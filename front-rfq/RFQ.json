{
  "name": "RFQ",
  "nodes": [
    {
      "parameters": {
        "operation": "pdf",
        "options": {}
      },
      "type": "n8n-nodes-base.extractFromFile",
      "typeVersion": 1.1,
      "position": [
        1344,
        4864
      ],
      "id": "ebbe79f5-4d8d-4cb0-a785-64fe67113a69",
      "name": "Extract from File1"
    },
    {
      "parameters": {
        "jsCode": "// =============================================\n// NODO: Generate Stable ID + Detectar Modo (NOMBRES CORRECTOS)\n// =============================================\n\nfunction simpleHash(str) {\n  let hash = 0;\n  for (let i = 0; i < str.length; i++) {\n    const char = str.charCodeAt(i);\n    hash = ((hash << 5) - hash) + char;\n    hash = hash & hash;\n  }\n  return Math.abs(hash).toString(16).padStart(16, '0').substring(0, 16);\n}\n\nconst body = $json.body;\n\n// CAMPOS EXISTENTES\nconst originalFileId = body.file_id || \"unknown\";\nconst fileTitle = body.file_title || \"unknown.pdf\";\nconst fileBinary = body.file_binary || \"\";\nconst fileUrl = body.file_url || \"unknown\";\n\n// âœ… EXTRAER METADATA DEL USUARIO (NOMBRES CORRECTOS)\nconst metadata = body.metadata || {};\nconst rfqProjectId = metadata.proyect_name || null;        // â† proyect_name\nconst userProveedor = metadata.proveedor || null;          // â† proveedor\nconst userTipoEval = metadata.evaluation || null;          // â† evaluation (Array)\n\n// âœ… DETERMINAR MODO DE OPERACIÃ“N\nlet modoOperacion = \"CLASIFICADOR\"; // Por defecto\nlet datosCompletos = false;\n\n// Verificar si tiene datos suficientes para VALIDACIÃ“N\nif (userProveedor && userTipoEval && Array.isArray(userTipoEval) && userTipoEval.length > 0) {\n    modoOperacion = \"VALIDADOR\";\n    datosCompletos = true;\n} else if (userProveedor || (userTipoEval && Array.isArray(userTipoEval) && userTipoEval.length > 0)) {\n    modoOperacion = \"HIBRIDO\"; // Tiene algunos datos pero no todos\n}\n\n// Generar ID estable del archivo\nconst normalizedTitle = fileTitle.toLowerCase().trim();\nconst stableId = simpleHash(normalizedTitle);\n\n// LOGGING\nconsole.log(\"=== ANÃLISIS DE METADATA ===\");\nconsole.log(`Modo OperaciÃ³n: ${modoOperacion}`);\nconsole.log(`RFQ Project Name: ${rfqProjectId || 'No especificado'}`);\nconsole.log(`Proveedor (Usuario): ${userProveedor || 'No especificado'}`);\nconsole.log(`Evaluation (Usuario): ${JSON.stringify(userTipoEval) || 'No especificado'}`);\nconsole.log(`Datos Completos: ${datosCompletos}`);\nconsole.log(`Original ID: ${originalFileId}`);\nconsole.log(`Nombre archivo: ${fileTitle}`);\nconsole.log(`ID ESTABLE generado: ${stableId}`);\n\n// RETORNO\nreturn {\n  json: {\n    // Datos directos en raÃ­z\n    file_id: stableId,\n    file_id_original: originalFileId,\n    file_title: fileTitle,\n    file_binary: fileBinary,\n    file_url: fileUrl,\n    \n    rfq_project_id: rfqProjectId || \"proyecto_sin_especificar\",\n    user_proveedor: userProveedor,\n    user_tipo_evaluacion: userTipoEval,\n    modo_operacion: modoOperacion,\n    datos_usuario_completos: datosCompletos,\n    \n    // Mantener body completo\n    body: {\n      ...body,\n      file_id: stableId,\n      file_id_original: originalFileId,\n      rfq_project_id: rfqProjectId || \"proyecto_sin_especificar\",\n      user_proveedor: userProveedor,\n      user_tipo_evaluacion: userTipoEval,\n      modo_operacion: modoOperacion,\n      datos_usuario_completos: datosCompletos\n    }\n  }\n};"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        464,
        912
      ],
      "id": "786c4360-b13f-4e69-a2f4-94652e659607",
      "name": "Code in JavaScript1"
    },
    {
      "parameters": {
        "jsCode": "// Esto borra cualquier dato residual del loop y dispara el siguiente nodo 1 sola vez\nreturn [{}];"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        1152,
        -144
      ],
      "id": "86df636f-654d-4530-a39b-66b2fac5edeb",
      "name": "Reset de valores"
    },
    {
      "parameters": {
        "operation": "get",
        "dataTableId": {
          "__rl": true,
          "value": "hwY1VFb924Ptf1P6",
          "mode": "list",
          "cachedResultName": "Tabla-RFQ-v1",
          "cachedResultUrl": "/projects/YoqFb1alZvPQmuNs/datatables/hwY1VFb924Ptf1P6"
        },
        "returnAll": true
      },
      "type": "n8n-nodes-base.dataTable",
      "typeVersion": 1.1,
      "position": [
        1392,
        -144
      ],
      "id": "20723611-766f-4606-85c2-2c43b2c7f1ca",
      "name": "Get row(s)"
    },
    {
      "parameters": {
        "jsCode": "// =============================================\n// NODO: Convertir Base64 a Binary Data (CORREGIDO v3)\n// =============================================\n\n// LEER DIRECTAMENTE DEL NODO \"Set File ID\"\nlet inputData;\ntry {\n    inputData = $('Set File ID').first().json;\n} catch (e) {\n    throw new Error(\"âŒ No se puede acceder al nodo 'Set File ID'\");\n}\n\nconst base64Data = inputData.file_binary;\n\n// --- VALIDACIÃ“N CRÃTICA ---\nif (!base64Data || base64Data === \"\") {\n    console.error(\"âŒ ERROR: file_binary estÃ¡ vacÃ­o\");\n    console.error(\"Datos en 'Set File ID':\", Object.keys(inputData));\n    console.error(\"file_id:\", inputData.file_id);\n    console.error(\"file_title:\", inputData.file_title);\n    \n    throw new Error(\n        \"âŒ CRÃTICO: 'file_binary' no existe en 'Set File ID'. \" +\n        \"Verifica la configuraciÃ³n del nodo.\"\n    );\n}\n\n// Validar que sea string\nif (typeof base64Data !== 'string') {\n    throw new Error(`âŒ ERROR: 'file_binary' debe ser string, es ${typeof base64Data}`);\n}\n\n// Logging\nconsole.log(\"âœ… file_binary recibido de 'Set File ID'\");\nconsole.log(`   â”œâ”€ Longitud: ${base64Data.length} caracteres`);\nconsole.log(`   â”œâ”€ Archivo: ${inputData.file_title}`);\n\n// Convertir base64 a binary\nlet binaryData;\ntry {\n    binaryData = Buffer.from(base64Data, 'base64');\n} catch (e) {\n    throw new Error(`âŒ ERROR decodificando base64: ${e.message}`);\n}\n\n// Validar tamaÃ±o\nif (binaryData.length === 0) {\n    throw new Error(\"âŒ ERROR: Archivo decodificado vacÃ­o (0 bytes)\");\n}\n\nconsole.log(`âœ… Binary generado: ${binaryData.length} bytes`);\n\n// Retornar formato n8n\nreturn {\n    json: {\n        file_id: inputData.file_id,\n        file_title: inputData.file_title,\n        file_url: inputData.file_url || \"unknown\"\n    },\n    binary: {\n        data: {\n            data: binaryData.toString('base64'),\n            mimeType: 'application/pdf',\n            fileName: inputData.file_title || 'document.pdf',\n            fileSize: binaryData.length\n        }\n    }\n};"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        2528,
        800
      ],
      "id": "1413cd85-a831-43f2-86ac-faf87cd2e42e",
      "name": "Base64 a Binary1"
    },
    {
      "parameters": {
        "jsCode": "// =============================================\n// NODO: Convertir Base64 a Binary Data (CORREGIDO v3)\n// =============================================\n\n// LEER DIRECTAMENTE DEL NODO \"Set File ID\"\nlet inputData;\ntry {\n    inputData = $('Set File ID').first().json;\n} catch (e) {\n    throw new Error(\"âŒ No se puede acceder al nodo 'Set File ID'\");\n}\n\nconst base64Data = inputData.file_binary;\n\n// --- VALIDACIÃ“N CRÃTICA ---\nif (!base64Data || base64Data === \"\") {\n    console.error(\"âŒ ERROR: file_binary estÃ¡ vacÃ­o\");\n    console.error(\"Datos en 'Set File ID':\", Object.keys(inputData));\n    console.error(\"file_id:\", inputData.file_id);\n    console.error(\"file_title:\", inputData.file_title);\n    \n    throw new Error(\n        \"âŒ CRÃTICO: 'file_binary' no existe en 'Set File ID'. \" +\n        \"Verifica la configuraciÃ³n del nodo.\"\n    );\n}\n\n// Validar que sea string\nif (typeof base64Data !== 'string') {\n    throw new Error(`âŒ ERROR: 'file_binary' debe ser string, es ${typeof base64Data}`);\n}\n\n// Logging\nconsole.log(\"âœ… file_binary recibido de 'Set File ID'\");\nconsole.log(`   â”œâ”€ Longitud: ${base64Data.length} caracteres`);\nconsole.log(`   â”œâ”€ Archivo: ${inputData.file_title}`);\n\n// Convertir base64 a binary\nlet binaryData;\ntry {\n    binaryData = Buffer.from(base64Data, 'base64');\n} catch (e) {\n    throw new Error(`âŒ ERROR decodificando base64: ${e.message}`);\n}\n\n// Validar tamaÃ±o\nif (binaryData.length === 0) {\n    throw new Error(\"âŒ ERROR: Archivo decodificado vacÃ­o (0 bytes)\");\n}\n\nconsole.log(`âœ… Binary generado: ${binaryData.length} bytes`);\n\n// Retornar formato n8n\nreturn {\n    json: {\n        file_id: inputData.file_id,\n        file_title: inputData.file_title,\n        file_url: inputData.file_url || \"unknown\"\n    },\n    binary: {\n        data: {\n            data: binaryData.toString('base64'),\n            mimeType: 'application/pdf',\n            fileName: inputData.file_title || 'document.pdf',\n            fileSize: binaryData.length\n        }\n    }\n};"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        1536,
        912
      ],
      "id": "254a0a20-d969-4f1d-821f-1f0af5ed1cc8",
      "name": "Base64 a Binary"
    },
    {
      "parameters": {
        "httpMethod": "POST",
        "path": "ofertas-proveedores",
        "responseMode": "responseNode",
        "options": {}
      },
      "type": "n8n-nodes-base.webhook",
      "typeVersion": 2.1,
      "position": [
        224,
        912
      ],
      "id": "b9d6690f-8539-4307-b052-5af3e1a7e939",
      "name": "Webhook",
      "webhookId": "2a435cf4-d7c8-4148-8d9f-189c3b620e8f"
    },
    {
      "parameters": {
        "respondWith": "allIncomingItems",
        "options": {}
      },
      "type": "n8n-nodes-base.respondToWebhook",
      "typeVersion": 1.5,
      "position": [
        1632,
        -144
      ],
      "id": "f702828b-3159-43f6-82d8-e84082bc48cc",
      "name": "Respond to Webhook"
    },
    {
      "parameters": {
        "model": "nomic-embed-text:latest"
      },
      "type": "@n8n/n8n-nodes-langchain.embeddingsOllama",
      "typeVersion": 1,
      "position": [
        4048,
        1136
      ],
      "id": "6b230bdd-74cd-454d-b93b-59fc7534ac24",
      "name": "Embeddings Ollama",
      "credentials": {
        "ollamaApi": {
          "id": "oS2Qqti9oVfsm8XZ",
          "name": "Ollama account"
        }
      },
      "disabled": true
    },
    {
      "parameters": {
        "jsCode": "const items = $input.all();\n\nreturn items.map(item => ({\n    json: {\n        ...item.json, // Mantiene todos los datos originales (incluido tipo_evaluacion)\n        \n        // AquÃ­ estÃ¡ la correcciÃ³n: Usamos dos puntos, no el igual.\n        reiniciar_bucle: true \n    }\n}));\n"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        1536,
        64
      ],
      "id": "80673efb-f115-460e-8cf1-2a03125b70db",
      "name": "Reset Items"
    },
    {
      "parameters": {
        "promptType": "define",
        "text": "=### INPUT A ANALIZAR\n\n**Datos proporcionados por el usuario:**\n- Proveedor indicado: {{ $('Set File ID').item.json.proveedor || 'NO ESPECIFICADO' }}\n- Tipo(s) de evaluaciÃ³n indicados: {{ $('Set File ID').item.json.evaluation }}\n- Proyecto: {{ $('Set File ID').item.json.proyect_name }}\n\n---\n\n**Nombre archivo**: {{ $json.fileName }}\n\n**Texto (Inicio del documento)**: \n{{ $json.pages[0].text }}",
        "hasOutputParser": true,
        "messages": {
          "messageValues": [
            {
              "message": "=# SISTEMA HÃBRIDO: VALIDADOR Y CLASIFICADOR DE RFQ\n\n## CONTEXTO GENERAL\n\nEres un *auditor senior especializado en RFQs de ingenierÃ­a*.  \nTu funciÃ³n es *validar y/o clasificar* el **proveedor** y el **tipo de evaluaciÃ³n** de un documento RFQ.\n\nEl sistema opera automÃ¡ticamente en *uno de tres modos*, segÃºn la informaciÃ³n proporcionada por el usuario.\n\n---\n\n## DETECCIÃ“N AUTOMÃTICA DE MODO\n\nAntes de analizar el documento, *evalÃºa los datos del usuario* y determina el modo de operaciÃ³n:\n\n### *MODO A â€“ VALIDADOR* (Prioridad alta)\n* El usuario proporcionÃ³ **Proveedor Y Tipo(s) de EvaluaciÃ³n**\n* Tu tarea:\n  * Validar la informaciÃ³n contra el documento\n  * Complementar con informaciÃ³n adicional si existe\n\n### *MODO B â€“ HÃBRIDO* (Prioridad media)\n* El usuario proporcionÃ³ **SOLO Proveedor** o **SOLO Tipo(s)**\n* Tu tarea:\n  * Validar lo proporcionado\n  * Clasificar lo faltante desde cero\n\n### *MODO C â€“ CLASIFICADOR* (Fallback)\n* El usuario **NO proporcionÃ³ ningÃºn dato**\n* Tu tarea:\n  * Clasificar completamente proveedor y tipo(s)\n\n---\n\n## MODO A: VALIDADOR  \n*(Usuario proporcionÃ³ Proveedor + Tipo(s))*\n\n### PASO 1: VALIDAR PROVEEDOR\n\n#### Reglas de validaciÃ³n\n\n1. Busca evidencia del proveedor en:\n   * Encabezados\n   * Logos\n   * Firmas\n   * Pie de pÃ¡gina\n   * Secciones como â€œPrepared byâ€, â€œIssued byâ€, etc.\n\n2. Resultado de la validaciÃ³n:\n   * **CONFIRMADO**: Coincide exactamente con el proveedor del usuario\n   * **DISCREPANCIA**: El documento indica un proveedor distinto (reportar ambos)\n   * **AMBIGUO**: No hay evidencia clara (aceptar el del usuario con nota)\n\n3. Normaliza SIEMPRE usando la tabla oficial:\n\n| Variaciones detectadas | VALOR OFICIAL |\n|----------------------|---------------|\n| TÃ©cnicas Reunidas, TR, Initec | TECNICASREUNIDAS |\n| Empresarios Agrupados, EA, GHESA | EA |\n| IDOM, Idom Consulting | IDOM |\n| SACYR, Sacyr Fluor | SACYR |\n| SENER, Sener Engineering | SENER |\n| TRESCA, Tresca IngenierÃ­a | TRESCA |\n| WORLEY, Worley Parsons | WORLEY |\n| Cualquier otro | OTROS |\n\n---\n\n### PASO 2: VALIDAR Y COMPLEMENTAR TIPOS\n\n#### ValidaciÃ³n de tipos indicados por el usuario\n\nPara cada tipo:\n* **CONFIRMADO**: Evidencia clara\n* **ERROR**: No hay evidencia\n* **PARCIAL**: Evidencia relacionada pero incompleta\n\n#### BÃºsqueda de tipos adicionales\n\n* Escanea TODO el documento\n* AÃ±ade tipos no indicados por el usuario si cumplen criterios\n* Reporta explÃ­citamente cualquier adiciÃ³n\n\n---\n\n## MODO B: HÃBRIDO  \n*(Usuario proporcionÃ³ informaciÃ³n parcial)*\n\n### Si el usuario dio SOLO PROVEEDOR\n1. Valida proveedor (reglas de Modo A)\n2. Clasifica tipos desde cero (reglas de Modo C)\n\n### Si el usuario dio SOLO TIPOS\n1. Valida y complementa tipos (reglas de Modo A)\n2. Detecta proveedor desde cero (reglas de Modo C)\n\n---\n\n## MODO C: CLASIFICADOR  \n*(Sin datos del usuario)*\n\n### TAREA 1: DETECTAR Y NORMALIZAR PROVEEDOR\n\n* Buscar en texto y nombre del archivo\n* Normalizar usando la tabla oficial\n\n---\n\n### TAREA 2: CLASIFICAR TIPO DE EVALUACIÃ“N\n\n### REGLA DE ORO  \n*Si no estÃ¡s 100 % seguro, NO lo incluyas*\n\n---\n\n### 1. ECONOMICAL EVALUATION\n\n#### Evidencia obligatoria (todas deben cumplirse)\n* Tablas con precios explÃ­citos\n* Moneda visible (EUR, USD, etc.)\n* Precios desglosados por concepto\n\n#### Exclusiones\n* Presupuesto estimado sin detalle\n* â€œSujeto a cotizaciÃ³nâ€\n* Subtotales sin desglose\n\n---\n\n### 2. TECHNICAL EVALUATION\n\n#### Evidencia vÃ¡lida\n* MetodologÃ­a\n* Organigramas\n* Alcance tÃ©cnico\n* Cronogramas\n* Especificaciones\n* Diagramas de proceso\n\n#### No es tÃ©cnica\n* Solo precios\n* Solo listado de documentos\n\n---\n\n### 3. PRE-FEED / FEED DELIVERABLES  \n*(Criterio ultra-restrictivo)*\n\nClasifica como Deliverables SOLO si cumple TODO:\n1. Lista tabulada o numerada de documentos\n2. CÃ³digos o identificadores Ãºnicos\n3. Matriz MDR explÃ­cita\n\n#### Exclusiones\n* â€œSe entregarÃ¡ documentaciÃ³nâ€\n* â€œIncluye diseÃ±osâ€\n* Listado de actividades\n\n#### Diferencia clave\n* **Pre-FEED**: Estudios preliminares (+/- 30 %)\n* **FEED**: Documentos detallados (+/- 15 %)\n\n---\n\n## FORMATO DE SALIDA (JSON ÃšNICO)\n\n```json\n{\n  \"modo_usado\": \"VALIDADOR | HIBRIDO | CLASIFICADOR\",\n  \"proveedor_detectado\": \"VALOR_OFICIAL\",\n  \"proveedor_validado\": true | false | null,\n  \"proveedor_nota\": \"DescripciÃ³n clara\",\n  \"tipos_detectados\": [],\n  \"tipos_validados\": true | false | null,\n  \"tipos_nota\": \"DescripciÃ³n clara\",\n  \"razonamiento\": \"ExplicaciÃ³n detallada y trazable\"\n}\nREGLAS FINALES\nLee los datos del usuario\n\nDetermina el modo correcto\n\nAplica SOLO la lÃ³gica de ese modo\n\nGenera el JSON completo\n\nReporta errores del usuario si existen\n\nREGLA CRÃTICA\nEs preferible seÃ±alar un error que validar informaciÃ³n incorrecta.\nTu credibilidad depende de la precisiÃ³n."
            }
          ]
        },
        "batching": {}
      },
      "type": "@n8n/n8n-nodes-langchain.chainLlm",
      "typeVersion": 1.8,
      "position": [
        3552,
        1088
      ],
      "id": "c0feb110-48e1-466e-8ccc-363dfbdd9526",
      "name": "Clasificador de Tipo de RFQ y Proveedor"
    },
    {
      "parameters": {},
      "type": "n8n-nodes-base.merge",
      "typeVersion": 3.2,
      "position": [
        3168,
        912
      ],
      "id": "128f3fa9-d92e-4508-95b4-961dcf47e1ed",
      "name": "Merge1"
    },
    {
      "parameters": {
        "schemaType": "manual",
        "inputSchema": "{\n  \"type\": \"object\",\n  \"properties\": {\n    \"proveedor_detectado\": {\n      \"type\": \"string\",\n      \"description\": \"Nombre de la empresa proveedora (Ej: SACYR, IDOM, etc.)\"\n    },\n    \"tipos_detectados\": {\n      \"type\": \"array\",\n      \"items\": {\n        \"type\": \"string\",\n        \"enum\": [\n          \"Technical Evaluation\",\n          \"Economical Evaluation\",\n          \"Pre-FEED Deliverables\",\n          \"FEED Deliverables\"\n        ]\n      },\n      \"description\": \"Lista de tipos de oferta detectados en el documento.\"\n    },\n    \"razonamiento\": {\n      \"type\": \"string\",\n      \"description\": \"Breve explicaciÃ³n de por quÃ© se eligieron esos tipos.\"\n    }\n  },\n  \"required\": [\n    \"proveedor_detectado\",\n    \"tipos_detectados\"\n  ]\n}"
      },
      "type": "@n8n/n8n-nodes-langchain.outputParserStructured",
      "typeVersion": 1.3,
      "position": [
        3712,
        1312
      ],
      "id": "ea061874-d6a1-4709-bc62-724b320ef9db",
      "name": "Structured Output Parser"
    },
    {
      "parameters": {
        "method": "POST",
        "url": "https://unlaconic-ardelle-pretenceful.ngrok-free.dev/v1/convert/file",
        "sendBody": true,
        "contentType": "multipart-form-data",
        "bodyParameters": {
          "parameters": [
            {
              "parameterType": "formBinaryData",
              "name": "files",
              "inputDataFieldName": "data"
            }
          ]
        },
        "options": {
          "timeout": 300000
        }
      },
      "id": "3dc716fa-fa99-402a-b019-31188ae3f283",
      "name": "Docling OCR",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.3,
      "position": [
        2736,
        704
      ],
      "retryOnFail": true
    },
    {
      "parameters": {
        "options": {}
      },
      "type": "n8n-nodes-base.splitInBatches",
      "typeVersion": 3,
      "position": [
        832,
        128
      ],
      "id": "7e3051df-a590-4687-a80a-62cf2087a145",
      "name": "Loop Over Items1"
    },
    {
      "parameters": {
        "jsCode": "// =============================================\n// NODO: Expandir por Tipo de EvaluaciÃ³n (VERSIÃ“N SIMPLIFICADA)\n// =============================================\n\n// 1. RECUPERAR TEXTO DE LA OFERTA\nlet fullText = \"\";\nlet totalPages = 1;\n\ntry {\n    const mergeData = $('Merge1').first().json;\n    \n    // Extraer texto\n    if (mergeData.pages && mergeData.pages[0]) {\n        fullText = mergeData.pages[0].text || \"\";\n    } else {\n        fullText = mergeData.text || \"\";\n    }\n    \n    totalPages = mergeData.totalPages || 1;\n    \n} catch (e) {\n    console.error(\"âŒ Error leyendo texto de Merge1:\", e.message);\n    fullText = \"ERROR: No se pudo leer el texto\";\n}\n\n// 2. RECUPERAR METADATOS DESDE SET FILE ID (Fuente Ãºnica de verdad)\nlet fileId = \"unknown\";\nlet fileTitle = \"unknown\";\nlet proveedor = \"OTROS\";\nlet tipoEval = [\"Technical Evaluation\"];\nlet projectName = \"proyecto_sin_especificar\";\n\ntry {\n    const fileData = $('Set File ID').first().json;\n    \n    fileId = fileData.file_id || \"unknown\";\n    fileTitle = fileData.file_title || \"unknown\";\n    projectName = fileData.proyect_name || \"proyecto_sin_especificar\";\n    proveedor = fileData.proveedor || \"OTROS\";\n    tipoEval = fileData.evaluation || [\"Technical Evaluation\"];\n    \n    console.log(\"âœ… Metadatos recuperados de Set File ID:\");\n    console.log(`   â”œâ”€ Proyecto: ${projectName}`);\n    console.log(`   â”œâ”€ Proveedor: ${proveedor}`);\n    console.log(`   â”œâ”€ EvaluaciÃ³n: ${JSON.stringify(tipoEval)}`);\n    \n} catch (e) {\n    console.error(\"âŒ Error leyendo Set File ID:\", e.message);\n}\n\n// 3. NORMALIZAR TIPOS (Asegurar que sea array)\nif (!Array.isArray(tipoEval)) {\n    if (typeof tipoEval === 'string') {\n        const cleanString = tipoEval.replace(/[\\[\\]\"]/g, '');\n        if (cleanString.includes(',')) {\n            tipoEval = cleanString.split(',').map(t => t.trim());\n        } else {\n            tipoEval = [cleanString.trim()];\n        }\n    } else {\n        tipoEval = [tipoEval];\n    }\n}\n\n// Filtrar valores vacÃ­os\ntipoEval = tipoEval.filter(t => t && t.trim() !== \"\");\n\n// Si quedÃ³ vacÃ­o, poner default\nif (tipoEval.length === 0) {\n    tipoEval = [\"Technical Evaluation\"];\n}\n\n// LOGGING FINAL\nconsole.log(`ðŸ”€ EXPANSIÃ“N POR TIPO`);\nconsole.log(`   Archivo: ${fileTitle}`);\nconsole.log(`   Proyecto: ${projectName}`);\nconsole.log(`   Proveedor: ${proveedor}`);\nconsole.log(`   Tipos a expandir: ${JSON.stringify(tipoEval)}`);\nconsole.log(`   Texto extraÃ­do: ${fullText.length} caracteres`);\n\n// 4. GENERAR SALIDA (UNA FILA POR CADA TIPO)\nreturn tipoEval.map((tipo, idx) => ({\n    json: {\n        // --- DATOS PRINCIPALES ---\n        tipo_evaluacion_actual: tipo,\n        proveedor_detectado: proveedor,\n        proyecto_nombre: projectName,\n        texto_oferta_completo: fullText,\n        \n        // --- METADATOS DEL ARCHIVO ---\n        file_title: fileTitle,\n        file_id: fileId,\n        \n        // --- CONTROL DE EXPANSIÃ“N ---\n        es_hibrido: tipoEval.length > 1,\n        indice_actual: idx + 1,\n        total_tipos: tipoEval.length,\n        total_pages: totalPages\n    }\n}));"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        496,
        208
      ],
      "id": "a2c3affb-a49a-4ee4-bf0c-449d3cb5dde8",
      "name": "Expandir por Tipo de EvaluaciÃ³n"
    },
    {
      "parameters": {
        "jsCode": "// =============================================\n// NODO: Format for Vectorstore (FINAL v2)\n// =============================================\n\n// 1. RECUPERAR CONTENIDO (InstrucciÃ³n explÃ­cita)\n// Sacamos el texto y pÃ¡ginas directamente del nodo Merge1 como indicaste\nlet fullText = \"\";\nlet totalPages = 1;\n\ntry {\n    const mergeData = $('Merge1').first().json;\n    \n    // Ruta especÃ­fica que pediste:\n    if (mergeData.pages && mergeData.pages[0]) {\n        fullText = mergeData.pages[0].text || \"\";\n    } else {\n        // Fallback por si acaso viene en 'text' directo\n        fullText = mergeData.text || \"\";\n    }\n    \n    // NÃºmero de pÃ¡ginas\n    totalPages = mergeData.totalPages || 1;\n    \n} catch (e) {\n    console.log(\"âŒ Error leyendo de Merge1. Verifica que el nodo se llame exactamente 'Merge1'\");\n}\n\n// 2. RECUPERAR CLASIFICACIÃ“N (Del nodo LLM)\nlet proveedor = \"OTROS\";\nlet tipoEval = [\"Technical Evaluation\"];\n\ntry {\n    // Leemos la salida del clasificador\n    const llmData = $('Clasificador de Tipo de RFQ y Proveedor').first().json;\n    const output = llmData.output || llmData; // A veces estÃ¡ anidado\n\n    if (output.proveedor_detectado) proveedor = output.proveedor_detectado;\n    \n    if (output.tipos_detectados) {\n        tipoEval = Array.isArray(output.tipos_detectados) \n            ? output.tipos_detectados \n            : [output.tipos_detectados];\n    }\n} catch (e) {\n    console.log(\"âš ï¸ No se pudo leer la clasificaciÃ³n del LLM, usando defaults.\");\n}\n\n// 3. RECUPERAR METADATOS DEL ARCHIVO\nlet fileId = \"unknown\";\nlet fileTitle = \"unknown\";\ntry {\n    const fileNode = $('Set File ID').first().json;\n    fileId = fileNode.file_id;\n    fileTitle = fileNode.file_title;\n} catch(e) {}\n\n// 4. GENERAR SALIDA\nconsole.log(`âœ… Procesando: ${fileTitle}`);\nconsole.log(`   Proveedor: ${proveedor}`);\nconsole.log(`   Tipos: ${JSON.stringify(tipoEval)}`);\n\nreturn {\n    json: {\n        text: fullText,\n        metadata: {\n            file_id: fileId,\n            file_title: fileTitle,\n            proveedor: proveedor,\n            tipo_evaluacion: tipoEval, // Se guarda como array [\"Technical\", \"Economical\"]\n            processed_at: new Date().toISOString(),\n            total_pages: totalPages\n        }\n    }\n};"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        3872,
        912
      ],
      "id": "dee2348a-010d-417d-bb87-fdcb0c145f67",
      "name": "Format for Vectorstore"
    },
    {
      "parameters": {
        "jsCode": "// =============================================\n// NODO: Aggregate OCR Pages (CORREGIDO)\n// =============================================\n\nconst items = $input.all();\nlet fullText = \"\";\nlet pagesArray = [];\n\n// OPCIÃ“N A: Si Tesseract devuelve mÃºltiples items (1 por pÃ¡gina)\nif (items.length > 1) {\n  items.forEach((item, idx) => {\n    const pageText = item.json.text || \"\";\n    fullText += pageText + \"\\n\\n\";\n    \n    // Construimos array compatible con vectorstore\n    pagesArray.push({\n      text: pageText,\n      pageNumber: idx + 1\n    });\n  });\n}\n// OPCIÃ“N B: Si Tesseract devuelve un solo item con todo el texto\nelse if (items.length === 1) {\n  fullText = items[0].json.text || \"\";\n  pagesArray = [{\n    text: fullText,\n    pageNumber: 1\n  }];\n}\n\n// RECUPERAR METADATOS ORIGINALES (CRÃTICO)\nlet fileId, fileName, proveedor;\ntry {\n  fileId = $('Set File ID').first().json.file_id;\n  fileName = $('Set File ID').first().json.file_title;\n  proveedor = $('Identificar Proveedor').first().json.proveedor_detectado;\n} catch (e) {\n  console.error(\"âš ï¸ No se pudieron recuperar metadatos:\", e.message);\n  fileId = \"unknown\";\n  fileName = \"unknown\";\n  proveedor = \"OTROS\";\n}\n\nconsole.log(`ðŸ”„ OCR Agregado: ${items.length} pÃ¡ginas â†’ ${fullText.length} caracteres`);\n\n// ESTRUCTURA COMPATIBLE CON VECTORSTORE\nreturn {\n  json: {\n    pages: pagesArray, // â† Array de pÃ¡ginas (requerido por Default Data Loader)\n    text: fullText, // â† Texto completo (backup)\n    \n    // Metadatos crÃ­ticos\n    file_id: fileId,\n    file_title: fileName,\n    proveedor: proveedor,\n    \n    // Marca de origen\n    origen_datos: \"OCR_TESSERACT\",\n    ocr_pages_processed: items.length,\n    ocr_total_chars: fullText.length\n  }\n};"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        2944,
        800
      ],
      "id": "3cf8a8f5-e108-44c1-b551-eda68969c71f",
      "name": "Aggregate OCR Pages"
    },
    {
      "parameters": {
        "conditions": {
          "options": {
            "caseSensitive": true,
            "leftValue": "",
            "typeValidation": "strict",
            "version": 3
          },
          "conditions": [
            {
              "id": "57b9c551-9997-4ed5-8ddd-f80c108a177c",
              "leftValue": "={{ $json.needsOCR }}",
              "rightValue": "",
              "operator": {
                "type": "boolean",
                "operation": "true",
                "singleValue": true
              }
            }
          ],
          "combinator": "and"
        },
        "options": {}
      },
      "type": "n8n-nodes-base.if",
      "typeVersion": 2.3,
      "position": [
        2304,
        912
      ],
      "id": "0ed0ba9b-eeb7-4f27-9b02-6031e5759456",
      "name": "Â¿Necesita OCR?"
    },
    {
      "parameters": {
        "operation": "pdf",
        "options": {}
      },
      "type": "n8n-nodes-base.extractFromFile",
      "typeVersion": 1.1,
      "position": [
        1760,
        912
      ],
      "id": "e825865b-419e-4b55-b38c-c54409589794",
      "name": "Extract from File"
    },
    {
      "parameters": {
        "jsCode": "// =============================================\n// NODO: Validar Contenido PDF (FIX PAGINACIÃ“N)\n// =============================================\n\nconst input = $input.first().json;\n\n// Variables de inicializaciÃ³n\nlet pages = [];\nlet totalChars = 0;\nlet hasTablesDetected = false;\n\n// --- 1. PROCESAMIENTO DEL TEXTO ---\n\n// CASO A: Viene desglosado por pÃ¡ginas (Array)\nif (input.pages && Array.isArray(input.pages) && input.pages.length > 0) {\n  pages = input.pages;\n  pages.forEach(page => {\n    const text = page.text || page.pageContent || \"\";\n    totalChars += text.length;\n    // DetecciÃ³n simple de tablas\n    if ((text.match(/\\s{4,}/g) || []).length > 5) hasTablesDetected = true;\n  });\n\n// CASO B: Viene todo el texto junto (String) - ESTE ES TU CASO ACTUAL\n} else if (input.text && typeof input.text === 'string') {\n  const text = input.text;\n  totalChars = text.length;\n  // Creamos una \"pÃ¡gina Ãºnica\" contenedora para no romper el flujo\n  pages = [{ text: text, pageNumber: 1 }];\n  \n  // Detectar tablas en el texto completo\n  if ((text.match(/\\s{4,}/g) || []).length > 20) hasTablesDetected = true;\n  \n} else {\n  // CASO C: VacÃ­o\n  pages = [];\n}\n\n// --- 2. CÃLCULO DE PÃGINAS REALES (FIX CRÃTICO) ---\n\n// Intentamos leer el metadato 'numpages' que se ve en tu captura\nlet realPageCount = input.numpages || input.numPages || input.numberOfPages || 0;\n\n// Si no existe el metadato, usamos la longitud del array (fallback)\nif (!realPageCount || realPageCount === 0) {\n    realPageCount = pages.length;\n}\n\n// Si sigue siendo 1 pero el texto es enorme (>10k chars), estimamos\nif (realPageCount <= 1 && totalChars > 10000) {\n    // EstimaciÃ³n conservadora: 3000 caracteres por pÃ¡gina tÃ©cnica\n    realPageCount = Math.ceil(totalChars / 3000);\n}\n\n// Evitar divisiÃ³n por cero\nrealPageCount = Math.max(1, realPageCount);\n\n\n// --- 3. MÃ‰TRICAS FINALES ---\n\nconst avgCharsPerPage = totalChars / realPageCount;\n\n// CRITERIO: Â¿Necesita OCR?\n// Si hay texto (< 100 chars/pag) es probable que sea escaneado.\nconst needsOCR = avgCharsPerPage < 100; \n\n// Metadatos\nlet fileId = \"unknown\";\nlet fileTitle = \"unknown\";\ntry {\n  const metaNode = $('Set File ID').first().json;\n  fileId = metaNode.file_id;\n  fileTitle = metaNode.file_title;\n} catch (e) {}\n\n// --- LOGGING ---\nconsole.log(`ðŸ“„ AnÃ¡lisis: ${fileTitle}`);\nconsole.log(`   â”œâ”€ PÃ¡ginas (Metadato): ${input.numpages}`); \nconsole.log(`   â”œâ”€ PÃ¡ginas (Usadas): ${realPageCount}`);\nconsole.log(`   â”œâ”€ Caracteres Totales: ${totalChars}`);\nconsole.log(`   â”œâ”€ Promedio/PÃ¡g: ${Math.round(avgCharsPerPage)}`);\n\nreturn {\n  json: {\n    // MÃ©tricas corregidas\n    totalPages: realPageCount, // Ahora dirÃ¡ 235\n    totalChars: totalChars,\n    avgCharsPerPage: Math.round(avgCharsPerPage), // Ahora serÃ¡ un nÃºmero razonable (~2800)\n    hasTables: hasTablesDetected,\n    needsOCR: needsOCR,\n    \n    // Contenido\n    pages: pages, \n    \n    // Metadatos\n    fileId: fileId,\n    fileName: fileTitle\n  }\n};"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        2032,
        912
      ],
      "id": "2c0b4103-160d-435a-ab4e-b05949b0a23f",
      "name": "Validar Contenido PDF"
    },
    {
      "parameters": {
        "mode": "insert",
        "tableName": {
          "__rl": true,
          "value": "documents_768",
          "mode": "list",
          "cachedResultName": "documents_768"
        },
        "options": {
          "queryName": "match_documents_768"
        }
      },
      "id": "2f312a02-2b1c-4a89-85b4-10837e88b949",
      "name": "Insert into Supabase Vectorstore",
      "type": "@n8n/n8n-nodes-langchain.vectorStoreSupabase",
      "typeVersion": 1,
      "position": [
        4112,
        912
      ],
      "disabled": true
    },
    {
      "parameters": {
        "operation": "get",
        "dataTableId": {
          "__rl": true,
          "value": "hwY1VFb924Ptf1P6",
          "mode": "list",
          "cachedResultName": "Tabla-RFQ-v1",
          "cachedResultUrl": "/projects/YoqFb1alZvPQmuNs/datatables/hwY1VFb924Ptf1P6"
        },
        "matchType": "allConditions",
        "filters": {
          "conditions": [
            {
              "keyName": "evaluation",
              "keyValue": "={{ $json.tipo_evaluacion_actual }}"
            },
            {
              "keyName": "project_name",
              "keyValue": "={{ $json.proyecto_nombre }}"
            }
          ]
        },
        "returnAll": true
      },
      "type": "n8n-nodes-base.dataTable",
      "typeVersion": 1,
      "position": [
        1248,
        64
      ],
      "id": "f0db3872-2a8b-4642-8ef7-88d5f5d5d446",
      "name": "Get RFQ Items"
    },
    {
      "parameters": {
        "chunkSize": 1500,
        "chunkOverlap": 200,
        "options": {}
      },
      "type": "@n8n/n8n-nodes-langchain.textSplitterRecursiveCharacterTextSplitter",
      "typeVersion": 1,
      "position": [
        4160,
        1328
      ],
      "id": "334dd949-6049-435d-a5ea-a9316280a635",
      "name": "Recursive Character Text Splitter",
      "disabled": true
    },
    {
      "parameters": {
        "jsonMode": "expressionData",
        "jsonData": "={{ $json.text }}",
        "options": {
          "metadata": {
            "metadataValues": [
              {
                "name": "file_id",
                "value": "={{ $json.metadata.file_id }}"
              },
              {
                "name": "file_title",
                "value": "={{ $json.metadata.file_title }}"
              },
              {
                "name": "tipo_evaluacion",
                "value": "={{ $json.metadata.tipo_evaluacion }}"
              },
              {
                "name": "proveedor",
                "value": "={{ $json.metadata.proveedor }}"
              }
            ]
          }
        }
      },
      "id": "71ba6045-364a-49ca-b347-6564bafed1bc",
      "name": "Default Data Loader",
      "type": "@n8n/n8n-nodes-langchain.documentDefaultDataLoader",
      "typeVersion": 1,
      "position": [
        4256,
        1168
      ],
      "disabled": true
    },
    {
      "parameters": {
        "assignments": {
          "assignments": [
            {
              "id": "10646eae-ae46-4327-a4dc-9987c2d76173",
              "name": "file_id",
              "value": "={{ $json.body.file_id }}",
              "type": "string"
            },
            {
              "id": "77d782de-169d-4a46-8a8e-a3831c04d90f",
              "name": "file_title",
              "value": "={{ $json.body.file_title }}",
              "type": "string"
            },
            {
              "id": "9bde4d7f-e4f3-4ebd-9338-dce1350f9eab",
              "name": "file_url",
              "value": "={{ $json.body.file_url }}",
              "type": "string"
            },
            {
              "id": "b1dbe9b9-248a-4593-a769-a085b34e0810",
              "name": "file_binary",
              "value": "={{ $json.body.file_binary }}",
              "type": "string"
            },
            {
              "id": "74d93dce-cddc-4947-ae19-88bc5cacd146",
              "name": "file_metadata",
              "value": "={{ $json.body.metadata }}",
              "type": "string"
            },
            {
              "id": "5e43f8d4-b48e-4188-89c8-3723f184dbeb",
              "name": "proyect_name",
              "value": "={{ $json.body.metadata.proyecto }}",
              "type": "string"
            },
            {
              "id": "1093ebc6-8dd8-4c5d-b146-b6f01b069be6",
              "name": "proveedor",
              "value": "={{ $json.body.user_proveedor }}",
              "type": "string"
            },
            {
              "id": "6e0e6e2a-9b88-403e-aa0a-da0eecccd3f9",
              "name": "evaluation",
              "value": "={{ $json.body.metadata.tipoEvaluacion }}",
              "type": "array"
            }
          ]
        },
        "options": {}
      },
      "id": "10e917b9-b63e-4dd2-9d02-b496efbfac6f",
      "name": "Set File ID",
      "type": "n8n-nodes-base.set",
      "typeVersion": 3.4,
      "position": [
        736,
        912
      ]
    },
    {
      "parameters": {
        "operation": "delete",
        "tableId": "documents_768",
        "filterType": "string",
        "filterString": "=metadata->>file_id=like.*{{ $json.file_id }}*"
      },
      "id": "17b20c8e-8451-4779-b40e-01098d01e189",
      "name": "Delete Old Doc Rows",
      "type": "n8n-nodes-base.supabase",
      "typeVersion": 1,
      "position": [
        960,
        912
      ],
      "alwaysOutputData": true,
      "disabled": true
    },
    {
      "parameters": {
        "operation": "upsert",
        "schema": {
          "__rl": true,
          "mode": "list",
          "value": "public"
        },
        "table": {
          "__rl": true,
          "value": "document_metadata",
          "mode": "list",
          "cachedResultName": "document_metadata"
        },
        "columns": {
          "mappingMode": "defineBelow",
          "value": {
            "id": "={{ $('Set File ID').item.json.file_id }}",
            "title": "={{ $('Set File ID').item.json.file_title }}",
            "url": "={{ $('Set File ID').item.json.file_url }}"
          },
          "matchingColumns": [
            "id"
          ],
          "schema": [
            {
              "id": "id",
              "displayName": "id",
              "required": true,
              "defaultMatch": true,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            },
            {
              "id": "title",
              "displayName": "title",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": false
            },
            {
              "id": "url",
              "displayName": "url",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": false
            },
            {
              "id": "created_at",
              "displayName": "created_at",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "dateTime",
              "canBeUsedToMatch": false,
              "removed": false
            },
            {
              "id": "schema",
              "displayName": "schema",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": false,
              "removed": false
            }
          ],
          "attemptToConvertTypes": false,
          "convertFieldsToString": false
        },
        "options": {}
      },
      "type": "n8n-nodes-base.postgres",
      "typeVersion": 2.5,
      "position": [
        1216,
        912
      ],
      "id": "affa489d-5ec5-4be3-ad63-f28c7bfa6f09",
      "name": "Insert Document Metadata",
      "executeOnce": true,
      "disabled": true
    },
    {
      "parameters": {
        "operation": "update",
        "dataTableId": {
          "__rl": true,
          "value": "hwY1VFb924Ptf1P6",
          "mode": "list",
          "cachedResultName": "Tabla-RFQ-v1",
          "cachedResultUrl": "/projects/YoqFb1alZvPQmuNs/datatables/hwY1VFb924Ptf1P6"
        },
        "filters": {
          "conditions": [
            {
              "keyValue": "={{ $json.id }}"
            }
          ]
        },
        "columns": {
          "mappingMode": "defineBelow",
          "value": {
            "WORLEY": "={{ $('Parsear y Preparar Update').item.json.WORLEY }}"
          },
          "matchingColumns": [
            "id"
          ],
          "schema": [
            {
              "id": "Evaluation",
              "displayName": "Evaluation",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "readOnly": false,
              "removed": true
            },
            {
              "id": "fase",
              "displayName": "fase",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "readOnly": false,
              "removed": true
            },
            {
              "id": "descripcion_item",
              "displayName": "descripcion_item",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "readOnly": false,
              "removed": true
            },
            {
              "id": "TRESCA",
              "displayName": "TRESCA",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "readOnly": false,
              "removed": true
            },
            {
              "id": "EA",
              "displayName": "EA",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "readOnly": false,
              "removed": true
            },
            {
              "id": "IDOM",
              "displayName": "IDOM",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "readOnly": false,
              "removed": true
            },
            {
              "id": "TECNICASREUNIDAS",
              "displayName": "TECNICASREUNIDAS",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "readOnly": false,
              "removed": true
            },
            {
              "id": "SACYR",
              "displayName": "SACYR",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "readOnly": false,
              "removed": true
            },
            {
              "id": "SENER",
              "displayName": "SENER",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "readOnly": false,
              "removed": true
            },
            {
              "id": "WORLEY",
              "displayName": "WORLEY",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "readOnly": false,
              "removed": false
            }
          ],
          "attemptToConvertTypes": false,
          "convertFieldsToString": false
        },
        "options": {}
      },
      "id": "11cff249-e7c0-456a-b36c-965a370c55d0",
      "name": "Update RFQ WORLEY",
      "type": "n8n-nodes-base.dataTable",
      "typeVersion": 1,
      "position": [
        4576,
        960
      ]
    },
    {
      "parameters": {
        "operation": "update",
        "dataTableId": {
          "__rl": true,
          "value": "hwY1VFb924Ptf1P6",
          "mode": "list",
          "cachedResultName": "Tabla-RFQ-v1",
          "cachedResultUrl": "/projects/YoqFb1alZvPQmuNs/datatables/hwY1VFb924Ptf1P6"
        },
        "filters": {
          "conditions": [
            {
              "keyValue": "={{ $json.id }}"
            }
          ]
        },
        "columns": {
          "mappingMode": "defineBelow",
          "value": {
            "TRESCA": "={{ $('Parsear y Preparar Update').item.json.TRESCA }}"
          },
          "matchingColumns": [
            "id"
          ],
          "schema": [
            {
              "id": "Evaluation",
              "displayName": "Evaluation",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "readOnly": false,
              "removed": true
            },
            {
              "id": "fase",
              "displayName": "fase",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "readOnly": false,
              "removed": true
            },
            {
              "id": "descripcion_item",
              "displayName": "descripcion_item",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "readOnly": false,
              "removed": true
            },
            {
              "id": "rfq_requisito",
              "displayName": "rfq_requisito",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "readOnly": false,
              "removed": true
            },
            {
              "id": "IDOM",
              "displayName": "IDOM",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "readOnly": false,
              "removed": true
            },
            {
              "id": "TECNICASREUNIDAS",
              "displayName": "TECNICASREUNIDAS",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "readOnly": false,
              "removed": true
            },
            {
              "id": "SACYR",
              "displayName": "SACYR",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "readOnly": false,
              "removed": true
            },
            {
              "id": "EA",
              "displayName": "EA",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "readOnly": false,
              "removed": true
            },
            {
              "id": "SENER",
              "displayName": "SENER",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "readOnly": false,
              "removed": true
            },
            {
              "id": "TRESCA",
              "displayName": "TRESCA",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "readOnly": false,
              "removed": false
            },
            {
              "id": "WORLEY",
              "displayName": "WORLEY",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "readOnly": false,
              "removed": true
            }
          ],
          "attemptToConvertTypes": false,
          "convertFieldsToString": false
        },
        "options": {}
      },
      "id": "72b26cc5-7754-4d78-b829-8423a0fa42fb",
      "name": "Update RFQ TRESCA",
      "type": "n8n-nodes-base.dataTable",
      "typeVersion": 1,
      "position": [
        4576,
        752
      ]
    },
    {
      "parameters": {
        "operation": "update",
        "dataTableId": {
          "__rl": true,
          "value": "hwY1VFb924Ptf1P6",
          "mode": "list",
          "cachedResultName": "Tabla-RFQ-v1",
          "cachedResultUrl": "/projects/YoqFb1alZvPQmuNs/datatables/hwY1VFb924Ptf1P6"
        },
        "filters": {
          "conditions": [
            {
              "keyValue": "={{ $json.id }}"
            }
          ]
        },
        "columns": {
          "mappingMode": "defineBelow",
          "value": {
            "SENER": "={{ $('Parsear y Preparar Update').item.json.SENER }}"
          },
          "matchingColumns": [
            "id"
          ],
          "schema": [
            {
              "id": "Evaluation",
              "displayName": "Evaluation",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "readOnly": false,
              "removed": true
            },
            {
              "id": "fase",
              "displayName": "fase",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "readOnly": false,
              "removed": true
            },
            {
              "id": "descripcion_item",
              "displayName": "descripcion_item",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "readOnly": false,
              "removed": true
            },
            {
              "id": "TRESCA",
              "displayName": "TRESCA",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "readOnly": false,
              "removed": true
            },
            {
              "id": "EA",
              "displayName": "EA",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "readOnly": false,
              "removed": true
            },
            {
              "id": "IDOM",
              "displayName": "IDOM",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "readOnly": false,
              "removed": true
            },
            {
              "id": "TECNICASREUNIDAS",
              "displayName": "TECNICASREUNIDAS",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "readOnly": false,
              "removed": true
            },
            {
              "id": "SACYR",
              "displayName": "SACYR",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "readOnly": false,
              "removed": true
            },
            {
              "id": "SENER",
              "displayName": "SENER",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "readOnly": false,
              "removed": false
            },
            {
              "id": "WORLEY",
              "displayName": "WORLEY",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "readOnly": false,
              "removed": true
            }
          ],
          "attemptToConvertTypes": false,
          "convertFieldsToString": false
        },
        "options": {}
      },
      "id": "9424c661-3c9e-4042-81bb-5d5b24450e11",
      "name": "Update RFQ SENER",
      "type": "n8n-nodes-base.dataTable",
      "typeVersion": 1,
      "position": [
        4576,
        560
      ]
    },
    {
      "parameters": {
        "operation": "update",
        "dataTableId": {
          "__rl": true,
          "value": "hwY1VFb924Ptf1P6",
          "mode": "list",
          "cachedResultName": "Tabla-RFQ-v1",
          "cachedResultUrl": "/projects/YoqFb1alZvPQmuNs/datatables/hwY1VFb924Ptf1P6"
        },
        "filters": {
          "conditions": [
            {
              "keyValue": "={{ $json.id }}"
            }
          ]
        },
        "columns": {
          "mappingMode": "defineBelow",
          "value": {
            "EA": "={{ $('Parsear y Preparar Update').item.json.EA }}"
          },
          "matchingColumns": [
            "id"
          ],
          "schema": [
            {
              "id": "Evaluation",
              "displayName": "Evaluation",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "readOnly": false,
              "removed": true
            },
            {
              "id": "fase",
              "displayName": "fase",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "readOnly": false,
              "removed": true
            },
            {
              "id": "descripcion_item",
              "displayName": "descripcion_item",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "readOnly": false,
              "removed": true
            },
            {
              "id": "TRESCA",
              "displayName": "TRESCA",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "readOnly": false,
              "removed": true
            },
            {
              "id": "EA",
              "displayName": "EA",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "readOnly": false,
              "removed": false
            },
            {
              "id": "IDOM",
              "displayName": "IDOM",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "readOnly": false,
              "removed": true
            },
            {
              "id": "TECNICASREUNIDAS",
              "displayName": "TECNICASREUNIDAS",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "readOnly": false,
              "removed": true
            },
            {
              "id": "SACYR",
              "displayName": "SACYR",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "readOnly": false,
              "removed": true
            },
            {
              "id": "SENER",
              "displayName": "SENER",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "readOnly": false,
              "removed": true
            },
            {
              "id": "WORLEY",
              "displayName": "WORLEY",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "readOnly": false,
              "removed": true
            }
          ],
          "attemptToConvertTypes": false,
          "convertFieldsToString": false
        },
        "options": {}
      },
      "id": "f5ee17de-1ccd-4936-937f-a4d213fe5211",
      "name": "Update RFQ EA",
      "type": "n8n-nodes-base.dataTable",
      "typeVersion": 1,
      "position": [
        4576,
        368
      ]
    },
    {
      "parameters": {
        "operation": "update",
        "dataTableId": {
          "__rl": true,
          "value": "hwY1VFb924Ptf1P6",
          "mode": "list",
          "cachedResultName": "Tabla-RFQ-v1",
          "cachedResultUrl": "/projects/YoqFb1alZvPQmuNs/datatables/hwY1VFb924Ptf1P6"
        },
        "filters": {
          "conditions": [
            {
              "keyValue": "={{ $json.id }}"
            }
          ]
        },
        "columns": {
          "mappingMode": "defineBelow",
          "value": {
            "SACYR": "={{ $('Parsear y Preparar Update').item.json.SACYR }}"
          },
          "matchingColumns": [
            "id"
          ],
          "schema": [
            {
              "id": "Evaluation",
              "displayName": "Evaluation",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "readOnly": false,
              "removed": true
            },
            {
              "id": "fase",
              "displayName": "fase",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "readOnly": false,
              "removed": true
            },
            {
              "id": "descripcion_item",
              "displayName": "descripcion_item",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "readOnly": false,
              "removed": true
            },
            {
              "id": "TRESCA",
              "displayName": "TRESCA",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "readOnly": false,
              "removed": true
            },
            {
              "id": "EA",
              "displayName": "EA",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "readOnly": false,
              "removed": true
            },
            {
              "id": "IDOM",
              "displayName": "IDOM",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "readOnly": false,
              "removed": true
            },
            {
              "id": "TECNICASREUNIDAS",
              "displayName": "TECNICASREUNIDAS",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "readOnly": false,
              "removed": true
            },
            {
              "id": "SACYR",
              "displayName": "SACYR",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "readOnly": false,
              "removed": false
            },
            {
              "id": "SENER",
              "displayName": "SENER",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "readOnly": false,
              "removed": true
            },
            {
              "id": "WORLEY",
              "displayName": "WORLEY",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "readOnly": false,
              "removed": true
            }
          ],
          "attemptToConvertTypes": false,
          "convertFieldsToString": false
        },
        "options": {}
      },
      "id": "b309bd4b-a342-4042-83c3-c132831a3a2f",
      "name": "Update RFQ SACYR",
      "type": "n8n-nodes-base.dataTable",
      "typeVersion": 1,
      "position": [
        4576,
        192
      ]
    },
    {
      "parameters": {
        "operation": "update",
        "dataTableId": {
          "__rl": true,
          "value": "hwY1VFb924Ptf1P6",
          "mode": "list",
          "cachedResultName": "Tabla-RFQ-v1",
          "cachedResultUrl": "/projects/YoqFb1alZvPQmuNs/datatables/hwY1VFb924Ptf1P6"
        },
        "filters": {
          "conditions": [
            {
              "keyValue": "={{ $json.id }}"
            }
          ]
        },
        "columns": {
          "mappingMode": "defineBelow",
          "value": {
            "IDOM": "={{ $('Parsear y Preparar Update').item.json.IDOM }}"
          },
          "matchingColumns": [
            "id"
          ],
          "schema": [
            {
              "id": "Evaluation",
              "displayName": "Evaluation",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "readOnly": false,
              "removed": true
            },
            {
              "id": "fase",
              "displayName": "fase",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "readOnly": false,
              "removed": true
            },
            {
              "id": "descripcion_item",
              "displayName": "descripcion_item",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "readOnly": false,
              "removed": true
            },
            {
              "id": "TRESCA",
              "displayName": "TRESCA",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "readOnly": false,
              "removed": true
            },
            {
              "id": "EA",
              "displayName": "EA",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "readOnly": false,
              "removed": true
            },
            {
              "id": "IDOM",
              "displayName": "IDOM",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "readOnly": false,
              "removed": false
            },
            {
              "id": "TECNICASREUNIDAS",
              "displayName": "TECNICASREUNIDAS",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "readOnly": false,
              "removed": true
            },
            {
              "id": "SACYR",
              "displayName": "SACYR",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "readOnly": false,
              "removed": true
            },
            {
              "id": "SENER",
              "displayName": "SENER",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "readOnly": false,
              "removed": true
            },
            {
              "id": "WORLEY",
              "displayName": "WORLEY",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "readOnly": false,
              "removed": true
            }
          ],
          "attemptToConvertTypes": false,
          "convertFieldsToString": false
        },
        "options": {}
      },
      "id": "c8ba2590-0a61-42ad-bc3b-ee90974d35bf",
      "name": "Update RFQ IDOM",
      "type": "n8n-nodes-base.dataTable",
      "typeVersion": 1,
      "position": [
        4576,
        0
      ]
    },
    {
      "parameters": {
        "operation": "update",
        "dataTableId": {
          "__rl": true,
          "value": "hwY1VFb924Ptf1P6",
          "mode": "list",
          "cachedResultName": "Tabla-RFQ-v1",
          "cachedResultUrl": "/projects/YoqFb1alZvPQmuNs/datatables/hwY1VFb924Ptf1P6"
        },
        "filters": {
          "conditions": [
            {
              "keyValue": "={{ $json.id }}"
            }
          ]
        },
        "columns": {
          "mappingMode": "defineBelow",
          "value": {
            "TECNICASREUNIDAS": "={{ $('Parsear y Preparar Update').item.json.TECNICASREUNIDAS }}"
          },
          "matchingColumns": [
            "id"
          ],
          "schema": [
            {
              "id": "Evaluation",
              "displayName": "Evaluation",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "readOnly": false,
              "removed": true
            },
            {
              "id": "fase",
              "displayName": "fase",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "readOnly": false,
              "removed": true
            },
            {
              "id": "descripcion_item",
              "displayName": "descripcion_item",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "readOnly": false,
              "removed": true
            },
            {
              "id": "TRESCA",
              "displayName": "TRESCA",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "readOnly": false,
              "removed": true
            },
            {
              "id": "EA",
              "displayName": "EA",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "readOnly": false,
              "removed": true
            },
            {
              "id": "IDOM",
              "displayName": "IDOM",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "readOnly": false,
              "removed": true
            },
            {
              "id": "TECNICASREUNIDAS",
              "displayName": "TECNICASREUNIDAS",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "readOnly": false,
              "removed": false
            },
            {
              "id": "SACYR",
              "displayName": "SACYR",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "readOnly": false,
              "removed": true
            },
            {
              "id": "SENER",
              "displayName": "SENER",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "readOnly": false,
              "removed": true
            },
            {
              "id": "WORLEY",
              "displayName": "WORLEY",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "readOnly": false,
              "removed": true
            }
          ],
          "attemptToConvertTypes": false,
          "convertFieldsToString": false
        },
        "options": {}
      },
      "id": "eec23d29-93db-41df-8815-5ee35c19e8d6",
      "name": "Update RFQ TR",
      "type": "n8n-nodes-base.dataTable",
      "typeVersion": 1,
      "position": [
        4576,
        -192
      ]
    },
    {
      "parameters": {
        "rules": {
          "values": [
            {
              "conditions": {
                "options": {
                  "caseSensitive": true,
                  "leftValue": "",
                  "typeValidation": "strict",
                  "version": 3
                },
                "conditions": [
                  {
                    "leftValue": "={{ $('Expandir por Tipo de EvaluaciÃ³n').first().json.proveedor_detectado }}",
                    "rightValue": "TECNICASREUNIDAS",
                    "operator": {
                      "type": "string",
                      "operation": "equals"
                    },
                    "id": "f3688704-f30f-4143-8008-ae6c1a06eea1"
                  }
                ],
                "combinator": "and"
              }
            },
            {
              "conditions": {
                "options": {
                  "caseSensitive": true,
                  "leftValue": "",
                  "typeValidation": "strict",
                  "version": 3
                },
                "conditions": [
                  {
                    "id": "c2c6726d-ea3f-4909-a535-6f402eef63b8",
                    "leftValue": "={{ $('Expandir por Tipo de EvaluaciÃ³n').first().json.proveedor_detectado }}",
                    "rightValue": "IDOM",
                    "operator": {
                      "type": "string",
                      "operation": "equals"
                    }
                  }
                ],
                "combinator": "and"
              }
            },
            {
              "conditions": {
                "options": {
                  "caseSensitive": true,
                  "leftValue": "",
                  "typeValidation": "strict",
                  "version": 3
                },
                "conditions": [
                  {
                    "id": "a64d8e41-6f32-489d-bf60-3bd22c9c9374",
                    "leftValue": "={{ $('Expandir por Tipo de EvaluaciÃ³n').first().json.proveedor_detectado }}",
                    "rightValue": "SACYR",
                    "operator": {
                      "type": "string",
                      "operation": "equals"
                    }
                  }
                ],
                "combinator": "and"
              }
            },
            {
              "conditions": {
                "options": {
                  "caseSensitive": true,
                  "leftValue": "",
                  "typeValidation": "strict",
                  "version": 3
                },
                "conditions": [
                  {
                    "id": "42a16d6b-db65-401d-abb0-f8ae9aefff12",
                    "leftValue": "={{ $('Expandir por Tipo de EvaluaciÃ³n').first().json.proveedor_detectado }}",
                    "rightValue": "EA",
                    "operator": {
                      "type": "string",
                      "operation": "equals",
                      "name": "filter.operator.equals"
                    }
                  }
                ],
                "combinator": "and"
              }
            },
            {
              "conditions": {
                "options": {
                  "caseSensitive": true,
                  "leftValue": "",
                  "typeValidation": "strict",
                  "version": 3
                },
                "conditions": [
                  {
                    "id": "79599b4a-f8d0-4078-913a-2b40bea117c4",
                    "leftValue": "={{ $('Expandir por Tipo de EvaluaciÃ³n').first().json.proveedor_detectado }}",
                    "rightValue": "SENER",
                    "operator": {
                      "type": "string",
                      "operation": "equals",
                      "name": "filter.operator.equals"
                    }
                  }
                ],
                "combinator": "and"
              }
            },
            {
              "conditions": {
                "options": {
                  "caseSensitive": true,
                  "leftValue": "",
                  "typeValidation": "strict",
                  "version": 3
                },
                "conditions": [
                  {
                    "id": "59b13bbc-96bb-4e22-8fde-5c2fb10c8675",
                    "leftValue": "={{ $('Expandir por Tipo de EvaluaciÃ³n').first().json.proveedor_detectado }}",
                    "rightValue": "TRESCA",
                    "operator": {
                      "type": "string",
                      "operation": "equals",
                      "name": "filter.operator.equals"
                    }
                  }
                ],
                "combinator": "and"
              }
            },
            {
              "conditions": {
                "options": {
                  "caseSensitive": true,
                  "leftValue": "",
                  "typeValidation": "strict",
                  "version": 3
                },
                "conditions": [
                  {
                    "id": "d1601299-eed6-4754-b538-5e32d16a2a40",
                    "leftValue": "={{ $('Expandir por Tipo de EvaluaciÃ³n').first().json.proveedor_detectado }}",
                    "rightValue": "WORLEY",
                    "operator": {
                      "type": "string",
                      "operation": "equals",
                      "name": "filter.operator.equals"
                    }
                  }
                ],
                "combinator": "and"
              }
            }
          ]
        },
        "options": {
          "fallbackOutput": "extra"
        }
      },
      "type": "n8n-nodes-base.switch",
      "typeVersion": 3.4,
      "position": [
        4176,
        288
      ],
      "id": "44eb61e5-650c-4bf7-bbb9-fa23ed62de83",
      "name": "Switch"
    },
    {
      "parameters": {
        "promptType": "define",
        "text": "=### CONTEXTO DEL DOCUMENTO\n\nProveedor: {{ $('Expandir por Tipo de EvaluaciÃ³n').first().json.proveedor_detectado }}\n\nTipo de Oferta: {{ $('Expandir por Tipo de EvaluaciÃ³n').first().json.tipo_evaluacion_actual }}\n\nTexto ExtraÃ­do:\n{{ $('Expandir por Tipo de EvaluaciÃ³n').first().json.texto_oferta_completo }}\n\n---\n### ITEMS A EVALUAR (CON REQUISITOS RFQ):\n{{ $json.lista_items_json }}\nIMPORTANTE: \"rfq_requisito\" contiene lo que el CLIENTE EXIGE.\nTu trabajo es comparar la OFERTA DEL PROVEEDOR contra estos REQUISITOS ESPECÃFICOS.",
        "messages": {
          "messageValues": [
            {
              "message": "=# ERES UN AUDITOR DE RFQ. TU TRABAJO ES BINARIO Y ESTRICTO.\n\n---\n\n## PROTOCOLO DE EXTRACCIÃ“N\n\nDebes elegir UN SOLO MODO de operaciÃ³n basado en la variable \"tipo_evaluacion_actual\".\n\n---\n\n## MODO A: EVALUACIÃ“N ECONÃ“MICA\n\n**CONDICIÃ“N:** tipo_evaluacion_actual = \"Economical Evaluation\"\n\n**OBJETIVO:** Extraer VALORES MONETARIOS, TARIFAS o PORCENTAJES.\n\n**PROHIBICIÃ“N ABSOLUTA:** NUNCA usar la palabra \"INCLUIDO\" en este modo.\n\n### Reglas de DecisiÃ³n:\n\n1. **Â¿Hay un VALOR NUMÃ‰RICO con moneda/unidad?**\n   - Responde: [VALOR] - [Contexto breve] | Ref: [UbicaciÃ³n]\n   - Ejemplo: \"45.000 EUR - Precio fijo por ingenierÃ­a bÃ¡sica | Ref: Tabla 3.2\"\n\n2. **Â¿Se menciona el Ã­tem pero SIN CIFRA asociada?**\n   - Responde: SIN VALORAR - [Breve explicaciÃ³n] | Ref: [UbicaciÃ³n]\n   - Ejemplo: \"SIN VALORAR - Incluido en alcance sin desglose de precio | Ref: PÃ¡g 12\"\n\n3. **Â¿NO se menciona el Ã­tem?**\n   - Responde: NO COTIZADO\n\n### PROTOCOLO ANTI-ALUCINACIÃ“N PARA MODO ECONÃ“MICO:\n\n**ANTES de reportar cualquier precio, verifica:**\n\nCHECKLIST OBLIGATORIO (Responde SÃ/NO a cada pregunta):\n1. Â¿Veo el NÃšMERO exacto en el texto?\n2. Â¿Veo la MONEDA (EUR, USD, $, â‚¬) en la MISMA frase?\n3. Â¿El nÃºmero estÃ¡ claramente asociado al Ã­tem solicitado?\n4. Â¿Puedo citar textualmente la frase completa que contiene precio + concepto?\n\n**SI CUALQUIER RESPUESTA ES NO:** Usar \"SIN VALORAR\" + explicar quÃ© falta\n\n**EJEMPLOS DE VALIDACIÃ“N:**\n\nTEXTO: \"IngenierÃ­a bÃ¡sica: 45.000 EUR\"\n- NÃšMERO: SÃ (45.000)\n- MONEDA: SÃ (EUR)\n- ASOCIACIÃ“N: SÃ (IngenierÃ­a bÃ¡sica)\n- CITA: SÃ (puedo citar la frase completa)\nâ†’ VÃLIDO: \"45.000 EUR - Precio fijo | Ref: PÃ¡g X\"\n\nTEXTO: \"El coste de ingenierÃ­a se incluye en el alcance general\"\n- NÃšMERO: NO\n- MONEDA: NO\n- ASOCIACIÃ“N: SÃ (menciona ingenierÃ­a)\n- CITA: Parcial\nâ†’ INVÃLIDO: \"SIN VALORAR - Mencionado sin cifra asociada | Ref: PÃ¡g X\"\n\nTEXTO: \"45.000\"\n- NÃšMERO: SÃ\n- MONEDA: NO (podrÃ­a ser cÃ³digo, aÃ±o, coordenada)\n- ASOCIACIÃ“N: Dudoso\n- CITA: Insuficiente\nâ†’ INVÃLIDO: \"SIN VALORAR - NÃºmero sin contexto de moneda | Ref: PÃ¡g X\"\n\n### PROHIBICIONES:\n\n- NUNCA usar \"INCLUIDO\" en modo econÃ³mico\n- NUNCA inferir precios de Ã­tems similares\n- NUNCA calcular totales sin base textual explÃ­cita\n- NUNCA asumir que un nÃºmero sin moneda es un precio\n- Si hay duda: usar \"SIN VALORAR\" + explicar ambigÃ¼edad\n\n---\n\n## MODO B: EVALUACIÃ“N TÃ‰CNICA/DELIVERABLES\n\n**CONDICIÃ“N:** tipo_evaluacion_actual IN (\"Technical Evaluation\", \"Pre-FEED Deliverables\", \"FEED Deliverables\")\n\n**OBJETIVO:** Verificar ALCANCE TÃ‰CNICO (el precio es irrelevante).\n\n### Reglas de DecisiÃ³n:\n\n1. **Â¿Se describe/menciona el trabajo o entregable?**\n   - Responde: INCLUIDO - [Resumen del alcance] | Ref: [UbicaciÃ³n]\n   - Ejemplo: \"INCLUIDO - DiseÃ±o de sistemas de tuberÃ­as hasta lÃ­mites de baterÃ­a | Ref: SecciÃ³n 3.1, Tabla 4\"\n\n2. **Â¿Se excluye explÃ­citamente?**\n   - Responde: NO INCLUIDO - [Motivo de exclusiÃ³n] | Ref: [UbicaciÃ³n]\n   - Ejemplo: \"NO INCLUIDO - Servicios auxiliares fuera de alcance contractual | Ref: PÃ¡g 12, ClÃ¡usula 8\"\n\n3. **Â¿EstÃ¡ cubierto solo parcialmente?**\n   - Responde: PARCIAL - [QuÃ© estÃ¡ incluido y quÃ© no] | Ref: [UbicaciÃ³n]\n   - Ejemplo: \"PARCIAL - IngenierÃ­a bÃ¡sica incluida, detalle requiere aprobaciÃ³n | Ref: Anexo B.2\"\n\n4. **Â¿NO hay informaciÃ³n?**\n   - Responde: SIN INFORMACIÃ“N\n\n### PROTOCOLO ANTI-ALUCINACIÃ“N PARA MODO TÃ‰CNICO:\n\n**ANTES de reportar \"INCLUIDO\", verifica:**\n\nCHECKLIST OBLIGATORIO:\n1. Â¿El Ã­tem estÃ¡ mencionado explÃ­citamente en el texto?\n2. Â¿Hay descripciÃ³n de cÃ³mo se ejecutarÃ¡ o quÃ© incluye?\n3. Â¿Puedo citar la frase exacta donde aparece?\n4. Â¿Es una afirmaciÃ³n positiva de inclusiÃ³n (no una negaciÃ³n)?\n\n**SI FALTA CUALQUIERA:** Usar \"SIN INFORMACIÃ“N\" o buscar mÃ¡s evidencia\n\n**EJEMPLOS DE VALIDACIÃ“N:**\n\nTEXTO: \"Se realizarÃ¡ anÃ¡lisis de suelos mediante ensayos SPT en 5 ubicaciones\"\n- MENCIÃ“N: SÃ (anÃ¡lisis de suelos)\n- DESCRIPCIÃ“N: SÃ (ensayos SPT, 5 ubicaciones)\n- CITA: SÃ (puedo citar completo)\n- AFIRMACIÃ“N POSITIVA: SÃ (\"Se realizarÃ¡\")\nâ†’ VÃLIDO: \"INCLUIDO - AnÃ¡lisis de suelos con ensayos SPT en 5 puntos | Ref: PÃ¡g X\"\n\nTEXTO: \"La ingenierÃ­a estructural se desarrollarÃ¡ conforme a norma ACI-318\"\n- MENCIÃ“N: SÃ\n- DESCRIPCIÃ“N: SÃ (metodologÃ­a normativa)\n- CITA: SÃ\n- AFIRMACIÃ“N POSITIVA: SÃ\nâ†’ VÃLIDO: \"INCLUIDO - IngenierÃ­a estructural segÃºn ACI-318 | Ref: PÃ¡g X\"\n\nTEXTO: \"No incluye servicios de topografÃ­a\"\n- MENCIÃ“N: SÃ (topografÃ­a)\n- DESCRIPCIÃ“N: SÃ (exclusiÃ³n clara)\n- CITA: SÃ\n- AFIRMACIÃ“N POSITIVA: NO (es negaciÃ³n)\nâ†’ VÃLIDO: \"NO INCLUIDO - ExclusiÃ³n explÃ­cita | Ref: PÃ¡g X\"\n\nTEXTO: \"Los estudios necesarios serÃ¡n determinados\"\n- MENCIÃ“N: GenÃ©rico (\"estudios\")\n- DESCRIPCIÃ“N: NO (muy vago)\n- CITA: Insuficiente\n- AFIRMACIÃ“N POSITIVA: Ambiguo\nâ†’ INVÃLIDO: \"SIN INFORMACIÃ“N - MenciÃ³n genÃ©rica sin detalle\"\n\n### GUÃAS DE INTERPRETACIÃ“N:\n\n- \"Parte del alcance\" significa INCLUIDO\n- \"SegÃºn necesidad del cliente\" significa PARCIAL\n- \"Fuera de lÃ­mites\" significa NO INCLUIDO\n- \"A definir\", \"TBD\", \"sujeto a\" significa PARCIAL\n- Silencio total significa SIN INFORMACIÃ“N\n- MenciÃ³n muy genÃ©rica sin detalle significa SIN INFORMACIÃ“N\n\n### REGLA CRÃTICA - NO INFERIR:\n\n- Si el Ã­tem es \"AnÃ¡lisis sÃ­smico\" y solo dice \"anÃ¡lisis estructural\" â†’ SIN INFORMACIÃ“N (no asumir que incluye sÃ­smico)\n- Si el Ã­tem es \"Planos arquitectÃ³nicos\" y solo dice \"documentaciÃ³n tÃ©cnica\" â†’ SIN INFORMACIÃ“N (no asumir)\n- SOLO marca INCLUIDO si el Ã­tem estÃ¡ mencionado especÃ­ficamente o muy claramente abarcado\n\n---\n\n## VALIDACIÃ“N DE FASE\n\n**Regla CrÃ­tica:** Si el Ã­tem solicita precio para fase \"EPC\" pero el documento es \"FEED\":\n- Responde: \"NO COTIZADO (Fase incorrecta - Documento: FEED, Solicitado: EPC)\"\n\n---\n\n## FORMATO DE SALIDA (JSON)\n```json[\n{\n\"id\": 101,\n\"cumple\": \"[ESTADO] - [DescripciÃ³n]\",\n\"gap_analysis\": \"Cita: '[Texto literal del documento]' | Ref: [UbicaciÃ³n exacta]\"\n}\n]\n\n### Estructura del campo \"cumple\":\n\n**Para EconÃ³micas:**\n- \"45.000 EUR - Precio fijo por diseÃ±o completo\"\n- \"SIN VALORAR - Mencionado sin cifra asociada\"\n- \"NO COTIZADO\"\n\n**Para TÃ©cnicas/Deliverables:**\n- \"INCLUIDO - DescripciÃ³n del alcance cubierto\"\n- \"NO INCLUIDO - Motivo de exclusiÃ³n\"\n- \"PARCIAL - QuÃ© estÃ¡ y quÃ© no estÃ¡ incluido\"\n- \"SIN INFORMACIÃ“N\"\n\n### Estructura del campo \"gap_analysis\":\n\nSIEMPRE incluir:\n1. Cita textual breve (mÃ¡ximo 20 palabras)\n2. Referencia precisa (pÃ¡gina, secciÃ³n, tabla)\n3. Nota aclaratoria si aplica\n\n**Ejemplo completo:**\n```json{\n\"id\": 42,\n\"cumple\": \"INCLUIDO - Sistema de tuberÃ­as hasta lÃ­mites de baterÃ­a\",\n\"gap_analysis\": \"Cita: 'Incluye diseÃ±o e instalaciÃ³n de tuberÃ­as hasta BL' | Ref: SecciÃ³n 3.1, Tabla 4 | Nota: No incluye equipos externos\"\n}\n\n---\n\n## COMPARACIÃ“N CONTRA REQUISITOS RFQ\n\n**REGLA CRÃTICA:** Para cada Ã­tem, DEBES comparar la oferta del proveedor contra el campo `rfq_requisito`.\n\n### LÃ“GICA DE COMPARACIÃ“N:\n\n**SI rfq_requisito = \"NO ESPECIFICADO EN RFQ\":**\n- EvalÃºa solo si el proveedor menciona el Ã­tem (comportamiento actual)\n\n**SI rfq_requisito TIENE CONTENIDO:**\n- COMPARA la oferta contra los requisitos especÃ­ficos\n- Verifica: Â¿Cumple con las especificaciones exigidas?\n- Verifica: Â¿Cumple con las normativas requeridas?\n- Verifica: Â¿Cumple con las cantidades/formatos solicitados?\n\n### FORMATO DE RESPUESTA CON COMPARACIÃ“N:\n\n**Para EvaluaciÃ³n TÃ©cnica:**\n```\nCUMPLE - Oferta cumple requisito RFQ: [Resumen de cumplimiento] | Ref: [UbicaciÃ³n en oferta]\nPARCIAL - Cumple [X], falta [Y segÃºn RFQ] | Ref: [UbicaciÃ³n]\nNO CUMPLE - RFQ exige [X], oferta indica [Y] | Ref: [UbicaciÃ³n]\nSIN INFORMACIÃ“N - No se puede verificar contra requisito RFQ\n```\n\n**Para EvaluaciÃ³n EconÃ³mica:**\n```\n[PRECIO] - [ComparaciÃ³n vs formato RFQ] | Ref: [UbicaciÃ³n]\nEjemplo: \"45.000 EUR - Cumple formato Lump Sum requerido, incluye desglose por fase | Ref: Tabla 3\"\nEjemplo: \"85 EUR/h - NO cumple: RFQ pide precio global, oferta da tarifa horaria | Ref: PÃ¡g 12\"\n```\n\n### EJEMPLO DE EVALUACIÃ“N COMPARATIVA:\n\n**Input:**\n```json\n{\n  \"id\": 101,\n  \"item\": \"DiseÃ±o de tuberÃ­as de proceso\",\n  \"rfq_requisito\": \"DiÃ¡metros 2\\\"-24\\\" | Norma: ASME B31.3 | Material: SS316L\"\n}\n```\n\n**Texto Oferta:** \"Incluye diseÃ±o de tuberÃ­as 1\\\"-36\\\" segÃºn ASME B31.3, material acero inoxidable 304\"\n\n**Output Correcto:**\n```json\n{\n  \"id\": 101,\n  \"cumple\": \"PARCIAL - Cumple norma ASME B31.3, rango diÃ¡metros mayor (1\\\"-36\\\" vs 2\\\"-24\\\"), pero material SS304 no cumple requisito SS316L\",\n  \"gap_analysis\": \"Cita: 'tuberÃ­as 1\\\"-36\\\" segÃºn ASME B31.3, material acero inoxidable 304' | Ref: SecciÃ³n 3.2, PÃ¡g 15 | GAP: Material no conforme\"\n}\n\n\n\n---\n\n## REGLA ABSOLUTA: PROCESAR TODOS LOS ÃTEMS\n\n**CRÃTICO:** El JSON de salida DEBE contener EXACTAMENTE el mismo nÃºmero de Ã­tems que recibiste en la lista de entrada.\n\n**SI UN ÃTEM NO TIENE INFORMACIÃ“N:**\n- NO lo omitas del JSON\n- NO lo dejes en blanco\n- Devuelve: \"SIN INFORMACIÃ“N\" o \"NO COTIZADO\" segÃºn corresponda\n\n**VERIFICACIÃ“N FINAL ANTES DE RESPONDER:**\n1. Cuenta cuÃ¡ntos Ã­tems recibiste en el input\n2. Cuenta cuÃ¡ntos Ã­tems tienes en tu JSON de salida\n3. Si los nÃºmeros no coinciden â†’ REVISA y completa los faltantes\n\n---\n\n## INSTRUCCIONES DE EJECUCIÃ“N\n\n1. LEE la lista completa de Ã­tems\n2. IDENTIFICA el modo (EconÃ³mico vs TÃ©cnico) basado en \"tipo_evaluacion_actual\"\n3. Para CADA Ã­tem individualmente:\n   a. BUSCA el Ã­tem en el texto usando tÃ©rminos clave\n   b. APLICA el checklist anti-alucinaciÃ³n correspondiente\n   c. Si pasa el checklist â†’ reporta el hallazgo\n   d. Si no pasa â†’ usa \"SIN VALORAR\" o \"SIN INFORMACIÃ“N\"\n   e. NUNCA omitas el Ã­tem del JSON\n4. VERIFICA que tienes el mismo nÃºmero de Ã­tems en el output que en el input\n5. FORMATEA la respuesta en JSON vÃ¡lido\n\n**IMPORTANTE:** Tu credibilidad depende de NO inventar informaciÃ³n. Es mejor decir \"SIN INFORMACIÃ“N\" con honestidad que reportar datos que no existen en el documento."
            }
          ]
        },
        "batching": {}
      },
      "type": "@n8n/n8n-nodes-langchain.chainLlm",
      "typeVersion": 1.7,
      "position": [
        2560,
        144
      ],
      "id": "77c94550-e26e-49c9-aa5f-fe10c036368f",
      "name": "LLM Chain"
    },
    {
      "parameters": {
        "jsCode": "// 1. Obtener la respuesta del LLM\nconst llmOutput = $input.first().json.text || $input.first().json.content || \"[]\";\nlet parsedData = [];\n\n// 2. Intentar parsear el JSON del LLM\ntry {\n  let cleanOutput = llmOutput\n    .replace(/```json/gi, '')\n    .replace(/```/g, '')\n    .trim();\n  \n  const firstBracket = cleanOutput.indexOf('[');\n  const lastBracket = cleanOutput.lastIndexOf(']');\n  \n  if (firstBracket !== -1 && lastBracket !== -1) {\n    const jsonString = cleanOutput.substring(firstBracket, lastBracket + 1);\n    parsedData = JSON.parse(jsonString);\n  }\n} catch (e) {\n  console.log(\"âš ï¸ Error parseando JSON del LLM, se usarÃ¡n valores por defecto.\");\n}\n\n// 3. RECUPERAR LA LISTA ORIGINAL (La fuente de la verdad)\n// Esto asegura que si enviamos 50 Ã­tems, salgan 50 Ã­tems, pase lo que pase.\nlet originalItems = [];\ntry {\n    originalItems = JSON.parse($('Code in JavaScript').first().json.lista_items_json);\n} catch (e) {\n    throw new Error(\"No se pudo recuperar la lista original de Ã­tems del nodo anterior\");\n}\n\n// 4. Identificar el Proveedor\nlet proveedor = \"OTROS\";\ntry {\n  proveedor = $('Expandir por Tipo de EvaluaciÃ³n').first().json.proveedor_detectado;\n} catch (e) {\n  try {\n     proveedor = $('Loop Over Items1').first().json.proveedor_detectado;\n  } catch(e2) {}\n}\n\n// 5. MERGE (CRÃTICO): Cruzar la lista original con la respuesta del LLM\nreturn originalItems.map(originalItem => {\n    // Buscamos si el LLM respondiÃ³ algo para este ID\n    const found = parsedData.find(p => p.id === originalItem.id);\n    \n    let resultado = \"\";\n    \n    if (found && found.cumple) {\n        // Caso: El LLM respondiÃ³ correctamente\n        const gap = found.gap_analysis || \"Sin justificaciÃ³n\";\n        resultado = `${found.cumple} - ${gap}`;\n    } else {\n        // Caso: El LLM ignorÃ³ este Ã­tem (ALERTA PARA TI)\n        resultado = \"ERROR_LLM: Ãtem no procesado por la IA\";\n    }\n\n    return {\n        json: {\n            id: originalItem.id,\n            [proveedor]: resultado\n        }\n    };\n});"
      },
      "id": "9d8181e3-fa1f-4abc-a12f-8c23deee2d82",
      "name": "Parsear y Preparar Update",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        3088,
        144
      ]
    },
    {
      "parameters": {
        "jsCode": "// Tomamos los Ã­tems del lote actual (ej. 15 filas)\nconst items = $input.all();\n\n// Creamos la lista limpia solo con ID y DescripciÃ³n para ahorrar tokens\nconst listaParaLLM = items.map(i => ({\n    id: i.json.id,\n    fase: i.json.fase,\n    requisito_rfq: i.json.requisito_rfq|| \"NO ESPECIFICADO EN RFQ\"\n}));\n\n// Devolvemos UN SOLO ÃTEM que contiene la lista stringificada.\n// Esto obliga al nodo LLM a ejecutarse UNA vez por cada lote de 15.\nreturn {\n    json: {\n        lista_items_json: JSON.stringify(listaParaLLM),\n        batch_size: items.length\n    }\n};"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        2224,
        144
      ],
      "id": "236327ed-1e2f-4e4a-aa30-dcbc90f9240d",
      "name": "Code in JavaScript"
    },
    {
      "parameters": {
        "numberInputs": 7
      },
      "type": "n8n-nodes-base.merge",
      "typeVersion": 3.2,
      "position": [
        4976,
        288
      ],
      "id": "a605b41a-2115-4fa5-9ae7-aafac41eae07",
      "name": "Merge"
    },
    {
      "parameters": {
        "batchSize": 50,
        "options": {
          "reset": "={{ $json.reiniciar_bucle ? true : false }}"
        }
      },
      "type": "n8n-nodes-base.splitInBatches",
      "typeVersion": 3,
      "position": [
        1920,
        144
      ],
      "id": "261c3bd7-dbbd-4478-8b98-77e2d5725d9d",
      "name": "Loop Over Items"
    },
    {
      "parameters": {
        "content": "### Ingesta de Ofertas de Proveedores",
        "height": 1776,
        "width": 5088,
        "color": 5
      },
      "type": "n8n-nodes-base.stickyNote",
      "typeVersion": 1,
      "position": [
        96,
        -256
      ],
      "id": "8baf3086-c1b6-4d13-ac0e-641cbef54c09",
      "name": "Sticky Note5"
    },
    {
      "parameters": {
        "content": "### Ingesta de RFQ, actualizaciÃ³n de requisitos",
        "height": 1312,
        "width": 4016,
        "color": 4
      },
      "type": "n8n-nodes-base.stickyNote",
      "typeVersion": 1,
      "position": [
        128,
        1792
      ],
      "id": "052c77bc-f62a-49b1-acf6-a05f7ef71ff1",
      "name": "Sticky Note"
    },
    {
      "parameters": {
        "assignments": {
          "assignments": [
            {
              "id": "10646eae-ae46-4327-a4dc-9987c2d76173",
              "name": "file_id",
              "value": "={{ $json.body.file_id }}",
              "type": "string"
            },
            {
              "id": "77d782de-169d-4a46-8a8e-a3831c04d90f",
              "name": "file_title",
              "value": "={{ $json.body.file_title }}",
              "type": "string"
            },
            {
              "id": "b1dbe9b9-248a-4593-a769-a085b34e0810",
              "name": "file_binary",
              "value": "={{ $json.body.file_binary }}",
              "type": "string"
            },
            {
              "id": "74d93dce-cddc-4947-ae19-88bc5cacd146",
              "name": "file_metadata",
              "value": "={{ $json.body.metadata }}",
              "type": "string"
            }
          ]
        },
        "options": {}
      },
      "id": "a5765fc0-89bf-485a-964a-bceef1a42aa1",
      "name": "Set File ID2",
      "type": "n8n-nodes-base.set",
      "typeVersion": 3.4,
      "position": [
        448,
        4864
      ]
    },
    {
      "parameters": {
        "operation": "delete",
        "tableId": "documents_rfq",
        "filterType": "string",
        "filterString": "=metadata->>file_id=like.*{{ $json.file_id }}*"
      },
      "id": "7baaa50d-17af-48df-805e-16eaed068ab3",
      "name": "Delete Old Doc Rows2",
      "type": "n8n-nodes-base.supabase",
      "typeVersion": 1,
      "position": [
        672,
        4864
      ],
      "alwaysOutputData": true,
      "disabled": true
    },
    {
      "parameters": {
        "operation": "upsert",
        "schema": {
          "__rl": true,
          "mode": "list",
          "value": "public"
        },
        "table": {
          "__rl": true,
          "value": "document_metadata",
          "mode": "list",
          "cachedResultName": "document_metadata"
        },
        "columns": {
          "mappingMode": "defineBelow",
          "value": {
            "id": "={{ $('Set File ID2').item.json.file_id }}",
            "title": "={{ $('Set File ID2').item.json.file_title }}",
            "url": "={{ $('Set File ID2').item.json.file_url }}"
          },
          "matchingColumns": [
            "id"
          ],
          "schema": [
            {
              "id": "id",
              "displayName": "id",
              "required": true,
              "defaultMatch": true,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            },
            {
              "id": "title",
              "displayName": "title",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": false
            },
            {
              "id": "url",
              "displayName": "url",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": false
            },
            {
              "id": "created_at",
              "displayName": "created_at",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "dateTime",
              "canBeUsedToMatch": false,
              "removed": false
            },
            {
              "id": "schema",
              "displayName": "schema",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": false,
              "removed": false
            }
          ],
          "attemptToConvertTypes": false,
          "convertFieldsToString": false
        },
        "options": {}
      },
      "type": "n8n-nodes-base.postgres",
      "typeVersion": 2.5,
      "position": [
        896,
        4864
      ],
      "id": "07f97079-1f6a-4b1c-ba44-005fffa92a8b",
      "name": "Insert Document Metadata2",
      "executeOnce": true,
      "disabled": true
    },
    {
      "parameters": {
        "respondWith": "text",
        "responseBody": "={\"success\": true, \"message\": \"RFQ procesada correctamente\", \"file_id\": \"{{ $('Set File ID2').first().json.file_id }}\", \"tipos_procesados\": {{ JSON.stringify($('Clasificador Tipo RFQ').first().json.output.tipos_detectados) }} }",
        "options": {}
      },
      "type": "n8n-nodes-base.respondToWebhook",
      "typeVersion": 1.5,
      "position": [
        3312,
        4672
      ],
      "id": "541e01f1-1be7-4abe-aa5b-a065132a1ce2",
      "name": "Respond Webhook RFQ"
    },
    {
      "parameters": {
        "promptType": "define",
        "text": "=### INPUT A ANALIZAR\nNombre archivo: {{ $json.metadata.file_title }}\n\nTexto (Inicio del documento): \n{{ $json.text }}",
        "hasOutputParser": true,
        "messages": {
          "messageValues": [
            {
              "message": "### TAREA: CLASIFICACIÃ“N DE DOCUMENTO RFQ BASE\n\nEres un auditor senior de documentaciÃ³n de ingenierÃ­a.\nEste documento es una RFQ (Request for Quotation) emitida por el CLIENTE.\n\n---\n\n## TU OBJETIVO\n\nIdentificar quÃ© TIPOS DE REQUISITOS contiene esta RFQ para saber quÃ© columnas de la tabla deben poblarse.\n\n---\n\n## TIPOS POSIBLES\n\n### 1. \"Technical Evaluation\"\nLa RFQ contiene requisitos tÃ©cnicos como:\n- Especificaciones de ingenierÃ­a\n- Normativas aplicables (ASME, API, ISO, etc.)\n- MetodologÃ­as requeridas\n- Alcance tÃ©cnico del trabajo\n- Criterios de aceptaciÃ³n tÃ©cnica\n\n### 2. \"Economical Evaluation\"\nLa RFQ contiene requisitos econÃ³micos como:\n- Formato de cotizaciÃ³n esperado\n- Desglose de precios requerido\n- Condiciones de pago\n- Moneda de cotizaciÃ³n\n- Estructura de costos esperada\n\n### 3. \"Pre-FEED Deliverables\"\nLa RFQ solicita entregables de fase Pre-FEED:\n- Lista de documentos a entregar en Pre-FEED\n- Matriz de entregables conceptuales\n- Requisitos de formato y revisiones\n\n### 4. \"FEED Deliverables\"\nLa RFQ solicita entregables de fase FEED:\n- Lista de documentos a entregar en FEED\n- Matriz de entregables de ingenierÃ­a bÃ¡sica\n- Requisitos de formato y revisiones\n\n---\n\n## REGLAS\n\n1. Una RFQ tÃ­picamente contiene MÃšLTIPLES tipos (ej: Technical + Economical)\n2. Marca todos los tipos que apliquen\n3. Si hay duda, incluye el tipo (es mejor tener mÃ¡s cobertura)\n4. Si no hay evidencia clara de un tipo, no lo incluyas\n\n---\n\n## FORMATO DE SALIDA\n\n```json\n{\n  \"tipos_detectados\": [\"Technical Evaluation\", \"Economical Evaluation\"],\n  \"razonamiento\": \"La RFQ incluye secciÃ³n de especificaciones tÃ©cnicas (SecciÃ³n 3) con normativas ASME y API, y secciÃ³n de formato de cotizaciÃ³n (SecciÃ³n 5) con desglose de precios requerido.\"\n}\n```"
            }
          ]
        },
        "batching": {}
      },
      "type": "@n8n/n8n-nodes-langchain.chainLlm",
      "typeVersion": 1.8,
      "position": [
        1792,
        4864
      ],
      "id": "9989042a-f340-4d10-a849-8ccd851b3bf0",
      "name": "Clasificador Tipo RFQ"
    },
    {
      "parameters": {
        "schemaType": "manual",
        "inputSchema": "{\n  \"type\": \"object\",\n  \"properties\": {\n    \"tipos_detectados\": {\n      \"type\": \"array\",\n      \"items\": {\n        \"type\": \"string\",\n        \"enum\": [\n          \"Technical Evaluation\",\n          \"Economical Evaluation\",\n          \"Pre-FEED Deliverables\",\n          \"FEED Deliverables\"\n        ]\n      },\n      \"description\": \"Lista de tipos de evaluaciÃ³n detectados en el documento RFQ.\"\n    },\n    \"razonamiento\": {\n      \"type\": \"string\",\n      \"description\": \"Breve explicaciÃ³n de por quÃ© se eligieron esos tipos.\"\n    }\n  },\n  \"required\": [\n    \"tipos_detectados\"\n  ]\n}"
      },
      "type": "@n8n/n8n-nodes-langchain.outputParserStructured",
      "typeVersion": 1.3,
      "position": [
        1968,
        5088
      ],
      "id": "f7e6f11f-4569-4ae6-a93d-ece8d5c3ae86",
      "name": "Structured Output Parser RFQ"
    },
    {
      "parameters": {
        "operation": "update",
        "dataTableId": {
          "__rl": true,
          "value": "svF2jfNtm7DQCbXz",
          "mode": "list",
          "cachedResultName": "Tabla-RFQ-Ofertas",
          "cachedResultUrl": "/projects/YoqFb1alZvPQmuNs/datatables/svF2jfNtm7DQCbXz"
        },
        "filters": {
          "conditions": [
            {
              "keyValue": "={{ $json.id }}"
            }
          ]
        },
        "columns": {
          "mappingMode": "defineBelow",
          "value": {
            "rfq_requisito": "={{ $json.rfq_requisito }}"
          },
          "matchingColumns": [
            "id"
          ],
          "schema": [
            {
              "id": "Evaluation",
              "displayName": "Evaluation",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "readOnly": false,
              "removed": true
            },
            {
              "id": "fase",
              "displayName": "fase",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "readOnly": false,
              "removed": true
            },
            {
              "id": "descripcion_item",
              "displayName": "descripcion_item",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "readOnly": false,
              "removed": true
            },
            {
              "id": "rfq_requisito",
              "displayName": "rfq_requisito",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "readOnly": false,
              "removed": false
            },
            {
              "id": "IDOM",
              "displayName": "IDOM",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "readOnly": false,
              "removed": true
            },
            {
              "id": "TECNICASREUNIDAS",
              "displayName": "TECNICASREUNIDAS",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "readOnly": false,
              "removed": true
            },
            {
              "id": "SACYR",
              "displayName": "SACYR",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "readOnly": false,
              "removed": true
            },
            {
              "id": "EA",
              "displayName": "EA",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "readOnly": false,
              "removed": true
            },
            {
              "id": "SENER",
              "displayName": "SENER",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "readOnly": false,
              "removed": true
            },
            {
              "id": "TRESCA",
              "displayName": "TRESCA",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "readOnly": false,
              "removed": true
            },
            {
              "id": "WORLEY",
              "displayName": "WORLEY",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "readOnly": false,
              "removed": true
            }
          ],
          "attemptToConvertTypes": false,
          "convertFieldsToString": false
        },
        "options": {}
      },
      "type": "n8n-nodes-base.dataTable",
      "typeVersion": 1.1,
      "position": [
        4800,
        4944
      ],
      "id": "dfb40e78-3daf-42c7-ac44-30f8aa485630",
      "name": "Update rfq_requisito"
    },
    {
      "parameters": {
        "jsCode": "const items = $input.all();\n\nreturn items.map(item => ({\n    json: {\n        ...item.json,\n        reiniciar_bucle: true \n    }\n}));\n"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        3536,
        4864
      ],
      "id": "8cefd4f1-0f5a-477a-a458-1644af4c9657",
      "name": "Reset Items RFQ"
    },
    {
      "parameters": {
        "options": {}
      },
      "type": "n8n-nodes-base.splitInBatches",
      "typeVersion": 3,
      "position": [
        3088,
        4864
      ],
      "id": "253a893c-ab53-4329-9819-8c21e80bd99c",
      "name": "Loop Tipos RFQ"
    },
    {
      "parameters": {
        "jsCode": "// =============================================\n// NODO: Expandir por Tipo de EvaluaciÃ³n RFQ\n// =============================================\n\nlet sourceData = {};\ntry {\n    sourceData = $('Format RFQ for Vectorstore').first().json;\n} catch (e) {\n    console.log(\"âŒ Error: No se encuentra 'Format RFQ for Vectorstore'\");\n    sourceData = $input.first().json; \n}\n\nconst fullText = sourceData.text || \"âš ï¸ ERROR: Texto vacÃ­o\";\nconst metadata = sourceData.metadata || {};\n\nlet tipos = metadata.tipo_evaluacion;\n\nif (!tipos) {\n    tipos = [\"Technical Evaluation\"];\n}\n\nif (!Array.isArray(tipos)) {\n    if (typeof tipos === 'string') {\n        const cleanString = tipos.replace(/[\\[\\]\"]/g, ''); \n        if (cleanString.includes(',')) {\n            tipos = cleanString.split(',').map(t => t.trim());\n        } else {\n            tipos = [cleanString.trim()];\n        }\n    } else {\n        tipos = [tipos];\n    }\n}\n\nconsole.log(`ðŸ”€ Procesando RFQ: ${metadata.file_title}`);\nconsole.log(`   Tipos detectados: ${JSON.stringify(tipos)}`);\n\nreturn tipos.map((tipo, idx) => ({\n    json: {\n        tipo_evaluacion_actual: tipo, \n        texto_rfq_completo: fullText,\n        file_title: metadata.file_title,\n        file_id: metadata.file_id,\n        es_hibrido: tipos.length > 1,\n        indice_actual: idx + 1,\n        total_tipos: tipos.length\n    }\n}));"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        2864,
        4864
      ],
      "id": "64c4b8f1-a6bd-4b70-8f17-b5aab2ae80d0",
      "name": "Expandir por Tipo RFQ"
    },
    {
      "parameters": {
        "operation": "get",
        "dataTableId": {
          "__rl": true,
          "value": "svF2jfNtm7DQCbXz",
          "mode": "list",
          "cachedResultName": "Tabla-RFQ-Ofertas",
          "cachedResultUrl": "/projects/YoqFb1alZvPQmuNs/datatables/svF2jfNtm7DQCbXz"
        },
        "filters": {
          "conditions": [
            {
              "keyName": "Evaluation",
              "keyValue": "={{ $json.tipo_evaluacion_actual }}"
            }
          ]
        },
        "returnAll": true
      },
      "type": "n8n-nodes-base.dataTable",
      "typeVersion": 1,
      "position": [
        3312,
        4864
      ],
      "id": "d838ab38-8ae5-469f-93cc-390d5938f4f8",
      "name": "Get Items por Tipo"
    },
    {
      "parameters": {
        "promptType": "define",
        "text": "=You are an RFQ requirement validator and extractor.\n\n## YOUR JOB\n\nFor each item in the list, you must:\n1. Search if that item is mentioned in the RFQ document\n2. If found â†’ Extract the CLIENT'S specific requirements\n3. If NOT found â†’ Mark as \"NO ESPECIFICADO EN RFQ\"\n\n## INPUT DATA\n\nEvaluation Type: {{ $('Expandir por Tipo RFQ').first().json.tipo_evaluacion_actual }}\n\nItems to validate and extract:\n{{ $json.lista_items_json }}\n\nRFQ Document Text:\n{{ $('Expandir por Tipo RFQ').first().json.texto_rfq_completo }}\n\n---\n\n## EXTRACTION PROCESS\n\n### STEP 1: Search for the item in RFQ\n\nLook for the item description (or similar terms) in the RFQ text.\n\n**Example:**\nItem: \"Electrical room layout with implementation and distribution of equipment\"\nSearch in RFQ for: \"electrical room\", \"layout\", \"distribution\", \"sala elÃ©ctrica\", \"disposiciÃ³n\"\n\n### STEP 2: Determine status\n\n**CASE A: Item is mentioned WITH specific requirements**\nExtract: \"[Requirement details] | Ref: [Location]\"\n\nExample:\n```\n\"Planos en formato DWG | Norma: IEC 61082 | Incluir protecciones y dimensiones | Ref: SecciÃ³n 3.2, PÃ¡g 18\"\n```\n\n**CASE B: Item is mentioned WITHOUT specific requirements**\nUse: \"SOLICITADO SIN ESPECIFICACIÃ“N - [brief context]\"\n\nExample:\n```\n\"SOLICITADO SIN ESPECIFICACIÃ“N - Aparece en lista de entregables sin detalles tÃ©cnicos | Ref: Anexo II\"\n```\n\n**CASE C: Item is NOT in RFQ**\nUse: \"NO SOLICITADO EN RFQ\"\n\n---\n\n## WHAT TO EXTRACT (When item is found)\n\n### For TECHNICAL EVALUATION:\n- Technical specifications (dimensions, capacities, materials)\n- Norms/standards required (ASME, API, IEC, ISO)\n- Level of detail expected\n- Acceptance criteria\n- Formats (DWG, PDF, Excel)\n- Exclusions mentioned\n\n### For ECONOMICAL EVALUATION:\n- Pricing format required (lump sum, unit price, hourly)\n- Currency\n- Breakdown structure\n- Commercial conditions\n\n### For DELIVERABLES:\n- Document codes\n- Formats required\n- Number of revisions\n- Delivery deadlines\n\n---\n\n## OUTPUT FORMAT\n\nReturn ONLY a JSON array:\n```json\n[\n  {\n    \"id\": 1,\n    \"rfq_requisito\": \"extracted requirement or status\",\n    \"referencia\": \"Section X, Page Y or null\"\n  }\n]\n```\n\n---\n\n## EXAMPLES\n\n### Example 1: Item found with requirements\n\n**Input item:**\n```json\n{\n  \"id\": 5,\n  \"descripcion_item\": \"CAPEX estimate\",\n  \"fase\": \"PRE-FEED\"\n}\n```\n\n**RFQ text contains:**\n\"CAPEX estimate Class 3 AACEI (-20% +30%) including equipment, materials, and EPC costs\"\n\n**Output:**\n```json\n{\n  \"id\": 5,\n  \"rfq_requisito\": \"Class 3 AACEI (-20% +30%) | Incluir equipos, materiales y costos EPC | Ref: Section 5 CAPEX estimate\",\n  \"referencia\": \"Section 5\"\n}\n```\n\n### Example 2: Item mentioned without details\n\n**Input item:**\n```json\n{\n  \"id\": 13,\n  \"descripcion_item\": \"3D Model\",\n  \"fase\": \"PRE-FEED\"\n}\n```\n\n**RFQ text contains:**\n\"Deliverables list: [...] 3D Model [...]\" (no specifications)\n\n**Output:**\n```json\n{\n  \"id\": 13,\n  \"rfq_requisito\": \"MENCIONADO SIN ESPECIFICACIÃ“N - Aparece en lista de entregables sin requisitos tÃ©cnicos | Ref: Annex II\",\n  \"referencia\": \"Annex II\"\n}\n```\n\n### Example 3: Item NOT in RFQ\n\n**Input item:**\n```json\n{\n  \"id\": 4,\n  \"descripcion_item\": \"Project Management (Piedad site)\",\n  \"fase\": \"PRE-FEED\"\n}\n```\n\n**RFQ text does NOT mention:** project management, site Piedad, or similar terms\n\n**Output:**\n```json\n{\n  \"id\": 4,\n  \"rfq_requisito\": \"NO ESPECIFICADO EN RFQ\",\n  \"referencia\": null\n}\n```\n\n---\n\n## CRITICAL RULES\n\n1. âš ï¸ VALIDATE first if item exists in RFQ\n2. If NOT found â†’ Use \"NO ESPECIFICADO EN RFQ\"\n3. If found â†’ Extract CLIENT requirements (not item description)\n4. Search using FLEXIBLE terms (synonyms, translations ES/EN)\n5. Output ONLY JSON array\n6. Process ALL items\n7. NO markdown, NO explanations\n\n---\n\n## SEARCH STRATEGY\n\nUse flexible matching:\n- \"Electrical room\" = \"Sala elÃ©ctrica\" = \"Cuarto elÃ©ctrico\"\n- \"Layout\" = \"DisposiciÃ³n\" = \"DistribuciÃ³n\"\n- \"3D Model\" = \"Modelo 3D\" = \"Modelado tridimensional\"\n- \"CAPEX\" = \"Capital cost\" = \"Costo de inversiÃ³n\"\n\nStart validation and extraction now. Return JSON array only.",
        "batching": {}
      },
      "type": "@n8n/n8n-nodes-langchain.chainLlm",
      "typeVersion": 1.7,
      "position": [
        4208,
        4816
      ],
      "id": "c23beede-0fd8-4551-835b-423ac378f0a7",
      "name": "LLM Extractor Requisitos RFQ"
    },
    {
      "parameters": {
        "jsCode": "// =============================================\n// NODO: Parsear Requisitos RFQ y Preparar Update\n// =============================================\n\nconst llmOutput = $input.first().json.text || $input.first().json.content || \"[]\";\nlet parsedData = [];\n\ntry {\n  let cleanOutput = llmOutput\n    .replace(/```json/gi, '')\n    .replace(/```/g, '')\n    .trim();\n  \n  const firstBracket = cleanOutput.indexOf('[');\n  const lastBracket = cleanOutput.lastIndexOf(']');\n  \n  if (firstBracket !== -1 && lastBracket !== -1) {\n    const jsonString = cleanOutput.substring(firstBracket, lastBracket + 1);\n    parsedData = JSON.parse(jsonString);\n  }\n} catch (e) {\n  console.log(\"âš ï¸ Error parseando JSON del LLM:\", e.message);\n}\n\nlet originalItems = [];\ntry {\n    originalItems = JSON.parse($('Preparar Items para LLM').first().json.lista_items_json);\n} catch (e) {\n    throw new Error(\"No se pudo recuperar la lista original de Ã­tems\");\n}\n\nconsole.log(`ðŸ“‹ Procesando ${originalItems.length} Ã­tems`);\nconsole.log(`ðŸ“‹ LLM devolviÃ³ ${parsedData.length} Ã­tems`);\n\nreturn originalItems.map(originalItem => {\n    const found = parsedData.find(p => p.id === originalItem.id);\n    \n    let rfqRequisito = \"NO ESPECIFICADO EN RFQ\";\n    \n    if (found && found.rfq_requisito) {\n        rfqRequisito = found.rfq_requisito;\n        \n        if (found.referencia) {\n            rfqRequisito += ` | Ref: ${found.referencia}`;\n        }\n    }\n\n    return {\n        json: {\n            id: originalItem.id,\n            rfq_requisito: rfqRequisito\n        }\n    };\n});"
      },
      "id": "a7641cc2-96af-4674-8329-acd14ca52f19",
      "name": "Parsear Requisitos RFQ",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        4576,
        4816
      ]
    },
    {
      "parameters": {
        "jsCode": "// =============================================\n// NODO: Preparar Items para ExtracciÃ³n RFQ\n// =============================================\n\nconst items = $input.all();\n\nconst listaParaLLM = items.map(i => ({\n    id: i.json.id,\n    descripcion_item: i.json.descripcion_item,\n    fase: i.json.fase,\n    tipo_evaluacion: i.json.Evaluation\n}));\n\nreturn {\n    json: {\n        lista_items_json: JSON.stringify(listaParaLLM),\n        batch_size: items.length\n    }\n};"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        3984,
        4816
      ],
      "id": "414fca97-944b-4d6b-a683-1b34e207ceae",
      "name": "Preparar Items para LLM"
    },
    {
      "parameters": {
        "batchSize": 50,
        "options": {
          "reset": "={{ $json.reiniciar_bucle ? true : false }}"
        }
      },
      "type": "n8n-nodes-base.splitInBatches",
      "typeVersion": 3,
      "position": [
        3760,
        4944
      ],
      "id": "4e8d775c-df0b-46f3-aab6-27840a0a0df0",
      "name": "Loop Over Items RFQ"
    },
    {
      "parameters": {
        "model": "nomic-embed-text:latest"
      },
      "type": "@n8n/n8n-nodes-langchain.embeddingsOllama",
      "typeVersion": 1,
      "position": [
        2288,
        5088
      ],
      "id": "b03a43d4-cfe4-4151-ba9b-da932d84e224",
      "name": "Embeddings Ollama RFQ",
      "credentials": {
        "ollamaApi": {
          "id": "oS2Qqti9oVfsm8XZ",
          "name": "Ollama account"
        }
      },
      "disabled": true
    },
    {
      "parameters": {
        "jsCode": "// =============================================\n// NODO: Format RFQ for Vectorstore\n// =============================================\n\nlet fullText = \"\";\nlet totalPages = 1;\n\ntry {\n    const validarNode = $('Validar Contenido PDF RFQ').first().json;\n    \n    if (validarNode.pages && validarNode.pages[0]) {\n        fullText = validarNode.pages[0].text || \"\";\n    } else {\n        fullText = validarNode.text || \"\";\n    }\n    \n    totalPages = validarNode.totalPages || 1;\n    \n} catch (e) {\n    console.log(\"âŒ Error leyendo contenido del PDF\");\n    fullText = $input.first().json.text || \"\";\n}\n\nlet tipoEval = [\"Technical Evaluation\"];\n\ntry {\n    const llmData = $('Clasificador Tipo RFQ').first().json;\n    const output = llmData.output || llmData;\n\n    if (output.tipos_detectados) {\n        tipoEval = Array.isArray(output.tipos_detectados) \n            ? output.tipos_detectados \n            : [output.tipos_detectados];\n    }\n} catch (e) {\n    console.log(\"âš ï¸ No se pudo leer la clasificaciÃ³n del LLM, usando defaults.\");\n}\n\nlet fileId = \"unknown\";\nlet fileTitle = \"unknown\";\ntry {\n    const fileNode = $('Set File ID2').first().json;\n    fileId = fileNode.file_id;\n    fileTitle = fileNode.file_title;\n} catch(e) {}\n\nconsole.log(`âœ… Procesando RFQ: ${fileTitle}`);\nconsole.log(`   Tipos: ${JSON.stringify(tipoEval)}`);\n\nreturn {\n    json: {\n        text: fullText,\n        metadata: {\n            file_id: fileId,\n            file_title: fileTitle,\n            tipo_documento: \"RFQ_BASE\",\n            tipo_evaluacion: tipoEval,\n            processed_at: new Date().toISOString(),\n            total_pages: totalPages\n        }\n    }\n};"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        2144,
        4864
      ],
      "id": "297c020e-ca88-4529-bb76-a18751ba97b2",
      "name": "Format RFQ for Vectorstore"
    },
    {
      "parameters": {
        "mode": "insert",
        "tableName": {
          "__rl": true,
          "value": "documents_rfq",
          "mode": "list",
          "cachedResultName": "documents_rfq"
        },
        "options": {
          "queryName": "match_documents_rfq"
        }
      },
      "id": "0ad629f1-dbe7-4f1d-a80b-32c65382567e",
      "name": "Insert RFQ Vectorstore",
      "type": "@n8n/n8n-nodes-langchain.vectorStoreSupabase",
      "typeVersion": 1,
      "position": [
        2400,
        4864
      ],
      "disabled": true
    },
    {
      "parameters": {
        "chunkSize": 1500,
        "chunkOverlap": 200,
        "options": {}
      },
      "type": "@n8n/n8n-nodes-langchain.textSplitterRecursiveCharacterTextSplitter",
      "typeVersion": 1,
      "position": [
        2576,
        5296
      ],
      "id": "f846e0a5-dec6-412f-af31-538b1b5d23ea",
      "name": "Text Splitter RFQ",
      "disabled": true
    },
    {
      "parameters": {
        "jsonMode": "expressionData",
        "jsonData": "={{ $json.text }}",
        "options": {
          "metadata": {
            "metadataValues": [
              {
                "name": "file_id",
                "value": "={{ $json.metadata.file_id }}"
              },
              {
                "name": "file_title",
                "value": "={{ $json.metadata.file_title }}"
              },
              {
                "name": "tipo_documento",
                "value": "RFQ_BASE"
              },
              {
                "name": "tipo_evaluacion",
                "value": "={{ $json.metadata.tipo_evaluacion }}"
              }
            ]
          }
        }
      },
      "id": "85b7d52c-ba60-4c49-b5c6-cdecd595ae83",
      "name": "Default Data Loader RFQ",
      "type": "@n8n/n8n-nodes-langchain.documentDefaultDataLoader",
      "typeVersion": 1,
      "position": [
        2496,
        5088
      ],
      "disabled": true
    },
    {
      "parameters": {
        "jsCode": "// =============================================\n// NODO: Generate Stable ID para RFQ\n// =============================================\n\nfunction simpleHash(str) {\n  let hash = 0;\n  for (let i = 0; i < str.length; i++) {\n    const char = str.charCodeAt(i);\n    hash = ((hash << 5) - hash) + char;\n    hash = hash & hash;\n  }\n  return 'rfq_' + Math.abs(hash).toString(16).padStart(16, '0').substring(0, 16);\n}\n\nconst body = $json.body;\n\nconst originalFileId = body.file_id || \"unknown\";\nconst fileTitle = body.file_title || \"unknown.pdf\";\nconst fileBinary = body.file_binary || \"\";\n\nconst normalizedTitle = fileTitle.toLowerCase().trim();\nconst stableId = simpleHash(normalizedTitle);\n\nconsole.log(\"=== GENERACIÃ“N DE ID ESTABLE RFQ ===\");\nconsole.log(`Nombre archivo: ${fileTitle}`);\nconsole.log(`ID ESTABLE generado: ${stableId}`);\n\nreturn {\n  json: {\n    body: {\n      ...body,\n      file_id: stableId,\n      file_id_original: originalFileId\n    }\n  }\n};"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        224,
        4864
      ],
      "id": "023a0aee-94c0-4056-a3c6-b052bce52c17",
      "name": "Generate Stable ID RFQ"
    },
    {
      "parameters": {
        "jsCode": "// =============================================\n// NODO: Convertir Base64 a Binary Data\n// =============================================\n\nlet inputData;\ntry {\n    inputData = $('Set File ID2').first().json;\n} catch (e) {\n    throw new Error(\"âŒ No se puede acceder al nodo 'Set File ID1'\");\n}\n\nconst base64Data = inputData.file_binary;\n\nif (!base64Data || base64Data === \"\") {\n    throw new Error(\"âŒ CRÃTICO: 'file_binary' no existe en 'Set File ID1'.\");\n}\n\nif (typeof base64Data !== 'string') {\n    throw new Error(`âŒ ERROR: 'file_binary' debe ser string, es ${typeof base64Data}`);\n}\n\nconsole.log(\"âœ… file_binary recibido\");\nconsole.log(`   â”œâ”€ Longitud: ${base64Data.length} caracteres`);\nconsole.log(`   â”œâ”€ Archivo: ${inputData.file_title}`);\n\nlet binaryData;\ntry {\n    binaryData = Buffer.from(base64Data, 'base64');\n} catch (e) {\n    throw new Error(`âŒ ERROR decodificando base64: ${e.message}`);\n}\n\nif (binaryData.length === 0) {\n    throw new Error(\"âŒ ERROR: Archivo decodificado vacÃ­o (0 bytes)\");\n}\n\nconsole.log(`âœ… Binary generado: ${binaryData.length} bytes`);\n\nreturn {\n    json: {\n        file_id: inputData.file_id,\n        file_title: inputData.file_title,\n        file_url: inputData.file_url || \"unknown\"\n    },\n    binary: {\n        data: {\n            data: binaryData.toString('base64'),\n            mimeType: 'application/pdf',\n            fileName: inputData.file_title || 'document.pdf',\n            fileSize: binaryData.length\n        }\n    }\n};"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        1120,
        4864
      ],
      "id": "75aa9951-acac-4967-a230-24aa144b6cb7",
      "name": "Base64 a Binary RFQ"
    },
    {
      "parameters": {
        "jsCode": "// =============================================\n// NODO: Format RFQ - ExtracciÃ³n Segura de ImÃ¡genes\n// =============================================\n\n// 1. OBTENER EL CONTENIDO\n// Accedemos de forma segura a la variable que indicaste\nconst inputData = $input.first().json;\nlet content = \"\";\n\nif (inputData.document && inputData.document.md_content) {\n    content = inputData.document.md_content;\n} else {\n    // Fallback por seguridad si no existe la ruta\n    content = inputData.text || \"\";\n}\n\n// 2. FUNCIÃ“N DE LIMPIEZA QUIRÃšRGICA\nfunction extractImagesSafely(text) {\n    if (!text) return { cleanText: \"\", images: [] };\n\n    const imagesFound = [];\n    \n    // EXPLICACIÃ“N DEL REGEX:\n    // !\\[(.*?)\\]   -> Captura el texto alternativo (ej: \"Figura 1\") en el grupo 1. Es \"lazy\" (.*?) para no comerse texto de mÃ¡s.\n    // \\(           -> ParÃ©ntesis de apertura literal.\n    // (data:image\\/[^;]+;base64,[^)]+) -> Captura la data Base64 en el grupo 2.\n    //    [^)]+     -> Significa \"todo lo que no sea un parÃ©ntesis de cierre\". Esto evita que se rompa si hay parÃ©ntesis dentro del base64 (raro pero posible) y asegura que pare al final de la URL.\n    // \\)           -> ParÃ©ntesis de cierre literal.\n    // g            -> Global (buscar todas).\n    \n    const regex = /!\\[(.*?)\\]\\((data:image\\/[^;]+;base64,[^)]+)\\)/g;\n\n    const cleanText = text.replace(regex, (match, altText, base64Data) => {\n        // 1. Guardamos la imagen en el array aparte\n        imagesFound.push({\n            alt: altText || \"Sin descripciÃ³n\",\n            data: base64Data\n        });\n\n        // 2. RETORNAMOS EL PLACEHOLDER (CRÃTICO PARA NO DESCOLOCAR)\n        // Mantenemos el 'altText' para que el LLM sepa quÃ© habÃ­a ahÃ­.\n        // Si la imagen estaba dentro de una tabla |...|, esto mantiene la celda ocupada y no rompe la tabla.\n        return ``; \n    });\n\n    return { cleanText, images: imagesFound };\n}\n\n// 3. EJECUTAR\nconst { cleanText, images } = extractImagesSafely(content);\n\n// 4. RECUPERAR METADATOS (Mantenemos tu lÃ³gica existente)\nlet fileMeta = { id: \"unknown\", title: \"unknown\" };\ntry {\n    const f = $('Set File ID2').first().json;\n    fileMeta = { id: f.file_id, title: f.file_title };\n} catch(e) {}\n\nlet tipoEval = [\"Technical Evaluation\"];\ntry {\n    const t = $('Clasificador Tipo RFQ').first().json;\n    const out = t.output || t;\n    if (out.tipos_detectados) tipoEval = Array.isArray(out.tipos_detectados) ? out.tipos_detectados : [out.tipos_detectados];\n} catch(e) {}\n\n// 5. OUTPUT\nreturn {\n    json: {\n        text: cleanText,             // El texto mantiene su estructura original\n        images_extracted: images,    // Array de objetos { alt, data }\n        metadata: {\n            file_id: fileMeta.id,\n            file_title: fileMeta.title,\n            tipo_documento: \"RFQ_BASE\",\n            tipo_evaluacion: tipoEval,\n            processed_at: new Date().toISOString(),\n            original_length: content.length,\n            clean_length: cleanText.length,\n            images_count: images.length\n        }\n    }\n};"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        1568,
        4864
      ],
      "id": "1f1ac41c-d1b5-49f2-a5c3-af43dcbfc7f6",
      "name": "Validar Contenido PDF RFQ"
    },
    {
      "parameters": {
        "httpMethod": "POST",
        "path": "ingesta-rfq",
        "responseMode": "responseNode",
        "options": {}
      },
      "type": "n8n-nodes-base.webhook",
      "typeVersion": 2.1,
      "position": [
        496,
        2256
      ],
      "id": "942b6a22-766f-4749-8c32-5dfddaab6b02",
      "name": "Webhook RFQ",
      "webhookId": "bb2ad58d-9bf2-42b0-a26f-5a465c3b0999"
    },
    {
      "parameters": {},
      "id": "8875d1ec-daef-4883-bc45-dbdffb09e709",
      "name": "Postgres Chat Memory",
      "type": "@n8n/n8n-nodes-langchain.memoryPostgresChat",
      "typeVersion": 1,
      "position": [
        -1168,
        352
      ],
      "notesInFlow": false,
      "disabled": true
    },
    {
      "parameters": {
        "public": true,
        "mode": "webhook",
        "options": {}
      },
      "id": "b831bba7-3a22-4083-a412-c0349c94ea8e",
      "name": "When chat message received",
      "type": "@n8n/n8n-nodes-langchain.chatTrigger",
      "typeVersion": 1.1,
      "position": [
        -1520,
        32
      ],
      "webhookId": "072a6322-4bb1-444b-bd82-5c1df6db623f"
    },
    {
      "parameters": {
        "options": {
          "systemMessage": "=Eres un asistente experto en anÃ¡lisis de ofertas tÃ©cnicas y econÃ³micas de proyectos de ingenierÃ­a.\n\n## TU ÃšNICA HERRAMIENTA\n\nTienes acceso a UNA SOLA herramienta: **consultar_tabla_evaluacion1**\n\nEsta herramienta contiene una tabla con:\n- **Filas**: Items/requisitos del proyecto (ej: \"IngenierÃ­a bÃ¡sica\", \"Modelo 3D\", \"AnÃ¡lisis sÃ­smico\")\n- **Columnas de proveedores**: IDOM, SACYR, TECNICASREUNIDAS, EA, SENER, TRESCA, WORLEY, OTROS\n- **Columnas adicionales**: evaluation (tipo de evaluaciÃ³n), fase, requisito_rfq\n\n## PROTOCOLO DE TRABAJO\n\n### PASO 1: Ejecutar la herramienta\n- **SIEMPRE** llama a `consultar_tabla_evaluacion1` PRIMERO\n- NO narres lo que vas a hacer (\"voy a consultar...\", \"primero busco...\")\n- Ejecuta directamente\n\n### PASO 2: Interpretar resultados\n\nLas celdas de proveedores pueden contener:\n\n**Para evaluaciones tÃ©cnicas:**\n- `\"INCLUIDO - [descripciÃ³n] | Ref: [ubicaciÃ³n]\"` â†’ El proveedor SÃ ofrece este servicio\n- `\"NO INCLUIDO - [razÃ³n] | Ref: [ubicaciÃ³n]\"` â†’ El proveedor NO lo ofrece\n- `\"PARCIAL - [quÃ© incluye y quÃ© no] | Ref: [ubicaciÃ³n]\"` â†’ Cumplimiento parcial\n- `\"SIN INFORMACIÃ“N\"` â†’ No hay datos en la oferta del proveedor\n- `\"ERROR_LLM: Ãtem no procesado\"` â†’ Fallo tÃ©cnico (menciona que hay un error)\n\n**Para evaluaciones econÃ³micas:**\n- `\"45.000 EUR - [contexto] | Ref: [ubicaciÃ³n]\"` â†’ Precio cotizado\n- `\"SIN VALORAR - [explicaciÃ³n] | Ref: [ubicaciÃ³n]\"` â†’ Mencionado pero sin precio\n- `\"NO COTIZADO\"` â†’ No incluido en la oferta econÃ³mica\n\n### PASO 3: Responder\n\n**ESTRUCTURA DE RESPUESTA:**\n\n1. **Respuesta directa** a la pregunta\n2. **Evidencia** (extraÃ­da del campo, citando la referencia si existe)\n3. **Comparaciones** (si es relevante)\n\n**EJEMPLOS DE RESPUESTAS CORRECTAS:**\n\n---\n\n**Pregunta:** \"Â¿QuÃ© ofrece IDOM para modelado 3D?\"\n\n**Respuesta:**\n```\nIDOM ofrece modelado 3D en formato IFC, incluyendo equipos principales y estructuras. \n\nðŸ“„ Fuente: Oferta IDOM, SecciÃ³n 4.2, PÃ¡g 45\n```\n\n---\n\n**Pregunta:** \"Â¿CuÃ¡nto cobra SACYR por ingenierÃ­a bÃ¡sica?\"\n\n**Respuesta:**\n```\nSACYR cotiza 85.000 EUR en modalidad lump sum para la ingenierÃ­a bÃ¡sica.\n\nðŸ“„ Fuente: Tabla 5.2 de oferta SACYR\n```\n\n---\n\n**Pregunta:** \"Â¿Incluye TRESCA el anÃ¡lisis sÃ­smico?\"\n\n**Respuesta:**\n```\nNo. TRESCA excluye explÃ­citamente el anÃ¡lisis sÃ­smico del alcance contractual.\n\nðŸ“„ Fuente: Oferta TRESCA, ClÃ¡usula 3.4, PÃ¡g 23\n```\n\n---\n\n**Pregunta:** \"Compara los precios de ingenierÃ­a bÃ¡sica entre todos los proveedores\"\n\n**Respuesta:**\n```\nPrecios de ingenierÃ­a bÃ¡sica:\n\n- IDOM: 120.000 EUR\n- SACYR: 85.000 EUR (mÃ¡s econÃ³mico)\n- TECNICASREUNIDAS: 145.000 EUR\n- SENER: SIN VALORAR (mencionado sin precio)\n- EA: NO COTIZADO\n\nEl proveedor mÃ¡s econÃ³mico es SACYR con 85.000 EUR.\n\nðŸ“„ Fuente: Tabla comparativa de ofertas\n```\n\n---\n\n**Pregunta:** \"Â¿Hay informaciÃ³n sobre anÃ¡lisis de vibraciones?\"\n\n**Respuesta:**\n```\nNo se encontrÃ³ informaciÃ³n especÃ­fica sobre \"anÃ¡lisis de vibraciones\" en ninguna de las ofertas consultadas. \n\nPosibles razones:\n- No estÃ¡ incluido en el alcance de ningÃºn proveedor\n- PodrÃ­a estar bajo otro nombre (ej: \"anÃ¡lisis dinÃ¡mico\", \"estudios mecÃ¡nicos\")\n\nÂ¿Quieres que busque con tÃ©rminos relacionados?\n```\n\n---\n\n## CASOS ESPECIALES\n\n### Si la herramienta devuelve array vacÃ­o:\n```\nNo encontrÃ© informaciÃ³n sobre [tema] en la tabla de evaluaciones. \n\nEsto puede significar que:\n- El Ã­tem no estÃ¡ en el alcance del RFQ\n- EstÃ¡ categorizado con otro nombre\n\nÂ¿Puedes reformular tu pregunta o darme mÃ¡s contexto?\n```\n\n### Si una columna tiene \"SIN INFORMACIÃ“N\":\n```\nNo hay datos especÃ­ficos sobre [tema] en la oferta de [proveedor]. \n\nEsto indica que el proveedor no mencionÃ³ este punto en su propuesta.\n```\n\n### Si hay \"ERROR_LLM\":\n```\nâš ï¸ DetectÃ© un error tÃ©cnico en el procesamiento de este Ã­tem. Los datos podrÃ­an estar incompletos. Te recomiendo verificar manualmente la oferta del proveedor.\n```\n\n---\n\n## REGLAS ESTRICTAS\n\nâŒ **NO HAGAS:**\n- Narrar tu proceso (\"primero consulto...\", \"ahora analizo...\")\n- Inventar informaciÃ³n que no estÃ¡ en la herramienta\n- Asumir datos de proveedores con \"SIN INFORMACIÃ“N\"\n- Dar precios aproximados si dice \"SIN VALORAR\"\n\nâœ… **SÃ HAZ:**\n- Ejecutar la herramienta inmediatamente\n- Citar las referencias cuando existan\n- Ser directo y conciso\n- Admitir cuando no hay informaciÃ³n\n- Comparar cuando sea Ãºtil para el usuario\n\n---\n\n## FORMATO DE RESPUESTA\n\nSiempre usa este formato:\n\n1. **Respuesta directa** (1-2 lÃ­neas)\n2. **Detalles/Evidencia** (extracto del campo con referencia)\n3. **Insight adicional** (opcional: comparaciÃ³n, recomendaciÃ³n)\n\nResponde SIEMPRE en espaÃ±ol."
        }
      },
      "id": "f06a54d2-a369-4237-b412-0634ec3feb57",
      "name": "RAG AI Agent",
      "type": "@n8n/n8n-nodes-langchain.agent",
      "typeVersion": 1.6,
      "position": [
        -992,
        128
      ]
    },
    {
      "parameters": {
        "descriptionType": "manual",
        "toolDescription": "Use this tool to fetch all available documents, including the table schema if the file is a CSV or Excel file.",
        "operation": "select",
        "schema": {
          "__rl": true,
          "mode": "list",
          "value": "public"
        },
        "table": {
          "__rl": true,
          "value": "document_metadata",
          "mode": "list",
          "cachedResultName": "document_metadata"
        },
        "returnAll": true,
        "options": {}
      },
      "type": "n8n-nodes-base.postgresTool",
      "typeVersion": 2.5,
      "position": [
        -1040,
        352
      ],
      "id": "1e13a514-70fb-4ccf-bade-f9adc97850c8",
      "name": "List Documents",
      "disabled": true
    },
    {
      "parameters": {
        "descriptionType": "manual",
        "toolDescription": "Given a file ID, fetches the text from the document.",
        "operation": "executeQuery",
        "query": "SELECT \n    string_agg(content, ' ') as document_text\nFROM documents\n  WHERE metadata->>'file_id' = $1\nGROUP BY metadata->>'file_id';",
        "options": {
          "queryReplacement": "={{ $fromAI('file_id') }}"
        }
      },
      "type": "n8n-nodes-base.postgresTool",
      "typeVersion": 2.5,
      "position": [
        -912,
        352
      ],
      "id": "c255dacd-914d-4121-bc52-25728861f226",
      "name": "Get File Contents",
      "disabled": true
    },
    {
      "parameters": {
        "descriptionType": "manual",
        "toolDescription": "Run a SQL query - use this to query from the document_rows table once you know the file ID you are querying. dataset_id is the file_id and you are always using the row_data for filtering, which is a jsonb field that has all the keys from the file schema given in the document_metadata table.\n\nExample query:\n\nSELECT AVG((row_data->>'revenue')::numeric)\nFROM document_rows\nWHERE dataset_id = '123';\n\nExample query 2:\n\nSELECT \n    row_data->>'category' as category,\n    SUM((row_data->>'sales')::numeric) as total_sales\nFROM dataset_rows\nWHERE dataset_id = '123'\nGROUP BY row_data->>'category';",
        "operation": "executeQuery",
        "query": "{{ $fromAI('sql_query') }}",
        "options": {}
      },
      "type": "n8n-nodes-base.postgresTool",
      "typeVersion": 2.5,
      "position": [
        -784,
        352
      ],
      "id": "3da2f904-868a-4e23-b6f9-f2edf339724a",
      "name": "Query Document Rows",
      "disabled": true
    },
    {
      "parameters": {
        "mode": "retrieve-as-tool",
        "toolName": "documents",
        "toolDescription": "Use RAG to look up information in the knowledgebase.",
        "tableName": {
          "__rl": true,
          "value": "documents_rfq",
          "mode": "list",
          "cachedResultName": "documents_rfq"
        },
        "topK": 10,
        "options": {
          "queryName": "match_documents_rfq"
        }
      },
      "type": "@n8n/n8n-nodes-langchain.vectorStoreSupabase",
      "typeVersion": 1,
      "position": [
        -656,
        352
      ],
      "id": "7ad4d0da-746d-43a6-ac0d-e728da8b5cee",
      "name": "consultar_ofertas",
      "disabled": true
    },
    {
      "parameters": {
        "content": "## Chat con RFQs",
        "height": 800,
        "width": 1440,
        "color": 3
      },
      "type": "n8n-nodes-base.stickyNote",
      "typeVersion": 1,
      "position": [
        -1600,
        -64
      ],
      "id": "bec69966-7a0b-4fc9-af9d-8cb6fb1bb547",
      "name": "Sticky Note2"
    },
    {
      "parameters": {
        "respondWith": "allIncomingItems",
        "options": {}
      },
      "type": "n8n-nodes-base.respondToWebhook",
      "typeVersion": 1.5,
      "position": [
        -368,
        128
      ],
      "id": "54d854d5-b5a4-4bea-9b08-2ba376beda47",
      "name": "Respond to Webhook1"
    },
    {
      "parameters": {
        "httpMethod": "POST",
        "path": "chat-ofertas",
        "options": {}
      },
      "type": "n8n-nodes-base.webhook",
      "typeVersion": 2.1,
      "position": [
        -1520,
        224
      ],
      "id": "53c0a71b-1576-42cd-88ad-b0a5a8b76a29",
      "name": "Webhook1",
      "webhookId": "014a6be2-a8d5-4dd3-85f2-ea5e7d0ba092"
    },
    {
      "parameters": {
        "model": "nomic-embed-text:latest"
      },
      "type": "@n8n/n8n-nodes-langchain.embeddingsOllama",
      "typeVersion": 1,
      "position": [
        -576,
        560
      ],
      "id": "cf42ad20-7dd4-4250-a0a4-b811e31056f9",
      "name": "Embeddings Ollama2",
      "credentials": {
        "ollamaApi": {
          "id": "oS2Qqti9oVfsm8XZ",
          "name": "Ollama account"
        }
      },
      "disabled": true
    },
    {
      "parameters": {
        "model": "qwen3:14b",
        "options": {}
      },
      "type": "@n8n/n8n-nodes-langchain.lmOllama",
      "typeVersion": 1,
      "position": [
        3280,
        1312
      ],
      "id": "adbc9445-8d84-49af-8522-20d7bc3e9998",
      "name": "Ollama Model",
      "credentials": {
        "ollamaApi": {
          "id": "oS2Qqti9oVfsm8XZ",
          "name": "Ollama account"
        }
      }
    },
    {
      "parameters": {
        "model": "deepseek-r1:14b",
        "options": {}
      },
      "type": "@n8n/n8n-nodes-langchain.lmOllama",
      "typeVersion": 1,
      "position": [
        2512,
        352
      ],
      "id": "3b1efb74-f00f-4b9a-95f4-02c330e3a74e",
      "name": "Ollama Model1",
      "credentials": {
        "ollamaApi": {
          "id": "oS2Qqti9oVfsm8XZ",
          "name": "Ollama account"
        }
      }
    },
    {
      "parameters": {
        "model": "deepseek-r1:14b",
        "options": {
          "temperature": 0.1
        }
      },
      "type": "@n8n/n8n-nodes-langchain.lmOllama",
      "typeVersion": 1,
      "position": [
        4160,
        4976
      ],
      "id": "6413c1e0-0ffd-435b-9093-ca1751479d22",
      "name": "Ollama Model2",
      "credentials": {
        "ollamaApi": {
          "id": "oS2Qqti9oVfsm8XZ",
          "name": "Ollama account"
        }
      }
    },
    {
      "parameters": {
        "model": "qwen3:14b",
        "options": {
          "temperature": 0.1
        }
      },
      "type": "@n8n/n8n-nodes-langchain.lmOllama",
      "typeVersion": 1,
      "position": [
        1744,
        5088
      ],
      "id": "24295049-8f64-44f4-a0e3-384debde5be2",
      "name": "Ollama Model3",
      "credentials": {
        "ollamaApi": {
          "id": "oS2Qqti9oVfsm8XZ",
          "name": "Ollama account"
        }
      }
    },
    {
      "parameters": {
        "model": "mistral:7b",
        "options": {
          "temperature": 0.1
        }
      },
      "type": "@n8n/n8n-nodes-langchain.lmChatOllama",
      "typeVersion": 1,
      "position": [
        -1328,
        352
      ],
      "id": "ecd4fdd9-e111-4bf8-b411-05a2c82c09ec",
      "name": "Ollama Chat Model",
      "credentials": {
        "ollamaApi": {
          "id": "oS2Qqti9oVfsm8XZ",
          "name": "Ollama account"
        }
      }
    },
    {
      "parameters": {
        "operation": "get",
        "dataTableId": {
          "__rl": true,
          "value": "hwY1VFb924Ptf1P6",
          "mode": "list",
          "cachedResultName": "Tabla-RFQ-v1",
          "cachedResultUrl": "/projects/YoqFb1alZvPQmuNs/datatables/hwY1VFb924Ptf1P6"
        },
        "returnAll": ""
      },
      "type": "n8n-nodes-base.dataTableTool",
      "typeVersion": 1,
      "position": [
        -368,
        352
      ],
      "id": "a9dba94c-d006-4b50-a72b-3284dd5747e1",
      "name": "consultar_tabla_evaluacion1"
    },
    {
      "parameters": {
        "method": "POST",
        "url": "https://unlaconic-ardelle-pretenceful.ngrok-free.dev/v1/convert/file",
        "sendBody": true,
        "contentType": "multipart-form-data",
        "bodyParameters": {
          "parameters": [
            {
              "parameterType": "formBinaryData",
              "name": "files",
              "inputDataFieldName": "data"
            }
          ]
        },
        "options": {
          "timeout": 300000
        }
      },
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.3,
      "position": [
        1584,
        3728
      ],
      "id": "ed91e836-67a2-4a42-aaf4-e988bc6929f6",
      "name": "Docling OCR1",
      "retryOnFail": true
    },
    {
      "parameters": {
        "jsCode": "// =============================================\n// NODO: Preparar Texto Limpio\n// =============================================\n\nconst inputData = $input.first().json;\nlet content = \"\";\n\n// Extraer contenido de Docling\nif (inputData.document && inputData.document.md_content) {\n    content = inputData.document.md_content;\n} else if (inputData.text) {\n    content = inputData.text;\n} else {\n    // Fallback: intentar extraer de cualquier campo\n    content = JSON.stringify(inputData).substring(0, 50000);\n}\n\n// Limpiar imÃ¡genes base64 (muy pesadas para el LLM)\nconst cleanContent = content.replace(/!\\[.*?\\]\\(data:image\\/[^)]+\\)/g, '[IMAGEN_REMOVIDA]');\n\n// Recuperar metadatos del proyecto\nlet projectId = \"unknown\";\nlet documentId = \"unknown\";\nlet fileTitle = \"unknown\";\ntry {\n    const projectNode = $('Generate IDs1').first().json;\n    projectId = projectNode.rfq_project_id;\n    documentId = projectNode.rfq_document_id;  // âœ… NUEVO: Recuperar Doc ID\n    fileTitle = projectNode.file_title;\n} catch(e) {\n    console.log(\"âš ï¸ No se pudieron recuperar metadatos del proyecto\");\n}\n\nconsole.log(`ðŸ“„ Texto extraÃ­do: ${cleanContent.length} caracteres`);\nconsole.log(`ðŸ“‹ Proyecto: ${projectId}, Doc: ${documentId}`);\n\nreturn {\n    json: {\n        text: cleanContent,\n        rfq_project_id: projectId,\n        rfq_document_id: documentId, // âœ… PASAR ID\n        file_title: fileTitle\n    }\n};"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        1440,
        2256
      ],
      "id": "8a9c0a38-ebdf-4f7c-97b1-823355d4459e",
      "name": "Preparar Texto1"
    },
    {
      "parameters": {
        "promptType": "define",
        "text": "=### DOCUMENTO RFQ\n\nArchivo: {{ $json.file_title }}\n\nContenido (primeros 20000 caracteres):\n{{ $json.text.substring(0, 20000) }}",
        "hasOutputParser": true,
        "messages": {
          "messageValues": [
            {
              "message": "=## TAREA: CLASIFICAR TIPOS DE EVALUACIÃ“N EN DOCUMENTO RFQ Y NOMBRE DEL PROYECTO\n\nEres un auditor experto en documentaciÃ³n de ingenierÃ­a EPC.  \nAnaliza el documento RFQ y determina quÃ© tipos de evaluaciÃ³n contiene y el nombre del proyecto.\n\n### IMPORTANTE\n\nUn documento puede contener 1, 2, 3 o 4 tipos de evaluaciÃ³n.  \n**No asumas que estÃ¡n todos.**  \nDetecta **SOLO** los que realmente estÃ¡n presentes.\n\n### TIPOS POSIBLES\n\n1. **Technical Evaluation**\n\n   **Evidencia requerida:**\n   - Secciones de **Scope of Work**, **Scope of Facilities**\n   - Requisitos tÃ©cnicos generales (metodologÃ­a, normativas)\n   - DescripciÃ³n de alcance por fases (**PRE-FEED**, **FEED**, **EPC**)\n   - Especificaciones de ingenierÃ­a\n\n2. **Economical Evaluation**\n\n   **Evidencia requerida:**\n   - Tablas de **precios** o **tarifas**\n   - **Hours per discipline**, **EUR/hora**\n   - Formato de **cotizaciÃ³n econÃ³mica**\n   - **Desglose de costos por fase**\n   - Secciones **Commercial**, **Pricing**, **Budget**\n\n3. **Pre-FEED Deliverables**\n\n   **Evidencia requerida:**\n   - Lista o tabla de documentos a entregar en fase **PRE-FEED**\n   - Organizada por **disciplinas** (Process, Mechanical, Electricalâ€¦)\n   - Documentos conceptuales: **Basis of Design**, **PFDs**, **P&IDs preliminares**\n   - Estudios: **HAZID**, **Risk Analysis**\n   - **CAPEX Class 3â€“4 (AACEI)**\n\n4. **FEED Deliverables**\n\n   **Evidencia requerida:**\n   - Lista o tabla de documentos a entregar en fase **FEED**\n   - Documentos mÃ¡s detallados que en Pre-FEED\n   - **Especificaciones de compra**, **datasheets**\n   - **MTO** (Material Take-Off)\n   - **CAPEX Class 2â€“3 (AACEI)**\n   - **HAZOP**, **SIL studies**\n\n### CÃ“MO DIFERENCIAR\n\n| Si ves... | Es probablemente... |\n| --- | --- |\n| **Scope of Work** general, **metodologÃ­a** | **Technical Evaluation** |\n| Tablas de precios, horas, **EUR/h** | **Economical Evaluation** |\n| Lista de docs por disciplina + \"Pre-FEED\" o \"Conceptual\" | **Pre-FEED Deliverables** |\n| Lista de docs por disciplina + \"FEED\" o \"Basic Engineering\" | **FEED Deliverables** |\n\n### CASOS TÃPICOS\n\n- **RFQ completo**: contiene los **4 tipos**.\n- **Solo tÃ©cnico-econÃ³mico**: **Technical Evaluation** + **Economical Evaluation**.\n- **Solo Pre-FEED**: **Pre-FEED Deliverables**.\n- **Solo FEED**: **FEED Deliverables**.\n- **TÃ©cnico + entregables**: **Technical Evaluation** + **Pre-FEED** o **FEED Deliverables**.\n\n### TAREA OBLIGATORIA: IDENTIFICAR NOMBRE DEL PROYECTO\n\nEsta tarea es **obligatoria** y **NO** puede omitirse.  \n**DeberÃ¡s devolver SIEMPRE** un valor para `nombre_proyecto`.\n\n### ORDEN DE PRIORIDAD (estricto)\n\n1. **Nombre explÃ­cito del proyecto**  \n   - Busca en la **portada** o el **tÃ­tulo principal**.  \n   - Encabezados repetidos que contengan el nombre del proyecto.  \n   - Frases como **Project**, **Project Name**, **Project Title**, **RFQ for...**  \n\n2. **Nombre implÃ­cito pero oficial**  \n   Si no encuentras un tÃ­tulo literal, genera el nombre combinando los siguientes elementos:\n   - Tipo de instalaciÃ³n (**Hydrogen Plant**, **PV Plant**, **Power Plant**, etc.)\n   - UbicaciÃ³n (ciudad, regiÃ³n o paÃ­s)\n   - Cliente o **site** si estÃ¡ claramente indicado  \n   - Ejemplo: **Hydrogen Production Plant â€“ La Zaida, Spain**\n\n3. **Fallback obligatorio**  \n   Si el documento no declara claramente un nombre:\n   - **NO dejes el campo vacÃ­o**.\n   - **NO uses valores genÃ©ricos**.\n   - Genera un nombre tÃ©cnico-descriptivo utilizando:\n     - **Formato obligatorio**: `<Tipo de Proyecto> â€“ <UbicaciÃ³n o Cliente> (RFQ)`\n   - Ejemplo: **Solar PV Plant â€“ Southern Spain (RFQ)**\n\n### REGLAS DURAS\n\n- **No usar**: Unknown, N/A, Not specified\n- **No inventar nombres comerciales**\n- El nombre debe ser vÃ¡lido para un entorno EPC / PMO\n- Prioriza claridad, trazabilidad y profesionalidad\n\n### FORMATO DE SALIDA (JSON PLANO â€“ ESTRICTO)\n\n**ATENCIÃ“N: REGLAS DE ESTRUCTURA**  \n1. Devuelve **ÃšNICAMENTE** un objeto JSON que empiece por `{` y termine por `}`.  \n2. **PROHIBIDO** devolver el JSON dentro de una lista o array `[]`.  \n3. **PROHIBIDO** usar claves contenedoras como `\"output\"`, `\"response\"` o `\"json\"`. El nivel raÃ­z debe tener directamente las claves `tipos_detectados` y `nombre_proyecto`.  \n4. No incluyas bloques de cÃ³digo markdown (\\`\\`\\`json). Solo el texto plano del JSON.\n\n**FORMATO DE SALIDA CORRECTO:**\n```json\n{\n  \"tipos_detectados\": [\"Technical Evaluation\", \"Pre-FEED Deliverables\"],\n  \"nombre_proyecto\": \"Hydrogen Production Plant â€“ La Zaida, Spain\",\n  \"razonamiento\": \"El documento incluye un Scope of Work tÃ©cnico y una lista de documentos para la fase Pre-FEED...\"\n}\n"
            }
          ]
        },
        "batching": {}
      },
      "type": "@n8n/n8n-nodes-langchain.chainLlm",
      "typeVersion": 1.8,
      "position": [
        1728,
        2256
      ],
      "id": "156c2406-7c99-42b2-9f22-921d35644511",
      "name": "Clasificador de Tipos1"
    },
    {
      "parameters": {
        "model": "mistral:7b",
        "options": {
          "temperature": 0.1
        }
      },
      "type": "@n8n/n8n-nodes-langchain.lmOllama",
      "typeVersion": 1,
      "position": [
        1664,
        2464
      ],
      "id": "f393df38-eb40-472b-a232-10eb57bbad49",
      "name": "Ollama Clasificador1",
      "credentials": {
        "ollamaApi": {
          "id": "oS2Qqti9oVfsm8XZ",
          "name": "Ollama account"
        }
      }
    },
    {
      "parameters": {
        "schemaType": "manual",
        "inputSchema": "{\n  \"type\": \"object\",\n  \"properties\": {\n    \"tipos_detectados\": {\n      \"type\": \"array\",\n      \"items\": {\n        \"type\": \"string\",\n        \"enum\": [\"Technical Evaluation\", \"Economical Evaluation\", \"Pre-FEED Deliverables\", \"FEED Deliverables\"]\n      }\n    },\n    \"razonamiento\": {\n      \"type\": \"string\"\n    }\n  },\n  \"required\": [\"tipos_detectados\"]\n}"
      },
      "type": "@n8n/n8n-nodes-langchain.outputParserStructured",
      "typeVersion": 1.3,
      "position": [
        1904,
        2464
      ],
      "id": "85905efe-1121-47ff-966a-aed20750fbe9",
      "name": "Output Parser1"
    },
    {
      "parameters": {
        "jsCode": "const llmOutput = $input.first().json;\n// A veces el output viene directo o dentro de 'output'\nconst output = llmOutput.output || llmOutput;\n\nlet tipos = output.tipos_detectados || [];\n\n// âœ… CAPTURAR NOMBRE PROYECTO\nconst realProjectName = output.nombre_proyecto || \"Proyecto Desconocido\";\n\nif (tipos.length === 0) {\n    tipos = [\"Technical Evaluation\"];\n}\n\n// Recuperar datos tÃ©cnicos\nlet projectId = \"unknown\";\nlet documentId = \"unknown\";\nlet fileTitle = \"unknown\";\nlet fullText = \"\";\n\ntry {\n    const textNode = $('Preparar Texto1').first().json;\n    projectId = textNode.rfq_project_id;\n    documentId = textNode.rfq_document_id;\n    fileTitle = textNode.file_title;\n    fullText = textNode.text;\n} catch(e) {}\n\n// Generar output\nreturn tipos.map((tipo, idx) => ({\n    json: {\n        tipo_evaluacion: tipo,\n        rfq_project_id: projectId,\n        rfq_document_id: documentId,\n        nombre_proyecto: realProjectName, // âœ… PASARLO\n        file_title: fileTitle,\n        texto_rfq: fullText,\n        indice: idx + 1,\n        total_tipos: tipos.length\n    }\n}));"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        2080,
        2256
      ],
      "id": "84b2142f-5048-42ba-a6f8-7bd2036c2e2a",
      "name": "Expandir por Tipo1"
    },
    {
      "parameters": {
        "options": {}
      },
      "type": "n8n-nodes-base.splitInBatches",
      "typeVersion": 3,
      "position": [
        2304,
        2256
      ],
      "id": "cb4a0722-aef6-483d-9123-5cde9e359630",
      "name": "Loop por Tipo1"
    },
    {
      "parameters": {
        "jsCode": "// =============================================\n// NODO: Parsear Final (Con Nombre Proyecto)\n// =============================================\nconst inputJson = $input.first().json;\nconst llmOutput = inputJson.text || inputJson.content || \"[]\";\n\n// 1. Recuperar Contexto del Loop\nlet projectId = \"unknown\";\nlet documentId = \"unknown\";\nlet tipoEvaluacion = \"Unknown\";\nlet nombreProyecto = \"Sin Nombre\"; // âœ… Variable nueva\n\ntry {\n    const loopData = $('Loop por Tipo1').first().json;\n    projectId = loopData.rfq_project_id;\n    documentId = loopData.rfq_document_id;\n    tipoEvaluacion = loopData.tipo_evaluacion;\n    nombreProyecto = loopData.nombre_proyecto || \"Sin Nombre\"; // âœ… Recuperamos del Loop\n} catch(e) {}\n\n// 2. LÃ³gica de Parsing (Intenta JSON, si falla intenta Texto)\nlet items = [];\n\n// Intento A: JSON Puro\ntry {\n    let clean = llmOutput.replace(/```json/gi, '').replace(/```/g, '').trim();\n    const start = clean.indexOf('[');\n    const end = clean.lastIndexOf(']');\n    if (start !== -1 && end !== -1) {\n        items = JSON.parse(clean.substring(start, end + 1));\n    }\n} catch(e) {}\n\n// Intento B: Lista de texto (Fallback para Deliverables)\nif (items.length === 0) {\n    const lines = llmOutput.split('\\n');\n    let currentPhase = \"General\";\n    for (let i = 0; i < lines.length; i++) {\n        const line = lines[i].trim();\n        if (!line) continue;\n        // Detectar Fase (ej: \"3. Civil...\")\n        if (/^\\d+\\./.test(line) && !line.includes('Estimate')) {\n            const text = line.replace(/^\\d+\\.\\s*/, '').trim();\n             // Chequeo simple si es fase (si la siguiente linea es un item)\n            if (i+1 < lines.length && (lines[i+1].trim().startsWith('-') || lines[i+1].trim().startsWith('â€¢'))) {\n                currentPhase = text;\n            } else {\n                 items.push({ fase: \"General\", requisito_rfq: text });\n            }\n        }\n        // Detectar Item (ej: \"- Documento\")\n        else if (line.startsWith('-') || line.startsWith('â€¢')) {\n            items.push({ fase: currentPhase, requisito_rfq: line.replace(/^[-â€¢]\\s*/, '').trim() });\n        }\n    }\n}\n\n// 3. Generar ID y Salida\nfunction generateId(str) {\n    let hash = 0;\n    for (let i = 0; i < str.length; i++) {\n        hash = ((hash << 5) - hash) + str.charCodeAt(i);\n        hash = hash & hash;\n    }\n    return 'item_' + Math.abs(hash).toString(16).padStart(12, '0');\n}\n\n// âœ… RETURN CON EL NOMBRE DEL PROYECTO\nreturn items.map(item => ({\n    json: {\n        item_id: generateId(projectId + documentId + item.fase + item.requisito_rfq),\n        rfq_project_id: projectId,     // ID tÃ©cnico (para la mÃ¡quina)\n        project_name: nombreProyecto,  // âœ… NOMBRE REAL (para el humano)\n        rfq_document_id: documentId,\n        evaluation: tipoEvaluacion,\n        fase: item.fase,\n        requisito_rfq: item.requisito_rfq\n    }\n}));"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        3328,
        2224
      ],
      "id": "18c0fa19-4bdc-47d0-8f24-22f403d0fcc4",
      "name": "Parsear Items1"
    },
    {
      "parameters": {
        "jsCode": "// =============================================\n// NODO: Agregar Resultados del Tipo Actual\n// =============================================\n\nconst items = $input.all();\n\n// Contar items insertados\nconst totalInserted = items.length;\n\n// Recuperar info del tipo actual\nlet tipoActual = \"unknown\";\ntry {\n    tipoActual = $('Loop por Tipo1').first().json.tipo_evaluacion;\n} catch(e) {}\n\nconsole.log(`âœ… Tipo ${tipoActual}: ${totalInserted} items insertados`);\n\nreturn {\n    json: {\n        tipo_procesado: tipoActual,\n        items_insertados: totalInserted,\n        continuar_loop: true\n    }\n};"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        3856,
        2416
      ],
      "id": "c4d1ecfe-f012-472a-aad5-6baab2106fe2",
      "name": "Agregar Resultados1"
    },
    {
      "parameters": {
        "jsCode": "// =============================================\n// NODO: Resumen Final\n// =============================================\n\n// Recuperar datos del proyecto\nlet projectId = \"unknown\";\nlet fileTitle = \"unknown\";\nlet tiposDetectados = [];\n\ntry {\n    const projectNode = $('Generate IDs1').first().json;\n    projectId = projectNode.rfq_project_id;\n    fileTitle = projectNode.file_title;\n} catch(e) {}\n\ntry {\n    const clasificador = $('Clasificador de Tipos1').first().json;\n    const output = clasificador.output || clasificador;\n    tiposDetectados = output.tipos_detectados || [];\n} catch(e) {}\n\nconsole.log(\"========================================\");\nconsole.log(\"âœ… PROCESAMIENTO RFQ COMPLETADO\");\nconsole.log(`   Proyecto: ${projectId}`);\nconsole.log(`   Archivo: ${fileTitle}`);\nconsole.log(`   Tipos procesados: ${tiposDetectados.length}`);\nconsole.log(\"========================================\");\n\nreturn {\n    json: {\n        success: true,\n        rfq_project_id: projectId,\n        file_title: fileTitle,\n        tipos_procesados: tiposDetectados,\n        mensaje: `RFQ procesada correctamente. ${tiposDetectados.length} tipo(s) de evaluaciÃ³n detectados y poblados.`\n    }\n};"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        3200,
        1920
      ],
      "id": "0807ad40-af0e-4341-8673-42dcdc6a1a4b",
      "name": "Resumen Final1"
    },
    {
      "parameters": {
        "respondWith": "json",
        "responseBody": "={{ JSON.stringify($json) }}",
        "options": {}
      },
      "type": "n8n-nodes-base.respondToWebhook",
      "typeVersion": 1.5,
      "position": [
        3488,
        1920
      ],
      "id": "35393e1e-9723-426c-825c-97266d688733",
      "name": "Respond Success1"
    },
    {
      "parameters": {
        "jsCode": "// =============================================\n// NODO: Base64 a Binary\n// =============================================\n\nconst inputData = $json;\nconst base64Data = inputData.file_binary;\n\nif (!base64Data || base64Data === \"\") {\n    throw new Error(\"âŒ CRÃTICO: 'file_binary' estÃ¡ vacÃ­o\");\n}\n\nconst binaryData = Buffer.from(base64Data, 'base64');\n\nconsole.log(`âœ… PDF convertido: ${binaryData.length} bytes`);\n\nreturn {\n    json: {\n        rfq_project_id: inputData.rfq_project_id,\n        file_title: inputData.file_title\n    },\n    binary: {\n        data: {\n            data: binaryData.toString('base64'),\n            mimeType: 'application/pdf',\n            fileName: inputData.file_title || 'rfq.pdf',\n            fileSize: binaryData.length\n        }\n    }\n};"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        976,
        2256
      ],
      "id": "791f5a2f-11a8-4e37-a996-2288f84a8c42",
      "name": "Base64 a Binary3"
    },
    {
      "parameters": {
        "operation": "pdf",
        "options": {}
      },
      "type": "n8n-nodes-base.extractFromFile",
      "typeVersion": 1.1,
      "position": [
        1200,
        2256
      ],
      "id": "9f3b0f8b-2918-484e-82fc-7d5fe31490d7",
      "name": "Extract from File3"
    },
    {
      "parameters": {
        "jsCode": "// =============================================\n// NODO: Generate IDs (MEJORADO)\n// =============================================\n// Reemplaza el nodo \"Generate Project ID\"\n// Este nodo genera IDs estables y Ãºnicos\n\nfunction stableHash(str) {\n  let hash = 0;\n  for (let i = 0; i < str.length; i++) {\n    const char = str.charCodeAt(i);\n    hash = ((hash << 5) - hash) + char;\n    hash = hash & hash;\n  }\n  return Math.abs(hash).toString(16).padStart(12, '0').substring(0, 12);\n}\n\nconst body = $json.body || $json;\nconst fileTitle = body.file_title || \"unknown.pdf\";\nconst fileBinary = body.file_binary || \"\";\n\n// NUEVO: Extraer project_name del webhook o usar file_title\nconst projectName = body.project_name || fileTitle.replace(/\\.(pdf|docx)$/i, '');\n\n// 1. PROJECT_ID (basado solo en nombre del proyecto, sin timestamp)\n//    â†’ Mismo proyecto = mismo ID, aunque sean diferentes documentos\nconst projectId = 'proj_' + stableHash(projectName.toLowerCase().trim());\n\n// 2. DOCUMENT_ID (Ãºnico por archivo, estable entre subidas)\n//    â†’ Mismo archivo = mismo ID, incluso si se sube mÃºltiples veces\nconst documentId = 'doc_' + stableHash(fileTitle + fileBinary.substring(0, 1000));\n\nconsole.log(\"=== GENERACIÃ“N DE IDs ===\");\nconsole.log(`Project Name: ${projectName}`);\nconsole.log(`Project ID: ${projectId}`);\nconsole.log(`Document ID: ${documentId}`);\nconsole.log(`File Title: ${fileTitle}`);\n\nreturn {\n  json: {\n    rfq_project_id: projectId,      // Compartido entre docs del mismo proyecto\n    rfq_document_id: documentId,    // Ãšnico por documento\n    project_name: projectName,      // Nombre legible del proyecto\n    file_title: fileTitle,\n    file_binary: fileBinary\n  }\n};"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        752,
        2256
      ],
      "id": "a97b0027-db30-452e-96d4-485463b1fd9e",
      "name": "Generate IDs1"
    },
    {
      "parameters": {
        "rules": {
          "values": [
            {
              "conditions": {
                "options": {
                  "caseSensitive": true,
                  "leftValue": "",
                  "typeValidation": "strict",
                  "version": 3
                },
                "conditions": [
                  {
                    "leftValue": "={{ $json.tipo_evaluacion }}",
                    "rightValue": "Evaluation",
                    "operator": {
                      "type": "string",
                      "operation": "contains"
                    },
                    "id": "c3ac36b0-dcd7-4e84-a72a-7e88b6f2fc2a"
                  }
                ],
                "combinator": "and"
              }
            },
            {
              "conditions": {
                "options": {
                  "caseSensitive": true,
                  "leftValue": "",
                  "typeValidation": "strict",
                  "version": 3
                },
                "conditions": [
                  {
                    "id": "529ee554-7a05-413a-9782-710d0deb6365",
                    "leftValue": "={{ $json.tipo_evaluacion }}",
                    "rightValue": "Deliverables",
                    "operator": {
                      "type": "string",
                      "operation": "contains"
                    }
                  }
                ],
                "combinator": "and"
              }
            }
          ]
        },
        "options": {}
      },
      "type": "n8n-nodes-base.switch",
      "typeVersion": 3.4,
      "position": [
        2704,
        2416
      ],
      "id": "49d14f2e-a0d0-4a68-8c13-5863f2d33dc5",
      "name": "Switch1"
    },
    {
      "parameters": {
        "model": "qwen3:14b",
        "options": {
          "temperature": 0.1,
          "numCtx": 32768
        }
      },
      "type": "@n8n/n8n-nodes-langchain.lmOllama",
      "typeVersion": 1,
      "position": [
        3024,
        2848
      ],
      "id": "485ef701-8515-4d60-8bff-12970d1c2f7e",
      "name": "Ollama Extractor2",
      "credentials": {
        "ollamaApi": {
          "id": "oS2Qqti9oVfsm8XZ",
          "name": "Ollama account"
        }
      }
    },
    {
      "parameters": {
        "promptType": "define",
        "text": "=### EXTRACCIÃ“N DE LISTA DE ENTREGABLES (TEXTO DESORDENADO)\n\nProyecto: {{ $json.rfq_project_id }} - {{ $json.nombre_proyecto }}\nArchivo: {{ $json.file_title }}\n\n### TEXTO DEL PDF (SIN FORMATO DE TABLA):\n{{ $json.texto_rfq }}",
        "messages": {
          "messageValues": [
            {
              "message": "=### ROL\nEres un motor de extracciÃ³n de datos automatizado (JSON Parser). **NO eres un asistente conversacional.** Tu Ãºnica funciÃ³n es transformar texto desestructurado en un array JSON.\n\n### ENTRADA\nRecibirÃ¡s texto crudo de un PDF donde se ha perdido el formato de tabla. VerÃ¡s secuencias de nÃºmeros y textos mezclados.\n\n### INSTRUCCIONES DE PROCESAMIENTO\n\n1. **IdentificaciÃ³n de FASES/DISCIPLINAS:**\n   - Busca los siguientes tÃ©rminos clave para identificar las fases/disciplina:\n     - **\"Process Engineering\", \"Mechanical Engineering\", \"Piping\", \"Civil and Structural\", \"Electrical\", \"Instrumentation and Control\", \"HSE / Safety\", \"Planning\", \"Cost / Estimating\", \"Management / General\", \"Preliminary surveys\"**\n   - Cada vez que encuentres uno de estos tÃ©rminos, marca el comienzo de una nueva fase y asigna todos los documentos que aparezcan debajo de ella hasta que se detecte la siguiente fase.\n\n2. **AsociaciÃ³n de DOCUMENTOS:**\n   - Cada documento o entregable mencionado debajo de una fase debe ser asociado con esa fase.\n   - **Cada documento debe ser tratado como una unidad indivisible**. **No agrupes varios documentos en una sola lÃ­nea.**\n\n3. **Limpieza de Datos:**\n   - **Elimina los nÃºmeros de Ã­ndice** al inicio de las lÃ­neas (por ejemplo, \"1.\", \"2.\", \"3.\", etc.).\n   - **Ignora lÃ­neas administrativas** como \"Date\", \"Rev\", \"Checked\", \"Description\", y otras que no sean documentos tÃ©cnicos.\n\n4. **Atomicidad Documental:**\n   - **Cada documento debe ser tratado como una entidad indivisible**. Si una lÃ­nea contiene varios documentos o planos, debes generar un objeto JSON para **cada documento individual**.\n   - Si encuentras comas que separan elementos, debes **crear un objeto JSON por cada Ã­tem**.\n     - Ejemplo:\n       - **Entrada:** \"P&IDs, PFDs, Heat & Material Balance\"\n       - **Salida:**\n         ```json\n         {\"fase\": \"Civil Engineering\", \"requisito_rfq\": \"P&IDs\"}\n         {\"fase\": \"Civil Engineering\", \"requisito_rfq\": \"PFDs\"}\n         {\"fase\": \"Civil Engineering\", \"requisito_rfq\": \"Heat & Material Balance\"}\n         ```\n\n5. **Protocolo de Persistencia (Anti-Truncamiento):**\n   - **Nunca truncarÃ¡s listas largas de documentos.** Si encuentras una lista larga de entregables (como planos, diagramas, etc.), **tu Ãºnica salida vÃ¡lida es transcribir toda la lista, Ã­tem por Ã­tem**.\n   - **Prohibido** usar \"...\" o detenerse antes de completar la lista. Esto se considera un **error fatal**.\n     - Ejemplo:\n       - **Entrada incorrecta:** \"Planos de planta, alzado, perfil, etc.\"\n       - **Salida incorrecta:**\n         ```json\n         {\"fase\": \"Civil Engineering\", \"requisito_rfq\": \"Planos de planta\"}\n         {\"fase\": \"Civil Engineering\", \"requisito_rfq\": \"Alzado\"}\n         {\"fase\": \"Civil Engineering\", \"requisito_rfq\": \"Perfil\"}\n         ```\n       - **Entrada correcta (transcripciÃ³n completa):**\n         ```json\n         {\"fase\": \"Civil Engineering\", \"requisito_rfq\": \"Planos de planta\"}\n         {\"fase\": \"Civil Engineering\", \"requisito_rfq\": \"Alzado\"}\n         {\"fase\": \"Civil Engineering\", \"requisito_rfq\": \"Perfil\"}\n         ```\n\n6. **Manejo de \"EtcÃ©teras\" y Frases GenÃ©ricas:**\n   - **Prohibido** usar tÃ©rminos como \"etc.\", \"varios\", \"entre otros\", \"and similar\". Si el texto menciona frases genÃ©ricas como \"y otros planos asociados\", debes **ignorar esa frase** y asegurarte de que todos los documentos mencionados anteriormente se extraigan **de manera explÃ­cita**.\n     - Si el texto menciona \"y otros planos\", **asegÃºrate de haber extraÃ­do todos los documentos especÃ­ficos** que se mencionan antes de esa expresiÃ³n.\n  \n7. **Limpieza de Enumeraciones Sucias:**\n   - Si encuentras una lista sucia de documentos o requisitos, como:\n     ```\n     Foundation layout\n     Piling details\n     ```\n     Debes **eliminarlos de la lista** y asegurarte de que se extraigan **de manera individual** en el formato correcto:\n     ```json\n     {\"fase\": \"Civil Engineering\", \"requisito_rfq\": \"Foundation layout\"}\n     {\"fase\": \"Civil Engineering\", \"requisito_rfq\": \"Piling details\"}\n     ```\n\n### FORMATO DE SALIDA (CRÃTICO)\n- Tu respuesta debe ser **estrictamente** un array de objetos JSON. Cada objeto debe contener los campos **fase** y **requisito_rfq**.\n- **Prohibido**: Escribir introducciones, conclusiones, o usar bloques de cÃ³digo markdown (```json).\n- **Prohibido**: Devolver listas numeradas o con guiones.\n- **Ejemplo de salida correcta**:\n  ```json\n  [\n    {\"fase\": \"Mechanical Engineering\", \"requisito_rfq\": \"Rotating equipment philosophy\"},\n    {\"fase\": \"Mechanical Engineering\", \"requisito_rfq\": \"Tanks calculations\"},\n    {\"fase\": \"Electrical Engineering\", \"requisito_rfq\": \"Electrical design basis\"},\n    {\"fase\": \"Electrical Engineering\", \"requisito_rfq\": \"Single line diagram\"}\n  ]\n\n###EJEMPLO DE COMPORTAMIENTO (Few-Shot)\nTexto de Entrada (Ejemplo):\n\narduino\nCopiar cÃ³digo\n10\n11\nMechanical Engineering\nRotating equipment philosophy\nTanks calculations\nElectrical Engineering\nElectrical design basis\nSingle line diagram\nRespuesta esperada (JSON Puro):\n\n##EJEMPLO RESPUESTA\n\n[\n  {\"fase\": \"Mechanical Engineering\", \"requisito_rfq\": \"Rotating equipment philosophy\"},\n  {\"fase\": \"Mechanical Engineering\", \"requisito_rfq\": \"Tanks calculations\"},\n  {\"fase\": \"Electrical Engineering\", \"requisito_rfq\": \"Electrical design basis\"},\n  {\"fase\": \"Electrical Engineering\", \"requisito_rfq\": \"Single line diagram\"}\n]\n"
            }
          ]
        },
        "batching": {}
      },
      "type": "@n8n/n8n-nodes-langchain.chainLlm",
      "typeVersion": 1.7,
      "position": [
        2976,
        2624
      ],
      "id": "acfce844-30b2-47af-af0d-ae34d130cf03",
      "name": "LLM Extractor - Deliverables"
    },
    {
      "parameters": {
        "promptType": "define",
        "text": "=### EXTRACCIÃ“N DE ITEMS PARA: {{ $json.tipo_evaluacion }}\n\nProyecto: {{ $json.rfq_project_id }}\nArchivo: {{ $json.file_title }}\n\n### DOCUMENTO RFQ:\n{{ $json.texto_rfq }}",
        "messages": {
          "messageValues": [
            {
              "message": "=# EXTRACTOR DE ÃTEMS RFQ\n\nEres un extractor especializado de requisitos de documentos RFQ de ingenierÃ­a.\n\n## TU TAREA\n\nExtraer TODOS los Ã­tems/requisitos del documento que correspondan al tipo de evaluaciÃ³n indicado.\n\n---\n\n# INSTRUCCIONES CRÃTICAS DE FORMATO\n\nTu respuesta DEBE ser ÃšNICAMENTE un JSON array vÃ¡lido.\n\n**PROHIBIDO:**\n- Texto explicativo antes o despuÃ©s del JSON\n- TÃ­tulos markdown (###, **)\n- Listas numeradas (1., 2., 3.)\n- Comentarios\n- Backticks de markdown (```json o ```)\n- Encabezados de cualquier tipo\n- Notas adicionales\n\n**FORMATO CORRECTO (tu respuesta completa):**\n[\n  {\"fase\": \"Process Engineering\", \"requisito_rfq\": \"Basis of design\"},\n  {\"fase\": \"Process Engineering\", \"requisito_rfq\": \"Mass and Energy balance\"},\n  {\"fase\": \"Mechanical Engineering\", \"requisito_rfq\": \"Equipment datasheets\"}\n]\n\n**IMPORTANTE:**\n- Primera lÃ­nea de tu respuesta: `[`\n- Ãšltima lÃ­nea de tu respuesta: `]`\n- Sin explicaciones adicionales de ningÃºn tipo\n- Sin encabezados de ningÃºn tipo\n\n---\n\n# REGLAS POR TIPO DE EVALUACIÃ“N\n\n### Si tipo_evaluacion = \"Pre-FEED Deliverables\" o \"FEED Deliverables\":\n\n**Busca:** Tablas o listas de documentos organizadas por DISCIPLINA\n\n**Disciplinas tÃ­picas:**\n- Management\n- Process Engineering\n- Mechanical Engineering\n- Piping\n- Civil and Structural Engineering\n- Electrical Engineering\n- Instrumentation and Control Engineering\n- HSE / Safety\n- Planning\n- Cost\n- Procurement\n- Preliminary surveys\n- Technical and economical studies\n\n**ExtracciÃ³n:**\n- **FASE =** Nombre de la disciplina/secciÃ³n\n- **REQUISITO =** Cada documento/entregable listado (no omitir ninguno)\n\n**Ejemplo de salida (tu respuesta completa):**\n[\n  {\"fase\": \"Process Engineering\", \"requisito_rfq\": \"Basis of design\"},\n  {\"fase\": \"Process Engineering\", \"requisito_rfq\": \"Mass and Energy balance\"},\n  {\"fase\": \"Process Engineering\", \"requisito_rfq\": \"Process flow diagrams\"},\n  {\"fase\": \"Process Engineering\", \"requisito_rfq\": \"P&IDs\"}\n]\n\n### Si tipo_evaluacion = \"Technical Evaluation\":\n\n**Busca:** Requisitos tÃ©cnicos, alcance, metodologÃ­a, especificaciones\n\n**Fases tÃ­picas:**\n- PRE-FEED\n- FEED\n- EPC TENDER\n\n**ExtracciÃ³n:**\n- **FASE =** Fase del proyecto (PRE-FEED, FEED, EPC TENDER)\n- **REQUISITO =** Cada requisito tÃ©cnico mencionado (no omitir ninguno)\n\n### Si tipo_evaluacion = \"Economical Evaluation\":\n\n**Busca:** Formato de precios, tarifas, horas por disciplina\n\n**Fases tÃ­picas:**\n- PRE-FEED\n- FEED\n- EPC TENDER\n- EPC Budgetary Price\n- General Comments\n\n**ExtracciÃ³n:**\n- **FASE =** Fase del proyecto\n- **REQUISITO =** Cada concepto econÃ³mico a cotizar (sin omitir detalles)\n\n---\n\n**REGLA DE \"EXPLOSIÃ“N\" DE PRECIOS:**\n\nSi encuentras una solicitud de precios agrupada (ej: \"Hours per discipline (Process, Civil, Mechanical...)\"), **ESTÃ PROHIBIDO** generar un solo Ã­tem.  \n**DEBES separar cada elemento entre parÃ©ntesis en su propia fila.**\n\n- **Entrada:** \"Rates for engineering (Manager, Senior, Junior)\"\n- **Salida (3 filas):**\n  1. \"Rate - Manager\"\n  2. \"Rate - Senior\"\n  3. \"Rate - Junior\""
            }
          ]
        },
        "batching": {}
      },
      "type": "@n8n/n8n-nodes-langchain.chainLlm",
      "typeVersion": 1.7,
      "position": [
        2976,
        2224
      ],
      "id": "ac424e7e-254b-4fa7-8413-450b891ed925",
      "name": "LLM Extractor Tech-Econ"
    },
    {
      "parameters": {
        "jsCode": "// =============================================\n// NODO: Parsear Final (Con Nombre Proyecto)\n// =============================================\nconst inputJson = $input.first().json;\nconst llmOutput = inputJson.text || inputJson.content || \"[]\";\n\n// 1. Recuperar Contexto del Loop\nlet projectId = \"unknown\";\nlet documentId = \"unknown\";\nlet tipoEvaluacion = \"Unknown\";\nlet nombreProyecto = \"Sin Nombre\"; // âœ… Variable nueva\n\ntry {\n    const loopData = $('Loop por Tipo1').first().json;\n    projectId = loopData.rfq_project_id;\n    documentId = loopData.rfq_document_id;\n    tipoEvaluacion = loopData.tipo_evaluacion;\n    nombreProyecto = loopData.nombre_proyecto || \"Sin Nombre\"; // âœ… Recuperamos del Loop\n} catch(e) {}\n\n// 2. LÃ³gica de Parsing (Intenta JSON, si falla intenta Texto)\nlet items = [];\n\n// Intento A: JSON Puro\ntry {\n    let clean = llmOutput.replace(/```json/gi, '').replace(/```/g, '').trim();\n    const start = clean.indexOf('[');\n    const end = clean.lastIndexOf(']');\n    if (start !== -1 && end !== -1) {\n        items = JSON.parse(clean.substring(start, end + 1));\n    }\n} catch(e) {}\n\n// Intento B: Lista de texto (Fallback para Deliverables)\nif (items.length === 0) {\n    const lines = llmOutput.split('\\n');\n    let currentPhase = \"General\";\n    for (let i = 0; i < lines.length; i++) {\n        const line = lines[i].trim();\n        if (!line) continue;\n        // Detectar Fase (ej: \"3. Civil...\")\n        if (/^\\d+\\./.test(line) && !line.includes('Estimate')) {\n            const text = line.replace(/^\\d+\\.\\s*/, '').trim();\n             // Chequeo simple si es fase (si la siguiente linea es un item)\n            if (i+1 < lines.length && (lines[i+1].trim().startsWith('-') || lines[i+1].trim().startsWith('â€¢'))) {\n                currentPhase = text;\n            } else {\n                 items.push({ fase: \"General\", requisito_rfq: text });\n            }\n        }\n        // Detectar Item (ej: \"- Documento\")\n        else if (line.startsWith('-') || line.startsWith('â€¢')) {\n            items.push({ fase: currentPhase, requisito_rfq: line.replace(/^[-â€¢]\\s*/, '').trim() });\n        }\n    }\n}\n\n// 3. Generar ID y Salida\nfunction generateId(str) {\n    let hash = 0;\n    for (let i = 0; i < str.length; i++) {\n        hash = ((hash << 5) - hash) + str.charCodeAt(i);\n        hash = hash & hash;\n    }\n    return 'item_' + Math.abs(hash).toString(16).padStart(12, '0');\n}\n\n// âœ… RETURN CON EL NOMBRE DEL PROYECTO\nreturn items.map(item => ({\n    json: {\n        item_id: generateId(projectId + documentId + item.fase + item.requisito_rfq),\n        rfq_project_id: projectId,     // ID tÃ©cnico (para la mÃ¡quina)\n        project_name: nombreProyecto,  // âœ… NOMBRE REAL (para el humano)\n        rfq_document_id: documentId,\n        evaluation: tipoEvaluacion,\n        fase: item.fase,\n        requisito_rfq: item.requisito_rfq\n    }\n}));"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        3328,
        2624
      ],
      "id": "6adf0a1d-b3c0-4b74-bd78-de1add7d8115",
      "name": "Parsear deliverables"
    },
    {
      "parameters": {
        "dataTableId": {
          "__rl": true,
          "value": "hwY1VFb924Ptf1P6",
          "mode": "list",
          "cachedResultName": "Tabla-RFQ-v1",
          "cachedResultUrl": "/projects/YoqFb1alZvPQmuNs/datatables/hwY1VFb924Ptf1P6"
        },
        "columns": {
          "mappingMode": "defineBelow",
          "value": {
            "evaluation": "={{ $json.evaluation }}",
            "fase": "={{ $json.fase }}",
            "requisito_rfq": "={{ $json.requisito_rfq }}",
            "project_name": "={{ $json.project_name }}"
          },
          "matchingColumns": [
            "item_id"
          ],
          "schema": [
            {
              "id": "project_name",
              "displayName": "project_name",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "readOnly": false,
              "removed": false
            },
            {
              "id": "evaluation",
              "displayName": "evaluation",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "readOnly": false,
              "removed": false
            },
            {
              "id": "fase",
              "displayName": "fase",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "readOnly": false,
              "removed": false
            },
            {
              "id": "requisito_rfq",
              "displayName": "requisito_rfq",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "readOnly": false,
              "removed": false
            },
            {
              "id": "IDOM",
              "displayName": "IDOM",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "readOnly": false,
              "removed": true
            },
            {
              "id": "SACYR",
              "displayName": "SACYR",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "readOnly": false,
              "removed": true
            },
            {
              "id": "EA",
              "displayName": "EA",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "readOnly": false,
              "removed": true
            },
            {
              "id": "SENER",
              "displayName": "SENER",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "readOnly": false,
              "removed": true
            },
            {
              "id": "TRESCA",
              "displayName": "TRESCA",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "readOnly": false,
              "removed": true
            },
            {
              "id": "WORLEY",
              "displayName": "WORLEY",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "readOnly": false,
              "removed": true
            },
            {
              "id": "TECNICASREUNIDAS",
              "displayName": "TECNICASREUNIDAS",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "readOnly": false,
              "removed": true
            }
          ],
          "attemptToConvertTypes": false,
          "convertFieldsToString": false
        },
        "options": {}
      },
      "type": "n8n-nodes-base.dataTable",
      "typeVersion": 1.1,
      "position": [
        3600,
        2416
      ],
      "id": "41c3d1af-ab32-4c65-8a55-cd3eb55be9c5",
      "name": "Insertar Items en Tabla1"
    },
    {
      "parameters": {
        "model": "mistral-large-latest",
        "options": {}
      },
      "type": "@n8n/n8n-nodes-langchain.lmChatMistralCloud",
      "typeVersion": 1,
      "position": [
        3184,
        2416
      ],
      "id": "9ff5194c-0c2d-486a-9de3-e97db3c2c3de",
      "name": "Mistral Cloud Chat Model",
      "credentials": {
        "mistralCloudApi": {
          "id": "tDjuOnF6lpADMmd5",
          "name": "Mistral Cloud account"
        }
      }
    },
    {
      "parameters": {
        "model": "deepseek-r1:14b",
        "options": {
          "temperature": 0.1
        }
      },
      "type": "@n8n/n8n-nodes-langchain.lmOllama",
      "typeVersion": 1,
      "position": [
        3024,
        2432
      ],
      "id": "7c5ef113-f2f3-4304-92ae-22afc3b572df",
      "name": "Ollama Extractor1",
      "credentials": {
        "ollamaApi": {
          "id": "oS2Qqti9oVfsm8XZ",
          "name": "Ollama account"
        }
      },
      "disabled": true
    },
    {
      "parameters": {
        "model": "mistral-large-latest",
        "options": {}
      },
      "type": "@n8n/n8n-nodes-langchain.lmChatMistralCloud",
      "typeVersion": 1,
      "position": [
        2880,
        2832
      ],
      "id": "68479b0b-1da5-465e-8506-3b935ef2c218",
      "name": "Mistral Cloud Chat Model1",
      "credentials": {
        "mistralCloudApi": {
          "id": "tDjuOnF6lpADMmd5",
          "name": "Mistral Cloud account"
        }
      }
    },
    {
      "parameters": {
        "model": "mistral-large-latest",
        "options": {}
      },
      "type": "@n8n/n8n-nodes-langchain.lmChatMistralCloud",
      "typeVersion": 1,
      "position": [
        1792,
        2480
      ],
      "id": "7932fede-44ac-4b7d-8a29-12398c5e4c51",
      "name": "Mistral Cloud Chat Model2",
      "credentials": {
        "mistralCloudApi": {
          "id": "tDjuOnF6lpADMmd5",
          "name": "Mistral Cloud account"
        }
      }
    },
    {
      "parameters": {
        "model": "mistral-large-latest",
        "options": {}
      },
      "type": "@n8n/n8n-nodes-langchain.lmChatMistralCloud",
      "typeVersion": 1,
      "position": [
        2688,
        352
      ],
      "id": "36f124b3-6a9d-4898-8860-b6816edc683a",
      "name": "Mistral Cloud Chat Model3",
      "credentials": {
        "mistralCloudApi": {
          "id": "tDjuOnF6lpADMmd5",
          "name": "Mistral Cloud account"
        }
      }
    },
    {
      "parameters": {
        "model": "mistral-large-latest",
        "options": {}
      },
      "type": "@n8n/n8n-nodes-langchain.lmChatMistralCloud",
      "typeVersion": 1,
      "position": [
        3440,
        1312
      ],
      "id": "649f1a99-c931-4c26-8620-dbc8f4a81b70",
      "name": "Mistral Cloud Chat Model4",
      "credentials": {
        "mistralCloudApi": {
          "id": "tDjuOnF6lpADMmd5",
          "name": "Mistral Cloud account"
        }
      }
    },
    {
      "parameters": {
        "conditions": {
          "options": {
            "caseSensitive": true,
            "leftValue": "",
            "typeValidation": "strict",
            "version": 3
          },
          "conditions": [
            {
              "id": "267128b5-e2c0-44ae-9973-7f18dffe292e",
              "leftValue": "={{ $('Set File ID').item.json.proveedor }}",
              "rightValue": "",
              "operator": {
                "type": "string",
                "operation": "notEmpty",
                "singleValue": true
              }
            },
            {
              "id": "a9d65ff4-430e-45db-8ca8-6078e5ee32fa",
              "leftValue": "={{ $('Set File ID').item.json.evaluation[0] }}",
              "rightValue": "",
              "operator": {
                "type": "string",
                "operation": "notEmpty",
                "singleValue": true
              }
            },
            {
              "id": "d5c265e7-00e5-42f4-95ad-4eca1e3ef530",
              "leftValue": "={{ $('Set File ID').item.json.proyect_name }}",
              "rightValue": "",
              "operator": {
                "type": "string",
                "operation": "notEmpty",
                "singleValue": true
              }
            }
          ],
          "combinator": "and"
        },
        "options": {}
      },
      "type": "n8n-nodes-base.if",
      "typeVersion": 2.3,
      "position": [
        3376,
        912
      ],
      "id": "4695f851-52be-461a-9918-5ed3ef9dcea3",
      "name": "If"
    },
    {
      "parameters": {
        "model": "mistral-large-latest",
        "options": {}
      },
      "type": "@n8n/n8n-nodes-langchain.lmChatMistralCloud",
      "typeVersion": 1,
      "position": [
        -1360,
        480
      ],
      "id": "529f1c5c-cba4-4864-90aa-ae96ea246121",
      "name": "Mistral Cloud Chat Model5",
      "credentials": {
        "mistralCloudApi": {
          "id": "tDjuOnF6lpADMmd5",
          "name": "Mistral Cloud account"
        }
      }
    }
  ],
  "pinData": {
    "Clasificador Tipo RFQ": [
      {
        "json": {
          "output": {
            "tipos_detectados": [
              "Pre-FEED Deliverables"
            ],
            "razonamiento": "El documento incluye aspectos tÃ©cnicos (ej.: diseÃ±o estructural, cÃ¡lculos de tuberÃ­as, selecciÃ³n de materiales), evaluaciones econÃ³micas (ej.: estimaciÃ³n de CAPEX y costos de operaciÃ³n) y entregables especÃ­ficos de Pre-FEED (ej.: estudios de riesgo, diagramas de proceso, planos de diseÃ±o). No se mencionan entregables de FEED."
          }
        }
      }
    ]
  },
  "connections": {
    "Code in JavaScript1": {
      "main": [
        [
          {
            "node": "Set File ID",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Reset de valores": {
      "main": [
        [
          {
            "node": "Get row(s)",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Base64 a Binary1": {
      "main": [
        [
          {
            "node": "Docling OCR",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Base64 a Binary": {
      "main": [
        [
          {
            "node": "Extract from File",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Webhook": {
      "main": [
        [
          {
            "node": "Code in JavaScript1",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Get row(s)": {
      "main": [
        [
          {
            "node": "Respond to Webhook",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Reset Items": {
      "main": [
        [
          {
            "node": "Loop Over Items",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Clasificador de Tipo de RFQ y Proveedor": {
      "main": [
        [
          {
            "node": "Format for Vectorstore",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Merge1": {
      "main": [
        [
          {
            "node": "If",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Structured Output Parser": {
      "ai_outputParser": [
        [
          {
            "node": "Clasificador de Tipo de RFQ y Proveedor",
            "type": "ai_outputParser",
            "index": 0
          }
        ]
      ]
    },
    "Docling OCR": {
      "main": [
        [
          {
            "node": "Aggregate OCR Pages",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Loop Over Items1": {
      "main": [
        [
          {
            "node": "Reset de valores",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Get RFQ Items",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Expandir por Tipo de EvaluaciÃ³n": {
      "main": [
        [
          {
            "node": "Loop Over Items1",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Format for Vectorstore": {
      "main": [
        [
          {
            "node": "Insert into Supabase Vectorstore",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Aggregate OCR Pages": {
      "main": [
        [
          {
            "node": "Merge1",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Â¿Necesita OCR?": {
      "main": [
        [
          {
            "node": "Base64 a Binary1",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Merge1",
            "type": "main",
            "index": 1
          }
        ]
      ]
    },
    "Extract from File": {
      "main": [
        [
          {
            "node": "Validar Contenido PDF",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Validar Contenido PDF": {
      "main": [
        [
          {
            "node": "Â¿Necesita OCR?",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Embeddings Ollama": {
      "ai_embedding": [
        [
          {
            "node": "Insert into Supabase Vectorstore",
            "type": "ai_embedding",
            "index": 0
          }
        ]
      ]
    },
    "Insert into Supabase Vectorstore": {
      "main": [
        [
          {
            "node": "Expandir por Tipo de EvaluaciÃ³n",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Get RFQ Items": {
      "main": [
        [
          {
            "node": "Reset Items",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Recursive Character Text Splitter": {
      "ai_textSplitter": [
        [
          {
            "node": "Default Data Loader",
            "type": "ai_textSplitter",
            "index": 0
          }
        ]
      ]
    },
    "Default Data Loader": {
      "ai_document": [
        [
          {
            "node": "Insert into Supabase Vectorstore",
            "type": "ai_document",
            "index": 0
          }
        ]
      ]
    },
    "Set File ID": {
      "main": [
        [
          {
            "node": "Delete Old Doc Rows",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Delete Old Doc Rows": {
      "main": [
        [
          {
            "node": "Insert Document Metadata",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Insert Document Metadata": {
      "main": [
        [
          {
            "node": "Base64 a Binary",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Update RFQ TR": {
      "main": [
        [
          {
            "node": "Merge",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Switch": {
      "main": [
        [
          {
            "node": "Update RFQ TR",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Update RFQ IDOM",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Update RFQ SACYR",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Update RFQ EA",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Update RFQ SENER",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Update RFQ TRESCA",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Update RFQ WORLEY",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "LLM Chain": {
      "main": [
        [
          {
            "node": "Parsear y Preparar Update",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Parsear y Preparar Update": {
      "main": [
        [
          {
            "node": "Switch",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Code in JavaScript": {
      "main": [
        [
          {
            "node": "LLM Chain",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Update RFQ WORLEY": {
      "main": [
        [
          {
            "node": "Merge",
            "type": "main",
            "index": 6
          }
        ]
      ]
    },
    "Update RFQ TRESCA": {
      "main": [
        [
          {
            "node": "Merge",
            "type": "main",
            "index": 5
          }
        ]
      ]
    },
    "Update RFQ SENER": {
      "main": [
        [
          {
            "node": "Merge",
            "type": "main",
            "index": 4
          }
        ]
      ]
    },
    "Update RFQ EA": {
      "main": [
        [
          {
            "node": "Merge",
            "type": "main",
            "index": 3
          }
        ]
      ]
    },
    "Update RFQ SACYR": {
      "main": [
        [
          {
            "node": "Merge",
            "type": "main",
            "index": 2
          }
        ]
      ]
    },
    "Update RFQ IDOM": {
      "main": [
        [
          {
            "node": "Merge",
            "type": "main",
            "index": 1
          }
        ]
      ]
    },
    "Merge": {
      "main": [
        [
          {
            "node": "Loop Over Items",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Loop Over Items": {
      "main": [
        [
          {
            "node": "Loop Over Items1",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Code in JavaScript",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Set File ID2": {
      "main": [
        [
          {
            "node": "Delete Old Doc Rows2",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Delete Old Doc Rows2": {
      "main": [
        [
          {
            "node": "Insert Document Metadata2",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Insert Document Metadata2": {
      "main": [
        [
          {
            "node": "Base64 a Binary RFQ",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Clasificador Tipo RFQ": {
      "main": [
        [
          {
            "node": "Format RFQ for Vectorstore",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Structured Output Parser RFQ": {
      "ai_outputParser": [
        [
          {
            "node": "Clasificador Tipo RFQ",
            "type": "ai_outputParser",
            "index": 0
          }
        ]
      ]
    },
    "Update rfq_requisito": {
      "main": [
        [
          {
            "node": "Loop Over Items RFQ",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Reset Items RFQ": {
      "main": [
        [
          {
            "node": "Loop Over Items RFQ",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Loop Tipos RFQ": {
      "main": [
        [
          {
            "node": "Respond Webhook RFQ",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Get Items por Tipo",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Expandir por Tipo RFQ": {
      "main": [
        [
          {
            "node": "Loop Tipos RFQ",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Get Items por Tipo": {
      "main": [
        [
          {
            "node": "Reset Items RFQ",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "LLM Extractor Requisitos RFQ": {
      "main": [
        [
          {
            "node": "Parsear Requisitos RFQ",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Parsear Requisitos RFQ": {
      "main": [
        [
          {
            "node": "Update rfq_requisito",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Preparar Items para LLM": {
      "main": [
        [
          {
            "node": "LLM Extractor Requisitos RFQ",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Loop Over Items RFQ": {
      "main": [
        [
          {
            "node": "Loop Tipos RFQ",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Preparar Items para LLM",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Format RFQ for Vectorstore": {
      "main": [
        [
          {
            "node": "Insert RFQ Vectorstore",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Embeddings Ollama RFQ": {
      "ai_embedding": [
        [
          {
            "node": "Insert RFQ Vectorstore",
            "type": "ai_embedding",
            "index": 0
          }
        ]
      ]
    },
    "Insert RFQ Vectorstore": {
      "main": [
        [
          {
            "node": "Expandir por Tipo RFQ",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Text Splitter RFQ": {
      "ai_textSplitter": [
        [
          {
            "node": "Default Data Loader RFQ",
            "type": "ai_textSplitter",
            "index": 0
          }
        ]
      ]
    },
    "Default Data Loader RFQ": {
      "ai_document": [
        [
          {
            "node": "Insert RFQ Vectorstore",
            "type": "ai_document",
            "index": 0
          }
        ]
      ]
    },
    "Generate Stable ID RFQ": {
      "main": [
        [
          {
            "node": "Set File ID2",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Base64 a Binary RFQ": {
      "main": [
        [
          {
            "node": "Extract from File1",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Validar Contenido PDF RFQ": {
      "main": [
        [
          {
            "node": "Clasificador Tipo RFQ",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Webhook RFQ": {
      "main": [
        [
          {
            "node": "Generate IDs1",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Extract from File1": {
      "main": [
        [
          {
            "node": "Validar Contenido PDF RFQ",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Postgres Chat Memory": {
      "ai_memory": [
        [
          {
            "node": "RAG AI Agent",
            "type": "ai_memory",
            "index": 0
          }
        ]
      ]
    },
    "When chat message received": {
      "main": [
        [
          {
            "node": "RAG AI Agent",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "RAG AI Agent": {
      "main": [
        [
          {
            "node": "Respond to Webhook1",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "List Documents": {
      "ai_tool": [
        [
          {
            "node": "RAG AI Agent",
            "type": "ai_tool",
            "index": 0
          }
        ]
      ]
    },
    "Get File Contents": {
      "ai_tool": [
        [
          {
            "node": "RAG AI Agent",
            "type": "ai_tool",
            "index": 0
          }
        ]
      ]
    },
    "Query Document Rows": {
      "ai_tool": [
        [
          {
            "node": "RAG AI Agent",
            "type": "ai_tool",
            "index": 0
          }
        ]
      ]
    },
    "consultar_ofertas": {
      "ai_tool": [
        [
          {
            "node": "RAG AI Agent",
            "type": "ai_tool",
            "index": 0
          }
        ]
      ]
    },
    "Webhook1": {
      "main": [
        [
          {
            "node": "RAG AI Agent",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Embeddings Ollama2": {
      "ai_embedding": [
        [
          {
            "node": "consultar_ofertas",
            "type": "ai_embedding",
            "index": 0
          }
        ]
      ]
    },
    "Ollama Model": {
      "ai_languageModel": [
        []
      ]
    },
    "Ollama Model1": {
      "ai_languageModel": [
        []
      ]
    },
    "Ollama Model2": {
      "ai_languageModel": [
        [
          {
            "node": "LLM Extractor Requisitos RFQ",
            "type": "ai_languageModel",
            "index": 0
          }
        ]
      ]
    },
    "Ollama Model3": {
      "ai_languageModel": [
        [
          {
            "node": "Clasificador Tipo RFQ",
            "type": "ai_languageModel",
            "index": 0
          }
        ]
      ]
    },
    "Ollama Chat Model": {
      "ai_languageModel": [
        []
      ]
    },
    "consultar_tabla_evaluacion1": {
      "ai_tool": [
        [
          {
            "node": "RAG AI Agent",
            "type": "ai_tool",
            "index": 0
          }
        ]
      ]
    },
    "Docling OCR1": {
      "main": [
        []
      ]
    },
    "Preparar Texto1": {
      "main": [
        [
          {
            "node": "Clasificador de Tipos1",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Clasificador de Tipos1": {
      "main": [
        [
          {
            "node": "Expandir por Tipo1",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Ollama Clasificador1": {
      "ai_languageModel": [
        []
      ]
    },
    "Output Parser1": {
      "ai_outputParser": [
        [
          {
            "node": "Clasificador de Tipos1",
            "type": "ai_outputParser",
            "index": 0
          }
        ]
      ]
    },
    "Expandir por Tipo1": {
      "main": [
        [
          {
            "node": "Loop por Tipo1",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Loop por Tipo1": {
      "main": [
        [
          {
            "node": "Resumen Final1",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Switch1",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Parsear Items1": {
      "main": [
        [
          {
            "node": "Insertar Items en Tabla1",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Agregar Resultados1": {
      "main": [
        [
          {
            "node": "Loop por Tipo1",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Resumen Final1": {
      "main": [
        [
          {
            "node": "Respond Success1",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Base64 a Binary3": {
      "main": [
        [
          {
            "node": "Extract from File3",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Extract from File3": {
      "main": [
        [
          {
            "node": "Preparar Texto1",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Generate IDs1": {
      "main": [
        [
          {
            "node": "Base64 a Binary3",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Switch1": {
      "main": [
        [
          {
            "node": "LLM Extractor Tech-Econ",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "LLM Extractor - Deliverables",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Ollama Extractor2": {
      "ai_languageModel": [
        []
      ]
    },
    "LLM Extractor Tech-Econ": {
      "main": [
        [
          {
            "node": "Parsear Items1",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "LLM Extractor - Deliverables": {
      "main": [
        [
          {
            "node": "Parsear deliverables",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Parsear deliverables": {
      "main": [
        [
          {
            "node": "Insertar Items en Tabla1",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Insertar Items en Tabla1": {
      "main": [
        [
          {
            "node": "Agregar Resultados1",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Mistral Cloud Chat Model": {
      "ai_languageModel": [
        [
          {
            "node": "LLM Extractor Tech-Econ",
            "type": "ai_languageModel",
            "index": 0
          }
        ]
      ]
    },
    "Ollama Extractor1": {
      "ai_languageModel": [
        []
      ]
    },
    "Mistral Cloud Chat Model1": {
      "ai_languageModel": [
        [
          {
            "node": "LLM Extractor - Deliverables",
            "type": "ai_languageModel",
            "index": 0
          }
        ]
      ]
    },
    "Mistral Cloud Chat Model2": {
      "ai_languageModel": [
        [
          {
            "node": "Clasificador de Tipos1",
            "type": "ai_languageModel",
            "index": 0
          }
        ]
      ]
    },
    "Mistral Cloud Chat Model3": {
      "ai_languageModel": [
        [
          {
            "node": "LLM Chain",
            "type": "ai_languageModel",
            "index": 0
          }
        ]
      ]
    },
    "Mistral Cloud Chat Model4": {
      "ai_languageModel": [
        [
          {
            "node": "Clasificador de Tipo de RFQ y Proveedor",
            "type": "ai_languageModel",
            "index": 0
          }
        ]
      ]
    },
    "If": {
      "main": [
        [
          {
            "node": "Format for Vectorstore",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Clasificador de Tipo de RFQ y Proveedor",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Mistral Cloud Chat Model5": {
      "ai_languageModel": [
        [
          {
            "node": "RAG AI Agent",
            "type": "ai_languageModel",
            "index": 0
          }
        ]
      ]
    }
  },
  "active": true,
  "settings": {
    "executionOrder": "v1",
    "availableInMCP": false
  },
  "versionId": "d9bfa2a1-2f8c-478b-8805-97800a85a989",
  "meta": {
    "templateCredsSetupCompleted": true,
    "instanceId": "53140335eaf11280ef77ef2f5a378f48c2b28e822e3e0d96563cdd92175c0eff"
  },
  "id": "y98b44u828cQkbhm",
  "tags": []
}