# Build stage
FROM node:20-alpine AS build
WORKDIR /app
ARG APP_VERSION=dev
ARG VITE_SUPABASE_URL
ARG VITE_SUPABASE_ANON_KEY
ARG VITE_SUPABASE_SCHEMA
ARG VITE_DEMO_MODE
ARG VITE_N8N_WEBHOOK_URL
ARG VITE_N8N_RFQ_INGESTA_URL
ARG VITE_N8N_CHAT_URL
ARG VITE_N8N_TABLA_URL
ARG VITE_N8N_MAIL_URL
ARG VITE_N8N_QA_AUDIT_URL
ARG VITE_N8N_QA_SEND_TO_SUPPLIER_URL
ARG VITE_N8N_QA_PROCESS_RESPONSES_URL
ARG VITE_N8N_QA_SEND_EMAIL_URL
ARG VITE_N8N_QA_PROCESS_EMAIL_RESPONSE_URL
ARG VITE_N8N_SCORING_URL
ARG VITE_N8N_API_URL
ARG VITE_N8N_API_KEY
ARG VITE_REQUEST_TIMEOUT
ARG VITE_SENTRY_DSN
ENV VITE_APP_VERSION=$APP_VERSION \
    VITE_SUPABASE_URL=$VITE_SUPABASE_URL \
    VITE_SUPABASE_ANON_KEY=$VITE_SUPABASE_ANON_KEY \
    VITE_SUPABASE_SCHEMA=$VITE_SUPABASE_SCHEMA \
    VITE_DEMO_MODE=$VITE_DEMO_MODE \
    VITE_N8N_WEBHOOK_URL=$VITE_N8N_WEBHOOK_URL \
    VITE_N8N_RFQ_INGESTA_URL=$VITE_N8N_RFQ_INGESTA_URL \
    VITE_N8N_CHAT_URL=$VITE_N8N_CHAT_URL \
    VITE_N8N_TABLA_URL=$VITE_N8N_TABLA_URL \
    VITE_N8N_MAIL_URL=$VITE_N8N_MAIL_URL \
    VITE_N8N_QA_AUDIT_URL=$VITE_N8N_QA_AUDIT_URL \
    VITE_N8N_QA_SEND_TO_SUPPLIER_URL=$VITE_N8N_QA_SEND_TO_SUPPLIER_URL \
    VITE_N8N_QA_PROCESS_RESPONSES_URL=$VITE_N8N_QA_PROCESS_RESPONSES_URL \
    VITE_N8N_QA_SEND_EMAIL_URL=$VITE_N8N_QA_SEND_EMAIL_URL \
    VITE_N8N_QA_PROCESS_EMAIL_RESPONSE_URL=$VITE_N8N_QA_PROCESS_EMAIL_RESPONSE_URL \
    VITE_N8N_SCORING_URL=$VITE_N8N_SCORING_URL \
    VITE_N8N_API_URL=$VITE_N8N_API_URL \
    VITE_N8N_API_KEY=$VITE_N8N_API_KEY \
    VITE_REQUEST_TIMEOUT=$VITE_REQUEST_TIMEOUT \
    VITE_SENTRY_DSN=$VITE_SENTRY_DSN
COPY package.json package-lock.json ./
RUN npm ci
COPY . .
# Write .env from build args so Vite can read them during build
RUN printenv | grep ^VITE_ > .env || true
RUN npm run build

# Production stage
FROM nginx:alpine
COPY --from=build /app/dist /usr/share/nginx/html
COPY nginx.conf /etc/nginx/conf.d/default.conf
COPY nginx-rate-limit.conf /etc/nginx/conf.d/rate-limit.conf
EXPOSE 80
CMD ["nginx", "-g", "daemon off;"]
