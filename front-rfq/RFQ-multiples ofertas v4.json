{
  "nodes": [
    {
      "parameters": {
        "httpMethod": "POST",
        "path": "ingesta-rfq",
        "responseMode": "responseNode",
        "options": {}
      },
      "type": "n8n-nodes-base.webhook",
      "typeVersion": 2.1,
      "position": [
        -448,
        2224
      ],
      "id": "38418f63-f5d4-41d7-ad45-34fabd62fc16",
      "name": "Webhook RFQ",
      "webhookId": "bb2ad58d-9bf2-42b0-a26f-5a465c3b0999"
    },
    {
      "parameters": {
        "jsCode": "// =============================================\n// NODO: Format RFQ - Extracci√≥n Segura de Im√°genes\n// =============================================\n\n// 1. OBTENER EL CONTENIDO\n// Accedemos de forma segura a la variable que indicaste\nconst inputData = $input.first().json;\nlet content = \"\";\n\nif (inputData.document && inputData.document.md_content) {\n    content = inputData.document.md_content;\n} else {\n    // Fallback por seguridad si no existe la ruta\n    content = inputData.text || \"\";\n}\n\n// 2. FUNCI√ìN DE LIMPIEZA QUIR√öRGICA\nfunction extractImagesSafely(text) {\n    if (!text) return { cleanText: \"\", images: [] };\n\n    const imagesFound = [];\n    \n    // EXPLICACI√ìN DEL REGEX:\n    // !\\[(.*?)\\]   -> Captura el texto alternativo (ej: \"Figura 1\") en el grupo 1. Es \"lazy\" (.*?) para no comerse texto de m√°s.\n    // \\(           -> Par√©ntesis de apertura literal.\n    // (data:image\\/[^;]+;base64,[^)]+) -> Captura la data Base64 en el grupo 2.\n    //    [^)]+     -> Significa \"todo lo que no sea un par√©ntesis de cierre\". Esto evita que se rompa si hay par√©ntesis dentro del base64 (raro pero posible) y asegura que pare al final de la URL.\n    // \\)           -> Par√©ntesis de cierre literal.\n    // g            -> Global (buscar todas).\n    \n    const regex = /!\\[(.*?)\\]\\((data:image\\/[^;]+;base64,[^)]+)\\)/g;\n\n    const cleanText = text.replace(regex, (match, altText, base64Data) => {\n        // 1. Guardamos la imagen en el array aparte\n        imagesFound.push({\n            alt: altText || \"Sin descripci√≥n\",\n            data: base64Data\n        });\n\n        // 2. RETORNAMOS EL PLACEHOLDER (CR√çTICO PARA NO DESCOLOCAR)\n        // Mantenemos el 'altText' para que el LLM sepa qu√© hab√≠a ah√≠.\n        // Si la imagen estaba dentro de una tabla |...|, esto mantiene la celda ocupada y no rompe la tabla.\n        return ``; \n    });\n\n    return { cleanText, images: imagesFound };\n}\n\n// 3. EJECUTAR\nconst { cleanText, images } = extractImagesSafely(content);\n\n// 4. RECUPERAR METADATOS (Mantenemos tu l√≥gica existente)\nlet fileMeta = { id: \"unknown\", title: \"unknown\" };\ntry {\n    const f = $('Set File ID2').first().json;\n    fileMeta = { id: f.file_id, title: f.file_title };\n} catch(e) {}\n\nlet tipoEval = [\"Technical Evaluation\"];\ntry {\n    const t = $('Clasificador Tipo RFQ').first().json;\n    const out = t.output || t;\n    if (out.tipos_detectados) tipoEval = Array.isArray(out.tipos_detectados) ? out.tipos_detectados : [out.tipos_detectados];\n} catch(e) {}\n\n// 5. OUTPUT\nreturn {\n    json: {\n        text: cleanText,             // El texto mantiene su estructura original\n        images_extracted: images,    // Array de objetos { alt, data }\n        metadata: {\n            file_id: fileMeta.id,\n            file_title: fileMeta.title,\n            tipo_documento: \"RFQ_BASE\",\n            tipo_evaluacion: tipoEval,\n            processed_at: new Date().toISOString(),\n            original_length: content.length,\n            clean_length: cleanText.length,\n            images_count: images.length\n        }\n    }\n};"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        1120,
        2224
      ],
      "id": "16fe6136-46a2-4c4c-a087-c55fbed16eb7",
      "name": "Validar Contenido PDF RFQ"
    },
    {
      "parameters": {
        "jsCode": "// =============================================\n// NODO: Convertir Base64 a Binary Data\n// =============================================\n\nlet inputData;\ntry {\n    inputData = $('Set File ID2').first().json;\n} catch (e) {\n    throw new Error(\"‚ùå No se puede acceder al nodo 'Set File ID1'\");\n}\n\nconst base64Data = inputData.file_binary;\n\nif (!base64Data || base64Data === \"\") {\n    throw new Error(\"‚ùå CR√çTICO: 'file_binary' no existe en 'Set File ID1'.\");\n}\n\nif (typeof base64Data !== 'string') {\n    throw new Error(`‚ùå ERROR: 'file_binary' debe ser string, es ${typeof base64Data}`);\n}\n\nconsole.log(\"‚úÖ file_binary recibido\");\nconsole.log(`   ‚îú‚îÄ Longitud: ${base64Data.length} caracteres`);\nconsole.log(`   ‚îú‚îÄ Archivo: ${inputData.file_title}`);\n\nlet binaryData;\ntry {\n    binaryData = Buffer.from(base64Data, 'base64');\n} catch (e) {\n    throw new Error(`‚ùå ERROR decodificando base64: ${e.message}`);\n}\n\nif (binaryData.length === 0) {\n    throw new Error(\"‚ùå ERROR: Archivo decodificado vac√≠o (0 bytes)\");\n}\n\nconsole.log(`‚úÖ Binary generado: ${binaryData.length} bytes`);\n\nreturn {\n    json: {\n        file_id: inputData.file_id,\n        file_title: inputData.file_title,\n        file_url: inputData.file_url || \"unknown\"\n    },\n    binary: {\n        data: {\n            data: binaryData.toString('base64'),\n            mimeType: 'application/pdf',\n            fileName: inputData.file_title || 'document.pdf',\n            fileSize: binaryData.length\n        }\n    }\n};"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        672,
        2224
      ],
      "id": "0ace77b5-78d1-4fa1-869c-a5fcfae4e40f",
      "name": "Base64 a Binary RFQ"
    },
    {
      "parameters": {
        "jsCode": "// =============================================\n// NODO: Generate Stable ID para RFQ\n// =============================================\n\nfunction simpleHash(str) {\n  let hash = 0;\n  for (let i = 0; i < str.length; i++) {\n    const char = str.charCodeAt(i);\n    hash = ((hash << 5) - hash) + char;\n    hash = hash & hash;\n  }\n  return 'rfq_' + Math.abs(hash).toString(16).padStart(16, '0').substring(0, 16);\n}\n\nconst body = $json.body;\n\nconst originalFileId = body.file_id || \"unknown\";\nconst fileTitle = body.file_title || \"unknown.pdf\";\nconst fileBinary = body.file_binary || \"\";\n\nconst normalizedTitle = fileTitle.toLowerCase().trim();\nconst stableId = simpleHash(normalizedTitle);\n\nconsole.log(\"=== GENERACI√ìN DE ID ESTABLE RFQ ===\");\nconsole.log(`Nombre archivo: ${fileTitle}`);\nconsole.log(`ID ESTABLE generado: ${stableId}`);\n\nreturn {\n  json: {\n    body: {\n      ...body,\n      file_id: stableId,\n      file_id_original: originalFileId\n    }\n  }\n};"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        -224,
        2224
      ],
      "id": "da7e6683-eddc-4646-8e5c-0a36917e63fa",
      "name": "Generate Stable ID RFQ"
    },
    {
      "parameters": {
        "method": "POST",
        "url": "http://docling:5001/v1/convert/file",
        "sendBody": true,
        "contentType": "multipart-form-data",
        "bodyParameters": {
          "parameters": [
            {
              "parameterType": "formBinaryData",
              "name": "files",
              "inputDataFieldName": "data"
            }
          ]
        },
        "options": {
          "timeout": 300000
        }
      },
      "id": "f6f436a1-80aa-4259-9a4b-42d75104f2db",
      "name": "Docling OCR RFQ",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.3,
      "position": [
        896,
        2032
      ],
      "retryOnFail": true
    },
    {
      "parameters": {
        "jsonMode": "expressionData",
        "jsonData": "={{ $json.text }}",
        "options": {
          "metadata": {
            "metadataValues": [
              {
                "name": "file_id",
                "value": "={{ $json.metadata.file_id }}"
              },
              {
                "name": "file_title",
                "value": "={{ $json.metadata.file_title }}"
              },
              {
                "name": "tipo_documento",
                "value": "RFQ_BASE"
              },
              {
                "name": "tipo_evaluacion",
                "value": "={{ $json.metadata.tipo_evaluacion }}"
              }
            ]
          }
        }
      },
      "id": "cc4bfae8-4058-4a80-b288-1c7d00c8d8e2",
      "name": "Default Data Loader RFQ",
      "type": "@n8n/n8n-nodes-langchain.documentDefaultDataLoader",
      "typeVersion": 1,
      "position": [
        2048,
        2448
      ]
    },
    {
      "parameters": {
        "chunkSize": 1500,
        "chunkOverlap": 200,
        "options": {
          "splitCode": "markdown"
        }
      },
      "type": "@n8n/n8n-nodes-langchain.textSplitterRecursiveCharacterTextSplitter",
      "typeVersion": 1,
      "position": [
        2128,
        2656
      ],
      "id": "7c3a0c8f-0ec7-4b62-9693-31b8575cb9a0",
      "name": "Text Splitter RFQ"
    },
    {
      "parameters": {
        "mode": "insert",
        "tableName": {
          "__rl": true,
          "value": "documents_rfq",
          "mode": "list",
          "cachedResultName": "documents_rfq"
        },
        "options": {
          "queryName": "match_documents_rfq"
        }
      },
      "id": "5fb66338-7a3a-44f4-af40-7c189cbbf88c",
      "name": "Insert RFQ Vectorstore",
      "type": "@n8n/n8n-nodes-langchain.vectorStoreSupabase",
      "typeVersion": 1,
      "position": [
        1952,
        2224
      ],
      "credentials": {
        "supabaseApi": {
          "id": "XmXPiDCWkaOfYEXf",
          "name": "Supabase account"
        }
      }
    },
    {
      "parameters": {
        "jsCode": "// =============================================\n// NODO: Format RFQ for Vectorstore\n// =============================================\n\nlet fullText = \"\";\nlet totalPages = 1;\n\ntry {\n    const validarNode = $('Validar Contenido PDF RFQ').first().json;\n    \n    if (validarNode.pages && validarNode.pages[0]) {\n        fullText = validarNode.pages[0].text || \"\";\n    } else {\n        fullText = validarNode.text || \"\";\n    }\n    \n    totalPages = validarNode.totalPages || 1;\n    \n} catch (e) {\n    console.log(\"‚ùå Error leyendo contenido del PDF\");\n    fullText = $input.first().json.text || \"\";\n}\n\nlet tipoEval = [\"Technical Evaluation\"];\n\ntry {\n    const llmData = $('Clasificador Tipo RFQ').first().json;\n    const output = llmData.output || llmData;\n\n    if (output.tipos_detectados) {\n        tipoEval = Array.isArray(output.tipos_detectados) \n            ? output.tipos_detectados \n            : [output.tipos_detectados];\n    }\n} catch (e) {\n    console.log(\"‚ö†Ô∏è No se pudo leer la clasificaci√≥n del LLM, usando defaults.\");\n}\n\nlet fileId = \"unknown\";\nlet fileTitle = \"unknown\";\ntry {\n    const fileNode = $('Set File ID2').first().json;\n    fileId = fileNode.file_id;\n    fileTitle = fileNode.file_title;\n} catch(e) {}\n\nconsole.log(`‚úÖ Procesando RFQ: ${fileTitle}`);\nconsole.log(`   Tipos: ${JSON.stringify(tipoEval)}`);\n\nreturn {\n    json: {\n        text: fullText,\n        metadata: {\n            file_id: fileId,\n            file_title: fileTitle,\n            tipo_documento: \"RFQ_BASE\",\n            tipo_evaluacion: tipoEval,\n            processed_at: new Date().toISOString(),\n            total_pages: totalPages\n        }\n    }\n};"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        1696,
        2224
      ],
      "id": "f4a6c473-0b01-4c97-8075-627409505e38",
      "name": "Format RFQ for Vectorstore"
    },
    {
      "parameters": {
        "model": "nomic-embed-text:latest"
      },
      "type": "@n8n/n8n-nodes-langchain.embeddingsOllama",
      "typeVersion": 1,
      "position": [
        1840,
        2448
      ],
      "id": "88634bdf-86f1-4bec-9b7f-8d08cb6b01f8",
      "name": "Embeddings Ollama RFQ",
      "credentials": {
        "ollamaApi": {
          "id": "Qy5SfLiSYwx3Okjy",
          "name": "Ollama account"
        }
      }
    },
    {
      "parameters": {
        "batchSize": 50,
        "options": {
          "reset": "={{ $json.reiniciar_bucle ? true : false }}"
        }
      },
      "type": "n8n-nodes-base.splitInBatches",
      "typeVersion": 3,
      "position": [
        3312,
        2304
      ],
      "id": "2a3b62f8-8ca0-4929-bdea-13b72a570c33",
      "name": "Loop Over Items RFQ"
    },
    {
      "parameters": {
        "jsCode": "// =============================================\n// NODO: Preparar Items para Extracci√≥n RFQ\n// =============================================\n\nconst items = $input.all();\n\nconst listaParaLLM = items.map(i => ({\n    id: i.json.id,\n    descripcion_item: i.json.descripcion_item,\n    fase: i.json.fase,\n    tipo_evaluacion: i.json.Evaluation\n}));\n\nreturn {\n    json: {\n        lista_items_json: JSON.stringify(listaParaLLM),\n        batch_size: items.length\n    }\n};"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        3536,
        2176
      ],
      "id": "34cd7ad5-4eb2-433a-a807-d494bbcc9376",
      "name": "Preparar Items para LLM"
    },
    {
      "parameters": {
        "jsCode": "// =============================================\n// NODO: Parsear Requisitos RFQ y Preparar Update\n// =============================================\n\nconst llmOutput = $input.first().json.text || $input.first().json.content || \"[]\";\nlet parsedData = [];\n\ntry {\n  let cleanOutput = llmOutput\n    .replace(/```json/gi, '')\n    .replace(/```/g, '')\n    .trim();\n  \n  const firstBracket = cleanOutput.indexOf('[');\n  const lastBracket = cleanOutput.lastIndexOf(']');\n  \n  if (firstBracket !== -1 && lastBracket !== -1) {\n    const jsonString = cleanOutput.substring(firstBracket, lastBracket + 1);\n    parsedData = JSON.parse(jsonString);\n  }\n} catch (e) {\n  console.log(\"‚ö†Ô∏è Error parseando JSON del LLM:\", e.message);\n}\n\nlet originalItems = [];\ntry {\n    originalItems = JSON.parse($('Preparar Items para LLM').first().json.lista_items_json);\n} catch (e) {\n    throw new Error(\"No se pudo recuperar la lista original de √≠tems\");\n}\n\nconsole.log(`üìã Procesando ${originalItems.length} √≠tems`);\nconsole.log(`üìã LLM devolvi√≥ ${parsedData.length} √≠tems`);\n\nreturn originalItems.map(originalItem => {\n    const found = parsedData.find(p => p.id === originalItem.id);\n    \n    let rfqRequisito = \"NO ESPECIFICADO EN RFQ\";\n    \n    if (found && found.rfq_requisito) {\n        rfqRequisito = found.rfq_requisito;\n        \n        if (found.referencia) {\n            rfqRequisito += ` | Ref: ${found.referencia}`;\n        }\n    }\n\n    return {\n        json: {\n            id: originalItem.id,\n            rfq_requisito: rfqRequisito\n        }\n    };\n});"
      },
      "id": "80c3c567-9442-4e68-b21f-b50eac241151",
      "name": "Parsear Requisitos RFQ",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        4112,
        2176
      ]
    },
    {
      "parameters": {
        "promptType": "define",
        "text": "=### CONTEXTO DEL DOCUMENTO RFQ\n\nTipo de Evaluaci√≥n: {{ $('Expandir por Tipo RFQ').first().json.tipo_evaluacion_actual }}\n\nTexto del documento RFQ:\n{{ $('Expandir por Tipo RFQ').first().json.texto_rfq_completo }}\n\n---\n### ITEMS PARA EXTRAER REQUISITOS:\n{{ $json.lista_items_json }}\n",
        "messages": {
          "messageValues": [
            {
              "message": "=# ERES UN EXTRACTOR DE REQUISITOS DE RFQ (Request for Quotation)\n\n## TU OBJETIVO\nAnalizar el documento RFQ y extraer los REQUISITOS ESPEC√çFICOS que el cliente solicita para cada √≠tem.\nEstos requisitos ser√°n usados posteriormente para comparar contra las ofertas de proveedores.\nDebes responder siempre en castellano.\n\n---\n\n## MODOS DE EXTRACCI√ìN\n\nDebes elegir UN SOLO MODO basado en la variable \"tipo_evaluacion_actual\". \n\n---\n\n### MODO A: REQUISITOS ECON√ìMICOS\n**CONDICI√ìN:** tipo_evaluacion_actual = \"Economical Evaluation\"\n\n**EXTRAER para cada √≠tem:**\n1. Unidad de medida requerida (horas, m¬≤, kg, lump sum, etc.)\n2. Cantidad estimada (si se especifica)\n3. Formato de cotizaci√≥n esperado (precio unitario, precio global, tarifa horaria)\n4. Condiciones comerciales (t√©rminos de pago, garant√≠as, penalizaciones)\n5. Moneda requerida (EUR, USD, etc.)\n\n**FORMATO de rfq_requisito:**\n\"[Unidad]: [Cantidad si aplica] | Formato: [Tipo de cotizaci√≥n] | Condiciones: [Especiales]\"\n\n**Ejemplos:**\n- \"Lump Sum | Desglosar por fase Pre-FEED/FEED | Incluir backup horas-hombre | Moneda: EUR\"\n- \"Tarifa horaria | Categor√≠as: Ing. Senior, Ing. Junior, T√©cnico | M√≠nimo 500 horas\"\n- \"Precio unitario por m¬≤ | Cantidad estimada: 15.000 m¬≤ | Incluir transporte\"\n\n---\n\n### MODO B: REQUISITOS T√âCNICOS\n**CONDICI√ìN:** tipo_evaluacion_actual = \"Technical Evaluation\"\n\n**EXTRAER para cada √≠tem:**\n1. Especificaciones t√©cnicas m√≠nimas exigidas\n2. Normativas aplicables (ASME, API, ISO, UNE, etc.)\n3. Criterios de aceptaci√≥n\n4. Metodolog√≠a requerida\n5. Exclusiones expl√≠citas mencionadas\n\n**FORMATO de rfq_requisito:**\n\"[Especificaci√≥n t√©cnica] | Norma: [Normativas] | Criterio: [Aceptaci√≥n] | M√©todo: [Si aplica]\"\n\n**Ejemplos:**\n- \"Di√°metros 2\"-24\", P&IDs completos, isom√©tricos | Norma: ASME B31.3, API 570 | Criterio: Aprobaci√≥n cliente antes de fabricaci√≥n\"\n- \"An√°lisis s√≠smico zona 4, factor importancia 1.5 | Norma: NCSE-02, Euroc√≥digo 8 | Criterio: Drift m√°ximo 0.5%\"\n- \"Estudio geot√©cnico con 10 sondeos SPT m√≠nimo | Norma: UNE-EN ISO 22476 | Profundidad: 30m m√≠nimo\"\n\n---\n\n### MODO C: REQUISITOS DE DELIVERABLES (Pre-FEED / FEED)\n**CONDICI√ìN:** tipo_evaluacion_actual IN (\"Pre-FEED Deliverables\", \"FEED Deliverables\")\n\n**EXTRAER para cada √≠tem:**\n1. C√≥digo de documento esperado (si existe en RFQ)\n2. Formato de entrega exigido (PDF, DWG, nativos, etc.)\n3. Nivel de detalle esperado\n4. N√∫mero de revisiones incluidas\n5. Plazo de entrega (si se especifica)\n\n**FORMATO de rfq_requisito:**\n\"C√≥digo: [Si existe] | Formato: [Tipos] | Detalle: [Nivel] | Revisiones: [Cantidad] | Plazo: [Semanas/D√≠as]\"\n\n**Ejemplos:**\n- \"C√≥digo: PID-XXX | Formato: DWG + PDF firmado | Detalle: Para construcci√≥n | Revisiones: 3 incluidas | Plazo: Semana 8\"\n- \"Formato: Excel nativo + PDF | Detalle: Nivel AFE (-15%) | Revisiones: 2 incluidas\"\n- \"C√≥digo: MDR-FEED-001 | Formato: PDF controlado | Actualizaci√≥n: Semanal\"\n\n---\n\n## REGLAS DE EXTRACCI√ìN\n\n### SI EL REQUISITO EXISTE EN LA RFQ:\n- Extrae TODA la informaci√≥n relevante\n- S√© espec√≠fico con n√∫meros, normas y condiciones\n- Incluye la referencia: \"Ref: Secci√≥n X, P√°g Y, Tabla Z\"\n\n### SI EL √çTEM APARECE PERO SIN REQUISITOS ESPEC√çFICOS:\n- rfq_requisito: \"MENCIONADO SIN ESPECIFICACI√ìN - [Contexto donde aparece]\"\n\n### SI EL √çTEM NO EST√Å EN LA RFQ:\n- rfq_requisito: \"NO ESPECIFICADO EN RFQ\"\n- NO inventes requisitos\n\n### SI LA INFORMACI√ìN ES PARCIAL:\n- Extrae lo disponible\n- Indica qu√© falta: \"Pendiente definir: [aspecto]\"\n\n---\n\n## PROTOCOLO ANTI-ALUCINACI√ìN\n\nANTES de escribir cualquier requisito, verifica:\n1. ¬øVeo este texto EXACTO en el documento RFQ?\n2. ¬øPuedo citar la frase original?\n3. ¬øEl requisito est√° claramente asociado a este √≠tem?\n\n**SI LA RESPUESTA ES NO A CUALQUIERA:** Usar \"NO ESPECIFICADO EN RFQ\"\n\n**NUNCA:**\n- Inventar normativas que no aparezcan\n- Asumir cantidades no especificadas\n- Inferir requisitos de √≠tems similares\n- Copiar requisitos gen√©ricos si no est√°n expl√≠citos\n\n---\n\n## FORMATO DE SALIDA (JSON)\n\n```json\n[\n  {\n    \"id\": 101,\n    \"rfq_requisito\": \"Lump Sum | Desglosar Pre-FEED y FEED | Backup horas-hombre obligatorio | Moneda: EUR\",\n    \"referencia\": \"Secci√≥n 4.2, Tabla de Precios, P√°g 15\"\n  },\n  {\n    \"id\": 102,\n    \"rfq_requisito\": \"NO ESPECIFICADO EN RFQ\",\n    \"referencia\": null\n  },\n  {\n    \"id\": 103,\n    \"rfq_requisito\": \"MENCIONADO SIN ESPECIFICACI√ìN - Aparece en alcance general sin detalle\",\n    \"referencia\": \"Secci√≥n 2.1, P√°g 8\"\n  }\n]\n```\n\n---\n\n## REGLA ABSOLUTA: PROCESAR TODOS LOS √çTEMS\n\n**CR√çTICO:** El JSON de salida DEBE contener EXACTAMENTE el mismo n√∫mero de √≠tems que recibiste.\n\n**VERIFICACI√ìN FINAL:**\n1. Cuenta √≠tems de entrada\n2. Cuenta √≠tems de salida\n3. Si no coinciden ‚Üí REVISA y completa\n\n---\n\n## INSTRUCCIONES DE EJECUCI√ìN\n\n1. LEE el documento RFQ completo\n2. IDENTIFICA el modo (Econ√≥mico, T√©cnico, Deliverables)\n3. Para CADA √≠tem:\n   a. BUSCA menciones en el texto\n   b. EXTRAE requisitos espec√≠ficos si existen\n   c. APLICA el protocolo anti-alucinaci√≥n\n   d. NUNCA omitas el √≠tem del JSON\n4. VERIFICA que el conteo de salida coincida con entrada\n5. FORMATEA como JSON v√°lido\n\n**IMPORTANTE:** Estos requisitos se usar√°n para evaluar ofertas de proveedores. La precisi√≥n es CR√çTICA. Es mejor decir \"NO ESPECIFICADO\" que inventar."
            }
          ]
        },
        "batching": {}
      },
      "type": "@n8n/n8n-nodes-langchain.chainLlm",
      "typeVersion": 1.7,
      "position": [
        3760,
        2176
      ],
      "id": "eb661d86-8ddd-415b-91bb-3dc4b7f7284a",
      "name": "LLM Extractor Requisitos RFQ"
    },
    {
      "parameters": {
        "operation": "get",
        "dataTableId": {
          "__rl": true,
          "value": "jIatxsggJ92wzApV",
          "mode": "list",
          "cachedResultName": "Prueba",
          "cachedResultUrl": "/projects/vcLkFgTx7CPaMMKV/datatables/jIatxsggJ92wzApV"
        },
        "filters": {
          "conditions": [
            {
              "keyName": "Evaluation",
              "keyValue": "={{ $json.tipo_evaluacion_actual }}"
            }
          ]
        },
        "returnAll": true
      },
      "type": "n8n-nodes-base.dataTable",
      "typeVersion": 1,
      "position": [
        2864,
        2224
      ],
      "id": "02169b3c-5745-47d6-a6eb-32a154ab710c",
      "name": "Get Items por Tipo"
    },
    {
      "parameters": {
        "jsCode": "// =============================================\n// NODO: Expandir por Tipo de Evaluaci√≥n RFQ\n// =============================================\n\nlet sourceData = {};\ntry {\n    sourceData = $('Format RFQ for Vectorstore').first().json;\n} catch (e) {\n    console.log(\"‚ùå Error: No se encuentra 'Format RFQ for Vectorstore'\");\n    sourceData = $input.first().json; \n}\n\nconst fullText = sourceData.text || \"‚ö†Ô∏è ERROR: Texto vac√≠o\";\nconst metadata = sourceData.metadata || {};\n\nlet tipos = metadata.tipo_evaluacion;\n\nif (!tipos) {\n    tipos = [\"Technical Evaluation\"];\n}\n\nif (!Array.isArray(tipos)) {\n    if (typeof tipos === 'string') {\n        const cleanString = tipos.replace(/[\\[\\]\"]/g, ''); \n        if (cleanString.includes(',')) {\n            tipos = cleanString.split(',').map(t => t.trim());\n        } else {\n            tipos = [cleanString.trim()];\n        }\n    } else {\n        tipos = [tipos];\n    }\n}\n\nconsole.log(`üîÄ Procesando RFQ: ${metadata.file_title}`);\nconsole.log(`   Tipos detectados: ${JSON.stringify(tipos)}`);\n\nreturn tipos.map((tipo, idx) => ({\n    json: {\n        tipo_evaluacion_actual: tipo, \n        texto_rfq_completo: fullText,\n        file_title: metadata.file_title,\n        file_id: metadata.file_id,\n        es_hibrido: tipos.length > 1,\n        indice_actual: idx + 1,\n        total_tipos: tipos.length\n    }\n}));"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        2416,
        2224
      ],
      "id": "0f796b60-8354-45b0-bdce-44cca0e2eb7b",
      "name": "Expandir por Tipo RFQ"
    },
    {
      "parameters": {
        "options": {}
      },
      "type": "n8n-nodes-base.splitInBatches",
      "typeVersion": 3,
      "position": [
        2640,
        2224
      ],
      "id": "9bf3fcce-6857-4eaa-b1a8-4ecf8e07d43a",
      "name": "Loop Tipos RFQ"
    },
    {
      "parameters": {
        "jsCode": "const items = $input.all();\n\nreturn items.map(item => ({\n    json: {\n        ...item.json,\n        reiniciar_bucle: true \n    }\n}));\n"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        3088,
        2224
      ],
      "id": "11482730-2e44-44ba-825e-07a0bf311e8c",
      "name": "Reset Items RFQ"
    },
    {
      "parameters": {
        "options": {
          "temperature": 0
        }
      },
      "type": "@n8n/n8n-nodes-langchain.lmChatOpenRouter",
      "typeVersion": 1,
      "position": [
        3904,
        2336
      ],
      "id": "7f3feb3e-a460-48bb-9400-2904cd6ced13",
      "name": "OpenRouter Chat Model RFQ",
      "credentials": {
        "openRouterApi": {
          "id": "qDD6QT1T2s8YMdby",
          "name": "OpenRouter account"
        }
      }
    },
    {
      "parameters": {
        "operation": "update",
        "dataTableId": {
          "__rl": true,
          "value": "jIatxsggJ92wzApV",
          "mode": "list",
          "cachedResultName": "Prueba",
          "cachedResultUrl": "/projects/vcLkFgTx7CPaMMKV/datatables/jIatxsggJ92wzApV"
        },
        "filters": {
          "conditions": [
            {
              "keyValue": "={{ $json.id }}"
            }
          ]
        },
        "columns": {
          "mappingMode": "defineBelow",
          "value": {
            "rfq_requisito": "={{ $json.rfq_requisito }}"
          },
          "matchingColumns": [
            "id"
          ],
          "schema": [
            {
              "id": "Evaluation",
              "displayName": "Evaluation",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "readOnly": false,
              "removed": true
            },
            {
              "id": "fase",
              "displayName": "fase",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "readOnly": false,
              "removed": true
            },
            {
              "id": "descripcion_item",
              "displayName": "descripcion_item",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "readOnly": false,
              "removed": true
            },
            {
              "id": "rfq_requisito",
              "displayName": "rfq_requisito",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "readOnly": false,
              "removed": false
            },
            {
              "id": "IDOM",
              "displayName": "IDOM",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "readOnly": false,
              "removed": true
            },
            {
              "id": "TECNICASREUNIDAS",
              "displayName": "TECNICASREUNIDAS",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "readOnly": false,
              "removed": true
            },
            {
              "id": "SACYR",
              "displayName": "SACYR",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "readOnly": false,
              "removed": true
            },
            {
              "id": "EA",
              "displayName": "EA",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "readOnly": false,
              "removed": true
            },
            {
              "id": "SENER",
              "displayName": "SENER",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "readOnly": false,
              "removed": true
            },
            {
              "id": "TRESCA",
              "displayName": "TRESCA",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "readOnly": false,
              "removed": true
            },
            {
              "id": "WORLEY",
              "displayName": "WORLEY",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "readOnly": false,
              "removed": true
            }
          ],
          "attemptToConvertTypes": false,
          "convertFieldsToString": false
        },
        "options": {}
      },
      "type": "n8n-nodes-base.dataTable",
      "typeVersion": 1.1,
      "position": [
        4336,
        2304
      ],
      "id": "194274ac-5a31-40bc-a0cc-303f557d6cc2",
      "name": "Update rfq_requisito"
    },
    {
      "parameters": {
        "schemaType": "manual",
        "inputSchema": "{\n  \"type\": \"object\",\n  \"properties\": {\n    \"tipos_detectados\": {\n      \"type\": \"array\",\n      \"items\": {\n        \"type\": \"string\",\n        \"enum\": [\n          \"Technical Evaluation\",\n          \"Economical Evaluation\",\n          \"Pre-FEED Deliverables\",\n          \"FEED Deliverables\"\n        ]\n      },\n      \"description\": \"Lista de tipos de evaluaci√≥n detectados en el documento RFQ.\"\n    },\n    \"razonamiento\": {\n      \"type\": \"string\",\n      \"description\": \"Breve explicaci√≥n de por qu√© se eligieron esos tipos.\"\n    }\n  },\n  \"required\": [\n    \"tipos_detectados\"\n  ]\n}"
      },
      "type": "@n8n/n8n-nodes-langchain.outputParserStructured",
      "typeVersion": 1.3,
      "position": [
        1520,
        2448
      ],
      "id": "461e9a45-2230-42b7-901f-8be470166e8d",
      "name": "Structured Output Parser RFQ"
    },
    {
      "parameters": {
        "promptType": "define",
        "text": "=### INPUT A ANALIZAR\nNombre archivo: {{ $json.fileName }}{{ $json.metadata.file_title }}\nTexto (Inicio del documento): \n{{ $json.pages[0].text }}{{ $json.text }}",
        "hasOutputParser": true,
        "messages": {
          "messageValues": [
            {
              "message": "=### TAREA: CLASIFICACI√ìN DE DOCUMENTO RFQ BASE\n\nEres un auditor senior de documentaci√≥n de ingenier√≠a.\nEste documento es una RFQ (Request for Quotation) emitida por el CLIENTE.\nPara clasificar, es muy importante fijarse en el titulo del archivo y en las primeras lineas.\n\n---\n\n## TU OBJETIVO\n\nIdentificar qu√© TIPOS DE REQUISITOS contiene esta RFQ para saber qu√© columnas de la tabla deben poblarse.\n\n---\n\n## TIPOS POSIBLES\n\n### 1. \"Technical Evaluation\"\nLa RFQ contiene requisitos t√©cnicos como:\n- Especificaciones de ingenier√≠a\n- Normativas aplicables (ASME, API, ISO, etc.)\n- Metodolog√≠as requeridas\n- Alcance t√©cnico del trabajo\n- Criterios de aceptaci√≥n t√©cnica\n\n### 2. \"Economical Evaluation\"\nLa RFQ contiene requisitos econ√≥micos como:\n- Formato de cotizaci√≥n esperado\n- Desglose de precios requerido\n- Condiciones de pago\n- Moneda de cotizaci√≥n\n- Estructura de costos esperada\n\n### 3. \"Pre-FEED Deliverables\"\nLa RFQ solicita entregables de fase Pre-FEED:\n- Lista de documentos a entregar en Pre-FEED\n- Matriz de entregables conceptuales\n- Requisitos de formato y revisiones\n\n### 4. \"FEED Deliverables\"\nLa RFQ solicita entregables de fase FEED:\n- Lista de documentos a entregar en FEED\n- Matriz de entregables de ingenier√≠a b√°sica\n- Requisitos de formato y revisiones\n\n---\n\n## REGLAS\n\n1. Una RFQ t√≠picamente contiene M√öLTIPLES tipos (ej: Technical + Economical)\n2. Marca todos los tipos que apliquen\n3. Si hay duda, incluye el tipo (es mejor tener m√°s cobertura)\n4. Si no hay evidencia clara de un tipo, no lo incluyas\n\n---\n\n## FORMATO DE SALIDA\n\n```json\n{\n  \"tipos_detectados\": [\"Technical Evaluation\", \"Economical Evaluation\"],\n  \"razonamiento\": \"La RFQ incluye secci√≥n de especificaciones t√©cnicas (Secci√≥n 3) con normativas ASME y API, y secci√≥n de formato de cotizaci√≥n (Secci√≥n 5) con desglose de precios requerido.\"\n}\n```"
            }
          ]
        },
        "batching": {}
      },
      "type": "@n8n/n8n-nodes-langchain.chainLlm",
      "typeVersion": 1.8,
      "position": [
        1344,
        2224
      ],
      "id": "806eceea-7e51-4b43-a3f2-5f86f8e0b2e8",
      "name": "Clasificador Tipo RFQ"
    },
    {
      "parameters": {
        "model": "devstral-latest",
        "options": {
          "temperature": 0.1
        }
      },
      "type": "@n8n/n8n-nodes-langchain.lmChatMistralCloud",
      "typeVersion": 1,
      "position": [
        1328,
        2448
      ],
      "id": "61467fa0-08e2-430a-aba8-c5536846e97b",
      "name": "Mistral Cloud RFQ",
      "credentials": {
        "mistralCloudApi": {
          "id": "tYcsXUVtTWeJIEDg",
          "name": "Mistral Cloud account"
        }
      }
    },
    {
      "parameters": {
        "respondWith": "text",
        "responseBody": "={\"success\": true, \"message\": \"RFQ procesada correctamente\", \"file_id\": \"{{ $('Set File ID2').first().json.file_id }}\", \"tipos_procesados\": {{ JSON.stringify($('Clasificador Tipo RFQ').first().json.output.tipos_detectados) }} }",
        "options": {}
      },
      "type": "n8n-nodes-base.respondToWebhook",
      "typeVersion": 1.5,
      "position": [
        2864,
        2032
      ],
      "id": "0bd21a1d-6b96-4738-b3cc-0dfe706ab665",
      "name": "Respond Webhook RFQ"
    },
    {
      "parameters": {
        "operation": "upsert",
        "schema": {
          "__rl": true,
          "mode": "list",
          "value": "public"
        },
        "table": {
          "__rl": true,
          "value": "document_metadata",
          "mode": "list",
          "cachedResultName": "document_metadata"
        },
        "columns": {
          "mappingMode": "defineBelow",
          "value": {
            "id": "={{ $('Set File ID2').item.json.file_id }}",
            "title": "={{ $('Set File ID2').item.json.file_title }}",
            "url": "={{ $('Set File ID2').item.json.file_url }}"
          },
          "matchingColumns": [
            "id"
          ],
          "schema": [
            {
              "id": "id",
              "displayName": "id",
              "required": true,
              "defaultMatch": true,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            },
            {
              "id": "title",
              "displayName": "title",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": false
            },
            {
              "id": "url",
              "displayName": "url",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": false
            },
            {
              "id": "created_at",
              "displayName": "created_at",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "dateTime",
              "canBeUsedToMatch": false,
              "removed": false
            },
            {
              "id": "schema",
              "displayName": "schema",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": false,
              "removed": false
            }
          ],
          "attemptToConvertTypes": false,
          "convertFieldsToString": false
        },
        "options": {}
      },
      "type": "n8n-nodes-base.postgres",
      "typeVersion": 2.5,
      "position": [
        448,
        2224
      ],
      "id": "b2612f64-f181-419a-b402-e92596847f54",
      "name": "Insert Document Metadata2",
      "executeOnce": true,
      "credentials": {
        "postgres": {
          "id": "BNCttvQcKbXFj6nd",
          "name": "Postgres account"
        }
      }
    },
    {
      "parameters": {
        "operation": "delete",
        "tableId": "documents_rfq",
        "filterType": "string",
        "filterString": "=metadata->>file_id=like.*{{ $json.file_id }}*"
      },
      "id": "41be1faf-2aae-4394-bbb8-59148e00892a",
      "name": "Delete Old Doc Rows2",
      "type": "n8n-nodes-base.supabase",
      "typeVersion": 1,
      "position": [
        224,
        2224
      ],
      "alwaysOutputData": true,
      "credentials": {
        "supabaseApi": {
          "id": "XmXPiDCWkaOfYEXf",
          "name": "Supabase account"
        }
      }
    },
    {
      "parameters": {
        "assignments": {
          "assignments": [
            {
              "id": "10646eae-ae46-4327-a4dc-9987c2d76173",
              "name": "file_id",
              "value": "={{ $json.body.file_id }}",
              "type": "string"
            },
            {
              "id": "77d782de-169d-4a46-8a8e-a3831c04d90f",
              "name": "file_title",
              "value": "={{ $json.body.file_title }}",
              "type": "string"
            },
            {
              "id": "b1dbe9b9-248a-4593-a769-a085b34e0810",
              "name": "file_binary",
              "value": "={{ $json.body.file_binary }}",
              "type": "string"
            },
            {
              "id": "74d93dce-cddc-4947-ae19-88bc5cacd146",
              "name": "file_metadata",
              "value": "={{ $json.body.metadata }}",
              "type": "string"
            }
          ]
        },
        "options": {}
      },
      "id": "5fc94a32-aa83-42af-a549-ed9f1e6afa9d",
      "name": "Set File ID2",
      "type": "n8n-nodes-base.set",
      "typeVersion": 3.4,
      "position": [
        0,
        2224
      ]
    },
    {
      "parameters": {
        "content": "### Ingesta de RFQ, actualizaci√≥n de requisitos",
        "height": 1120,
        "width": 5152,
        "color": 4
      },
      "type": "n8n-nodes-base.stickyNote",
      "typeVersion": 1,
      "position": [
        -512,
        1760
      ],
      "id": "7ca104ed-da6f-42fb-bf5e-633fe3f5ca82",
      "name": "Sticky Note"
    },
    {
      "parameters": {
        "content": "### Ingesta de RFQ, actualizaci√≥n de requisitos",
        "height": 1776,
        "width": 5152,
        "color": 5
      },
      "type": "n8n-nodes-base.stickyNote",
      "typeVersion": 1,
      "position": [
        -512,
        -288
      ],
      "id": "e48a0b0c-058d-4828-85cd-ebe1640bb1f2",
      "name": "Sticky Note5"
    },
    {
      "parameters": {
        "batchSize": 50,
        "options": {
          "reset": "={{ $json.reiniciar_bucle ? true : false }}"
        }
      },
      "type": "n8n-nodes-base.splitInBatches",
      "typeVersion": 3,
      "position": [
        1280,
        112
      ],
      "id": "35cdcefb-5311-4444-b589-3960a176d8a3",
      "name": "Loop Over Items"
    },
    {
      "parameters": {
        "numberInputs": 7
      },
      "type": "n8n-nodes-base.merge",
      "typeVersion": 3.2,
      "position": [
        4336,
        256
      ],
      "id": "d2732ddf-357a-42ff-949b-89cf161db9ed",
      "name": "Merge"
    },
    {
      "parameters": {
        "jsCode": "// Tomamos los √≠tems del lote actual (ej. 15 filas)\nconst items = $input.all();\n\n// Creamos la lista limpia solo con ID y Descripci√≥n para ahorrar tokens\nconst listaParaLLM = items.map(i => ({\n    id: i.json.id,\n    item: i.json.descripcion_item,\n    fase: i.json.fase,\n    rfq_requisito: i.json.rfq_requisito || \"NO ESPECIFICADO EN RFQ\"\n}));\n\n// Devolvemos UN SOLO √çTEM que contiene la lista stringificada.\n// Esto obliga al nodo LLM a ejecutarse UNA vez por cada lote de 15.\nreturn {\n    json: {\n        lista_items_json: JSON.stringify(listaParaLLM),\n        batch_size: items.length\n    }\n};"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        1584,
        112
      ],
      "id": "a19ea720-285b-4e2b-9772-8f7011925d64",
      "name": "Code in JavaScript"
    },
    {
      "parameters": {},
      "id": "2296b3ff-af96-485b-b4f5-efb9b62e00b3",
      "name": "Postgres Chat Memory",
      "type": "@n8n/n8n-nodes-langchain.memoryPostgresChat",
      "typeVersion": 1,
      "position": [
        -1824,
        336
      ],
      "notesInFlow": false,
      "credentials": {
        "postgres": {
          "id": "BNCttvQcKbXFj6nd",
          "name": "Postgres account"
        }
      }
    },
    {
      "parameters": {
        "public": true,
        "mode": "webhook",
        "options": {}
      },
      "id": "8fe4fd02-0a03-4294-be7c-d69b1da24cf5",
      "name": "When chat message received",
      "type": "@n8n/n8n-nodes-langchain.chatTrigger",
      "typeVersion": 1.1,
      "position": [
        -2176,
        16
      ],
      "webhookId": "072a6322-4bb1-444b-bd82-5c1df6db623f"
    },
    {
      "parameters": {
        "options": {
          "systemMessage": "=Eres un Asistente T√©cnico de Compras experto en Licitaciones (RFQ).\nTu objetivo es ayudar al usuario a comparar requisitos t√©cnicos contra las ofertas de los proveedores, bas√°ndote en dos fuentes de verdad.\n\n### TUS HERRAMIENTAS:\n1. `consultar_ofertas` (Vector Store): √ösala para leer el TEXTO ORIGINAL de los PDFs. Sirve para encontrar detalles, matices t√©cnicos y contexto que no cabe en una tabla.\n2. `consultar_tabla_evaluacion` (Structured Data): √ösala para ver el RESUMEN FINAL. Aqu√≠ est√°n los precios exactos detectados, los \"NO INCLUIDO\" y la comparaci√≥n directa √≠tem por √≠tem.\n\n### PROTOCOLO DE RESPUESTA (Sigue este orden):\n\nCASO A: El usuario pregunta datos concretos (Precios, Cumplimiento, Status)\n1. Usa `consultar_tabla_evaluacion` primero.\n2. Si encuentras el dato (ej: \"Sacyr: 50.000 EUR\"), responde directamente.\n3. Si el dato en la tabla es ambiguo o nulo, usa `consultar_ofertas` para investigar en el documento original por qu√© no se encontr√≥.\n\nCASO B: El usuario pregunta detalles t√©cnicos o descripciones (Contexto)\n1. Usa `consultar_ofertas` directamente para extraer p√°rrafos del manual o propuesta t√©cnica.\n\nCASO C: An√°lisis de Brechas (Gap Analysis)\n1. Obt√©n el estado de `consultar_tabla_evaluacion`.\n2. Contrasta con la evidencia de `consultar_ofertas`.\n3. Genera una respuesta tipo: \"En la tabla figura como INCLUIDO, y seg√∫n el documento t√©cnico (P√°g 45), se detalla el uso de bombas centr√≠fugas...\"\n\n### REGLAS:\n- Si la tabla dice \"SIN VALORAR\" o \"NO COTIZADO\", inf√≥rmalo tal cual.\n- Cita siempre la fuente: \"(Fuente: Tabla de Evaluaci√≥n)\" o \"(Fuente: Documento PDF de IDOM)\".\n- S√© conciso y t√©cnico.\n- La respuesta debe ser en formato texto."
        }
      },
      "id": "64d0a9ed-7f5e-49ab-9d7b-51d0984eb070",
      "name": "RAG AI Agent",
      "type": "@n8n/n8n-nodes-langchain.agent",
      "typeVersion": 1.6,
      "position": [
        -1648,
        112
      ]
    },
    {
      "parameters": {
        "descriptionType": "manual",
        "toolDescription": "Use this tool to fetch all available documents, including the table schema if the file is a CSV or Excel file.",
        "operation": "select",
        "schema": {
          "__rl": true,
          "mode": "list",
          "value": "public"
        },
        "table": {
          "__rl": true,
          "value": "document_metadata",
          "mode": "list",
          "cachedResultName": "document_metadata"
        },
        "returnAll": true,
        "options": {}
      },
      "type": "n8n-nodes-base.postgresTool",
      "typeVersion": 2.5,
      "position": [
        -1696,
        336
      ],
      "id": "f66d5c5d-1a1b-44dc-8789-27eb9af1bbe5",
      "name": "List Documents",
      "credentials": {
        "postgres": {
          "id": "BNCttvQcKbXFj6nd",
          "name": "Postgres account"
        }
      }
    },
    {
      "parameters": {
        "descriptionType": "manual",
        "toolDescription": "Given a file ID, fetches the text from the document.",
        "operation": "executeQuery",
        "query": "SELECT \n    string_agg(content, ' ') as document_text\nFROM documents\n  WHERE metadata->>'file_id' = $1\nGROUP BY metadata->>'file_id';",
        "options": {
          "queryReplacement": "={{ $fromAI('file_id') }}"
        }
      },
      "type": "n8n-nodes-base.postgresTool",
      "typeVersion": 2.5,
      "position": [
        -1568,
        336
      ],
      "id": "5c0c465d-4b91-4064-9abd-e028a0a514a3",
      "name": "Get File Contents",
      "credentials": {
        "postgres": {
          "id": "BNCttvQcKbXFj6nd",
          "name": "Postgres account"
        }
      }
    },
    {
      "parameters": {
        "descriptionType": "manual",
        "toolDescription": "Run a SQL query - use this to query from the document_rows table once you know the file ID you are querying. dataset_id is the file_id and you are always using the row_data for filtering, which is a jsonb field that has all the keys from the file schema given in the document_metadata table.\n\nExample query:\n\nSELECT AVG((row_data->>'revenue')::numeric)\nFROM document_rows\nWHERE dataset_id = '123';\n\nExample query 2:\n\nSELECT \n    row_data->>'category' as category,\n    SUM((row_data->>'sales')::numeric) as total_sales\nFROM dataset_rows\nWHERE dataset_id = '123'\nGROUP BY row_data->>'category';",
        "operation": "executeQuery",
        "query": "{{ $fromAI('sql_query') }}",
        "options": {}
      },
      "type": "n8n-nodes-base.postgresTool",
      "typeVersion": 2.5,
      "position": [
        -1440,
        336
      ],
      "id": "34e10699-30c0-41dc-a89a-b6c1ca5bfccb",
      "name": "Query Document Rows",
      "credentials": {
        "postgres": {
          "id": "BNCttvQcKbXFj6nd",
          "name": "Postgres account"
        }
      }
    },
    {
      "parameters": {
        "options": {
          "maxTokens": 2048
        }
      },
      "type": "@n8n/n8n-nodes-langchain.lmChatOpenRouter",
      "typeVersion": 1,
      "position": [
        -1952,
        336
      ],
      "id": "c06c69dc-fdce-4417-aa5f-a8c24c5a67bd",
      "name": "OpenRouter Chat Model",
      "credentials": {
        "openRouterApi": {
          "id": "qDD6QT1T2s8YMdby",
          "name": "OpenRouter account"
        }
      }
    },
    {
      "parameters": {
        "mode": "retrieve-as-tool",
        "toolName": "documents",
        "toolDescription": "Use RAG to look up information in the knowledgebase.",
        "tableName": {
          "__rl": true,
          "value": "documents_rfq",
          "mode": "list",
          "cachedResultName": "documents_rfq"
        },
        "topK": 10,
        "options": {
          "queryName": "match_documents_rfq"
        }
      },
      "type": "@n8n/n8n-nodes-langchain.vectorStoreSupabase",
      "typeVersion": 1,
      "position": [
        -1312,
        336
      ],
      "id": "020906d7-ed93-4a3f-8e50-58751b52ff3a",
      "name": "consultar_ofertas",
      "credentials": {
        "supabaseApi": {
          "id": "XmXPiDCWkaOfYEXf",
          "name": "Supabase account"
        }
      }
    },
    {
      "parameters": {
        "content": "## Chat con RFQs",
        "height": 800,
        "width": 1440,
        "color": 3
      },
      "type": "n8n-nodes-base.stickyNote",
      "typeVersion": 1,
      "position": [
        -2256,
        -80
      ],
      "id": "332ff101-caa5-4bf0-bc8d-dc3451286c33",
      "name": "Sticky Note2"
    },
    {
      "parameters": {
        "jsCode": "// 1. Obtener la respuesta del LLM\nconst llmOutput = $input.first().json.text || $input.first().json.content || \"[]\";\nlet parsedData = [];\n\n// 2. Intentar parsear el JSON del LLM\ntry {\n  let cleanOutput = llmOutput\n    .replace(/```json/gi, '')\n    .replace(/```/g, '')\n    .trim();\n  \n  const firstBracket = cleanOutput.indexOf('[');\n  const lastBracket = cleanOutput.lastIndexOf(']');\n  \n  if (firstBracket !== -1 && lastBracket !== -1) {\n    const jsonString = cleanOutput.substring(firstBracket, lastBracket + 1);\n    parsedData = JSON.parse(jsonString);\n  }\n} catch (e) {\n  console.log(\"‚ö†Ô∏è Error parseando JSON del LLM, se usar√°n valores por defecto.\");\n}\n\n// 3. RECUPERAR LA LISTA ORIGINAL (La fuente de la verdad)\n// Esto asegura que si enviamos 50 √≠tems, salgan 50 √≠tems, pase lo que pase.\nlet originalItems = [];\ntry {\n    originalItems = JSON.parse($('Code in JavaScript').first().json.lista_items_json);\n} catch (e) {\n    throw new Error(\"No se pudo recuperar la lista original de √≠tems del nodo anterior\");\n}\n\n// 4. Identificar el Proveedor\nlet proveedor = \"OTROS\";\ntry {\n  proveedor = $('Expandir por Tipo de Evaluaci√≥n').first().json.proveedor_detectado;\n} catch (e) {\n  try {\n     proveedor = $('Loop Over Items1').first().json.proveedor_detectado;\n  } catch(e2) {}\n}\n\n// 5. MERGE (CR√çTICO): Cruzar la lista original con la respuesta del LLM\nreturn originalItems.map(originalItem => {\n    // Buscamos si el LLM respondi√≥ algo para este ID\n    const found = parsedData.find(p => p.id === originalItem.id);\n    \n    let resultado = \"\";\n    \n    if (found && found.cumple) {\n        // Caso: El LLM respondi√≥ correctamente\n        const gap = found.gap_analysis || \"Sin justificaci√≥n\";\n        resultado = `${found.cumple} - ${gap}`;\n    } else {\n        // Caso: El LLM ignor√≥ este √≠tem (ALERTA PARA TI)\n        resultado = \"ERROR_LLM: √çtem no procesado por la IA\";\n    }\n\n    return {\n        json: {\n            id: originalItem.id,\n            [proveedor]: resultado\n        }\n    };\n});"
      },
      "id": "b4f19848-b70d-489f-b9b7-8cd2f71ce145",
      "name": "Parsear y Preparar Update",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        2448,
        112
      ]
    },
    {
      "parameters": {
        "promptType": "define",
        "text": "=### CONTEXTO DEL DOCUMENTO\n\nProveedor: {{ $('Expandir por Tipo de Evaluaci√≥n').first().json.proveedor_detectado }}\n\nTipo de Oferta: {{ $('Expandir por Tipo de Evaluaci√≥n').first().json.tipo_evaluacion_actual }}\n\nTexto Extra√≠do:\n{{ $('Expandir por Tipo de Evaluaci√≥n').first().json.texto_oferta_completo }}\n\n---\n### ITEMS A EVALUAR (CON REQUISITOS RFQ):\n{{ $json.lista_items_json }}\nIMPORTANTE: Cada √≠tem incluye un campo \"rfq_requisito\" que contiene lo que el CLIENTE EXIGE.\nTu trabajo es comparar la OFERTA DEL PROVEEDOR contra estos REQUISITOS ESPEC√çFICOS.",
        "messages": {
          "messageValues": [
            {
              "message": "=# ERES UN AUDITOR DE RFQ. TU TRABAJO ES BINARIO Y ESTRICTO.\n\n---\n\n## PROTOCOLO DE EXTRACCI√ìN\n\nDebes elegir UN SOLO MODO de operaci√≥n basado en la variable \"tipo_evaluacion_actual\".\n\n---\n\n## MODO A: EVALUACI√ìN ECON√ìMICA\n\n**CONDICI√ìN:** tipo_evaluacion_actual = \"Economical Evaluation\"\n\n**OBJETIVO:** Extraer VALORES MONETARIOS, TARIFAS o PORCENTAJES.\n\n**PROHIBICI√ìN ABSOLUTA:** NUNCA usar la palabra \"INCLUIDO\" en este modo.\n\n### Reglas de Decisi√≥n:\n\n1. **¬øHay un VALOR NUM√âRICO con moneda/unidad?**\n   - Responde: [VALOR] - [Contexto breve] | Ref: [Ubicaci√≥n]\n   - Ejemplo: \"45.000 EUR - Precio fijo por ingenier√≠a b√°sica | Ref: Tabla 3.2\"\n\n2. **¬øSe menciona el √≠tem pero SIN CIFRA asociada?**\n   - Responde: SIN VALORAR - [Breve explicaci√≥n] | Ref: [Ubicaci√≥n]\n   - Ejemplo: \"SIN VALORAR - Incluido en alcance sin desglose de precio | Ref: P√°g 12\"\n\n3. **¬øNO se menciona el √≠tem?**\n   - Responde: NO COTIZADO\n\n### PROTOCOLO ANTI-ALUCINACI√ìN PARA MODO ECON√ìMICO:\n\n**ANTES de reportar cualquier precio, verifica:**\n\nCHECKLIST OBLIGATORIO (Responde S√ç/NO a cada pregunta):\n1. ¬øVeo el N√öMERO exacto en el texto?\n2. ¬øVeo la MONEDA (EUR, USD, $, ‚Ç¨) en la MISMA frase?\n3. ¬øEl n√∫mero est√° claramente asociado al √≠tem solicitado?\n4. ¬øPuedo citar textualmente la frase completa que contiene precio + concepto?\n\n**SI CUALQUIER RESPUESTA ES NO:** Usar \"SIN VALORAR\" + explicar qu√© falta\n\n**EJEMPLOS DE VALIDACI√ìN:**\n\nTEXTO: \"Ingenier√≠a b√°sica: 45.000 EUR\"\n- N√öMERO: S√ç (45.000)\n- MONEDA: S√ç (EUR)\n- ASOCIACI√ìN: S√ç (Ingenier√≠a b√°sica)\n- CITA: S√ç (puedo citar la frase completa)\n‚Üí V√ÅLIDO: \"45.000 EUR - Precio fijo | Ref: P√°g X\"\n\nTEXTO: \"El coste de ingenier√≠a se incluye en el alcance general\"\n- N√öMERO: NO\n- MONEDA: NO\n- ASOCIACI√ìN: S√ç (menciona ingenier√≠a)\n- CITA: Parcial\n‚Üí INV√ÅLIDO: \"SIN VALORAR - Mencionado sin cifra asociada | Ref: P√°g X\"\n\nTEXTO: \"45.000\"\n- N√öMERO: S√ç\n- MONEDA: NO (podr√≠a ser c√≥digo, a√±o, coordenada)\n- ASOCIACI√ìN: Dudoso\n- CITA: Insuficiente\n‚Üí INV√ÅLIDO: \"SIN VALORAR - N√∫mero sin contexto de moneda | Ref: P√°g X\"\n\n### PROHIBICIONES:\n\n- NUNCA usar \"INCLUIDO\" en modo econ√≥mico\n- NUNCA inferir precios de √≠tems similares\n- NUNCA calcular totales sin base textual expl√≠cita\n- NUNCA asumir que un n√∫mero sin moneda es un precio\n- Si hay duda: usar \"SIN VALORAR\" + explicar ambig√ºedad\n\n---\n\n## MODO B: EVALUACI√ìN T√âCNICA/DELIVERABLES\n\n**CONDICI√ìN:** tipo_evaluacion_actual IN (\"Technical Evaluation\", \"Pre-FEED Deliverables\", \"FEED Deliverables\")\n\n**OBJETIVO:** Verificar ALCANCE T√âCNICO (el precio es irrelevante).\n\n### Reglas de Decisi√≥n:\n\n1. **¬øSe describe/menciona el trabajo o entregable?**\n   - Responde: INCLUIDO - [Resumen del alcance] | Ref: [Ubicaci√≥n]\n   - Ejemplo: \"INCLUIDO - Dise√±o de sistemas de tuber√≠as hasta l√≠mites de bater√≠a | Ref: Secci√≥n 3.1, Tabla 4\"\n\n2. **¬øSe excluye expl√≠citamente?**\n   - Responde: NO INCLUIDO - [Motivo de exclusi√≥n] | Ref: [Ubicaci√≥n]\n   - Ejemplo: \"NO INCLUIDO - Servicios auxiliares fuera de alcance contractual | Ref: P√°g 12, Cl√°usula 8\"\n\n3. **¬øEst√° cubierto solo parcialmente?**\n   - Responde: PARCIAL - [Qu√© est√° incluido y qu√© no] | Ref: [Ubicaci√≥n]\n   - Ejemplo: \"PARCIAL - Ingenier√≠a b√°sica incluida, detalle requiere aprobaci√≥n | Ref: Anexo B.2\"\n\n4. **¬øNO hay informaci√≥n?**\n   - Responde: SIN INFORMACI√ìN\n\n### PROTOCOLO ANTI-ALUCINACI√ìN PARA MODO T√âCNICO:\n\n**ANTES de reportar \"INCLUIDO\", verifica:**\n\nCHECKLIST OBLIGATORIO:\n1. ¬øEl √≠tem est√° mencionado expl√≠citamente en el texto?\n2. ¬øHay descripci√≥n de c√≥mo se ejecutar√° o qu√© incluye?\n3. ¬øPuedo citar la frase exacta donde aparece?\n4. ¬øEs una afirmaci√≥n positiva de inclusi√≥n (no una negaci√≥n)?\n\n**SI FALTA CUALQUIERA:** Usar \"SIN INFORMACI√ìN\" o buscar m√°s evidencia\n\n**EJEMPLOS DE VALIDACI√ìN:**\n\nTEXTO: \"Se realizar√° an√°lisis de suelos mediante ensayos SPT en 5 ubicaciones\"\n- MENCI√ìN: S√ç (an√°lisis de suelos)\n- DESCRIPCI√ìN: S√ç (ensayos SPT, 5 ubicaciones)\n- CITA: S√ç (puedo citar completo)\n- AFIRMACI√ìN POSITIVA: S√ç (\"Se realizar√°\")\n‚Üí V√ÅLIDO: \"INCLUIDO - An√°lisis de suelos con ensayos SPT en 5 puntos | Ref: P√°g X\"\n\nTEXTO: \"La ingenier√≠a estructural se desarrollar√° conforme a norma ACI-318\"\n- MENCI√ìN: S√ç\n- DESCRIPCI√ìN: S√ç (metodolog√≠a normativa)\n- CITA: S√ç\n- AFIRMACI√ìN POSITIVA: S√ç\n‚Üí V√ÅLIDO: \"INCLUIDO - Ingenier√≠a estructural seg√∫n ACI-318 | Ref: P√°g X\"\n\nTEXTO: \"No incluye servicios de topograf√≠a\"\n- MENCI√ìN: S√ç (topograf√≠a)\n- DESCRIPCI√ìN: S√ç (exclusi√≥n clara)\n- CITA: S√ç\n- AFIRMACI√ìN POSITIVA: NO (es negaci√≥n)\n‚Üí V√ÅLIDO: \"NO INCLUIDO - Exclusi√≥n expl√≠cita | Ref: P√°g X\"\n\nTEXTO: \"Los estudios necesarios ser√°n determinados\"\n- MENCI√ìN: Gen√©rico (\"estudios\")\n- DESCRIPCI√ìN: NO (muy vago)\n- CITA: Insuficiente\n- AFIRMACI√ìN POSITIVA: Ambiguo\n‚Üí INV√ÅLIDO: \"SIN INFORMACI√ìN - Menci√≥n gen√©rica sin detalle\"\n\n### GU√çAS DE INTERPRETACI√ìN:\n\n- \"Parte del alcance\" significa INCLUIDO\n- \"Seg√∫n necesidad del cliente\" significa PARCIAL\n- \"Fuera de l√≠mites\" significa NO INCLUIDO\n- \"A definir\", \"TBD\", \"sujeto a\" significa PARCIAL\n- Silencio total significa SIN INFORMACI√ìN\n- Menci√≥n muy gen√©rica sin detalle significa SIN INFORMACI√ìN\n\n### REGLA CR√çTICA - NO INFERIR:\n\n- Si el √≠tem es \"An√°lisis s√≠smico\" y solo dice \"an√°lisis estructural\" ‚Üí SIN INFORMACI√ìN (no asumir que incluye s√≠smico)\n- Si el √≠tem es \"Planos arquitect√≥nicos\" y solo dice \"documentaci√≥n t√©cnica\" ‚Üí SIN INFORMACI√ìN (no asumir)\n- SOLO marca INCLUIDO si el √≠tem est√° mencionado espec√≠ficamente o muy claramente abarcado\n\n---\n\n## VALIDACI√ìN DE FASE\n\n**Regla Cr√≠tica:** Si el √≠tem solicita precio para fase \"EPC\" pero el documento es \"FEED\":\n- Responde: \"NO COTIZADO (Fase incorrecta - Documento: FEED, Solicitado: EPC)\"\n\n---\n\n## FORMATO DE SALIDA (JSON)\n```json[\n{\n\"id\": 101,\n\"cumple\": \"[ESTADO] - [Descripci√≥n]\",\n\"gap_analysis\": \"Cita: '[Texto literal del documento]' | Ref: [Ubicaci√≥n exacta]\"\n}\n]\n\n### Estructura del campo \"cumple\":\n\n**Para Econ√≥micas:**\n- \"45.000 EUR - Precio fijo por dise√±o completo\"\n- \"SIN VALORAR - Mencionado sin cifra asociada\"\n- \"NO COTIZADO\"\n\n**Para T√©cnicas/Deliverables:**\n- \"INCLUIDO - Descripci√≥n del alcance cubierto\"\n- \"NO INCLUIDO - Motivo de exclusi√≥n\"\n- \"PARCIAL - Qu√© est√° y qu√© no est√° incluido\"\n- \"SIN INFORMACI√ìN\"\n\n### Estructura del campo \"gap_analysis\":\n\nSIEMPRE incluir:\n1. Cita textual breve (m√°ximo 20 palabras)\n2. Referencia precisa (p√°gina, secci√≥n, tabla)\n3. Nota aclaratoria si aplica\n\n**Ejemplo completo:**\n```json{\n\"id\": 42,\n\"cumple\": \"INCLUIDO - Sistema de tuber√≠as hasta l√≠mites de bater√≠a\",\n\"gap_analysis\": \"Cita: 'Incluye dise√±o e instalaci√≥n de tuber√≠as hasta BL' | Ref: Secci√≥n 3.1, Tabla 4 | Nota: No incluye equipos externos\"\n}\n\n---\n\n## COMPARACI√ìN CONTRA REQUISITOS RFQ\n\n**REGLA CR√çTICA:** Para cada √≠tem, DEBES comparar la oferta del proveedor contra el campo `rfq_requisito`.\n\n### L√ìGICA DE COMPARACI√ìN:\n\n**SI rfq_requisito = \"NO ESPECIFICADO EN RFQ\":**\n- Eval√∫a solo si el proveedor menciona el √≠tem (comportamiento actual)\n\n**SI rfq_requisito TIENE CONTENIDO:**\n- COMPARA la oferta contra los requisitos espec√≠ficos\n- Verifica: ¬øCumple con las especificaciones exigidas?\n- Verifica: ¬øCumple con las normativas requeridas?\n- Verifica: ¬øCumple con las cantidades/formatos solicitados?\n\n### FORMATO DE RESPUESTA CON COMPARACI√ìN:\n\n**Para Evaluaci√≥n T√©cnica:**\n```\nCUMPLE - Oferta cumple requisito RFQ: [Resumen de cumplimiento] | Ref: [Ubicaci√≥n en oferta]\nPARCIAL - Cumple [X], falta [Y seg√∫n RFQ] | Ref: [Ubicaci√≥n]\nNO CUMPLE - RFQ exige [X], oferta indica [Y] | Ref: [Ubicaci√≥n]\nSIN INFORMACI√ìN - No se puede verificar contra requisito RFQ\n```\n\n**Para Evaluaci√≥n Econ√≥mica:**\n```\n[PRECIO] - [Comparaci√≥n vs formato RFQ] | Ref: [Ubicaci√≥n]\nEjemplo: \"45.000 EUR - Cumple formato Lump Sum requerido, incluye desglose por fase | Ref: Tabla 3\"\nEjemplo: \"85 EUR/h - NO cumple: RFQ pide precio global, oferta da tarifa horaria | Ref: P√°g 12\"\n```\n\n### EJEMPLO DE EVALUACI√ìN COMPARATIVA:\n\n**Input:**\n```json\n{\n  \"id\": 101,\n  \"item\": \"Dise√±o de tuber√≠as de proceso\",\n  \"rfq_requisito\": \"Di√°metros 2\\\"-24\\\" | Norma: ASME B31.3 | Material: SS316L\"\n}\n```\n\n**Texto Oferta:** \"Incluye dise√±o de tuber√≠as 1\\\"-36\\\" seg√∫n ASME B31.3, material acero inoxidable 304\"\n\n**Output Correcto:**\n```json\n{\n  \"id\": 101,\n  \"cumple\": \"PARCIAL - Cumple norma ASME B31.3, rango di√°metros mayor (1\\\"-36\\\" vs 2\\\"-24\\\"), pero material SS304 no cumple requisito SS316L\",\n  \"gap_analysis\": \"Cita: 'tuber√≠as 1\\\"-36\\\" seg√∫n ASME B31.3, material acero inoxidable 304' | Ref: Secci√≥n 3.2, P√°g 15 | GAP: Material no conforme\"\n}\n\n\n\n---\n\n## REGLA ABSOLUTA: PROCESAR TODOS LOS √çTEMS\n\n**CR√çTICO:** El JSON de salida DEBE contener EXACTAMENTE el mismo n√∫mero de √≠tems que recibiste en la lista de entrada.\n\n**SI UN √çTEM NO TIENE INFORMACI√ìN:**\n- NO lo omitas del JSON\n- NO lo dejes en blanco\n- Devuelve: \"SIN INFORMACI√ìN\" o \"NO COTIZADO\" seg√∫n corresponda\n\n**VERIFICACI√ìN FINAL ANTES DE RESPONDER:**\n1. Cuenta cu√°ntos √≠tems recibiste en el input\n2. Cuenta cu√°ntos √≠tems tienes en tu JSON de salida\n3. Si los n√∫meros no coinciden ‚Üí REVISA y completa los faltantes\n\n---\n\n## INSTRUCCIONES DE EJECUCI√ìN\n\n1. LEE la lista completa de √≠tems\n2. IDENTIFICA el modo (Econ√≥mico vs T√©cnico) basado en \"tipo_evaluacion_actual\"\n3. Para CADA √≠tem individualmente:\n   a. BUSCA el √≠tem en el texto usando t√©rminos clave\n   b. APLICA el checklist anti-alucinaci√≥n correspondiente\n   c. Si pasa el checklist ‚Üí reporta el hallazgo\n   d. Si no pasa ‚Üí usa \"SIN VALORAR\" o \"SIN INFORMACI√ìN\"\n   e. NUNCA omitas el √≠tem del JSON\n4. VERIFICA que tienes el mismo n√∫mero de √≠tems en el output que en el input\n5. FORMATEA la respuesta en JSON v√°lido\n\n**IMPORTANTE:** Tu credibilidad depende de NO inventar informaci√≥n. Es mejor decir \"SIN INFORMACI√ìN\" con honestidad que reportar datos que no existen en el documento."
            }
          ]
        },
        "batching": {}
      },
      "type": "@n8n/n8n-nodes-langchain.chainLlm",
      "typeVersion": 1.7,
      "position": [
        1920,
        112
      ],
      "id": "7b23e216-5152-43b7-a8bc-c5df39f7457c",
      "name": "LLM Chain"
    },
    {
      "parameters": {
        "rules": {
          "values": [
            {
              "conditions": {
                "options": {
                  "caseSensitive": true,
                  "leftValue": "",
                  "typeValidation": "strict",
                  "version": 3
                },
                "conditions": [
                  {
                    "leftValue": "={{ $('Expandir por Tipo de Evaluaci√≥n').first().json.proveedor_detectado }}",
                    "rightValue": "TECNICASREUNIDAS",
                    "operator": {
                      "type": "string",
                      "operation": "equals"
                    },
                    "id": "f3688704-f30f-4143-8008-ae6c1a06eea1"
                  }
                ],
                "combinator": "and"
              }
            },
            {
              "conditions": {
                "options": {
                  "caseSensitive": true,
                  "leftValue": "",
                  "typeValidation": "strict",
                  "version": 3
                },
                "conditions": [
                  {
                    "id": "c2c6726d-ea3f-4909-a535-6f402eef63b8",
                    "leftValue": "={{ $('Expandir por Tipo de Evaluaci√≥n').first().json.proveedor_detectado }}",
                    "rightValue": "IDOM",
                    "operator": {
                      "type": "string",
                      "operation": "equals"
                    }
                  }
                ],
                "combinator": "and"
              }
            },
            {
              "conditions": {
                "options": {
                  "caseSensitive": true,
                  "leftValue": "",
                  "typeValidation": "strict",
                  "version": 3
                },
                "conditions": [
                  {
                    "id": "a64d8e41-6f32-489d-bf60-3bd22c9c9374",
                    "leftValue": "={{ $('Expandir por Tipo de Evaluaci√≥n').first().json.proveedor_detectado }}",
                    "rightValue": "SACYR",
                    "operator": {
                      "type": "string",
                      "operation": "equals"
                    }
                  }
                ],
                "combinator": "and"
              }
            },
            {
              "conditions": {
                "options": {
                  "caseSensitive": true,
                  "leftValue": "",
                  "typeValidation": "strict",
                  "version": 3
                },
                "conditions": [
                  {
                    "id": "42a16d6b-db65-401d-abb0-f8ae9aefff12",
                    "leftValue": "={{ $('Expandir por Tipo de Evaluaci√≥n').first().json.proveedor_detectado }}",
                    "rightValue": "EA",
                    "operator": {
                      "type": "string",
                      "operation": "equals",
                      "name": "filter.operator.equals"
                    }
                  }
                ],
                "combinator": "and"
              }
            },
            {
              "conditions": {
                "options": {
                  "caseSensitive": true,
                  "leftValue": "",
                  "typeValidation": "strict",
                  "version": 3
                },
                "conditions": [
                  {
                    "id": "79599b4a-f8d0-4078-913a-2b40bea117c4",
                    "leftValue": "={{ $('Expandir por Tipo de Evaluaci√≥n').first().json.proveedor_detectado }}",
                    "rightValue": "SENER",
                    "operator": {
                      "type": "string",
                      "operation": "equals",
                      "name": "filter.operator.equals"
                    }
                  }
                ],
                "combinator": "and"
              }
            },
            {
              "conditions": {
                "options": {
                  "caseSensitive": true,
                  "leftValue": "",
                  "typeValidation": "strict",
                  "version": 3
                },
                "conditions": [
                  {
                    "id": "59b13bbc-96bb-4e22-8fde-5c2fb10c8675",
                    "leftValue": "={{ $('Expandir por Tipo de Evaluaci√≥n').first().json.proveedor_detectado }}",
                    "rightValue": "TRESCA",
                    "operator": {
                      "type": "string",
                      "operation": "equals",
                      "name": "filter.operator.equals"
                    }
                  }
                ],
                "combinator": "and"
              }
            },
            {
              "conditions": {
                "options": {
                  "caseSensitive": true,
                  "leftValue": "",
                  "typeValidation": "strict",
                  "version": 3
                },
                "conditions": [
                  {
                    "id": "d1601299-eed6-4754-b538-5e32d16a2a40",
                    "leftValue": "={{ $('Expandir por Tipo de Evaluaci√≥n').first().json.proveedor_detectado }}",
                    "rightValue": "WORLEY",
                    "operator": {
                      "type": "string",
                      "operation": "equals",
                      "name": "filter.operator.equals"
                    }
                  }
                ],
                "combinator": "and"
              }
            }
          ]
        },
        "options": {
          "fallbackOutput": "extra"
        }
      },
      "type": "n8n-nodes-base.switch",
      "typeVersion": 3.4,
      "position": [
        3536,
        256
      ],
      "id": "55143288-437d-4a4c-836a-1ab699f33b59",
      "name": "Switch"
    },
    {
      "parameters": {
        "operation": "update",
        "dataTableId": {
          "__rl": true,
          "value": "jIatxsggJ92wzApV",
          "mode": "list",
          "cachedResultName": "Prueba",
          "cachedResultUrl": "/projects/vcLkFgTx7CPaMMKV/datatables/jIatxsggJ92wzApV"
        },
        "filters": {
          "conditions": [
            {
              "keyValue": "={{ $json.id }}"
            }
          ]
        },
        "columns": {
          "mappingMode": "defineBelow",
          "value": {
            "TECNICASREUNIDAS": "={{ $('Parsear y Preparar Update').item.json.TECNICASREUNIDAS }}"
          },
          "matchingColumns": [
            "id"
          ],
          "schema": [
            {
              "id": "Evaluation",
              "displayName": "Evaluation",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "readOnly": false,
              "removed": true
            },
            {
              "id": "fase",
              "displayName": "fase",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "readOnly": false,
              "removed": true
            },
            {
              "id": "descripcion_item",
              "displayName": "descripcion_item",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "readOnly": false,
              "removed": true
            },
            {
              "id": "TRESCA",
              "displayName": "TRESCA",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "readOnly": false,
              "removed": true
            },
            {
              "id": "EA",
              "displayName": "EA",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "readOnly": false,
              "removed": true
            },
            {
              "id": "IDOM",
              "displayName": "IDOM",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "readOnly": false,
              "removed": true
            },
            {
              "id": "TECNICASREUNIDAS",
              "displayName": "TECNICASREUNIDAS",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "readOnly": false,
              "removed": false
            },
            {
              "id": "SACYR",
              "displayName": "SACYR",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "readOnly": false,
              "removed": true
            },
            {
              "id": "SENER",
              "displayName": "SENER",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "readOnly": false,
              "removed": true
            },
            {
              "id": "WORLEY",
              "displayName": "WORLEY",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "readOnly": false,
              "removed": true
            }
          ],
          "attemptToConvertTypes": false,
          "convertFieldsToString": false
        },
        "options": {}
      },
      "id": "f5a7d06e-ee4e-40a2-ad16-3f02af96e8b2",
      "name": "Update RFQ TR",
      "type": "n8n-nodes-base.dataTable",
      "typeVersion": 1,
      "position": [
        3936,
        -224
      ]
    },
    {
      "parameters": {
        "operation": "update",
        "dataTableId": {
          "__rl": true,
          "value": "jIatxsggJ92wzApV",
          "mode": "list",
          "cachedResultName": "Prueba",
          "cachedResultUrl": "/projects/vcLkFgTx7CPaMMKV/datatables/jIatxsggJ92wzApV"
        },
        "filters": {
          "conditions": [
            {
              "keyValue": "={{ $json.id }}"
            }
          ]
        },
        "columns": {
          "mappingMode": "defineBelow",
          "value": {
            "IDOM": "={{ $('Parsear y Preparar Update').item.json.IDOM }}"
          },
          "matchingColumns": [
            "id"
          ],
          "schema": [
            {
              "id": "Evaluation",
              "displayName": "Evaluation",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "readOnly": false,
              "removed": true
            },
            {
              "id": "fase",
              "displayName": "fase",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "readOnly": false,
              "removed": true
            },
            {
              "id": "descripcion_item",
              "displayName": "descripcion_item",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "readOnly": false,
              "removed": true
            },
            {
              "id": "TRESCA",
              "displayName": "TRESCA",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "readOnly": false,
              "removed": true
            },
            {
              "id": "EA",
              "displayName": "EA",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "readOnly": false,
              "removed": true
            },
            {
              "id": "IDOM",
              "displayName": "IDOM",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "readOnly": false,
              "removed": false
            },
            {
              "id": "TECNICASREUNIDAS",
              "displayName": "TECNICASREUNIDAS",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "readOnly": false,
              "removed": true
            },
            {
              "id": "SACYR",
              "displayName": "SACYR",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "readOnly": false,
              "removed": true
            },
            {
              "id": "SENER",
              "displayName": "SENER",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "readOnly": false,
              "removed": true
            },
            {
              "id": "WORLEY",
              "displayName": "WORLEY",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "readOnly": false,
              "removed": true
            }
          ],
          "attemptToConvertTypes": false,
          "convertFieldsToString": false
        },
        "options": {}
      },
      "id": "65c56c42-3ca3-426d-8cec-0d5a3142aff0",
      "name": "Update RFQ IDOM",
      "type": "n8n-nodes-base.dataTable",
      "typeVersion": 1,
      "position": [
        3936,
        -32
      ]
    },
    {
      "parameters": {
        "operation": "update",
        "dataTableId": {
          "__rl": true,
          "value": "jIatxsggJ92wzApV",
          "mode": "list",
          "cachedResultName": "Prueba",
          "cachedResultUrl": "/projects/vcLkFgTx7CPaMMKV/datatables/jIatxsggJ92wzApV"
        },
        "filters": {
          "conditions": [
            {
              "keyValue": "={{ $json.id }}"
            }
          ]
        },
        "columns": {
          "mappingMode": "defineBelow",
          "value": {
            "SACYR": "={{ $('Parsear y Preparar Update').item.json.SACYR }}"
          },
          "matchingColumns": [
            "id"
          ],
          "schema": [
            {
              "id": "Evaluation",
              "displayName": "Evaluation",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "readOnly": false,
              "removed": true
            },
            {
              "id": "fase",
              "displayName": "fase",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "readOnly": false,
              "removed": true
            },
            {
              "id": "descripcion_item",
              "displayName": "descripcion_item",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "readOnly": false,
              "removed": true
            },
            {
              "id": "TRESCA",
              "displayName": "TRESCA",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "readOnly": false,
              "removed": true
            },
            {
              "id": "EA",
              "displayName": "EA",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "readOnly": false,
              "removed": true
            },
            {
              "id": "IDOM",
              "displayName": "IDOM",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "readOnly": false,
              "removed": true
            },
            {
              "id": "TECNICASREUNIDAS",
              "displayName": "TECNICASREUNIDAS",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "readOnly": false,
              "removed": true
            },
            {
              "id": "SACYR",
              "displayName": "SACYR",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "readOnly": false,
              "removed": false
            },
            {
              "id": "SENER",
              "displayName": "SENER",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "readOnly": false,
              "removed": true
            },
            {
              "id": "WORLEY",
              "displayName": "WORLEY",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "readOnly": false,
              "removed": true
            }
          ],
          "attemptToConvertTypes": false,
          "convertFieldsToString": false
        },
        "options": {}
      },
      "id": "b296e5a2-0c0d-4671-8369-941d21705072",
      "name": "Update RFQ SACYR",
      "type": "n8n-nodes-base.dataTable",
      "typeVersion": 1,
      "position": [
        3936,
        160
      ]
    },
    {
      "parameters": {
        "operation": "update",
        "dataTableId": {
          "__rl": true,
          "value": "jIatxsggJ92wzApV",
          "mode": "list",
          "cachedResultName": "Prueba",
          "cachedResultUrl": "/projects/vcLkFgTx7CPaMMKV/datatables/jIatxsggJ92wzApV"
        },
        "filters": {
          "conditions": [
            {
              "keyValue": "={{ $json.id }}"
            }
          ]
        },
        "columns": {
          "mappingMode": "defineBelow",
          "value": {
            "EA": "={{ $('Parsear y Preparar Update').item.json.EA }}"
          },
          "matchingColumns": [
            "id"
          ],
          "schema": [
            {
              "id": "Evaluation",
              "displayName": "Evaluation",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "readOnly": false,
              "removed": true
            },
            {
              "id": "fase",
              "displayName": "fase",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "readOnly": false,
              "removed": true
            },
            {
              "id": "descripcion_item",
              "displayName": "descripcion_item",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "readOnly": false,
              "removed": true
            },
            {
              "id": "TRESCA",
              "displayName": "TRESCA",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "readOnly": false,
              "removed": true
            },
            {
              "id": "EA",
              "displayName": "EA",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "readOnly": false,
              "removed": false
            },
            {
              "id": "IDOM",
              "displayName": "IDOM",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "readOnly": false,
              "removed": true
            },
            {
              "id": "TECNICASREUNIDAS",
              "displayName": "TECNICASREUNIDAS",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "readOnly": false,
              "removed": true
            },
            {
              "id": "SACYR",
              "displayName": "SACYR",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "readOnly": false,
              "removed": true
            },
            {
              "id": "SENER",
              "displayName": "SENER",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "readOnly": false,
              "removed": true
            },
            {
              "id": "WORLEY",
              "displayName": "WORLEY",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "readOnly": false,
              "removed": true
            }
          ],
          "attemptToConvertTypes": false,
          "convertFieldsToString": false
        },
        "options": {}
      },
      "id": "bf331edc-2938-4ea9-bdfc-2734d66c9167",
      "name": "Update RFQ EA",
      "type": "n8n-nodes-base.dataTable",
      "typeVersion": 1,
      "position": [
        3936,
        336
      ]
    },
    {
      "parameters": {
        "operation": "update",
        "dataTableId": {
          "__rl": true,
          "value": "jIatxsggJ92wzApV",
          "mode": "list",
          "cachedResultName": "Prueba",
          "cachedResultUrl": "/projects/vcLkFgTx7CPaMMKV/datatables/jIatxsggJ92wzApV"
        },
        "filters": {
          "conditions": [
            {
              "keyValue": "={{ $json.id }}"
            }
          ]
        },
        "columns": {
          "mappingMode": "defineBelow",
          "value": {
            "SENER": "={{ $('Parsear y Preparar Update').item.json.SENER }}"
          },
          "matchingColumns": [
            "id"
          ],
          "schema": [
            {
              "id": "Evaluation",
              "displayName": "Evaluation",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "readOnly": false,
              "removed": true
            },
            {
              "id": "fase",
              "displayName": "fase",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "readOnly": false,
              "removed": true
            },
            {
              "id": "descripcion_item",
              "displayName": "descripcion_item",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "readOnly": false,
              "removed": true
            },
            {
              "id": "TRESCA",
              "displayName": "TRESCA",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "readOnly": false,
              "removed": true
            },
            {
              "id": "EA",
              "displayName": "EA",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "readOnly": false,
              "removed": true
            },
            {
              "id": "IDOM",
              "displayName": "IDOM",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "readOnly": false,
              "removed": true
            },
            {
              "id": "TECNICASREUNIDAS",
              "displayName": "TECNICASREUNIDAS",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "readOnly": false,
              "removed": true
            },
            {
              "id": "SACYR",
              "displayName": "SACYR",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "readOnly": false,
              "removed": true
            },
            {
              "id": "SENER",
              "displayName": "SENER",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "readOnly": false,
              "removed": false
            },
            {
              "id": "WORLEY",
              "displayName": "WORLEY",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "readOnly": false,
              "removed": true
            }
          ],
          "attemptToConvertTypes": false,
          "convertFieldsToString": false
        },
        "options": {}
      },
      "id": "f1df7367-56a1-45e8-865c-69ec486ff732",
      "name": "Update RFQ SENER",
      "type": "n8n-nodes-base.dataTable",
      "typeVersion": 1,
      "position": [
        3936,
        528
      ]
    },
    {
      "parameters": {
        "operation": "update",
        "dataTableId": {
          "__rl": true,
          "value": "jIatxsggJ92wzApV",
          "mode": "list",
          "cachedResultName": "Prueba",
          "cachedResultUrl": "/projects/vcLkFgTx7CPaMMKV/datatables/jIatxsggJ92wzApV"
        },
        "filters": {
          "conditions": [
            {
              "keyValue": "={{ $json.id }}"
            }
          ]
        },
        "columns": {
          "mappingMode": "defineBelow",
          "value": {
            "TRESCA": "={{ $('Parsear y Preparar Update').item.json.TRESCA }}"
          },
          "matchingColumns": [
            "id"
          ],
          "schema": [
            {
              "id": "Evaluation",
              "displayName": "Evaluation",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "readOnly": false,
              "removed": true
            },
            {
              "id": "fase",
              "displayName": "fase",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "readOnly": false,
              "removed": true
            },
            {
              "id": "descripcion_item",
              "displayName": "descripcion_item",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "readOnly": false,
              "removed": true
            },
            {
              "id": "TRESCA",
              "displayName": "TRESCA",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "readOnly": false,
              "removed": false
            },
            {
              "id": "EA",
              "displayName": "EA",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "readOnly": false,
              "removed": true
            },
            {
              "id": "IDOM",
              "displayName": "IDOM",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "readOnly": false,
              "removed": true
            },
            {
              "id": "TECNICASREUNIDAS",
              "displayName": "TECNICASREUNIDAS",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "readOnly": false,
              "removed": true
            },
            {
              "id": "SACYR",
              "displayName": "SACYR",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "readOnly": false,
              "removed": true
            },
            {
              "id": "SENER",
              "displayName": "SENER",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "readOnly": false,
              "removed": true
            },
            {
              "id": "WORLEY",
              "displayName": "WORLEY",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "readOnly": false,
              "removed": true
            }
          ],
          "attemptToConvertTypes": false,
          "convertFieldsToString": false
        },
        "options": {}
      },
      "id": "11e3c3da-6599-4b5c-bc23-0dbe57ab2bef",
      "name": "Update RFQ TRESCA",
      "type": "n8n-nodes-base.dataTable",
      "typeVersion": 1,
      "position": [
        3936,
        720
      ]
    },
    {
      "parameters": {
        "operation": "update",
        "dataTableId": {
          "__rl": true,
          "value": "jIatxsggJ92wzApV",
          "mode": "list",
          "cachedResultName": "Prueba",
          "cachedResultUrl": "/projects/vcLkFgTx7CPaMMKV/datatables/jIatxsggJ92wzApV"
        },
        "filters": {
          "conditions": [
            {
              "keyValue": "={{ $json.id }}"
            }
          ]
        },
        "columns": {
          "mappingMode": "defineBelow",
          "value": {
            "WORLEY": "={{ $('Parsear y Preparar Update').item.json.WORLEY }}"
          },
          "matchingColumns": [
            "id"
          ],
          "schema": [
            {
              "id": "Evaluation",
              "displayName": "Evaluation",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "readOnly": false,
              "removed": true
            },
            {
              "id": "fase",
              "displayName": "fase",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "readOnly": false,
              "removed": true
            },
            {
              "id": "descripcion_item",
              "displayName": "descripcion_item",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "readOnly": false,
              "removed": true
            },
            {
              "id": "TRESCA",
              "displayName": "TRESCA",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "readOnly": false,
              "removed": true
            },
            {
              "id": "EA",
              "displayName": "EA",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "readOnly": false,
              "removed": true
            },
            {
              "id": "IDOM",
              "displayName": "IDOM",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "readOnly": false,
              "removed": true
            },
            {
              "id": "TECNICASREUNIDAS",
              "displayName": "TECNICASREUNIDAS",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "readOnly": false,
              "removed": true
            },
            {
              "id": "SACYR",
              "displayName": "SACYR",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "readOnly": false,
              "removed": true
            },
            {
              "id": "SENER",
              "displayName": "SENER",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "readOnly": false,
              "removed": true
            },
            {
              "id": "WORLEY",
              "displayName": "WORLEY",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "readOnly": false,
              "removed": false
            }
          ],
          "attemptToConvertTypes": false,
          "convertFieldsToString": false
        },
        "options": {}
      },
      "id": "883d3ad8-5932-4ab3-97b9-2ea09e6ec94a",
      "name": "Update RFQ WORLEY",
      "type": "n8n-nodes-base.dataTable",
      "typeVersion": 1,
      "position": [
        3936,
        928
      ]
    },
    {
      "parameters": {
        "operation": "upsert",
        "schema": {
          "__rl": true,
          "mode": "list",
          "value": "public"
        },
        "table": {
          "__rl": true,
          "value": "document_metadata",
          "mode": "list",
          "cachedResultName": "document_metadata"
        },
        "columns": {
          "mappingMode": "defineBelow",
          "value": {
            "id": "={{ $('Set File ID').item.json.file_id }}",
            "title": "={{ $('Set File ID').item.json.file_title }}",
            "url": "={{ $('Set File ID').item.json.file_url }}"
          },
          "matchingColumns": [
            "id"
          ],
          "schema": [
            {
              "id": "id",
              "displayName": "id",
              "required": true,
              "defaultMatch": true,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            },
            {
              "id": "title",
              "displayName": "title",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": false
            },
            {
              "id": "url",
              "displayName": "url",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": false
            },
            {
              "id": "created_at",
              "displayName": "created_at",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "dateTime",
              "canBeUsedToMatch": false,
              "removed": false
            },
            {
              "id": "schema",
              "displayName": "schema",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": false,
              "removed": false
            }
          ],
          "attemptToConvertTypes": false,
          "convertFieldsToString": false
        },
        "options": {}
      },
      "type": "n8n-nodes-base.postgres",
      "typeVersion": 2.5,
      "position": [
        576,
        880
      ],
      "id": "41401702-1d7a-47bc-9f6c-4ff18659a288",
      "name": "Insert Document Metadata",
      "executeOnce": true,
      "credentials": {
        "postgres": {
          "id": "BNCttvQcKbXFj6nd",
          "name": "Postgres account"
        }
      }
    },
    {
      "parameters": {
        "operation": "delete",
        "tableId": "documents_768",
        "filterType": "string",
        "filterString": "=metadata->>file_id=like.*{{ $json.file_id }}*"
      },
      "id": "fffdd1f0-297d-44a4-b14d-42396082d8c3",
      "name": "Delete Old Doc Rows",
      "type": "n8n-nodes-base.supabase",
      "typeVersion": 1,
      "position": [
        320,
        880
      ],
      "alwaysOutputData": true,
      "credentials": {
        "supabaseApi": {
          "id": "XmXPiDCWkaOfYEXf",
          "name": "Supabase account"
        }
      }
    },
    {
      "parameters": {
        "assignments": {
          "assignments": [
            {
              "id": "10646eae-ae46-4327-a4dc-9987c2d76173",
              "name": "file_id",
              "value": "={{ $json.body.file_id }}",
              "type": "string"
            },
            {
              "id": "77d782de-169d-4a46-8a8e-a3831c04d90f",
              "name": "file_title",
              "value": "={{ $json.body.file_title }}",
              "type": "string"
            },
            {
              "id": "9bde4d7f-e4f3-4ebd-9338-dce1350f9eab",
              "name": "file_url",
              "value": "={{ $json.body.file_url }}",
              "type": "string"
            },
            {
              "id": "b1dbe9b9-248a-4593-a769-a085b34e0810",
              "name": "file_binary",
              "value": "={{ $json.body.file_binary }}",
              "type": "string"
            },
            {
              "id": "74d93dce-cddc-4947-ae19-88bc5cacd146",
              "name": "file_metadata",
              "value": "={{ $json.body.metadata }}",
              "type": "string"
            }
          ]
        },
        "options": {}
      },
      "id": "96b932ce-b63f-4ba0-9efd-8fad35d50ea8",
      "name": "Set File ID",
      "type": "n8n-nodes-base.set",
      "typeVersion": 3.4,
      "position": [
        96,
        880
      ]
    },
    {
      "parameters": {
        "jsonMode": "expressionData",
        "jsonData": "={{ $json.text }}",
        "options": {
          "metadata": {
            "metadataValues": [
              {
                "name": "file_id",
                "value": "={{ $json.metadata.file_id }}"
              },
              {
                "name": "file_title",
                "value": "={{ $json.metadata.file_title }}"
              },
              {
                "name": "tipo_evaluacion",
                "value": "={{ $json.metadata.tipo_evaluacion }}"
              },
              {
                "name": "proveedor",
                "value": "={{ $json.metadata.proveedor }}"
              }
            ]
          }
        }
      },
      "id": "70e38ab9-a515-468e-b73e-f0744d5dc255",
      "name": "Default Data Loader",
      "type": "@n8n/n8n-nodes-langchain.documentDefaultDataLoader",
      "typeVersion": 1,
      "position": [
        3616,
        1136
      ]
    },
    {
      "parameters": {
        "chunkSize": 1500,
        "chunkOverlap": 200,
        "options": {}
      },
      "type": "@n8n/n8n-nodes-langchain.textSplitterRecursiveCharacterTextSplitter",
      "typeVersion": 1,
      "position": [
        3520,
        1296
      ],
      "id": "9d53a274-70a9-4ba7-841b-cfe6dcd00293",
      "name": "Recursive Character Text Splitter"
    },
    {
      "parameters": {
        "operation": "get",
        "dataTableId": {
          "__rl": true,
          "value": "jIatxsggJ92wzApV",
          "mode": "list",
          "cachedResultName": "Prueba",
          "cachedResultUrl": "/projects/vcLkFgTx7CPaMMKV/datatables/jIatxsggJ92wzApV"
        },
        "filters": {
          "conditions": [
            {
              "keyName": "Evaluation",
              "keyValue": "={{ $json.tipo_evaluacion_actual }}"
            }
          ]
        },
        "returnAll": true
      },
      "type": "n8n-nodes-base.dataTable",
      "typeVersion": 1,
      "position": [
        608,
        32
      ],
      "id": "775cbf69-d238-47a8-b274-1521898c33db",
      "name": "Get RFQ Items"
    },
    {
      "parameters": {
        "mode": "insert",
        "tableName": {
          "__rl": true,
          "value": "documents_768",
          "mode": "list",
          "cachedResultName": "documents_768"
        },
        "options": {
          "queryName": "match_documents_768"
        }
      },
      "id": "83779793-aacc-4711-a076-db6139f3a90e",
      "name": "Insert into Supabase Vectorstore",
      "type": "@n8n/n8n-nodes-langchain.vectorStoreSupabase",
      "typeVersion": 1,
      "position": [
        3472,
        880
      ],
      "credentials": {
        "supabaseApi": {
          "id": "XmXPiDCWkaOfYEXf",
          "name": "Supabase account"
        }
      }
    },
    {
      "parameters": {
        "jsCode": "// =============================================\n// NODO: Validar Contenido PDF (FIX PAGINACI√ìN)\n// =============================================\n\nconst input = $input.first().json;\n\n// Variables de inicializaci√≥n\nlet pages = [];\nlet totalChars = 0;\nlet hasTablesDetected = false;\n\n// --- 1. PROCESAMIENTO DEL TEXTO ---\n\n// CASO A: Viene desglosado por p√°ginas (Array)\nif (input.pages && Array.isArray(input.pages) && input.pages.length > 0) {\n  pages = input.pages;\n  pages.forEach(page => {\n    const text = page.text || page.pageContent || \"\";\n    totalChars += text.length;\n    // Detecci√≥n simple de tablas\n    if ((text.match(/\\s{4,}/g) || []).length > 5) hasTablesDetected = true;\n  });\n\n// CASO B: Viene todo el texto junto (String) - ESTE ES TU CASO ACTUAL\n} else if (input.text && typeof input.text === 'string') {\n  const text = input.text;\n  totalChars = text.length;\n  // Creamos una \"p√°gina √∫nica\" contenedora para no romper el flujo\n  pages = [{ text: text, pageNumber: 1 }];\n  \n  // Detectar tablas en el texto completo\n  if ((text.match(/\\s{4,}/g) || []).length > 20) hasTablesDetected = true;\n  \n} else {\n  // CASO C: Vac√≠o\n  pages = [];\n}\n\n// --- 2. C√ÅLCULO DE P√ÅGINAS REALES (FIX CR√çTICO) ---\n\n// Intentamos leer el metadato 'numpages' que se ve en tu captura\nlet realPageCount = input.numpages || input.numPages || input.numberOfPages || 0;\n\n// Si no existe el metadato, usamos la longitud del array (fallback)\nif (!realPageCount || realPageCount === 0) {\n    realPageCount = pages.length;\n}\n\n// Si sigue siendo 1 pero el texto es enorme (>10k chars), estimamos\nif (realPageCount <= 1 && totalChars > 10000) {\n    // Estimaci√≥n conservadora: 3000 caracteres por p√°gina t√©cnica\n    realPageCount = Math.ceil(totalChars / 3000);\n}\n\n// Evitar divisi√≥n por cero\nrealPageCount = Math.max(1, realPageCount);\n\n\n// --- 3. M√âTRICAS FINALES ---\n\nconst avgCharsPerPage = totalChars / realPageCount;\n\n// CRITERIO: ¬øNecesita OCR?\n// Si hay texto (< 100 chars/pag) es probable que sea escaneado.\nconst needsOCR = avgCharsPerPage < 100; \n\n// Metadatos\nlet fileId = \"unknown\";\nlet fileTitle = \"unknown\";\ntry {\n  const metaNode = $('Set File ID').first().json;\n  fileId = metaNode.file_id;\n  fileTitle = metaNode.file_title;\n} catch (e) {}\n\n// --- LOGGING ---\nconsole.log(`üìÑ An√°lisis: ${fileTitle}`);\nconsole.log(`   ‚îú‚îÄ P√°ginas (Metadato): ${input.numpages}`); \nconsole.log(`   ‚îú‚îÄ P√°ginas (Usadas): ${realPageCount}`);\nconsole.log(`   ‚îú‚îÄ Caracteres Totales: ${totalChars}`);\nconsole.log(`   ‚îú‚îÄ Promedio/P√°g: ${Math.round(avgCharsPerPage)}`);\n\nreturn {\n  json: {\n    // M√©tricas corregidas\n    totalPages: realPageCount, // Ahora dir√° 235\n    totalChars: totalChars,\n    avgCharsPerPage: Math.round(avgCharsPerPage), // Ahora ser√° un n√∫mero razonable (~2800)\n    hasTables: hasTablesDetected,\n    needsOCR: needsOCR,\n    \n    // Contenido\n    pages: pages, \n    \n    // Metadatos\n    fileId: fileId,\n    fileName: fileTitle\n  }\n};"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        1392,
        880
      ],
      "id": "554f3895-2eb0-4ce1-ae57-787b99723c42",
      "name": "Validar Contenido PDF"
    },
    {
      "parameters": {
        "operation": "pdf",
        "options": {}
      },
      "type": "n8n-nodes-base.extractFromFile",
      "typeVersion": 1.1,
      "position": [
        1120,
        880
      ],
      "id": "01c27cda-0112-4cf7-ba09-de35f41ab5e7",
      "name": "Extract from File"
    },
    {
      "parameters": {
        "conditions": {
          "options": {
            "caseSensitive": true,
            "leftValue": "",
            "typeValidation": "strict",
            "version": 3
          },
          "conditions": [
            {
              "id": "57b9c551-9997-4ed5-8ddd-f80c108a177c",
              "leftValue": "={{ $json.needsOCR }}",
              "rightValue": "",
              "operator": {
                "type": "boolean",
                "operation": "true",
                "singleValue": true
              }
            }
          ],
          "combinator": "and"
        },
        "options": {}
      },
      "type": "n8n-nodes-base.if",
      "typeVersion": 2.3,
      "position": [
        1664,
        880
      ],
      "id": "6566456a-f261-42bd-8be5-b97e3e195c0a",
      "name": "¬øNecesita OCR?"
    },
    {
      "parameters": {
        "jsCode": "// =============================================\n// NODO: Aggregate OCR Pages (CORREGIDO)\n// =============================================\n\nconst items = $input.all();\nlet fullText = \"\";\nlet pagesArray = [];\n\n// OPCI√ìN A: Si Tesseract devuelve m√∫ltiples items (1 por p√°gina)\nif (items.length > 1) {\n  items.forEach((item, idx) => {\n    const pageText = item.json.text || \"\";\n    fullText += pageText + \"\\n\\n\";\n    \n    // Construimos array compatible con vectorstore\n    pagesArray.push({\n      text: pageText,\n      pageNumber: idx + 1\n    });\n  });\n}\n// OPCI√ìN B: Si Tesseract devuelve un solo item con todo el texto\nelse if (items.length === 1) {\n  fullText = items[0].json.text || \"\";\n  pagesArray = [{\n    text: fullText,\n    pageNumber: 1\n  }];\n}\n\n// RECUPERAR METADATOS ORIGINALES (CR√çTICO)\nlet fileId, fileName, proveedor;\ntry {\n  fileId = $('Set File ID').first().json.file_id;\n  fileName = $('Set File ID').first().json.file_title;\n  proveedor = $('Identificar Proveedor').first().json.proveedor_detectado;\n} catch (e) {\n  console.error(\"‚ö†Ô∏è No se pudieron recuperar metadatos:\", e.message);\n  fileId = \"unknown\";\n  fileName = \"unknown\";\n  proveedor = \"OTROS\";\n}\n\nconsole.log(`üîÑ OCR Agregado: ${items.length} p√°ginas ‚Üí ${fullText.length} caracteres`);\n\n// ESTRUCTURA COMPATIBLE CON VECTORSTORE\nreturn {\n  json: {\n    pages: pagesArray, // ‚Üê Array de p√°ginas (requerido por Default Data Loader)\n    text: fullText, // ‚Üê Texto completo (backup)\n    \n    // Metadatos cr√≠ticos\n    file_id: fileId,\n    file_title: fileName,\n    proveedor: proveedor,\n    \n    // Marca de origen\n    origen_datos: \"OCR_TESSERACT\",\n    ocr_pages_processed: items.length,\n    ocr_total_chars: fullText.length\n  }\n};"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        2288,
        768
      ],
      "id": "17ee9f20-cc47-4063-8827-e427cd836ea2",
      "name": "Aggregate OCR Pages"
    },
    {
      "parameters": {
        "jsCode": "// =============================================\n// NODO: Format for Vectorstore (FINAL v2)\n// =============================================\n\n// 1. RECUPERAR CONTENIDO (Instrucci√≥n expl√≠cita)\n// Sacamos el texto y p√°ginas directamente del nodo Merge1 como indicaste\nlet fullText = \"\";\nlet totalPages = 1;\n\ntry {\n    const mergeData = $('Merge1').first().json;\n    \n    // Ruta espec√≠fica que pediste:\n    if (mergeData.pages && mergeData.pages[0]) {\n        fullText = mergeData.pages[0].text || \"\";\n    } else {\n        // Fallback por si acaso viene en 'text' directo\n        fullText = mergeData.text || \"\";\n    }\n    \n    // N√∫mero de p√°ginas\n    totalPages = mergeData.totalPages || 1;\n    \n} catch (e) {\n    console.log(\"‚ùå Error leyendo de Merge1. Verifica que el nodo se llame exactamente 'Merge1'\");\n}\n\n// 2. RECUPERAR CLASIFICACI√ìN (Del nodo LLM)\nlet proveedor = \"OTROS\";\nlet tipoEval = [\"Technical Evaluation\"];\n\ntry {\n    // Leemos la salida del clasificador\n    const llmData = $('Clasificador de Tipo de RFQ y Proveedor').first().json;\n    const output = llmData.output || llmData; // A veces est√° anidado\n\n    if (output.proveedor_detectado) proveedor = output.proveedor_detectado;\n    \n    if (output.tipos_detectados) {\n        tipoEval = Array.isArray(output.tipos_detectados) \n            ? output.tipos_detectados \n            : [output.tipos_detectados];\n    }\n} catch (e) {\n    console.log(\"‚ö†Ô∏è No se pudo leer la clasificaci√≥n del LLM, usando defaults.\");\n}\n\n// 3. RECUPERAR METADATOS DEL ARCHIVO\nlet fileId = \"unknown\";\nlet fileTitle = \"unknown\";\ntry {\n    const fileNode = $('Set File ID').first().json;\n    fileId = fileNode.file_id;\n    fileTitle = fileNode.file_title;\n} catch(e) {}\n\n// 4. GENERAR SALIDA\nconsole.log(`‚úÖ Procesando: ${fileTitle}`);\nconsole.log(`   Proveedor: ${proveedor}`);\nconsole.log(`   Tipos: ${JSON.stringify(tipoEval)}`);\n\nreturn {\n    json: {\n        text: fullText,\n        metadata: {\n            file_id: fileId,\n            file_title: fileTitle,\n            proveedor: proveedor,\n            tipo_evaluacion: tipoEval, // Se guarda como array [\"Technical\", \"Economical\"]\n            processed_at: new Date().toISOString(),\n            total_pages: totalPages\n        }\n    }\n};"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        3232,
        880
      ],
      "id": "14c02c18-58f4-42df-ab6d-314d7018daf5",
      "name": "Format for Vectorstore"
    },
    {
      "parameters": {
        "jsCode": "// =============================================\n// NODO: Expandir por Tipo de Evaluaci√≥n (RUTA FORZADA)\n// =============================================\n\n// 1. RECUPERAR DATOS (Mirando al nodo Format for Vectorstore)\nlet sourceData = {};\ntry {\n    // Usamos la ruta exacta que has validado\n    sourceData = $('Format for Vectorstore').first().json;\n} catch (e) {\n    console.log(\"‚ùå Error: No se encuentra el nodo 'Format for Vectorstore'\");\n    // Fallback de emergencia al input actual\n    sourceData = $input.first().json; \n}\n\n// 2. EXTRAER VARIABLES\nconst fullText = sourceData.text || \"‚ö†Ô∏è ERROR: Texto vac√≠o\";\nconst metadata = sourceData.metadata || {};\n\n// 3. NORMALIZAR TIPOS (L√≥gica de seguridad)\nlet tipos = metadata.tipo_evaluacion;\n\n// Si no hay tipos, ponemos uno por defecto\nif (!tipos) {\n    tipos = [\"Technical Evaluation\"];\n}\n\n// Conversi√≥n robusta a Array\nif (!Array.isArray(tipos)) {\n    if (typeof tipos === 'string') {\n        // Limpiamos caracteres raros y corchetes si vienen como string \"[A, B]\"\n        const cleanString = tipos.replace(/[\\[\\]\"]/g, ''); \n        if (cleanString.includes(',')) {\n            tipos = cleanString.split(',').map(t => t.trim());\n        } else {\n            tipos = [cleanString.trim()];\n        }\n    } else {\n        tipos = [tipos];\n    }\n}\n\nconst proveedor = metadata.proveedor || \"OTROS\";\n\n// LOGGING\nconsole.log(`üîÄ Procesando archivo: ${metadata.file_title}`);\nconsole.log(`   Fuente Texto: Format for Vectorstore`);\nconsole.log(`   Tama√±o Texto: ${fullText.length}`);\nconsole.log(`   Tipos: ${JSON.stringify(tipos)}`);\n\n// 4. GENERAR SALIDA (EXPANSI√ìN)\nreturn tipos.map((tipo, idx) => ({\n    json: {\n        // --- VARIABLES PARA EL FLUJO SIGUIENTE ---\n        tipo_evaluacion_actual: tipo, \n        proveedor_detectado: proveedor,\n        texto_oferta_completo: fullText, // Aqu√≠ va el texto recuperado de la fuente segura\n        \n        // --- METADATOS DE CONTROL ---\n        file_title: metadata.file_title,\n        file_id: metadata.file_id,\n        es_hibrido: tipos.length > 1,\n        indice_actual: idx + 1,\n        total_tipos: tipos.length\n    }\n}));"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        -144,
        176
      ],
      "id": "bab6c263-a14e-4561-b7ea-d94dfc91ad37",
      "name": "Expandir por Tipo de Evaluaci√≥n"
    },
    {
      "parameters": {
        "options": {}
      },
      "type": "n8n-nodes-base.splitInBatches",
      "typeVersion": 3,
      "position": [
        192,
        96
      ],
      "id": "fc929f94-d62c-42cb-8f6a-9a64d8cef32a",
      "name": "Loop Over Items1"
    },
    {
      "parameters": {
        "method": "POST",
        "url": "http://docling:5001/v1/convert/file",
        "sendBody": true,
        "contentType": "multipart-form-data",
        "bodyParameters": {
          "parameters": [
            {
              "parameterType": "formBinaryData",
              "name": "files",
              "inputDataFieldName": "data"
            }
          ]
        },
        "options": {
          "timeout": 300000
        }
      },
      "id": "550033f2-bb86-4e5e-a63a-a92862d882e6",
      "name": "Docling OCR",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.3,
      "position": [
        2080,
        672
      ],
      "retryOnFail": true
    },
    {
      "parameters": {
        "schemaType": "manual",
        "inputSchema": "{\n  \"type\": \"object\",\n  \"properties\": {\n    \"proveedor_detectado\": {\n      \"type\": \"string\",\n      \"description\": \"Nombre de la empresa proveedora (Ej: SACYR, IDOM, etc.)\"\n    },\n    \"tipos_detectados\": {\n      \"type\": \"array\",\n      \"items\": {\n        \"type\": \"string\",\n        \"enum\": [\n          \"Technical Evaluation\",\n          \"Economical Evaluation\",\n          \"Pre-FEED Deliverables\",\n          \"FEED Deliverables\"\n        ]\n      },\n      \"description\": \"Lista de tipos de oferta detectados en el documento.\"\n    },\n    \"razonamiento\": {\n      \"type\": \"string\",\n      \"description\": \"Breve explicaci√≥n de por qu√© se eligieron esos tipos.\"\n    }\n  },\n  \"required\": [\n    \"proveedor_detectado\",\n    \"tipos_detectados\"\n  ]\n}"
      },
      "type": "@n8n/n8n-nodes-langchain.outputParserStructured",
      "typeVersion": 1.3,
      "position": [
        3008,
        1104
      ],
      "id": "a99e2d55-1319-4350-a380-adc2e1be0500",
      "name": "Structured Output Parser"
    },
    {
      "parameters": {},
      "type": "n8n-nodes-base.merge",
      "typeVersion": 3.2,
      "position": [
        2496,
        880
      ],
      "id": "592938cc-5475-406a-ba06-fe416656afe2",
      "name": "Merge1"
    },
    {
      "parameters": {
        "promptType": "define",
        "text": "=### INPUT A ANALIZAR\nNombre archivo: {{ $json.fileName }}\nTexto (Inicio del documento): \n{{ $json.pages[0].text }}",
        "hasOutputParser": true,
        "messages": {
          "messageValues": [
            {
              "message": "=### TAREA: CLASIFICACI√ìN ESTRICTA DE DOCUMENTO RFQ\n\nEres un auditor senior de documentaci√≥n de ingenier√≠a con criterios extremadamente conservadores.\n\n---\n\n## TAREA 1: DETECTAR Y NORMALIZAR PROVEEDOR\n\nBusca el nombre de la empresa en el texto o el nombre del archivo.\n\n| Texto encontrado (Variaciones) | VALOR OFICIAL (Output) |\n|--------------------------------|------------------------|\n| \"T√©cnicas Reunidas\", \"TR\", \"Initec\", \"Tecnicas Reunidas\" | TECNICASREUNIDAS |\n| \"Empresarios Agrupados\", \"EA\", \"GHESA\", \"E.A.\" | EA |\n| \"IDOM\", \"Idom Consulting\" | IDOM |\n| \"SACYR\", \"Sacyr Fluor\", \"Sacyr Industrial\" | SACYR |\n| \"SENER\", \"Sener Engineering\" | SENER |\n| \"TRESCA\", \"Tresca Ingenieria\" | TRESCA |\n| \"WORLEY\", \"Worley Parsons\" | WORLEY |\n| Cualquier otro o desconocido | OTROS |\n\n---\n\n## TAREA 2: CLASIFICAR TIPO DE OFERTA\n\n### REGLA DE ORO: \"SI NO EST√ÅS 100% SEGURO, NO LO INCLUYAS\"\n\n---\n\n### 1. \"Economical Evaluation\" (Econ√≥mica)\n\n**EVIDENCIA OBLIGATORIA (Todas deben cumplirse):**\n- DEBE contener tablas con columnas de precios expl√≠citos\n- DEBE mostrar monedas (EUR, USD, $) o unidades de costo (EUR/hora, $/m¬≥)\n- DEBE tener l√≠neas individuales de precio por concepto\n\n**EXCLUSIONES AUTOM√ÅTICAS:**\n- Si solo menciona \"presupuesto estimado\" sin desglose ‚Üí NO es econ√≥mica\n- Si dice \"sujeto a cotizaci√≥n posterior\" ‚Üí NO es econ√≥mica\n- Si solo tiene subtotales sin detalle ‚Üí NO es econ√≥mica\n- Si solo describe alcance sin n√∫meros con moneda ‚Üí NO es econ√≥mica\n\n**Ejemplo de evidencia v√°lida:**ConceptoCantidadPrecio Unit.TotalIngenier√≠a B√°sica145.000 EUR45.000‚Ç¨Ingeniero Senior200 h85 EUR/h17.000‚Ç¨\n\n---\n\n### 2. \"Technical Evaluation\" (T√©cnica)\n\n**EVIDENCIA V√ÅLIDA:**\n- Metodolog√≠a de trabajo o procedimientos\n- Organigramas, organizaci√≥n del equipo\n- Descripci√≥n de alcance t√©cnico (qu√© se har√° y c√≥mo)\n- Planificaci√≥n, cronogramas, hitos\n- Especificaciones t√©cnicas, normativas aplicables\n- Diagramas de proceso, P&IDs, esquemas\n\n**LO QUE NO ES T√âCNICA:**\n- Solo una lista de documentos a entregar ‚Üí Probablemente sea Deliverables\n- Solo precios ‚Üí Es Econ√≥mica\n- Solo √≠ndice de documentos sin contenido t√©cnico ‚Üí No clasificar\n\n**Si encuentras:** Descripci√≥n de trabajo, enfoque metodol√≥gico, capacidades t√©cnicas ‚Üí S√ç es Technical\n\n---\n\n### 3. \"Pre-FEED Deliverables\" o \"FEED Deliverables\"\n\n**CRITERIO ULTRA-RESTRICTIVO**\n\n**SOLO clasifica como Deliverables si cumple TODOS estos criterios:**\n\n1. **DEBE contener una lista numerada o tabulada de documentos espec√≠ficos a entregar**\n   - Ejemplos v√°lidos:\n     - \"MDR-001 - Process Flow Diagram\"\n     - \"DOC-PRE-FEED-12 - Equipment List\"\n     - \"Plano de Situaci√≥n - Rev. A\"\n\n2. **DEBE especificar c√≥digos, revisiones o identificadores √∫nicos de documentos**\n   - V√°lido: \"P&ID-100-A, rev. 0\"\n   - Inv√°lido: \"Se entregar√°n los P&IDs necesarios\"\n\n3. **DEBE ser claramente un inventario/matriz de documentos (Document Register / MDR)**\n   - Si parece un √≠ndice de contenidos ‚Üí NO\n   - Si describe qu√© contienen los documentos ‚Üí NO\n   - Si solo menciona \"entregables\" gen√©ricamente ‚Üí NO\n\n**EXCLUSIONES CR√çTICAS:**\n- \"Se entregar√° documentaci√≥n t√©cnica completa\" ‚Üí NO es Deliverables (es descripci√≥n gen√©rica)\n- \"Incluye dise√±os de ingenier√≠a, estudios, especificaciones\" ‚Üí NO es Deliverables (es alcance t√©cnico)\n- Listado de actividades o fases ‚Üí NO es Deliverables (es planificaci√≥n)\n- Descripci√≥n de metodolog√≠a de documentaci√≥n ‚Üí NO es Deliverables\n\n**Diferenciaci√≥n Pre-FEED vs FEED:**\n- **Pre-FEED Deliverables:** Documentos de estudios preliminares, conceptuales, viabilidad, alcances de orden de magnitud (+/- 30%)\n- **FEED Deliverables:** Documentos de ingenier√≠a b√°sica detallada, especificaciones de compra, estimados Clase III (+/- 15%)\n\n**Ejemplo de documento que S√ç es Deliverables:**MATRIZ DE ENTREGABLES - FASE FEEDC√≥digo DocT√≠tuloRevFormatoFEED-P&ID-001P&ID General Process0DWGFEED-EL-100Equipment List - Main ProcessAXLSXFEED-PFD-01Process Flow Diagram0PDF\n\n**Ejemplo de documento que NO es Deliverables (es Technical):**\"La ingenier√≠a de detalle incluir√°:\n\nDise√±o de sistemas de tuber√≠as\nEspecificaciones de equipos\nC√°lculos estructurales\nPlanos de disposici√≥n general\nEstos documentos se desarrollar√°n seg√∫n normativa ASME...\"\n‚Üí Esto es descripci√≥n de alcance t√©cnico, NO un listado de deliverables.\n\n---\n\n## REGLAS DE COMBINACI√ìN\n\n**Combinaciones v√°lidas:**\n- [\"Technical Evaluation\", \"Economical Evaluation\"] - Oferta t√©cnico-econ√≥mica completa\n- [\"Technical Evaluation\"] - Solo metodolog√≠a y alcance\n- [\"Economical Evaluation\"] - Solo precios\n- [\"Pre-FEED Deliverables\"] o [\"FEED Deliverables\"] - Solo matriz de documentos\n- [\"Technical Evaluation\", \"FEED Deliverables\"] - Descripci√≥n t√©cnica + lista formal de docs\n\n**Combinaciones sospechosas (verificar dos veces):**\n- Si dudas entre Technical y Deliverables ‚Üí Es Technical (el 90% de las veces)\n- Si ves contenido t√©cnico + lista gen√©rica de \"entregables\" ‚Üí Solo Technical\n- Solo marca Deliverables si ves c√≥digos tipo \"DOC-FEED-001\" o tablas MDR\n\n**EN CASO DE DUDA:** Clasifica como [\"Technical Evaluation\"] √∫nicamente.\n\n---\n\n## FORMATO DE SALIDA (JSON √öNICO)\n```json{\n\"proveedor_detectado\": \"VALOR_OFICIAL\",\n\"tipos_detectados\": [\"Technical Evaluation\"],\n\"razonamiento\": \"Explica qu√© evidencia espec√≠fica encontraste. Si NO clasificaste como Deliverables, indica por qu√© no cumpl√≠a los criterios ultra-restrictivos.\"\n}\n\n**REGLAS DE RAZONAMIENTO:**\n- Si clasificaste como Deliverables: Cita el c√≥digo de documento o tabla MDR que viste\n- Si NO clasificaste como Deliverables: Explica qu√© elemento falt√≥ (c√≥digos de doc, matriz formal, etc.)\n- Si clasificaste como Economical: Menciona d√≥nde viste precios con moneda\n- Si clasificaste como Technical: Indica qu√© tipo de contenido t√©cnico predomina\n\n**EJEMPLOS DE RAZONAMIENTO:**\n\nCORRECTO:\n```json{\n\"razonamiento\": \"Clasificado como Technical √∫nicamente. El documento describe metodolog√≠a de trabajo, organigrama y alcance t√©cnico (secciones 2-5). Aunque menciona 'documentaci√≥n a entregar', no presenta matriz MDR ni c√≥digos de documentos formales.\"\n}\n\nINCORRECTO:\n```json{\n\"razonamiento\": \"Es t√©cnico y tiene deliverables.\"\n}"
            }
          ]
        },
        "batching": {}
      },
      "type": "@n8n/n8n-nodes-langchain.chainLlm",
      "typeVersion": 1.8,
      "position": [
        2768,
        880
      ],
      "id": "3bc06568-3566-4e0f-a303-f5294cc3edc9",
      "name": "Clasificador de Tipo de RFQ y Proveedor"
    },
    {
      "parameters": {
        "jsCode": "const items = $input.all();\n\nreturn items.map(item => ({\n    json: {\n        ...item.json, // Mantiene todos los datos originales (incluido tipo_evaluacion)\n        \n        // Aqu√≠ est√° la correcci√≥n: Usamos dos puntos, no el igual.\n        reiniciar_bucle: true \n    }\n}));\n"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        896,
        32
      ],
      "id": "920d29f5-0a56-4750-88ef-8bccfcbf8195",
      "name": "Reset Items"
    },
    {
      "parameters": {
        "operation": "get",
        "dataTableId": {
          "__rl": true,
          "value": "jIatxsggJ92wzApV",
          "mode": "list",
          "cachedResultName": "Prueba",
          "cachedResultUrl": "/projects/vcLkFgTx7CPaMMKV/datatables/jIatxsggJ92wzApV"
        },
        "returnAll": "={{ /*n8n-auto-generated-fromAI-override*/ $fromAI('Return_All', ``, 'boolean') }}"
      },
      "type": "n8n-nodes-base.dataTableTool",
      "typeVersion": 1,
      "position": [
        -1024,
        336
      ],
      "id": "730a07ff-26e9-48ab-863e-8b43b50146d8",
      "name": "consultar_tabla_evaluacion1"
    },
    {
      "parameters": {
        "options": {
          "temperature": 0
        }
      },
      "type": "@n8n/n8n-nodes-langchain.lmChatOpenRouter",
      "typeVersion": 1,
      "position": [
        1856,
        320
      ],
      "id": "821d3436-6497-4efc-ab39-2985027a3c4a",
      "name": "OpenRouter Chat Model1",
      "credentials": {
        "openRouterApi": {
          "id": "qDD6QT1T2s8YMdby",
          "name": "OpenRouter account"
        }
      }
    },
    {
      "parameters": {
        "options": {
          "temperature": 0.1
        }
      },
      "type": "@n8n/n8n-nodes-langchain.lmChatOpenRouter",
      "typeVersion": 1,
      "position": [
        2464,
        1104
      ],
      "id": "b7a5612c-66e6-4a30-b09f-bf6c45222fca",
      "name": "OpenRouter Chat Model2",
      "credentials": {
        "openRouterApi": {
          "id": "qDD6QT1T2s8YMdby",
          "name": "OpenRouter account"
        }
      }
    },
    {
      "parameters": {
        "model": "nomic-embed-text:latest"
      },
      "type": "@n8n/n8n-nodes-langchain.embeddingsOllama",
      "typeVersion": 1,
      "position": [
        3408,
        1104
      ],
      "id": "2deb6f2f-9cb4-4b77-96ed-d9a58b36f472",
      "name": "Embeddings Ollama",
      "credentials": {
        "ollamaApi": {
          "id": "Qy5SfLiSYwx3Okjy",
          "name": "Ollama account"
        }
      }
    },
    {
      "parameters": {
        "respondWith": "allIncomingItems",
        "options": {}
      },
      "type": "n8n-nodes-base.respondToWebhook",
      "typeVersion": 1.5,
      "position": [
        992,
        -176
      ],
      "id": "71f38dab-17c8-4a60-80b8-7f7c9aebdd4b",
      "name": "Respond to Webhook"
    },
    {
      "parameters": {
        "httpMethod": "POST",
        "path": "rfq",
        "responseMode": "responseNode",
        "options": {}
      },
      "type": "n8n-nodes-base.webhook",
      "typeVersion": 2.1,
      "position": [
        -416,
        880
      ],
      "id": "903694d5-265b-49dc-a8de-3497b29d0ed3",
      "name": "Webhook",
      "webhookId": "2a435cf4-d7c8-4148-8d9f-189c3b620e8f"
    },
    {
      "parameters": {
        "model": "devstral-latest",
        "options": {
          "temperature": 0.1
        }
      },
      "type": "@n8n/n8n-nodes-langchain.lmChatMistralCloud",
      "typeVersion": 1,
      "position": [
        2720,
        1104
      ],
      "id": "6b5e55fd-1648-483e-a2f8-4ec102d99249",
      "name": "Mistral Cloud Chat Model",
      "credentials": {
        "mistralCloudApi": {
          "id": "tYcsXUVtTWeJIEDg",
          "name": "Mistral Cloud account"
        }
      }
    },
    {
      "parameters": {
        "jsCode": "// =============================================\n// NODO: Convertir Base64 a Binary Data (CORREGIDO v3)\n// =============================================\n\n// LEER DIRECTAMENTE DEL NODO \"Set File ID\"\nlet inputData;\ntry {\n    inputData = $('Set File ID').first().json;\n} catch (e) {\n    throw new Error(\"‚ùå No se puede acceder al nodo 'Set File ID'\");\n}\n\nconst base64Data = inputData.file_binary;\n\n// --- VALIDACI√ìN CR√çTICA ---\nif (!base64Data || base64Data === \"\") {\n    console.error(\"‚ùå ERROR: file_binary est√° vac√≠o\");\n    console.error(\"Datos en 'Set File ID':\", Object.keys(inputData));\n    console.error(\"file_id:\", inputData.file_id);\n    console.error(\"file_title:\", inputData.file_title);\n    \n    throw new Error(\n        \"‚ùå CR√çTICO: 'file_binary' no existe en 'Set File ID'. \" +\n        \"Verifica la configuraci√≥n del nodo.\"\n    );\n}\n\n// Validar que sea string\nif (typeof base64Data !== 'string') {\n    throw new Error(`‚ùå ERROR: 'file_binary' debe ser string, es ${typeof base64Data}`);\n}\n\n// Logging\nconsole.log(\"‚úÖ file_binary recibido de 'Set File ID'\");\nconsole.log(`   ‚îú‚îÄ Longitud: ${base64Data.length} caracteres`);\nconsole.log(`   ‚îú‚îÄ Archivo: ${inputData.file_title}`);\n\n// Convertir base64 a binary\nlet binaryData;\ntry {\n    binaryData = Buffer.from(base64Data, 'base64');\n} catch (e) {\n    throw new Error(`‚ùå ERROR decodificando base64: ${e.message}`);\n}\n\n// Validar tama√±o\nif (binaryData.length === 0) {\n    throw new Error(\"‚ùå ERROR: Archivo decodificado vac√≠o (0 bytes)\");\n}\n\nconsole.log(`‚úÖ Binary generado: ${binaryData.length} bytes`);\n\n// Retornar formato n8n\nreturn {\n    json: {\n        file_id: inputData.file_id,\n        file_title: inputData.file_title,\n        file_url: inputData.file_url || \"unknown\"\n    },\n    binary: {\n        data: {\n            data: binaryData.toString('base64'),\n            mimeType: 'application/pdf',\n            fileName: inputData.file_title || 'document.pdf',\n            fileSize: binaryData.length\n        }\n    }\n};"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        896,
        880
      ],
      "id": "2ea6a507-efd6-4159-8fea-78337936d07d",
      "name": "Base64 a Binary"
    },
    {
      "parameters": {
        "jsCode": "// =============================================\n// NODO: Convertir Base64 a Binary Data (CORREGIDO v3)\n// =============================================\n\n// LEER DIRECTAMENTE DEL NODO \"Set File ID\"\nlet inputData;\ntry {\n    inputData = $('Set File ID').first().json;\n} catch (e) {\n    throw new Error(\"‚ùå No se puede acceder al nodo 'Set File ID'\");\n}\n\nconst base64Data = inputData.file_binary;\n\n// --- VALIDACI√ìN CR√çTICA ---\nif (!base64Data || base64Data === \"\") {\n    console.error(\"‚ùå ERROR: file_binary est√° vac√≠o\");\n    console.error(\"Datos en 'Set File ID':\", Object.keys(inputData));\n    console.error(\"file_id:\", inputData.file_id);\n    console.error(\"file_title:\", inputData.file_title);\n    \n    throw new Error(\n        \"‚ùå CR√çTICO: 'file_binary' no existe en 'Set File ID'. \" +\n        \"Verifica la configuraci√≥n del nodo.\"\n    );\n}\n\n// Validar que sea string\nif (typeof base64Data !== 'string') {\n    throw new Error(`‚ùå ERROR: 'file_binary' debe ser string, es ${typeof base64Data}`);\n}\n\n// Logging\nconsole.log(\"‚úÖ file_binary recibido de 'Set File ID'\");\nconsole.log(`   ‚îú‚îÄ Longitud: ${base64Data.length} caracteres`);\nconsole.log(`   ‚îú‚îÄ Archivo: ${inputData.file_title}`);\n\n// Convertir base64 a binary\nlet binaryData;\ntry {\n    binaryData = Buffer.from(base64Data, 'base64');\n} catch (e) {\n    throw new Error(`‚ùå ERROR decodificando base64: ${e.message}`);\n}\n\n// Validar tama√±o\nif (binaryData.length === 0) {\n    throw new Error(\"‚ùå ERROR: Archivo decodificado vac√≠o (0 bytes)\");\n}\n\nconsole.log(`‚úÖ Binary generado: ${binaryData.length} bytes`);\n\n// Retornar formato n8n\nreturn {\n    json: {\n        file_id: inputData.file_id,\n        file_title: inputData.file_title,\n        file_url: inputData.file_url || \"unknown\"\n    },\n    binary: {\n        data: {\n            data: binaryData.toString('base64'),\n            mimeType: 'application/pdf',\n            fileName: inputData.file_title || 'document.pdf',\n            fileSize: binaryData.length\n        }\n    }\n};"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        1888,
        768
      ],
      "id": "b73e9f70-e5b7-4434-854e-ad7af0da4d70",
      "name": "Base64 a Binary1"
    },
    {
      "parameters": {
        "operation": "get",
        "dataTableId": {
          "__rl": true,
          "value": "jIatxsggJ92wzApV",
          "mode": "list",
          "cachedResultName": "Prueba",
          "cachedResultUrl": "/projects/vcLkFgTx7CPaMMKV/datatables/jIatxsggJ92wzApV"
        },
        "returnAll": true
      },
      "type": "n8n-nodes-base.dataTable",
      "typeVersion": 1.1,
      "position": [
        752,
        -176
      ],
      "id": "ac8f76d5-c768-4fca-b212-c33197796a46",
      "name": "Get row(s)"
    },
    {
      "parameters": {
        "jsCode": "// Esto borra cualquier dato residual del loop y dispara el siguiente nodo 1 sola vez\nreturn [{}];"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        512,
        -176
      ],
      "id": "cedea81a-0b7f-46b4-954d-48b040101ae0",
      "name": "Reset de valores"
    },
    {
      "parameters": {
        "respondWith": "allIncomingItems",
        "options": {}
      },
      "type": "n8n-nodes-base.respondToWebhook",
      "typeVersion": 1.5,
      "position": [
        -1024,
        112
      ],
      "id": "9e9ce817-f622-44c3-82ac-24552d47da94",
      "name": "Respond to Webhook1"
    },
    {
      "parameters": {
        "jsCode": "// =============================================\n// NODO: Generate Stable ID (SIN CRYPTO MODULE)\n// =============================================\n\n// Funci√≥n hash simple (no requiere m√≥dulos externos)\nfunction simpleHash(str) {\n  let hash = 0;\n  for (let i = 0; i < str.length; i++) {\n    const char = str.charCodeAt(i);\n    hash = ((hash << 5) - hash) + char;\n    hash = hash & hash; // Convertir a 32bit integer\n  }\n  // Convertir a hex positivo de 16 caracteres\n  return Math.abs(hash).toString(16).padStart(16, '0').substring(0, 16);\n}\n\n// 1. EXTRAER DATOS DEL WEBHOOK\nconst body = $json.body;\n\nconst originalFileId = body.file_id || \"unknown\";\nconst fileTitle = body.file_title || \"unknown.pdf\";\nconst fileBinary = body.file_binary || \"\";\n\n// 2. GENERAR ID ESTABLE (HASH DEL NOMBRE DEL ARCHIVO)\n// Normalizamos el nombre: lowercase y sin espacios extras\nconst normalizedTitle = fileTitle.toLowerCase().trim();\nconst stableId = simpleHash(normalizedTitle);\n\n// 3. LOGS PARA DEBUG\nconsole.log(\"=== GENERACI√ìN DE ID ESTABLE ===\");\nconsole.log(`Original ID: ${originalFileId}`);\nconsole.log(`Nombre archivo: ${fileTitle}`);\nconsole.log(`Nombre normalizado: ${normalizedTitle}`);\nconsole.log(`ID ESTABLE generado: ${stableId}`);\nconsole.log(`Tama√±o binary: ${fileBinary ? fileBinary.length : 0} caracteres`);\n\n// 4. RETORNAR BODY CON ID ESTABLE\nreturn {\n  json: {\n    body: {\n      ...body,\n      file_id: stableId,\n      file_id_original: originalFileId\n    }\n  }\n};"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        -176,
        880
      ],
      "id": "56920ce1-3c27-4f9c-ad91-c9dbee3e1eba",
      "name": "Code in JavaScript1"
    },
    {
      "parameters": {
        "httpMethod": "POST",
        "path": "chat-ofertas",
        "options": {}
      },
      "type": "n8n-nodes-base.webhook",
      "typeVersion": 2.1,
      "position": [
        -2176,
        208
      ],
      "id": "12817d6e-c8d9-49da-951b-091e5b67e24a",
      "name": "Webhook1",
      "webhookId": "014a6be2-a8d5-4dd3-85f2-ea5e7d0ba092"
    },
    {
      "parameters": {
        "operation": "pdf",
        "options": {}
      },
      "type": "n8n-nodes-base.extractFromFile",
      "typeVersion": 1.1,
      "position": [
        896,
        2224
      ],
      "id": "cbdf4698-0c48-4341-8edc-827b258b009a",
      "name": "Extract from File1"
    },
    {
      "parameters": {
        "model": "openai/gpt-oss-20b",
        "options": {}
      },
      "type": "@n8n/n8n-nodes-langchain.lmChatGroq",
      "typeVersion": 1,
      "position": [
        -2016,
        512
      ],
      "id": "ca6a0e39-c000-4e65-90b5-722ab76bf6e1",
      "name": "Groq Chat Model",
      "credentials": {
        "groqApi": {
          "id": "FIDKJ20ohwstoZTe",
          "name": "Groq account"
        }
      }
    },
    {
      "parameters": {
        "model": "nomic-embed-text:latest"
      },
      "type": "@n8n/n8n-nodes-langchain.embeddingsOllama",
      "typeVersion": 1,
      "position": [
        -1232,
        544
      ],
      "id": "65a8c842-2dba-403d-af46-ff5fcaf5aa7b",
      "name": "Embeddings Ollama2",
      "credentials": {
        "ollamaApi": {
          "id": "Qy5SfLiSYwx3Okjy",
          "name": "Ollama account"
        }
      }
    }
  ],
  "connections": {
    "Webhook RFQ": {
      "main": [
        [
          {
            "node": "Generate Stable ID RFQ",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Validar Contenido PDF RFQ": {
      "main": [
        [
          {
            "node": "Clasificador Tipo RFQ",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Base64 a Binary RFQ": {
      "main": [
        [
          {
            "node": "Extract from File1",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Generate Stable ID RFQ": {
      "main": [
        [
          {
            "node": "Set File ID2",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Docling OCR RFQ": {
      "main": [
        []
      ]
    },
    "Default Data Loader RFQ": {
      "ai_document": [
        [
          {
            "node": "Insert RFQ Vectorstore",
            "type": "ai_document",
            "index": 0
          }
        ]
      ]
    },
    "Text Splitter RFQ": {
      "ai_textSplitter": [
        [
          {
            "node": "Default Data Loader RFQ",
            "type": "ai_textSplitter",
            "index": 0
          }
        ]
      ]
    },
    "Insert RFQ Vectorstore": {
      "main": [
        [
          {
            "node": "Expandir por Tipo RFQ",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Format RFQ for Vectorstore": {
      "main": [
        [
          {
            "node": "Insert RFQ Vectorstore",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Embeddings Ollama RFQ": {
      "ai_embedding": [
        [
          {
            "node": "Insert RFQ Vectorstore",
            "type": "ai_embedding",
            "index": 0
          }
        ]
      ]
    },
    "Loop Over Items RFQ": {
      "main": [
        [
          {
            "node": "Loop Tipos RFQ",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Preparar Items para LLM",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Preparar Items para LLM": {
      "main": [
        [
          {
            "node": "LLM Extractor Requisitos RFQ",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Parsear Requisitos RFQ": {
      "main": [
        [
          {
            "node": "Update rfq_requisito",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "LLM Extractor Requisitos RFQ": {
      "main": [
        [
          {
            "node": "Parsear Requisitos RFQ",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Get Items por Tipo": {
      "main": [
        [
          {
            "node": "Reset Items RFQ",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Expandir por Tipo RFQ": {
      "main": [
        [
          {
            "node": "Loop Tipos RFQ",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Loop Tipos RFQ": {
      "main": [
        [
          {
            "node": "Respond Webhook RFQ",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Get Items por Tipo",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Reset Items RFQ": {
      "main": [
        [
          {
            "node": "Loop Over Items RFQ",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "OpenRouter Chat Model RFQ": {
      "ai_languageModel": [
        [
          {
            "node": "LLM Extractor Requisitos RFQ",
            "type": "ai_languageModel",
            "index": 0
          }
        ]
      ]
    },
    "Update rfq_requisito": {
      "main": [
        [
          {
            "node": "Loop Over Items RFQ",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Structured Output Parser RFQ": {
      "ai_outputParser": [
        [
          {
            "node": "Clasificador Tipo RFQ",
            "type": "ai_outputParser",
            "index": 0
          }
        ]
      ]
    },
    "Clasificador Tipo RFQ": {
      "main": [
        [
          {
            "node": "Format RFQ for Vectorstore",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Mistral Cloud RFQ": {
      "ai_languageModel": [
        [
          {
            "node": "Clasificador Tipo RFQ",
            "type": "ai_languageModel",
            "index": 0
          }
        ]
      ]
    },
    "Insert Document Metadata2": {
      "main": [
        [
          {
            "node": "Base64 a Binary RFQ",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Delete Old Doc Rows2": {
      "main": [
        [
          {
            "node": "Insert Document Metadata2",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Set File ID2": {
      "main": [
        [
          {
            "node": "Delete Old Doc Rows2",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Loop Over Items": {
      "main": [
        [
          {
            "node": "Loop Over Items1",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Code in JavaScript",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Merge": {
      "main": [
        [
          {
            "node": "Loop Over Items",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Code in JavaScript": {
      "main": [
        [
          {
            "node": "LLM Chain",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Postgres Chat Memory": {
      "ai_memory": [
        [
          {
            "node": "RAG AI Agent",
            "type": "ai_memory",
            "index": 0
          }
        ]
      ]
    },
    "When chat message received": {
      "main": [
        [
          {
            "node": "RAG AI Agent",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "RAG AI Agent": {
      "main": [
        [
          {
            "node": "Respond to Webhook1",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "List Documents": {
      "ai_tool": [
        [
          {
            "node": "RAG AI Agent",
            "type": "ai_tool",
            "index": 0
          }
        ]
      ]
    },
    "Get File Contents": {
      "ai_tool": [
        [
          {
            "node": "RAG AI Agent",
            "type": "ai_tool",
            "index": 0
          }
        ]
      ]
    },
    "Query Document Rows": {
      "ai_tool": [
        [
          {
            "node": "RAG AI Agent",
            "type": "ai_tool",
            "index": 0
          }
        ]
      ]
    },
    "OpenRouter Chat Model": {
      "ai_languageModel": [
        []
      ]
    },
    "consultar_ofertas": {
      "ai_tool": [
        [
          {
            "node": "RAG AI Agent",
            "type": "ai_tool",
            "index": 0
          }
        ]
      ]
    },
    "Parsear y Preparar Update": {
      "main": [
        [
          {
            "node": "Switch",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "LLM Chain": {
      "main": [
        [
          {
            "node": "Parsear y Preparar Update",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Switch": {
      "main": [
        [
          {
            "node": "Update RFQ TR",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Update RFQ IDOM",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Update RFQ SACYR",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Update RFQ EA",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Update RFQ SENER",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Update RFQ TRESCA",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Update RFQ WORLEY",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Update RFQ TR": {
      "main": [
        [
          {
            "node": "Merge",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Update RFQ IDOM": {
      "main": [
        [
          {
            "node": "Merge",
            "type": "main",
            "index": 1
          }
        ]
      ]
    },
    "Update RFQ SACYR": {
      "main": [
        [
          {
            "node": "Merge",
            "type": "main",
            "index": 2
          }
        ]
      ]
    },
    "Update RFQ EA": {
      "main": [
        [
          {
            "node": "Merge",
            "type": "main",
            "index": 3
          }
        ]
      ]
    },
    "Update RFQ SENER": {
      "main": [
        [
          {
            "node": "Merge",
            "type": "main",
            "index": 4
          }
        ]
      ]
    },
    "Update RFQ TRESCA": {
      "main": [
        [
          {
            "node": "Merge",
            "type": "main",
            "index": 5
          }
        ]
      ]
    },
    "Update RFQ WORLEY": {
      "main": [
        [
          {
            "node": "Merge",
            "type": "main",
            "index": 6
          }
        ]
      ]
    },
    "Insert Document Metadata": {
      "main": [
        [
          {
            "node": "Base64 a Binary",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Delete Old Doc Rows": {
      "main": [
        [
          {
            "node": "Insert Document Metadata",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Set File ID": {
      "main": [
        [
          {
            "node": "Delete Old Doc Rows",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Default Data Loader": {
      "ai_document": [
        [
          {
            "node": "Insert into Supabase Vectorstore",
            "type": "ai_document",
            "index": 0
          }
        ]
      ]
    },
    "Recursive Character Text Splitter": {
      "ai_textSplitter": [
        [
          {
            "node": "Default Data Loader",
            "type": "ai_textSplitter",
            "index": 0
          }
        ]
      ]
    },
    "Get RFQ Items": {
      "main": [
        [
          {
            "node": "Reset Items",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Insert into Supabase Vectorstore": {
      "main": [
        [
          {
            "node": "Expandir por Tipo de Evaluaci√≥n",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Validar Contenido PDF": {
      "main": [
        [
          {
            "node": "¬øNecesita OCR?",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Extract from File": {
      "main": [
        [
          {
            "node": "Validar Contenido PDF",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "¬øNecesita OCR?": {
      "main": [
        [
          {
            "node": "Base64 a Binary1",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Merge1",
            "type": "main",
            "index": 1
          }
        ]
      ]
    },
    "Aggregate OCR Pages": {
      "main": [
        [
          {
            "node": "Merge1",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Format for Vectorstore": {
      "main": [
        [
          {
            "node": "Insert into Supabase Vectorstore",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Expandir por Tipo de Evaluaci√≥n": {
      "main": [
        [
          {
            "node": "Loop Over Items1",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Loop Over Items1": {
      "main": [
        [
          {
            "node": "Reset de valores",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Get RFQ Items",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Docling OCR": {
      "main": [
        [
          {
            "node": "Aggregate OCR Pages",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Structured Output Parser": {
      "ai_outputParser": [
        [
          {
            "node": "Clasificador de Tipo de RFQ y Proveedor",
            "type": "ai_outputParser",
            "index": 0
          }
        ]
      ]
    },
    "Merge1": {
      "main": [
        [
          {
            "node": "Clasificador de Tipo de RFQ y Proveedor",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Clasificador de Tipo de RFQ y Proveedor": {
      "main": [
        [
          {
            "node": "Format for Vectorstore",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Reset Items": {
      "main": [
        [
          {
            "node": "Loop Over Items",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "consultar_tabla_evaluacion1": {
      "ai_tool": [
        [
          {
            "node": "RAG AI Agent",
            "type": "ai_tool",
            "index": 0
          }
        ]
      ]
    },
    "OpenRouter Chat Model1": {
      "ai_languageModel": [
        [
          {
            "node": "LLM Chain",
            "type": "ai_languageModel",
            "index": 0
          }
        ]
      ]
    },
    "Embeddings Ollama": {
      "ai_embedding": [
        [
          {
            "node": "Insert into Supabase Vectorstore",
            "type": "ai_embedding",
            "index": 0
          }
        ]
      ]
    },
    "Webhook": {
      "main": [
        [
          {
            "node": "Code in JavaScript1",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Mistral Cloud Chat Model": {
      "ai_languageModel": [
        [
          {
            "node": "Clasificador de Tipo de RFQ y Proveedor",
            "type": "ai_languageModel",
            "index": 0
          }
        ]
      ]
    },
    "Base64 a Binary": {
      "main": [
        [
          {
            "node": "Extract from File",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Base64 a Binary1": {
      "main": [
        [
          {
            "node": "Docling OCR",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Get row(s)": {
      "main": [
        [
          {
            "node": "Respond to Webhook",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Reset de valores": {
      "main": [
        [
          {
            "node": "Get row(s)",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Code in JavaScript1": {
      "main": [
        [
          {
            "node": "Set File ID",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Webhook1": {
      "main": [
        [
          {
            "node": "RAG AI Agent",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Extract from File1": {
      "main": [
        [
          {
            "node": "Validar Contenido PDF RFQ",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Groq Chat Model": {
      "ai_languageModel": [
        [
          {
            "node": "RAG AI Agent",
            "type": "ai_languageModel",
            "index": 0
          }
        ]
      ]
    },
    "Embeddings Ollama2": {
      "ai_embedding": [
        [
          {
            "node": "consultar_ofertas",
            "type": "ai_embedding",
            "index": 0
          }
        ]
      ]
    }
  },
  "pinData": {
    "Clasificador Tipo RFQ": [
      {
        "output": {
          "tipos_detectados": [
            "Pre-FEED Deliverables"
          ],
          "razonamiento": "El documento es un anexo de una RFQ que detalla una lista de entregables para la fase Pre-FEED de un proyecto de planta de hidr√≥geno. Incluye requisitos t√©cnicos como c√≥digos y est√°ndares de ejecuci√≥n del proyecto, estudios t√©cnicos y econ√≥micos, y una lista detallada de documentos y estudios a entregar en la fase Pre-FEED, como estudios de proceso, ingenier√≠a mec√°nica, el√©ctrica, y de instrumentaci√≥n, entre otros. No se identifican requisitos econ√≥micos espec√≠ficos ni entregables para la fase FEED."
        }
      }
    ]
  },
  "meta": {
    "templateCredsSetupCompleted": true,
    "instanceId": "1fc4900212c9d62621a09257b15453fd8c3a567221719830af6b072b6c697fd7"
  }
}