{
  "nodes": [
    {
      "parameters": {
        "operation": "getAll",
        "tableId": "rfq_items_master",
        "returnAll": true,
        "matchType": "allFilters",
        "filters": {
          "conditions": [
            {
              "keyName": "project_id",
              "condition": "eq",
              "keyValue": "={{ $('Set Input Params1').first().json.project_id }}"
            }
          ]
        }
      },
      "type": "n8n-nodes-base.supabase",
      "typeVersion": 1,
      "position": [
        -5616,
        -272
      ],
      "id": "621ec828-6657-4c29-9d88-06a217bcd448",
      "name": "Fetch Requirements",
      "credentials": {
        "supabaseApi": {
          "id": "pI4CpdYLTiEEBmnz",
          "name": "Supabase account"
        }
      }
    },
    {
      "parameters": {
        "operation": "getAll",
        "tableId": "provider_responses",
        "returnAll": true,
        "filters": {
          "conditions": [
            {
              "keyName": "project_id",
              "condition": "eq",
              "keyValue": "={{ $('Set Input Params1').first().json.project_id }}"
            }
          ]
        }
      },
      "type": "n8n-nodes-base.supabase",
      "typeVersion": 1,
      "position": [
        -5616,
        -48
      ],
      "id": "20c08f3e-40a2-49ea-bf84-3132f5e3c25d",
      "name": "Fetch Provider Responses",
      "credentials": {
        "supabaseApi": {
          "id": "pI4CpdYLTiEEBmnz",
          "name": "Supabase account"
        }
      }
    },
    {
      "parameters": {
        "operation": "getAll",
        "tableId": "scoring_configuration_summary",
        "returnAll": true,
        "filters": {
          "conditions": [
            {
              "keyName": "project_id",
              "condition": "eq",
              "keyValue": "={{ $('Set Input Params1').first().json.project_id }}"
            }
          ]
        }
      },
      "type": "n8n-nodes-base.supabase",
      "typeVersion": 1,
      "position": [
        -5616,
        176
      ],
      "id": "ccd3f624-1fef-4b46-a0a2-496bb431577f",
      "name": "Fetch Scoring Configuration",
      "alwaysOutputData": true,
      "credentials": {
        "supabaseApi": {
          "id": "pI4CpdYLTiEEBmnz",
          "name": "Supabase account"
        }
      }
    },
    {
      "parameters": {
        "numberInputs": 3
      },
      "type": "n8n-nodes-base.merge",
      "typeVersion": 3.2,
      "position": [
        -5392,
        -176
      ],
      "id": "ae9c54ae-6be1-410b-a6b1-2d06e7a0b23e",
      "name": "Merge Requirements & Responses"
    },
    {
      "parameters": {
        "jsCode": "// =============================================\n// NODO: Prepare Scoring Data (v5 - Dynamic Criteria Support)\n// Supports both hardcoded defaults and dynamic criteria from database\n// =============================================\n\nconst items = $input.all();\n\nconsole.log('ðŸ“Š Prepare Scoring Data - Starting...');\nconsole.log('   Items received:', items.length);\n\n/* =========================\nGet project_id from webhook\n========================= */\nlet projectId = null;\ntry {\n    projectId = $('Set Input Params1').first().json.project_id;\n    console.log('   ðŸ“‹ Project ID:', projectId);\n} catch (e) {\n    console.log('   âš ï¸ Could not get project_id:', e.message);\n}\n\n/* =========================\nGet Dynamic Scoring Configuration (if exists)\n========================= */\nlet dynamicConfig = null;\nlet useDynamicConfig = false;\ntry {\n    const configItems = $('Fetch Scoring Configuration').all();\n    if (configItems && configItems.length > 0 && configItems[0].json.category_name) {\n        // Parse configuration into structured format\n        const configData = configItems.map(item => item.json);\n        dynamicConfig = {\n            categories: {},\n            criteria: {},\n            criteriaWeights: {},\n            categoryWeights: {}\n        };\n        \n        configData.forEach(row => {\n            const catName = row.category_name;\n            const catWeight = parseFloat(row.category_weight) || 0;\n            \n            if (!dynamicConfig.categories[catName]) {\n                dynamicConfig.categories[catName] = {\n                    name: catName,\n                    display_name: row.category_display_name,\n                    weight: catWeight,\n                    color: row.category_color,\n                    criteria: []\n                };\n                dynamicConfig.categoryWeights[catName.toUpperCase()] = catWeight / 100;\n            }\n            \n            if (row.criterion_name) {\n                const critName = row.criterion_name;\n                const critWeight = parseFloat(row.criterion_weight) || 0;\n                const actualWeight = (critWeight * catWeight) / 10000; // criterion_weight% of category_weight%\n                \n                dynamicConfig.criteria[critName] = {\n                    name: critName,\n                    display_name: row.criterion_display_name,\n                    description: row.criterion_description,\n                    category: catName,\n                    weight: critWeight,\n                    keywords: row.criterion_keywords || []\n                };\n                dynamicConfig.criteriaWeights[critName] = actualWeight;\n                dynamicConfig.categories[catName].criteria.push(critName);\n            }\n        });\n        \n        useDynamicConfig = Object.keys(dynamicConfig.criteria).length > 0;\n        console.log('   âœ… Dynamic configuration loaded:', Object.keys(dynamicConfig.criteria).length, 'criteria');\n    }\n} catch (e) {\n    console.log('   âš ï¸ Could not load dynamic config:', e.message);\n}\n\n/* =========================\nDefault Criteria (fallback)\n========================= */\nconst DEFAULT_CRITERIA_WEIGHTS = {\n    scope_facilities: 0.10,\n    scope_work: 0.10,\n    deliverables_quality: 0.10,\n    total_price: 0.15,\n    price_breakdown: 0.08,\n    optionals_included: 0.07,\n    capex_opex_methodology: 0.05,\n    schedule: 0.08,\n    resources_allocation: 0.06,\n    exceptions: 0.06,\n    safety_studies: 0.08,\n    regulatory_compliance: 0.07\n};\n\nconst DEFAULT_CATEGORY_WEIGHTS = {\n    TECHNICAL: 0.30,\n    ECONOMIC: 0.35,\n    EXECUTION: 0.20,\n    HSE_COMPLIANCE: 0.15\n};\n\n// Use dynamic or default\nconst CRITERIA_WEIGHTS = useDynamicConfig ? dynamicConfig.criteriaWeights : DEFAULT_CRITERIA_WEIGHTS;\nconst CATEGORY_WEIGHTS = useDynamicConfig ? dynamicConfig.categoryWeights : DEFAULT_CATEGORY_WEIGHTS;\n\nconsole.log('   ðŸ“Š Using', useDynamicConfig ? 'DYNAMIC' : 'DEFAULT', 'configuration');\nconsole.log('   ðŸ“Š Criteria:', Object.keys(CRITERIA_WEIGHTS).join(', '));\n\n/* =========================\nHelpers - Map requirements to criteria\n========================= */\nfunction getCriterionFromRequirement(evalType, phase, reqText, keywords) {\n    const type = (evalType || '').toLowerCase();\n    const phaseL = (phase || '').toLowerCase();\n    const text = (reqText || '').toLowerCase();\n    \n    // If using dynamic config, try to match by keywords first\n    if (useDynamicConfig && dynamicConfig.criteria) {\n        for (const [critName, critInfo] of Object.entries(dynamicConfig.criteria)) {\n            const kws = critInfo.keywords || [];\n            for (const kw of kws) {\n                if (text.includes(kw.toLowerCase())) {\n                    return critName;\n                }\n            }\n        }\n    }\n    \n    // Fallback to default mapping logic\n    if (type.includes('technical')) {\n        if (text.includes('scope of facilities') || text.includes('hydrogen plant') || text.includes('utilities')) {\n            return 'scope_facilities';\n        }\n        if (text.includes('scope of work') || text.includes('project management') || text.includes('deliverables')) {\n            return 'scope_work';\n        }\n        if (text.includes('p&id') || text.includes('3d model') || text.includes('specification') || text.includes('datasheet')) {\n            return 'deliverables_quality';\n        }\n        return 'scope_work';\n    }\n    \n    if (type.includes('econom')) {\n        if (text.includes('price') || text.includes('â‚¬') || text.includes('fee') || text.includes('cost')) {\n            return 'total_price';\n        }\n        if (text.includes('hour') || text.includes('discipline') || text.includes('breakdown')) {\n            return 'price_breakdown';\n        }\n        if (text.includes('optional') || text.includes('geotechnical') || text.includes('topograph') || text.includes('hazid')) {\n            return 'optionals_included';\n        }\n        if (text.includes('capex') || text.includes('opex') || text.includes('aacei') || text.includes('estimate')) {\n            return 'capex_opex_methodology';\n        }\n        return 'total_price';\n    }\n    \n    if (text.includes('hse') || text.includes('safety') || text.includes('hazop') || text.includes('hazid') || text.includes('atex') || text.includes('qra')) {\n        return 'safety_studies';\n    }\n    if (text.includes('code') || text.includes('standard') || text.includes('compliance') || text.includes('regulation')) {\n        return 'regulatory_compliance';\n    }\n    \n    if (phaseL.includes('pre-feed') || phaseL.includes('feed') || type.includes('deliverable')) {\n        if (text.includes('schedule') || text.includes('planning') || text.includes('timeline')) {\n            return 'schedule';\n        }\n        if (text.includes('exception') || text.includes('deviation') || text.includes('exclusion')) {\n            return 'exceptions';\n        }\n        return 'resources_allocation';\n    }\n    \n    return 'scope_work';\n}\n\nfunction classifyEval(val) {\n    const v = (val || '').toUpperCase();\n    if (v.includes('INCLUD') || v.includes('INCLUIDO') || v === 'SI' || v === 'YES') return 'INCLUDED';\n    if (v.includes('PARCIAL') || v.includes('PARTIAL')) return 'PARTIAL';\n    if (v.includes('NO INCLUD') || v.includes('NOT INCLUD') || v === 'NO') return 'NOT_INCLUDED';\n    return 'NO_INFO';\n}\n\n/* =========================\nGet data from previous nodes\n========================= */\nlet requirements = [];\nlet responses = [];\n\ntry {\n    const reqItems = $('Fetch Requirements').all();\n    requirements = reqItems.map(item => item.json);\n    console.log('   âœ… Requirements from Fetch Requirements:', requirements.length);\n} catch (e) {\n    console.log('   âš ï¸ Could not access Fetch Requirements:', e.message);\n}\n\ntry {\n    const respItems = $('Fetch Provider Responses').all();\n    responses = respItems.map(item => item.json);\n    console.log('   âœ… Responses from Fetch Provider Responses:', responses.length);\n} catch (e) {\n    console.log('   âš ï¸ Could not access Fetch Provider Responses:', e.message);\n}\n\nif (requirements.length === 0 || responses.length === 0) {\n    console.log('   ðŸ”„ Using fallback: separating from input...');\n    items.forEach(item => {\n        const data = item.json;\n        if (data.requirement_text && !data.provider_name) {\n            requirements.push(data);\n        } else if (data.provider_name && data.requirement_id) {\n            responses.push(data);\n        }\n    });\n}\n\nif (requirements.length === 0) {\n    return [{ json: { error: 'No requirements found', items_received: items.length } }];\n}\nif (responses.length === 0) {\n    return [{ json: { error: 'No responses found', items_received: items.length } }];\n}\n\n/* =========================\nOptimization with MAPS\n========================= */\nconst requirementMap = {};\nrequirements.forEach(r => {\n    if (r.id) requirementMap[r.id] = r;\n});\n\nconst responsesByProvider = {};\nresponses.forEach(r => {\n    if (r.provider_name) {\n        if (!responsesByProvider[r.provider_name]) {\n            responsesByProvider[r.provider_name] = [];\n        }\n        responsesByProvider[r.provider_name].push(r);\n    }\n});\n\nconsole.log('   ðŸ“Š Providers found:', Object.keys(responsesByProvider).join(', '));\n\n/* =========================\nProvider filter (optional)\n========================= */\nlet providerFilter = '';\ntry {\n    providerFilter = $('Set Input Params1').first().json.provider_filter || '';\n} catch (e) {}\n\nlet providers = Object.keys(responsesByProvider);\nif (providerFilter) {\n    providers = providers.filter(p => p.toLowerCase().includes(providerFilter.toLowerCase()));\n}\n\nif (providers.length === 0) {\n    return [{ json: { error: 'No providers found', filter: providerFilter } }];\n}\n\n/* =========================\nEvaluation by Criteria\n========================= */\nconst evaluationData = providers.map(providerName => {\n    const providerResponses = responsesByProvider[providerName] || [];\n    \n    // Initialize criteria summary\n    const criteriaScores = {};\n    Object.keys(CRITERIA_WEIGHTS).forEach(criterion => {\n        criteriaScores[criterion] = { total: 0, included: 0, partial: 0, not_included: 0, no_info: 0, scores: [] };\n    });\n    \n    providerResponses.forEach(resp => {\n        const req = requirementMap[resp.requirement_id];\n        if (!req) return;\n        \n        const criterion = getCriterionFromRequirement(req.evaluation_type, req.phase, req.requirement_text);\n        const evalClass = classifyEval(resp.evaluation_value);\n        \n        const cs = criteriaScores[criterion];\n        if (!cs) return;\n        \n        cs.total++;\n        if (evalClass === 'INCLUDED') cs.included++;\n        else if (evalClass === 'PARTIAL') cs.partial++;\n        else if (evalClass === 'NOT_INCLUDED') cs.not_included++;\n        else cs.no_info++;\n        \n        if (typeof resp.score === 'number') {\n            cs.scores.push(resp.score);\n        }\n    });\n    \n    // Calculate average scores per criterion\n    let globalScore = 0;\n    const criteriaAvgScores = {};\n    \n    Object.keys(criteriaScores).forEach(criterion => {\n        const cs = criteriaScores[criterion];\n        if (cs.scores.length > 0) {\n            cs.avg_score = Math.round((cs.scores.reduce((a, b) => a + b, 0) / cs.scores.length) * 100) / 100;\n        } else if (cs.total > 0) {\n            cs.avg_score = Math.round(((cs.included * 10 + cs.partial * 5) / cs.total) * 100) / 100;\n        } else {\n            cs.avg_score = 0;\n        }\n        criteriaAvgScores[criterion] = cs.avg_score;\n        globalScore += cs.avg_score * (CRITERIA_WEIGHTS[criterion] || 0);\n        delete cs.scores;\n    });\n    \n    globalScore = Math.round(globalScore * 100) / 100;\n    \n    // Calculate category scores dynamically\n    let categoryScores = {};\n    if (useDynamicConfig) {\n        for (const [catName, catInfo] of Object.entries(dynamicConfig.categories)) {\n            const catCriteria = catInfo.criteria || [];\n            const scores = catCriteria.map(c => criteriaAvgScores[c] || 0);\n            const avg = scores.length > 0 ? scores.reduce((a, b) => a + b, 0) / scores.length : 0;\n            categoryScores[catName.toUpperCase()] = Math.round(avg * 100) / 100;\n        }\n    } else {\n        categoryScores = {\n            TECHNICAL: Math.round(((criteriaAvgScores.scope_facilities || 0) + (criteriaAvgScores.scope_work || 0) + (criteriaAvgScores.deliverables_quality || 0)) / 3 * 100) / 100,\n            ECONOMIC: Math.round(((criteriaAvgScores.total_price || 0) + (criteriaAvgScores.price_breakdown || 0) + (criteriaAvgScores.optionals_included || 0) + (criteriaAvgScores.capex_opex_methodology || 0)) / 4 * 100) / 100,\n            EXECUTION: Math.round(((criteriaAvgScores.schedule || 0) + (criteriaAvgScores.resources_allocation || 0) + (criteriaAvgScores.exceptions || 0)) / 3 * 100) / 100,\n            HSE_COMPLIANCE: Math.round(((criteriaAvgScores.safety_studies || 0) + (criteriaAvgScores.regulatory_compliance || 0)) / 2 * 100) / 100\n        };\n    }\n    \n    return {\n        provider_name: providerName,\n        project_id: projectId,\n        total_responses: providerResponses.length,\n        global_score: globalScore,\n        category_scores: categoryScores,\n        criteria_scores: criteriaAvgScores,\n        criteria_summary: criteriaScores,\n        config_type: useDynamicConfig ? 'dynamic' : 'default',\n        scoring_config: useDynamicConfig ? dynamicConfig : null\n    };\n});\n\n/* =========================\nExecutive Ranking\n========================= */\nevaluationData\n    .sort((a, b) => b.global_score - a.global_score)\n    .forEach((item, index) => {\n        item.rank = index + 1;\n    });\n\nconsole.log('âœ… Scoring Data prepared for', evaluationData.length, 'providers');\nconsole.log('   Project ID included:', projectId);\nconsole.log('   Config type:', useDynamicConfig ? 'DYNAMIC' : 'DEFAULT');\n\nreturn evaluationData.map(data => ({ json: data }));"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        -5168,
        -176
      ],
      "id": "7a5ed7d9-4a4a-4180-adab-f67778f8d645",
      "name": "Prepare Scoring Data"
    },
    {
      "parameters": {
        "options": {
          "reset": false
        }
      },
      "type": "n8n-nodes-base.splitInBatches",
      "typeVersion": 3,
      "position": [
        -4944,
        -224
      ],
      "id": "9d59de1a-0706-427d-a77e-033c1080c164",
      "name": "Loop Over Providers"
    },
    {
      "parameters": {
        "promptType": "define",
        "text": "=Score this engineering proposal provider based on RFQ compliance.\n\n## PROVIDER: {{ $json.provider_name }}\n## TOTAL RESPONSES: {{ $json.total_responses }}\n## CONFIG TYPE: {{ $json.config_type || 'default' }}\n\n## CATEGORY SCORES (pre-calculated):\n{{ JSON.stringify($json.category_scores, null, 2) }}\n\n## INDIVIDUAL CRITERIA SCORES:\n{{ JSON.stringify($json.criteria_scores, null, 2) }}\n\n## CRITERIA DETAILS:\n{{ JSON.stringify($json.criteria_summary, null, 2) }}\n\n{{ $json.scoring_config ? '## DYNAMIC SCORING CONFIGURATION:\\n' + JSON.stringify($json.scoring_config.categories, null, 2) : '' }}\n\n## EVALUATION CRITERIA (weights):\n{{ $json.scoring_config ? Object.entries($json.scoring_config.categories).map(([name, cat]) => `### ${cat.display_name} (${cat.weight}%)\\n${cat.criteria.map(c => `- ${c}: ${$json.scoring_config.criteria[c]?.description || ''}`).join('\\n')}`).join('\\n\\n') : `### TECHNICAL COMPLETENESS (30%)\n- scope_facilities: 10% - H2 plant, BOP, utilities included\n- scope_work: 10% - PM, studies, deliverables covered\n- deliverables_quality: 10% - P&IDs, specs, 3D model quality\n\n### ECONOMIC COMPETITIVENESS (35%)\n- total_price: 15% - PRE-FEED + FEED + EPC price competitiveness\n- price_breakdown: 8% - Transparent hours/discipline, â‚¬/hour\n- optionals_included: 7% - Geotechnical, topographic, 3D, HAZID in base\n- capex_opex_methodology: 5% - AACEI class, estimate robustness\n\n### EXECUTION CAPABILITY (20%)\n- schedule: 8% - Realistic timeline vs requirements\n- resources_allocation: 6% - Coherent hours per discipline\n- exceptions: 6% - Fewer exceptions = better (invert score)\n\n### HSE & COMPLIANCE (15%)\n- safety_studies: 8% - HAZID, HAZOP, QRA, ATEX included\n- regulatory_compliance: 7% - Codes, standards, safety distances` }}\n\n## SCORING RULES:\n- included items = 10 points\n- partial items = 6 points\n- not_included items = 2 points\n- no_info items = 0 points\n- For 'exceptions': FEWER is BETTER (invert: more exceptions = lower score)\n\n## OUTPUT (JSON only):\n{\n  \"provider_name\": \"string\",\n  \"category_scores\": {\n    {{ $json.scoring_config ? Object.keys($json.scoring_config.categories).map(name => `\"${name.toUpperCase()}\": { \"score\": number, \"weight\": ${$json.scoring_config.categories[name].weight / 100} }`).join(',\\n    ') : `\"TECHNICAL\": { \"score\": number, \"weight\": 0.30 },\n    \"ECONOMIC\": { \"score\": number, \"weight\": 0.35 },\n    \"EXECUTION\": { \"score\": number, \"weight\": 0.20 },\n    \"HSE_COMPLIANCE\": { \"score\": number, \"weight\": 0.15 }` }}\n  },\n  \"individual_scores\": {\n    {{ Object.keys($json.criteria_scores).map(k => `\"${k}\": number`).join(',\\n    ') }}\n  },\n  \"overall_score\": number,\n  \"compliance_percentage\": number,\n  \"evaluation_summary\": \"1-2 sentences comparing to ideal proposal\",\n  \"strengths\": [\"max 3 specific strengths\"],\n  \"weaknesses\": [\"max 3 specific areas for improvement\"]\n}",
        "hasOutputParser": true,
        "batching": {}
      },
      "type": "@n8n/n8n-nodes-langchain.chainLlm",
      "typeVersion": 1.8,
      "position": [
        -4672,
        -208
      ],
      "id": "a2c74701-b416-44de-b9b9-106ea6115afb",
      "name": "Scoring LLM Chain"
    },
    {
      "parameters": {
        "jsCode": "// Extract LLM output and structure for database (v6 - Dynamic Criteria)\nconst input = $input.first().json;\nconst llmOutput = input.output || input;\n\n// Extract category scores\nconst cs = llmOutput.category_scores || {};\nconst getScore = (cat) => {\n    if (!cs[cat]) return 0;\n    return (typeof cs[cat] === 'object' && cs[cat].score) ? cs[cat].score : (cs[cat] || 0);\n};\n\n// Extract individual scores (dynamic - works with any criteria)\nconst is = llmOutput.individual_scores || {};\nconst configType = input.config_type || llmOutput.config_type || 'default';\nconst scoringConfig = input.scoring_config || null;\n\n// Build category_scores as a clean object { category_name: score }\nconst categoryScoresClean = {};\nfor (const [catKey, catVal] of Object.entries(cs)) {\n    categoryScoresClean[catKey] = (typeof catVal === 'object' && catVal.score) ? catVal.score : (catVal || 0);\n}\n\n// Build ranking object - always include legacy fields for backward compat\n// plus the new JSONB fields for dynamic scoring\nconst ranking = {\n    provider_name: llmOutput.provider_name || 'UNKNOWN',\n    project_id: input.project_id || llmOutput.project_id || null,\n    // Legacy fixed fields (populated from dynamic data when possible)\n    technical_score: getScore('TECHNICAL') || getScore('technical') || 0,\n    economic_score: getScore('ECONOMIC') || getScore('economic') || 0,\n    execution_score: getScore('EXECUTION') || getScore('execution') || 0,\n    hse_compliance_score: getScore('HSE_COMPLIANCE') || getScore('hse_compliance') || 0,\n    scope_facilities_score: is.scope_facilities || 0,\n    scope_work_score: is.scope_work || 0,\n    deliverables_quality_score: is.deliverables_quality || 0,\n    total_price_score: is.total_price || 0,\n    price_breakdown_score: is.price_breakdown || 0,\n    optionals_included_score: is.optionals_included || 0,\n    capex_opex_methodology_score: is.capex_opex_methodology || 0,\n    schedule_score: is.schedule || 0,\n    resources_allocation_score: is.resources_allocation || 0,\n    exceptions_score: is.exceptions || 0,\n    safety_studies_score: is.safety_studies || 0,\n    regulatory_compliance_score: is.regulatory_compliance || 0,\n    // Dynamic JSONB fields\n    category_scores_json: categoryScoresClean,\n    individual_scores_json: is,\n    evaluation_details: {\n        strengths: llmOutput.strengths || [],\n        weaknesses: llmOutput.weaknesses || [],\n        recommendations: llmOutput.recommendations || [],\n        summary: llmOutput.evaluation_summary || ''\n    },\n    overall_score: llmOutput.overall_score || 0,\n    compliance_percentage: llmOutput.compliance_percentage || 0,\n    evaluation_count: 1,\n    last_updated: new Date().toISOString()\n};\n\nreturn [{\n    json: {\n        ranking,\n        details: ranking.evaluation_details,\n        category_scores: cs,\n        individual_scores: is,\n        config_type: configType,\n        scoring_config: scoringConfig\n    }\n}];"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        -4288,
        -208
      ],
      "id": "2a5e6142-8f21-4bf4-8d62-4c52fb969070",
      "name": "Calculate Weighted Scores"
    },
    {
      "parameters": {
        "operation": "getAll",
        "tableId": "ranking_proveedores",
        "limit": 1,
        "filters": {
          "conditions": [
            {
              "keyName": "provider_name",
              "condition": "eq",
              "keyValue": "={{ $('Calculate Weighted Scores').first().json.ranking.provider_name }}"
            },
            {
              "keyName": "project_id",
              "condition": "eq",
              "keyValue": "={{ $('Set Input Params1').first().json.project_id }}"
            }
          ]
        }
      },
      "type": "n8n-nodes-base.supabase",
      "typeVersion": 1,
      "position": [
        -4048,
        -208
      ],
      "id": "0d36d819-a488-4892-8608-1da0a93ce459",
      "name": "Check Provider Exists",
      "alwaysOutputData": true,
      "credentials": {
        "supabaseApi": {
          "id": "pI4CpdYLTiEEBmnz",
          "name": "Supabase account"
        }
      }
    },
    {
      "parameters": {
        "conditions": {
          "options": {
            "caseSensitive": true,
            "leftValue": "",
            "typeValidation": "strict",
            "version": 2
          },
          "conditions": [
            {
              "id": "provider-exists-condition",
              "leftValue": "={{ $input.all().length }}",
              "rightValue": 0,
              "operator": {
                "type": "number",
                "operation": "gt"
              }
            }
          ],
          "combinator": "and"
        },
        "options": {}
      },
      "type": "n8n-nodes-base.if",
      "typeVersion": 2.2,
      "position": [
        -3808,
        -208
      ],
      "id": "dd8b9804-7407-4d8a-843b-9ea252350062",
      "name": "Provider Exists?",
      "disabled": true
    },
    {
      "parameters": {
        "operation": "update",
        "tableId": "ranking_proveedores",
        "matchType": "allFilters",
        "filters": {
          "conditions": [
            {
              "keyName": "provider_name",
              "condition": "eq",
              "keyValue": "={{ $('Calculate Weighted Scores').first().json.ranking.provider_name }}"
            },
            {
              "keyName": "project_id",
              "condition": "eq",
              "keyValue": "={{ $('Set Input Params1').first().json.project_id }}"
            }
          ]
        },
        "fieldsUi": {
          "fieldValues": [
            {
              "fieldId": "project_id",
              "fieldValue": "={{ $('Set Input Params1').first().json.project_id }}"
            },
            {
              "fieldId": "technical_score",
              "fieldValue": "={{ $('Calculate Weighted Scores').first().json.ranking.technical_score || 0 }}"
            },
            {
              "fieldId": "economic_score",
              "fieldValue": "={{ $('Calculate Weighted Scores').first().json.ranking.economic_score || 0 }}"
            },
            {
              "fieldId": "execution_score",
              "fieldValue": "={{ $('Calculate Weighted Scores').first().json.ranking.execution_score || 0 }}"
            },
            {
              "fieldId": "hse_compliance_score",
              "fieldValue": "={{ $('Calculate Weighted Scores').first().json.ranking.hse_compliance_score || 0 }}"
            },
            {
              "fieldId": "scope_facilities_score",
              "fieldValue": "={{ $('Calculate Weighted Scores').first().json.ranking.scope_facilities_score || 0 }}"
            },
            {
              "fieldId": "scope_work_score",
              "fieldValue": "={{ $('Calculate Weighted Scores').first().json.ranking.scope_work_score || 0 }}"
            },
            {
              "fieldId": "deliverables_quality_score",
              "fieldValue": "={{ $('Calculate Weighted Scores').first().json.ranking.deliverables_quality_score || 0 }}"
            },
            {
              "fieldId": "total_price_score",
              "fieldValue": "={{ $('Calculate Weighted Scores').first().json.ranking.total_price_score || 0 }}"
            },
            {
              "fieldId": "price_breakdown_score",
              "fieldValue": "={{ $('Calculate Weighted Scores').first().json.ranking.price_breakdown_score || 0 }}"
            },
            {
              "fieldId": "optionals_included_score",
              "fieldValue": "={{ $('Calculate Weighted Scores').first().json.ranking.optionals_included_score || 0 }}"
            },
            {
              "fieldId": "capex_opex_methodology_score",
              "fieldValue": "={{ $('Calculate Weighted Scores').first().json.ranking.capex_opex_methodology_score || 0 }}"
            },
            {
              "fieldId": "schedule_score",
              "fieldValue": "={{ $('Calculate Weighted Scores').first().json.ranking.schedule_score || 0 }}"
            },
            {
              "fieldId": "resources_allocation_score",
              "fieldValue": "={{ $('Calculate Weighted Scores').first().json.ranking.resources_allocation_score || 0 }}"
            },
            {
              "fieldId": "exceptions_score",
              "fieldValue": "={{ $('Calculate Weighted Scores').first().json.ranking.exceptions_score || 0 }}"
            },
            {
              "fieldId": "safety_studies_score",
              "fieldValue": "={{ $('Calculate Weighted Scores').first().json.ranking.safety_studies_score || 0 }}"
            },
            {
              "fieldId": "regulatory_compliance_score",
              "fieldValue": "={{ $('Calculate Weighted Scores').first().json.ranking.regulatory_compliance_score || 0 }}"
            },
            {
              "fieldId": "overall_score",
              "fieldValue": "={{ $('Calculate Weighted Scores').first().json.ranking.overall_score || 0 }}"
            },
            {
              "fieldId": "compliance_percentage",
              "fieldValue": "={{ $('Calculate Weighted Scores').first().json.ranking.compliance_percentage || 0 }}"
            },
            {
              "fieldId": "evaluation_count",
              "fieldValue": "={{ $('Calculate Weighted Scores').first().json.ranking.evaluation_count || 0 }}"
            },
            {
              "fieldId": "last_updated",
              "fieldValue": "={{ $('Calculate Weighted Scores').first().json.ranking.last_updated }}"
            }
          ]
        }
      },
      "type": "n8n-nodes-base.supabase",
      "typeVersion": 1,
      "position": [
        -3568,
        -304
      ],
      "id": "a03f9c35-b055-43ae-b11a-846c1147a5ea",
      "name": "Update Ranking",
      "alwaysOutputData": false,
      "credentials": {
        "supabaseApi": {
          "id": "pI4CpdYLTiEEBmnz",
          "name": "Supabase account"
        }
      },
      "disabled": true,
      "continueOnFail": true
    },
    {
      "parameters": {
        "tableId": "ranking_proveedores",
        "fieldsUi": {
          "fieldValues": [
            {
              "fieldId": "provider_name",
              "fieldValue": "={{ $('Calculate Weighted Scores').first().json.ranking.provider_name }}"
            },
            {
              "fieldId": "project_id",
              "fieldValue": "={{ $('Set Input Params1').first().json.project_id }}"
            },
            {
              "fieldId": "technical_score",
              "fieldValue": "={{ $('Calculate Weighted Scores').first().json.ranking.technical_score || 0 }}"
            },
            {
              "fieldId": "economic_score",
              "fieldValue": "={{ $('Calculate Weighted Scores').first().json.ranking.economic_score || 0 }}"
            },
            {
              "fieldId": "execution_score",
              "fieldValue": "={{ $('Calculate Weighted Scores').first().json.ranking.execution_score || 0 }}"
            },
            {
              "fieldId": "hse_compliance_score",
              "fieldValue": "={{ $('Calculate Weighted Scores').first().json.ranking.hse_compliance_score || 0 }}"
            },
            {
              "fieldId": "scope_facilities_score",
              "fieldValue": "={{ $('Calculate Weighted Scores').first().json.ranking.scope_facilities_score || 0 }}"
            },
            {
              "fieldId": "scope_work_score",
              "fieldValue": "={{ $('Calculate Weighted Scores').first().json.ranking.scope_work_score || 0 }}"
            },
            {
              "fieldId": "deliverables_quality_score",
              "fieldValue": "={{ $('Calculate Weighted Scores').first().json.ranking.deliverables_quality_score || 0 }}"
            },
            {
              "fieldId": "total_price_score",
              "fieldValue": "={{ $('Calculate Weighted Scores').first().json.ranking.total_price_score || 0 }}"
            },
            {
              "fieldId": "price_breakdown_score",
              "fieldValue": "={{ $('Calculate Weighted Scores').first().json.ranking.price_breakdown_score || 0 }}"
            },
            {
              "fieldId": "optionals_included_score",
              "fieldValue": "={{ $('Calculate Weighted Scores').first().json.ranking.optionals_included_score || 0 }}"
            },
            {
              "fieldId": "capex_opex_methodology_score",
              "fieldValue": "={{ $('Calculate Weighted Scores').first().json.ranking.capex_opex_methodology_score || 0 }}"
            },
            {
              "fieldId": "schedule_score",
              "fieldValue": "={{ $('Calculate Weighted Scores').first().json.ranking.schedule_score || 0 }}"
            },
            {
              "fieldId": "resources_allocation_score",
              "fieldValue": "={{ $('Calculate Weighted Scores').first().json.ranking.resources_allocation_score || 0 }}"
            },
            {
              "fieldId": "exceptions_score",
              "fieldValue": "={{ $('Calculate Weighted Scores').first().json.ranking.exceptions_score || 0 }}"
            },
            {
              "fieldId": "safety_studies_score",
              "fieldValue": "={{ $('Calculate Weighted Scores').first().json.ranking.safety_studies_score || 0 }}"
            },
            {
              "fieldId": "regulatory_compliance_score",
              "fieldValue": "={{ $('Calculate Weighted Scores').first().json.ranking.regulatory_compliance_score || 0 }}"
            },
            {
              "fieldId": "overall_score",
              "fieldValue": "={{ $('Calculate Weighted Scores').first().json.ranking.overall_score || 0 }}"
            },
            {
              "fieldId": "compliance_percentage",
              "fieldValue": "={{ $('Calculate Weighted Scores').first().json.ranking.compliance_percentage || 0 }}"
            },
            {
              "fieldId": "evaluation_count",
              "fieldValue": "={{ $('Calculate Weighted Scores').first().json.ranking.evaluation_count || 0 }}"
            },
            {
              "fieldId": "last_updated",
              "fieldValue": "={{ $('Calculate Weighted Scores').first().json.ranking.last_updated }}"
            },
            {
              "fieldId": "category_scores_json",
              "fieldValue": "={{ JSON.stringify($('Calculate Weighted Scores').first().json.ranking.category_scores_json || {}) }}"
            },
            {
              "fieldId": "individual_scores_json",
              "fieldValue": "={{ JSON.stringify($('Calculate Weighted Scores').first().json.ranking.individual_scores_json || {}) }}"
            },
            {
              "fieldId": "evaluation_details",
              "fieldValue": "={{ JSON.stringify($('Calculate Weighted Scores').first().json.ranking.evaluation_details || {}) }}"
            }
          ]
        }
      },
      "type": "n8n-nodes-base.supabase",
      "typeVersion": 1,
      "position": [
        -3568,
        -96
      ],
      "id": "a8d4e928-7367-4a4a-a7ac-36082d0228c5",
      "name": "Insert Ranking",
      "alwaysOutputData": false,
      "credentials": {
        "supabaseApi": {
          "id": "pI4CpdYLTiEEBmnz",
          "name": "Supabase account"
        }
      },
      "continueOnFail": true
    },
    {
      "parameters": {
        "aggregate": "aggregateAllItemData",
        "destinationFieldName": "all_rankings",
        "options": {}
      },
      "type": "n8n-nodes-base.aggregate",
      "typeVersion": 1,
      "position": [
        -4672,
        -384
      ],
      "id": "bc89c6d3-c1b8-4843-a3b3-9a14b717eb79",
      "name": "Aggregate All Rankings"
    },
    {
      "parameters": {
        "jsCode": "// =============================================\n// NODE: Generate Final Ranking with Details (v6 - Fully Dynamic Criteria)\n// Passes individual_scores and category scores as dynamic objects\n// =============================================\n\nconst items = $input.all();\nlet allRankings = [];\n\nitems.forEach(item => {\n    if (item.json.all_rankings) {\n        allRankings = allRankings.concat(item.json.all_rankings);\n    } else if (item.json.ranking) {\n        allRankings.push(item.json);\n    }\n});\n\nconst sortedRankings = allRankings\n    .map(r => ({\n        ranking: r.ranking || r,\n        details: r.details || {},\n        category_scores: r.category_scores || {},\n        individual_scores: r.individual_scores || {},\n        config_type: r.config_type || 'default'\n    }))\n    .sort((a, b) => (b.ranking.overall_score || 0) - (a.ranking.overall_score || 0));\n\nconst finalRanking = sortedRankings.map((r, idx) => {\n    // Build dynamic category scores object\n    const categoryScores = r.ranking.category_scores_json || {};\n    // Also populate legacy fields for backward compatibility\n    const scores = {\n        technical: categoryScores.TECHNICAL || categoryScores.technical || r.ranking.technical_score || 0,\n        economic: categoryScores.ECONOMIC || categoryScores.economic || r.ranking.economic_score || 0,\n        execution: categoryScores.EXECUTION || categoryScores.execution || r.ranking.execution_score || 0,\n        hse_compliance: categoryScores.HSE_COMPLIANCE || categoryScores.hse_compliance || r.ranking.hse_compliance_score || 0\n    };\n    // Add any dynamic categories that aren't in the legacy set\n    for (const [catKey, catScore] of Object.entries(categoryScores)) {\n        const normalizedKey = catKey.toLowerCase();\n        if (!scores[normalizedKey]) {\n            scores[normalizedKey] = catScore;\n        }\n    }\n\n    // Build dynamic individual_scores from JSONB or fallback to legacy fields\n    const dynamicIndividual = r.ranking.individual_scores_json || r.individual_scores || {};\n    // Merge with legacy fixed fields as fallback\n    const individualScores = { ...dynamicIndividual };\n    const legacyFields = [\n        'scope_facilities', 'scope_work', 'deliverables_quality',\n        'total_price', 'price_breakdown', 'optionals_included', 'capex_opex_methodology',\n        'schedule', 'resources_allocation', 'exceptions',\n        'safety_studies', 'regulatory_compliance'\n    ];\n    legacyFields.forEach(f => {\n        if (!(f in individualScores) || !individualScores[f]) {\n            individualScores[f] = r.ranking[f + '_score'] || r.individual_scores?.[f] || 0;\n        }\n    });\n\n    return {\n        position: idx + 1,\n        provider_name: r.ranking.provider_name,\n        overall_score: r.ranking.overall_score,\n        compliance_percentage: r.ranking.compliance_percentage,\n        scores,\n        individual_scores: individualScores,\n        evaluation: {\n            strengths: r.details.strengths || [],\n            weaknesses: r.details.weaknesses || [],\n            recommendations: r.details.recommendations || [],\n            summary: r.details.summary || ''\n        }\n    };\n});\n\nconst configType = sortedRankings[0]?.config_type || 'default';\n\nconst stats = {\n    total_providers: finalRanking.length,\n    average_score: finalRanking.reduce((sum, r) => sum + (r.overall_score || 0), 0) / (finalRanking.length || 1),\n    top_performer: finalRanking[0]?.provider_name || 'N/A',\n    score_range: {\n        min: Math.min(...finalRanking.map(r => r.overall_score || 0)),\n        max: Math.max(...finalRanking.map(r => r.overall_score || 0))\n    },\n    evaluation_date: new Date().toISOString(),\n    config_type: configType\n};\n\nconsole.log(`Final Ranking Generated (${configType} config):`);\nfinalRanking.forEach(r => {\n    console.log(`   ${r.position}. ${r.provider_name}: ${r.overall_score} (${r.compliance_percentage}%)`);\n});\n\nreturn {\n    json: {\n        success: true,\n        ranking: finalRanking,\n        statistics: stats,\n        message: `Scoring completed for ${finalRanking.length} providers using ${configType} criteria configuration`\n    }\n};"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        -4384,
        -384
      ],
      "id": "09266fa9-5c8e-4d81-a69b-56313fcca1c7",
      "name": "Generate Final Ranking"
    },
    {
      "parameters": {
        "respondWith": "json",
        "responseBody": "={{ $json }}",
        "options": {
          "responseHeaders": {
            "entries": [
              {
                "name": "Content-Type",
                "value": "application/json"
              }
            ]
          }
        }
      },
      "type": "n8n-nodes-base.respondToWebhook",
      "typeVersion": 1.5,
      "position": [
        -4160,
        -384
      ],
      "id": "13ed378a-3137-43b4-b0e2-80281f9f4271",
      "name": "Respond with Ranking"
    },
    {
      "parameters": {
        "content": "## Scoring Workflow - Provider Evaluation (v5)\n## Dynamic Criteria Support\n\nThis workflow now supports:\n1. **Default criteria** - 11 hardcoded criteria for engineering proposals\n2. **Dynamic criteria** - Custom criteria loaded from `scoring_configuration_summary` view\n\n### How it works:\n1. Fetches scoring configuration for the project\n2. If configuration exists, uses dynamic criteria and weights\n3. If no configuration, falls back to default criteria\n\n### Default Category Weights:\n- **TECHNICAL COMPLETENESS (30%)**\n- **ECONOMIC COMPETITIVENESS (35%)**\n- **EXECUTION CAPABILITY (20%)**\n- **HSE & COMPLIANCE (15%)**\n\n### Endpoint:\nPOST /webhook/scoring-evaluation\n```json\n{\n  \"project_id\": \"uuid\",\n  \"provider_name\": \"filter\",\n  \"recalculate_all\": false\n}\n```\n\n### Response includes:\n- `config_type`: 'dynamic' or 'default'\n- `ranking`: Sorted provider scores\n- `statistics`: Summary stats",
        "height": 1264,
        "width": 3280
      },
      "type": "n8n-nodes-base.stickyNote",
      "typeVersion": 1,
      "position": [
        -6624,
        -768
      ],
      "id": "6c852dee-3622-4275-82ec-268280bcf40a",
      "name": "Workflow Info"
    },
    {
      "parameters": {
        "content": "## AI Scoring (v5)\n\nEvaluates engineering proposals using:\n- Dynamic OR default criteria\n- Custom weights from database\n- Value-for-money comparison\n- Strengths and weaknesses\n\nStructured JSON output",
        "height": 220,
        "width": 320,
        "color": 6
      },
      "type": "n8n-nodes-base.stickyNote",
      "typeVersion": 1,
      "position": [
        -4768,
        -624
      ],
      "id": "a0684454-6ab7-4dc5-beef-f5ccf3cbf59d",
      "name": "LLM Scoring Info"
    },
    {
      "parameters": {
        "assignments": {
          "assignments": [
            {
              "id": "project_id",
              "name": "project_id",
              "value": "={{ $('Webhook Scoring').first().json.body.project_id }}",
              "type": "string"
            },
            {
              "id": "provider_filter",
              "name": "provider_filter",
              "value": "={{ $('Webhook Scoring').first().json.body.provider_name || '' }}",
              "type": "string"
            },
            {
              "id": "recalculate_all",
              "name": "recalculate_all",
              "value": "={{ $('Webhook Scoring').first().json.body.recalculate_all || false }}",
              "type": "boolean"
            }
          ]
        },
        "options": {}
      },
      "type": "n8n-nodes-base.set",
      "typeVersion": 3.4,
      "position": [
        -5840,
        -176
      ],
      "id": "6ede61c9-baab-4e74-b4d9-7aeca34f5c39",
      "name": "Set Input Params1"
    },
    {
      "parameters": {
        "schemaType": "manual",
        "inputSchema": "{\n  \"type\": \"object\",\n  \"properties\": {\n    \"provider_name\": { \"type\": \"string\" },\n    \"category_scores\": {\n      \"type\": \"object\",\n      \"additionalProperties\": {\n        \"type\": \"object\",\n        \"properties\": {\n          \"score\": { \"type\": \"number\" },\n          \"weight\": { \"type\": \"number\" }\n        }\n      }\n    },\n    \"individual_scores\": {\n      \"type\": \"object\",\n      \"additionalProperties\": { \"type\": \"number\" }\n    },\n    \"overall_score\": { \"type\": \"number\" },\n    \"compliance_percentage\": { \"type\": \"number\" },\n    \"evaluation_summary\": { \"type\": \"string\" },\n    \"strengths\": { \"type\": \"array\", \"items\": { \"type\": \"string\" } },\n    \"weaknesses\": { \"type\": \"array\", \"items\": { \"type\": \"string\" } },\n    \"recommendations\": { \"type\": \"array\", \"items\": { \"type\": \"string\" } }\n  },\n  \"required\": [\"provider_name\", \"category_scores\", \"individual_scores\", \"overall_score\", \"compliance_percentage\"]\n}"
      },
      "type": "@n8n/n8n-nodes-langchain.outputParserStructured",
      "typeVersion": 1.3,
      "position": [
        -4528,
        16
      ],
      "id": "5c7ee8d3-362d-4c1c-a11d-826d340f1b79",
      "name": "JSON Output Parser1"
    },
    {
      "parameters": {
        "model": "qwen3:8b",
        "options": {
          "temperature": 0.1,
          "numCtx": 8192,
          "numPredict": 2048
        }
      },
      "type": "@n8n/n8n-nodes-langchain.lmChatOllama",
      "typeVersion": 1,
      "position": [
        -4784,
        0
      ],
      "id": "be68a05b-901a-4708-8ea5-9d720c3ecbd0",
      "name": "Ollama Scoring Model",
      "credentials": {
        "ollamaApi": {
          "id": "oS2Qqti9oVfsm8XZ",
          "name": "Ollama account"
        }
      }
    },
    {
      "parameters": {
        "operation": "delete",
        "tableId": "ranking_proveedores",
        "filters": {
          "conditions": [
            {
              "keyName": "project_id",
              "condition": "eq",
              "keyValue": "={{ $('Webhook Scoring').first().json.body.project_id }}"
            }
          ]
        }
      },
      "type": "n8n-nodes-base.supabase",
      "typeVersion": 1,
      "position": [
        -6064,
        -176
      ],
      "id": "c583aa92-611b-42e6-a3bd-dc17152d339e",
      "name": "Delete a row",
      "alwaysOutputData": true,
      "credentials": {
        "supabaseApi": {
          "id": "pI4CpdYLTiEEBmnz",
          "name": "Supabase account"
        }
      }
    },
    {
      "parameters": {
        "options": {}
      },
      "type": "@n8n/n8n-nodes-langchain.lmChatOpenRouter",
      "typeVersion": 1,
      "position": [
        -4688,
        96
      ],
      "id": "a7c94e44-1eea-4639-a981-00a45a64ff3c",
      "name": "OpenRouter Chat Model1",
      "credentials": {
        "openRouterApi": {
          "id": "4AyUqsh1Z35g6bci",
          "name": "OpenRouter account"
        }
      }
    },
    {
      "parameters": {
        "httpMethod": "POST",
        "path": "scoring-evaluation",
        "responseMode": "responseNode",
        "options": {}
      },
      "type": "n8n-nodes-base.webhook",
      "typeVersion": 2.1,
      "position": [
        -6368,
        -176
      ],
      "id": "4a27eda4-b204-4a1d-b0a1-df45d057c5df",
      "name": "Webhook Scoring",
      "webhookId": "scoring-eval-webhook-001"
    }
  ],
  "connections": {
    "Fetch Requirements": {
      "main": [
        [
          {
            "node": "Merge Requirements & Responses",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Fetch Provider Responses": {
      "main": [
        [
          {
            "node": "Merge Requirements & Responses",
            "type": "main",
            "index": 1
          }
        ]
      ]
    },
    "Fetch Scoring Configuration": {
      "main": [
        [
          {
            "node": "Merge Requirements & Responses",
            "type": "main",
            "index": 2
          }
        ]
      ]
    },
    "Merge Requirements & Responses": {
      "main": [
        [
          {
            "node": "Prepare Scoring Data",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Prepare Scoring Data": {
      "main": [
        [
          {
            "node": "Loop Over Providers",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Loop Over Providers": {
      "main": [
        [
          {
            "node": "Aggregate All Rankings",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Scoring LLM Chain",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Scoring LLM Chain": {
      "main": [
        [
          {
            "node": "Calculate Weighted Scores",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Calculate Weighted Scores": {
      "main": [
        [
          {
            "node": "Check Provider Exists",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Check Provider Exists": {
      "main": [
        [
          {
            "node": "Insert Ranking",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Provider Exists?": {
      "main": [
        [
          {
            "node": "Update Ranking",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Insert Ranking",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Update Ranking": {
      "main": [
        [
          {
            "node": "Loop Over Providers",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Insert Ranking": {
      "main": [
        [
          {
            "node": "Loop Over Providers",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Aggregate All Rankings": {
      "main": [
        [
          {
            "node": "Generate Final Ranking",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Generate Final Ranking": {
      "main": [
        [
          {
            "node": "Respond with Ranking",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Set Input Params1": {
      "main": [
        [
          {
            "node": "Fetch Requirements",
            "type": "main",
            "index": 0
          },
          {
            "node": "Fetch Provider Responses",
            "type": "main",
            "index": 0
          },
          {
            "node": "Fetch Scoring Configuration",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "JSON Output Parser1": {
      "ai_outputParser": [
        [
          {
            "node": "Scoring LLM Chain",
            "type": "ai_outputParser",
            "index": 0
          }
        ]
      ]
    },
    "Delete a row": {
      "main": [
        [
          {
            "node": "Set Input Params1",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "OpenRouter Chat Model1": {
      "ai_languageModel": [
        [
          {
            "node": "Scoring LLM Chain",
            "type": "ai_languageModel",
            "index": 0
          }
        ]
      ]
    },
    "Webhook Scoring": {
      "main": [
        [
          {
            "node": "Delete a row",
            "type": "main",
            "index": 0
          }
        ]
      ]
    }
  },
  "pinData": {
    "Webhook Scoring": [
      {
        "headers": {
          "host": "n8n.beaienergy.com",
          "user-agent": "Mozilla/5.0 (Macintosh; Intel Mac OS X 10_15_7) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/144.0.0.0 Safari/537.36",
          "content-length": "95",
          "accept": "*/*",
          "accept-encoding": "gzip, deflate, br, zstd",
          "accept-language": "es-ES,es;q=0.9",
          "content-type": "application/json",
          "origin": "http://localhost:9102",
          "referer": "http://localhost:9102/",
          "sec-ch-ua": "\"Not(A:Brand\";v=\"8\", \"Chromium\";v=\"144\", \"Google Chrome\";v=\"144\"",
          "sec-ch-ua-mobile": "?0",
          "sec-ch-ua-platform": "\"macOS\"",
          "sec-fetch-dest": "empty",
          "sec-fetch-mode": "cors",
          "sec-fetch-site": "same-origin",
          "x-forwarded-for": "193.176.211.207",
          "x-forwarded-host": "n8n.beaienergy.com",
          "x-forwarded-port": "443",
          "x-forwarded-proto": "https",
          "x-forwarded-server": "0a67c8c4e180",
          "x-real-ip": "193.176.211.207"
        },
        "params": {},
        "query": {},
        "body": {
          "project_id": "0558d9ef-5702-430d-8978-2a1f30339cd0",
          "provider_name": "",
          "recalculate_all": true
        },
        "webhookUrl": "https://n8n.beaienergy.com/webhook/scoring-evaluation",
        "executionMode": "production"
      }
    ]
  },
  "meta": {
    "templateCredsSetupCompleted": true,
    "instanceId": "53140335eaf11280ef77ef2f5a378f48c2b28e822e3e0d96563cdd92175c0eff"
  }
}