{
  "nodes": [
    {
      "parameters": {
        "assignments": {
          "assignments": [
            {
              "id": "6d3a985e-7c5e-4c74-8b5e-407e4d8c83a9",
              "name": "project_name",
              "value": "={{ $json.body.project_name }}",
              "type": "string"
            },
            {
              "id": "project-id-uuid-field",
              "name": "project_id",
              "value": "={{ $json.body.project_id }}",
              "type": "string"
            },
            {
              "id": "2d3a985e-7c5e-4c74-8b5e-407e4d8c83a1",
              "name": "provider_name",
              "value": "={{ $json.body.provider_key }}",
              "type": "string"
            },
            {
              "id": "3d3a985e-7c5e-4c74-8b5e-407e4d8c83a2",
              "name": "tone",
              "value": "={{ $json.body.tone }}",
              "type": "string"
            },
            {
              "id": "4d3a985e-7c5e-4c74-8b5e-407e4d8c83a3",
              "name": "qa_items",
              "value": "={{ $json.body.qa_items }}",
              "type": "array"
            }
          ]
        },
        "options": {}
      },
      "type": "n8n-nodes-base.set",
      "typeVersion": 3.4,
      "position": [
        -3328,
        -112
      ],
      "id": "9c48c632-d4ec-4357-80a4-3807d5f30313",
      "name": "Edit Fields"
    },
    {
      "parameters": {
        "jsCode": "// 1. Obtenemos TODOS los datos de Supabase y de Edit Fields\nconst allOffers = $('Get Offers').all();\nconst editFields = $('Edit Fields').first().json;\nconst targetProvider = editFields.provider_name;\nconst qaItems = $('Edit Fields').first().json.qa_items || [];\n\nlet issuesFound = [];\n\n// 2. Iteramos por todos los registros\nfor (const item of allOffers) {\n  const row = item.json;\n  \n  // Solo procesamos si el proveedor coincide\n  if (row.provider_name === targetProvider) {\n    const status = (row.evaluation_value || '').trim();\n    \n    // CRITERIO: Si es distinto de \"INCLUIDO\" (ignorando mayúsculas/minúsculas), es un ISSUE\n    if (status.toUpperCase() !== 'INCLUIDO') {\n      // Usar descripción legible en lugar de UUID\n      const description = row.requirement_text || row.item_description || row.comment || 'Item requires clarification';\n      issuesFound.push({\n        description: description,\n        status: status || 'NOT PROVIDED',\n        provider_comment: row.comment || ''\n      });\n    }\n  }\n}\n\n// 3. Preparar Q&A questions si existen\nconst qaQuestions = qaItems.map(q => ({\n  question: q.question || q.pregunta_texto,\n  discipline: q.discipline || q.disciplina,\n  importance: q.importance || q.importancia\n}));\n\n// 4. Devolvemos un solo objeto con toda la info para el LLM\nreturn {\n  issues: issuesFound,\n  total_issues: issuesFound.length,\n  qa_questions: qaQuestions,\n  total_qa_questions: qaQuestions.length,\n  project_id: editFields.project_id,\n  project_name: editFields.project_name,\n  provider_name: targetProvider,\n  tone: editFields.tone\n};"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        -2880,
        -112
      ],
      "id": "274c19f7-0d3d-49b7-91e0-ba5f43f18e8f",
      "name": "Filter and Aggregate Issues"
    },
    {
      "parameters": {
        "content": "## Email en base datos faltantes\n",
        "height": 864,
        "width": 2016,
        "color": 6
      },
      "type": "n8n-nodes-base.stickyNote",
      "typeVersion": 1,
      "position": [
        -3840,
        -400
      ],
      "id": "08f38ce6-45a3-4e72-89cc-d84e22f00d7c",
      "name": "Sticky Note2"
    },
    {
      "parameters": {
        "httpMethod": "POST",
        "path": "mail-desarrollo",
        "responseMode": "responseNode",
        "options": {}
      },
      "type": "n8n-nodes-base.webhook",
      "typeVersion": 2.1,
      "position": [
        -3552,
        -112
      ],
      "id": "fc99cd64-3238-4d7e-b9f1-936cc9f7f95d",
      "name": "Webhook3",
      "webhookId": "2dcca6b6-4d20-4250-9202-7b16ac06f716"
    },
    {
      "parameters": {
        "operation": "executeQuery",
        "query": "=SELECT * FROM desarrollo.provider_responses WHERE provider_name = '={{ $json.provider_name }}' AND project_id = '={{ $json.project_id }}'",
        "options": {}
      },
      "id": "79460f8d-7a12-467b-acdd-bb455d3f0bc8",
      "name": "Get Offers",
      "type": "n8n-nodes-base.postgres",
      "typeVersion": 2.5,
      "position": [
        -3104,
        -112
      ],
      "alwaysOutputData": true,
      "credentials": {
        "postgres": {
          "id": "V0REAPph5JBLqze3",
          "name": "Postgres account"
        }
      }
    },
    {
      "parameters": {
        "model": "qwen3:8b",
        "options": {
          "temperature": 0.2,
          "numCtx": 4096,
          "numPredict": 1024
        }
      },
      "type": "@n8n/n8n-nodes-langchain.lmChatOllama",
      "typeVersion": 1,
      "position": [
        -2288,
        112
      ],
      "id": "e9ae9670-7957-4faf-9dc4-9b0f689dd726",
      "name": "Ollama Chat Model",
      "credentials": {
        "ollamaApi": {
          "id": "oS2Qqti9oVfsm8XZ",
          "name": "Ollama account"
        }
      }
    },
    {
      "parameters": {
        "promptType": "define",
        "text": "=### INPUT\n\n## PROJECT: {{ $('Edit Fields').first().json.project_name }}\n\n## PROVIDER: {{ $('Edit Fields').first().json.provider_name }}\n\n## REQUIRED TONE: {{ $('Edit Fields').first().json.tone }}\n\n## ISSUES ({{ $json.total_issues }} items): {{ JSON.stringify($json.issues, null, 2) }}\n\n## TECHNICAL QUESTIONS ({{ $json.total_qa_questions }} items): {{ JSON.stringify($json.qa_questions, null, 2) }}\n\n\\n## PROJECT CONTEXT: {{ $('Fetch Project Context Email').first().json.ai_context }}\\n\\n### FINAL INSTRUCTIONS\nReturn ONLY the JSON object. Do NOT think out loud. Do NOT include any text before or after the JSON.\n",
        "messages": {
          "messageValues": [
            {
              "message": "=### ROLE\nYou are an expert Senior Project Engineer and Procurement Manager for large-scale industrial projects (P2X, Green Hydrogen). You are meticulous, diplomatic, and results-oriented.\n\n### TASK\nDraft a professional email to the Provider regarding their recent proposal for the Project. We have identified specific gaps/issues and technical questions that need to be addressed.\n\n### GUIDELINES\n1. **Subject Line**: Must be clear, professional, and reference the Project name.\n2. **Tone**: Strictly adhere to the requested 'TONE' input.\n3. **Body Content**:\n   - Briefly thank them for the proposal.\n   - State that during the review, the following points require clarification or are missing.\n   - **For ISSUES**: Group them intelligently (e.g., by category or type). For each issue, describe what is missing using the 'description' field. NEVER show any IDs, UUIDs, or internal references.\n   - **For TECHNICAL QUESTIONS**: If there are any qa_questions, add a section titled 'Technical Questions' and list them. Include the discipline and importance level for each.\n   - Ask for these specific items to be provided or clarified.\n4. **Formatting**: Use Markdown formatting (bold, bullet points) for readability.\n5. **IMPORTANT**: NEVER include any UUIDs, internal IDs, requirement_id, or database references. Use only human-readable descriptions.\n\n### CRITICAL: OUTPUT RESTRICTIONS\n- Return **ONLY** a valid JSON object.\n- **DO NOT** include any UUIDs or internal database IDs anywhere in the output.\n- **DO NOT** include any conversational text, explanations, reasoning, thoughts, or technical notes.\n- **DO NOT** use Markdown code blocks (e.g., ```json).\n- The output must start with `{` and end with `}`.\n\n### SCHEMA\n{\n  \"subject\": \"Email Subject Here\",\n  \"body\": \"Email Body Here with **bold** and - bullet points\"\n}"
            }
          ]
        },
        "batching": {}
      },
      "type": "@n8n/n8n-nodes-langchain.chainLlm",
      "typeVersion": 1.8,
      "position": [
        -2656,
        -112
      ],
      "id": "c6220f22-cd4a-49f7-a451-337e49bf6c88",
      "name": "Basic LLM Chain"
    },
    {
      "parameters": {
        "respondWith": "allIncomingItems",
        "options": {}
      },
      "type": "n8n-nodes-base.respondToWebhook",
      "typeVersion": 1.5,
      "position": [
        -2304,
        -112
      ],
      "id": "79069bed-516d-47f3-8ecd-45e35d65705f",
      "name": "Respond to Webhook3"
    },
    {
      "parameters": {
        "model": "mistral-large-latest",
        "options": {
          "temperature": 0.1
        }
      },
      "type": "@n8n/n8n-nodes-langchain.lmChatMistralCloud",
      "typeVersion": 1,
      "position": [
        -2736,
        96
      ],
      "id": "56893586-ef16-4356-829a-ab8b46f2de5f",
      "name": "Mistral Cloud Chat Model1",
      "credentials": {
        "mistralCloudApi": {
          "id": "tDjuOnF6lpADMmd5",
          "name": "Mistral Cloud account"
        }
      }
    },
    {
      "parameters": {
        "assignments": {
          "assignments": [
            {
              "id": "to-field",
              "name": "to",
              "value": "={{ $json.body.to }}",
              "type": "string"
            },
            {
              "id": "subject-field",
              "name": "subject",
              "value": "={{ $json.body.subject }}",
              "type": "string"
            },
            {
              "id": "body-field",
              "name": "email_body",
              "value": "={{ $json.body.body }}",
              "type": "string"
            },
            {
              "id": "provider-field",
              "name": "provider_name",
              "value": "={{ $json.body.provider_name }}",
              "type": "string"
            },
            {
              "id": "project-id-field",
              "name": "project_id",
              "value": "={{ $json.body.project_id }}",
              "type": "string"
            },
            {
              "id": "project-name-field",
              "name": "project_name",
              "value": "={{ $json.body.project_name }}",
              "type": "string"
            }
          ]
        },
        "options": {}
      },
      "type": "n8n-nodes-base.set",
      "typeVersion": 3.4,
      "position": [
        -3312,
        976
      ],
      "id": "4c7d060b-effa-4275-ad96-fca787530e8d",
      "name": "Extract Fields"
    },
    {
      "parameters": {
        "conditions": {
          "options": {
            "caseSensitive": true,
            "leftValue": "",
            "typeValidation": "strict",
            "version": 2
          },
          "conditions": [
            {
              "id": "check-to-email",
              "leftValue": "={{ $json.to }}",
              "rightValue": "",
              "operator": {
                "type": "string",
                "operation": "notEmpty"
              }
            },
            {
              "id": "check-subject",
              "leftValue": "={{ $json.subject }}",
              "rightValue": "",
              "operator": {
                "type": "string",
                "operation": "notEmpty"
              }
            },
            {
              "id": "check-body",
              "leftValue": "={{ $json.email_body }}",
              "rightValue": "",
              "operator": {
                "type": "string",
                "operation": "notEmpty"
              }
            }
          ],
          "combinator": "and"
        },
        "options": {}
      },
      "type": "n8n-nodes-base.if",
      "typeVersion": 2.2,
      "position": [
        -3088,
        976
      ],
      "id": "9480e86c-3d8b-47de-975f-bf09824d4710",
      "name": "Validate Data"
    },
    {
      "parameters": {
        "jsCode": "// Convert markdown body to HTML for email\nconst markdownBody = $('Extract Fields').first().json.email_body;\n\n// Simple markdown to HTML conversion\nlet htmlBody = markdownBody\n  // Convert bold\n  .replace(/\\*\\*(.+?)\\*\\*/g, '<strong>$1</strong>')\n  // Convert italic\n  .replace(/\\*(.+?)\\*/g, '<em>$1</em>')\n  // Convert bullet points\n  .replace(/^- (.+)$/gm, '<li>$1</li>')\n  // Wrap lists\n  .replace(/(<li>.*<\\/li>\\n?)+/g, '<ul>$&</ul>')\n  // Convert line breaks to paragraphs\n  .split('\\n\\n')\n  .map(p => p.trim())\n  .filter(p => p.length > 0)\n  .map(p => {\n    if (p.startsWith('<ul>') || p.startsWith('<li>')) return p;\n    return `<p>${p}</p>`;\n  })\n  .join('\\n');\n\n// Add email styling\nconst styledHtml = `\n<!DOCTYPE html>\n<html>\n<head>\n  <style>\n    body { font-family: Arial, sans-serif; line-height: 1.6; color: #333; max-width: 800px; margin: 0 auto; padding: 20px; }\n    p { margin: 0 0 16px 0; }\n    ul { margin: 0 0 16px 0; padding-left: 24px; }\n    li { margin: 4px 0; }\n    strong { font-weight: 600; }\n  </style>\n</head>\n<body>\n${htmlBody}\n</body>\n</html>\n`;\n\nreturn {\n  html_body: styledHtml,\n  to: $('Extract Fields').first().json.to,\n  subject: $('Extract Fields').first().json.subject,\n  provider_name: $('Extract Fields').first().json.provider_name,\n  project_id: $('Extract Fields').first().json.project_id,\n  project_name: $('Extract Fields').first().json.project_name\n};"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        -2864,
        864
      ],
      "id": "5d8c0ab9-a835-4dc9-9046-7fb6b3434d7d",
      "name": "Convert Markdown to HTML"
    },
    {
      "parameters": {
        "sendTo": "={{ $json.to }}",
        "subject": "={{ $json.subject }}",
        "message": "={{ $json.html_body }}",
        "options": {
          "appendAttribution": false
        }
      },
      "type": "n8n-nodes-base.gmail",
      "typeVersion": 2.1,
      "position": [
        -2656,
        864
      ],
      "id": "89260dba-7e9e-4ca9-b0e1-346375eb1634",
      "name": "Gmail Send",
      "webhookId": "f32bcbf1-73d7-463b-b209-b7e114249ee9",
      "disabled": true
    },
    {
      "parameters": {
        "respondWith": "json",
        "responseBody": "={{ JSON.stringify({ success: false, error: 'Missing required fields: to, subject, or body' }) }}",
        "options": {
          "responseCode": 400
        }
      },
      "type": "n8n-nodes-base.respondToWebhook",
      "typeVersion": 1.5,
      "position": [
        -2864,
        1072
      ],
      "id": "045d3fad-037e-437f-9846-4461d0b23575",
      "name": "Respond Error"
    },
    {
      "parameters": {
        "content": "## QA Send Email Workflow\n\nThis workflow receives email data from the Mail Dashboard and sends it via Gmail.\n\n**Expected POST body:**\n```json\n{\n  \"to\": \"recipient@email.com\",\n  \"subject\": \"Email Subject\",\n  \"body\": \"Email body in Markdown format\",\n  \"provider_name\": \"Provider Name\",\n  \"project_id\": \"project-uuid\",\n  \"project_name\": \"Project Name\"\n}\n```\n\n**IMPORTANT:** Configure Gmail OAuth2 credentials in the Gmail node.",
        "height": 724,
        "width": 1788,
        "color": 6
      },
      "type": "n8n-nodes-base.stickyNote",
      "typeVersion": 1,
      "position": [
        -3840,
        512
      ],
      "id": "3c295b90-d5c9-4ece-8a88-e811c882c65a",
      "name": "Instructions"
    },
    {
      "parameters": {
        "httpMethod": "POST",
        "path": "qa-send-email-desarrollo",
        "responseMode": "responseNode",
        "options": {}
      },
      "type": "n8n-nodes-base.webhook",
      "typeVersion": 2.1,
      "position": [
        -3536,
        976
      ],
      "id": "b5956b03-d0a2-4691-9d79-94544459d506",
      "name": "Webhook2",
      "webhookId": "qa-send-email-webhook"
    },
    {
      "parameters": {
        "respondWith": "json",
        "responseBody": "={{ JSON.stringify({ success: true, message: 'Email sent successfully', to: $json.to, subject: $json.subject }) }}",
        "options": {
          "responseCode": 200
        }
      },
      "type": "n8n-nodes-base.respondToWebhook",
      "typeVersion": 1.5,
      "position": [
        -2432,
        864
      ],
      "id": "1458b5b9-0f73-474f-b858-ffef4334dcbd",
      "name": "Respond Success2"
    },
    {
      "parameters": {
        "httpMethod": "POST",
        "path": "qa-send-to-supplier-desarrollo",
        "responseMode": "responseNode",
        "options": {}
      },
      "type": "n8n-nodes-base.webhook",
      "typeVersion": 2.1,
      "position": [
        -1328,
        2144
      ],
      "id": "9524345b-8380-4367-af82-f53e8e956bf9",
      "name": "Webhook Receive",
      "webhookId": "qa-send-to-supplier-webhook"
    },
    {
      "parameters": {
        "conditions": {
          "options": {
            "caseSensitive": true,
            "leftValue": "",
            "typeValidation": "strict"
          },
          "conditions": [
            {
              "id": "check-email",
              "leftValue": "={{ $json.email_to }}",
              "rightValue": "",
              "operator": {
                "type": "string",
                "operation": "notEmpty"
              }
            }
          ],
          "combinator": "and"
        },
        "options": {}
      },
      "type": "n8n-nodes-base.if",
      "typeVersion": 2.1,
      "position": [
        464,
        2144
      ],
      "id": "d2a32dbe-ccae-4642-afdd-57149826535a",
      "name": "Email Provided?"
    },
    {
      "parameters": {
        "sendTo": "={{ $json.email_to }}",
        "subject": "={{ $json.email_subject }}",
        "message": "={{ $json.email_html }}",
        "options": {
          "senderName": "BidEval Team"
        }
      },
      "type": "n8n-nodes-base.gmail",
      "typeVersion": 2.1,
      "position": [
        688,
        2080
      ],
      "id": "2caa2aad-9b6e-4623-93e4-39f0828f973f",
      "name": "Send Email via Gmail",
      "webhookId": "9be31203-685f-4b78-a56d-e950bca3a806",
      "disabled": true
    },
    {
      "parameters": {
        "jsCode": "// Generate a random token without crypto module\nfunction generateToken(length = 64) {\n  const chars = 'abcdef0123456789';\n  let token = '';\n  for (let i = 0; i < length; i++) {\n    token += chars.charAt(Math.floor(Math.random() * chars.length));\n  }\n  // Add timestamp for uniqueness\n  const timestamp = Date.now().toString(16);\n  return (timestamp + token).slice(0, 64);\n}\n\nconst token = generateToken();\n\n// Calculate expiration date\nconst expiresDays = $input.first().json.expires_days || 7;\nconst expiresAt = new Date();\nexpiresAt.setDate(expiresAt.getDate() + expiresDays);\n\nreturn {\n  json: {\n    ...$input.first().json,\n    token: token,\n    expires_at: expiresAt.toISOString()\n  }\n};"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        -880,
        2144
      ],
      "id": "24f77bbf-27a8-4a26-b357-b080b029d045",
      "name": "Generate Token"
    },
    {
      "parameters": {
        "operation": "executeQuery",
        "query": "=INSERT INTO desarrollo.qa_response_tokens (project_id, token, provider_name, question_ids, expires_at) VALUES ('={{ $json.project_id }}', '={{ $json.token }}', '={{ $json.provider_name }}', '={{ $json.question_ids }}', '={{ $json.expires_at }}') RETURNING *",
        "options": {}
      },
      "type": "n8n-nodes-base.postgres",
      "typeVersion": 2.5,
      "position": [
        -656,
        2144
      ],
      "id": "2ae2b344-c633-4902-b62f-656665ff9ff0",
      "name": "Save Token to DB",
      "credentials": {
        "postgres": {
          "id": "V0REAPph5JBLqze3",
          "name": "Postgres account"
        }
      }
    },
    {
      "parameters": {
        "jsCode": "// Split question_ids array into individual items\nconst questionIds = $(\"Set Input Params2\").first().json.question_ids || [];\n\n// Return each ID as a separate item\nreturn questionIds.map(id => ({\n  json: {\n    question_id: id\n  }\n}));"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        -432,
        2048
      ],
      "id": "d6e412ca-a6c0-49a4-9514-71162d9ec3c2",
      "name": "Split Question IDs"
    },
    {
      "parameters": {
        "operation": "executeQuery",
        "query": "=SELECT * FROM desarrollo.qa_audit WHERE id = '={{ $json.question_id }}' LIMIT 1",
        "options": {}
      },
      "type": "n8n-nodes-base.postgres",
      "typeVersion": 2.5,
      "position": [
        -208,
        2048
      ],
      "id": "d17122ab-46fc-4ac2-821e-23aa0cb616cb",
      "name": "Fetch Questions",
      "credentials": {
        "postgres": {
          "id": "V0REAPph5JBLqze3",
          "name": "Postgres account"
        }
      }
    },
    {
      "parameters": {
        "operation": "executeQuery",
        "query": "=SELECT * FROM desarrollo.projects WHERE id = '={{ $(\"Set Input Params2\").first().json.project_id }}' LIMIT 1",
        "options": {}
      },
      "type": "n8n-nodes-base.postgres",
      "typeVersion": 2.5,
      "position": [
        -208,
        2240
      ],
      "id": "c6091a1a-cf4e-4e72-b67c-97e92d08cb1e",
      "name": "Fetch Project Name",
      "credentials": {
        "postgres": {
          "id": "V0REAPph5JBLqze3",
          "name": "Postgres account"
        }
      }
    },
    {
      "parameters": {
        "mode": "combine",
        "combineBy": "combineAll",
        "options": {}
      },
      "type": "n8n-nodes-base.merge",
      "typeVersion": 3,
      "position": [
        16,
        2144
      ],
      "id": "2e5068b2-03fc-4dda-b95d-54002f32b1d8",
      "name": "Merge Data"
    },
    {
      "parameters": {
        "jsCode": "const items = $input.all();\nconst inputParams = $(\"Generate Token\").first().json;\nconst projectData = items.find(i => i.json.display_name)?.json || {};\nconst questions = items.filter(i => i.json.question);\n\n// Build the response link - UPDATE THIS URL TO YOUR FRONTEND\nconst frontendUrl = 'http://portalia.ignisenergia.es:9102';\nconst responseLink = `${frontendUrl}/respond/${inputParams.token}`;\n\n// Build questions HTML for email\nconst questionsHtml = questions.map((q, idx) => `\n  <tr>\n    <td style=\"padding: 12px; border-bottom: 1px solid #e2e8f0;\">${idx + 1}</td>\n    <td style=\"padding: 12px; border-bottom: 1px solid #e2e8f0;\">${q.json.discipline || 'General'}</td>\n    <td style=\"padding: 12px; border-bottom: 1px solid #e2e8f0;\">${q.json.question}</td>\n    <td style=\"padding: 12px; border-bottom: 1px solid #e2e8f0;\">\n      <span style=\"padding: 4px 8px; border-radius: 4px; font-size: 12px; background: ${q.json.importance === 'High' ? '#fee2e2' : q.json.importance === 'Medium' ? '#fef3c7' : '#dcfce7'}; color: ${q.json.importance === 'High' ? '#991b1b' : q.json.importance === 'Medium' ? '#92400e' : '#166534'};\">\n        ${q.json.importance || 'Medium'}\n      </span>\n    </td>\n  </tr>\n`).join('');\n\n// Build email HTML\nconst emailHtml = `\n<!DOCTYPE html>\n<html>\n<head>\n  <meta charset=\"utf-8\">\n  <meta name=\"viewport\" content=\"width=device-width, initial-scale=1.0\">\n</head>\n<body style=\"margin: 0; padding: 0; font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif; background-color: #f8fafc;\">\n  <div style=\"max-width: 600px; margin: 0 auto; padding: 40px 20px;\">\n    <!-- Header -->\n    <div style=\"text-align: center; margin-bottom: 32px;\">\n      <h1 style=\"margin: 0; font-size: 28px;\">\n        <span style=\"color: #1e293b;\">Bid</span><span style=\"color: #12b5b0;\">Eval</span>\n      </h1>\n      <p style=\"margin: 8px 0 0; color: #64748b;\">Technical Evaluation Platform</p>\n    </div>\n    \n    <!-- Main Card -->\n    <div style=\"background: white; border-radius: 16px; padding: 32px; box-shadow: 0 4px 24px rgba(0,0,0,0.08);\">\n      <h2 style=\"margin: 0 0 8px; color: #1e293b; font-size: 20px;\">Technical Questionnaire Request</h2>\n      <p style=\"margin: 0 0 24px; color: #64748b;\">Project: <strong>${projectData.display_name || 'N/A'}</strong></p>\n      \n      <p style=\"color: #475569; line-height: 1.6;\">\n        Dear <strong>${inputParams.provider_name}</strong> team,\n      </p>\n      <p style=\"color: #475569; line-height: 1.6;\">\n        As part of the technical evaluation process, we have prepared a questionnaire with <strong>${questions.length}</strong> questions that require your response.\n      </p>\n      \n      <!-- Questions Table -->\n      <div style=\"margin: 24px 0; overflow-x: auto;\">\n        <table style=\"width: 100%; border-collapse: collapse; font-size: 14px;\">\n          <thead>\n            <tr style=\"background: #f1f5f9;\">\n              <th style=\"padding: 12px; text-align: left; font-weight: 600; color: #475569;\">#</th>\n              <th style=\"padding: 12px; text-align: left; font-weight: 600; color: #475569;\">Discipline</th>\n              <th style=\"padding: 12px; text-align: left; font-weight: 600; color: #475569;\">Question</th>\n              <th style=\"padding: 12px; text-align: left; font-weight: 600; color: #475569;\">Priority</th>\n            </tr>\n          </thead>\n          <tbody>\n            ${questionsHtml}\n          </tbody>\n        </table>\n      </div>\n      \n      <!-- CTA Button -->\n      <div style=\"text-align: center; margin: 32px 0;\">\n        <a href=\"${responseLink}\" style=\"display: inline-block; padding: 16px 48px; background: linear-gradient(135deg, #12b5b0 0%, #0d9488 100%); color: white; text-decoration: none; border-radius: 12px; font-weight: 600; font-size: 16px;\">Respond to Questionnaire</a>\n      </div>\n      \n      <p style=\"color: #64748b; font-size: 14px;\">\n        This link will expire on <strong>${new Date(inputParams.expires_at).toLocaleDateString('en-US', { year: 'numeric', month: 'long', day: 'numeric' })}</strong>.\n      </p>\n      \n      <hr style=\"border: none; border-top: 1px solid #e2e8f0; margin: 24px 0;\">\n      \n      <p style=\"color: #94a3b8; font-size: 12px; margin: 0;\">\n        If you have any questions, please contact the evaluation team.\n      </p>\n    </div>\n    \n    <!-- Footer -->\n    <div style=\"text-align: center; margin-top: 32px; color: #94a3b8; font-size: 12px;\">\n      <p style=\"margin: 0;\">Powered by BidEval - Technical Evaluation Platform</p>\n    </div>\n  </div>\n</body>\n</html>\n`;\n\nreturn {\n  json: {\n    success: true,\n    token: inputParams.token,\n    response_link: responseLink,\n    expires_at: inputParams.expires_at,\n    project_name: projectData.display_name,\n    provider_name: inputParams.provider_name,\n    question_count: questions.length,\n    email_to: inputParams.email_to,\n    email_subject: `Technical Questionnaire - ${projectData.display_name || 'BidEval'}`,\n    email_html: emailHtml\n  }\n};"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        240,
        2144
      ],
      "id": "5c544fad-8c5a-4188-9a56-7b4f98cd88ca",
      "name": "Build Email Content"
    },
    {
      "parameters": {
        "jsCode": "// Split question_ids for update\nconst questionIds = $(\"Set Input Params2\").first().json.question_ids || [];\nreturn questionIds.map(id => ({ json: { question_id: id } }));"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        912,
        2144
      ],
      "id": "749c0d59-ce4e-44d3-8160-62b85fc14524",
      "name": "Split for Update"
    },
    {
      "parameters": {
        "operation": "executeQuery",
        "query": "=UPDATE desarrollo.qa_audit SET status = 'Sent' WHERE id = '={{ $json.question_id }}' RETURNING *",
        "options": {}
      },
      "type": "n8n-nodes-base.postgres",
      "typeVersion": 2.5,
      "position": [
        1136,
        2144
      ],
      "id": "b78ec1d6-c0bc-4678-b607-9a88ca43f7f6",
      "name": "Update Question Status",
      "credentials": {
        "postgres": {
          "id": "V0REAPph5JBLqze3",
          "name": "Postgres account"
        }
      }
    },
    {
      "parameters": {
        "assignments": {
          "assignments": [
            {
              "id": "project_id",
              "name": "project_id",
              "value": "={{ $json.body?.project_id || $json.project_id }}",
              "type": "string"
            },
            {
              "id": "provider_name",
              "name": "provider_name",
              "value": "={{ $json.body?.provider_name || $json.provider_name }}",
              "type": "string"
            },
            {
              "id": "question_ids",
              "name": "question_ids",
              "value": "={{ $json.body?.question_ids || $json.question_ids }}",
              "type": "array"
            },
            {
              "id": "email_to",
              "name": "email_to",
              "value": "={{ $json.body?.email_to || $json.email_to || '' }}",
              "type": "string"
            },
            {
              "id": "expires_days",
              "name": "expires_days",
              "value": "={{ $json.body?.expires_days || $json.expires_days || 7 }}",
              "type": "number"
            }
          ]
        },
        "options": {}
      },
      "type": "n8n-nodes-base.set",
      "typeVersion": 3.4,
      "position": [
        -1104,
        2144
      ],
      "id": "ec46e95a-af93-41dd-8a6d-c642ac7940d4",
      "name": "Set Input Params2"
    },
    {
      "parameters": {
        "respondWith": "json",
        "responseBody": "={{ $(\"Build Email Content\").first().json }}",
        "options": {}
      },
      "type": "n8n-nodes-base.respondToWebhook",
      "typeVersion": 1.5,
      "position": [
        1360,
        2144
      ],
      "id": "6d1e3931-fb15-4c61-8e34-b14f0ccb9e4c",
      "name": "Respond to Webhook2"
    },
    {
      "parameters": {
        "content": "## QA Send to Supplier Workflow\n\n**Purpose:** Generate a unique token, send email via Gmail, and create response link for suppliers.\n\n**Input (POST body):**\n```json\n{\n  \"project_id\": \"uuid\",\n  \"provider_name\": \"IDOM\",\n  \"question_ids\": [\"uuid1\", \"uuid2\"],\n  \"email_to\": \"supplier@example.com\",\n  \"expires_days\": 7\n}\n```\n\n**Flow:**\n1. Generate 64-char token\n2. Save to `qa_response_tokens`\n3. Build HTML email\n4. If email_to provided → Send via Gmail\n5. Update questions status to 'Sent'\n6. Return response link\n\n**Gmail Setup:**\nConfigure Gmail OAuth2 credentials in n8n.",
        "height": 688,
        "width": 3328,
        "color": 2
      },
      "type": "n8n-nodes-base.stickyNote",
      "typeVersion": 1,
      "position": [
        -1696,
        1760
      ],
      "id": "cef58b53-ae1e-48dd-bead-3c45d518643c",
      "name": "Sticky Note3"
    },
    {
      "parameters": {
        "operation": "executeQuery",
        "query": "=SELECT * FROM desarrollo.qa_response_tokens WHERE token = '={{ $json.token }}' LIMIT 1",
        "options": {}
      },
      "type": "n8n-nodes-base.postgres",
      "typeVersion": 2.5,
      "position": [
        -5488,
        1920
      ],
      "id": "7088920d-c1f1-4fac-8d6d-e6969ee3f553",
      "name": "Validate Token",
      "credentials": {
        "postgres": {
          "id": "V0REAPph5JBLqze3",
          "name": "Postgres account"
        }
      }
    },
    {
      "parameters": {
        "conditions": {
          "options": {
            "caseSensitive": true,
            "leftValue": "",
            "typeValidation": "strict"
          },
          "conditions": [
            {
              "id": "token-valid",
              "leftValue": "={{ $json.status }}",
              "rightValue": "responded",
              "operator": {
                "type": "string",
                "operation": "notEquals"
              }
            },
            {
              "id": "not-expired",
              "leftValue": "={{ new Date($json.expires_at) > new Date() }}",
              "rightValue": true,
              "operator": {
                "type": "boolean",
                "operation": "equals"
              }
            }
          ],
          "combinator": "and"
        },
        "options": {}
      },
      "type": "n8n-nodes-base.if",
      "typeVersion": 2.2,
      "position": [
        -5264,
        1920
      ],
      "id": "6322b5f0-ed96-4d35-b434-995efa2eb3c5",
      "name": "Token Valid?"
    },
    {
      "parameters": {
        "respondWith": "json",
        "responseBody": "={\n  \"success\": false,\n  \"error\": \"Token is invalid, expired, or already used\"\n}",
        "options": {
          "responseCode": 400
        }
      },
      "type": "n8n-nodes-base.respondToWebhook",
      "typeVersion": 1.5,
      "position": [
        -5040,
        2096
      ],
      "id": "675b4542-2844-47d7-bf49-9b11185125c0",
      "name": "Respond Invalid"
    },
    {
      "parameters": {
        "jsCode": "// Get responses from the original input and token data\nconst inputParams = $('Set Input Params3').first().json;\nconst tokenData = $input.first().json;\n\nconst responses = inputParams.responses || [];\n\n// Return each response as a separate item with all context needed\nreturn responses.map(response => ({\n  json: {\n    // Token data\n    token_id: tokenData.id,\n    project_id: tokenData.project_id,\n    provider_name: tokenData.provider_name,\n    token: tokenData.token,\n    // Question data\n    question_id: response.question_id,\n    response_text: response.response_text\n  }\n}));"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        -5040,
        1920
      ],
      "id": "cd563430-09d3-4855-a06d-9a2a8c3e60c4",
      "name": "Split Responses"
    },
    {
      "parameters": {
        "options": {}
      },
      "type": "n8n-nodes-base.splitInBatches",
      "typeVersion": 3,
      "position": [
        -4816,
        1920
      ],
      "id": "75750f72-218c-457c-8319-edfd2e03554a",
      "name": "Loop Over Items"
    },
    {
      "parameters": {
        "operation": "executeQuery",
        "query": "=UPDATE desarrollo.qa_audit SET response = '={{ $json.response_text }}', status = 'Answered', responded_at = '={{ new Date().toISOString() }}', response_source = 'portal' WHERE id = '={{ $json.question_id }}' RETURNING *",
        "options": {}
      },
      "type": "n8n-nodes-base.postgres",
      "typeVersion": 2.5,
      "position": [
        -4592,
        1920
      ],
      "id": "326b084f-cf6a-4270-afd8-bb9d62e9f0f1",
      "name": "Save Response to QA Audit",
      "credentials": {
        "postgres": {
          "id": "V0REAPph5JBLqze3",
          "name": "Postgres account"
        }
      }
    },
    {
      "parameters": {
        "operation": "executeQuery",
        "query": "=SELECT * FROM desarrollo.qa_audit WHERE id = '={{ $('Loop Over Items').item.json.question_id }}' LIMIT 1",
        "options": {}
      },
      "type": "n8n-nodes-base.postgres",
      "typeVersion": 2.5,
      "position": [
        -4368,
        1920
      ],
      "id": "e6c80040-25cf-4eb9-8ba8-5a7f8bf0d680",
      "name": "Fetch Question Details",
      "alwaysOutputData": true,
      "credentials": {
        "postgres": {
          "id": "V0REAPph5JBLqze3",
          "name": "Postgres account"
        }
      }
    },
    {
      "parameters": {
        "conditions": {
          "options": {
            "caseSensitive": true,
            "leftValue": "",
            "typeValidation": "strict",
            "version": 2
          },
          "conditions": [
            {
              "id": "has-requirement",
              "leftValue": "={{ $json.requirement_id }}",
              "rightValue": "",
              "operator": {
                "type": "string",
                "operation": "notEmpty"
              }
            }
          ],
          "combinator": "and"
        },
        "options": {}
      },
      "type": "n8n-nodes-base.if",
      "typeVersion": 2.2,
      "position": [
        -4144,
        1920
      ],
      "id": "24c1f0df-ab40-47f4-beb0-eca235c6061d",
      "name": "Has Requirement?"
    },
    {
      "parameters": {
        "operation": "executeQuery",
        "query": "=SELECT * FROM desarrollo.rfq_items_master WHERE id = '={{ $('Fetch Question Details').first().json.requirement_id }}' LIMIT 1",
        "options": {}
      },
      "type": "n8n-nodes-base.postgres",
      "typeVersion": 2.5,
      "position": [
        -3920,
        1808
      ],
      "id": "a55d5ec8-51cf-473c-a8c5-b1c2bde8f9c6",
      "name": "Fetch Requirement",
      "alwaysOutputData": true,
      "credentials": {
        "postgres": {
          "id": "V0REAPph5JBLqze3",
          "name": "Postgres account"
        }
      }
    },
    {
      "parameters": {
        "operation": "executeQuery",
        "query": "=SELECT * FROM desarrollo.provider_responses WHERE requirement_id = '={{ $('Fetch Question Details').first().json.requirement_id }}' AND provider_name = '={{ $('Loop Over Items').item.json.provider_name }}'",
        "options": {}
      },
      "type": "n8n-nodes-base.postgres",
      "typeVersion": 2.5,
      "position": [
        -3696,
        1808
      ],
      "id": "07d7f9c5-b762-4590-a939-5eed11171b88",
      "name": "Fetch Current Evaluation",
      "alwaysOutputData": true,
      "credentials": {
        "postgres": {
          "id": "V0REAPph5JBLqze3",
          "name": "Postgres account"
        }
      }
    },
    {
      "parameters": {
        "promptType": "define",
        "text": "=You are a technical evaluation expert. Based on a supplier's clarifying response, re-evaluate if a requirement is now better satisfied.\n\n**ORIGINAL REQUIREMENT:**\n{{ $('Fetch Requirement').first().json.requirement_text }}\n\n**CURRENT EVALUATION:**\nStatus: {{ $json.evaluation_value || 'NO INCLUIDO' }}\nScore: {{ $json.score || 0 }}/10\nComment: {{ $json.comment || 'Not evaluated' }}\n\n**SUPPLIER'S CLARIFYING RESPONSE:**\n{{ $('Loop Over Items').item.json.response_text }}\n\n**INSTRUCTIONS:**\n1. Analyze if the supplier's response addresses the gaps in the original requirement.\n2. Determine if the evaluation should be improved.\n3. Only improve the score if the response provides substantial new information.\n4. Be conservative - don't upgrade unless clearly justified.\n\n**RESPOND STRICTLY WITH JSON:**\n{\n  \"should_update\": true/false,\n  \"new_evaluation_value\": \"INCLUIDO\" | \"PARCIAL\" | \"NO INCLUIDO\",\n  \"new_score\": 0-10,\n  \"new_comment\": \"Brief explanation of change or why no change\",\n  \"confidence\": 0-100\n}",
        "hasOutputParser": true,
        "batching": {}
      },
      "type": "@n8n/n8n-nodes-langchain.chainLlm",
      "typeVersion": 1.8,
      "position": [
        -3472,
        1808
      ],
      "id": "ed7c5129-84bf-4d4b-9c7b-c2f4b5d58bed",
      "name": "LLM Re-evaluate"
    },
    {
      "parameters": {
        "conditions": {
          "options": {
            "caseSensitive": true,
            "leftValue": "",
            "typeValidation": "strict"
          },
          "conditions": [
            {
              "id": "should-update",
              "leftValue": "={{ $json.output.should_update }}",
              "rightValue": true,
              "operator": {
                "type": "boolean",
                "operation": "equals"
              }
            },
            {
              "id": "high-confidence",
              "leftValue": "={{ $json.output.confidence }}",
              "rightValue": 70,
              "operator": {
                "type": "number",
                "operation": "gte"
              }
            }
          ],
          "combinator": "and"
        },
        "options": {}
      },
      "type": "n8n-nodes-base.if",
      "typeVersion": 2.2,
      "position": [
        -3248,
        1808
      ],
      "id": "6240382f-4aed-4e22-83ed-e1027a503a5d",
      "name": "Should Update?"
    },
    {
      "parameters": {
        "operation": "executeQuery",
        "query": "=UPDATE desarrollo.provider_responses SET evaluation_value = '={{ $json.output.new_evaluation_value }}', score = '={{ $json.output.new_score }}', comment = '={{ $json.output.new_comment + ' [Updated after supplier response]' }}' WHERE requirement_id = '={{ $('Fetch Question Details').first().json.requirement_id }}' AND provider_name = '={{ $('Loop Over Items').item.json.provider_name }}' RETURNING *",
        "options": {}
      },
      "type": "n8n-nodes-base.postgres",
      "typeVersion": 2.5,
      "position": [
        -3024,
        1728
      ],
      "id": "5b04bb5e-622f-4e4e-aa15-21433e716f9e",
      "name": "Update Provider Response",
      "credentials": {
        "postgres": {
          "id": "V0REAPph5JBLqze3",
          "name": "Postgres account"
        }
      }
    },
    {
      "parameters": {},
      "type": "n8n-nodes-base.noOp",
      "typeVersion": 1,
      "position": [
        -3024,
        1888
      ],
      "id": "38287dd0-9319-4ba5-bc5b-a0e112e5b0d6",
      "name": "Skip Update"
    },
    {
      "parameters": {},
      "type": "n8n-nodes-base.noOp",
      "typeVersion": 1,
      "position": [
        -3920,
        2032
      ],
      "id": "72a3b8d2-6801-4cbc-86a1-696fb4246abf",
      "name": "No Requirement"
    },
    {
      "parameters": {},
      "type": "n8n-nodes-base.merge",
      "typeVersion": 3,
      "position": [
        -2800,
        1920
      ],
      "id": "fc70a2ea-9a38-42f9-8d07-13cfa7579fe0",
      "name": "Merge Results"
    },
    {
      "parameters": {
        "operation": "executeQuery",
        "query": "=UPDATE desarrollo.qa_response_tokens SET status = 'responded', responded_at = '={{ new Date().toISOString() }}' WHERE token = '={{ $('Set Input Params3').first().json.token }}' RETURNING *",
        "options": {}
      },
      "type": "n8n-nodes-base.postgres",
      "typeVersion": 2.5,
      "position": [
        -2576,
        1920
      ],
      "id": "0baaa8dc-f85f-49cc-8a6a-b78b16ac180b",
      "name": "Mark Token Responded",
      "credentials": {
        "postgres": {
          "id": "V0REAPph5JBLqze3",
          "name": "Postgres account"
        }
      }
    },
    {
      "parameters": {
        "operation": "executeQuery",
        "query": "=INSERT INTO desarrollo.qa_notifications (project_id, provider_name, notification_type, title, message, metadata) VALUES ('={{ $('Validate Token').first().json.project_id }}', '={{ $('Validate Token').first().json.provider_name }}', 'supplier_responded', '=Supplier {{ $('Validate Token').first().json.provider_name }} has responded', '={{ $('Set Input Params3').first().json.responses.length || 0 }} question(s) answered via the supplier portal', '={{ JSON.stringify({ response_count: $('Set Input Params3').first().json.responses.length || 0, token: $('Set Input Params3').first().json.token }) }}') RETURNING *",
        "options": {}
      },
      "type": "n8n-nodes-base.postgres",
      "typeVersion": 2.5,
      "position": [
        -2352,
        1920
      ],
      "id": "4673b087-c7be-45e2-9e68-3e8c2e4afed2",
      "name": "Create Notification",
      "credentials": {
        "postgres": {
          "id": "V0REAPph5JBLqze3",
          "name": "Postgres account"
        }
      }
    },
    {
      "parameters": {
        "respondWith": "json",
        "responseBody": "={\n  \"success\": true,\n  \"message\": \"Responses processed and evaluations updated\",\n  \"processed_count\": {{ $('Set Input Params3').first().json.responses.length || 0 }}\n}",
        "options": {}
      },
      "type": "n8n-nodes-base.respondToWebhook",
      "typeVersion": 1.5,
      "position": [
        -2128,
        1920
      ],
      "id": "62e51184-ba08-42e7-9dbb-0b25975d79d6",
      "name": "Respond Success"
    },
    {
      "parameters": {
        "httpMethod": "POST",
        "path": "qa-process-responses-desarrollo",
        "responseMode": "responseNode",
        "options": {}
      },
      "type": "n8n-nodes-base.webhook",
      "typeVersion": 2.1,
      "position": [
        -5920,
        1920
      ],
      "id": "3eb18943-aed7-4969-bc25-8d5e91277f35",
      "name": "Webhook Receive1",
      "webhookId": "qa-process-responses-webhook"
    },
    {
      "parameters": {
        "assignments": {
          "assignments": [
            {
              "id": "token",
              "name": "token",
              "value": "={{ $json.body?.token || $json.token }}",
              "type": "string"
            },
            {
              "id": "responses",
              "name": "responses",
              "value": "={{ $json.body?.responses || $json.responses }}",
              "type": "array"
            }
          ]
        },
        "options": {}
      },
      "type": "n8n-nodes-base.set",
      "typeVersion": 3.4,
      "position": [
        -5696,
        1920
      ],
      "id": "46cc117e-328a-4377-a501-28e38732b2c9",
      "name": "Set Input Params3"
    },
    {
      "parameters": {
        "schemaType": "manual",
        "inputSchema": "{\n  \"type\": \"object\",\n  \"properties\": {\n    \"should_update\": { \"type\": \"boolean\" },\n    \"new_evaluation_value\": { \"type\": \"string\" },\n    \"new_score\": { \"type\": \"number\" },\n    \"new_comment\": { \"type\": \"string\" },\n    \"confidence\": { \"type\": \"number\" }\n  }\n}"
      },
      "type": "@n8n/n8n-nodes-langchain.outputParserStructured",
      "typeVersion": 1.3,
      "position": [
        -3472,
        2048
      ],
      "id": "737dd088-7a2f-46f2-9d5a-c09f3f3fcbd7",
      "name": "JSON Output Parser2"
    },
    {
      "parameters": {
        "model": "mistral-large-latest",
        "options": {
          "temperature": 0.1
        }
      },
      "type": "@n8n/n8n-nodes-langchain.lmChatMistralCloud",
      "typeVersion": 1,
      "position": [
        -3472,
        2176
      ],
      "id": "273694d6-6782-41f8-9ec7-35a61f626724",
      "name": "Mistral Cloud Chat Model4",
      "credentials": {
        "mistralCloudApi": {
          "id": "tDjuOnF6lpADMmd5",
          "name": "Mistral Cloud account"
        }
      }
    },
    {
      "parameters": {
        "content": "## QA Process Responses Workflow\n\n**Purpose:** Process supplier responses using a Loop for reliable item-by-item processing.\n\n**Data Model:**\n- `qa_audit.requirement_id` links to `rfq_items_master.id`\n- This allows re-evaluation of requirements based on supplier responses\n\n**Input (POST body):**\n```json\n{\n  \"token\": \"abc123xyz...\",\n  \"responses\": [\n    {\n      \"question_id\": \"uuid\",\n      \"response_text\": \"Supplier's answer...\"\n    }\n  ]\n}\n```\n\n**Process:**\n1. Validate token (not expired, not used)\n2. Split responses into items\n3. **Loop Over Items** - process each response:\n   - Save response to qa_audit\n   - Fetch question details (including requirement_id)\n   - If has requirement_id:\n     - Fetch requirement from rfq_items_master\n     - Fetch current evaluation\n     - Re-evaluate with LLM\n     - Update if confidence >= 70%\n4. After loop: Mark token as responded\n5. Create notification\n6. Respond with success\n\n**Tables Updated:**\n- `qa_audit` - response, status, responded_at, response_source\n- `provider_responses` - evaluation_value, score, comment\n- `qa_response_tokens` - status, responded_at\n- `qa_notifications` - new notification created",
        "height": 1020,
        "width": 4418,
        "color": 3
      },
      "type": "n8n-nodes-base.stickyNote",
      "typeVersion": 1,
      "position": [
        -6272,
        1328
      ],
      "id": "26290500-6440-43dd-96da-73291446f603",
      "name": "Sticky Note6"
    },
    {
      "parameters": {
        "httpMethod": "POST",
        "path": "qa-audit-generator-desarrollo",
        "responseMode": "responseNode",
        "options": {}
      },
      "type": "n8n-nodes-base.webhook",
      "typeVersion": 2.1,
      "position": [
        -6048,
        -656
      ],
      "id": "aa7dfa8d-e39a-473a-85c8-1cadc901f67e",
      "name": "Webhook Inbound",
      "webhookId": "0496e481-bb76-42f1-b3d5-734935b4b631"
    },
    {
      "parameters": {
        "assignments": {
          "assignments": [
            {
              "id": "project_id",
              "name": "project_id",
              "value": "={{ $json.body.project_id }}",
              "type": "string"
            },
            {
              "id": "provider",
              "name": "provider",
              "value": "={{ $json.body.provider }}",
              "type": "string"
            }
          ]
        },
        "options": {}
      },
      "type": "n8n-nodes-base.set",
      "typeVersion": 3.4,
      "position": [
        -5824,
        -656
      ],
      "id": "ba9d1700-73e4-462a-8284-86194600634b",
      "name": "Set Input Params"
    },
    {
      "parameters": {
        "operation": "executeQuery",
        "query": "=SELECT * FROM desarrollo.provider_responses WHERE provider_name = '={{ $json.provider }}' AND project_id = '={{ $json.project_id }}'",
        "options": {}
      },
      "type": "n8n-nodes-base.postgres",
      "typeVersion": 2.5,
      "position": [
        -5616,
        -656
      ],
      "id": "ba474d3b-a4f3-4d01-9166-4edb44dc1170",
      "name": "Fetch All Provider Responses",
      "credentials": {
        "postgres": {
          "id": "V0REAPph5JBLqze3",
          "name": "Postgres account"
        }
      }
    },
    {
      "parameters": {
        "jsCode": "// =============================================\n// NODO: Filter Deficiencies Only\n// Solo incluye items que realmente son deficiencias\n// =============================================\n\nconst items = $input.all();\n\n// Valores que indican deficiencias (necesitan Q&A)\nconst DEFICIENCY_VALUES = [\n  'PARTIALLY INCLUDED',\n  'NOT INCLUDED WITH ALTERNATIVE',\n  'NOT INCLUDED',\n  'NO INFORMATION'\n];\n\n// Valores que NO son deficiencias (no necesitan Q&A)\nconst OK_VALUES = [\n  'INCLUDED',\n  'INCLUDED WITH CAVEATS'\n];\n\nconst filteredItems = items.filter(item => {\n  const evalValue = (item.json.evaluation_value || '').toUpperCase().trim();\n  \n  // Si es un valor OK, excluir\n  if (OK_VALUES.some(v => evalValue === v.toUpperCase())) {\n    return false;\n  }\n  \n  // Caso 1: Es uno de los valores de deficiencia conocidos\n  if (DEFICIENCY_VALUES.some(v => evalValue.includes(v.toUpperCase()))) {\n    return true;\n  }\n  \n  // Caso 2: Empieza con \"NO VALUE FOUND\" (evaluación económica sin valor)\n  if (evalValue.startsWith('NO VALUE FOUND')) {\n    return true;\n  }\n  \n  // Caso 3: Score bajo (menor a 5) como indicador de deficiencia\n  const score = item.json.score || 0;\n  if (score < 5) {\n    return true;\n  }\n  \n  // Por defecto, excluir (valores económicos con precios, etc.)\n  return false;\n});\n\nconsole.log(`📋 Filtrado de deficiencias:`);\nconsole.log(`   ├─ Total recibidos: ${items.length}`);\nconsole.log(`   └─ Deficiencias encontradas: ${filteredItems.length}`);\n\n// Log de valores excluidos para debug\nconst excluded = items.length - filteredItems.length;\nif (excluded > 0) {\n  console.log(`   ├─ Excluidos (valores OK o económicos): ${excluded}`);\n}\n\nreturn filteredItems;"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        -5408,
        -656
      ],
      "id": "89a11a41-a372-4cd7-81d7-65a2c785f94c",
      "name": "Filter Deficiencies Only"
    },
    {
      "parameters": {
        "operation": "executeQuery",
        "query": "=SELECT * FROM desarrollo.rfq_items_master WHERE id = '={{ $json.requirement_id }}' LIMIT 1",
        "options": {}
      },
      "type": "n8n-nodes-base.postgres",
      "typeVersion": 2.5,
      "position": [
        -5216,
        -656
      ],
      "id": "8593aee8-3541-46ea-ac6c-5024615dcf6c",
      "name": "Fetch Requirement Specs",
      "credentials": {
        "postgres": {
          "id": "V0REAPph5JBLqze3",
          "name": "Postgres account"
        }
      }
    },
    {
      "parameters": {
        "aggregate": "aggregateAllItemData",
        "destinationFieldName": "total_deficiencies",
        "options": {}
      },
      "type": "n8n-nodes-base.aggregate",
      "typeVersion": 1,
      "position": [
        -5008,
        -656
      ],
      "id": "d29148e3-9ed2-4be6-b729-b710ddebd38f",
      "name": "Consolidate Deficiencies"
    },
    {
      "parameters": {
        "promptType": "define",
        "text": "=Generate technical audit questions in English based on the following deficiencies detected for the provider {{ $(\"Set Input Params\").first().json.provider }}.\n\n**IMPORTANT**: Each deficiency has an \"id\" field which is the requirement_id. You MUST include this requirement_id with each question you generate, linking the question back to its source deficiency.\n\nDEFICIENCIES:\n{{ JSON.stringify($json.total_deficiencies) }}\n\n## PROJECT CONTEXT: {{ $('Fetch Project Context QA').first().json.ai_context }}\n\n## DISCIPLINES:\n{{ $('Fetch Project Context QA').first().json.disciplines ? 'Use ONLY these project-specific disciplines: ' + $('Fetch Project Context QA').first().json.disciplines.join(', ') : 'No disciplines defined yet for this project. You MUST first determine the appropriate engineering disciplines based on the project context and the deficiencies provided. Typical disciplines include: Electrical, Mechanical, Civil, Process, Instrumentation, Structural, Environmental, General, etc. Choose the ones that best fit this specific project.' }}\n\n### INSTRUCTIONS:\n1.  **Link to Requirement**: Each question MUST include the \"requirement_id\" (the \"id\" field from the deficiency it relates to).\n2.  **Determine Disciplines**: First, identify the relevant engineering disciplines for THIS project based on the deficiencies and project context. Then classify each question into the most specific discipline.\n    - Be as specific as possible. Do not label everything as \"General\".\n    - Only use \"General\" if it is truly administrative or multi-disciplinary.\n3.  **Language**: All questions and text MUST be in English.\n4.  **Format**: Respond strictly with the JSON object following the schema.\n\n### OUTPUT SCHEMA:\n{\n  \"disciplines\": [\"list of all unique discipline names used in the questions below\"],\n  \"questions\": [\n    {\n      \"requirement_id\": \"uuid-from-deficiency-id-field\",\n      \"discipline\": \"One of the disciplines listed above\",\n      \"question\": \"The specific question in English\",\n      \"importance\": \"High\" | \"Medium\" | \"Low\"\n    }\n  ]\n}",
        "hasOutputParser": true,
        "batching": {}
      },
      "type": "@n8n/n8n-nodes-langchain.chainLlm",
      "typeVersion": 1.8,
      "position": [
        -4816,
        -656
      ],
      "id": "ea6a834e-784b-4c8e-a0e6-ddd19533ace5",
      "name": "QA Generation Chain"
    },
    {
      "parameters": {
        "schemaType": "manual",
        "inputSchema": "{\n  \"type\": \"object\",\n  \"properties\": {\n    \"disciplines\": {\n      \"type\": \"array\",\n      \"items\": { \"type\": \"string\" }\n    },\n    \"questions\": {\n      \"type\": \"array\",\n      \"items\": {\n        \"type\": \"object\",\n        \"properties\": {\n          \"requirement_id\": { \"type\": \"string\" },\n          \"discipline\": { \"type\": \"string\" },\n          \"question\": { \"type\": \"string\" },\n          \"importance\": { \"type\": \"string\" }\n        }\n      }\n    }\n  }\n}"
      },
      "type": "@n8n/n8n-nodes-langchain.outputParserStructured",
      "typeVersion": 1.3,
      "position": [
        -4592,
        -448
      ],
      "id": "80fd8eb1-f345-4948-bfe2-9252412ce005",
      "name": "JSON Output Parser"
    },
    {
      "parameters": {
        "fieldToSplitOut": "output.questions",
        "include": "allOtherFields",
        "options": {}
      },
      "type": "n8n-nodes-base.itemLists",
      "typeVersion": 3.1,
      "position": [
        -4496,
        -656
      ],
      "id": "f20b5ccb-82cc-4953-a86a-717ededabcc1",
      "name": "Split Questions List"
    },
    {
      "parameters": {
        "operation": "executeQuery",
        "query": "=INSERT INTO desarrollo.qa_audit (question, importance, discipline, provider_name, project_id, requirement_id, status) VALUES ('={{ $json['output.questions'].question }}', '={{ $json['output.questions'].importance }}', '={{ $json['output.questions'].discipline }}', '={{ $(\"Set Input Params\").first().json.provider }}', '={{ $(\"Set Input Params\").first().json.project_id }}', '={{ $json['output.questions'].requirement_id }}', 'Pending') RETURNING *",
        "options": {}
      },
      "type": "n8n-nodes-base.postgres",
      "typeVersion": 2.5,
      "position": [
        -4336,
        -656
      ],
      "id": "e8177b02-e8b3-4a58-b33f-513d853315c9",
      "name": "Supabase Insert",
      "credentials": {
        "postgres": {
          "id": "V0REAPph5JBLqze3",
          "name": "Postgres account"
        }
      }
    },
    {
      "parameters": {
        "jsCode": "// Extract unique disciplines from the QA Generation Chain output\n// and merge with existing project disciplines\nconst qaOutput = $('QA Generation Chain').first().json.output || {};\nconst generatedDisciplines = qaOutput.disciplines || [];\nconst existingDisciplines = $('Fetch Project Context QA').first().json.disciplines || [];\n\n// Merge: existing + new, deduplicated\nconst allDisciplines = [...new Set([...existingDisciplines, ...generatedDisciplines])];\nconst projectId = $('Set Input Params').first().json.project_id;\n\n// Format as PostgreSQL array literal for safe Supabase handling\nconst pgArray = '{' + allDisciplines.map(d => '\"' + d.replace(/\"/g, '\\\\\"') + '\"').join(',') + '}';\n\nconsole.log(`📋 Disciplines for project ${projectId}:`);\nconsole.log(`   ├─ Existing: ${existingDisciplines.join(', ') || 'none'}`);\nconsole.log(`   ├─ Generated: ${generatedDisciplines.join(', ')}`);\nconsole.log(`   └─ Merged (${allDisciplines.length}): ${allDisciplines.join(', ')}`);\n\nreturn [{ json: { project_id: projectId, disciplines: pgArray } }];"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        -3968,
        -656
      ],
      "id": "1347a8e2-243e-43bd-9dcb-18f5126ef82d",
      "name": "Extract Disciplines"
    },
    {
      "parameters": {
        "operation": "executeQuery",
        "query": "=UPDATE desarrollo.projects SET disciplines = '{{ $json.disciplines }}' WHERE id = '{{ $json.project_id }}' RETURNING *",
        "options": {}
      },
      "type": "n8n-nodes-base.postgres",
      "typeVersion": 2.5,
      "position": [
        -3776,
        -656
      ],
      "id": "6e53bd3d-1b1a-4cfb-84bb-c71a6b47c51b",
      "name": "Save Project Disciplines",
      "credentials": {
        "postgres": {
          "id": "V0REAPph5JBLqze3",
          "name": "Postgres account"
        }
      }
    },
    {
      "parameters": {
        "respondWith": "allIncomingItems",
        "options": {}
      },
      "type": "n8n-nodes-base.respondToWebhook",
      "typeVersion": 1.5,
      "position": [
        -3584,
        -656
      ],
      "id": "2f2547cc-74e9-42f1-9f3a-8e805ca15031",
      "name": "Respond to Webhook1"
    },
    {
      "parameters": {
        "content": "## Q&A Generator\n\n**Updated**: Dynamic disciplines per project + deficiency filtering.\n\n**Disciplines**:\n- Generated dynamically by the LLM based on project context\n- Saved to `projects.disciplines` for reuse in future runs\n- If project already has disciplines, LLM uses those\n- Merged: existing + new, deduplicated\n\n**Deficiencies filtered**:\n- PARTIALLY INCLUDED\n- NOT INCLUDED WITH ALTERNATIVE\n- NOT INCLUDED\n- NO INFORMATION\n- NO VALUE FOUND - *\n- Any item with score < 5\n\n**Excluded** (not deficiencies):\n- INCLUDED\n- INCLUDED WITH CAVEATS\n- Economic values (prices, hours, etc.)\n\n**Flow**:\n1. Receive project_id and provider\n2. Fetch project context (incl. existing disciplines)\n3. Fetch ALL provider_responses\n4. Filter only deficiencies (Code node)\n5. Fetch requirement details for each\n6. Generate questions + disciplines with LLM\n7. Save questions to qa_audit\n8. Extract & merge disciplines\n9. Save disciplines to project",
        "height": 656,
        "width": 2200,
        "color": 7
      },
      "type": "n8n-nodes-base.stickyNote",
      "typeVersion": 1,
      "position": [
        -6144,
        -880
      ],
      "id": "f5197b2f-c46a-4296-95ef-18e22655cfd8",
      "name": "Sticky Note1"
    },
    {
      "parameters": {
        "model": "qwen3:8b",
        "options": {
          "temperature": 0.1,
          "numCtx": 8192,
          "numPredict": 1536
        }
      },
      "type": "@n8n/n8n-nodes-langchain.lmOllama",
      "typeVersion": 1,
      "position": [
        -4912,
        -400
      ],
      "id": "0a2d3cad-607c-4850-aa63-9b82348e00c6",
      "name": "Ollama Model2",
      "credentials": {
        "ollamaApi": {
          "id": "oS2Qqti9oVfsm8XZ",
          "name": "Ollama account"
        }
      }
    },
    {
      "parameters": {
        "model": "mistral-large-latest",
        "options": {
          "temperature": 0.1
        }
      },
      "type": "@n8n/n8n-nodes-langchain.lmChatMistralCloud",
      "typeVersion": 1,
      "position": [
        -4736,
        -352
      ],
      "id": "d24e964d-3546-4e91-a919-69d657bd9d23",
      "name": "Mistral Cloud Chat Model",
      "credentials": {
        "mistralCloudApi": {
          "id": "tDjuOnF6lpADMmd5",
          "name": "Mistral Cloud account"
        }
      }
    },
    {
      "parameters": {
        "operation": "executeQuery",
        "query": "=SELECT * FROM desarrollo.rfq_items_master WHERE project_id = '={{ $('Set Input Params1').first().json.project_id }}'",
        "options": {}
      },
      "type": "n8n-nodes-base.postgres",
      "typeVersion": 2.5,
      "position": [
        -6224,
        416
      ],
      "id": "6faca4fe-4a6e-4e9f-b2ed-b3a2f793c9fe",
      "name": "Fetch Requirements",
      "credentials": {
        "postgres": {
          "id": "V0REAPph5JBLqze3",
          "name": "Postgres account"
        }
      }
    },
    {
      "parameters": {
        "operation": "executeQuery",
        "query": "=SELECT * FROM desarrollo.provider_responses WHERE project_id = '={{ $('Set Input Params1').first().json.project_id }}'",
        "options": {}
      },
      "type": "n8n-nodes-base.postgres",
      "typeVersion": 2.5,
      "position": [
        -6224,
        656
      ],
      "id": "80dbd82a-958d-44a8-9da3-bdc342c13b4f",
      "name": "Fetch Provider Responses",
      "credentials": {
        "postgres": {
          "id": "V0REAPph5JBLqze3",
          "name": "Postgres account"
        }
      }
    },
    {
      "parameters": {
        "operation": "executeQuery",
        "query": "=SELECT * FROM desarrollo.scoring_configuration_summary WHERE project_id = '={{ $('Set Input Params1').first().json.project_id }}'",
        "options": {}
      },
      "type": "n8n-nodes-base.postgres",
      "typeVersion": 2.5,
      "position": [
        -6224,
        880
      ],
      "id": "10adbe63-254b-4d78-b93d-564fd4277473",
      "name": "Fetch Scoring Configuration",
      "alwaysOutputData": true,
      "credentials": {
        "postgres": {
          "id": "V0REAPph5JBLqze3",
          "name": "Postgres account"
        }
      }
    },
    {
      "parameters": {
        "numberInputs": 3
      },
      "type": "n8n-nodes-base.merge",
      "typeVersion": 3.2,
      "position": [
        -6000,
        512
      ],
      "id": "50453b58-1d43-44b1-a5fd-7a1dc9b8ef64",
      "name": "Merge Requirements & Responses"
    },
    {
      "parameters": {
        "jsCode": "// =============================================\n// NODO: Prepare Scoring Data (v5 - Dynamic Criteria Support)\n// Supports both hardcoded defaults and dynamic criteria from database\n// =============================================\n\nconst items = $input.all();\n\nconsole.log('📊 Prepare Scoring Data - Starting...');\nconsole.log('   Items received:', items.length);\n\n/* =========================\nGet project_id from webhook\n========================= */\nlet projectId = null;\ntry {\n    projectId = $('Set Input Params1').first().json.project_id;\n    console.log('   📋 Project ID:', projectId);\n} catch (e) {\n    console.log('   ⚠️ Could not get project_id:', e.message);\n}\n\n/* =========================\nGet Dynamic Scoring Configuration (if exists)\n========================= */\nlet dynamicConfig = null;\nlet useDynamicConfig = false;\ntry {\n    const configItems = $('Fetch Scoring Configuration').all();\n    if (configItems && configItems.length > 0 && configItems[0].json.category_name) {\n        // Parse configuration into structured format\n        const configData = configItems.map(item => item.json);\n        dynamicConfig = {\n            categories: {},\n            criteria: {},\n            criteriaWeights: {},\n            categoryWeights: {}\n        };\n        \n        configData.forEach(row => {\n            const catName = row.category_name;\n            const catWeight = parseFloat(row.category_weight) || 0;\n            \n            if (!dynamicConfig.categories[catName]) {\n                dynamicConfig.categories[catName] = {\n                    name: catName,\n                    display_name: row.category_display_name,\n                    weight: catWeight,\n                    color: row.category_color,\n                    criteria: []\n                };\n                dynamicConfig.categoryWeights[catName.toUpperCase()] = catWeight / 100;\n            }\n            \n            if (row.criterion_name) {\n                const critName = row.criterion_name;\n                const critWeight = parseFloat(row.criterion_weight) || 0;\n                const actualWeight = (critWeight * catWeight) / 10000; // criterion_weight% of category_weight%\n                \n                dynamicConfig.criteria[critName] = {\n                    name: critName,\n                    display_name: row.criterion_display_name,\n                    description: row.criterion_description,\n                    category: catName,\n                    weight: critWeight,\n                    keywords: row.criterion_keywords || []\n                };\n                dynamicConfig.criteriaWeights[critName] = actualWeight;\n                dynamicConfig.categories[catName].criteria.push(critName);\n            }\n        });\n        \n        useDynamicConfig = Object.keys(dynamicConfig.criteria).length > 0;\n        console.log('   ✅ Dynamic configuration loaded:', Object.keys(dynamicConfig.criteria).length, 'criteria');\n    }\n} catch (e) {\n    console.log('   ⚠️ Could not load dynamic config:', e.message);\n}\n\n/* =========================\nDefault Criteria (fallback)\n========================= */\nconst DEFAULT_CRITERIA_WEIGHTS = {\n    scope_facilities: 0.10,\n    scope_work: 0.10,\n    deliverables_quality: 0.10,\n    total_price: 0.15,\n    price_breakdown: 0.08,\n    optionals_included: 0.07,\n    capex_opex_methodology: 0.05,\n    schedule: 0.08,\n    resources_allocation: 0.06,\n    exceptions: 0.06,\n    safety_studies: 0.08,\n    regulatory_compliance: 0.07\n};\n\nconst DEFAULT_CATEGORY_WEIGHTS = {\n    TECHNICAL: 0.30,\n    ECONOMIC: 0.35,\n    EXECUTION: 0.20,\n    HSE_COMPLIANCE: 0.15\n};\n\n// Use dynamic or default\nconst CRITERIA_WEIGHTS = useDynamicConfig ? dynamicConfig.criteriaWeights : DEFAULT_CRITERIA_WEIGHTS;\nconst CATEGORY_WEIGHTS = useDynamicConfig ? dynamicConfig.categoryWeights : DEFAULT_CATEGORY_WEIGHTS;\n\nconsole.log('   📊 Using', useDynamicConfig ? 'DYNAMIC' : 'DEFAULT', 'configuration');\nconsole.log('   📊 Criteria:', Object.keys(CRITERIA_WEIGHTS).join(', '));\n\n/* =========================\nHelpers - Map requirements to criteria\n========================= */\nfunction getCriterionFromRequirement(evalType, phase, reqText, keywords) {\n    const type = (evalType || '').toLowerCase();\n    const phaseL = (phase || '').toLowerCase();\n    const text = (reqText || '').toLowerCase();\n    \n    // If using dynamic config, try to match by keywords first\n    if (useDynamicConfig && dynamicConfig.criteria) {\n        for (const [critName, critInfo] of Object.entries(dynamicConfig.criteria)) {\n            const kws = critInfo.keywords || [];\n            for (const kw of kws) {\n                if (text.includes(kw.toLowerCase())) {\n                    return critName;\n                }\n            }\n        }\n    }\n    \n    // Fallback to default mapping logic\n    if (type.includes('technical')) {\n        if (text.includes('scope of facilities') || text.includes('hydrogen plant') || text.includes('utilities')) {\n            return 'scope_facilities';\n        }\n        if (text.includes('scope of work') || text.includes('project management') || text.includes('deliverables')) {\n            return 'scope_work';\n        }\n        if (text.includes('p&id') || text.includes('3d model') || text.includes('specification') || text.includes('datasheet')) {\n            return 'deliverables_quality';\n        }\n        return 'scope_work';\n    }\n    \n    if (type.includes('econom')) {\n        if (text.includes('price') || text.includes('€') || text.includes('fee') || text.includes('cost')) {\n            return 'total_price';\n        }\n        if (text.includes('hour') || text.includes('discipline') || text.includes('breakdown')) {\n            return 'price_breakdown';\n        }\n        if (text.includes('optional') || text.includes('geotechnical') || text.includes('topograph') || text.includes('hazid')) {\n            return 'optionals_included';\n        }\n        if (text.includes('capex') || text.includes('opex') || text.includes('aacei') || text.includes('estimate')) {\n            return 'capex_opex_methodology';\n        }\n        return 'total_price';\n    }\n    \n    if (text.includes('hse') || text.includes('safety') || text.includes('hazop') || text.includes('hazid') || text.includes('atex') || text.includes('qra')) {\n        return 'safety_studies';\n    }\n    if (text.includes('code') || text.includes('standard') || text.includes('compliance') || text.includes('regulation')) {\n        return 'regulatory_compliance';\n    }\n    \n    if (phaseL.includes('pre-feed') || phaseL.includes('feed') || type.includes('deliverable')) {\n        if (text.includes('schedule') || text.includes('planning') || text.includes('timeline')) {\n            return 'schedule';\n        }\n        if (text.includes('exception') || text.includes('deviation') || text.includes('exclusion')) {\n            return 'exceptions';\n        }\n        return 'resources_allocation';\n    }\n    \n    return 'scope_work';\n}\n\nfunction classifyEval(val) {\n    const v = (val || '').toUpperCase();\n    if (v.includes('INCLUD') || v.includes('INCLUIDO') || v === 'SI' || v === 'YES') return 'INCLUDED';\n    if (v.includes('PARCIAL') || v.includes('PARTIAL')) return 'PARTIAL';\n    if (v.includes('NO INCLUD') || v.includes('NOT INCLUD') || v === 'NO') return 'NOT_INCLUDED';\n    return 'NO_INFO';\n}\n\n/* =========================\nGet data from previous nodes\n========================= */\nlet requirements = [];\nlet responses = [];\n\ntry {\n    const reqItems = $('Fetch Requirements').all();\n    requirements = reqItems.map(item => item.json);\n    console.log('   ✅ Requirements from Fetch Requirements:', requirements.length);\n} catch (e) {\n    console.log('   ⚠️ Could not access Fetch Requirements:', e.message);\n}\n\ntry {\n    const respItems = $('Fetch Provider Responses').all();\n    responses = respItems.map(item => item.json);\n    console.log('   ✅ Responses from Fetch Provider Responses:', responses.length);\n} catch (e) {\n    console.log('   ⚠️ Could not access Fetch Provider Responses:', e.message);\n}\n\nif (requirements.length === 0 || responses.length === 0) {\n    console.log('   🔄 Using fallback: separating from input...');\n    items.forEach(item => {\n        const data = item.json;\n        if (data.requirement_text && !data.provider_name) {\n            requirements.push(data);\n        } else if (data.provider_name && data.requirement_id) {\n            responses.push(data);\n        }\n    });\n}\n\nif (requirements.length === 0) {\n    return [{ json: { error: 'No requirements found', items_received: items.length } }];\n}\nif (responses.length === 0) {\n    return [{ json: { error: 'No responses found', items_received: items.length } }];\n}\n\n/* =========================\nOptimization with MAPS\n========================= */\nconst requirementMap = {};\nrequirements.forEach(r => {\n    if (r.id) requirementMap[r.id] = r;\n});\n\nconst responsesByProvider = {};\nresponses.forEach(r => {\n    if (r.provider_name) {\n        if (!responsesByProvider[r.provider_name]) {\n            responsesByProvider[r.provider_name] = [];\n        }\n        responsesByProvider[r.provider_name].push(r);\n    }\n});\n\nconsole.log('   📊 Providers found:', Object.keys(responsesByProvider).join(', '));\n\n/* =========================\nProvider filter (optional)\n========================= */\nlet providerFilter = '';\ntry {\n    providerFilter = $('Set Input Params1').first().json.provider_filter || '';\n} catch (e) {}\n\nlet providers = Object.keys(responsesByProvider);\nif (providerFilter) {\n    providers = providers.filter(p => p.toLowerCase().includes(providerFilter.toLowerCase()));\n}\n\nif (providers.length === 0) {\n    return [{ json: { error: 'No providers found', filter: providerFilter } }];\n}\n\n/* =========================\nEvaluation by Criteria\n========================= */\nconst evaluationData = providers.map(providerName => {\n    const providerResponses = responsesByProvider[providerName] || [];\n    \n    // Initialize criteria summary\n    const criteriaScores = {};\n    Object.keys(CRITERIA_WEIGHTS).forEach(criterion => {\n        criteriaScores[criterion] = { total: 0, included: 0, partial: 0, not_included: 0, no_info: 0, scores: [] };\n    });\n    \n    providerResponses.forEach(resp => {\n        const req = requirementMap[resp.requirement_id];\n        if (!req) return;\n        \n        const criterion = getCriterionFromRequirement(req.evaluation_type, req.phase, req.requirement_text);\n        const evalClass = classifyEval(resp.evaluation_value);\n        \n        const cs = criteriaScores[criterion];\n        if (!cs) return;\n        \n        cs.total++;\n        if (evalClass === 'INCLUDED') cs.included++;\n        else if (evalClass === 'PARTIAL') cs.partial++;\n        else if (evalClass === 'NOT_INCLUDED') cs.not_included++;\n        else cs.no_info++;\n        \n        if (typeof resp.score === 'number') {\n            cs.scores.push(resp.score);\n        }\n    });\n    \n    // Calculate average scores per criterion\n    let globalScore = 0;\n    const criteriaAvgScores = {};\n    \n    Object.keys(criteriaScores).forEach(criterion => {\n        const cs = criteriaScores[criterion];\n        if (cs.scores.length > 0) {\n            cs.avg_score = Math.round((cs.scores.reduce((a, b) => a + b, 0) / cs.scores.length) * 100) / 100;\n        } else if (cs.total > 0) {\n            cs.avg_score = Math.round(((cs.included * 10 + cs.partial * 5) / cs.total) * 100) / 100;\n        } else {\n            cs.avg_score = 0;\n        }\n        criteriaAvgScores[criterion] = cs.avg_score;\n        globalScore += cs.avg_score * (CRITERIA_WEIGHTS[criterion] || 0);\n        delete cs.scores;\n    });\n    \n    globalScore = Math.round(globalScore * 100) / 100;\n    \n    // Calculate category scores dynamically\n    let categoryScores = {};\n    if (useDynamicConfig) {\n        for (const [catName, catInfo] of Object.entries(dynamicConfig.categories)) {\n            const catCriteria = catInfo.criteria || [];\n            const scores = catCriteria.map(c => criteriaAvgScores[c] || 0);\n            const avg = scores.length > 0 ? scores.reduce((a, b) => a + b, 0) / scores.length : 0;\n            categoryScores[catName.toUpperCase()] = Math.round(avg * 100) / 100;\n        }\n    } else {\n        categoryScores = {\n            TECHNICAL: Math.round(((criteriaAvgScores.scope_facilities || 0) + (criteriaAvgScores.scope_work || 0) + (criteriaAvgScores.deliverables_quality || 0)) / 3 * 100) / 100,\n            ECONOMIC: Math.round(((criteriaAvgScores.total_price || 0) + (criteriaAvgScores.price_breakdown || 0) + (criteriaAvgScores.optionals_included || 0) + (criteriaAvgScores.capex_opex_methodology || 0)) / 4 * 100) / 100,\n            EXECUTION: Math.round(((criteriaAvgScores.schedule || 0) + (criteriaAvgScores.resources_allocation || 0) + (criteriaAvgScores.exceptions || 0)) / 3 * 100) / 100,\n            HSE_COMPLIANCE: Math.round(((criteriaAvgScores.safety_studies || 0) + (criteriaAvgScores.regulatory_compliance || 0)) / 2 * 100) / 100\n        };\n    }\n    \n    return {\n        provider_name: providerName,\n        project_id: projectId,\n        total_responses: providerResponses.length,\n        global_score: globalScore,\n        category_scores: categoryScores,\n        criteria_scores: criteriaAvgScores,\n        criteria_summary: criteriaScores,\n        config_type: useDynamicConfig ? 'dynamic' : 'default',\n        scoring_config: useDynamicConfig ? dynamicConfig : null\n    };\n});\n\n/* =========================\nExecutive Ranking\n========================= */\nevaluationData\n    .sort((a, b) => b.global_score - a.global_score)\n    .forEach((item, index) => {\n        item.rank = index + 1;\n    });\n\nconsole.log('✅ Scoring Data prepared for', evaluationData.length, 'providers');\nconsole.log('   Project ID included:', projectId);\nconsole.log('   Config type:', useDynamicConfig ? 'DYNAMIC' : 'DEFAULT');\n\nreturn evaluationData.map(data => ({ json: data }));"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        -5776,
        512
      ],
      "id": "39347b72-94c5-465b-9ed1-feec2b3f162e",
      "name": "Prepare Scoring Data"
    },
    {
      "parameters": {
        "options": {
          "reset": false
        }
      },
      "type": "n8n-nodes-base.splitInBatches",
      "typeVersion": 3,
      "position": [
        -5552,
        464
      ],
      "id": "b79e4726-e514-4c33-9564-c2eb528b4948",
      "name": "Loop Over Providers"
    },
    {
      "parameters": {
        "promptType": "define",
        "text": "=Score this engineering proposal provider based on RFQ compliance.\n\n## PROVIDER: {{ $json.provider_name }}\n## TOTAL RESPONSES: {{ $json.total_responses }}\n\\n## PROJECT CONTEXT: {{ $('Fetch Project Context Scoring').first().json.ai_context }}\\n\\n## CONFIG TYPE: {{ $json.config_type || 'default' }}\n\n## CATEGORY SCORES (pre-calculated):\n{{ JSON.stringify($json.category_scores, null, 2) }}\n\n## INDIVIDUAL CRITERIA SCORES:\n{{ JSON.stringify($json.criteria_scores, null, 2) }}\n\n## CRITERIA DETAILS:\n{{ JSON.stringify($json.criteria_summary, null, 2) }}\n\n{{ $json.scoring_config ? '## DYNAMIC SCORING CONFIGURATION:\\n' + JSON.stringify($json.scoring_config.categories, null, 2) : '' }}\n\n## EVALUATION CRITERIA (weights):\n{{ $json.scoring_config ? Object.entries($json.scoring_config.categories).map(([name, cat]) => `### ${cat.display_name} (${cat.weight}%)\\n${cat.criteria.map(c => `- ${c}: ${$json.scoring_config.criteria[c]?.description || ''}`).join('\\n')}`).join('\\n\\n') : `### TECHNICAL COMPLETENESS (30%)\n- scope_facilities: 10% - H2 plant, BOP, utilities included\n- scope_work: 10% - PM, studies, deliverables covered\n- deliverables_quality: 10% - P&IDs, specs, 3D model quality\n\n### ECONOMIC COMPETITIVENESS (35%)\n- total_price: 15% - PRE-FEED + FEED + EPC price competitiveness\n- price_breakdown: 8% - Transparent hours/discipline, €/hour\n- optionals_included: 7% - Geotechnical, topographic, 3D, HAZID in base\n- capex_opex_methodology: 5% - AACEI class, estimate robustness\n\n### EXECUTION CAPABILITY (20%)\n- schedule: 8% - Realistic timeline vs requirements\n- resources_allocation: 6% - Coherent hours per discipline\n- exceptions: 6% - Fewer exceptions = better (invert score)\n\n### HSE & COMPLIANCE (15%)\n- safety_studies: 8% - HAZID, HAZOP, QRA, ATEX included\n- regulatory_compliance: 7% - Codes, standards, safety distances` }}\n\n## SCORING RULES:\n- included items = 10 points\n- partial items = 6 points\n- not_included items = 2 points\n- no_info items = 0 points\n- For 'exceptions': FEWER is BETTER (invert: more exceptions = lower score)\n\n## OUTPUT (JSON only):\n{\n  \"provider_name\": \"string\",\n  \"category_scores\": {\n    {{ $json.scoring_config ? Object.keys($json.scoring_config.categories).map(name => `\"${name.toUpperCase()}\": { \"score\": number, \"weight\": ${$json.scoring_config.categories[name].weight / 100} }`).join(',\\n    ') : `\"TECHNICAL\": { \"score\": number, \"weight\": 0.30 },\n    \"ECONOMIC\": { \"score\": number, \"weight\": 0.35 },\n    \"EXECUTION\": { \"score\": number, \"weight\": 0.20 },\n    \"HSE_COMPLIANCE\": { \"score\": number, \"weight\": 0.15 }` }}\n  },\n  \"individual_scores\": {\n    {{ Object.keys($json.criteria_scores).map(k => `\"${k}\": number`).join(',\\n    ') }}\n  },\n  \"overall_score\": number,\n  \"compliance_percentage\": number,\n  \"evaluation_summary\": \"1-2 sentences comparing to ideal proposal\",\n  \"strengths\": [\"max 3 specific strengths\"],\n  \"weaknesses\": [\"max 3 specific areas for improvement\"]\n}",
        "hasOutputParser": true,
        "batching": {}
      },
      "type": "@n8n/n8n-nodes-langchain.chainLlm",
      "typeVersion": 1.8,
      "position": [
        -5280,
        480
      ],
      "id": "cd27045b-f379-4f2a-bd90-df4f8e585da3",
      "name": "Scoring LLM Chain"
    },
    {
      "parameters": {
        "jsCode": "// Extract LLM output and structure for database (v6 - Dynamic Criteria)\nconst input = $input.first().json;\nconst llmOutput = input.output || input;\n\n// Extract category scores\nconst cs = llmOutput.category_scores || {};\nconst getScore = (cat) => {\n    if (!cs[cat]) return 0;\n    return (typeof cs[cat] === 'object' && cs[cat].score) ? cs[cat].score : (cs[cat] || 0);\n};\n\n// Extract individual scores (dynamic - works with any criteria)\nconst is = llmOutput.individual_scores || {};\nconst configType = input.config_type || llmOutput.config_type || 'default';\nconst scoringConfig = input.scoring_config || null;\n\n// Build category_scores as a clean object { category_name: score }\nconst categoryScoresClean = {};\nfor (const [catKey, catVal] of Object.entries(cs)) {\n    categoryScoresClean[catKey] = (typeof catVal === 'object' && catVal.score) ? catVal.score : (catVal || 0);\n}\n\n// Build ranking object - always include legacy fields for backward compat\n// plus the new JSONB fields for dynamic scoring\nconst ranking = {\n    provider_name: llmOutput.provider_name || 'UNKNOWN',\n    project_id: input.project_id || llmOutput.project_id || null,\n    // Legacy fixed fields (populated from dynamic data when possible)\n    technical_score: getScore('TECHNICAL') || getScore('technical') || 0,\n    economic_score: getScore('ECONOMIC') || getScore('economic') || 0,\n    execution_score: getScore('EXECUTION') || getScore('execution') || 0,\n    hse_compliance_score: getScore('HSE_COMPLIANCE') || getScore('hse_compliance') || 0,\n    scope_facilities_score: is.scope_facilities || 0,\n    scope_work_score: is.scope_work || 0,\n    deliverables_quality_score: is.deliverables_quality || 0,\n    total_price_score: is.total_price || 0,\n    price_breakdown_score: is.price_breakdown || 0,\n    optionals_included_score: is.optionals_included || 0,\n    capex_opex_methodology_score: is.capex_opex_methodology || 0,\n    schedule_score: is.schedule || 0,\n    resources_allocation_score: is.resources_allocation || 0,\n    exceptions_score: is.exceptions || 0,\n    safety_studies_score: is.safety_studies || 0,\n    regulatory_compliance_score: is.regulatory_compliance || 0,\n    // Dynamic JSONB fields\n    category_scores_json: categoryScoresClean,\n    individual_scores_json: is,\n    evaluation_details: {\n        strengths: llmOutput.strengths || [],\n        weaknesses: llmOutput.weaknesses || [],\n        recommendations: llmOutput.recommendations || [],\n        summary: llmOutput.evaluation_summary || ''\n    },\n    overall_score: llmOutput.overall_score || 0,\n    compliance_percentage: llmOutput.compliance_percentage || 0,\n    evaluation_count: 1,\n    last_updated: new Date().toISOString()\n};\n\nreturn [{\n    json: {\n        ranking,\n        details: ranking.evaluation_details,\n        category_scores: cs,\n        individual_scores: is,\n        config_type: configType,\n        scoring_config: scoringConfig\n    }\n}];"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        -4896,
        480
      ],
      "id": "4a6f36f1-57a8-4a1b-b2be-feb13645aa8a",
      "name": "Calculate Weighted Scores"
    },
    {
      "parameters": {
        "operation": "executeQuery",
        "query": "=SELECT * FROM desarrollo.ranking_proveedores WHERE provider_name = '={{ $('Calculate Weighted Scores').first().json.ranking.provider_name }}' AND project_id = '={{ $('Set Input Params1').first().json.project_id }}' LIMIT 1",
        "options": {}
      },
      "type": "n8n-nodes-base.postgres",
      "typeVersion": 2.5,
      "position": [
        -4656,
        480
      ],
      "id": "1e23aa15-143f-41d1-987e-e9dc45206640",
      "name": "Check Provider Exists",
      "alwaysOutputData": true,
      "credentials": {
        "postgres": {
          "id": "V0REAPph5JBLqze3",
          "name": "Postgres account"
        }
      }
    },
    {
      "parameters": {
        "conditions": {
          "options": {
            "caseSensitive": true,
            "leftValue": "",
            "typeValidation": "strict",
            "version": 2
          },
          "conditions": [
            {
              "id": "provider-exists-condition",
              "leftValue": "={{ $input.all().length }}",
              "rightValue": 0,
              "operator": {
                "type": "number",
                "operation": "gt"
              }
            }
          ],
          "combinator": "and"
        },
        "options": {}
      },
      "type": "n8n-nodes-base.if",
      "typeVersion": 2.2,
      "position": [
        -4416,
        480
      ],
      "id": "8e3ed288-3bc6-44a2-96a0-66b8f5867657",
      "name": "Provider Exists?",
      "disabled": true
    },
    {
      "parameters": {
        "operation": "executeQuery",
        "query": "=UPDATE desarrollo.ranking_proveedores SET project_id = '={{ $('Set Input Params1').first().json.project_id }}', technical_score = '={{ $('Calculate Weighted Scores').first().json.ranking.technical_score || 0 }}', economic_score = '={{ $('Calculate Weighted Scores').first().json.ranking.economic_score || 0 }}', execution_score = '={{ $('Calculate Weighted Scores').first().json.ranking.execution_score || 0 }}', hse_compliance_score = '={{ $('Calculate Weighted Scores').first().json.ranking.hse_compliance_score || 0 }}', scope_facilities_score = '={{ $('Calculate Weighted Scores').first().json.ranking.scope_facilities_score || 0 }}', scope_work_score = '={{ $('Calculate Weighted Scores').first().json.ranking.scope_work_score || 0 }}', deliverables_quality_score = '={{ $('Calculate Weighted Scores').first().json.ranking.deliverables_quality_score || 0 }}', total_price_score = '={{ $('Calculate Weighted Scores').first().json.ranking.total_price_score || 0 }}', price_breakdown_score = '={{ $('Calculate Weighted Scores').first().json.ranking.price_breakdown_score || 0 }}', optionals_included_score = '={{ $('Calculate Weighted Scores').first().json.ranking.optionals_included_score || 0 }}', capex_opex_methodology_score = '={{ $('Calculate Weighted Scores').first().json.ranking.capex_opex_methodology_score || 0 }}', schedule_score = '={{ $('Calculate Weighted Scores').first().json.ranking.schedule_score || 0 }}', resources_allocation_score = '={{ $('Calculate Weighted Scores').first().json.ranking.resources_allocation_score || 0 }}', exceptions_score = '={{ $('Calculate Weighted Scores').first().json.ranking.exceptions_score || 0 }}', safety_studies_score = '={{ $('Calculate Weighted Scores').first().json.ranking.safety_studies_score || 0 }}', regulatory_compliance_score = '={{ $('Calculate Weighted Scores').first().json.ranking.regulatory_compliance_score || 0 }}', overall_score = '={{ $('Calculate Weighted Scores').first().json.ranking.overall_score || 0 }}', compliance_percentage = '={{ $('Calculate Weighted Scores').first().json.ranking.compliance_percentage || 0 }}', evaluation_count = '={{ $('Calculate Weighted Scores').first().json.ranking.evaluation_count || 0 }}', last_updated = '={{ $('Calculate Weighted Scores').first().json.ranking.last_updated }}' WHERE provider_name = '={{ $('Calculate Weighted Scores').first().json.ranking.provider_name }}' AND project_id = '={{ $('Set Input Params1').first().json.project_id }}' RETURNING *",
        "options": {}
      },
      "type": "n8n-nodes-base.postgres",
      "typeVersion": 2.5,
      "position": [
        -4176,
        384
      ],
      "id": "2f03cb4d-69ec-4548-b8e7-ca4ca3b92d00",
      "name": "Update Ranking",
      "alwaysOutputData": false,
      "credentials": {
        "postgres": {
          "id": "V0REAPph5JBLqze3",
          "name": "Postgres account"
        }
      },
      "disabled": true,
      "continueOnFail": true
    },
    {
      "parameters": {
        "operation": "executeQuery",
        "query": "=INSERT INTO desarrollo.ranking_proveedores (provider_name, project_id, technical_score, economic_score, execution_score, hse_compliance_score, scope_facilities_score, scope_work_score, deliverables_quality_score, total_price_score, price_breakdown_score, optionals_included_score, capex_opex_methodology_score, schedule_score, resources_allocation_score, exceptions_score, safety_studies_score, regulatory_compliance_score, overall_score, compliance_percentage, evaluation_count, last_updated, category_scores_json, individual_scores_json, evaluation_details) VALUES ('={{ $('Calculate Weighted Scores').first().json.ranking.provider_name }}', '={{ $('Set Input Params1').first().json.project_id }}', '={{ $('Calculate Weighted Scores').first().json.ranking.technical_score || 0 }}', '={{ $('Calculate Weighted Scores').first().json.ranking.economic_score || 0 }}', '={{ $('Calculate Weighted Scores').first().json.ranking.execution_score || 0 }}', '={{ $('Calculate Weighted Scores').first().json.ranking.hse_compliance_score || 0 }}', '={{ $('Calculate Weighted Scores').first().json.ranking.scope_facilities_score || 0 }}', '={{ $('Calculate Weighted Scores').first().json.ranking.scope_work_score || 0 }}', '={{ $('Calculate Weighted Scores').first().json.ranking.deliverables_quality_score || 0 }}', '={{ $('Calculate Weighted Scores').first().json.ranking.total_price_score || 0 }}', '={{ $('Calculate Weighted Scores').first().json.ranking.price_breakdown_score || 0 }}', '={{ $('Calculate Weighted Scores').first().json.ranking.optionals_included_score || 0 }}', '={{ $('Calculate Weighted Scores').first().json.ranking.capex_opex_methodology_score || 0 }}', '={{ $('Calculate Weighted Scores').first().json.ranking.schedule_score || 0 }}', '={{ $('Calculate Weighted Scores').first().json.ranking.resources_allocation_score || 0 }}', '={{ $('Calculate Weighted Scores').first().json.ranking.exceptions_score || 0 }}', '={{ $('Calculate Weighted Scores').first().json.ranking.safety_studies_score || 0 }}', '={{ $('Calculate Weighted Scores').first().json.ranking.regulatory_compliance_score || 0 }}', '={{ $('Calculate Weighted Scores').first().json.ranking.overall_score || 0 }}', '={{ $('Calculate Weighted Scores').first().json.ranking.compliance_percentage || 0 }}', '={{ $('Calculate Weighted Scores').first().json.ranking.evaluation_count || 0 }}', '={{ $('Calculate Weighted Scores').first().json.ranking.last_updated }}', '={{ JSON.stringify($('Calculate Weighted Scores').first().json.ranking.category_scores_json || {}) }}', '={{ JSON.stringify($('Calculate Weighted Scores').first().json.ranking.individual_scores_json || {}) }}', '={{ JSON.stringify($('Calculate Weighted Scores').first().json.ranking.evaluation_details || {}) }}') RETURNING *",
        "options": {}
      },
      "type": "n8n-nodes-base.postgres",
      "typeVersion": 2.5,
      "position": [
        -4176,
        608
      ],
      "id": "7c02d44c-e3e3-4fc9-a5b9-5ad4fac74b68",
      "name": "Insert Ranking",
      "alwaysOutputData": false,
      "credentials": {
        "postgres": {
          "id": "V0REAPph5JBLqze3",
          "name": "Postgres account"
        }
      },
      "continueOnFail": true
    },
    {
      "parameters": {
        "aggregate": "aggregateAllItemData",
        "destinationFieldName": "all_rankings",
        "options": {}
      },
      "type": "n8n-nodes-base.aggregate",
      "typeVersion": 1,
      "position": [
        -5280,
        304
      ],
      "id": "4852e325-53bc-4707-99c5-0e903aa0f9b8",
      "name": "Aggregate All Rankings"
    },
    {
      "parameters": {
        "jsCode": "// =============================================\n// NODE: Generate Final Ranking with Details (v6 - Fully Dynamic Criteria)\n// Passes individual_scores and category scores as dynamic objects\n// =============================================\n\nconst items = $input.all();\nlet allRankings = [];\n\nitems.forEach(item => {\n    if (item.json.all_rankings) {\n        allRankings = allRankings.concat(item.json.all_rankings);\n    } else if (item.json.ranking) {\n        allRankings.push(item.json);\n    }\n});\n\nconst sortedRankings = allRankings\n    .map(r => ({\n        ranking: r.ranking || r,\n        details: r.details || {},\n        category_scores: r.category_scores || {},\n        individual_scores: r.individual_scores || {},\n        config_type: r.config_type || 'default'\n    }))\n    .sort((a, b) => (b.ranking.overall_score || 0) - (a.ranking.overall_score || 0));\n\nconst finalRanking = sortedRankings.map((r, idx) => {\n    // Build dynamic category scores object\n    const categoryScores = r.ranking.category_scores_json || {};\n    // Also populate legacy fields for backward compatibility\n    const scores = {\n        technical: categoryScores.TECHNICAL || categoryScores.technical || r.ranking.technical_score || 0,\n        economic: categoryScores.ECONOMIC || categoryScores.economic || r.ranking.economic_score || 0,\n        execution: categoryScores.EXECUTION || categoryScores.execution || r.ranking.execution_score || 0,\n        hse_compliance: categoryScores.HSE_COMPLIANCE || categoryScores.hse_compliance || r.ranking.hse_compliance_score || 0\n    };\n    // Add any dynamic categories that aren't in the legacy set\n    for (const [catKey, catScore] of Object.entries(categoryScores)) {\n        const normalizedKey = catKey.toLowerCase();\n        if (!scores[normalizedKey]) {\n            scores[normalizedKey] = catScore;\n        }\n    }\n\n    // Build dynamic individual_scores from JSONB or fallback to legacy fields\n    const dynamicIndividual = r.ranking.individual_scores_json || r.individual_scores || {};\n    // Merge with legacy fixed fields as fallback\n    const individualScores = { ...dynamicIndividual };\n    const legacyFields = [\n        'scope_facilities', 'scope_work', 'deliverables_quality',\n        'total_price', 'price_breakdown', 'optionals_included', 'capex_opex_methodology',\n        'schedule', 'resources_allocation', 'exceptions',\n        'safety_studies', 'regulatory_compliance'\n    ];\n    legacyFields.forEach(f => {\n        if (!(f in individualScores) || !individualScores[f]) {\n            individualScores[f] = r.ranking[f + '_score'] || r.individual_scores?.[f] || 0;\n        }\n    });\n\n    return {\n        position: idx + 1,\n        provider_name: r.ranking.provider_name,\n        overall_score: r.ranking.overall_score,\n        compliance_percentage: r.ranking.compliance_percentage,\n        scores,\n        individual_scores: individualScores,\n        evaluation: {\n            strengths: r.details.strengths || [],\n            weaknesses: r.details.weaknesses || [],\n            recommendations: r.details.recommendations || [],\n            summary: r.details.summary || ''\n        }\n    };\n});\n\nconst configType = sortedRankings[0]?.config_type || 'default';\n\nconst stats = {\n    total_providers: finalRanking.length,\n    average_score: finalRanking.reduce((sum, r) => sum + (r.overall_score || 0), 0) / (finalRanking.length || 1),\n    top_performer: finalRanking[0]?.provider_name || 'N/A',\n    score_range: {\n        min: Math.min(...finalRanking.map(r => r.overall_score || 0)),\n        max: Math.max(...finalRanking.map(r => r.overall_score || 0))\n    },\n    evaluation_date: new Date().toISOString(),\n    config_type: configType\n};\n\nconsole.log(`Final Ranking Generated (${configType} config):`);\nfinalRanking.forEach(r => {\n    console.log(`   ${r.position}. ${r.provider_name}: ${r.overall_score} (${r.compliance_percentage}%)`);\n});\n\nreturn {\n    json: {\n        success: true,\n        ranking: finalRanking,\n        statistics: stats,\n        message: `Scoring completed for ${finalRanking.length} providers using ${configType} criteria configuration`\n    }\n};"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        -4992,
        304
      ],
      "id": "1bc3278b-0725-4933-89f3-344c5c0020f8",
      "name": "Generate Final Ranking"
    },
    {
      "parameters": {
        "respondWith": "json",
        "responseBody": "={{ $json }}",
        "options": {
          "responseHeaders": {
            "entries": [
              {
                "name": "Content-Type",
                "value": "application/json"
              }
            ]
          }
        }
      },
      "type": "n8n-nodes-base.respondToWebhook",
      "typeVersion": 1.5,
      "position": [
        -4768,
        304
      ],
      "id": "35bc2cc6-8428-42c2-89f5-57e61f21f2e2",
      "name": "Respond with Ranking"
    },
    {
      "parameters": {
        "content": "## Scoring Workflow - Provider Evaluation (v5)\n## Dynamic Criteria Support\n\nThis workflow now supports:\n1. **Default criteria** - 11 hardcoded criteria for engineering proposals\n2. **Dynamic criteria** - Custom criteria loaded from `scoring_configuration_summary` view\n\n### How it works:\n1. Fetches scoring configuration for the project\n2. If configuration exists, uses dynamic criteria and weights\n3. If no configuration, falls back to default criteria\n\n### Default Category Weights:\n- **TECHNICAL COMPLETENESS (30%)**\n- **ECONOMIC COMPETITIVENESS (35%)**\n- **EXECUTION CAPABILITY (20%)**\n- **HSE & COMPLIANCE (15%)**\n\n### Endpoint:\nPOST /webhook/scoring-evaluation\n```json\n{\n  \"project_id\": \"uuid\",\n  \"provider_name\": \"filter\",\n  \"recalculate_all\": false\n}\n```\n\n### Response includes:\n- `config_type`: 'dynamic' or 'default'\n- `ranking`: Sorted provider scores\n- `statistics`: Summary stats",
        "height": 1264,
        "width": 3280
      },
      "type": "n8n-nodes-base.stickyNote",
      "typeVersion": 1,
      "position": [
        -7232,
        -96
      ],
      "id": "13565459-d846-464d-b7ba-4c4076260af2",
      "name": "Workflow Info"
    },
    {
      "parameters": {
        "content": "## AI Scoring (v5)\n\nEvaluates engineering proposals using:\n- Dynamic OR default criteria\n- Custom weights from database\n- Value-for-money comparison\n- Strengths and weaknesses\n\nStructured JSON output",
        "height": 220,
        "width": 320,
        "color": 6
      },
      "type": "n8n-nodes-base.stickyNote",
      "typeVersion": 1,
      "position": [
        -5376,
        64
      ],
      "id": "0763c93d-0afb-4d09-bcca-22b1c9504cac",
      "name": "LLM Scoring Info"
    },
    {
      "parameters": {
        "assignments": {
          "assignments": [
            {
              "id": "project_id",
              "name": "project_id",
              "value": "={{ $('Webhook Scoring').first().json.body.project_id }}",
              "type": "string"
            },
            {
              "id": "provider_filter",
              "name": "provider_filter",
              "value": "={{ $('Webhook Scoring').first().json.body.provider_name || '' }}",
              "type": "string"
            },
            {
              "id": "recalculate_all",
              "name": "recalculate_all",
              "value": "={{ $('Webhook Scoring').first().json.body.recalculate_all || false }}",
              "type": "boolean"
            }
          ]
        },
        "options": {}
      },
      "type": "n8n-nodes-base.set",
      "typeVersion": 3.4,
      "position": [
        -6448,
        512
      ],
      "id": "3963dc0a-b43d-45b1-a514-b40ce63e3cd9",
      "name": "Set Input Params1"
    },
    {
      "parameters": {
        "schemaType": "manual",
        "inputSchema": "{\n  \"type\": \"object\",\n  \"properties\": {\n    \"provider_name\": { \"type\": \"string\" },\n    \"category_scores\": {\n      \"type\": \"object\",\n      \"additionalProperties\": {\n        \"type\": \"object\",\n        \"properties\": {\n          \"score\": { \"type\": \"number\" },\n          \"weight\": { \"type\": \"number\" }\n        }\n      }\n    },\n    \"individual_scores\": {\n      \"type\": \"object\",\n      \"additionalProperties\": { \"type\": \"number\" }\n    },\n    \"overall_score\": { \"type\": \"number\" },\n    \"compliance_percentage\": { \"type\": \"number\" },\n    \"evaluation_summary\": { \"type\": \"string\" },\n    \"strengths\": { \"type\": \"array\", \"items\": { \"type\": \"string\" } },\n    \"weaknesses\": { \"type\": \"array\", \"items\": { \"type\": \"string\" } },\n    \"recommendations\": { \"type\": \"array\", \"items\": { \"type\": \"string\" } }\n  },\n  \"required\": [\"provider_name\", \"category_scores\", \"individual_scores\", \"overall_score\", \"compliance_percentage\"]\n}"
      },
      "type": "@n8n/n8n-nodes-langchain.outputParserStructured",
      "typeVersion": 1.3,
      "position": [
        -5136,
        720
      ],
      "id": "ae294d2f-2220-4a7b-9542-9ae0329d888b",
      "name": "JSON Output Parser1"
    },
    {
      "parameters": {
        "model": "qwen3:8b",
        "options": {
          "temperature": 0.1,
          "numCtx": 8192,
          "numPredict": 2048
        }
      },
      "type": "@n8n/n8n-nodes-langchain.lmChatOllama",
      "typeVersion": 1,
      "position": [
        -5392,
        704
      ],
      "id": "f48650f4-5c93-45ed-a1e7-f874049384e3",
      "name": "Ollama Scoring Model",
      "credentials": {
        "ollamaApi": {
          "id": "oS2Qqti9oVfsm8XZ",
          "name": "Ollama account"
        }
      }
    },
    {
      "parameters": {
        "operation": "executeQuery",
        "query": "=DELETE FROM desarrollo.ranking_proveedores WHERE project_id = '={{ $('Webhook Scoring').first().json.body.project_id }}'",
        "options": {}
      },
      "type": "n8n-nodes-base.postgres",
      "typeVersion": 2.5,
      "position": [
        -6672,
        512
      ],
      "id": "1f043289-52d8-44d1-9506-84cb27cd9e6c",
      "name": "Delete a row",
      "alwaysOutputData": true,
      "credentials": {
        "postgres": {
          "id": "V0REAPph5JBLqze3",
          "name": "Postgres account"
        }
      }
    },
    {
      "parameters": {
        "options": {}
      },
      "type": "@n8n/n8n-nodes-langchain.lmChatOpenRouter",
      "typeVersion": 1,
      "position": [
        -5296,
        800
      ],
      "id": "91a819b9-b132-49ce-b78d-a5a309bece8e",
      "name": "OpenRouter Chat Model1",
      "credentials": {
        "openRouterApi": {
          "id": "4AyUqsh1Z35g6bci",
          "name": "OpenRouter account"
        }
      }
    },
    {
      "parameters": {
        "httpMethod": "POST",
        "path": "scoring-evaluation-desarrollo",
        "responseMode": "responseNode",
        "options": {}
      },
      "type": "n8n-nodes-base.webhook",
      "typeVersion": 2.1,
      "position": [
        -6976,
        512
      ],
      "id": "201c610f-d067-426a-af6a-edec41ebd738",
      "name": "Webhook Scoring",
      "webhookId": "scoring-eval-webhook-001"
    },
    {
      "parameters": {
        "content": "## RFQ Chat - Full Database Access",
        "height": 832,
        "width": 2016,
        "color": 3
      },
      "type": "n8n-nodes-base.stickyNote",
      "typeVersion": 1,
      "position": [
        -3840,
        -1312
      ],
      "id": "5123fd30-9647-4b93-881c-a2ee384994e7",
      "name": "Sticky Note4"
    },
    {
      "parameters": {
        "options": {}
      },
      "type": "n8n-nodes-base.respondToWebhook",
      "typeVersion": 1.5,
      "position": [
        -2080,
        -1120
      ],
      "id": "59648d30-31d6-433f-912a-d6e0421a99bb",
      "name": "Respond to Webhook5"
    },
    {
      "parameters": {
        "model": "qwen3:8b",
        "options": {
          "temperature": 0.2,
          "numCtx": 8192,
          "numPredict": 1024
        }
      },
      "type": "@n8n/n8n-nodes-langchain.lmChatOllama",
      "typeVersion": 1,
      "position": [
        -3552,
        -752
      ],
      "id": "0b15b392-aa8b-4f49-9863-efdce8242d34",
      "name": "Ollama Chat Model3",
      "credentials": {
        "ollamaApi": {
          "id": "oS2Qqti9oVfsm8XZ",
          "name": "Ollama account"
        }
      }
    },
    {
      "parameters": {
        "httpMethod": "POST",
        "path": "chat-rfq-desarrollo",
        "responseMode": "responseNode",
        "options": {}
      },
      "type": "n8n-nodes-base.webhook",
      "typeVersion": 2.1,
      "position": [
        -3728,
        -1120
      ],
      "id": "7983e997-68bc-4dca-a255-f9470c126c3e",
      "name": "Webhook1",
      "webhookId": "chat-rfq"
    },
    {
      "parameters": {
        "sessionIdType": "customKey",
        "sessionKey": "={{ $json.body.sessionId }}"
      },
      "id": "c3e2012a-0b72-436f-abe0-755f0e9fa704",
      "name": "Postgres Chat Memory",
      "type": "@n8n/n8n-nodes-langchain.memoryPostgresChat",
      "typeVersion": 1,
      "position": [
        -3376,
        -896
      ],
      "notesInFlow": false,
      "credentials": {
        "postgres": {
          "id": "V0REAPph5JBLqze3",
          "name": "Postgres account"
        }
      }
    },
    {
      "parameters": {
        "model": "qwen3-embedding:8b"
      },
      "type": "@n8n/n8n-nodes-langchain.embeddingsOllama",
      "typeVersion": 1,
      "position": [
        -2880,
        -688
      ],
      "id": "d8e8ad1c-330d-4bd8-a72a-a20f4f3cd229",
      "name": "Embeddings Ollama",
      "credentials": {
        "ollamaApi": {
          "id": "oS2Qqti9oVfsm8XZ",
          "name": "Ollama account"
        }
      }
    },
    {
      "parameters": {
        "promptType": "define",
        "text": "={{ $json.body.chatInput }}",
        "options": {
          "systemMessage": "=CRITICAL RULES - YOU MUST FOLLOW THESE:\n1. ALWAYS respond in ENGLISH or SPANISH, it depends on the previous message from the user.\n2. NEVER use emojis or emoticons in your responses.\n\nYou are an expert assistant specialized in analyzing vendor proposals for RFQ evaluations.\n\nVENDORS: IDOM, SACYR, TECNICASREUNIDAS (TR), EA, SENER, TRESCA, WORLEY\n\n## AVAILABLE TOOLS\n\n### Vector Search Tools (for narrative/document content):\n- **consultar_ofertas_proveedores**: Search vendor proposal documents for detailed text, technical descriptions, and narrative content.\n- **consultar_documentos_rfq**: Search original RFQ documents for client requirements and specifications.\n\n### SQL Tools (for structured data):\n- **query_requirements**: Query rfq_items_master with provider_responses. Returns: requirement_text, evaluation_type (Technical/Economical/Others), phase, provider evaluations (evaluation_value, comment).\n- **query_provider_responses**: Query provider_responses table. Filter by provider_name to get detailed vendor responses with comments.\n- **query_ranking**: Query ranking_proveedores table. Returns: overall_score (0-10 scale), compliance_percentage (%), category scores (0-10 scale), individual criterion scores (JSONB), and evaluation details with strengths/weaknesses (JSONB). Categories and weights are dynamic per project. IMPORTANT: Present data exactly as returned by the query, never invent or estimate scores.\n- **query_qa_audit**: Query qa_audit table. Filter by: provider, discipline (Electrica/Mecanica/Civil/Proceso/General), status, or all.\n\n## TOOL SELECTION GUIDE\n\n| Question Type | Tool to Use |\n|---------------|-------------|\n| Overall ranking, who is best? | query_ranking |\n| Category scores (technical, economic, execution, HSE) | query_ranking |\n| Requirement compliance details | query_requirements |\n| Vendor evaluation details and comments | query_provider_responses |\n| Pending Q&A questions | query_qa_audit |\n| Document text, technical details | consultar_ofertas_proveedores |\n| Original RFQ specifications | consultar_documentos_rfq |\n\n## SCORING\n- All scores are on a 0-10 scale.\n- Scoring categories and weights are DYNAMIC per project. Do NOT assume fixed categories or weights.\n- Always retrieve actual scores from query_ranking and present them exactly as returned.\n- NEVER invent, estimate, or hallucinate scores. If query_ranking returns no data, say so.\n\n## INSTRUCTIONS\n1. ALWAYS use tools to retrieve data before answering. Never guess.\n2. For comparisons, query multiple sources if needed.\n3. Be concise (2-3 sentences max).\n4. Remember: English only, no emojis."
        }
      },
      "id": "dfe7b417-bd18-426a-be7b-ebf822b7c63a",
      "name": "Chat AI Agent",
      "type": "@n8n/n8n-nodes-langchain.agent",
      "typeVersion": 1.6,
      "position": [
        -2848,
        -1120
      ]
    },
    {
      "parameters": {
        "mode": "retrieve-as-tool",
        "toolName": "consultar_ofertas_proveedores",
        "toolDescription": "Search vendor technical proposals for narrative content, technical descriptions, pricing details, and compliance explanations. Use when you need detailed text from proposal documents.",
        "tableName": {
          "__rl": true,
          "value": "proposals",
          "mode": "list",
          "cachedResultName": "proposals"
        },
        "topK": 10,
        "options": {
          "queryName": "match_proposals"
        }
      },
      "type": "@n8n/n8n-nodes-langchain.vectorStoreSupabase",
      "typeVersion": 1,
      "position": [
        -3248,
        -896
      ],
      "id": "e4d75c92-5362-466d-ab73-9ada740f8784",
      "name": "Revisar-ofertas",
      "credentials": {
        "supabaseApi": {
          "id": "pI4CpdYLTiEEBmnz",
          "name": "Supabase account"
        }
      },
      "disabled": true
    },
    {
      "parameters": {
        "mode": "retrieve-as-tool",
        "toolName": "consultar_documentos_rfq",
        "toolDescription": "Search original RFQ documents for client requirements, technical specifications, scope of work, and tender documentation. Use when you need the original request details.",
        "tableName": {
          "__rl": true,
          "value": "rfq",
          "mode": "list",
          "cachedResultName": "rfq"
        },
        "topK": 10,
        "options": {
          "queryName": "match_rfq"
        }
      },
      "type": "@n8n/n8n-nodes-langchain.vectorStoreSupabase",
      "typeVersion": 1,
      "position": [
        -2960,
        -896
      ],
      "id": "541e52cb-0239-473d-aa37-71cc78ba096a",
      "name": "Revisar RFQs",
      "credentials": {
        "supabaseApi": {
          "id": "pI4CpdYLTiEEBmnz",
          "name": "Supabase account"
        }
      },
      "disabled": true
    },
    {
      "parameters": {
        "model": "qwen3-embedding:8b"
      },
      "type": "@n8n/n8n-nodes-langchain.embeddingsOllama",
      "typeVersion": 1,
      "position": [
        -3168,
        -688
      ],
      "id": "d5c49b44-3209-4ff0-a3dd-60ae8cc1c80f",
      "name": "Embeddings Ollama5",
      "credentials": {
        "ollamaApi": {
          "id": "oS2Qqti9oVfsm8XZ",
          "name": "Ollama account"
        }
      }
    },
    {
      "parameters": {
        "descriptionType": "manual",
        "toolDescription": "Query RFQ requirements with optional vendor responses. Use to find: requirement_text, evaluation_type (Technical/Economical/Others), phase, and provider evaluations. Provide a search_term to filter requirements.",
        "operation": "executeQuery",
        "query": "SELECT rim.id, rim.evaluation_type, rim.phase, rim.requirement_text, pr.provider_name, pr.evaluation_value, pr.comment FROM rfq_items_master rim LEFT JOIN provider_responses pr ON rim.id = pr.requirement_id WHERE (rim.requirement_text ILIKE '%' || $1 || '%' OR rim.evaluation_type ILIKE '%' || $1 || '%') AND ($2 = '' OR rim.project_id::text = $2) ORDER BY rim.id LIMIT 30;",
        "options": {
          "queryReplacement": "={{ $fromAI('search_term', 'Keyword to search in requirements', 'string') }}, {{ $json.body.project_id || '' }}"
        }
      },
      "type": "n8n-nodes-base.postgresTool",
      "typeVersion": 2.5,
      "position": [
        -2672,
        -896
      ],
      "id": "7975fe52-e4af-497b-b647-383d6db5d829",
      "name": "query_requirements",
      "credentials": {
        "postgres": {
          "id": "V0REAPph5JBLqze3",
          "name": "Postgres account"
        }
      }
    },
    {
      "parameters": {
        "descriptionType": "manual",
        "toolDescription": "Query detailed vendor responses with comments. Use to find: evaluation_value, comment, provider_name. Provide provider_name to filter by vendor (IDOM, SACYR, TECNICASREUNIDAS, EA, SENER, TRESCA, WORLEY) or leave empty for all.",
        "operation": "executeQuery",
        "query": "SELECT pr.id, pr.provider_name, pr.evaluation_value, pr.comment, rim.requirement_text, rim.evaluation_type, rim.phase FROM provider_responses pr LEFT JOIN rfq_items_master rim ON pr.requirement_id = rim.id WHERE ($1 = '' OR pr.provider_name ILIKE '%' || $1 || '%') AND ($2 = '' OR pr.project_id::text = $2) ORDER BY pr.provider_name LIMIT 30;",
        "options": {
          "queryReplacement": "={{ $fromAI('provider_name', 'Provider name to filter (or empty for all)', 'string') }}, {{ $json.body.project_id || '' }}"
        }
      },
      "type": "n8n-nodes-base.postgresTool",
      "typeVersion": 2.5,
      "position": [
        -2544,
        -896
      ],
      "id": "fc5430e4-d1ae-49ab-aa12-8b7bbc2134d0",
      "name": "query_provider_responses",
      "credentials": {
        "postgres": {
          "id": "V0REAPph5JBLqze3",
          "name": "Postgres account"
        }
      }
    },
    {
      "parameters": {
        "descriptionType": "manual",
        "toolDescription": "Query vendor rankings and scores. Returns provider_name, overall_score (0-10 scale), compliance_percentage (%), category scores (0-10 scale), individual criterion scores (JSONB), and evaluation details with strengths/weaknesses (JSONB). Categories and weights are dynamic per project. Use for ranking questions and score comparisons. Always present the data exactly as returned, never invent or estimate scores.",
        "operation": "executeQuery",
        "query": "SELECT rp.provider_name, ROUND(rp.overall_score / 10, 2) as overall_score, rp.compliance_percentage, ROUND(rp.technical_score / 10, 2) as technical_score, ROUND(rp.economic_score / 10, 2) as economic_score, ROUND(rp.execution_score / 10, 2) as execution_score, ROUND(rp.hse_compliance_score / 10, 2) as hse_compliance_score, rp.category_scores_json, rp.individual_scores_json, rp.evaluation_details, rp.evaluation_count, rp.last_updated FROM ranking_proveedores rp WHERE ($1 = '' OR rp.project_id::text = $1) ORDER BY rp.overall_score DESC;",
        "options": {
          "queryReplacement": "={{ $json.body.project_id || '' }}"
        }
      },
      "type": "n8n-nodes-base.postgresTool",
      "typeVersion": 2.5,
      "position": [
        -2416,
        -896
      ],
      "id": "a32e4ec3-e76a-4040-b251-aefb74d42b94",
      "name": "query_ranking",
      "credentials": {
        "postgres": {
          "id": "V0REAPph5JBLqze3",
          "name": "Postgres account"
        }
      }
    },
    {
      "parameters": {
        "descriptionType": "manual",
        "toolDescription": "Query Q&A audit for technical questions and responses. Returns: provider_name, discipline (Electrica/Mecanica/Civil/Proceso/General), question, status (Pending/Approved/etc.), importance (High/Medium/Low), response. Use filter_type: 'provider' with filter_value for vendor name, 'discipline' for discipline, 'status' for status, or 'all' for everything.",
        "operation": "executeQuery",
        "query": "SELECT qa.id, qa.provider_name, qa.discipline, qa.question, qa.status, qa.importance, qa.response, qa.created_at FROM qa_audit qa WHERE (($1 = 'all') OR ($1 = 'provider' AND qa.provider_name ILIKE '%' || $2 || '%') OR ($1 = 'discipline' AND qa.discipline ILIKE '%' || $2 || '%') OR ($1 = 'status' AND qa.status ILIKE '%' || $2 || '%')) AND ($3 = '' OR qa.project_id::text = $3) ORDER BY qa.created_at DESC LIMIT 25;",
        "options": {
          "queryReplacement": "={{ $fromAI('filter_type', 'Filter type: provider, discipline, status, or all', 'string') }}, {{ $fromAI('filter_value', 'Value to filter by (provider name, discipline, or status)', 'string') }}, {{ $json.body.project_id || '' }}"
        }
      },
      "type": "n8n-nodes-base.postgresTool",
      "typeVersion": 2.5,
      "position": [
        -2288,
        -896
      ],
      "id": "e93a2a0c-9ac9-404c-96eb-7720ee61a4fb",
      "name": "query_qa_audit",
      "credentials": {
        "postgres": {
          "id": "V0REAPph5JBLqze3",
          "name": "Postgres account"
        }
      }
    },
    {
      "parameters": {
        "model": "mistral-large-latest",
        "options": {}
      },
      "type": "@n8n/n8n-nodes-langchain.lmChatMistralCloud",
      "typeVersion": 1,
      "position": [
        -2752,
        -672
      ],
      "id": "b3645d33-7d60-42c5-8c9d-e8b3598b1aca",
      "name": "Mistral Cloud Chat Model2",
      "credentials": {
        "mistralCloudApi": {
          "id": "tDjuOnF6lpADMmd5",
          "name": "Mistral Cloud account"
        }
      }
    },
    {
      "parameters": {
        "options": {
          "temperature": 0.1
        }
      },
      "type": "@n8n/n8n-nodes-langchain.lmChatOpenRouter",
      "typeVersion": 1,
      "position": [
        -2656,
        -576
      ],
      "id": "1a4d4db9-f966-4e45-a4c4-b84f75f558eb",
      "name": "OpenRouter Chat Model",
      "credentials": {
        "openRouterApi": {
          "id": "4AyUqsh1Z35g6bci",
          "name": "OpenRouter account"
        }
      }
    },
    {
      "parameters": {
        "content": "### Ingesta de RFQ, actualización de requisitos",
        "height": 1280,
        "width": 4390,
        "color": 4
      },
      "type": "n8n-nodes-base.stickyNote",
      "typeVersion": 1,
      "position": [
        -1712,
        368
      ],
      "id": "2b4547ee-b3d4-4bce-a3d1-b794492d73f6",
      "name": "Sticky Note"
    },
    {
      "parameters": {
        "httpMethod": "POST",
        "path": "ingesta-rfq-desarrollo",
        "responseMode": "responseNode",
        "options": {}
      },
      "type": "n8n-nodes-base.webhook",
      "typeVersion": 2.1,
      "position": [
        -1600,
        592
      ],
      "id": "af74fd58-efa8-40ad-8339-51f48d6bdc13",
      "name": "Webhook RFQ",
      "webhookId": "86850b01-70b4-4c99-a63a-6ccad35c0be2"
    },
    {
      "parameters": {
        "jsCode": "// =============================================\n// NODO: Preparar Texto (Agregador de Páginas)\n// =============================================\n\nconst items = $input.all();\nif (!items || items.length === 0) {\n    return { json: { error: \"No input items received\" } };\n}\n\n// Recuperar metadatos del inicio del flujo (Generate IDs1)\nlet metadata = {};\ntry {\n    metadata = $('Generate IDs1').first().json;\n} catch (e) {\n    console.log(\"⚠️ No se pudo recuperar metadata de Generate IDs1\");\n}\n\n// 1. Agregado de Texto Completo (todas las páginas)\n// Intentamos md_content primero (mejor para LLMs), luego text\nlet fullText = items.map(item => item.json.md_content || item.json.text || \"\").join('\\n\\n').trim();\n\nif (!fullText) {\n    console.log(\"⚠️ Advertencia: No se extrajo texto del documento.\");\n}\n\n// 2. Limpieza básica\nfullText = fullText.replace(/\\x00/g, ''); // Eliminar caracteres nulos\n\n// 3. Preparar fragmento para clasificación (máx 40k chars para no saturar context)\nconst textForClassification = fullText.substring(0, 40000);\n\nconsole.log(`✅ Texto preparado: ${items.length} páginas aggregadas. Chars: ${fullText.length}`);\n\nreturn {\n    json: {\n        rfq_project_id: metadata.rfq_project_id || \"unknown\",\n        rfq_document_id: metadata.rfq_document_id || \"unknown\",\n        project_name: metadata.project_name || \"Sin Nombre\",\n        file_title: metadata.file_title || \"document.pdf\",\n        text: fullText, \n        text_for_classification: textForClassification || \"SIN TEXTO DETECTADO\",\n        pages_count: items.length\n    }\n};"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        -480,
        592
      ],
      "id": "a00ee5b0-3641-4a34-9cf2-569cf91e8a6a",
      "name": "Preparar Texto1"
    },
    {
      "parameters": {
        "promptType": "define",
        "text": "=### DOCUMENTO RFQ\n\nNombre del Archivo: {{ $json.file_title }}\nNombre Proyect: {{ $('Webhook RFQ').item.json.body.project_name }}\n### CONTENIDO (FRAGMENTO):\n{{ $json.pages ? $json.pages.slice(0, 1).map(p => p.text).join('\\n\\n') : ($json.text ? $json.text.substring(0, 2000) : 'SIN TEXTO') }}",
        "hasOutputParser": true,
        "messages": {
          "messageValues": [
            {
              "message": "=## TAREA: CLASIFICAR TIPOS DE EVALUACIÓN EN DOCUMENTO RFQ Y NOMBRE DEL PROYECTO\n\nEres un auditor experto en documentación de ingeniería EPC del sector energético.\nAnaliza el documento RFQ y determina qué tipos de evaluación contiene y el nombre del proyecto.\n\n### IMPORTANTE\n\nUn documento puede contener 1, 2, 3 o 4 tipos de evaluación.\n**No asumas que están todos.**\nDetecta **SOLO** los que realmente están presentes.\n\n### REGLA DE CONSERVADURISMO (CRÍTICA)\n**Clasifica SOLO el tipo que realmente está presente en el contenido del documento.**\n- Cada documento PDF individual suele contener UN SOLO tipo de evaluación.\n- Solo clasifica múltiples tipos si el documento tiene secciones CLARAMENTE DIFERENCIADAS para cada tipo.\n- NO asumas tipos basándote en el nombre del archivo o título. Basa tu clasificación EXCLUSIVAMENTE en el contenido real.\n- En caso de duda, clasifica con MENOS tipos, no más.\n\n### TIPOS POSIBLES (SOLO 3)\n\n1. **Technical Evaluation**\n\n   **Evidencia requerida:**\n   - Secciones de **Scope of Work**, **Scope of Facilities**, **Technical Requirements**\n   - Requisitos técnicos generales (metodología, normativas, estándares)\n   - Descripción de alcance por fases (PRE-FEED, FEED, EPC, Conceptual, Basic Engineering, Detailed Engineering)\n   - Especificaciones de ingeniería, criterios de diseño\n   - Listas de deliverables técnicos por disciplina\n\n2. **Economical Evaluation**\n\n   **Evidencia requerida:**\n   - Tablas de **precios** o **tarifas**\n   - **Hours per discipline**, **EUR/hora**, **USD/hour**, tarifas horarias\n   - Formato de **cotización económica**, **pricing schedule**\n   - **Desglose de costos por fase** o por disciplina\n   - Secciones **Commercial**, **Pricing**, **Budget**, **Cost Breakdown**\n\n3. **Others**\n\n   **Usar cuando el documento NO encaja claramente en Technical ni Economical.**\n   Ejemplos: listas de deliverables sin requisitos técnicos, documentos HSE, compliance, schedules, términos y condiciones, información general del proyecto, etc.\n\n### NOMENCLATURA ALTERNATIVA\n\n| Nombre en documento | Clasificar como |\n|---------------------|-----------------|\n| Technical Proposal, Technical Offer, Scope of Work, Technical Requirements | Technical Evaluation |\n| Commercial Proposal, Pricing, Cost Estimate, Quotation, Rate Schedule | Economical Evaluation |\n| Cualquier otro contenido (deliverables, HSE, compliance, general, etc.) | Others |\n\n### CÓMO DIFERENCIAR\n\n| Si ves... | Es... |\n| --- | --- |\n| **Scope of Work**, **metodología**, requisitos técnicos, especificaciones | **Technical Evaluation** |\n| Tablas de precios, horas, **EUR/h**, tarifas, presupuestos | **Economical Evaluation** |\n| Cualquier otro contenido que no encaje arriba | **Others** |\n\n### TAREA OBLIGATORIA: IDENTIFICAR NOMBRE DEL PROYECTO\n\nEsta tarea es **obligatoria** y **NO** puede omitirse.\n**Deberás devolver SIEMPRE** un valor para `nombre_proyecto`.\n\n### ORDEN DE PRIORIDAD (estricto)\n\n1. **Nombre explícito del proyecto**\n   - Busca en la **portada** o el **título principal**.\n   - Encabezados repetidos que contengan el nombre del proyecto.\n   - Frases como **Project**, **Project Name**, **Project Title**, **RFQ for...**\n\n2. **Nombre implícito pero oficial**\n   Si no encuentras un título literal, genera el nombre combinando los siguientes elementos:\n   - Tipo de instalación energética (**Hydrogen Plant**, **PV Plant**, **Solar Plant**, **Wind Farm**, **Battery Storage**, **Power Plant**, **Electrolyzer**, **Substation**, etc.)\n   - Ubicación (ciudad, región o país)\n   - Cliente o **site** si está claramente indicado\n   - Capacidad si se menciona (ej: 100 MW, 50 MWp, 20 MW electrolyzer)\n   - Ejemplo: **100 MW Solar PV Plant – Andalucía, Spain**\n\n3. **Fallback obligatorio**\n   Si el documento no declara claramente un nombre:\n   - **NO dejes el campo vacío**.\n   - **NO uses valores genéricos**.\n   - Genera un nombre técnico-descriptivo utilizando:\n     - **Formato obligatorio**: `<Tipo de Proyecto Energético> – <Ubicación o Cliente> (RFQ)`\n   - Ejemplo: **Green Hydrogen Production Facility – Northern Spain (RFQ)**\n\n### REGLAS DURAS\n\n- **No usar**: Unknown, N/A, Not specified\n- **No inventar nombres comerciales**\n- El nombre debe ser válido para un entorno EPC / PMO del sector energético\n- Prioriza claridad, trazabilidad y profesionalidad\n\n### FORMATO DE SALIDA (JSON PLANO – ESTRICTO)\n\n**ATENCIÓN: REGLAS DE ESTRUCTURA**\n1. Devuelve **ÚNICAMENTE** un objeto JSON que empiece por `{` y termine por `}`.\n2. **PROHIBIDO** devolver el JSON dentro de una lista o array `[]`.\n3. **PROHIBIDO** usar claves contenedoras como `\"output\"`, `\"response\"` o `\"json\"`. El nivel raíz debe tener directamente las claves `tipos_detectados` y `nombre_proyecto`.\n4. No incluyas bloques de código markdown (\\`\\`\\`json). Solo el texto plano del JSON.\n\n**FORMATO DE SALIDA CORRECTO:**\n{\n  \"tipos_detectados\": [\"Technical Evaluation\"],\n  \"razonamiento\": \"El documento incluye un Scope of Work con requisitos técnicos y especificaciones de ingeniería.\"\n}"
            }
          ]
        },
        "batching": {}
      },
      "type": "@n8n/n8n-nodes-langchain.chainLlm",
      "typeVersion": 1.8,
      "position": [
        -784,
        832
      ],
      "id": "2b2c42c1-dde1-4da3-9eff-50e4fbfb51c0",
      "name": "Clasificador de Tipos1"
    },
    {
      "parameters": {
        "model": "mistral:7b",
        "options": {
          "temperature": 0.1
        }
      },
      "type": "@n8n/n8n-nodes-langchain.lmOllama",
      "typeVersion": 1,
      "position": [
        -832,
        1056
      ],
      "id": "06aeab00-7ecd-4778-8153-90e828a55095",
      "name": "Ollama Clasificador1",
      "credentials": {
        "ollamaApi": {
          "id": "oS2Qqti9oVfsm8XZ",
          "name": "Ollama account"
        }
      }
    },
    {
      "parameters": {
        "schemaType": "manual",
        "inputSchema": "{\n  \"type\": \"object\",\n  \"properties\": {\n    \"tipos_detectados\": {\n      \"type\": \"array\",\n      \"items\": {\n        \"type\": \"string\",\n        \"enum\": [\"Technical Evaluation\", \"Economical Evaluation\", \"Others\"]\n      }\n    },\n\"razonamiento\": {\n      \"type\": \"string\"\n    }\n  },\n  \"required\": [\"tipos_detectados\", \"nombre_proyecto\"]\n}"
      },
      "type": "@n8n/n8n-nodes-langchain.outputParserStructured",
      "typeVersion": 1.3,
      "position": [
        -592,
        1056
      ],
      "id": "cfe5816f-6ef8-41fa-b4a2-142ab6a1ecc5",
      "name": "Output Parser1"
    },
    {
      "parameters": {
        "jsCode": "// =============================================\n// NODO: Expandir por Tipo (CORREGIDO)\n// =============================================\n\n// 1. Recuperar metadatos de nodos anteriores\nlet projectId = \"unknown\";\nlet documentId = \"unknown\";\nlet fileTitle = \"unknown\";\nlet fullText = \"\";\nlet metadataProjectName = \"\";\n\ntry {\n    const textNode = $('Preparar Texto1').first().json;\n    projectId = textNode.rfq_project_id || \"unknown\";\n    documentId = textNode.rfq_document_id || \"unknown\";\n    fileTitle = textNode.file_title || \"unknown\";\n    fullText = textNode.text || \"\";\n    metadataProjectName = textNode.project_name || \"\"; \n} catch(e) {\n    console.log(\"⚠️ No se pudieron leer metadatos de Preparar Texto1\");\n}\n\n// 2. Obtener los tipos DIRECTAMENTE del Clasificador (no del input actual)\nlet tipos = [];\nlet nombreProyecto = \"\";\n\ntry {\n    const clasificadorData = $('Clasificador de Tipos1').first().json;\n    \n    // El clasificador puede devolver el output de diferentes formas\n    let output = clasificadorData.output || clasificadorData;\n    \n    // Intentar parsear si es string\n    if (typeof output === 'string') {\n        try {\n            const clean = output.replace(/```json/gi, '').replace(/```/g, '').trim();\n            const start = clean.indexOf('{');\n            const end = clean.lastIndexOf('}');\n            if (start !== -1 && end !== -1) {\n                output = JSON.parse(clean.substring(start, end + 1));\n            } else {\n                output = JSON.parse(clean);\n            }\n        } catch(e) {\n            console.log(\"⚠️ Error parseando output del clasificador\");\n        }\n    }\n    \n    // Extraer tipos y nombre del proyecto\n    tipos = output.tipos_detectados || [];\n    nombreProyecto = output.nombre_proyecto || \"\";\n    \n    console.log(`✅ Tipos detectados por IA: ${JSON.stringify(tipos)}`);\n} catch(e) {\n    console.log(\"⚠️ Error recuperando datos del Clasificador de Tipos1\");\n}\n\n// 3. Validación y fallback SOLO si NO hay tipos\nif (!Array.isArray(tipos)) tipos = [];\n\nif (tipos.length === 0) {\n    // Fallback: si el clasificador falló completamente\n    const titleLower = (fileTitle || \"\").toLowerCase();\n    const isRFQ = titleLower.includes(\"rfq\") || titleLower.includes(\"request for quotation\");\n    \n    if (isRFQ) {\n        tipos = [\"Technical Evaluation\"];\n        console.log(\"⚠️ Fallback: Usando Technical Evaluation por defecto para RFQ\");\n    } else {\n        tipos = [\"Technical Evaluation\"];\n        console.log(\"⚠️ Fallback: Usando Technical Evaluation por defecto\");\n    }\n}\n\n// Eliminar duplicados\ntipos = [...new Set(tipos)];\n\n// 4. Nombre del Proyecto\nlet finalProjectName = nombreProyecto || metadataProjectName;\n\nif (!finalProjectName || finalProjectName === \"Sin Nombre\" || finalProjectName.includes(\"La Zaida\")) {\n    finalProjectName = fileTitle.replace(/\\.pdf$/i, '') + \" (Project)\";\n}\n\nconsole.log(`📋 Expandiendo ${tipos.length} tipos: ${tipos.join(', ')}`);\n\n// 5. Generar Salida (Expandir items)\nreturn tipos.map((tipo, idx) => ({\n    json: {\n        tipo_evaluacion: tipo,\n        rfq_project_id: projectId,\n        rfq_document_id: documentId,\n        nombre_proyecto: finalProjectName,\n        file_title: fileTitle,\n        texto_rfq: fullText,\n        indice: idx + 1,\n        total_tipos: tipos.length\n    }\n}));"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        176,
        832
      ],
      "id": "682cac3d-f960-4df4-b944-4f2cfffbfc43",
      "name": "Expandir por Tipo1"
    },
    {
      "parameters": {
        "options": {}
      },
      "type": "n8n-nodes-base.splitInBatches",
      "typeVersion": 3,
      "position": [
        384,
        832
      ],
      "id": "1ae340cc-1dc4-4a45-a8fe-569979d35189",
      "name": "Loop por Tipo1"
    },
    {
      "parameters": {
        "jsCode": "// =============================================\n// NODO: Parsear Final (Con Nombre Proyecto)\n// =============================================\nconst inputJson = $input.first().json;\n// Asegurar que sea string\nlet llmOutput = \"\";\nif (typeof inputJson === 'string') llmOutput = inputJson;\nelse if (inputJson.text && typeof inputJson.text === 'string') llmOutput = inputJson.text;\nelse if (inputJson.output && typeof inputJson.output === 'string') llmOutput = inputJson.output;\nelse if (inputJson.content && typeof inputJson.content === 'string') llmOutput = inputJson.content;\nelse llmOutput = JSON.stringify(inputJson.text || inputJson.output || inputJson.content || inputJson);\n\nllmOutput = String(llmOutput || \"[]\");\n\n// 1. Recuperar Contexto del Loop\nlet projectId = \"unknown\";\nlet documentId = \"unknown\";\nlet tipoEvaluacion = \"Unknown\";\nlet nombreProyecto = \"Sin Nombre\";\n\ntry {\n    const loopData = $('Loop por Tipo1').first().json;\n    projectId = loopData.rfq_project_id;\n    documentId = loopData.rfq_document_id;\n    tipoEvaluacion = loopData.tipo_evaluacion;\n    nombreProyecto = loopData.nombre_proyecto || \"Sin Nombre\";\n} catch(e) {}\n\n// 2. Lógica de Parsing\nlet items = [];\n\ntry {\n    let clean = llmOutput.replace(/```json/gi, '').replace(/```/g, '').trim();\n    const start = clean.indexOf('[');\n    const end = clean.lastIndexOf(']');\n    if (start !== -1 && end !== -1) {\n        items = JSON.parse(clean.substring(start, end + 1));\n    }\n} catch(e) {}\n\nif (items.length === 0) {\n    const lines = llmOutput.split('\\n');\n    let currentPhase = \"General\";\n    for (let i = 0; i < lines.length; i++) {\n        const line = lines[i].trim();\n        if (!line) continue;\n        if (/^\\d+\\./.test(line) && !line.includes('Estimate')) {\n            const text = line.replace(/^\\d+\\.\\s*/, '').trim();\n            if (i+1 < lines.length && (lines[i+1].trim().startsWith('-') || lines[i+1].trim().startsWith('•'))) {\n                currentPhase = text;\n            } else {\n                 items.push({ fase: \"General\", requisito_rfq: text });\n            }\n        }\n        else if (line.startsWith('-') || line.startsWith('•')) {\n            items.push({ fase: currentPhase, requisito_rfq: line.replace(/^[-•]\\s*/, '').trim() });\n        }\n    }\n}\n\nfunction generateId(str) {\n    let hash = 0;\n    for (let i = 0; i < str.length; i++) {\n        hash = ((hash << 5) - hash) + str.charCodeAt(i);\n        hash = hash & hash;\n    }\n    return 'item_' + Math.abs(hash).toString(16).padStart(12, '0');\n}\n\nreturn items.map(item => ({\n    json: {\n        rfq_project_id: projectId,\n        project_name: nombreProyecto,\n        rfq_document_id: documentId,\n        evaluation: tipoEvaluacion,\n        fase: item.fase || \"General\",\n        requisito_rfq: item.requisito_rfq || \"Sin Nombre\"\n    }\n}));"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        1952,
        768
      ],
      "id": "298d462e-60e6-420c-b544-8beafdafbd6d",
      "name": "Parsear Items1"
    },
    {
      "parameters": {
        "jsCode": "// =============================================\n// NODO: Agregar Resultados del Tipo Actual\n// =============================================\n\nconst items = $input.all();\n\n// Contar items insertados\nconst totalInserted = items.length;\n\n// Recuperar info del tipo actual\nlet tipoActual = \"unknown\";\ntry {\n    tipoActual = $('Loop por Tipo1').first().json.tipo_evaluacion;\n} catch(e) {}\n\nconsole.log(`✅ Tipo ${tipoActual}: ${totalInserted} items insertados`);\n\nreturn {\n    json: {\n        tipo_procesado: tipoActual,\n        items_insertados: totalInserted,\n        continuar_loop: true\n    }\n};"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        2480,
        960
      ],
      "id": "af8996ec-d01f-47ab-b969-e3a055b85db1",
      "name": "Agregar Resultados1"
    },
    {
      "parameters": {
        "jsCode": "// =============================================\n// NODO: Resumen Final\n// =============================================\n\n// Recuperar datos del proyecto\nlet projectId = \"unknown\";\nlet fileTitle = \"unknown\";\nlet tiposDetectados = [];\n\ntry {\n    const projectNode = $('Generate IDs1').first().json;\n    projectId = projectNode.rfq_project_id;\n    fileTitle = projectNode.file_title;\n} catch(e) {}\n\ntry {\n    const clasificador = $('Clasificador de Tipos1').first().json;\n    const output = clasificador.output || clasificador;\n    tiposDetectados = output.tipos_detectados || [];\n} catch(e) {}\n\nconsole.log(\"========================================\");\nconsole.log(\"✅ PROCESAMIENTO RFQ COMPLETADO\");\nconsole.log(`   Proyecto: ${projectId}`);\nconsole.log(`   Archivo: ${fileTitle}`);\nconsole.log(`   Tipos procesados: ${tiposDetectados.length}`);\nconsole.log(\"========================================\");\n\nreturn {\n    json: {\n        success: true,\n        rfq_project_id: projectId,\n        file_title: fileTitle,\n        tipos_procesados: tiposDetectados,\n        mensaje: `RFQ procesada correctamente. ${tiposDetectados.length} tipo(s) de evaluación detectados y poblados.`\n    }\n};"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        1680,
        432
      ],
      "id": "c5c9c227-8c1a-444a-b3e1-7e46ad7467fe",
      "name": "Resumen Final1"
    },
    {
      "parameters": {
        "respondWith": "json",
        "responseBody": "={{ JSON.stringify($json) }}",
        "options": {}
      },
      "type": "n8n-nodes-base.respondToWebhook",
      "typeVersion": 1.5,
      "position": [
        1968,
        432
      ],
      "id": "c34912a5-e26e-424f-8a10-1097faa2930d",
      "name": "Respond Success1"
    },
    {
      "parameters": {
        "jsCode": "// =============================================\n// NODO: Base64 a Binary\n// =============================================\n\n// Recuperar metadatos del inicio del flujo (Generate IDs1)\nlet inputData = {};\ntry {\n    inputData = $('Generate IDs1').first().json;\n} catch (e) {\n    inputData = $json; // Fallback\n}\n\nconst base64Data = inputData.file_binary;\n\nif (!base64Data || base64Data === \"\") {\n    throw new Error(\"❌ CRÍTICO: 'file_binary' está vacío\");\n}\n\nconst binaryData = Buffer.from(base64Data, 'base64');\n\nconsole.log(`✅ PDF convertido: ${binaryData.length} bytes`);\n\nreturn {\n    json: {\n        rfq_project_id: inputData.rfq_project_id || \"unknown\",\n        rfq_document_id: inputData.rfq_document_id || \"unknown\",\n        project_name: inputData.project_name || \"Sin Nombre\",\n        file_title: inputData.file_title || \"document.pdf\"\n    },\n    binary: {\n        data: {\n            data: binaryData.toString('base64'),\n            mimeType: 'application/pdf',\n            fileName: inputData.file_title || 'rfq.pdf',\n            fileSize: binaryData.length\n        }\n    }\n};"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        -928,
        592
      ],
      "id": "38e9180a-d822-46d6-84b3-1bbaae7a5308",
      "name": "Base64 a Binary3"
    },
    {
      "parameters": {
        "operation": "pdf",
        "options": {}
      },
      "type": "n8n-nodes-base.extractFromFile",
      "typeVersion": 1.1,
      "position": [
        -704,
        592
      ],
      "id": "1b5239ca-0081-4606-ae9a-cb8740e70cec",
      "name": "Extract from File3"
    },
    {
      "parameters": {
        "jsCode": "// =============================================\n// NODO: Generate Stable ID + Detectar Modo (CORREGIDO)\n// Con soporte para project_id (UUID) del frontend\n// =============================================\n\nfunction simpleHash(str) {\n  let hash = 0;\n  for (let i = 0; i < str.length; i++) {\n    const char = str.charCodeAt(i);\n    hash = ((hash << 5) - hash) + char;\n    hash = hash & hash;\n  }\n  return Math.abs(hash).toString(16).padStart(16, '0').substring(0, 16);\n}\n\n// Aseguramos capturar el body correctamente desde el nodo anterior\nconst body = $json.body || $json;\n\n// CAMPOS BÁSICOS\nconst originalFileId = body.file_id || \"unknown\";\nconst fileTitle = body.file_title || \"unknown.pdf\";\nconst fileBinary = body.file_binary || \"\";\nconst fileUrl = body.file_url || \"unknown\";\n\n// ✅ EXTRAER project_id (UUID) del payload del frontend\nconst projectIdFromPayload = body.project_id || null;\n\n// ✅ EXTRAER METADATA DEL USUARIO\n// Usamos el operador ?. para evitar errores si metadata no existe\nconst metadata = body.metadata || {};\nconst rfqProjectName = metadata.proyect_name || body.project_name || null;\nconst userProveedor = metadata.proveedor || null;\nconst userTipoEval = metadata.evaluation || null; \n\n// ✅ DETERMINAR MODO DE OPERACIÓN\nlet modoOperacion = \"CLASIFICADOR\"; \nlet datosCompletos = false;\n\nif (userProveedor && userTipoEval && Array.isArray(userTipoEval) && userTipoEval.length > 0) {\n    modoOperacion = \"VALIDADOR\";\n    datosCompletos = true;\n} else if (userProveedor || (userTipoEval && Array.isArray(userTipoEval) && userTipoEval.length > 0)) {\n    modoOperacion = \"HIBRIDO\";\n}\n\n// Generar ID estable basado en título + project_id (evita colisiones entre proyectos)\nconst normalizedTitle = fileTitle.toLowerCase().trim();\nconst stableId = simpleHash(normalizedTitle + '_' + (projectIdFromPayload || ''));\n\n// ID de Documento (único por contenido + proyecto)\nconst documentId = 'doc_' + stableId;\n\nconsole.log('📋 Generate IDs - project_id from frontend:', projectIdFromPayload);\n\nreturn {\n  json: {\n    file_id: stableId, // Este es tu ID estable\n    rfq_document_id: documentId,\n    file_id_original: originalFileId,\n    file_title: fileTitle,\n    file_binary: fileBinary,\n    file_url: fileUrl,\n    \n    // ✅ project_id (UUID) real del frontend - usado para filtrar por proyecto\n    project_id: projectIdFromPayload,\n    \n    // Si no hay nombre de proyecto, usamos el nombre del archivo como fallback\n    project_name: rfqProjectName || fileTitle.replace(/\\.[^/.]+$/, \"\"),\n    rfq_project_id: projectIdFromPayload || (rfqProjectName ? 'proj_' + simpleHash(rfqProjectName.toLowerCase().trim()) : 'proj_generic'),\n    \n    user_proveedor: userProveedor,\n    user_tipo_evaluacion: userTipoEval,\n    modo_operacion: modoOperacion,\n    datos_usuario_completos: datosCompletos,\n    \n    // Guardamos una copia limpia para los nodos siguientes\n    metadata_limpia: {\n        proyect_name: rfqProjectName,\n        proveedor: userProveedor,\n        evaluation: userTipoEval\n    }\n  }\n};"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        -1376,
        592
      ],
      "id": "e5690535-4a28-49b9-9b9b-d49e189df882",
      "name": "Generate IDs1"
    },
    {
      "parameters": {
        "rules": {
          "values": [
            {
              "conditions": {
                "options": {
                  "caseSensitive": true,
                  "leftValue": "",
                  "typeValidation": "strict",
                  "version": 3
                },
                "conditions": [
                  {
                    "leftValue": "={{ $json.tipo_evaluacion }}",
                    "rightValue": "Evaluation",
                    "operator": {
                      "type": "string",
                      "operation": "contains"
                    },
                    "id": "c3ac36b0-dcd7-4e84-a72a-7e88b6f2fc2a"
                  }
                ],
                "combinator": "and"
              }
            },
            {
              "conditions": {
                "options": {
                  "caseSensitive": true,
                  "leftValue": "",
                  "typeValidation": "strict",
                  "version": 3
                },
                "conditions": [
                  {
                    "id": "529ee554-7a05-413a-9782-710d0deb6365",
                    "leftValue": "={{ $json.tipo_evaluacion }}",
                    "rightValue": "Deliverables",
                    "operator": {
                      "type": "string",
                      "operation": "contains"
                    }
                  }
                ],
                "combinator": "and"
              }
            }
          ]
        },
        "options": {}
      },
      "type": "n8n-nodes-base.switch",
      "typeVersion": 3.4,
      "position": [
        1280,
        960
      ],
      "id": "3652133c-900c-41c2-b259-571f0049c468",
      "name": "Switch1"
    },
    {
      "parameters": {
        "model": "qwen3:8b",
        "options": {
          "temperature": 0.1,
          "numCtx": 8192,
          "numPredict": 2048
        }
      },
      "type": "@n8n/n8n-nodes-langchain.lmOllama",
      "typeVersion": 1,
      "position": [
        1536,
        1408
      ],
      "id": "ca2cbf35-16ac-4b40-a2b5-8a92d521bcd6",
      "name": "Ollama Extractor2",
      "credentials": {
        "ollamaApi": {
          "id": "oS2Qqti9oVfsm8XZ",
          "name": "Ollama account"
        }
      }
    },
    {
      "parameters": {
        "promptType": "define",
        "text": "=### TAREA: EXTRACCIÓN MASIVA DE ENTREGABLES (DELIVERABLES)\n\n**OBJETIVO:** Extraer **TODOS** los documentos, planos y entregables listados. **EXHAUSTIVIDAD TOTAL**.\n\n### INSTRUCCIONES CRÍTICAS (NO RESUMIR):\n1. **TABLAS:** Si encuentras una tabla, extrae **CADA FILA**. Si hay 140 filas, devuelve 140 ítems.\n2. **NO AGRUPES:** Mantén la granularidad.\n3. **FASES:** Infiere la fase/disciplina. Si no, usa 'General'.\n\n### IDIOMA:\n- Los campos `fase` y `requisito_rfq` deben estar en el MISMO IDIOMA que el texto del documento.\n- NO traduzcas: mantén el idioma original.\n\n### EXTRACCIÓN DE LISTA DE ENTREGABLES (TEXTO DESORDENADO)\n\n### EXTRACCIÓN DE LISTA DE ENTREGABLES (TEXTO DESORDENADO)\n\nProyecto: {{ $json.nombre_proyecto }}\nEvaluación: {{ $('Loop por Tipo1').item.json.tipo_evaluacion }}\nArchivo: {{ $('Generate IDs1').first().json.file_title }}\n\n### TEXTO DEL PDF:\n{{ $json.texto_chunk }}\n\n### FORMATO DE SALIDA:\n```json\n[\n  { \"fase\": \"Process\", \"requisito_rfq\": \"PFD\" },\n  { \"fase\": \"Civil\", \"requisito_rfq\": \"Foundation Layout\" }\n]\n```\n\n**RESPUESTA (JSON PURO):**",
        "messages": {
          "messageValues": [
            {
              "message": "=Eres una API que devuelve JSON. \n- NO saludes.\n- NO expliques.\n- NO uses markdown fuera del JSON.\n- Tu salida DEBE empezar con `[` y terminar con `]`."
            }
          ]
        },
        "batching": {}
      },
      "type": "@n8n/n8n-nodes-langchain.chainLlm",
      "typeVersion": 1.7,
      "position": [
        1600,
        1184
      ],
      "id": "04d53319-66cf-4300-9b23-2e8540113ff0",
      "name": "LLM Extractor - Deliverables"
    },
    {
      "parameters": {
        "jsCode": "// =============================================\n// NODO: Parsear Deliverables (ROBUST FALLBACK)\n// =============================================\n\nconst inputJson = $input.first().json;\n\n// 1. RECOGIDA DE DATOS RAW\nlet rawOutput = \"\";\nif (inputJson.output && typeof inputJson.output === 'string') rawOutput = inputJson.output;\nelse if (inputJson.text && typeof inputJson.text === 'string') rawOutput = inputJson.text;\nelse if (inputJson.content && typeof inputJson.content === 'string') rawOutput = inputJson.content;\nelse if (typeof inputJson === 'string') rawOutput = inputJson;\n\n// 2. INTENTO A: EXTRAER JSON\nlet items = [];\ntry {\n    const clean = rawOutput.replace(/```json/gi, '').replace(/```/g, '').trim();\n    const start = clean.indexOf('[');\n    const end = clean.lastIndexOf(']');\n    if (start !== -1 && end !== -1) {\n        items = JSON.parse(clean.substring(start, end + 1));\n    }\n} catch(e) {}\n\n// 3. INTENTO B: FALLBACK DE LISTA\nif (items.length === 0 && rawOutput) {\n    const lines = rawOutput.split('\\n');\n    let currentPhase = \"General\";\n    lines.forEach(line => {\n        const trimmed = line.trim();\n        if (!trimmed) return;\n        const numberMatch = trimmed.match(/^\\d+\\.\\s*(.*)/);\n        const bulletMatch = trimmed.match(/^[-•*]\\s*(.*)/);\n        if (numberMatch) {\n            items.push({ fase: currentPhase, requisito_rfq: numberMatch[1] });\n        } else if (bulletMatch) {\n             items.push({ fase: currentPhase, requisito_rfq: bulletMatch[1] });\n        }\n    });\n}\n\n// 4. HELPER: GENERAR ID ESTABLE\nfunction generateId(str) {\n    let hash = 0;\n    for (let i = 0; i < str.length; i++) {\n        hash = ((hash << 5) - hash) + str.charCodeAt(i);\n        hash = hash & hash;\n    }\n    return 'item_' + Math.abs(hash).toString(16).padStart(12, '0');\n}\n\n// 5. NORMALIZAR Y RETORNAR\nlet loopCtx = {};\ntry {\n   const outerLoop = $('Loop por Tipo1').first().json;\n   loopCtx = {\n       rfq_project_id: outerLoop.rfq_project_id,\n       rfq_document_id: outerLoop.rfq_document_id,\n       project_name: outerLoop.nombre_proyecto,\n       tipo_evaluacion: outerLoop.tipo_evaluacion\n   };\n} catch(e){}\n\nreturn items.map(item => {\n    const phase = item.fase || \"General\";\n    const req = item.requisito_rfq || \"Sin Nombre\";\n    return {\n        json: {\n            rfq_project_id: loopCtx.rfq_project_id || \"unknown\",\n            rfq_document_id: loopCtx.rfq_document_id || \"unknown\",\n            project_name: loopCtx.project_name || \"Unknown\",\n            evaluation: loopCtx.tipo_evaluacion || \"Deliverables\",\n            fase: phase,\n            requisito_rfq: req\n        }\n    };\n});"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        1952,
        1184
      ],
      "id": "da2dfc11-d55d-4b24-8614-f7b5a63f75a5",
      "name": "Parsear deliverables"
    },
    {
      "parameters": {
        "model": "qwen3:8b",
        "options": {
          "temperature": 0.1,
          "numCtx": 8192,
          "numPredict": 2048
        }
      },
      "type": "@n8n/n8n-nodes-langchain.lmOllama",
      "typeVersion": 1,
      "position": [
        1536,
        960
      ],
      "id": "13d22b05-0482-43dc-9f5b-7054d2d498b9",
      "name": "Ollama Extractor1",
      "credentials": {
        "ollamaApi": {
          "id": "oS2Qqti9oVfsm8XZ",
          "name": "Ollama account"
        }
      }
    },
    {
      "parameters": {
        "schemaType": "manual",
        "inputSchema": "{\n  \"type\": \"array\",\n  \"items\": {\n    \"type\": \"object\",\n    \"properties\": {\n      \"fase\": {\n        \"type\": \"string\",\n        \"description\": \"Nombre de la disciplina o área (ej: Process Engineering, Mechanical Engineering, Civil and Structural, Electrical Engineering, etc.)\"\n      },\n      \"requisito_rfq\": {\n        \"type\": \"string\",\n        \"description\": \"Nombre del documento o entregable específico\"\n      }\n    },\n    \"required\": [\"fase\", \"requisito_rfq\"]\n  }\n}"
      },
      "type": "@n8n/n8n-nodes-langchain.outputParserStructured",
      "typeVersion": 1.3,
      "position": [
        1840,
        1392
      ],
      "id": "a1988522-f2d3-44da-987e-2e903173882c",
      "name": "Structured Output Parser1"
    },
    {
      "parameters": {
        "schemaType": "manual",
        "inputSchema": "{\n  \"type\": \"array\",\n  \"items\": {\n    \"type\": \"object\",\n    \"properties\": {\n      \"fase\": {\n        \"type\": \"string\",\n        \"description\": \"Fase del proyecto o disciplina (ej: PRE-FEED, FEED, EPC, Process Engineering, etc.)\"\n      },\n      \"requisito_rfq\": {\n        \"type\": \"string\",\n        \"description\": \"Requisito técnico o económico específico\"\n      }\n    },\n    \"required\": [\"fase\", \"requisito_rfq\"]\n  }\n}"
      },
      "type": "@n8n/n8n-nodes-langchain.outputParserStructured",
      "typeVersion": 1.3,
      "position": [
        1776,
        960
      ],
      "id": "90843b10-82c3-4f1a-83d7-275e646d9d62",
      "name": "Structured Output Parser2"
    },
    {
      "parameters": {
        "jsCode": "// =============================================\n// NODO: Dividir en Trozos (Chunking)\n// =============================================\n\nconst input = $input.first().json;\nconst fullText = input.texto_rfq || \"\";\n\n// OPTIMIZADO: Chunks más pequeños para procesamiento más rápido\n// ~6000 caracteres (aprox 1.5k-2k tokens) = respuestas en 10-15 seg\nconst chunkSize = 6000;\nconst overlap = 400;\nconst chunks = [];\n\nif (fullText.length <= chunkSize) {\n    chunks.push({\n        ...input,\n        texto_chunk: fullText,\n        chunk_index: 1,\n        total_chunks: 1\n    });\n} else {\n    let start = 0;\n    while (start < fullText.length) {\n        let end = start + chunkSize;\n        let chunk = fullText.substring(start, end);\n        \n        chunks.push({\n            ...input,\n            texto_chunk: chunk,\n            chunk_index: chunks.length + 1\n        });\n\n        start += (chunkSize - overlap);\n        if (start >= fullText.length) break;\n    }\n    chunks.forEach(c => c.total_chunks = chunks.length);\n}\n\nreturn chunks;"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        672,
        944
      ],
      "id": "fdba9fc5-67c6-42c9-b3a0-569f73dc0518",
      "name": "Dividir en Trozos1"
    },
    {
      "parameters": {
        "options": {
          "reset": "={{ $json.reiniciar_bucle ? true : false }}"
        }
      },
      "type": "n8n-nodes-base.splitInBatches",
      "typeVersion": 3,
      "position": [
        1024,
        944
      ],
      "id": "34ebfeac-3d17-461b-9a00-86739dd5a8bc",
      "name": "Loop por Trozo1"
    },
    {
      "parameters": {
        "jsCode": "const items = $input.all();\n\nreturn items.map(item => ({\n    json: {\n        ...item.json, // Mantiene todos los datos originales (incluido tipo_evaluacion)\n        \n        // Aquí está la corrección: Usamos dos puntos, no el igual.\n        reiniciar_bucle: true \n    }\n}));\n"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        848,
        944
      ],
      "id": "973341ad-a0a9-4f00-a245-03b2c138c06e",
      "name": "Reset Items1"
    },
    {
      "parameters": {
        "model": "qwen3-embedding:8b"
      },
      "type": "@n8n/n8n-nodes-langchain.embeddingsOllama",
      "typeVersion": 1,
      "position": [
        -256,
        1056
      ],
      "id": "0193f94e-6827-48bf-bbb0-abce2b95bf32",
      "name": "Embeddings Ollama1",
      "credentials": {
        "ollamaApi": {
          "id": "oS2Qqti9oVfsm8XZ",
          "name": "Ollama account"
        }
      }
    },
    {
      "parameters": {
        "mode": "insert",
        "tableName": {
          "__rl": true,
          "value": "rfq",
          "mode": "list",
          "cachedResultName": "rfq"
        },
        "options": {
          "queryName": "match_rfq"
        }
      },
      "id": "f8f80034-49aa-4234-bb57-c42686796131",
      "name": "Insert into Supabase Vectorstore1",
      "type": "@n8n/n8n-nodes-langchain.vectorStoreSupabase",
      "typeVersion": 1,
      "position": [
        -176,
        832
      ],
      "credentials": {
        "supabaseApi": {
          "id": "pI4CpdYLTiEEBmnz",
          "name": "Supabase account"
        }
      },
      "disabled": true
    },
    {
      "parameters": {
        "chunkSize": 800,
        "chunkOverlap": 150,
        "options": {}
      },
      "type": "@n8n/n8n-nodes-langchain.textSplitterRecursiveCharacterTextSplitter",
      "typeVersion": 1,
      "position": [
        0,
        1264
      ],
      "id": "f2bb05b3-a0f2-4c37-8d39-1d8091b898fd",
      "name": "Recursive Character Text Splitter1"
    },
    {
      "parameters": {
        "jsonMode": "expressionData",
        "jsonData": "={{ $('Preparar Texto1').item.json.text_for_classification }}",
        "options": {
          "metadata": {
            "metadataValues": [
              {
                "name": "file_id",
                "value": "={{ $('Generate IDs1').first().json.rfq_document_id }}"
              },
              {
                "name": "file_title",
                "value": "={{ $('Generate IDs1').first().json.file_title }}"
              },
              {
                "name": "tipo_evaluacion",
                "value": "={{ $('Clasificador de Tipos1').item.json.output.tipos_detectados }}"
              },
              {
                "name": "tipo-doc",
                "value": "RFQ"
              }
            ]
          }
        }
      },
      "id": "aa587949-6e25-49a7-a905-8f0c37eafd17",
      "name": "Default Data Loader1",
      "type": "@n8n/n8n-nodes-langchain.documentDefaultDataLoader",
      "typeVersion": 1,
      "position": [
        -80,
        1056
      ]
    },
    {
      "parameters": {
        "operation": "executeQuery",
        "query": "=INSERT INTO desarrollo.rfq_items_master (project_id, evaluation_type, phase, requirement_text) VALUES ('{{ $('Generate IDs1').first().json.project_id }}', '{{ $json.evaluation }}', '{{ $json.fase }}', '{{ $json.requisito_rfq }}') RETURNING *",
        "options": {}
      },
      "type": "n8n-nodes-base.postgres",
      "typeVersion": 2.5,
      "position": [
        2272,
        960
      ],
      "id": "96e434c2-06ef-4b29-8f0d-0a22992339c7",
      "name": "Create a row",
      "credentials": {
        "postgres": {
          "id": "V0REAPph5JBLqze3",
          "name": "Postgres account"
        }
      }
    },
    {
      "parameters": {
        "operation": "executeQuery",
        "query": "=DELETE FROM desarrollo.rfq WHERE metadata->>'file_id' LIKE '%{{ $json.file_id }}%'",
        "options": {}
      },
      "id": "355cc512-d678-43bd-bf49-0ab76a8755dd",
      "name": "Delete Old Doc Rows1",
      "type": "n8n-nodes-base.postgres",
      "typeVersion": 2.5,
      "position": [
        -1152,
        592
      ],
      "alwaysOutputData": true,
      "credentials": {
        "postgres": {
          "id": "V0REAPph5JBLqze3",
          "name": "Postgres account"
        }
      }
    },
    {
      "parameters": {
        "operation": "upsert",
        "schema": {
          "__rl": true,
          "mode": "list",
          "value": "desarrollo"
        },
        "table": {
          "__rl": true,
          "value": "document_metadata",
          "mode": "list",
          "cachedResultName": "document_metadata"
        },
        "columns": {
          "mappingMode": "defineBelow",
          "value": {
            "id": "={{ $('Generate IDs1').first().json.rfq_document_id }}",
            "title": "={{ $('Generate IDs1').first().json.file_title }}",
            "document_type": "=RFQ",
            "evaluation_types": "={{ $json.output.tipos_detectados }}",
            "provider": "IGNIS",
            "project_id": "={{ $('Webhook RFQ').first().json.body.project_id }}"
          },
          "matchingColumns": [
            "id"
          ],
          "schema": [
            {
              "id": "id",
              "displayName": "id",
              "required": true,
              "defaultMatch": true,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            },
            {
              "id": "title",
              "displayName": "title",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": false
            },
            {
              "id": "project_id",
              "displayName": "project_id",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": false,
              "removed": false
            },
            {
              "id": "document_type",
              "displayName": "document_type",
              "required": true,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": false,
              "removed": false
            },
            {
              "id": "provider",
              "displayName": "provider",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": false,
              "removed": false
            },
            {
              "id": "evaluation_types",
              "displayName": "evaluation_types",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "array",
              "canBeUsedToMatch": false,
              "removed": false
            },
            {
              "id": "created_at",
              "displayName": "created_at",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "dateTime",
              "canBeUsedToMatch": false,
              "removed": false
            }
          ],
          "attemptToConvertTypes": false,
          "convertFieldsToString": false
        },
        "options": {}
      },
      "type": "n8n-nodes-base.postgres",
      "typeVersion": 2.5,
      "position": [
        -1056,
        2416
      ],
      "id": "957cb6ef-cfdd-41e6-8acb-d36c992f3df1",
      "name": "Insert Document Metadata2",
      "executeOnce": true,
      "credentials": {
        "postgres": {
          "id": "V0REAPph5JBLqze3",
          "name": "Postgres account"
        }
      }
    },
    {
      "parameters": {
        "promptType": "define",
        "text": "=### EXTRACCIÓN DE REQUISITOS RFQ - SOLO ÍTEMS EXPLÍCITOS\n\nProyecto: {{ $json.nombre_proyecto }}\nTipo: {{ $json.tipo_evaluacion }}\nArchivo: {{ $json.file_title }}\n\n### TEXTO:\n{{ $json.texto_chunk }}\n\n---\n### INSTRUCCIONES:\n\n**SOLO EXTRAER ÍTEMS QUE APARECEN CLARAMENTE EN LISTAS, TABLAS O COMO REQUISITOS EXPLÍCITOS**\n\n#### Para Technical Evaluation:\n- Buscar: \"The vendor shall provide/submit/deliver...\"\n- Buscar: Listas de documentos, entregables o planos\n- NO extraer: Descripciones generales, introducciones, alcance\n\n#### Para Economical Evaluation:  \n- Buscar: \"Item\", \"Line item\", tablas de precios, BOQ\n- Buscar: Partidas específicas a cotizar\n- NO extraer: Textos descriptivos sin ítems concretos\n\n### REGLAS ESTRICTAS:\n1. **MÍNIMO**: Extraer solo lo que es claramente un requisito/lista\n2. **CONCRETO**: Un ítem por cada línea de lista/tabla\n3. **ESPECÍFICO**: Si hay duda, NO extraer\n\n### IDIOMA DE SALIDA:\n- **IMPORTANTE:** Los campos `fase` y `requisito_rfq` deben estar en el MISMO IDIOMA que el documento original.\n- Si el documento está en español, usa \"Ingeniería de Procesos\", \"Ingeniería Civil\", etc.\n- Si el documento está en inglés, usa \"Process Engineering\", \"Civil Engineering\", etc.\n- Mantén consistencia de idioma en TODOS los campos de salida.\n\n### FORMATO:\n```json\n[\n  { \"fase\": \"Disciplina\", \"requisito_rfq\": \"Ítem exacto del texto\" }\n]\n```\n\n**RESPUESTA:**",
        "messages": {
          "messageValues": [
            {
              "message": "=Eres un Extractor de Requisitos de Ingeniería. Tu trabajo es poblar la base de datos maestra de requisitos del proyecto.\nNO inventes datos.\nNO resumas.\nUsa JSON estricto."
            }
          ]
        },
        "batching": {}
      },
      "type": "@n8n/n8n-nodes-langchain.chainLlm",
      "typeVersion": 1.7,
      "position": [
        1584,
        768
      ],
      "id": "dd33209a-f4ba-4a92-8ae9-dbffc0651c5c",
      "name": "LLM Extractor Tech-Econ"
    },
    {
      "parameters": {
        "model": "mistral-large-latest",
        "options": {}
      },
      "type": "@n8n/n8n-nodes-langchain.lmChatMistralCloud",
      "typeVersion": 1,
      "position": [
        1648,
        944
      ],
      "id": "89657f1e-163a-43bf-80ff-6a218a0fcd15",
      "name": "Mistral Cloud Chat Model7",
      "credentials": {
        "mistralCloudApi": {
          "id": "tDjuOnF6lpADMmd5",
          "name": "Mistral Cloud account"
        }
      }
    },
    {
      "parameters": {
        "model": "mistral-large-latest",
        "options": {}
      },
      "type": "@n8n/n8n-nodes-langchain.lmChatMistralCloud",
      "typeVersion": 1,
      "position": [
        1664,
        1392
      ],
      "id": "6740b69c-2552-4a28-9ed0-c711d364ebcc",
      "name": "Mistral Cloud Chat Model8",
      "credentials": {
        "mistralCloudApi": {
          "id": "tDjuOnF6lpADMmd5",
          "name": "Mistral Cloud account"
        }
      }
    },
    {
      "parameters": {
        "options": {}
      },
      "type": "@n8n/n8n-nodes-langchain.lmChatMistralCloud",
      "typeVersion": 1,
      "position": [
        -752,
        1184
      ],
      "id": "9739137c-3abe-422d-b8f5-aa48ac5fb528",
      "name": "Mistral Cloud Chat Model9",
      "credentials": {
        "mistralCloudApi": {
          "id": "tDjuOnF6lpADMmd5",
          "name": "Mistral Cloud account"
        }
      }
    },
    {
      "parameters": {
        "operation": "executeQuery",
        "query": "=SELECT * FROM desarrollo.rfq_items_master WHERE evaluation_type = '={{ $json.tipo_evaluacion_actual }}' AND project_id = '={{ $('Set File ID').first().json.project_id }}'",
        "options": {}
      },
      "type": "n8n-nodes-base.postgres",
      "typeVersion": 2.5,
      "position": [
        -736,
        -1168
      ],
      "id": "0f752205-732e-46f3-84b5-2c111ee9502b",
      "name": "Get many rows1",
      "credentials": {
        "postgres": {
          "id": "V0REAPph5JBLqze3",
          "name": "Postgres account"
        }
      }
    },
    {
      "parameters": {
        "model": "qwen3-embedding:8b"
      },
      "type": "@n8n/n8n-nodes-langchain.embeddingsOllama",
      "typeVersion": 1,
      "position": [
        2304,
        -64
      ],
      "id": "b24356fb-c718-4e9c-a7fa-30469d8fc2dc",
      "name": "Embeddings Ollama3",
      "credentials": {
        "ollamaApi": {
          "id": "oS2Qqti9oVfsm8XZ",
          "name": "Ollama account"
        }
      }
    },
    {
      "parameters": {
        "promptType": "define",
        "text": "=### DOCUMENT AUDIT: CROSS-VALIDATION\n\n**[1. USER MANUAL SELECTION]**\n- Project: \"{{ $('Set File ID').item.json.proyect_name }}\"\n- Provider: \"{{ $('Set File ID').item.json.proveedor }}\"\n- Evaluation Type: \"{{ $('Set File ID').item.json.evaluation }}\"\n- File Name: \"{{ $('Set File ID').item.json.file_title }}\"\n\n---\n**[2. ACTUAL PDF EVIDENCE (Extracted text)]**\n{{ $json.texto_muestra }}\n\n---\n### MAPPING AND VALIDATION INSTRUCTIONS:\n\n#### RULE 1: SYNONYMS AND CANONICAL TYPES\nYou can only use these 3 exact names. Map the evidence as follows:\n- **\"Commercial Proposal\" / \"Oferta Económica\" / \"Price Schedule\"** → MUST BE `Economical Evaluation`.\n- **\"Technical Proposal\" / \"Scope of Work\" / \"Metodología\"** → MUST BE `Technical Evaluation`.\n- **\"Technical & Economical Proposal\"** → MUST INCLUDE BOTH: `Technical Evaluation` AND `Economical Evaluation`.\n- **Anything else** (drawing lists, HSE, compliance, schedules, etc.) → `Others`.\n\n#### RULE 2: TITLE AND FILE NAME ARE DECISIVE\n- Analyze the **File Name** and **Title** of the document. If they say \"Oferta Técnica\" or \"Technical Proposal\", the type is `Technical Evaluation`.\n- **IMPORTANT:** DO NOT add other types for minor mentions. Example: If a technical document mentions \"estimated prices\", DO NOT add `Economical Evaluation`. Only add it if you see a complete PRICE TABLE.\n- Be conservative: when in doubt, follow the File Name.\n\n#### RULE 3: INTENTION BALANCING\n- If the PDF is mixed but the user has selected one of the valid types present, mark `tipos_validados: true`.\n\n### OUTPUT FORMAT (SINGLE JSON):\n{\n  \"modo_usado\": \"VALIDADOR\",\n  \"proyecto_detectado\": \"Actual Name\",\n  \"proyecto_valido\": true | false,\n  \"proyecto_nota\": \"Summary\",\n  \"proveedor_detectado\": \"IDOM | SENER | TRESCA | SACYR | TECNICASREUNIDAS | EA | WORLEY\",\n  \"proveedor_valido\": true | false,\n  \"proveedor_nota\": \"Explanation\",\n  \"tipos_detectados\": [\"Technical Evaluation\", \"Economical Evaluation\", \"Others\"],\n  \"tipos_validados\": true | false,\n  \"tipos_nota\": \"Explain why you validated or rejected the types.\",\n  \"razonamiento\": \"Mention the File Name and Title found.\"\n}",
        "hasOutputParser": true,
        "messages": {
          "messageValues": [
            {
              "message": "=Act as a strict validator. If there are flagrant discrepancies between the user's suggestion and the actual PDF content, prioritize the PDF content and mark validation as false and report the correct provider/type.\n\nSupported providers: Tecnicas Reunidas, IDOM, SACYR, Empresarios Agrupados, SENER, TRESCA, WORLEY"
            }
          ]
        },
        "batching": {}
      },
      "type": "@n8n/n8n-nodes-langchain.chainLlm",
      "typeVersion": 1.8,
      "position": [
        1808,
        -528
      ],
      "id": "7e0300b5-d041-4911-9db7-378826b30fad",
      "name": "Validador de Ofertas"
    },
    {
      "parameters": {
        "model": "mistral:7b",
        "options": {
          "temperature": 0.1,
          "numCtx": 4096,
          "numPredict": 1024
        }
      },
      "type": "@n8n/n8n-nodes-langchain.lmChatOllama",
      "typeVersion": 1,
      "position": [
        1760,
        -336
      ],
      "id": "b497662c-b1bf-4c43-97cb-44968d001712",
      "name": "Ollama Chat Model1",
      "credentials": {
        "ollamaApi": {
          "id": "oS2Qqti9oVfsm8XZ",
          "name": "Ollama account"
        }
      }
    },
    {
      "parameters": {
        "schemaType": "manual",
        "inputSchema": "{\n  \"type\": \"object\",\n  \"properties\": {\n    \"modo_usado\": {\n      \"type\": \"string\"\n    },\n    \"proyecto_detectado\": {\n      \"type\": \"string\"\n    },\n    \"proyecto_valido\": {\n      \"type\": \"boolean\"\n    },\n    \"proyecto_nota\": {\n      \"type\": \"string\"\n    },\n    \"proveedor_detectado\": {\n      \"type\": \"string\"\n    },\n    \"proveedor_valido\": {\n      \"type\": \"boolean\",\n      \"description\": \"DEBE ser false si el proveedor detectado es distinto al que el usuario seleccionó.\"\n    },\n    \"proveedor_nota\": {\n      \"type\": \"string\"\n    },\n    \"tipos_detectados\": {\n      \"type\": \"array\",\n      \"items\": {\n        \"type\": \"string\"\n      },\n      \"description\": \"Array con los tipos que realmente tienen evidencia en el doc.\"\n    },\n    \"tipos_validados\": {\n      \"type\": \"boolean\",\n      \"description\": \"DEBE ser false si el tipo seleccionado por el usuario no tiene evidencia clara en el PDF.\"\n    },\n    \"tipos_nota\": {\n      \"type\": \"string\"\n    },\n    \"razonamiento\": {\n      \"type\": \"string\"\n    }\n  },\n  \"required\": [\n    \"proyecto_detectado\",\n    \"proyecto_valido\",\n    \"proveedor_detectado\",\n    \"proveedor_valido\",\n    \"tipos_validados\",\n    \"razonamiento\"\n  ]\n}"
      },
      "type": "@n8n/n8n-nodes-langchain.outputParserStructured",
      "typeVersion": 1.3,
      "position": [
        2000,
        -336
      ],
      "id": "97c91397-0456-4a18-a0d8-8506c1958e09",
      "name": "Structured Output Parser4"
    },
    {
      "parameters": {
        "promptType": "define",
        "text": "=### TECHNICAL AND COMMERCIAL CLASSIFICATION (RFQ)\n\n### DOCUMENT SAMPLE (First 2 pages):\n{{ $json.texto_muestra }}\n\n---\n### CLASSIFICATION TASK:\nIdentify project, provider and evaluation types.\n\n**GOLDEN RULE FOR NOMENCLATURE:**\nYou must translate document titles to these exact names:\n- **\"Commercial Proposal\" / \"Oferta Económica\"** → MUST BE `Economical Evaluation`.\n- **\"Technical Proposal\" / \"Scope of Work\"** → MUST BE `Technical Evaluation`.\n- **Anything else** (document lists, HSE, compliance, schedules, etc.) → `Others`.\n\n#### REQUIREMENTS:\n1. **PROVIDER**: Must be one of: IDOM, SENER, TRESCA, SACYR, TECNICASREUNIDAS, EA, WORLEY.\n2. **TYPES**: The `tipos_detectados` array can only contain: `Technical Evaluation`, `Economical Evaluation`, `Others`.\n\n---\n### OUTPUT FORMAT (JSON):\n{\n  \"modo_usado\": \"CLASIFICADOR\",\n  \"proyecto_detectado\": \"Name\",\n  \"proveedor_detectado\": \"IDOM | SENER | TRESCA | SACYR | TECNICASREUNIDAS | EA | WORLEY\",\n  \"tipos_detectados\": [\"Technical Evaluation\"],\n  \"razonamiento\": \"Justification: 'Commercial Proposal' detected -> Economical Evaluation mapped.\"\n}",
        "hasOutputParser": true,
        "messages": {
          "messageValues": [
            {
              "message": "Identify the provider and evaluation types present in the document based only on the first pages."
            }
          ]
        },
        "batching": {}
      },
      "type": "@n8n/n8n-nodes-langchain.chainLlm",
      "typeVersion": 1.8,
      "position": [
        1808,
        -96
      ],
      "id": "8eafd001-d11d-4564-9246-78ae29ca61a5",
      "name": "Clasificador de Tipo de Evaluacion y Proveedor"
    },
    {
      "parameters": {
        "conditions": {
          "options": {
            "caseSensitive": true,
            "leftValue": "",
            "typeValidation": "strict",
            "version": 3
          },
          "conditions": [
            {
              "id": "267128b5-e2c0-44ae-9973-7f18dffe292e",
              "leftValue": "={{ $('Set File ID').item.json.proveedor }}",
              "rightValue": "",
              "operator": {
                "type": "string",
                "operation": "notEmpty",
                "singleValue": true
              }
            },
            {
              "id": "a9d65ff4-430e-45db-8ca8-6078e5ee32fa",
              "leftValue": "={{ $('Set File ID').item.json.evaluation[0] }}",
              "rightValue": "",
              "operator": {
                "type": "string",
                "operation": "notEmpty",
                "singleValue": true
              }
            },
            {
              "id": "d5c265e7-00e5-42f4-95ad-4eca1e3ef530",
              "leftValue": "={{ $('Set File ID').item.json.proyect_name }}",
              "rightValue": "",
              "operator": {
                "type": "string",
                "operation": "notEmpty",
                "singleValue": true
              }
            }
          ],
          "combinator": "and"
        },
        "options": {}
      },
      "type": "n8n-nodes-base.if",
      "typeVersion": 2.3,
      "position": [
        1536,
        -336
      ],
      "id": "18135ab9-aa66-466d-9cd3-8076b6e67eb4",
      "name": "If"
    },
    {
      "parameters": {
        "model": "qwen3:8b",
        "options": {
          "temperature": 0.1,
          "numCtx": 8192,
          "numPredict": 1536
        }
      },
      "type": "@n8n/n8n-nodes-langchain.lmOllama",
      "typeVersion": 1,
      "position": [
        1520,
        -896
      ],
      "id": "4772dee9-7534-490d-a8c5-d456047f1fcd",
      "name": "Ollama Model1",
      "credentials": {
        "ollamaApi": {
          "id": "oS2Qqti9oVfsm8XZ",
          "name": "Ollama account"
        }
      }
    },
    {
      "parameters": {
        "model": "mistral:7b",
        "options": {
          "temperature": 0.1,
          "numCtx": 4096,
          "numPredict": 1024
        }
      },
      "type": "@n8n/n8n-nodes-langchain.lmOllama",
      "typeVersion": 1,
      "position": [
        1760,
        112
      ],
      "id": "fd950da4-60c2-4270-9e9e-0897cbe33036",
      "name": "Ollama Model",
      "credentials": {
        "ollamaApi": {
          "id": "oS2Qqti9oVfsm8XZ",
          "name": "Ollama account"
        }
      }
    },
    {
      "parameters": {
        "content": "### Ingesta de Ofertas de Proveedores",
        "height": 1744,
        "width": 4608,
        "color": 5
      },
      "type": "n8n-nodes-base.stickyNote",
      "typeVersion": 1,
      "position": [
        -1712,
        -1488
      ],
      "id": "0927e240-5391-46f5-b472-570ffdd8e107",
      "name": "Sticky Note5"
    },
    {
      "parameters": {
        "batchSize": 50,
        "options": {
          "reset": "={{ $json.reiniciar_bucle ? true : false }}"
        }
      },
      "type": "n8n-nodes-base.splitInBatches",
      "typeVersion": 3,
      "position": [
        96,
        -1104
      ],
      "id": "49cd6a38-8075-42db-a906-9ea348c63b5e",
      "name": "Loop Over Phases"
    },
    {
      "parameters": {
        "jsCode": "// =============================================\n// NODO: Parsear y Preparar Update (SIN quoted_value)\n// =============================================\n\n// 1. Obtener TODOS los items del LLM Chain\nconst allItems = $input.all();\nconsole.log(`📥 Procesando ${allItems.length} respuestas del LLM`);\n\n// 2. Obtener la lista de requisitos VÁLIDOS (para validar FK)\nlet validRequirements = [];\ntry {\n  const getRowsData = $('Get many rows1').all();\n  validRequirements = getRowsData.map(item => item.json.id);\n  console.log(`✅ Lista de requisitos válidos: ${validRequirements.length} items`);\n} catch(e) {\n  console.error('❌ Error obteniendo lista de requisitos válidos:', e.message);\n  return [];\n}\n\n// 3. Obtener el provider name (una sola vez, es el mismo para todos)\nlet providerName = \"OTROS\";\ntry {\n  providerName = $('Expandir por Tipo de Evaluación').first().json.proveedor_detectado || \"OTROS\";\n} catch(e) {\n  console.warn('⚠️ Error obteniendo provider, usando default:', e.message);\n}\n\n// 4. Procesar CADA respuesta del LLM\nconst resultados = [];\n\nfor (let i = 0; i < allItems.length; i++) {\n  try {\n    const item = allItems[i];\n    const itemData = item.json || item;\n\n    let rawText = itemData.text || itemData.output || \"\";\n\n    if (!rawText || typeof rawText !== 'string') {\n      console.warn(`⚠️ Item ${i}: No se encontró campo 'text' o 'output'`);\n      continue;\n    }\n\n    let cleanText = rawText\n      .replace(/```json/g, '')\n      .replace(/```/g, '')\n      .trim();\n\n    let parsedData = null;\n\n    try {\n      const start = cleanText.indexOf('[');\n      const end = cleanText.lastIndexOf(']');\n\n      if (start >= 0 && end >= 0 && end > start) {\n        const jsonString = cleanText.substring(start, end + 1);\n        parsedData = JSON.parse(jsonString);\n      } else {\n        parsedData = JSON.parse(cleanText);\n      }\n    } catch (parseError) {\n      console.error(`❌ Error parseando JSON del item ${i}:`, parseError.message);\n      console.error(`Texto recibido:`, cleanText.substring(0, 200));\n      continue;\n    }\n\n    const outputArray = Array.isArray(parsedData) ? parsedData : [parsedData];\n\n    for (let j = 0; j < outputArray.length; j++) {\n      const outputItem = outputArray[j];\n\n      if (!outputItem || typeof outputItem !== 'object') {\n        console.warn(`⚠️ Item ${i}.${j}: Elemento de salida no es objeto`);\n        continue;\n      }\n\n      const cumple = outputItem?.cumple || \"ERROR ANALISIS\";\n      const gap = outputItem?.gap_analysis || \"Check logs\";\n      const score = outputItem?.score !== undefined ? outputItem.score : 0;\n      const requirementId = outputItem?.id || null;\n\n      const validatedScore = Math.max(0, Math.min(10, parseInt(score) || 0));\n\n      if (!requirementId) {\n        console.error(`❌ Item ${i}.${j}: No se encontró ID del requisito en la respuesta del LLM`);\n        continue;\n      }\n\n      if (!validRequirements.includes(requirementId)) {\n        console.error(`❌ Item ${i}.${j}: El requirement_id ${requirementId} NO existe en rfq_items_master. Saltando...`);\n        continue;\n      }\n\n      console.log(`✅ Item ${i}.${j}: Requisito ${requirementId} - ${cumple} (${validatedScore}/10)`);\n\n      resultados.push({\n        json: {\n          requirement_id: requirementId,\n          provider_name: providerName,\n          evaluation_value: cumple,\n          comment: gap,\n          score: validatedScore\n        }\n      });\n    }\n\n  } catch (error) {\n    console.error(`❌ Error procesando item ${i}:`, error.message);\n    continue;\n  }\n}\n\nconsole.log(`✅ Procesados ${resultados.length} de ${allItems.length} items exitosamente`);\n\nreturn resultados;"
      },
      "id": "882313c3-59a3-4d49-b5d4-6e72c8b3d4aa",
      "name": "Parsear y Preparar Update",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        2048,
        -1120
      ]
    },
    {
      "parameters": {
        "promptType": "define",
        "text": "=### EVALUATION GROUP\n- Type: {{ $json.evaluation_type }}\n- Total requirements in this batch: {{ $json.total_requisitos }}\n- Batch: {{ $json.batch_index }} of {{ $json.total_batches }}\n\n### RFQ REQUIREMENTS (LIST)\nBelow is a list of RFQ requirements in JSON format. Each element includes the 'id' field and the requirement text.\n\n{{ JSON.stringify($json.requisitos, null, 2) }}\n\n### FULL PROPOSAL TEXT\n\n{{ $('Loop Over Items1').first().json.texto_oferta_completo }}\n---\n### TASK\nAnalyze the proposal and evaluate EACH requirement.\n\n### FOR ECONOMICAL EVALUATIONS - EXTRACT THE ACTUAL VALUE:\n**CRITICAL**: For economic items, the 'cumple' field must contain the ACTUAL VALUE found, not a label.\n\nFormat for 'cumple' field:\n- If value found: \"[VALUE] [CURRENCY/UNIT] - [DESCRIPTION]\"\n  Examples:\n  - \"84,3 €/h - TARIFA (Process, Mechanical, Piping)\"\n  - \"312.640,62 € - PRE-FEED TOTAL BASE QUOTATION\"\n  - \"5.231,21 € - Geotechnical survey - Confirmed\"\n  - \"732.588,83 € - FEED TOTAL BASE QUOTATION\"\n  - \"97.935 € - EPC TENDER QUOTATION\"\n\n- If NO value found: \"NO VALUE FOUND - [REASON]\"\n  Examples:\n  - \"NO VALUE FOUND - 3D model not included in proposal\"\n  - \"NO VALUE FOUND - Methodology not specified\"\n  - \"NO VALUE FOUND - OPEX not quoted\"\n  - \"NO VALUE FOUND - No price for this optional\"\n\n\n### OUTPUT FORMAT (JSON)\n[\n  {\n    \"id\": \"<requirement id>\",\n    \"cumple\": \"[For Technical: label | For Economic: VALUE or NO VALUE FOUND]\",\n    \"gap_analysis\": \"[Quote from document or 'No mention found']\"\n  }\n]\n\nJSON only, no explanations.",
        "messages": {
          "messageValues": [
            {
              "message": "=You are an expert auditor for EPC proposals.\n\nRULES:\n- For TECHNICAL: Use labels (INCLUDED, PARTIALLY INCLUDED, etc.)\n- For ECONOMICAL: Extract ACTUAL VALUES with currency/units (e.g., '312.640,62 € - PRE-FEED TOTAL'). If no value found: 'NO VALUE FOUND - [reason]'\n- Be conservative\n- ALL responses in ENGLISH\n- JSON only"
            }
          ]
        },
        "batching": {}
      },
      "type": "@n8n/n8n-nodes-langchain.chainLlm",
      "typeVersion": 1.7,
      "position": [
        1600,
        -1248
      ],
      "id": "c8201ae4-9b95-4ced-8123-4c35447f553f",
      "name": "LLM Chain"
    },
    {
      "parameters": {
        "operation": "executeQuery",
        "query": "=INSERT INTO desarrollo.document_metadata (id, title, project_id, evaluation_types, document_type, provider)\nVALUES (\n  '{{ $('Set File ID').item.json.file_id }}',\n  '{{ $('Set File ID').item.json.file_title }}',\n  '{{ $('Set File ID').item.json.project_id }}',\n  '{{ $('Set File ID').item.json.evaluation }}',\n  'PROPOSAL',\n  '{{ $('Set File ID').item.json.proveedor }}'\n)\nON CONFLICT (id) DO UPDATE SET\n  title = EXCLUDED.title,\n  project_id = EXCLUDED.project_id,\n  evaluation_types = EXCLUDED.evaluation_types,\n  document_type = EXCLUDED.document_type,\n  provider = EXCLUDED.provider\nRETURNING *",
        "options": {}
      },
      "type": "n8n-nodes-base.postgres",
      "typeVersion": 2.5,
      "position": [
        -704,
        -336
      ],
      "id": "0131db24-fbec-47ad-8796-4be5464a29c0",
      "name": "Insert Document Metadata",
      "executeOnce": true,
      "credentials": {
        "postgres": {
          "id": "V0REAPph5JBLqze3",
          "name": "Postgres account"
        }
      }
    },
    {
      "parameters": {
        "operation": "executeQuery",
        "query": "=DELETE FROM desarrollo.proposals WHERE metadata->>'file_id' LIKE '%{{ $json.file_id }}%'",
        "options": {}
      },
      "id": "fa5e8e32-8aac-479c-a3dd-3d113ac604b7",
      "name": "Delete Old Doc Rows",
      "type": "n8n-nodes-base.postgres",
      "typeVersion": 2.5,
      "position": [
        -912,
        -336
      ],
      "alwaysOutputData": true,
      "credentials": {
        "postgres": {
          "id": "V0REAPph5JBLqze3",
          "name": "Postgres account"
        }
      }
    },
    {
      "parameters": {
        "assignments": {
          "assignments": [
            {
              "id": "10646eae-ae46-4327-a4dc-9987c2d76173",
              "name": "file_id",
              "value": "={{ $json.body.file_id }}",
              "type": "string"
            },
            {
              "id": "77d782de-169d-4a46-8a8e-a3831c04d90f",
              "name": "file_title",
              "value": "={{ $json.body.file_title }}",
              "type": "string"
            },
            {
              "id": "9bde4d7f-e4f3-4ebd-9338-dce1350f9eab",
              "name": "file_url",
              "value": "={{ $json.body.file_url }}",
              "type": "string"
            },
            {
              "id": "b1dbe9b9-248a-4593-a769-a085b34e0810",
              "name": "file_binary",
              "value": "={{ $json.body.file_binary }}",
              "type": "string"
            },
            {
              "id": "74d93dce-cddc-4947-ae19-88bc5cacd146",
              "name": "file_metadata",
              "value": "={{ $json.body.metadata }}",
              "type": "string"
            },
            {
              "id": "5e43f8d4-b48e-4188-89c8-3723f184dbeb",
              "name": "proyect_name",
              "value": "={{ $json.body.metadata.proyecto }}",
              "type": "string"
            },
            {
              "id": "1093ebc6-8dd8-4c5d-b146-b6f01b069be6",
              "name": "proveedor",
              "value": "={{ $json.body.user_proveedor }}",
              "type": "string"
            },
            {
              "id": "6e0e6e2a-9b88-403e-aa0a-da0eecccd3f9",
              "name": "evaluation",
              "value": "={{ $json.body.metadata.tipoEvaluacion }}",
              "type": "array"
            },
            {
              "id": "project-id-uuid-field",
              "name": "project_id",
              "value": "={{ $json.body.project_id }}",
              "type": "string"
            }
          ]
        },
        "options": {}
      },
      "id": "3a5e62ef-87cb-4617-a58e-53054c227297",
      "name": "Set File ID",
      "type": "n8n-nodes-base.set",
      "typeVersion": 3.4,
      "position": [
        -1104,
        -336
      ]
    },
    {
      "parameters": {
        "jsonMode": "expressionData",
        "jsonData": "={{ $json.text }}",
        "options": {
          "metadata": {
            "metadataValues": [
              {
                "name": "file_id",
                "value": "={{ $json.metadata.file_id }}"
              },
              {
                "name": "file_title",
                "value": "={{ $json.metadata.file_title }}"
              },
              {
                "name": "tipo_evaluacion",
                "value": "={{ $json.metadata.tipo_evaluacion }}"
              },
              {
                "name": "proveedor",
                "value": "={{ $json.metadata.proveedor }}"
              },
              {
                "name": "project_name",
                "value": "={{ $json.metadata.project_name }}"
              },
              {
                "name": "project_id",
                "value": "={{ $json.metadata.project_id }}"
              }
            ]
          }
        }
      },
      "id": "f6959037-1a5b-4fa1-8f70-7ccfdf013ac3",
      "name": "Default Data Loader",
      "type": "@n8n/n8n-nodes-langchain.documentDefaultDataLoader",
      "typeVersion": 1,
      "position": [
        2512,
        -32
      ]
    },
    {
      "parameters": {
        "chunkSize": 1200,
        "chunkOverlap": 200,
        "options": {}
      },
      "type": "@n8n/n8n-nodes-langchain.textSplitterRecursiveCharacterTextSplitter",
      "typeVersion": 1,
      "position": [
        2416,
        144
      ],
      "id": "183e332b-4a03-4623-b151-b2b97c9d3f22",
      "name": "Recursive Character Text Splitter"
    },
    {
      "parameters": {
        "mode": "insert",
        "tableName": {
          "__rl": true,
          "value": "proposals",
          "mode": "list",
          "cachedResultName": "proposals"
        },
        "options": {
          "queryName": "match_proposals"
        }
      },
      "id": "aeb2dd72-76c8-4c4d-914a-a449f8be9691",
      "name": "Insert into Supabase Vectorstore",
      "type": "@n8n/n8n-nodes-langchain.vectorStoreSupabase",
      "typeVersion": 1,
      "position": [
        2384,
        -352
      ],
      "credentials": {
        "supabaseApi": {
          "id": "pI4CpdYLTiEEBmnz",
          "name": "Supabase account"
        }
      },
      "disabled": true
    },
    {
      "parameters": {
        "jsCode": "// =============================================\n// NODO: Validar Contenido PDF (FIX PAGINACIÓN)\n// =============================================\n\nconst input = $input.first().json;\n\n// Variables de inicialización\nlet pages = [];\nlet totalChars = 0;\nlet hasTablesDetected = false;\n\n// --- 1. PROCESAMIENTO DEL TEXTO ---\n\n// CASO A: Viene desglosado por páginas (Array)\nif (input.pages && Array.isArray(input.pages) && input.pages.length > 0) {\n  pages = input.pages;\n  pages.forEach(page => {\n    const text = page.text || page.pageContent || \"\";\n    totalChars += text.length;\n    // Detección simple de tablas\n    if ((text.match(/\\s{4,}/g) || []).length > 5) hasTablesDetected = true;\n  });\n\n// CASO B: Viene todo el texto junto (String) - ESTE ES TU CASO ACTUAL\n} else if (input.text && typeof input.text === 'string') {\n  const text = input.text;\n  totalChars = text.length;\n  // Creamos una \"página única\" contenedora para no romper el flujo\n  pages = [{ text: text, pageNumber: 1 }];\n  \n  // Detectar tablas en el texto completo\n  if ((text.match(/\\s{4,}/g) || []).length > 20) hasTablesDetected = true;\n  \n} else {\n  // CASO C: Vacío\n  pages = [];\n}\n\n// --- 2. CÁLCULO DE PÁGINAS REALES (FIX CRÍTICO) ---\n\n// Intentamos leer el metadato 'numpages' que se ve en tu captura\nlet realPageCount = input.numpages || input.numPages || input.numberOfPages || 0;\n\n// Si no existe el metadato, usamos la longitud del array (fallback)\nif (!realPageCount || realPageCount === 0) {\n    realPageCount = pages.length;\n}\n\n// Si sigue siendo 1 pero el texto es enorme (>10k chars), estimamos\nif (realPageCount <= 1 && totalChars > 10000) {\n    // Estimación conservadora: 3000 caracteres por página técnica\n    realPageCount = Math.ceil(totalChars / 3000);\n}\n\n// Evitar división por cero\nrealPageCount = Math.max(1, realPageCount);\n\n\n// --- 3. MÉTRICAS FINALES ---\n\nconst avgCharsPerPage = totalChars / realPageCount;\n\n// CRITERIO: ¿Necesita OCR?\n// Si hay texto (< 100 chars/pag) es probable que sea escaneado.\nconst needsOCR = avgCharsPerPage < 100; \n\n// Metadatos\nlet fileId = \"unknown\";\nlet fileTitle = \"unknown\";\ntry {\n  const metaNode = $('Set File ID').first().json;\n  fileId = metaNode.file_id;\n  fileTitle = metaNode.file_title;\n} catch (e) {}\n\n// --- LOGGING ---\nconsole.log(`📄 Análisis: ${fileTitle}`);\nconsole.log(`   ├─ Páginas (Metadato): ${input.numpages}`); \nconsole.log(`   ├─ Páginas (Usadas): ${realPageCount}`);\nconsole.log(`   ├─ Caracteres Totales: ${totalChars}`);\nconsole.log(`   ├─ Promedio/Pág: ${Math.round(avgCharsPerPage)}`);\n\nreturn {\n  json: {\n    // Métricas corregidas\n    totalPages: realPageCount, // Ahora dirá 235\n    totalChars: totalChars,\n    avgCharsPerPage: Math.round(avgCharsPerPage), // Ahora será un número razonable (~2800)\n    hasTables: hasTablesDetected,\n    needsOCR: needsOCR,\n    \n    // Contenido\n    pages: pages, \n    \n    // Metadatos\n    fileId: fileId,\n    fileName: fileTitle\n  }\n};"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        -32,
        -336
      ],
      "id": "de850188-4780-47a4-8600-a1a6ce39bd75",
      "name": "Validar Contenido PDF"
    },
    {
      "parameters": {
        "operation": "pdf",
        "options": {}
      },
      "type": "n8n-nodes-base.extractFromFile",
      "typeVersion": 1.1,
      "position": [
        -304,
        -336
      ],
      "id": "eb9bb904-f2a0-4d2a-9f07-e66413de9c46",
      "name": "Extract from File"
    },
    {
      "parameters": {
        "conditions": {
          "options": {
            "caseSensitive": true,
            "leftValue": "",
            "typeValidation": "strict",
            "version": 3
          },
          "conditions": [
            {
              "id": "57b9c551-9997-4ed5-8ddd-f80c108a177c",
              "leftValue": "={{ $json.needsOCR }}",
              "rightValue": "",
              "operator": {
                "type": "boolean",
                "operation": "true",
                "singleValue": true
              }
            }
          ],
          "combinator": "and"
        },
        "options": {}
      },
      "type": "n8n-nodes-base.if",
      "typeVersion": 2.3,
      "position": [
        256,
        -336
      ],
      "id": "c239e9a9-2346-4419-8c97-a2e712d36f42",
      "name": "¿Necesita OCR?"
    },
    {
      "parameters": {
        "jsCode": "// =============================================\n// NODO: Aggregate OCR Pages (CORREGIDO)\n// =============================================\n\nconst items = $input.all();\nlet fullText = \"\";\nlet pagesArray = [];\n\n// OPCIÓN A: Si Tesseract devuelve múltiples items (1 por página)\nif (items.length > 1) {\n  items.forEach((item, idx) => {\n    const pageText = item.json.text || \"\";\n    fullText += pageText + \"\\n\\n\";\n    \n    // Construimos array compatible con vectorstore\n    pagesArray.push({\n      text: pageText,\n      pageNumber: idx + 1\n    });\n  });\n}\n// OPCIÓN B: Si Tesseract devuelve un solo item con todo el texto\nelse if (items.length === 1) {\n  fullText = items[0].json.text || \"\";\n  pagesArray = [{\n    text: fullText,\n    pageNumber: 1\n  }];\n}\n\n// RECUPERAR METADATOS ORIGINALES (CRÍTICO)\nlet fileId, fileName, proveedor;\ntry {\n  fileId = $('Set File ID').first().json.file_id;\n  fileName = $('Set File ID').first().json.file_title;\n  proveedor = $('Set File ID').first().json.proveedor || \"OTROS\";\n} catch (e) {\n  console.error(\"⚠️ No se pudieron recuperar metadatos:\", e.message);\n  fileId = \"unknown\";\n  fileName = \"unknown\";\n  proveedor = \"OTROS\";\n}\n\nconsole.log(`🔄 OCR Agregado: ${items.length} páginas → ${fullText.length} caracteres`);\n\n// ESTRUCTURA COMPATIBLE CON VECTORSTORE\nreturn {\n  json: {\n    pages: pagesArray, // ← Array de páginas (requerido por Default Data Loader)\n    text: fullText, // ← Texto completo (backup)\n    \n    // Metadatos críticos\n    file_id: fileId,\n    file_title: fileName,\n    proveedor: proveedor,\n    \n    // Marca de origen\n    origen_datos: \"OCR_TESSERACT\",\n    ocr_pages_processed: items.length,\n    ocr_total_chars: fullText.length\n  }\n};"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        896,
        -448
      ],
      "id": "eb4f4533-e34a-4e43-b968-91c018b8473b",
      "name": "Aggregate OCR Pages"
    },
    {
      "parameters": {
        "jsCode": "// =============================================\n// NODO: Preparar Texto de Muestra (STRICT LIMIT)\n// =============================================\n\nconst items = $input.all();\n\nreturn items.map(item => {\n    let texto_muestra = \"SIN TEXTO\";\n\n    try {\n        if (item.json.pages && Array.isArray(item.json.pages) && item.json.pages.length > 0) {\n            // Unimos las 2 primeras páginas pero limitamos el total a 3000 caracteres\n            let rawJoin = item.json.pages.slice(0, 2).map(p => p.text || \"\").join(\"\\n\\n\");\n            texto_muestra = rawJoin.substring(0, 3000);\n        } else {\n            // Fallback extremadamente corto para texto plano\n            texto_muestra = (item.json.text || \"\").substring(0, 500);\n        }\n    } catch (e) {\n        console.error(\"Error al procesar páginas:\", e);\n    }\n\n    return {\n        json: {\n            ...item.json,\n            texto_muestra: texto_muestra\n        }\n    };\n});"
      },
      "id": "529e243f-05e8-4a67-9344-66e323e62315",
      "name": "Preparar Texto de Muestra",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        1344,
        -336
      ]
    },
    {
      "parameters": {
        "jsCode": "// =============================================\n// NODO: Format for Vectorstore (v3 - DIRECTO DEL USUARIO)\n// SIN clasificador ni validador LLM\n// =============================================\n\n// 1. RECUPERAR CONTENIDO\nlet fullText = \"\";\nlet totalPages = 1;\n\ntry {\n    const mergeData = $('Merge1').first().json;\n    if (mergeData.pages && mergeData.pages[0]) {\n        fullText = mergeData.pages.slice(0, 2).map(p => p.text || \"\").join(\"\\n\\n\");\n    } else {\n        fullText = mergeData.text || \"\";\n    }\n    totalPages = mergeData.totalPages || 1;\n} catch (e) {\n    console.log(\"❌ Error leyendo de Merge1\");\n}\n\n// 2. USAR DIRECTAMENTE DATOS DEL USUARIO (Set File ID)\nlet fileId = \"unknown\";\nlet fileTitle = \"unknown\";\nlet proveedor = \"OTROS\";\nlet tipoEval = [\"Technical Evaluation\"];\nlet proyecto = \"\";\nlet projectId = null;\n\ntry {\n    const fileNode = $('Set File ID').first().json;\n    fileId = fileNode.file_id || \"unknown\";\n    fileTitle = fileNode.file_title || \"unknown\";\n    proveedor = fileNode.proveedor || \"OTROS\";\n    proyecto = fileNode.proyect_name || \"\";\n    projectId = fileNode.project_id || null;\n    \n    if (fileNode.evaluation && Array.isArray(fileNode.evaluation) && fileNode.evaluation.length > 0) {\n        tipoEval = fileNode.evaluation;\n    } else if (fileNode.evaluation && typeof fileNode.evaluation === 'string') {\n        tipoEval = [fileNode.evaluation];\n    }\n} catch(e) {\n    console.log(\"❌ Error leyendo Set File ID\");\n}\n\n// 3. GENERAR SALIDA\nreturn {\n    json: {\n        text: fullText,\n        metadata: {\n            file_id: fileId,\n            file_title: fileTitle,\n            proveedor: proveedor,\n            tipo_evaluacion: tipoEval,\n            project_name: proyecto,\n            project_id: projectId,\n            processed_at: new Date().toISOString(),\n            total_pages: totalPages\n        }\n    }\n};"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        2208,
        -352
      ],
      "id": "55afcab0-b2e1-4f2f-b266-6abe6cda008d",
      "name": "Format for Vectorstore"
    },
    {
      "parameters": {
        "jsCode": "// =============================================\n// NODO: Expandir por Tipo de Evaluación (v3 - DIRECTO DEL USUARIO)\n// SIN clasificador ni validador LLM - usa datos del usuario directamente\n// =============================================\n\n// 1. RECUPERAR TEXTO Y CONTENIDO BASE\nlet fullText = \"\";\nlet totalPages = 1;\ntry {\n    const mergeData = $('Merge1').first().json;\n    fullText = (mergeData.pages && mergeData.pages[0]) \n        ? mergeData.pages.slice(0, 2).map(p => p.text || \"\").join(\"\\n\\n\") \n        : (mergeData.text || \"\");\n    totalPages = mergeData.totalPages || 1;\n} catch (e) {\n    console.error(\"❌ Error leyendo Merge1\");\n}\n\n// 2. USAR DIRECTAMENTE DATOS DEL USUARIO (Set File ID)\nlet fileId = \"unknown\";\nlet proveedor = \"OTROS\";\nlet tipoEval = [\"Technical Evaluation\"];\nlet projectName = \"proyecto_sin_especificar\";\n\ntry {\n    const fileData = $('Set File ID').first().json;\n    fileId = fileData.file_id || \"unknown\";\n    proveedor = fileData.proveedor || \"OTROS\";\n    projectName = fileData.proyect_name || \"proyecto_sin_especificar\";\n    \n    // Tipos de evaluación del usuario\n    if (fileData.evaluation && Array.isArray(fileData.evaluation) && fileData.evaluation.length > 0) {\n        tipoEval = fileData.evaluation;\n    } else if (fileData.evaluation && typeof fileData.evaluation === 'string') {\n        tipoEval = [fileData.evaluation];\n    }\n    \n    console.log(`✅ Usando datos del usuario directamente:`);\n    console.log(`   Proveedor: ${proveedor}`);\n    console.log(`   Proyecto: ${projectName}`);\n    console.log(`   Tipos: ${JSON.stringify(tipoEval)}`);\n} catch (e) {\n    console.error(\"❌ Error leyendo Set File ID:\", e.message);\n}\n\n// 3. NORMALIZAR TIPOS\nif (!Array.isArray(tipoEval)) tipoEval = [tipoEval];\ntipoEval = tipoEval.filter(t => t && t.trim() !== \"\");\nif (tipoEval.length === 0) tipoEval = [\"Technical Evaluation\"];\n\n// 4. GENERAR FILAS\nreturn tipoEval.map((tipo, idx) => ({\n    json: {\n        tipo_evaluacion_actual: tipo,\n        proveedor_detectado: proveedor,\n        proyecto_nombre: projectName,\n        texto_oferta_completo: fullText,\n        indice_actual: idx + 1,\n        total_tipos: tipoEval.length,\n        file_id: fileId\n    }\n}));"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        -1456,
        -1040
      ],
      "id": "c76df1d9-23e5-431b-98e9-ab20002f86f2",
      "name": "Expandir por Tipo de Evaluación"
    },
    {
      "parameters": {
        "options": {}
      },
      "type": "n8n-nodes-base.splitInBatches",
      "typeVersion": 3,
      "position": [
        -1152,
        -1120
      ],
      "id": "382a30fa-79a7-40a2-9aff-11339e724193",
      "name": "Loop Over Items1"
    },
    {
      "parameters": {
        "method": "POST",
        "url": "https://unlaconic-ardelle-pretenceful.ngrok-free.dev/v1/convert/file",
        "sendBody": true,
        "contentType": "multipart-form-data",
        "bodyParameters": {
          "parameters": [
            {
              "parameterType": "formBinaryData",
              "name": "files",
              "inputDataFieldName": "data"
            }
          ]
        },
        "options": {
          "timeout": 300000
        }
      },
      "id": "a5b17895-71c4-4a41-b435-03e527a377bd",
      "name": "Docling OCR",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.3,
      "position": [
        688,
        -544
      ],
      "retryOnFail": true
    },
    {
      "parameters": {
        "schemaType": "manual",
        "inputSchema": "{\n  \"type\": \"object\",\n  \"properties\": {\n    \"proveedor_detectado\": {\n      \"type\": \"string\",\n      \"description\": \"Nombre de la empresa proveedora (Ej: SACYR, IDOM, etc.)\"\n    },\n    \"tipos_detectados\": {\n      \"type\": \"array\",\n      \"items\": {\n        \"type\": \"string\",\n        \"enum\": [\n          \"Technical Evaluation\",\n          \"Economical Evaluation\",\n          \"Others\"\n        ]\n      },\n      \"description\": \"Lista de tipos de oferta detectados en el documento.\"\n    },\n    \"razonamiento\": {\n      \"type\": \"string\",\n      \"description\": \"Breve explicación de por qué se eligieron esos tipos.\"\n    }\n  },\n  \"required\": [\n    \"proveedor_detectado\",\n    \"tipos_detectados\"\n  ]\n}"
      },
      "type": "@n8n/n8n-nodes-langchain.outputParserStructured",
      "typeVersion": 1.3,
      "position": [
        2000,
        112
      ],
      "id": "bf5714af-1139-44f1-997c-d0ecaa96db34",
      "name": "Structured Output Parser"
    },
    {
      "parameters": {},
      "type": "n8n-nodes-base.merge",
      "typeVersion": 3.2,
      "position": [
        1152,
        -336
      ],
      "id": "691359f8-c4bc-4b94-bfe5-842cb7236e6f",
      "name": "Merge1"
    },
    {
      "parameters": {
        "jsCode": "const items = $input.all();\n\nreturn items.map(item => ({\n    json: {\n        ...item.json, // Mantiene todos los datos originales (incluido tipo_evaluacion)\n        \n        // Aquí está la corrección: Usamos dos puntos, no el igual.\n        reiniciar_bucle: true \n    }\n}));\n"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        -144,
        -1168
      ],
      "id": "97dae99b-85e2-4e7f-b771-77c9fe737595",
      "name": "Reset Items"
    },
    {
      "parameters": {
        "respondWith": "allIncomingItems",
        "options": {}
      },
      "type": "n8n-nodes-base.respondToWebhook",
      "typeVersion": 1.5,
      "position": [
        -704,
        -1392
      ],
      "id": "bffc0b79-749b-4689-88d8-1c232d8c7728",
      "name": "Respond to Webhook"
    },
    {
      "parameters": {
        "httpMethod": "POST",
        "path": "ofertas-desarrollo",
        "responseMode": "responseNode",
        "options": {}
      },
      "type": "n8n-nodes-base.webhook",
      "typeVersion": 2.1,
      "position": [
        -1536,
        -336
      ],
      "id": "e0033552-d5c7-4cd2-a588-ca63551d98fa",
      "name": "Webhook",
      "webhookId": "54339356-4e6d-4e22-9820-6e1e98e167a8"
    },
    {
      "parameters": {
        "jsCode": "// =============================================\n// NODO: Convertir Base64 a Binary Data (CORREGIDO v3)\n// =============================================\n\n// LEER DIRECTAMENTE DEL NODO \"Set File ID\"\nlet inputData;\ntry {\n    inputData = $('Set File ID').first().json;\n} catch (e) {\n    throw new Error(\"❌ No se puede acceder al nodo 'Set File ID'\");\n}\n\nconst base64Data = inputData.file_binary;\n\n// --- VALIDACIÓN CRÍTICA ---\nif (!base64Data || base64Data === \"\") {\n    console.error(\"❌ ERROR: file_binary está vacío\");\n    console.error(\"Datos en 'Set File ID':\", Object.keys(inputData));\n    console.error(\"file_id:\", inputData.file_id);\n    console.error(\"file_title:\", inputData.file_title);\n    \n    throw new Error(\n        \"❌ CRÍTICO: 'file_binary' no existe en 'Set File ID'. \" +\n        \"Verifica la configuración del nodo.\"\n    );\n}\n\n// Validar que sea string\nif (typeof base64Data !== 'string') {\n    throw new Error(`❌ ERROR: 'file_binary' debe ser string, es ${typeof base64Data}`);\n}\n\n// Logging\nconsole.log(\"✅ file_binary recibido de 'Set File ID'\");\nconsole.log(`   ├─ Longitud: ${base64Data.length} caracteres`);\nconsole.log(`   ├─ Archivo: ${inputData.file_title}`);\n\n// Convertir base64 a binary\nlet binaryData;\ntry {\n    binaryData = Buffer.from(base64Data, 'base64');\n} catch (e) {\n    throw new Error(`❌ ERROR decodificando base64: ${e.message}`);\n}\n\n// Validar tamaño\nif (binaryData.length === 0) {\n    throw new Error(\"❌ ERROR: Archivo decodificado vacío (0 bytes)\");\n}\n\nconsole.log(`✅ Binary generado: ${binaryData.length} bytes`);\n\n// Retornar formato n8n\nreturn {\n    json: {\n        file_id: inputData.file_id,\n        file_title: inputData.file_title,\n        file_url: inputData.file_url || \"unknown\"\n    },\n    binary: {\n        data: {\n            data: binaryData.toString('base64'),\n            mimeType: 'application/pdf',\n            fileName: inputData.file_title || 'document.pdf',\n            fileSize: binaryData.length\n        }\n    }\n};"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        -528,
        -336
      ],
      "id": "edb1d7c3-22ab-42fd-8a5e-976a459b2aa1",
      "name": "Base64 a Binary"
    },
    {
      "parameters": {
        "jsCode": "// =============================================\n// NODO: Convertir Base64 a Binary Data (CORREGIDO v3)\n// =============================================\n\n// LEER DIRECTAMENTE DEL NODO \"Set File ID\"\nlet inputData;\ntry {\n    inputData = $('Set File ID').first().json;\n} catch (e) {\n    throw new Error(\"❌ No se puede acceder al nodo 'Set File ID'\");\n}\n\nconst base64Data = inputData.file_binary;\n\n// --- VALIDACIÓN CRÍTICA ---\nif (!base64Data || base64Data === \"\") {\n    console.error(\"❌ ERROR: file_binary está vacío\");\n    console.error(\"Datos en 'Set File ID':\", Object.keys(inputData));\n    console.error(\"file_id:\", inputData.file_id);\n    console.error(\"file_title:\", inputData.file_title);\n    \n    throw new Error(\n        \"❌ CRÍTICO: 'file_binary' no existe en 'Set File ID'. \" +\n        \"Verifica la configuración del nodo.\"\n    );\n}\n\n// Validar que sea string\nif (typeof base64Data !== 'string') {\n    throw new Error(`❌ ERROR: 'file_binary' debe ser string, es ${typeof base64Data}`);\n}\n\n// Logging\nconsole.log(\"✅ file_binary recibido de 'Set File ID'\");\nconsole.log(`   ├─ Longitud: ${base64Data.length} caracteres`);\nconsole.log(`   ├─ Archivo: ${inputData.file_title}`);\n\n// Convertir base64 a binary\nlet binaryData;\ntry {\n    binaryData = Buffer.from(base64Data, 'base64');\n} catch (e) {\n    throw new Error(`❌ ERROR decodificando base64: ${e.message}`);\n}\n\n// Validar tamaño\nif (binaryData.length === 0) {\n    throw new Error(\"❌ ERROR: Archivo decodificado vacío (0 bytes)\");\n}\n\nconsole.log(`✅ Binary generado: ${binaryData.length} bytes`);\n\n// Retornar formato n8n\nreturn {\n    json: {\n        file_id: inputData.file_id,\n        file_title: inputData.file_title,\n        file_url: inputData.file_url || \"unknown\"\n    },\n    binary: {\n        data: {\n            data: binaryData.toString('base64'),\n            mimeType: 'application/pdf',\n            fileName: inputData.file_title || 'document.pdf',\n            fileSize: binaryData.length\n        }\n    }\n};"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        480,
        -448
      ],
      "id": "71f40834-834f-4ae4-ad62-acf2a829a31d",
      "name": "Base64 a Binary1"
    },
    {
      "parameters": {
        "jsCode": "// =============================================\n// NODO: Generate Stable ID + Detectar Modo (NOMBRES CORRECTOS)\n// =============================================\n\nfunction simpleHash(str) {\n  let hash = 0;\n  for (let i = 0; i < str.length; i++) {\n    const char = str.charCodeAt(i);\n    hash = ((hash << 5) - hash) + char;\n    hash = hash & hash;\n  }\n  return Math.abs(hash).toString(16).padStart(16, '0').substring(0, 16);\n}\n\nconst body = $json.body;\n\n// CAMPOS EXISTENTES\nconst originalFileId = body.file_id || \"unknown\";\nconst fileTitle = body.file_title || \"unknown.pdf\";\nconst fileBinary = body.file_binary || \"\";\nconst fileUrl = body.file_url || \"unknown\";\n\n// ✅ EXTRAER METADATA DEL USUARIO (NOMBRES CORRECTOS)\nconst metadata = body.metadata || {};\nconst rfqProjectId = metadata.proyect_name || null;        // ← proyect_name\nconst userProveedor = metadata.proveedor || null;          // ← proveedor\nconst userTipoEval = metadata.evaluation || null;          // ← evaluation (Array)\n\n// ✅ DETERMINAR MODO DE OPERACIÓN\nlet modoOperacion = \"CLASIFICADOR\"; // Por defecto\nlet datosCompletos = false;\n\n// Verificar si tiene datos suficientes para VALIDACIÓN\nif (userProveedor && userTipoEval && Array.isArray(userTipoEval) && userTipoEval.length > 0) {\n    modoOperacion = \"VALIDADOR\";\n    datosCompletos = true;\n} else if (userProveedor || (userTipoEval && Array.isArray(userTipoEval) && userTipoEval.length > 0)) {\n    modoOperacion = \"HIBRIDO\"; // Tiene algunos datos pero no todos\n}\n\n// Generar ID estable del archivo (incluye project_id para evitar colisiones entre proyectos)\nconst projectId = body.project_id || metadata.project_id || '';\nconst normalizedTitle = fileTitle.toLowerCase().trim();\nconst stableId = simpleHash(normalizedTitle + '_' + projectId);\n\n// LOGGING\nconsole.log(\"=== ANÁLISIS DE METADATA ===\");\nconsole.log(`Modo Operación: ${modoOperacion}`);\nconsole.log(`RFQ Project Name: ${rfqProjectId || 'No especificado'}`);\nconsole.log(`Proveedor (Usuario): ${userProveedor || 'No especificado'}`);\nconsole.log(`Evaluation (Usuario): ${JSON.stringify(userTipoEval) || 'No especificado'}`);\nconsole.log(`Datos Completos: ${datosCompletos}`);\nconsole.log(`Original ID: ${originalFileId}`);\nconsole.log(`Nombre archivo: ${fileTitle}`);\nconsole.log(`ID ESTABLE generado: ${stableId}`);\n\n// RETORNO\nreturn {\n  json: {\n    // Datos directos en raíz\n    file_id: stableId,\n    file_id_original: originalFileId,\n    file_title: fileTitle,\n    file_binary: fileBinary,\n    file_url: fileUrl,\n    \n    rfq_project_id: rfqProjectId || \"proyecto_sin_especificar\",\n    user_proveedor: userProveedor,\n    user_tipo_evaluacion: userTipoEval,\n    modo_operacion: modoOperacion,\n    datos_usuario_completos: datosCompletos,\n    \n    // Mantener body completo\n    body: {\n      ...body,\n      file_id: stableId,\n      file_id_original: originalFileId,\n      rfq_project_id: rfqProjectId || \"proyecto_sin_especificar\",\n      user_proveedor: userProveedor,\n      user_tipo_evaluacion: userTipoEval,\n      modo_operacion: modoOperacion,\n      datos_usuario_completos: datosCompletos\n    }\n  }\n};"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        -1296,
        -336
      ],
      "id": "d2467eb6-a053-4b36-8233-7bf53a7d36be",
      "name": "Code in JavaScript1"
    },
    {
      "parameters": {
        "operation": "executeQuery",
        "query": "=INSERT INTO desarrollo.provider_responses (provider_name, evaluation_value, comment, requirement_id, file_id, project_id, updated_at)\nVALUES (\n  '{{ $json.provider_name }}',\n  '{{ $json.evaluation_value }}',\n  '{{ $json.comment }}',\n  '{{ $json.requirement_id }}',\n  '{{ $('Set File ID').first().json.file_id }}',\n  '{{ $('Set File ID').first().json.project_id }}',\n  '{{ $now }}'\n)\nON CONFLICT (requirement_id, provider_name, file_id) DO UPDATE SET\n  evaluation_value = EXCLUDED.evaluation_value,\n  comment = EXCLUDED.comment,\n  project_id = EXCLUDED.project_id,\n  updated_at = EXCLUDED.updated_at\nRETURNING *",
        "options": {}
      },
      "type": "n8n-nodes-base.postgres",
      "typeVersion": 2.5,
      "position": [
        2560,
        -896
      ],
      "id": "3053655c-02f4-4ccd-bf3d-574d8b4b4bdb",
      "name": "Insert or update rows in a table",
      "credentials": {
        "postgres": {
          "id": "V0REAPph5JBLqze3",
          "name": "Postgres account"
        }
      }
    },
    {
      "parameters": {
        "jsCode": "// =============================================\n// NODO: Preparar Todo para LLM (SIN RAG, SIN FASES)\n// Pasa TODOS los requisitos directamente al LLM\n// =============================================\n\nconst items = $input.all();\n\nconsole.log('📥 Requisitos recibidos:', items.length);\n\n// Obtener texto completo de la oferta desde Loop Over Items1\nlet textoOfertaCompleto = \"\";\nlet evaluationType = \"Technical Evaluation\";\n\ntry {\n    const loopData = $('Loop Over Items1').first().json;\n    textoOfertaCompleto = loopData.texto_oferta_completo || \"\";\n    evaluationType = loopData.tipo_evaluacion_actual || \"Technical Evaluation\";\n    console.log('✅ Datos obtenidos de Loop Over Items1');\n    console.log('   ├─ Tipo evaluación:', evaluationType);\n    console.log('   └─ Texto oferta:', textoOfertaCompleto.length, 'chars');\n} catch(e) {\n    console.warn('⚠️ No se pudo obtener texto de oferta de Loop Over Items1:', e.message);\n    // Fallback: intentar obtener de otro lugar\n    try {\n        const expandirData = $('Expandir por Tipo de Evaluación').first().json;\n        textoOfertaCompleto = expandirData.texto_oferta_completo || \"\";\n        evaluationType = expandirData.tipo_evaluacion_actual || \"Technical Evaluation\";\n        console.log('✅ Fallback: Datos obtenidos de Expandir por Tipo de Evaluación');\n    } catch(e2) {\n        console.error('❌ No se pudo obtener texto de ningún nodo');\n    }\n}\n\n// Formatear TODOS los requisitos (sin batching)\nconst todosLosRequisitos = items.map(item => ({\n    id: item.json.id || \"\",\n    requirement_text: item.json.requirement_text || item.json.text || \"NO ESPECIFICADO\",\n    evaluation_type: item.json.evaluation_type || evaluationType\n}));\n\nconsole.log('📋 Preparación directa (sin RAG ni fases):');\nconsole.log('   ├─ Total requisitos:', todosLosRequisitos.length);\nconsole.log('   ├─ Tipo evaluación:', evaluationType);\nconsole.log('   └─ Tamaño texto oferta:', textoOfertaCompleto.length, 'chars');\n\n// Retornar UN SOLO item con TODOS los requisitos\nreturn [{\n    json: {\n        evaluation_type: evaluationType,\n        requisitos: todosLosRequisitos,\n        total_requisitos: todosLosRequisitos.length,\n        batch_index: 1,\n        total_batches: 1,\n        context: textoOfertaCompleto,\n        texto_length: textoOfertaCompleto.length\n    }\n}];"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        608,
        -1248
      ],
      "id": "bdde0f15-bae6-4e13-bc2a-79042e51ba1c",
      "name": "Preparar Todo para LLM1"
    },
    {
      "parameters": {
        "model": "mistral-large-latest",
        "options": {}
      },
      "type": "@n8n/n8n-nodes-langchain.lmChatMistralCloud",
      "typeVersion": 1,
      "position": [
        1536,
        -1040
      ],
      "id": "bfe8b33f-e57a-4022-baef-089246ffb7bb",
      "name": "Mistral Cloud Chat Model3",
      "credentials": {
        "mistralCloudApi": {
          "id": "tDjuOnF6lpADMmd5",
          "name": "Mistral Cloud account"
        }
      }
    },
    {
      "parameters": {
        "model": "ministral-14b-latest",
        "options": {}
      },
      "type": "@n8n/n8n-nodes-langchain.lmChatMistralCloud",
      "typeVersion": 1,
      "position": [
        1792,
        -224
      ],
      "id": "1fc9ba61-b2c3-40ea-80f0-f331d6cc1d85",
      "name": "Mistral Cloud Chat Model5",
      "credentials": {
        "mistralCloudApi": {
          "id": "tDjuOnF6lpADMmd5",
          "name": "Mistral Cloud account"
        }
      }
    },
    {
      "parameters": {
        "model": "ministral-14b-latest",
        "options": {}
      },
      "type": "@n8n/n8n-nodes-langchain.lmChatMistralCloud",
      "typeVersion": 1,
      "position": [
        1872,
        112
      ],
      "id": "f64267e1-05fb-4e20-94cb-7cfde69968cd",
      "name": "Mistral Cloud Chat Model6",
      "credentials": {
        "mistralCloudApi": {
          "id": "tDjuOnF6lpADMmd5",
          "name": "Mistral Cloud account"
        }
      }
    },
    {
      "parameters": {
        "operation": "executeQuery",
        "query": "=SELECT * FROM desarrollo.projects WHERE id = '={{ $('Edit Fields').first().json.project_id }}' LIMIT 1",
        "options": {}
      },
      "id": "50dc003e-f1cc-4a9d-8f92-6e192b494b6b",
      "name": "Fetch Project Context Email",
      "type": "n8n-nodes-base.postgres",
      "typeVersion": 2.5,
      "position": [
        -3072,
        -112
      ],
      "credentials": {
        "postgres": {
          "id": "V0REAPph5JBLqze3",
          "name": "Postgres account"
        }
      }
    },
    {
      "parameters": {
        "operation": "executeQuery",
        "query": "=SELECT * FROM desarrollo.projects WHERE id = '={{ $('Set Input Params').first().json.project_id }}' LIMIT 1",
        "options": {}
      },
      "id": "31f0ea77-5fc6-4eea-8248-1d15ee8ff575",
      "name": "Fetch Project Context QA",
      "type": "n8n-nodes-base.postgres",
      "typeVersion": 2.5,
      "position": [
        -5568,
        -656
      ],
      "credentials": {
        "postgres": {
          "id": "V0REAPph5JBLqze3",
          "name": "Postgres account"
        }
      }
    },
    {
      "parameters": {
        "operation": "executeQuery",
        "query": "=SELECT * FROM desarrollo.projects WHERE id = '={{ $('Set Input Params1').first().json.project_id }}' LIMIT 1",
        "options": {}
      },
      "id": "4e637b4a-b297-466d-a596-5937216cbdbf",
      "name": "Fetch Project Context Scoring",
      "type": "n8n-nodes-base.postgres",
      "typeVersion": 2.5,
      "position": [
        -6192,
        512
      ],
      "credentials": {
        "postgres": {
          "id": "V0REAPph5JBLqze3",
          "name": "Postgres account"
        }
      }
    },
    {
      "parameters": {
        "content": "## /tabla - Provider Responses Table\n\nReturns all provider_responses for a given project_id.\n\n**Method**: GET\n**Query params**: project_id (required)\n\n**Flow**: Webhook → Set Fields → Supabase getAll → Respond",
        "height": 320,
        "width": 1280,
        "color": 4
      },
      "type": "n8n-nodes-base.stickyNote",
      "typeVersion": 1,
      "position": [
        2880,
        2480
      ],
      "id": "3fd4d27b-7dda-4a8f-b93e-c95622db17f9",
      "name": "Sticky Note Tabla"
    },
    {
      "parameters": {
        "path": "tabla-desarrollo",
        "responseMode": "responseNode",
        "options": {}
      },
      "type": "n8n-nodes-base.webhook",
      "typeVersion": 2.1,
      "position": [
        2960,
        2640
      ],
      "id": "4dbfb8d7-4e9d-4bf4-9d56-36f1192b4971",
      "name": "Webhook Tabla",
      "webhookId": "tabla-webhook-001"
    },
    {
      "parameters": {
        "assignments": {
          "assignments": [
            {
              "id": "tabla-project-id",
              "name": "project_id",
              "value": "={{ $json.query.project_id || '' }}",
              "type": "string"
            }
          ]
        },
        "options": {}
      },
      "type": "n8n-nodes-base.set",
      "typeVersion": 3.4,
      "position": [
        3168,
        2640
      ],
      "id": "463a7500-1a41-4ac4-80ea-8321403b0e6e",
      "name": "Set Tabla Params"
    },
    {
      "parameters": {
        "operation": "executeQuery",
        "query": "=SELECT * FROM desarrollo.provider_responses WHERE project_id = '={{ $json.project_id }}'",
        "options": {}
      },
      "type": "n8n-nodes-base.postgres",
      "typeVersion": 2.5,
      "position": [
        3360,
        2640
      ],
      "id": "4d705f89-21e3-4568-9dfd-d749ae99a685",
      "name": "Supabase Get Tabla",
      "alwaysOutputData": true,
      "credentials": {
        "postgres": {
          "id": "V0REAPph5JBLqze3",
          "name": "Postgres account"
        }
      }
    },
    {
      "parameters": {
        "respondWith": "allIncomingItems",
        "options": {}
      },
      "type": "n8n-nodes-base.respondToWebhook",
      "typeVersion": 1.5,
      "position": [
        3568,
        2640
      ],
      "id": "423d463c-7720-441c-ba68-20d3403b2b8c",
      "name": "Respond Tabla"
    },
    {
      "parameters": {
        "content": "## /qa-process-email-response - AI Email Response Mapper\n\nProcesses supplier email responses and maps them to original Q&A questions using AI.\n\n**Method**: POST\n**Body**: { project_id, provider_name, email_content }\n\n**Flow**: Webhook → Set Fields → Fetch Q&A Questions → Build AI Context → LLM Chain → Parse Output → Respond\n\n**Returns**: { success, processed_count, mappings: [{ question_id, question_text, response_text, confidence, matched }] }",
        "height": 400,
        "width": 2400,
        "color": 7
      },
      "type": "n8n-nodes-base.stickyNote",
      "typeVersion": 1,
      "position": [
        2880,
        2784
      ],
      "id": "5b2f7fe4-ce58-4bd6-a627-d71286dfb70f",
      "name": "Sticky Note QA Email"
    },
    {
      "parameters": {
        "httpMethod": "POST",
        "path": "qa-process-email-response-desarrollo",
        "responseMode": "responseNode",
        "options": {}
      },
      "type": "n8n-nodes-base.webhook",
      "typeVersion": 2.1,
      "position": [
        2960,
        3040
      ],
      "id": "d7a8ba69-03ed-4ba6-90b6-900ff061a03e",
      "name": "Webhook QA Email Response",
      "webhookId": "qa-email-response-webhook-001"
    },
    {
      "parameters": {
        "assignments": {
          "assignments": [
            {
              "id": "qa-email-project-id",
              "name": "project_id",
              "value": "={{ $json.body.project_id }}",
              "type": "string"
            },
            {
              "id": "qa-email-provider",
              "name": "provider_name",
              "value": "={{ $json.body.provider_name }}",
              "type": "string"
            },
            {
              "id": "qa-email-content",
              "name": "email_content",
              "value": "={{ $json.body.email_content }}",
              "type": "string"
            }
          ]
        },
        "options": {}
      },
      "type": "n8n-nodes-base.set",
      "typeVersion": 3.4,
      "position": [
        3168,
        3040
      ],
      "id": "2e0d5f7d-963c-4ce9-a0d3-2e0a91d8f07b",
      "name": "Set QA Email Params"
    },
    {
      "parameters": {
        "operation": "executeQuery",
        "query": "=SELECT * FROM desarrollo.qa_audit WHERE project_id = '={{ $json.project_id }}' AND provider_name = '={{ $json.provider_name }}'",
        "options": {}
      },
      "type": "n8n-nodes-base.postgres",
      "typeVersion": 2.5,
      "position": [
        3360,
        3040
      ],
      "id": "abf2f031-97f2-4412-8a41-0405ab9cd59f",
      "name": "Fetch QA Questions",
      "alwaysOutputData": true,
      "credentials": {
        "postgres": {
          "id": "V0REAPph5JBLqze3",
          "name": "Postgres account"
        }
      }
    },
    {
      "parameters": {
        "jsCode": "// Build context for LLM: combine Q&A questions with email content\nconst questions = $('Fetch QA Questions').all();\nconst params = $('Set QA Email Params').first().json;\n\nconst questionList = questions.map(q => ({\n  id: q.json.id,\n  question: q.json.question,\n  discipline: q.json.discipline,\n  importance: q.json.importance,\n  status: q.json.status\n}));\n\nconsole.log(`📧 Processing email response:`);\nconsole.log(`   ├─ Provider: ${params.provider_name}`);\nconsole.log(`   ├─ Questions found: ${questionList.length}`);\nconsole.log(`   └─ Email length: ${(params.email_content || '').length} chars`);\n\nreturn [{\n  json: {\n    project_id: params.project_id,\n    provider_name: params.provider_name,\n    email_content: params.email_content,\n    questions: questionList,\n    total_questions: questionList.length\n  }\n}];"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        3568,
        3040
      ],
      "id": "784e84ef-f3ee-40c8-b979-b314bf6856f2",
      "name": "Build AI Context"
    },
    {
      "parameters": {
        "promptType": "define",
        "text": "=### INPUT\n\n## PROVIDER: {{ $json.provider_name }}\n\n## ORIGINAL QUESTIONS ({{ $json.total_questions }} items):\n{{ JSON.stringify($json.questions, null, 2) }}\n\n## SUPPLIER EMAIL RESPONSE:\n{{ $json.email_content }}\n\n### INSTRUCTIONS\nAnalyze the supplier's email response and map each answer to its most likely original question.\nFor each mapping, provide a confidence score (0.0 to 1.0) indicating how certain you are of the match.\nIf a question has no corresponding answer in the email, set matched=false and response_text to empty string.\n\nReturn ONLY the JSON object. Do NOT include any text before or after the JSON.\n\n### OUTPUT SCHEMA\n{\n  \"success\": true,\n  \"processed_count\": <number of matched responses>,\n  \"mappings\": [\n    {\n      \"question_id\": \"<uuid from original question>\",\n      \"question_text\": \"<original question text>\",\n      \"response_text\": \"<extracted response from email>\",\n      \"confidence\": <0.0 to 1.0>,\n      \"matched\": <true/false>\n    }\n  ]\n}",
        "messages": {
          "messageValues": [
            {
              "message": "You are an expert AI assistant specialized in analyzing supplier email responses for procurement Q&A processes.\n\n### ROLE\nYou analyze email responses from suppliers and map each answer to its original technical question from a Q&A audit.\n\n### GUIDELINES\n1. Read the email carefully and identify distinct answers or response sections.\n2. Match each answer to the most relevant original question based on content, keywords, and context.\n3. Extract the exact response text from the email for each matched question.\n4. Assign confidence scores: 0.9+ for clear matches, 0.6-0.8 for likely matches, below 0.5 for uncertain.\n5. If a question has no answer in the email, mark it as not matched.\n6. Preserve the original question_id UUID exactly as provided.\n\n### CRITICAL: OUTPUT RESTRICTIONS\n- Return **ONLY** a valid JSON object.\n- **DO NOT** include any conversational text, explanations, or reasoning.\n- **DO NOT** use Markdown code blocks.\n- The output must start with `{` and end with `}`."
            }
          ]
        },
        "batching": {}
      },
      "type": "@n8n/n8n-nodes-langchain.chainLlm",
      "typeVersion": 1.8,
      "position": [
        3760,
        3040
      ],
      "id": "2ff19e31-e45d-4ec1-928b-74ab59318b97",
      "name": "QA Email Mapping Chain"
    },
    {
      "parameters": {
        "model": "mistral-large-latest",
        "options": {
          "temperature": 0.1
        }
      },
      "type": "@n8n/n8n-nodes-langchain.lmChatMistralCloud",
      "typeVersion": 1,
      "position": [
        3760,
        3248
      ],
      "id": "0a1ca948-c1b8-4b27-aa3e-a7a95b3bc7a4",
      "name": "Mistral QA Email Model",
      "credentials": {
        "mistralCloudApi": {
          "id": "tDjuOnF6lpADMmd5",
          "name": "Mistral Cloud account"
        }
      }
    },
    {
      "parameters": {
        "jsCode": "// Parse LLM output and ensure correct response format\nconst llmOutput = $input.first().json;\nlet result;\n\ntry {\n  // The LLM chain returns output in .text or .output\n  const rawText = llmOutput.text || llmOutput.output || JSON.stringify(llmOutput);\n  \n  // Try to parse as JSON\n  let parsed;\n  if (typeof rawText === 'string') {\n    // Clean potential markdown code blocks\n    const cleaned = rawText.replace(/```json\\n?/g, '').replace(/```\\n?/g, '').trim();\n    parsed = JSON.parse(cleaned);\n  } else {\n    parsed = rawText;\n  }\n  \n  // Validate and normalize\n  const mappings = (parsed.mappings || []).map(m => ({\n    question_id: m.question_id || '',\n    question_text: m.question_text || '',\n    response_text: m.response_text || '',\n    confidence: typeof m.confidence === 'number' ? m.confidence : 0,\n    matched: m.matched === true\n  }));\n  \n  const matchedCount = mappings.filter(m => m.matched).length;\n  \n  result = {\n    success: true,\n    processed_count: matchedCount,\n    mappings: mappings,\n    message: `Processed ${matchedCount} of ${mappings.length} questions from email`\n  };\n  \n  console.log(`✅ QA Email Response processed:`);\n  console.log(`   ├─ Total mappings: ${mappings.length}`);\n  console.log(`   └─ Matched: ${matchedCount}`);\n} catch (err) {\n  console.error('❌ Error parsing LLM output:', err.message);\n  result = {\n    success: false,\n    processed_count: 0,\n    mappings: [],\n    message: 'Error parsing AI response: ' + err.message\n  };\n}\n\nreturn [{ json: result }];"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        3968,
        3040
      ],
      "id": "c06cf20d-9bca-40df-836b-ee9f0da8870c",
      "name": "Parse QA Email Output"
    },
    {
      "parameters": {
        "respondWith": "allIncomingItems",
        "options": {}
      },
      "type": "n8n-nodes-base.respondToWebhook",
      "typeVersion": 1.5,
      "position": [
        4160,
        3040
      ],
      "id": "4c05118a-a0fc-4ebc-9f88-ad68bf4ec7d5",
      "name": "Respond QA Email Response"
    },
    {
      "parameters": {
        "content": "## /rfp-generate - AI RFP Document Generator\n\nGenerates a complete RFP/RFQ/RFI document using AI based on project requirements.\n\n**Method**: POST\n**Body**: { project_id, project_name, project_type, description, requirements, providers?, criteria?, deadlines?, language?, sections? }\n\n**Flow**: Webhook → Set Fields → LLM Chain → Parse & Structure Output → Respond\n\n**Returns**: { success, document, title, sections: [{title, content}], metadata: {word_count, generated_at, model} }",
        "height": 400,
        "width": 2200,
        "color": 6
      },
      "type": "n8n-nodes-base.stickyNote",
      "typeVersion": 1,
      "position": [
        2880,
        3376
      ],
      "id": "7950684b-457e-4f89-af51-f10906096b75",
      "name": "Sticky Note RFP Generate"
    },
    {
      "parameters": {
        "httpMethod": "POST",
        "path": "rfp-generate-desarrollo",
        "responseMode": "responseNode",
        "options": {}
      },
      "type": "n8n-nodes-base.webhook",
      "typeVersion": 2.1,
      "position": [
        2960,
        3536
      ],
      "id": "953d6eab-602e-469a-9143-face2d905ec0",
      "name": "Webhook RFP Generate",
      "webhookId": "rfp-generate-webhook-001"
    },
    {
      "parameters": {
        "assignments": {
          "assignments": [
            {
              "id": "rfp-project-id",
              "name": "project_id",
              "value": "={{ $json.body.project_id }}",
              "type": "string"
            },
            {
              "id": "rfp-project-name",
              "name": "project_name",
              "value": "={{ $json.body.project_name }}",
              "type": "string"
            },
            {
              "id": "rfp-project-type",
              "name": "project_type",
              "value": "={{ $json.body.project_type || 'RFP' }}",
              "type": "string"
            },
            {
              "id": "rfp-description",
              "name": "description",
              "value": "={{ $json.body.description }}",
              "type": "string"
            },
            {
              "id": "rfp-requirements",
              "name": "requirements",
              "value": "={{ $json.body.requirements }}",
              "type": "string"
            },
            {
              "id": "rfp-language",
              "name": "language",
              "value": "={{ $json.body.language || 'es' }}",
              "type": "string"
            },
            {
              "id": "rfp-sections",
              "name": "sections",
              "value": "={{ $json.body.sections }}",
              "type": "array"
            },
            {
              "id": "rfp-criteria",
              "name": "criteria",
              "value": "={{ $json.body.criteria }}",
              "type": "array"
            },
            {
              "id": "rfp-deadlines",
              "name": "deadlines",
              "value": "={{ $json.body.deadlines }}",
              "type": "object"
            },
            {
              "id": "rfp-providers",
              "name": "providers",
              "value": "={{ $json.body.providers }}",
              "type": "array"
            }
          ]
        },
        "options": {}
      },
      "type": "n8n-nodes-base.set",
      "typeVersion": 3.4,
      "position": [
        3168,
        3536
      ],
      "id": "d1e14817-bac2-4b26-a807-cfd462598e1f",
      "name": "Set RFP Params"
    },
    {
      "parameters": {
        "promptType": "define",
        "text": "=### INPUT\n\n## PROJECT: {{ $json.project_name }}\n## TYPE: {{ $json.project_type }}\n## LANGUAGE: {{ $json.language }}\n\n## DESCRIPTION:\n{{ $json.description }}\n\n## REQUIREMENTS:\n{{ $json.requirements }}\n\n## SECTIONS TO INCLUDE:\n{{ JSON.stringify($json.sections) }}\n\n## EVALUATION CRITERIA:\n{{ JSON.stringify($json.criteria) }}\n\n## DEADLINES:\n{{ JSON.stringify($json.deadlines) }}\n\n## INVITED PROVIDERS:\n{{ JSON.stringify($json.providers) }}\n\n### INSTRUCTIONS\nGenerate a complete, professional {{ $json.project_type }} document with ALL the requested sections.\nThe document must be in {{ $json.language === 'en' ? 'English' : 'Spanish' }}.\nUse Markdown formatting for the document body.\nEach section should be comprehensive and detailed.\nInclude the evaluation criteria and deadlines in the appropriate sections.\n\nReturn ONLY the JSON object. Do NOT include any text before or after the JSON.\n\n### OUTPUT SCHEMA\n{\n  \"title\": \"Document title\",\n  \"document\": \"Full document content in Markdown\",\n  \"sections\": [\n    { \"title\": \"Section Name\", \"content\": \"Section content in Markdown\" }\n  ]\n}",
        "messages": {
          "messageValues": [
            {
              "message": "=You are an expert procurement specialist and technical writer with extensive experience in industrial projects (energy, P2X, green hydrogen, EPC).\n\n### ROLE\nGenerate formal {{ $json.project_type }} (Request for Proposal/Quotation/Information) documents that are professional, comprehensive, and aligned with industry best practices.\n\n### GUIDELINES\n1. **Structure**: Follow standard {{ $json.project_type }} format with clear sections, numbering, and professional language.\n2. **Content**: Each section must be substantive (not just headers). Include specific requirements, evaluation methodology, and clear instructions for bidders.\n3. **Evaluation Criteria**: If criteria with weights are provided, include them in a dedicated section with a clear scoring methodology.\n4. **Deadlines**: If deadlines are provided, include a timeline section with key dates.\n5. **Providers**: If invited providers are listed, reference the closed bidding process.\n6. **Language**: Write entirely in the requested language. Use formal, professional tone.\n7. **Formatting**: Use Markdown (headers ##, bold **, bullet points -, tables |) for readability.\n\n### CRITICAL: OUTPUT RESTRICTIONS\n- Return **ONLY** a valid JSON object.\n- **DO NOT** include any conversational text, explanations, or reasoning.\n- **DO NOT** use Markdown code blocks (e.g., ```json).\n- The output must start with `{` and end with `}`.\n- The 'document' field must contain the FULL document text, not just a summary."
            }
          ]
        },
        "batching": {}
      },
      "type": "@n8n/n8n-nodes-langchain.chainLlm",
      "typeVersion": 1.8,
      "position": [
        3360,
        3536
      ],
      "id": "6fb8b2fd-c70c-4d40-8a77-fca4b9e17088",
      "name": "RFP Generation Chain"
    },
    {
      "parameters": {
        "model": "mistral-large-latest",
        "options": {
          "temperature": 0.2
        }
      },
      "type": "@n8n/n8n-nodes-langchain.lmChatMistralCloud",
      "typeVersion": 1,
      "position": [
        3360,
        3744
      ],
      "id": "77400334-41f2-4ed8-9896-1227fb48d3ce",
      "name": "Mistral RFP Model",
      "credentials": {
        "mistralCloudApi": {
          "id": "tDjuOnF6lpADMmd5",
          "name": "Mistral Cloud account"
        }
      }
    },
    {
      "parameters": {
        "jsCode": "// Parse LLM output and structure the RFP response\nconst llmOutput = $input.first().json;\nconst params = $('Set RFP Params').first().json;\nlet result;\n\ntry {\n  const rawText = llmOutput.text || llmOutput.output || JSON.stringify(llmOutput);\n  \n  let parsed;\n  if (typeof rawText === 'string') {\n    const cleaned = rawText.replace(/```json\\n?/g, '').replace(/```\\n?/g, '').trim();\n    parsed = JSON.parse(cleaned);\n  } else {\n    parsed = rawText;\n  }\n  \n  // Build sections array\n  const sections = (parsed.sections || []).map(s => ({\n    title: s.title || 'Untitled Section',\n    content: s.content || ''\n  }));\n  \n  // Build full document\n  const document = parsed.document || sections.map(s => `## ${s.title}\\n\\n${s.content}`).join('\\n\\n');\n  \n  // Calculate word count\n  const wordCount = document.split(/\\s+/).filter(w => w.length > 0).length;\n  \n  result = {\n    success: true,\n    title: parsed.title || `${params.project_type} - ${params.project_name}`,\n    document: document,\n    sections: sections,\n    metadata: {\n      word_count: wordCount,\n      generated_at: new Date().toISOString(),\n      model: 'mistral-large-latest'\n    },\n    message: `RFP generated successfully (${wordCount} words, ${sections.length} sections)`\n  };\n  \n  console.log(`✅ RFP Generated:`);\n  console.log(`   ├─ Title: ${result.title}`);\n  console.log(`   ├─ Sections: ${sections.length}`);\n  console.log(`   └─ Words: ${wordCount}`);\n} catch (err) {\n  console.error('❌ Error parsing RFP output:', err.message);\n  result = {\n    success: false,\n    title: '',\n    document: '',\n    sections: [],\n    metadata: { word_count: 0, generated_at: new Date().toISOString(), model: 'mistral-large-latest' },\n    message: 'Error generating RFP: ' + err.message\n  };\n}\n\nreturn [{ json: result }];"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        3568,
        3536
      ],
      "id": "c74a01dd-1fdb-4d6f-8351-2c0628bbaf42",
      "name": "Parse RFP Output"
    },
    {
      "parameters": {
        "respondWith": "allIncomingItems",
        "options": {}
      },
      "type": "n8n-nodes-base.respondToWebhook",
      "typeVersion": 1.5,
      "position": [
        3760,
        3536
      ],
      "id": "3b65b858-f473-415d-ad19-09ec97e3caf4",
      "name": "Respond RFP Generate"
    },
    {
      "parameters": {
        "conditions": {
          "options": {
            "caseSensitive": false,
            "leftValue": ""
          },
          "conditions": [
            {
              "id": "check-has-economic-type",
              "leftValue": "={{ ($('Set File ID').first().json.evaluation || []).join(',').toLowerCase() }}",
              "rightValue": "econom",
              "operator": {
                "type": "string",
                "operation": "contains"
              }
            }
          ],
          "combinator": "and"
        },
        "options": {}
      },
      "type": "n8n-nodes-base.if",
      "typeVersion": 2.2,
      "position": [
        912,
        -1488
      ],
      "id": "cb784dd4-7310-45a7-9d70-1debd2260c44",
      "name": "Has Economic Evaluation?"
    },
    {
      "parameters": {
        "content": "## Economic Data Extraction (T8)\n\nExtracts structured economic/financial data from supplier proposals.\nOnly triggered when the offer includes Economical Evaluation type.\n\n**Flow**: Merge1 -> IF (Has Economic?) -> Check If Economic -> Extract Economic Data (LLM) -> Parse Economic JSON -> Save Economic Offer (Supabase UPSERT)\n\n**Target table**: economic_offers (project_id, provider_name unique constraint)",
        "height": 520,
        "width": 2500,
        "color": 5
      },
      "type": "n8n-nodes-base.stickyNote",
      "typeVersion": 1,
      "position": [
        832,
        -1808
      ],
      "id": "cdfcfc7a-c148-41e5-af60-c6830fb9a8d4",
      "name": "Sticky Note Economic"
    },
    {
      "parameters": {
        "jsCode": "// =============================================\n// NODE: Check If Economic Offer\n// Determines if this supplier proposal contains economic/pricing data\n// and prepares text for LLM extraction.\n// =============================================\n\n// Get the merged proposal data\nconst mergeData = $input.first().json;\n\n// Get metadata from Set File ID\nlet providerName = 'UNKNOWN';\nlet projectId = null;\nlet projectName = '';\nlet evaluationTypes = [];\n\ntry {\n    const fileData = $('Set File ID').first().json;\n    providerName = fileData.proveedor || 'UNKNOWN';\n    projectId = fileData.project_id || null;\n    projectName = fileData.proyect_name || '';\n    \n    if (fileData.evaluation && Array.isArray(fileData.evaluation)) {\n        evaluationTypes = fileData.evaluation;\n    } else if (fileData.evaluation && typeof fileData.evaluation === 'string') {\n        evaluationTypes = [fileData.evaluation];\n    }\n} catch (e) {\n    console.log('Warning: Could not read Set File ID:', e.message);\n}\n\n// Check if evaluation types include economic\nconst hasEconomic = evaluationTypes.some(t => \n    t.toLowerCase().includes('econom') || \n    t.toLowerCase().includes('commercial') ||\n    t.toLowerCase().includes('pricing')\n);\n\n// Also check text content for economic indicators as fallback\nlet fullText = '';\ntry {\n    if (mergeData.pages && Array.isArray(mergeData.pages)) {\n        fullText = mergeData.pages.map(p => p.text || '').join('\\n\\n');\n    } else {\n        fullText = mergeData.text || '';\n    }\n} catch (e) {\n    fullText = '';\n}\n\n// Economic indicators in text\nconst economicKeywords = ['total price', 'precio total', 'price breakdown', 'desglose', \n    'payment terms', 'condiciones de pago', 'discount', 'descuento', 'EUR/h', 'USD/h',\n    'lump sum', 'suma alzada', 'cost estimate', 'presupuesto', 'budget',\n    'fee schedule', 'tarifa', 'quotation', 'cotizacion', 'oferta economica',\n    'commercial proposal', 'propuesta economica', 'pricing schedule'];\n\nconst textLower = fullText.substring(0, 50000).toLowerCase();\nconst textHasEconomic = economicKeywords.some(kw => textLower.includes(kw));\n\nconst shouldExtract = hasEconomic || textHasEconomic;\n\nconsole.log(`Economic Check:`);\nconsole.log(`  Provider: ${providerName}`);\nconsole.log(`  Project ID: ${projectId}`);\nconsole.log(`  Eval types: ${JSON.stringify(evaluationTypes)}`);\nconsole.log(`  Has economic type: ${hasEconomic}`);\nconsole.log(`  Text has economic keywords: ${textHasEconomic}`);\nconsole.log(`  Should extract: ${shouldExtract}`);\n\nif (!shouldExtract) {\n    console.log('Skipping economic extraction - no economic content detected');\n    return [];\n}\n\n// Limit text to ~60k chars for LLM context\nconst textForExtraction = fullText.substring(0, 60000);\n\nreturn [{\n    json: {\n        provider_name: providerName,\n        project_id: projectId,\n        project_name: projectName,\n        proposal_text: textForExtraction,\n        text_length: fullText.length,\n        evaluation_types: evaluationTypes\n    }\n}];"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        1152,
        -1488
      ],
      "id": "52842c6e-db4b-418b-ae71-fa99e6c8cf32",
      "name": "Check If Economic Offer"
    },
    {
      "parameters": {
        "promptType": "define",
        "text": "=### SUPPLIER PROPOSAL - ECONOMIC DATA EXTRACTION\n\n## PROJECT: {{ $json.project_name }}\n## PROVIDER: {{ $json.provider_name }}\n\n### PROPOSAL TEXT:\n{{ $json.proposal_text }}\n\n---\n### INSTRUCTIONS:\nExtract ALL economic and financial data from this supplier proposal.\nReturn ONLY a valid JSON object. Do NOT include markdown code blocks.\nIf a field is not found in the text, use null.\nFor total_price, look for the main bid amount, lump sum, or total cost figure.\nFor price_breakdown, extract line items, cost by discipline, or cost by phase.\nFor payment terms, look for Net 30/60/90, milestone payments, etc.\n\nReturn ONLY valid JSON starting with { and ending with }.",
        "messages": {
          "messageValues": [
            {
              "message": "You are an expert procurement analyst specializing in extracting economic and financial data from supplier proposals for large-scale industrial projects (EPC, P2X, Green Hydrogen, Energy).\n\n### TASK\nExtract all economic/financial data from the supplier proposal text.\n\n### OUTPUT SCHEMA (return ONLY this JSON structure):\n{\n  \"total_price\": <number or null>,\n  \"currency\": \"<ISO 4217 code, default EUR>\",\n  \"price_breakdown\": <object with line items like {\"engineering\": X, \"procurement\": Y, \"construction\": Z} or null>,\n  \"discount_percentage\": <number, 0 if none>,\n  \"discount_conditions\": <string or null>,\n  \"tco_value\": <number or null>,\n  \"tco_period_years\": <number or null>,\n  \"tco_breakdown\": <object like {\"capex\": X, \"opex_annual\": Y} or null>,\n  \"payment_terms\": <string describing terms like \"Net 60\" or \"30/40/30\" or null>,\n  \"payment_schedule\": <array of {\"milestone\": \"percentage\", \"event\": \"description\"} or null>,\n  \"validity_days\": <number, default 90>,\n  \"price_escalation\": <string describing escalation clauses or null>,\n  \"guarantees\": <string describing financial/performance guarantees or null>,\n  \"insurance_included\": <boolean>,\n  \"taxes_included\": <boolean>,\n  \"optional_items\": <array of {\"description\": \"X\", \"price\": Y} or null>,\n  \"alternative_offers\": <array of {\"description\": \"X\", \"total_price\": Y, \"details\": \"...\"} or null>,\n  \"extraction_confidence\": <number 0.0-1.0>,\n  \"raw_notes\": <string with any additional economic observations>\n}\n\n### CRITICAL RULES:\n1. Return ONLY the JSON object. No explanations, no markdown.\n2. Numbers must be actual numbers, not strings (e.g., 1500000 not \"1,500,000\").\n3. If you find prices in different currencies, note the original and convert to EUR if possible.\n4. For price_breakdown, use descriptive keys in English.\n5. extraction_confidence should reflect how much economic data you actually found (0.1 = almost nothing, 0.9 = very detailed).\n6. Be thorough: check tables, headers, footers, appendices for pricing data.\n7. Look for both explicit prices and calculated totals."
            }
          ]
        },
        "batching": {}
      },
      "type": "@n8n/n8n-nodes-langchain.chainLlm",
      "typeVersion": 1.8,
      "position": [
        1472,
        -1488
      ],
      "id": "9f926c47-834f-4aa3-855d-d9df8cfb0dce",
      "name": "Extract Economic Data"
    },
    {
      "parameters": {
        "model": "mistral-large-latest",
        "options": {
          "temperature": 0.1
        }
      },
      "type": "@n8n/n8n-nodes-langchain.lmChatMistralCloud",
      "typeVersion": 1,
      "position": [
        1472,
        -1280
      ],
      "id": "bf1bb0d1-474b-484f-a21e-bd999b6ad2e5",
      "name": "Mistral Economic Model",
      "credentials": {
        "mistralCloudApi": {
          "id": "tDjuOnF6lpADMmd5",
          "name": "Mistral Cloud account"
        }
      }
    },
    {
      "parameters": {
        "jsCode": "// =============================================\n// NODE: Parse Economic JSON\n// Parses and validates the LLM economic extraction output\n// =============================================\n\nconst llmOutput = $input.first().json;\nconst inputData = $('Check If Economic Offer').first().json;\n\nlet parsed = null;\n\ntry {\n    // The LLM chain returns output in .text or .output\n    let rawText = llmOutput.text || llmOutput.output || JSON.stringify(llmOutput);\n    \n    if (typeof rawText === 'string') {\n        // Clean potential markdown code blocks\n        rawText = rawText.replace(/```json\\n?/g, '').replace(/```\\n?/g, '').trim();\n        \n        // Find JSON boundaries\n        const start = rawText.indexOf('{');\n        const end = rawText.lastIndexOf('}');\n        if (start !== -1 && end !== -1 && end > start) {\n            rawText = rawText.substring(start, end + 1);\n        }\n        \n        parsed = JSON.parse(rawText);\n    } else {\n        parsed = rawText;\n    }\n} catch (err) {\n    console.error('Error parsing economic JSON:', err.message);\n    // Return minimal valid record so we still save something\n    parsed = {\n        total_price: null,\n        currency: 'EUR',\n        extraction_confidence: 0.0,\n        raw_notes: 'LLM output could not be parsed: ' + err.message\n    };\n}\n\n// Helper to safely convert to number\nfunction toNumber(val) {\n    if (val === null || val === undefined) return null;\n    if (typeof val === 'number') return val;\n    if (typeof val === 'string') {\n        // Remove currency symbols, commas, spaces\n        const cleaned = val.replace(/[^0-9.-]/g, '');\n        const num = parseFloat(cleaned);\n        return isNaN(num) ? null : num;\n    }\n    return null;\n}\n\n// Helper to safely convert to JSON string for Supabase JSONB columns\nfunction toJsonString(val) {\n    if (val === null || val === undefined) return null;\n    if (typeof val === 'string') return val;\n    return JSON.stringify(val);\n}\n\n// Build the record for Supabase\nconst record = {\n    project_id: inputData.project_id,\n    provider_name: inputData.provider_name,\n    \n    // Core pricing\n    total_price: toNumber(parsed.total_price),\n    currency: parsed.currency || 'EUR',\n    price_breakdown: toJsonString(parsed.price_breakdown || {}),\n    \n    // Payment terms\n    payment_terms: parsed.payment_terms || null,\n    payment_schedule: toJsonString(parsed.payment_schedule || []),\n    \n    // Discounts\n    discount_percentage: toNumber(parsed.discount_percentage) || 0,\n    discount_conditions: parsed.discount_conditions || null,\n    \n    // TCO\n    tco_value: toNumber(parsed.tco_value),\n    tco_period_years: parsed.tco_period_years ? parseInt(parsed.tco_period_years) : null,\n    tco_breakdown: toJsonString(parsed.tco_breakdown || {}),\n    \n    // Additional\n    validity_days: parsed.validity_days ? parseInt(parsed.validity_days) : 90,\n    price_escalation: parsed.price_escalation || null,\n    guarantees: parsed.guarantees || null,\n    insurance_included: parsed.insurance_included === true,\n    taxes_included: parsed.taxes_included === true,\n    \n    // Optional / alternatives\n    optional_items: toJsonString(parsed.optional_items || []),\n    alternative_offers: toJsonString(parsed.alternative_offers || []),\n    \n    // AI metadata\n    extraction_confidence: toNumber(parsed.extraction_confidence) || 0,\n    raw_notes: parsed.raw_notes || null\n};\n\nconsole.log('Economic data parsed successfully:');\nconsole.log(`  Provider: ${record.provider_name}`);\nconsole.log(`  Total price: ${record.total_price} ${record.currency}`);\nconsole.log(`  Confidence: ${record.extraction_confidence}`);\nconsole.log(`  Has breakdown: ${record.price_breakdown !== '{}'}`);\nconsole.log(`  Has payment terms: ${!!record.payment_terms}`);\n\n// Validate: skip save if no project_id or provider_name\nif (!record.project_id || !record.provider_name || record.provider_name === 'UNKNOWN') {\n    console.log('WARNING: Missing project_id or provider_name, skipping save');\n    return [];\n}\n\nreturn [{ json: record }];"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        1792,
        -1488
      ],
      "id": "14163cc5-7513-4fe2-a805-2e6d2b98c6d1",
      "name": "Parse Economic JSON"
    },
    {
      "parameters": {
        "operation": "executeQuery",
        "query": "=INSERT INTO desarrollo.economic_offers (project_id, provider_name, economic_data, total_amount, currency, updated_at)\nVALUES (\n  '{{ $json.project_id }}',\n  '{{ $json.provider_name }}',\n  '{{ JSON.stringify($json.economic_data || $json) }}',\n  {{ $json.total_amount || 0 }},\n  '{{ $json.currency || \"EUR\" }}',\n  NOW()\n)\nON CONFLICT (project_id, provider_name)\nDO UPDATE SET\n  economic_data = EXCLUDED.economic_data,\n  total_amount = EXCLUDED.total_amount,\n  currency = EXCLUDED.currency,\n  updated_at = NOW()\nRETURNING *",
        "options": {}
      },
      "type": "n8n-nodes-base.postgres",
      "typeVersion": 2.5,
      "position": [
        2112,
        -1488
      ],
      "id": "c9062b91-9a28-48c5-aa97-127c4d70acdd",
      "name": "Save Economic Offer",
      "credentials": {
        "postgres": {
          "id": "V0REAPph5JBLqze3",
          "name": "Postgres account"
        }
      }
    }
  ],
  "connections": {
    "Edit Fields": {
      "main": [
        [
          {
            "node": "Get Offers",
            "type": "main",
            "index": 0
          },
          {
            "node": "Fetch Project Context Email",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Filter and Aggregate Issues": {
      "main": [
        [
          {
            "node": "Basic LLM Chain",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Webhook3": {
      "main": [
        [
          {
            "node": "Edit Fields",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Get Offers": {
      "main": [
        [
          {
            "node": "Filter and Aggregate Issues",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Basic LLM Chain": {
      "main": [
        [
          {
            "node": "Respond to Webhook3",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Mistral Cloud Chat Model1": {
      "ai_languageModel": [
        [
          {
            "node": "Basic LLM Chain",
            "type": "ai_languageModel",
            "index": 0
          }
        ]
      ]
    },
    "Extract Fields": {
      "main": [
        [
          {
            "node": "Validate Data",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Validate Data": {
      "main": [
        [
          {
            "node": "Convert Markdown to HTML",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Respond Error",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Convert Markdown to HTML": {
      "main": [
        [
          {
            "node": "Gmail Send",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Gmail Send": {
      "main": [
        [
          {
            "node": "Respond Success2",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Webhook2": {
      "main": [
        [
          {
            "node": "Extract Fields",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Webhook Receive": {
      "main": [
        [
          {
            "node": "Set Input Params2",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Email Provided?": {
      "main": [
        [
          {
            "node": "Send Email via Gmail",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Split for Update",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Send Email via Gmail": {
      "main": [
        [
          {
            "node": "Split for Update",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Generate Token": {
      "main": [
        [
          {
            "node": "Save Token to DB",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Save Token to DB": {
      "main": [
        [
          {
            "node": "Split Question IDs",
            "type": "main",
            "index": 0
          },
          {
            "node": "Fetch Project Name",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Split Question IDs": {
      "main": [
        [
          {
            "node": "Fetch Questions",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Fetch Questions": {
      "main": [
        [
          {
            "node": "Merge Data",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Fetch Project Name": {
      "main": [
        [
          {
            "node": "Merge Data",
            "type": "main",
            "index": 1
          }
        ]
      ]
    },
    "Merge Data": {
      "main": [
        [
          {
            "node": "Build Email Content",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Build Email Content": {
      "main": [
        [
          {
            "node": "Email Provided?",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Split for Update": {
      "main": [
        [
          {
            "node": "Update Question Status",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Update Question Status": {
      "main": [
        [
          {
            "node": "Respond to Webhook2",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Set Input Params2": {
      "main": [
        [
          {
            "node": "Generate Token",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Validate Token": {
      "main": [
        [
          {
            "node": "Token Valid?",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Token Valid?": {
      "main": [
        [
          {
            "node": "Split Responses",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Respond Invalid",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Split Responses": {
      "main": [
        [
          {
            "node": "Loop Over Items",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Loop Over Items": {
      "main": [
        [
          {
            "node": "Mark Token Responded",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Save Response to QA Audit",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Save Response to QA Audit": {
      "main": [
        [
          {
            "node": "Fetch Question Details",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Fetch Question Details": {
      "main": [
        [
          {
            "node": "Has Requirement?",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Has Requirement?": {
      "main": [
        [
          {
            "node": "Fetch Requirement",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "No Requirement",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Fetch Requirement": {
      "main": [
        [
          {
            "node": "Fetch Current Evaluation",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Fetch Current Evaluation": {
      "main": [
        [
          {
            "node": "LLM Re-evaluate",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "LLM Re-evaluate": {
      "main": [
        [
          {
            "node": "Should Update?",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Should Update?": {
      "main": [
        [
          {
            "node": "Update Provider Response",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Skip Update",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Update Provider Response": {
      "main": [
        [
          {
            "node": "Merge Results",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Skip Update": {
      "main": [
        [
          {
            "node": "Merge Results",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "No Requirement": {
      "main": [
        [
          {
            "node": "Merge Results",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Merge Results": {
      "main": [
        [
          {
            "node": "Loop Over Items",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Mark Token Responded": {
      "main": [
        [
          {
            "node": "Create Notification",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Create Notification": {
      "main": [
        [
          {
            "node": "Respond Success",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Webhook Receive1": {
      "main": [
        [
          {
            "node": "Set Input Params3",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Set Input Params3": {
      "main": [
        [
          {
            "node": "Validate Token",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "JSON Output Parser2": {
      "ai_outputParser": [
        [
          {
            "node": "LLM Re-evaluate",
            "type": "ai_outputParser",
            "index": 0
          }
        ]
      ]
    },
    "Mistral Cloud Chat Model4": {
      "ai_languageModel": [
        [
          {
            "node": "LLM Re-evaluate",
            "type": "ai_languageModel",
            "index": 0
          }
        ]
      ]
    },
    "Webhook Inbound": {
      "main": [
        [
          {
            "node": "Set Input Params",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Set Input Params": {
      "main": [
        [
          {
            "node": "Fetch Project Context QA",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Fetch All Provider Responses": {
      "main": [
        [
          {
            "node": "Filter Deficiencies Only",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Filter Deficiencies Only": {
      "main": [
        [
          {
            "node": "Fetch Requirement Specs",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Fetch Requirement Specs": {
      "main": [
        [
          {
            "node": "Consolidate Deficiencies",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Consolidate Deficiencies": {
      "main": [
        [
          {
            "node": "QA Generation Chain",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "QA Generation Chain": {
      "main": [
        [
          {
            "node": "Split Questions List",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "JSON Output Parser": {
      "ai_outputParser": [
        [
          {
            "node": "QA Generation Chain",
            "type": "ai_outputParser",
            "index": 0
          }
        ]
      ]
    },
    "Split Questions List": {
      "main": [
        [
          {
            "node": "Supabase Insert",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Supabase Insert": {
      "main": [
        [
          {
            "node": "Extract Disciplines",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Extract Disciplines": {
      "main": [
        [
          {
            "node": "Save Project Disciplines",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Save Project Disciplines": {
      "main": [
        [
          {
            "node": "Respond to Webhook1",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Mistral Cloud Chat Model": {
      "ai_languageModel": [
        [
          {
            "node": "QA Generation Chain",
            "type": "ai_languageModel",
            "index": 0
          }
        ]
      ]
    },
    "Fetch Requirements": {
      "main": [
        [
          {
            "node": "Merge Requirements & Responses",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Fetch Provider Responses": {
      "main": [
        [
          {
            "node": "Merge Requirements & Responses",
            "type": "main",
            "index": 1
          }
        ]
      ]
    },
    "Fetch Scoring Configuration": {
      "main": [
        [
          {
            "node": "Merge Requirements & Responses",
            "type": "main",
            "index": 2
          }
        ]
      ]
    },
    "Merge Requirements & Responses": {
      "main": [
        [
          {
            "node": "Prepare Scoring Data",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Prepare Scoring Data": {
      "main": [
        [
          {
            "node": "Loop Over Providers",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Loop Over Providers": {
      "main": [
        [
          {
            "node": "Aggregate All Rankings",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Scoring LLM Chain",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Scoring LLM Chain": {
      "main": [
        [
          {
            "node": "Calculate Weighted Scores",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Calculate Weighted Scores": {
      "main": [
        [
          {
            "node": "Check Provider Exists",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Check Provider Exists": {
      "main": [
        [
          {
            "node": "Insert Ranking",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Provider Exists?": {
      "main": [
        [
          {
            "node": "Update Ranking",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Insert Ranking",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Update Ranking": {
      "main": [
        [
          {
            "node": "Loop Over Providers",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Insert Ranking": {
      "main": [
        [
          {
            "node": "Loop Over Providers",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Aggregate All Rankings": {
      "main": [
        [
          {
            "node": "Generate Final Ranking",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Generate Final Ranking": {
      "main": [
        [
          {
            "node": "Respond with Ranking",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Set Input Params1": {
      "main": [
        [
          {
            "node": "Fetch Project Context Scoring",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "JSON Output Parser1": {
      "ai_outputParser": [
        [
          {
            "node": "Scoring LLM Chain",
            "type": "ai_outputParser",
            "index": 0
          }
        ]
      ]
    },
    "Delete a row": {
      "main": [
        [
          {
            "node": "Set Input Params1",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "OpenRouter Chat Model1": {
      "ai_languageModel": [
        [
          {
            "node": "Scoring LLM Chain",
            "type": "ai_languageModel",
            "index": 0
          }
        ]
      ]
    },
    "Webhook Scoring": {
      "main": [
        [
          {
            "node": "Delete a row",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Webhook1": {
      "main": [
        [
          {
            "node": "Chat AI Agent",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Postgres Chat Memory": {
      "ai_memory": [
        [
          {
            "node": "Chat AI Agent",
            "type": "ai_memory",
            "index": 0
          }
        ]
      ]
    },
    "Embeddings Ollama": {
      "ai_embedding": [
        [
          {
            "node": "Revisar RFQs",
            "type": "ai_embedding",
            "index": 0
          }
        ]
      ]
    },
    "Chat AI Agent": {
      "main": [
        [
          {
            "node": "Respond to Webhook5",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Revisar-ofertas": {
      "ai_tool": [
        [
          {
            "node": "Chat AI Agent",
            "type": "ai_tool",
            "index": 0
          }
        ]
      ]
    },
    "Revisar RFQs": {
      "ai_tool": [
        [
          {
            "node": "Chat AI Agent",
            "type": "ai_tool",
            "index": 0
          }
        ]
      ]
    },
    "Embeddings Ollama5": {
      "ai_embedding": [
        [
          {
            "node": "Revisar-ofertas",
            "type": "ai_embedding",
            "index": 0
          }
        ]
      ]
    },
    "query_requirements": {
      "ai_tool": [
        [
          {
            "node": "Chat AI Agent",
            "type": "ai_tool",
            "index": 0
          }
        ]
      ]
    },
    "query_provider_responses": {
      "ai_tool": [
        [
          {
            "node": "Chat AI Agent",
            "type": "ai_tool",
            "index": 0
          }
        ]
      ]
    },
    "query_ranking": {
      "ai_tool": [
        [
          {
            "node": "Chat AI Agent",
            "type": "ai_tool",
            "index": 0
          }
        ]
      ]
    },
    "query_qa_audit": {
      "ai_tool": [
        [
          {
            "node": "Chat AI Agent",
            "type": "ai_tool",
            "index": 0
          }
        ]
      ]
    },
    "Mistral Cloud Chat Model2": {
      "ai_languageModel": [
        [
          {
            "node": "Chat AI Agent",
            "type": "ai_languageModel",
            "index": 0
          }
        ]
      ]
    },
    "Webhook RFQ": {
      "main": [
        [
          {
            "node": "Generate IDs1",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Preparar Texto1": {
      "main": [
        [
          {
            "node": "Clasificador de Tipos1",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Clasificador de Tipos1": {
      "main": [
        [
          {
            "node": "Insert Document Metadata2",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Output Parser1": {
      "ai_outputParser": [
        [
          {
            "node": "Clasificador de Tipos1",
            "type": "ai_outputParser",
            "index": 0
          }
        ]
      ]
    },
    "Expandir por Tipo1": {
      "main": [
        [
          {
            "node": "Loop por Tipo1",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Loop por Tipo1": {
      "main": [
        [
          {
            "node": "Resumen Final1",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Dividir en Trozos1",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Parsear Items1": {
      "main": [
        [
          {
            "node": "Create a row",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Agregar Resultados1": {
      "main": [
        [
          {
            "node": "Loop por Trozo1",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Resumen Final1": {
      "main": [
        [
          {
            "node": "Respond Success1",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Base64 a Binary3": {
      "main": [
        [
          {
            "node": "Extract from File3",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Extract from File3": {
      "main": [
        [
          {
            "node": "Preparar Texto1",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Generate IDs1": {
      "main": [
        [
          {
            "node": "Delete Old Doc Rows1",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Switch1": {
      "main": [
        [
          {
            "node": "LLM Extractor Tech-Econ",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "LLM Extractor - Deliverables",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "LLM Extractor - Deliverables": {
      "main": [
        [
          {
            "node": "Parsear deliverables",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Parsear deliverables": {
      "main": [
        [
          {
            "node": "Create a row",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Dividir en Trozos1": {
      "main": [
        [
          {
            "node": "Reset Items1",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Loop por Trozo1": {
      "main": [
        [
          {
            "node": "Loop por Tipo1",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Switch1",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Reset Items1": {
      "main": [
        [
          {
            "node": "Loop por Trozo1",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Embeddings Ollama1": {
      "ai_embedding": [
        [
          {
            "node": "Insert into Supabase Vectorstore1",
            "type": "ai_embedding",
            "index": 0
          }
        ]
      ]
    },
    "Insert into Supabase Vectorstore1": {
      "main": [
        [
          {
            "node": "Expandir por Tipo1",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Recursive Character Text Splitter1": {
      "ai_textSplitter": [
        [
          {
            "node": "Default Data Loader1",
            "type": "ai_textSplitter",
            "index": 0
          }
        ]
      ]
    },
    "Default Data Loader1": {
      "ai_document": [
        [
          {
            "node": "Insert into Supabase Vectorstore1",
            "type": "ai_document",
            "index": 0
          }
        ]
      ]
    },
    "Create a row": {
      "main": [
        [
          {
            "node": "Agregar Resultados1",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Delete Old Doc Rows1": {
      "main": [
        [
          {
            "node": "Base64 a Binary3",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Insert Document Metadata2": {
      "main": [
        [
          {
            "node": "Insert into Supabase Vectorstore1",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "LLM Extractor Tech-Econ": {
      "main": [
        [
          {
            "node": "Parsear Items1",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Mistral Cloud Chat Model7": {
      "ai_languageModel": [
        [
          {
            "node": "LLM Extractor Tech-Econ",
            "type": "ai_languageModel",
            "index": 0
          }
        ]
      ]
    },
    "Mistral Cloud Chat Model8": {
      "ai_languageModel": [
        [
          {
            "node": "LLM Extractor - Deliverables",
            "type": "ai_languageModel",
            "index": 0
          }
        ]
      ]
    },
    "Mistral Cloud Chat Model9": {
      "ai_languageModel": [
        [
          {
            "node": "Clasificador de Tipos1",
            "type": "ai_languageModel",
            "index": 0
          }
        ]
      ]
    },
    "Get many rows1": {
      "main": [
        [
          {
            "node": "Reset Items",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Embeddings Ollama3": {
      "ai_embedding": [
        [
          {
            "node": "Insert into Supabase Vectorstore",
            "type": "ai_embedding",
            "index": 0
          }
        ]
      ]
    },
    "Validador de Ofertas": {
      "main": [
        [
          {
            "node": "Format for Vectorstore",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Structured Output Parser4": {
      "ai_outputParser": [
        [
          {
            "node": "Validador de Ofertas",
            "type": "ai_outputParser",
            "index": 0
          }
        ]
      ]
    },
    "Clasificador de Tipo de Evaluacion y Proveedor": {
      "main": [
        [
          {
            "node": "Format for Vectorstore",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "If": {
      "main": [
        [
          {
            "node": "Format for Vectorstore",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Format for Vectorstore",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Loop Over Phases": {
      "main": [
        [
          {
            "node": "Loop Over Items1",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Preparar Todo para LLM1",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Parsear y Preparar Update": {
      "main": [
        [
          {
            "node": "Insert or update rows in a table",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "LLM Chain": {
      "main": [
        [
          {
            "node": "Parsear y Preparar Update",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Insert Document Metadata": {
      "main": [
        [
          {
            "node": "Base64 a Binary",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Delete Old Doc Rows": {
      "main": [
        [
          {
            "node": "Insert Document Metadata",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Set File ID": {
      "main": [
        [
          {
            "node": "Delete Old Doc Rows",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Default Data Loader": {
      "ai_document": [
        [
          {
            "node": "Insert into Supabase Vectorstore",
            "type": "ai_document",
            "index": 0
          }
        ]
      ]
    },
    "Recursive Character Text Splitter": {
      "ai_textSplitter": [
        [
          {
            "node": "Default Data Loader",
            "type": "ai_textSplitter",
            "index": 0
          }
        ]
      ]
    },
    "Insert into Supabase Vectorstore": {
      "main": [
        [
          {
            "node": "Expandir por Tipo de Evaluación",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Validar Contenido PDF": {
      "main": [
        [
          {
            "node": "¿Necesita OCR?",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Extract from File": {
      "main": [
        [
          {
            "node": "Validar Contenido PDF",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "¿Necesita OCR?": {
      "main": [
        [
          {
            "node": "Base64 a Binary1",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Merge1",
            "type": "main",
            "index": 1
          }
        ]
      ]
    },
    "Aggregate OCR Pages": {
      "main": [
        [
          {
            "node": "Merge1",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Preparar Texto de Muestra": {
      "main": [
        [
          {
            "node": "Format for Vectorstore",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Format for Vectorstore": {
      "main": [
        [
          {
            "node": "Insert into Supabase Vectorstore",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Expandir por Tipo de Evaluación": {
      "main": [
        [
          {
            "node": "Loop Over Items1",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Loop Over Items1": {
      "main": [
        [
          {
            "node": "Respond to Webhook",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Get many rows1",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Docling OCR": {
      "main": [
        [
          {
            "node": "Aggregate OCR Pages",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Structured Output Parser": {
      "ai_outputParser": [
        [
          {
            "node": "Clasificador de Tipo de Evaluacion y Proveedor",
            "type": "ai_outputParser",
            "index": 0
          }
        ]
      ]
    },
    "Merge1": {
      "main": [
        [
          {
            "node": "Has Economic Evaluation?",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Reset Items": {
      "main": [
        [
          {
            "node": "Loop Over Phases",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Webhook": {
      "main": [
        [
          {
            "node": "Code in JavaScript1",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Base64 a Binary": {
      "main": [
        [
          {
            "node": "Extract from File",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Base64 a Binary1": {
      "main": [
        [
          {
            "node": "Docling OCR",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Code in JavaScript1": {
      "main": [
        [
          {
            "node": "Set File ID",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Insert or update rows in a table": {
      "main": [
        [
          {
            "node": "Loop Over Phases",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Preparar Todo para LLM1": {
      "main": [
        [
          {
            "node": "LLM Chain",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Mistral Cloud Chat Model3": {
      "ai_languageModel": [
        [
          {
            "node": "LLM Chain",
            "type": "ai_languageModel",
            "index": 0
          }
        ]
      ]
    },
    "Mistral Cloud Chat Model5": {
      "ai_languageModel": [
        [
          {
            "node": "Validador de Ofertas",
            "type": "ai_languageModel",
            "index": 0
          }
        ]
      ]
    },
    "Mistral Cloud Chat Model6": {
      "ai_languageModel": [
        [
          {
            "node": "Clasificador de Tipo de Evaluacion y Proveedor",
            "type": "ai_languageModel",
            "index": 0
          }
        ]
      ]
    },
    "Fetch Project Context Email": {
      "main": [
        [
          {
            "node": "Filter and Aggregate Issues",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Fetch Project Context QA": {
      "main": [
        [
          {
            "node": "Fetch All Provider Responses",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Fetch Project Context Scoring": {
      "main": [
        [
          {
            "node": "Fetch Requirements",
            "type": "main",
            "index": 0
          },
          {
            "node": "Fetch Provider Responses",
            "type": "main",
            "index": 0
          },
          {
            "node": "Fetch Scoring Configuration",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Webhook Tabla": {
      "main": [
        [
          {
            "node": "Set Tabla Params",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Set Tabla Params": {
      "main": [
        [
          {
            "node": "Supabase Get Tabla",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Supabase Get Tabla": {
      "main": [
        [
          {
            "node": "Respond Tabla",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Webhook QA Email Response": {
      "main": [
        [
          {
            "node": "Set QA Email Params",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Set QA Email Params": {
      "main": [
        [
          {
            "node": "Fetch QA Questions",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Fetch QA Questions": {
      "main": [
        [
          {
            "node": "Build AI Context",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Build AI Context": {
      "main": [
        [
          {
            "node": "QA Email Mapping Chain",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "QA Email Mapping Chain": {
      "main": [
        [
          {
            "node": "Parse QA Email Output",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Mistral QA Email Model": {
      "ai_languageModel": [
        [
          {
            "node": "QA Email Mapping Chain",
            "type": "ai_languageModel",
            "index": 0
          }
        ]
      ]
    },
    "Parse QA Email Output": {
      "main": [
        [
          {
            "node": "Respond QA Email Response",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Webhook RFP Generate": {
      "main": [
        [
          {
            "node": "Set RFP Params",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Set RFP Params": {
      "main": [
        [
          {
            "node": "RFP Generation Chain",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "RFP Generation Chain": {
      "main": [
        [
          {
            "node": "Parse RFP Output",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Mistral RFP Model": {
      "ai_languageModel": [
        [
          {
            "node": "RFP Generation Chain",
            "type": "ai_languageModel",
            "index": 0
          }
        ]
      ]
    },
    "Parse RFP Output": {
      "main": [
        [
          {
            "node": "Respond RFP Generate",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Has Economic Evaluation?": {
      "main": [
        [
          {
            "node": "Check If Economic Offer",
            "type": "main",
            "index": 0
          },
          {
            "node": "Preparar Texto de Muestra",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Preparar Texto de Muestra",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Check If Economic Offer": {
      "main": [
        [
          {
            "node": "Extract Economic Data",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Extract Economic Data": {
      "main": [
        [
          {
            "node": "Parse Economic JSON",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Mistral Economic Model": {
      "ai_languageModel": [
        [
          {
            "node": "Extract Economic Data",
            "type": "ai_languageModel",
            "index": 0
          }
        ]
      ]
    },
    "Parse Economic JSON": {
      "main": [
        [
          {
            "node": "Save Economic Offer",
            "type": "main",
            "index": 0
          }
        ]
      ]
    }
  },
  "pinData": {},
  "meta": {
    "templateCredsSetupCompleted": true,
    "instanceId": "53140335eaf11280ef77ef2f5a378f48c2b28e822e3e0d96563cdd92175c0eff"
  }
}