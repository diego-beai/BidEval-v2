{
    "nodes": [
      {
        "parameters": {
          "content": "### Ingesta de RFQ, actualizaci√≥n de requisitos",
          "height": 1280,
          "width": 4390,
          "color": 4
        },
        "type": "n8n-nodes-base.stickyNote",
        "typeVersion": 1,
        "position": [
          -1104,
          -304
        ],
        "id": "fd799bf2-f618-46f3-bd2c-fe3d4610e07e",
        "name": "Sticky Note"
      },
      {
        "parameters": {
          "httpMethod": "POST",
          "path": "86850b01-70b4-4c99-a63a-6ccad35c0be2",
          "responseMode": "responseNode",
          "options": {}
        },
        "type": "n8n-nodes-base.webhook",
        "typeVersion": 2.1,
        "position": [
          -992,
          -96
        ],
        "id": "1e20f158-188b-4ed1-9e6f-0661da9bc2fc",
        "name": "Webhook RFQ",
        "webhookId": "86850b01-70b4-4c99-a63a-6ccad35c0be2"
      },
      {
        "parameters": {
          "jsCode": "// =============================================\n// NODO: Preparar Texto (Agregador de P√°ginas)\n// =============================================\n\nconst items = $input.all();\nif (!items || items.length === 0) {\n    return { json: { error: \"No input items received\" } };\n}\n\n// Recuperar metadatos del inicio del flujo (Generate IDs1)\nlet metadata = {};\ntry {\n    metadata = $('Generate IDs1').first().json;\n} catch (e) {\n    console.log(\"‚ö†Ô∏è No se pudo recuperar metadata de Generate IDs1\");\n}\n\n// 1. Agregado de Texto Completo (todas las p√°ginas)\n// Intentamos md_content primero (mejor para LLMs), luego text\nlet fullText = items.map(item => item.json.md_content || item.json.text || \"\").join('\\n\\n').trim();\n\nif (!fullText) {\n    console.log(\"‚ö†Ô∏è Advertencia: No se extrajo texto del documento.\");\n}\n\n// 2. Limpieza b√°sica\nfullText = fullText.replace(/\\x00/g, ''); // Eliminar caracteres nulos\n\n// 3. Preparar fragmento para clasificaci√≥n (m√°x 40k chars para no saturar context)\nconst textForClassification = fullText.substring(0, 40000);\n\nconsole.log(`‚úÖ Texto preparado: ${items.length} p√°ginas aggregadas. Chars: ${fullText.length}`);\n\nreturn {\n    json: {\n        rfq_project_id: metadata.rfq_project_id || \"unknown\",\n        rfq_document_id: metadata.rfq_document_id || \"unknown\",\n        project_name: metadata.project_name || \"Sin Nombre\",\n        file_title: metadata.file_title || \"document.pdf\",\n        text: fullText, \n        text_for_classification: textForClassification || \"SIN TEXTO DETECTADO\",\n        pages_count: items.length\n    }\n};"
        },
        "type": "n8n-nodes-base.code",
        "typeVersion": 2,
        "position": [
          128,
          -96
        ],
        "id": "e46eacc0-2412-44a8-87ac-5bb431929654",
        "name": "Preparar Texto1"
      },
      {
        "parameters": {
          "promptType": "define",
          "text": "=### DOCUMENTO RFQ\n\nNombre del Archivo: {{ $json.file_title }}\n\n### CONTENIDO (FRAGMENTO):\n{{ $json.pages ? $json.pages.slice(0, 1).map(p => p.text).join('\\n\\n') : ($json.text ? $json.text.substring(0, 2000) : 'SIN TEXTO') }}",
          "hasOutputParser": true,
          "messages": {
            "messageValues": [
              {
                "message": "=## TAREA: CLASIFICAR TIPOS DE EVALUACI√ìN EN DOCUMENTO RFQ Y NOMBRE DEL PROYECTO\n\nEres un auditor experto en documentaci√≥n de ingenier√≠a EPC del sector energ√©tico.\nAnaliza el documento RFQ y determina qu√© tipos de evaluaci√≥n contiene y el nombre del proyecto.\n\n### IMPORTANTE\n\nUn documento puede contener 1, 2, 3 o 4 tipos de evaluaci√≥n.\n**No asumas que est√°n todos.**\nDetecta **SOLO** los que realmente est√°n presentes.\n\n### REGLA DE T√çTULO (CR√çTICA)\n**Si el nombre del archivo o el t√≠tulo del documento es \"RFQ\" o \"Request for quotation\", clasifica autom√°ticamente como \"Technical Evaluation\" Y \"Economical Evaluation\"**, ya que por definici√≥n una licitaci√≥n completa implica evaluar ambos alcances.\n\n### TIPOS POSIBLES\n\n1. **Technical Evaluation**\n\n   **Evidencia requerida:**\n   - Secciones de **Scope of Work**, **Scope of Facilities**, **Technical Requirements**\n   - Requisitos t√©cnicos generales (metodolog√≠a, normativas, est√°ndares)\n   - Descripci√≥n de alcance por fases (PRE-FEED, FEED, EPC, Conceptual, Basic Engineering, Detailed Engineering)\n   - Especificaciones de ingenier√≠a, criterios de dise√±o\n\n2. **Economical Evaluation**\n\n   **Evidencia requerida:**\n   - Tablas de **precios** o **tarifas**\n   - **Hours per discipline**, **EUR/hora**, **USD/hour**, tarifas horarias\n   - Formato de **cotizaci√≥n econ√≥mica**, **pricing schedule**\n   - **Desglose de costos por fase** o por disciplina\n   - Secciones **Commercial**, **Pricing**, **Budget**, **Cost Breakdown**\n\n3. **Pre-FEED Deliverables** (o equivalentes: Conceptual Design Deliverables, Feasibility Deliverables)\n\n   **Evidencia requerida:**\n   - Lista o tabla de documentos a entregar en fase preliminar/conceptual\n   - Organizada por **disciplinas** (Process, Mechanical, Electrical, Civil, I&C, etc.)\n   - Documentos conceptuales: **Basis of Design**, **PFDs**, **P&IDs preliminares**, **Block diagrams**\n   - Estudios: **HAZID**, **Risk Analysis**, **Site Assessment**\n   - **CAPEX Class 3‚Äì5 (AACEI)**, estimaciones preliminares (+/- 30%)\n\n4. **FEED Deliverables** (o equivalentes: Basic Engineering Deliverables)\n\n   **Evidencia requerida:**\n   - Lista o tabla de documentos a entregar en fase FEED/Basic Engineering\n   - Documentos m√°s detallados que en Pre-FEED\n   - **Especificaciones de compra**, **datasheets**, **equipment lists**\n   - **MTO** (Material Take-Off), **cable schedules**, **instrument lists**\n   - **CAPEX Class 2‚Äì3 (AACEI)**, estimaciones m√°s precisas (+/- 15%)\n   - **HAZOP**, **SIL studies**, **3D Model review**\n\n### NOMENCLATURA ALTERNATIVA\n\nEl documento puede usar nombres diferentes para las mismas fases. Aqu√≠ tienes equivalencias:\n\n| Nombre en RFQ | Clasificar como |\n|---------------|-----------------|\n| Pre-FEED, Conceptual Design, Feasibility Study, Phase 1 | Pre-FEED Deliverables |\n| FEED, Basic Engineering, Basic Design, Phase 2 | FEED Deliverables |\n| Technical Proposal, Technical Offer, Scope of Work | Technical Evaluation |\n| Commercial Proposal, Pricing, Cost Estimate, Quotation | Economical Evaluation |\n\n### C√ìMO DIFERENCIAR\n\n| Si ves... | Es probablemente... |\n| --- | --- |\n| **Scope of Work** general, **metodolog√≠a**, requisitos t√©cnicos | **Technical Evaluation** |\n| Tablas de precios, horas, **EUR/h**, tarifas | **Economical Evaluation** |\n| Lista de docs por disciplina + fase preliminar/conceptual | **Pre-FEED Deliverables** |\n| Lista de docs por disciplina + fase FEED/Basic Engineering | **FEED Deliverables** |\n\n### TAREA OBLIGATORIA: IDENTIFICAR NOMBRE DEL PROYECTO\n\nEsta tarea es **obligatoria** y **NO** puede omitirse.\n**Deber√°s devolver SIEMPRE** un valor para `nombre_proyecto`.\n\n### ORDEN DE PRIORIDAD (estricto)\n\n1. **Nombre expl√≠cito del proyecto**\n   - Busca en la **portada** o el **t√≠tulo principal**.\n   - Encabezados repetidos que contengan el nombre del proyecto.\n   - Frases como **Project**, **Project Name**, **Project Title**, **RFQ for...**\n\n2. **Nombre impl√≠cito pero oficial**\n   Si no encuentras un t√≠tulo literal, genera el nombre combinando los siguientes elementos:\n   - Tipo de instalaci√≥n energ√©tica (**Hydrogen Plant**, **PV Plant**, **Solar Plant**, **Wind Farm**, **Battery Storage**, **Power Plant**, **Electrolyzer**, **Substation**, etc.)\n   - Ubicaci√≥n (ciudad, regi√≥n o pa√≠s)\n   - Cliente o **site** si est√° claramente indicado\n   - Capacidad si se menciona (ej: 100 MW, 50 MWp, 20 MW electrolyzer)\n   - Ejemplo: **100 MW Solar PV Plant ‚Äì Andaluc√≠a, Spain**\n\n3. **Fallback obligatorio**\n   Si el documento no declara claramente un nombre:\n   - **NO dejes el campo vac√≠o**.\n   - **NO uses valores gen√©ricos**.\n   - Genera un nombre t√©cnico-descriptivo utilizando:\n     - **Formato obligatorio**: `<Tipo de Proyecto Energ√©tico> ‚Äì <Ubicaci√≥n o Cliente> (RFQ)`\n   - Ejemplo: **Green Hydrogen Production Facility ‚Äì Northern Spain (RFQ)**\n\n### REGLAS DURAS\n\n- **No usar**: Unknown, N/A, Not specified\n- **No inventar nombres comerciales**\n- El nombre debe ser v√°lido para un entorno EPC / PMO del sector energ√©tico\n- Prioriza claridad, trazabilidad y profesionalidad\n\n### FORMATO DE SALIDA (JSON PLANO ‚Äì ESTRICTO)\n\n**ATENCI√ìN: REGLAS DE ESTRUCTURA**\n1. Devuelve **√öNICAMENTE** un objeto JSON que empiece por `{` y termine por `}`.\n2. **PROHIBIDO** devolver el JSON dentro de una lista o array `[]`.\n3. **PROHIBIDO** usar claves contenedoras como `\"output\"`, `\"response\"` o `\"json\"`. El nivel ra√≠z debe tener directamente las claves `tipos_detectados` y `nombre_proyecto`.\n4. No incluyas bloques de c√≥digo markdown (\\`\\`\\`json). Solo el texto plano del JSON.\n\n**FORMATO DE SALIDA CORRECTO:**\n{\n  \"tipos_detectados\": [\"Technical Evaluation\", \"Pre-FEED Deliverables\"],\n  \"nombre_proyecto\": \"Hydrogen Production Plant ‚Äì La Zaida, Spain\",\n  \"razonamiento\": \"El documento incluye un Scope of Work t√©cnico y una lista de documentos para la fase Pre-FEED...\"\n}"
              }
            ]
          },
          "batching": {}
        },
        "type": "@n8n/n8n-nodes-langchain.chainLlm",
        "typeVersion": 1.8,
        "position": [
          -176,
          144
        ],
        "id": "7559e381-bb36-451b-84ed-d0909e155d33",
        "name": "Clasificador de Tipos1"
      },
      {
        "parameters": {
          "model": "mistral:7b",
          "options": {
            "temperature": 0.1
          }
        },
        "type": "@n8n/n8n-nodes-langchain.lmOllama",
        "typeVersion": 1,
        "position": [
          -224,
          368
        ],
        "id": "e55601a3-2366-45cc-86c0-e0a44e145f66",
        "name": "Ollama Clasificador1",
        "credentials": {
          "ollamaApi": {
            "id": "oS2Qqti9oVfsm8XZ",
            "name": "Ollama account"
          }
        }
      },
      {
        "parameters": {
          "schemaType": "manual",
          "inputSchema": "{\n  \"type\": \"object\",\n  \"properties\": {\n    \"tipos_detectados\": {\n      \"type\": \"array\",\n      \"items\": {\n        \"type\": \"string\",\n        \"enum\": [\"Technical Evaluation\", \"Economical Evaluation\", \"Pre-FEED Deliverables\", \"FEED Deliverables\"]\n      }\n    },\n    \"nombre_proyecto\": {\n      \"type\": \"string\",\n      \"description\": \"Nombre del proyecto extra√≠do del documento RFQ\"\n    },\n    \"razonamiento\": {\n      \"type\": \"string\"\n    }\n  },\n  \"required\": [\"tipos_detectados\", \"nombre_proyecto\"]\n}"
        },
        "type": "@n8n/n8n-nodes-langchain.outputParserStructured",
        "typeVersion": 1.3,
        "position": [
          16,
          368
        ],
        "id": "9b342015-9d6f-4609-8673-43aa66a6aad0",
        "name": "Output Parser1"
      },
      {
        "parameters": {
          "jsCode": "// =============================================\n// NODO: Expandir por Tipo (CORREGIDO)\n// =============================================\n\nconst inputItem = $input.first();\nconst inputData = inputItem.json;\n\n// 1. Recuperar metadatos de nodos anteriores (Prioridad)\nlet projectId = \"unknown\";\nlet documentId = \"unknown\";\nlet fileTitle = \"unknown\";\nlet fullText = \"\";\nlet metadataProjectName = \"\";\n\ntry {\n    // Intentamos recuperar del nodo de preparaci√≥n de texto\n    const textNode = $('Preparar Texto1').first().json;\n    projectId = textNode.rfq_project_id || \"unknown\";\n    documentId = textNode.rfq_document_id || \"unknown\";\n    fileTitle = textNode.file_title || \"unknown\";\n    fullText = textNode.text || \"\";\n    metadataProjectName = textNode.project_name || \"\"; \n} catch(e) {\n    console.log(\"‚ö†Ô∏è No se pudieron leer metadatos de Preparar Texto1\");\n}\n\n// 2. Procesar la entrada del Output Parser (IA)\nlet output = {\n    tipos_detectados: [],\n    nombre_proyecto: \"\"\n};\n\n// L√ìGICA DE DETECCI√ìN:\n// A veces el Parser devuelve un objeto directo, a veces una cadena JSON.\nif (inputData && Array.isArray(inputData.tipos_detectados)) {\n    // CASO A: Ya es un objeto v√°lido (el Output Parser funcion√≥ bien)\n    output = inputData;\n} else {\n    // CASO B: Es un string o un objeto malformado, intentamos parsear manualmente\n    let rawText = \"\";\n    \n    if (typeof inputData === 'string') rawText = inputData;\n    else if (inputData.output) rawText = typeof inputData.output === 'string' ? inputData.output : JSON.stringify(inputData.output);\n    else if (inputData.text) rawText = inputData.text;\n    else rawText = JSON.stringify(inputData);\n\n    try {\n        // Limpiar bloques de c√≥digo Markdown ```json ... ```\n        const clean = rawText.replace(/```json/gi, '').replace(/```/g, '').trim();\n        \n        // Intentar encontrar el JSON entre llaves { }\n        const start = clean.indexOf('{');\n        const end = clean.lastIndexOf('}');\n        \n        if (start !== -1 && end !== -1) {\n            output = JSON.parse(clean.substring(start, end + 1));\n        } else {\n            // Intento final parseo directo\n            output = JSON.parse(clean);\n        }\n    } catch (e) {\n        console.log(\"‚ö†Ô∏è Error parseando JSON de la IA. Usando Fallback.\");\n        // No sobreescribimos output con datos falsos, mantenemos estructura vac√≠a\n        output.tipos_detectados = [];\n    }\n}\n\n// 3. Normalizaci√≥n de Datos (Reglas de Negocio)\n\n// Nombre del Proyecto: Prioridad IA > Prioridad Metadata > Fallback Gen√©rico\nlet finalProjectName = output.nombre_proyecto || metadataProjectName;\n\nif (!finalProjectName || finalProjectName === \"Sin Nombre\" || finalProjectName.includes(\"La Zaida\")) {\n    // Fallback inteligente basado en el nombre del archivo\n    finalProjectName = fileTitle.replace(/\\.pdf$/i, '') + \" (Project)\";\n}\n\n// Lista de Tipos\nlet tipos = output.tipos_detectados || [];\nif (!Array.isArray(tipos)) tipos = [];\n\n// REGLA CR√çTICA DE RFQ:\n// Si la lista est√° vac√≠a O si el t√≠tulo dice RFQ, aseguramos los b√°sicos.\nconst titleLower = (fileTitle || \"\").toLowerCase();\nconst isRFQ = titleLower.includes(\"rfq\") || titleLower.includes(\"request for quotation\");\n\nif (tipos.length === 0) {\n    if (isRFQ) {\n        tipos.push(\"Technical Evaluation\", \"Economical Evaluation\");\n        console.log(\"‚ÑπÔ∏è Inferencia: Archivo RFQ detectado, a√±adiendo tipos Technical y Economical.\");\n    } else {\n        // Si no es RFQ expl√≠cito y no detect√≥ nada, por defecto Technical\n        tipos.push(\"Technical Evaluation\");\n    }\n} else if (isRFQ) {\n    // Si detect√≥ cosas pero es un RFQ, nos aseguramos que no falten los principales\n    if (!tipos.includes(\"Technical Evaluation\")) tipos.push(\"Technical Evaluation\");\n    if (!tipos.includes(\"Economical Evaluation\")) tipos.push(\"Economical Evaluation\");\n}\n\n// Eliminar duplicados\ntipos = [...new Set(tipos)];\n\n// 4. Generar Salida (Expandir items)\nreturn tipos.map((tipo, idx) => ({\n    json: {\n        tipo_evaluacion: tipo,\n        rfq_project_id: projectId,\n        rfq_document_id: documentId,\n        nombre_proyecto: finalProjectName,\n        file_title: fileTitle,\n        texto_rfq: fullText, // Pasamos el texto completo para el siguiente paso\n        indice: idx + 1,\n        total_tipos: tipos.length\n    }\n}));"
        },
        "type": "n8n-nodes-base.code",
        "typeVersion": 2,
        "position": [
          784,
          144
        ],
        "id": "05163ff9-5522-480b-a533-1432b027ce68",
        "name": "Expandir por Tipo1"
      },
      {
        "parameters": {
          "options": {}
        },
        "type": "n8n-nodes-base.splitInBatches",
        "typeVersion": 3,
        "position": [
          992,
          144
        ],
        "id": "1c614f6f-c31b-4454-87bb-aaaa3eab21c3",
        "name": "Loop por Tipo1"
      },
      {
        "parameters": {
          "jsCode": "// =============================================\n// NODO: Parsear Final (Con Nombre Proyecto)\n// =============================================\nconst inputJson = $input.first().json;\n// Asegurar que sea string\nlet llmOutput = \"\";\nif (typeof inputJson === 'string') llmOutput = inputJson;\nelse if (inputJson.text && typeof inputJson.text === 'string') llmOutput = inputJson.text;\nelse if (inputJson.output && typeof inputJson.output === 'string') llmOutput = inputJson.output;\nelse if (inputJson.content && typeof inputJson.content === 'string') llmOutput = inputJson.content;\nelse llmOutput = JSON.stringify(inputJson.text || inputJson.output || inputJson.content || inputJson);\n\nllmOutput = String(llmOutput || \"[]\");\n\n// 1. Recuperar Contexto del Loop\nlet projectId = \"unknown\";\nlet documentId = \"unknown\";\nlet tipoEvaluacion = \"Unknown\";\nlet nombreProyecto = \"Sin Nombre\";\n\ntry {\n    const loopData = $('Loop por Tipo1').first().json;\n    projectId = loopData.rfq_project_id;\n    documentId = loopData.rfq_document_id;\n    tipoEvaluacion = loopData.tipo_evaluacion;\n    nombreProyecto = loopData.nombre_proyecto || \"Sin Nombre\";\n} catch(e) {}\n\n// 2. L√≥gica de Parsing\nlet items = [];\n\ntry {\n    let clean = llmOutput.replace(/```json/gi, '').replace(/```/g, '').trim();\n    const start = clean.indexOf('[');\n    const end = clean.lastIndexOf(']');\n    if (start !== -1 && end !== -1) {\n        items = JSON.parse(clean.substring(start, end + 1));\n    }\n} catch(e) {}\n\nif (items.length === 0) {\n    const lines = llmOutput.split('\\n');\n    let currentPhase = \"General\";\n    for (let i = 0; i < lines.length; i++) {\n        const line = lines[i].trim();\n        if (!line) continue;\n        if (/^\\d+\\./.test(line) && !line.includes('Estimate')) {\n            const text = line.replace(/^\\d+\\.\\s*/, '').trim();\n            if (i+1 < lines.length && (lines[i+1].trim().startsWith('-') || lines[i+1].trim().startsWith('‚Ä¢'))) {\n                currentPhase = text;\n            } else {\n                 items.push({ fase: \"General\", requisito_rfq: text });\n            }\n        }\n        else if (line.startsWith('-') || line.startsWith('‚Ä¢')) {\n            items.push({ fase: currentPhase, requisito_rfq: line.replace(/^[-‚Ä¢]\\s*/, '').trim() });\n        }\n    }\n}\n\nfunction generateId(str) {\n    let hash = 0;\n    for (let i = 0; i < str.length; i++) {\n        hash = ((hash << 5) - hash) + str.charCodeAt(i);\n        hash = hash & hash;\n    }\n    return 'item_' + Math.abs(hash).toString(16).padStart(12, '0');\n}\n\nreturn items.map(item => ({\n    json: {\n        rfq_project_id: projectId,\n        project_name: nombreProyecto,\n        rfq_document_id: documentId,\n        evaluation: tipoEvaluacion,\n        fase: item.fase || \"General\",\n        requisito_rfq: item.requisito_rfq || \"Sin Nombre\"\n    }\n}));"
        },
        "type": "n8n-nodes-base.code",
        "typeVersion": 2,
        "position": [
          2560,
          80
        ],
        "id": "239578f0-3a2a-4be8-9411-02fb2d039373",
        "name": "Parsear Items1"
      },
      {
        "parameters": {
          "jsCode": "// =============================================\n// NODO: Agregar Resultados del Tipo Actual\n// =============================================\n\nconst items = $input.all();\n\n// Contar items insertados\nconst totalInserted = items.length;\n\n// Recuperar info del tipo actual\nlet tipoActual = \"unknown\";\ntry {\n    tipoActual = $('Loop por Tipo1').first().json.tipo_evaluacion;\n} catch(e) {}\n\nconsole.log(`‚úÖ Tipo ${tipoActual}: ${totalInserted} items insertados`);\n\nreturn {\n    json: {\n        tipo_procesado: tipoActual,\n        items_insertados: totalInserted,\n        continuar_loop: true\n    }\n};"
        },
        "type": "n8n-nodes-base.code",
        "typeVersion": 2,
        "position": [
          3088,
          272
        ],
        "id": "09942533-1b31-43eb-b653-76c02a638d8f",
        "name": "Agregar Resultados1"
      },
      {
        "parameters": {
          "jsCode": "// =============================================\n// NODO: Resumen Final\n// =============================================\n\n// Recuperar datos del proyecto\nlet projectId = \"unknown\";\nlet fileTitle = \"unknown\";\nlet tiposDetectados = [];\n\ntry {\n    const projectNode = $('Generate IDs1').first().json;\n    projectId = projectNode.rfq_project_id;\n    fileTitle = projectNode.file_title;\n} catch(e) {}\n\ntry {\n    const clasificador = $('Clasificador de Tipos1').first().json;\n    const output = clasificador.output || clasificador;\n    tiposDetectados = output.tipos_detectados || [];\n} catch(e) {}\n\nconsole.log(\"========================================\");\nconsole.log(\"‚úÖ PROCESAMIENTO RFQ COMPLETADO\");\nconsole.log(`   Proyecto: ${projectId}`);\nconsole.log(`   Archivo: ${fileTitle}`);\nconsole.log(`   Tipos procesados: ${tiposDetectados.length}`);\nconsole.log(\"========================================\");\n\nreturn {\n    json: {\n        success: true,\n        rfq_project_id: projectId,\n        file_title: fileTitle,\n        tipos_procesados: tiposDetectados,\n        mensaje: `RFQ procesada correctamente. ${tiposDetectados.length} tipo(s) de evaluaci√≥n detectados y poblados.`\n    }\n};"
        },
        "type": "n8n-nodes-base.code",
        "typeVersion": 2,
        "position": [
          2288,
          -240
        ],
        "id": "70a10156-b662-4528-8e1c-2439378c41fc",
        "name": "Resumen Final1"
      },
      {
        "parameters": {
          "respondWith": "json",
          "responseBody": "={{ JSON.stringify($json) }}",
          "options": {}
        },
        "type": "n8n-nodes-base.respondToWebhook",
        "typeVersion": 1.5,
        "position": [
          2576,
          -240
        ],
        "id": "367348f7-7583-4c13-9db8-c16ab5cd6898",
        "name": "Respond Success1"
      },
      {
        "parameters": {
          "jsCode": "// =============================================\n// NODO: Base64 a Binary\n// =============================================\n\n// Recuperar metadatos del inicio del flujo (Generate IDs1)\nlet inputData = {};\ntry {\n    inputData = $('Generate IDs1').first().json;\n} catch (e) {\n    inputData = $json; // Fallback\n}\n\nconst base64Data = inputData.file_binary;\n\nif (!base64Data || base64Data === \"\") {\n    throw new Error(\"‚ùå CR√çTICO: 'file_binary' est√° vac√≠o\");\n}\n\nconst binaryData = Buffer.from(base64Data, 'base64');\n\nconsole.log(`‚úÖ PDF convertido: ${binaryData.length} bytes`);\n\nreturn {\n    json: {\n        rfq_project_id: inputData.rfq_project_id || \"unknown\",\n        rfq_document_id: inputData.rfq_document_id || \"unknown\",\n        project_name: inputData.project_name || \"Sin Nombre\",\n        file_title: inputData.file_title || \"document.pdf\"\n    },\n    binary: {\n        data: {\n            data: binaryData.toString('base64'),\n            mimeType: 'application/pdf',\n            fileName: inputData.file_title || 'rfq.pdf',\n            fileSize: binaryData.length\n        }\n    }\n};"
        },
        "type": "n8n-nodes-base.code",
        "typeVersion": 2,
        "position": [
          -320,
          -96
        ],
        "id": "08b965b9-7bb6-47d6-b37b-d5cf0eb4b99c",
        "name": "Base64 a Binary3"
      },
      {
        "parameters": {
          "operation": "pdf",
          "options": {}
        },
        "type": "n8n-nodes-base.extractFromFile",
        "typeVersion": 1.1,
        "position": [
          -96,
          -96
        ],
        "id": "3eeb97ef-c3da-43d3-bc0d-fec5ee015fe9",
        "name": "Extract from File3"
      },
      {
        "parameters": {
          "jsCode": "// =============================================\n// NODO: Generate Stable ID + Detectar Modo (CORREGIDO)\n// Con soporte para project_id (UUID) del frontend\n// =============================================\n\nfunction simpleHash(str) {\n  let hash = 0;\n  for (let i = 0; i < str.length; i++) {\n    const char = str.charCodeAt(i);\n    hash = ((hash << 5) - hash) + char;\n    hash = hash & hash;\n  }\n  return Math.abs(hash).toString(16).padStart(16, '0').substring(0, 16);\n}\n\n// Aseguramos capturar el body correctamente desde el nodo anterior\nconst body = $json.body || $json;\n\n// CAMPOS B√ÅSICOS\nconst originalFileId = body.file_id || \"unknown\";\nconst fileTitle = body.file_title || \"unknown.pdf\";\nconst fileBinary = body.file_binary || \"\";\nconst fileUrl = body.file_url || \"unknown\";\n\n// ‚úÖ EXTRAER project_id (UUID) del payload del frontend\nconst projectIdFromPayload = body.project_id || null;\n\n// ‚úÖ EXTRAER METADATA DEL USUARIO\n// Usamos el operador ?. para evitar errores si metadata no existe\nconst metadata = body.metadata || {};\nconst rfqProjectName = metadata.proyect_name || body.project_name || null;\nconst userProveedor = metadata.proveedor || null;\nconst userTipoEval = metadata.evaluation || null; \n\n// ‚úÖ DETERMINAR MODO DE OPERACI√ìN\nlet modoOperacion = \"CLASIFICADOR\"; \nlet datosCompletos = false;\n\nif (userProveedor && userTipoEval && Array.isArray(userTipoEval) && userTipoEval.length > 0) {\n    modoOperacion = \"VALIDADOR\";\n    datosCompletos = true;\n} else if (userProveedor || (userTipoEval && Array.isArray(userTipoEval) && userTipoEval.length > 0)) {\n    modoOperacion = \"HIBRIDO\";\n}\n\n// Generar ID estable basado en el t√≠tulo (como pediste)\nconst normalizedTitle = fileTitle.toLowerCase().trim();\nconst stableId = simpleHash(normalizedTitle);\n\n// ID de Documento (√∫nico por contenido para evitar duplicados en Supabase)\nconst documentId = 'doc_' + stableId;\n\nconsole.log('üìã Generate IDs - project_id from frontend:', projectIdFromPayload);\n\nreturn {\n  json: {\n    file_id: stableId, // Este es tu ID estable\n    rfq_document_id: documentId,\n    file_id_original: originalFileId,\n    file_title: fileTitle,\n    file_binary: fileBinary,\n    file_url: fileUrl,\n    \n    // ‚úÖ project_id (UUID) real del frontend - usado para filtrar por proyecto\n    project_id: projectIdFromPayload,\n    \n    // Si no hay nombre de proyecto, usamos el nombre del archivo como fallback\n    project_name: rfqProjectName || fileTitle.replace(/\\.[^/.]+$/, \"\"),\n    rfq_project_id: projectIdFromPayload || (rfqProjectName ? 'proj_' + simpleHash(rfqProjectName.toLowerCase().trim()) : 'proj_generic'),\n    \n    user_proveedor: userProveedor,\n    user_tipo_evaluacion: userTipoEval,\n    modo_operacion: modoOperacion,\n    datos_usuario_completos: datosCompletos,\n    \n    // Guardamos una copia limpia para los nodos siguientes\n    metadata_limpia: {\n        proyect_name: rfqProjectName,\n        proveedor: userProveedor,\n        evaluation: userTipoEval\n    }\n  }\n};"
        },
        "type": "n8n-nodes-base.code",
        "typeVersion": 2,
        "position": [
          -768,
          -96
        ],
        "id": "247e7f0d-83c8-4c0a-b1ab-23ebb11bcfea",
        "name": "Generate IDs1"
      },
      {
        "parameters": {
          "rules": {
            "values": [
              {
                "conditions": {
                  "options": {
                    "caseSensitive": true,
                    "leftValue": "",
                    "typeValidation": "strict",
                    "version": 3
                  },
                  "conditions": [
                    {
                      "leftValue": "={{ $json.tipo_evaluacion }}",
                      "rightValue": "Evaluation",
                      "operator": {
                        "type": "string",
                        "operation": "contains"
                      },
                      "id": "c3ac36b0-dcd7-4e84-a72a-7e88b6f2fc2a"
                    }
                  ],
                  "combinator": "and"
                }
              },
              {
                "conditions": {
                  "options": {
                    "caseSensitive": true,
                    "leftValue": "",
                    "typeValidation": "strict",
                    "version": 3
                  },
                  "conditions": [
                    {
                      "id": "529ee554-7a05-413a-9782-710d0deb6365",
                      "leftValue": "={{ $json.tipo_evaluacion }}",
                      "rightValue": "Deliverables",
                      "operator": {
                        "type": "string",
                        "operation": "contains"
                      }
                    }
                  ],
                  "combinator": "and"
                }
              }
            ]
          },
          "options": {}
        },
        "type": "n8n-nodes-base.switch",
        "typeVersion": 3.4,
        "position": [
          1888,
          272
        ],
        "id": "0027e70f-d5e7-4a92-b5ba-bd94ab6d1094",
        "name": "Switch1"
      },
      {
        "parameters": {
          "model": "qwen3:8b",
          "options": {
            "temperature": 0.1,
            "numCtx": 8192,
            "numPredict": 2048
          }
        },
        "type": "@n8n/n8n-nodes-langchain.lmOllama",
        "typeVersion": 1,
        "position": [
          2144,
          720
        ],
        "id": "364078e4-795c-4421-8490-327445204c7e",
        "name": "Ollama Extractor2",
        "credentials": {
          "ollamaApi": {
            "id": "oS2Qqti9oVfsm8XZ",
            "name": "Ollama account"
          }
        }
      },
      {
        "parameters": {
          "promptType": "define",
          "text": "=### TAREA: EXTRACCI√ìN MASIVA DE ENTREGABLES (DELIVERABLES)\n\n**OBJETIVO:** Extraer **TODOS** los documentos, planos y entregables listados. **EXHAUSTIVIDAD TOTAL**.\n\n### INSTRUCCIONES CR√çTICAS (NO RESUMIR):\n1. **TABLAS:** Si encuentras una tabla, extrae **CADA FILA**. Si hay 140 filas, devuelve 140 √≠tems.\n2. **NO AGRUPES:** Mant√©n la granularidad.\n3. **FASES:** Infiere la fase/disciplina. Si no, usa 'General'.\n\n### EXTRACCI√ìN DE LISTA DE ENTREGABLES (TEXTO DESORDENADO)\n\n### EXTRACCI√ìN DE LISTA DE ENTREGABLES (TEXTO DESORDENADO)\n\nProyecto: {{ $json.nombre_proyecto }}\nEvaluaci√≥n: {{ $('Loop por Tipo1').item.json.tipo_evaluacion }}\nArchivo: {{ $('Generate IDs1').first().json.file_title }}\n\n### TEXTO DEL PDF:\n{{ $json.texto_chunk }}\n\n### FORMATO DE SALIDA:\n```json\n[\n  { \"fase\": \"Process\", \"requisito_rfq\": \"PFD\" },\n  { \"fase\": \"Civil\", \"requisito_rfq\": \"Foundation Layout\" }\n]\n```\n\n**RESPUESTA (JSON PURO):**",
          "messages": {
            "messageValues": [
              {
                "message": "=Eres una API que devuelve JSON. \n- NO saludes.\n- NO expliques.\n- NO uses markdown fuera del JSON.\n- Tu salida DEBE empezar con `[` y terminar con `]`."
              }
            ]
          },
          "batching": {}
        },
        "type": "@n8n/n8n-nodes-langchain.chainLlm",
        "typeVersion": 1.7,
        "position": [
          2208,
          496
        ],
        "id": "73180c46-8f86-4398-9296-3f1bd8e3356f",
        "name": "LLM Extractor - Deliverables"
      },
      {
        "parameters": {
          "jsCode": "// =============================================\n// NODO: Parsear Deliverables (ROBUST FALLBACK)\n// =============================================\n\nconst inputJson = $input.first().json;\n\n// 1. RECOGIDA DE DATOS RAW\nlet rawOutput = \"\";\nif (inputJson.output && typeof inputJson.output === 'string') rawOutput = inputJson.output;\nelse if (inputJson.text && typeof inputJson.text === 'string') rawOutput = inputJson.text;\nelse if (inputJson.content && typeof inputJson.content === 'string') rawOutput = inputJson.content;\nelse if (typeof inputJson === 'string') rawOutput = inputJson;\n\n// 2. INTENTO A: EXTRAER JSON\nlet items = [];\ntry {\n    const clean = rawOutput.replace(/```json/gi, '').replace(/```/g, '').trim();\n    const start = clean.indexOf('[');\n    const end = clean.lastIndexOf(']');\n    if (start !== -1 && end !== -1) {\n        items = JSON.parse(clean.substring(start, end + 1));\n    }\n} catch(e) {}\n\n// 3. INTENTO B: FALLBACK DE LISTA\nif (items.length === 0 && rawOutput) {\n    const lines = rawOutput.split('\\n');\n    let currentPhase = \"General\";\n    lines.forEach(line => {\n        const trimmed = line.trim();\n        if (!trimmed) return;\n        const numberMatch = trimmed.match(/^\\d+\\.\\s*(.*)/);\n        const bulletMatch = trimmed.match(/^[-‚Ä¢*]\\s*(.*)/);\n        if (numberMatch) {\n            items.push({ fase: currentPhase, requisito_rfq: numberMatch[1] });\n        } else if (bulletMatch) {\n             items.push({ fase: currentPhase, requisito_rfq: bulletMatch[1] });\n        }\n    });\n}\n\n// 4. HELPER: GENERAR ID ESTABLE\nfunction generateId(str) {\n    let hash = 0;\n    for (let i = 0; i < str.length; i++) {\n        hash = ((hash << 5) - hash) + str.charCodeAt(i);\n        hash = hash & hash;\n    }\n    return 'item_' + Math.abs(hash).toString(16).padStart(12, '0');\n}\n\n// 5. NORMALIZAR Y RETORNAR\nlet loopCtx = {};\ntry {\n   const outerLoop = $('Loop por Tipo1').first().json;\n   loopCtx = {\n       rfq_project_id: outerLoop.rfq_project_id,\n       rfq_document_id: outerLoop.rfq_document_id,\n       project_name: outerLoop.nombre_proyecto,\n       tipo_evaluacion: outerLoop.tipo_evaluacion\n   };\n} catch(e){}\n\nreturn items.map(item => {\n    const phase = item.fase || \"General\";\n    const req = item.requisito_rfq || \"Sin Nombre\";\n    return {\n        json: {\n            rfq_project_id: loopCtx.rfq_project_id || \"unknown\",\n            rfq_document_id: loopCtx.rfq_document_id || \"unknown\",\n            project_name: loopCtx.project_name || \"Unknown\",\n            evaluation: loopCtx.tipo_evaluacion || \"Deliverables\",\n            fase: phase,\n            requisito_rfq: req\n        }\n    };\n});"
        },
        "type": "n8n-nodes-base.code",
        "typeVersion": 2,
        "position": [
          2560,
          496
        ],
        "id": "4d086a76-7263-48c7-8769-8a51deb28666",
        "name": "Parsear deliverables"
      },
      {
        "parameters": {
          "model": "qwen3:8b",
          "options": {
            "temperature": 0.1,
            "numCtx": 8192,
            "numPredict": 2048
          }
        },
        "type": "@n8n/n8n-nodes-langchain.lmOllama",
        "typeVersion": 1,
        "position": [
          2144,
          272
        ],
        "id": "4cefb136-ad7b-4bfd-821c-02a3460a213e",
        "name": "Ollama Extractor1",
        "credentials": {
          "ollamaApi": {
            "id": "oS2Qqti9oVfsm8XZ",
            "name": "Ollama account"
          }
        }
      },
      {
        "parameters": {
          "schemaType": "manual",
          "inputSchema": "{\n  \"type\": \"array\",\n  \"items\": {\n    \"type\": \"object\",\n    \"properties\": {\n      \"fase\": {\n        \"type\": \"string\",\n        \"description\": \"Nombre de la disciplina o √°rea (ej: Process Engineering, Mechanical Engineering, Civil and Structural, Electrical Engineering, etc.)\"\n      },\n      \"requisito_rfq\": {\n        \"type\": \"string\",\n        \"description\": \"Nombre del documento o entregable espec√≠fico\"\n      }\n    },\n    \"required\": [\"fase\", \"requisito_rfq\"]\n  }\n}"
        },
        "type": "@n8n/n8n-nodes-langchain.outputParserStructured",
        "typeVersion": 1.3,
        "position": [
          2448,
          704
        ],
        "id": "3fd27669-16f0-4c67-a08a-25991b3db94b",
        "name": "Structured Output Parser1"
      },
      {
        "parameters": {
          "schemaType": "manual",
          "inputSchema": "{\n  \"type\": \"array\",\n  \"items\": {\n    \"type\": \"object\",\n    \"properties\": {\n      \"fase\": {\n        \"type\": \"string\",\n        \"description\": \"Fase del proyecto o disciplina (ej: PRE-FEED, FEED, EPC, Process Engineering, etc.)\"\n      },\n      \"requisito_rfq\": {\n        \"type\": \"string\",\n        \"description\": \"Requisito t√©cnico o econ√≥mico espec√≠fico\"\n      }\n    },\n    \"required\": [\"fase\", \"requisito_rfq\"]\n  }\n}"
        },
        "type": "@n8n/n8n-nodes-langchain.outputParserStructured",
        "typeVersion": 1.3,
        "position": [
          2384,
          272
        ],
        "id": "bf1fbfb4-0c93-482a-aee5-936f4447a6ee",
        "name": "Structured Output Parser2"
      },
      {
        "parameters": {
          "jsCode": "// =============================================\n// NODO: Dividir en Trozos (Chunking)\n// =============================================\n\nconst input = $input.first().json;\nconst fullText = input.texto_rfq || \"\";\n\n// OPTIMIZADO: Chunks m√°s peque√±os para procesamiento m√°s r√°pido\n// ~6000 caracteres (aprox 1.5k-2k tokens) = respuestas en 10-15 seg\nconst chunkSize = 6000;\nconst overlap = 400;\nconst chunks = [];\n\nif (fullText.length <= chunkSize) {\n    chunks.push({\n        ...input,\n        texto_chunk: fullText,\n        chunk_index: 1,\n        total_chunks: 1\n    });\n} else {\n    let start = 0;\n    while (start < fullText.length) {\n        let end = start + chunkSize;\n        let chunk = fullText.substring(start, end);\n        \n        chunks.push({\n            ...input,\n            texto_chunk: chunk,\n            chunk_index: chunks.length + 1\n        });\n\n        start += (chunkSize - overlap);\n        if (start >= fullText.length) break;\n    }\n    chunks.forEach(c => c.total_chunks = chunks.length);\n}\n\nreturn chunks;"
        },
        "type": "n8n-nodes-base.code",
        "typeVersion": 2,
        "position": [
          1280,
          256
        ],
        "id": "0e566018-2fe0-4f48-a281-421c3af4c3eb",
        "name": "Dividir en Trozos1"
      },
      {
        "parameters": {
          "options": {
            "reset": "={{ $json.reiniciar_bucle ? true : false }}"
          }
        },
        "type": "n8n-nodes-base.splitInBatches",
        "typeVersion": 3,
        "position": [
          1632,
          256
        ],
        "id": "ff1dbc0b-fa5f-4431-80cc-2ed422fee6cf",
        "name": "Loop por Trozo1"
      },
      {
        "parameters": {
          "jsCode": "const items = $input.all();\n\nreturn items.map(item => ({\n    json: {\n        ...item.json, // Mantiene todos los datos originales (incluido tipo_evaluacion)\n        \n        // Aqu√≠ est√° la correcci√≥n: Usamos dos puntos, no el igual.\n        reiniciar_bucle: true \n    }\n}));\n"
        },
        "type": "n8n-nodes-base.code",
        "typeVersion": 2,
        "position": [
          1456,
          256
        ],
        "id": "24dee0e5-951c-4182-8bee-494011553f9f",
        "name": "Reset Items1"
      },
      {
        "parameters": {
          "model": "qwen3-embedding:8b"
        },
        "type": "@n8n/n8n-nodes-langchain.embeddingsOllama",
        "typeVersion": 1,
        "position": [
          352,
          368
        ],
        "id": "9e63cb1f-6386-4e96-9368-2d0b1964080e",
        "name": "Embeddings Ollama1",
        "credentials": {
          "ollamaApi": {
            "id": "oS2Qqti9oVfsm8XZ",
            "name": "Ollama account"
          }
        }
      },
      {
        "parameters": {
          "mode": "insert",
          "tableName": {
            "__rl": true,
            "value": "rfq",
            "mode": "list",
            "cachedResultName": "rfq"
          },
          "options": {
            "queryName": "match_rfq"
          }
        },
        "id": "2b7261b1-89d3-4f54-a52f-a6d21bc4075d",
        "name": "Insert into Supabase Vectorstore1",
        "type": "@n8n/n8n-nodes-langchain.vectorStoreSupabase",
        "typeVersion": 1,
        "position": [
          432,
          144
        ],
        "credentials": {
          "supabaseApi": {
            "id": "pI4CpdYLTiEEBmnz",
            "name": "Supabase account"
          }
        }
      },
      {
        "parameters": {
          "chunkSize": 800,
          "chunkOverlap": 150,
          "options": {}
        },
        "type": "@n8n/n8n-nodes-langchain.textSplitterRecursiveCharacterTextSplitter",
        "typeVersion": 1,
        "position": [
          608,
          576
        ],
        "id": "f0ff3957-c0b1-48df-b751-6d1be8c9147d",
        "name": "Recursive Character Text Splitter1"
      },
      {
        "parameters": {
          "jsonMode": "expressionData",
          "jsonData": "={{ $('Preparar Texto1').item.json.text_for_classification }}",
          "options": {
            "metadata": {
              "metadataValues": [
                {
                  "name": "file_id",
                  "value": "={{ $('Generate IDs1').first().json.rfq_document_id }}"
                },
                {
                  "name": "file_title",
                  "value": "={{ $('Generate IDs1').first().json.file_title }}"
                },
                {
                  "name": "tipo_evaluacion",
                  "value": "={{ $('Clasificador de Tipos1').item.json.output.tipos_detectados }}"
                },
                {
                  "name": "tipo-doc",
                  "value": "RFQ"
                }
              ]
            }
          }
        },
        "id": "2a5def6d-d0f9-47e8-9c9f-879e1cd886a6",
        "name": "Default Data Loader1",
        "type": "@n8n/n8n-nodes-langchain.documentDefaultDataLoader",
        "typeVersion": 1,
        "position": [
          528,
          368
        ]
      },
      {
        "parameters": {
          "tableId": "rfq_items_master",
          "fieldsUi": {
            "fieldValues": [
              {
                "fieldId": "project_name",
                "fieldValue": "={{ $json.project_name }}"
              },
              {
                "fieldId": "project_id",
                "fieldValue": "={{ $('Generate IDs1').first().json.project_id }}"
              },
              {
                "fieldId": "evaluation_type",
                "fieldValue": "={{ $json.evaluation }}"
              },
              {
                "fieldId": "phase",
                "fieldValue": "={{ $json.fase }}"
              },
              {
                "fieldId": "requirement_text",
                "fieldValue": "={{ $json.requisito_rfq }}"
              }
            ]
          }
        },
        "type": "n8n-nodes-base.supabase",
        "typeVersion": 1,
        "position": [
          2880,
          272
        ],
        "id": "141c004e-a0d8-4a83-9b58-9b1ee9ca8f06",
        "name": "Create a row",
        "credentials": {
          "supabaseApi": {
            "id": "pI4CpdYLTiEEBmnz",
            "name": "Supabase account"
          }
        }
      },
      {
        "parameters": {
          "operation": "delete",
          "tableId": "rfq",
          "filterType": "string",
          "filterString": "=metadata->>file_id=like.*{{ $json.file_id }}*"
        },
        "id": "61ab864b-c90a-490a-981f-7e2424667f95",
        "name": "Delete Old Doc Rows1",
        "type": "n8n-nodes-base.supabase",
        "typeVersion": 1,
        "position": [
          -544,
          -96
        ],
        "alwaysOutputData": true,
        "credentials": {
          "supabaseApi": {
            "id": "pI4CpdYLTiEEBmnz",
            "name": "Supabase account"
          }
        }
      },
      {
        "parameters": {
          "operation": "upsert",
          "schema": {
            "__rl": true,
            "mode": "list",
            "value": "public"
          },
          "table": {
            "__rl": true,
            "value": "document_metadata",
            "mode": "list",
            "cachedResultName": "document_metadata"
          },
          "columns": {
            "mappingMode": "defineBelow",
            "value": {
              "id": "={{ $('Generate IDs1').first().json.rfq_document_id }}",
              "title": "={{ $('Generate IDs1').first().json.file_title }}",
              "project_name": "={{ $json.output.nombre_proyecto }}",
              "project_id": "={{ $('Generate IDs1').first().json.project_id }}",
              "document_type": "=RFQ",
              "evaluation_types": "={{ $json.output.tipos_detectados }}",
              "provider": "IGNIS"
            },
            "matchingColumns": [
              "id"
            ],
            "schema": [
              {
                "id": "id",
                "displayName": "id",
                "required": true,
                "defaultMatch": true,
                "display": true,
                "type": "string",
                "canBeUsedToMatch": true
              },
              {
                "id": "title",
                "displayName": "title",
                "required": false,
                "defaultMatch": false,
                "display": true,
                "type": "string",
                "canBeUsedToMatch": false
              },
              {
                "id": "project_name",
                "displayName": "project_name",
                "required": false,
                "defaultMatch": false,
                "display": true,
                "type": "string",
                "canBeUsedToMatch": false,
                "removed": false
              },
              {
                "id": "document_type",
                "displayName": "document_type",
                "required": true,
                "defaultMatch": false,
                "display": true,
                "type": "string",
                "canBeUsedToMatch": false,
                "removed": false
              },
              {
                "id": "provider",
                "displayName": "provider",
                "required": false,
                "defaultMatch": false,
                "display": true,
                "type": "string",
                "canBeUsedToMatch": false,
                "removed": false
              },
              {
                "id": "evaluation_types",
                "displayName": "evaluation_types",
                "required": false,
                "defaultMatch": false,
                "display": true,
                "type": "array",
                "canBeUsedToMatch": false,
                "removed": false
              },
              {
                "id": "created_at",
                "displayName": "created_at",
                "required": false,
                "defaultMatch": false,
                "display": true,
                "type": "dateTime",
                "canBeUsedToMatch": false,
                "removed": false
              }
            ],
            "attemptToConvertTypes": false,
            "convertFieldsToString": false
          },
          "options": {}
        },
        "type": "n8n-nodes-base.postgres",
        "typeVersion": 2.5,
        "position": [
          208,
          144
        ],
        "id": "241c1538-006a-43bd-8a9e-d912201209b6",
        "name": "Insert Document Metadata2",
        "executeOnce": true,
        "credentials": {
          "postgres": {
            "id": "V0REAPph5JBLqze3",
            "name": "Postgres account"
          }
        }
      },
      {
        "parameters": {
          "promptType": "define",
          "text": "=### EXTRACCI√ìN DE REQUISITOS RFQ - SOLO √çTEMS EXPL√çCITOS\n\nProyecto: {{ $json.nombre_proyecto }}\nTipo: {{ $json.tipo_evaluacion }}\nArchivo: {{ $json.file_title }}\n\n### TEXTO:\n{{ $json.texto_chunk }}\n\n---\n### INSTRUCCIONES:\n\n**SOLO EXTRAER √çTEMS QUE APARECEN CLARAMENTE EN LISTAS, TABLAS O COMO REQUISITOS EXPL√çCITOS**\n\n#### Para Technical Evaluation:\n- Buscar: \"The vendor shall provide/submit/deliver...\"\n- Buscar: Listas de documentos, entregables o planos\n- NO extraer: Descripciones generales, introducciones, alcance\n\n#### Para Economical Evaluation:  \n- Buscar: \"Item\", \"Line item\", tablas de precios, BOQ\n- Buscar: Partidas espec√≠ficas a cotizar\n- NO extraer: Textos descriptivos sin √≠tems concretos\n\n### REGLAS ESTRICTAS:\n1. **M√çNIMO**: Extraer solo lo que es claramente un requisito/lista\n2. **CONCRETO**: Un √≠tem por cada l√≠nea de lista/tabla\n3. **ESPEC√çFICO**: Si hay duda, NO extraer\n\n### FORMATO:\n```json\n[\n  { \"fase\": \"Disciplina\", \"requisito_rfq\": \"√çtem exacto del texto\" }\n]\n```\n\n**RESPUESTA:**",
          "messages": {
            "messageValues": [
              {
                "message": "=Eres un Extractor de Requisitos de Ingenier√≠a. Tu trabajo es poblar la base de datos maestra de requisitos del proyecto.\nNO inventes datos.\nNO resumas.\nUsa JSON estricto."
              }
            ]
          },
          "batching": {}
        },
        "type": "@n8n/n8n-nodes-langchain.chainLlm",
        "typeVersion": 1.7,
        "position": [
          2192,
          80
        ],
        "id": "ff5a2167-8df6-417e-8acd-1702309dcf11",
        "name": "LLM Extractor Tech-Econ"
      },
      {
        "parameters": {
          "content": "## RFQ Chat - Full Database Access",
          "height": 832,
          "width": 2016,
          "color": 3
        },
        "type": "n8n-nodes-base.stickyNote",
        "typeVersion": 1,
        "position": [
          -3232,
          -1984
        ],
        "id": "21c64fd6-5b0e-4953-9d83-ff82c62ffeb8",
        "name": "Sticky Note4"
      },
      {
        "parameters": {
          "options": {}
        },
        "type": "n8n-nodes-base.respondToWebhook",
        "typeVersion": 1.5,
        "position": [
          -1472,
          -1792
        ],
        "id": "74b599ba-f6bb-4f60-ac51-5d6d71516797",
        "name": "Respond to Webhook5"
      },
      {
        "parameters": {
          "model": "qwen3:8b",
          "options": {
            "temperature": 0.2,
            "numCtx": 8192,
            "numPredict": 1024
          }
        },
        "type": "@n8n/n8n-nodes-langchain.lmChatOllama",
        "typeVersion": 1,
        "position": [
          -2944,
          -1424
        ],
        "id": "493d58c5-f2fe-4a34-b4ab-30703a92a002",
        "name": "Ollama Chat Model3",
        "credentials": {
          "ollamaApi": {
            "id": "oS2Qqti9oVfsm8XZ",
            "name": "Ollama account"
          }
        }
      },
      {
        "parameters": {
          "httpMethod": "POST",
          "path": "chat-rfq",
          "responseMode": "responseNode",
          "options": {}
        },
        "type": "n8n-nodes-base.webhook",
        "typeVersion": 2.1,
        "position": [
          -3120,
          -1792
        ],
        "id": "09dcb2b7-aee2-457c-b6b3-aefea7433f9d",
        "name": "Webhook1",
        "webhookId": "chat-rfq"
      },
      {
        "parameters": {
          "sessionIdType": "customKey",
          "sessionKey": "={{ $json.body.sessionId }}"
        },
        "id": "77aed5c3-d23c-4fe3-b0a6-c88428057db2",
        "name": "Postgres Chat Memory",
        "type": "@n8n/n8n-nodes-langchain.memoryPostgresChat",
        "typeVersion": 1,
        "position": [
          -2768,
          -1568
        ],
        "notesInFlow": false,
        "credentials": {
          "postgres": {
            "id": "V0REAPph5JBLqze3",
            "name": "Postgres account"
          }
        }
      },
      {
        "parameters": {
          "model": "qwen3-embedding:8b"
        },
        "type": "@n8n/n8n-nodes-langchain.embeddingsOllama",
        "typeVersion": 1,
        "position": [
          -2272,
          -1360
        ],
        "id": "a56a2011-824a-423a-857c-b6530915c07d",
        "name": "Embeddings Ollama",
        "credentials": {
          "ollamaApi": {
            "id": "oS2Qqti9oVfsm8XZ",
            "name": "Ollama account"
          }
        }
      },
      {
        "parameters": {
          "promptType": "define",
          "text": "={{ $json.body.chatInput }}",
          "options": {
            "systemMessage": "=CRITICAL RULES - YOU MUST FOLLOW THESE:\n1. ALWAYS respond in ENGLISH only. Never respond in Spanish or any other language.\n2. NEVER use emojis or emoticons in your responses.\n\nYou are an expert assistant specialized in analyzing vendor proposals for RFQ evaluations.\n\nVENDORS: IDOM, SACYR, TECNICASREUNIDAS (TR), EA, SENER, TRESCA, WORLEY\n\n## AVAILABLE TOOLS\n\n### Vector Search Tools (for narrative/document content):\n- **consultar_ofertas_proveedores**: Search vendor proposal documents for detailed text, technical descriptions, and narrative content.\n- **consultar_documentos_rfq**: Search original RFQ documents for client requirements and specifications.\n\n### SQL Tools (for structured data):\n- **query_requirements**: Query rfq_items_master with provider_responses. Returns: requirement_text, evaluation_type (Technical/Economical/Pre-FEED/FEED), phase, provider evaluations (evaluation_value, score, comment).\n- **query_provider_responses**: Query provider_responses table. Filter by provider_name to get detailed vendor responses with scores and comments.\n- **query_ranking**: Query ranking_proveedores table. Returns: overall_score (0-10), cumplimiento_porcentual (compliance %), technical_score, economical_score, pre_feed_score, feed_score.\n- **query_qa_audit**: Query qa_audit table. Filter by: provider, discipline (Electrica/Mecanica/Civil/Proceso/General), status, or all.\n\n## TOOL SELECTION GUIDE\n\n| Question Type | Tool to Use |\n|---------------|-------------|\n| Overall ranking, who is best? | query_ranking |\n| Category scores (technical, economic) | query_ranking |\n| Requirement compliance details | query_requirements |\n| Vendor comments on requirements | query_provider_responses |\n| Pending Q&A questions | query_qa_audit |\n| Document text, technical details | consultar_ofertas_proveedores |\n| Original RFQ specifications | consultar_documentos_rfq |\n\n## SCORING WEIGHTS\n- **Technical Score (40%)**: Technical evaluation criteria\n- **Economical Score (30%)**: Economic/pricing evaluation\n- **Pre-FEED Score (15%)**: Pre-FEED deliverables evaluation\n- **FEED Score (15%)**: FEED deliverables evaluation\n\n## INSTRUCTIONS\n1. ALWAYS use tools to retrieve data before answering. Never guess.\n2. For comparisons, query multiple sources if needed.\n3. Be concise (2-3 sentences max).\n4. Remember: English only, no emojis."
          }
        },
        "id": "c47e2351-6ffb-47c6-8d80-a1c684426096",
        "name": "Chat AI Agent",
        "type": "@n8n/n8n-nodes-langchain.agent",
        "typeVersion": 1.6,
        "position": [
          -2240,
          -1792
        ]
      },
      {
        "parameters": {
          "mode": "retrieve-as-tool",
          "toolName": "consultar_ofertas_proveedores",
          "toolDescription": "Search vendor technical proposals for narrative content, technical descriptions, pricing details, and compliance explanations. Use when you need detailed text from proposal documents.",
          "tableName": {
            "__rl": true,
            "value": "proposals",
            "mode": "list",
            "cachedResultName": "proposals"
          },
          "topK": 10,
          "options": {
            "queryName": "match_proposals"
          }
        },
        "type": "@n8n/n8n-nodes-langchain.vectorStoreSupabase",
        "typeVersion": 1,
        "position": [
          -2640,
          -1568
        ],
        "id": "eda1e47f-6721-464e-a1ad-cd48c006319c",
        "name": "Revisar-ofertas",
        "credentials": {
          "supabaseApi": {
            "id": "pI4CpdYLTiEEBmnz",
            "name": "Supabase account"
          }
        }
      },
      {
        "parameters": {
          "mode": "retrieve-as-tool",
          "toolName": "consultar_documentos_rfq",
          "toolDescription": "Search original RFQ documents for client requirements, technical specifications, scope of work, and tender documentation. Use when you need the original request details.",
          "tableName": {
            "__rl": true,
            "value": "rfq",
            "mode": "list",
            "cachedResultName": "rfq"
          },
          "topK": 10,
          "options": {
            "queryName": "match_rfq"
          }
        },
        "type": "@n8n/n8n-nodes-langchain.vectorStoreSupabase",
        "typeVersion": 1,
        "position": [
          -2352,
          -1568
        ],
        "id": "4d1b0971-5b79-446d-88a7-97b4ea12de23",
        "name": "Revisar RFQs",
        "credentials": {
          "supabaseApi": {
            "id": "pI4CpdYLTiEEBmnz",
            "name": "Supabase account"
          }
        }
      },
      {
        "parameters": {
          "model": "qwen3-embedding:8b"
        },
        "type": "@n8n/n8n-nodes-langchain.embeddingsOllama",
        "typeVersion": 1,
        "position": [
          -2560,
          -1360
        ],
        "id": "d9e8c13d-a711-4121-86eb-32bd51832987",
        "name": "Embeddings Ollama5",
        "credentials": {
          "ollamaApi": {
            "id": "oS2Qqti9oVfsm8XZ",
            "name": "Ollama account"
          }
        }
      },
      {
        "parameters": {
          "descriptionType": "manual",
          "toolDescription": "Query RFQ requirements with optional vendor responses. Use to find: requirement_text, evaluation_type (Technical/Economical/Pre-FEED/FEED), phase, and provider evaluations. Provide a search_term to filter requirements.",
          "operation": "executeQuery",
          "query": "SELECT rim.id, rim.evaluation_type, rim.phase, rim.requirement_text, pr.provider_name, pr.evaluation_value, pr.score, pr.comment FROM rfq_items_master rim LEFT JOIN provider_responses pr ON rim.id = pr.requirement_id WHERE (rim.requirement_text ILIKE '%' || $1 || '%' OR rim.evaluation_type ILIKE '%' || $1 || '%') AND ($2 = '' OR rim.project_id::text = $2) ORDER BY rim.id LIMIT 30;",
          "options": {
            "queryReplacement": "={{ $fromAI('search_term', 'Keyword to search in requirements', 'string') }}, {{ $json.body.project_id || '' }}"
          }
        },
        "type": "n8n-nodes-base.postgresTool",
        "typeVersion": 2.5,
        "position": [
          -2064,
          -1568
        ],
        "id": "f1b7553b-3e15-4ecd-9079-4eab623cfe6b",
        "name": "query_requirements",
        "credentials": {
          "postgres": {
            "id": "V0REAPph5JBLqze3",
            "name": "Postgres account"
          }
        }
      },
      {
        "parameters": {
          "descriptionType": "manual",
          "toolDescription": "Query detailed vendor responses with scores and comments. Use to find: evaluation_value, score (numeric), comment, provider_name. Provide provider_name to filter by vendor (IDOM, SACYR, TECNICASREUNIDAS, EA, SENER, TRESCA, WORLEY) or leave empty for all.",
          "operation": "executeQuery",
          "query": "SELECT pr.id, pr.provider_name, pr.evaluation_value, pr.score, pr.comment, rim.requirement_text, rim.evaluation_type, rim.phase FROM provider_responses pr LEFT JOIN rfq_items_master rim ON pr.requirement_id = rim.id WHERE ($1 = '' OR pr.provider_name ILIKE '%' || $1 || '%') AND ($2 = '' OR pr.project_id::text = $2) ORDER BY pr.provider_name LIMIT 30;",
          "options": {
            "queryReplacement": "={{ $fromAI('provider_name', 'Provider name to filter (or empty for all)', 'string') }}, {{ $json.body.project_id || '' }}"
          }
        },
        "type": "n8n-nodes-base.postgresTool",
        "typeVersion": 2.5,
        "position": [
          -1936,
          -1568
        ],
        "id": "a1cc2b56-5c0b-4d68-ba12-afff54be37e2",
        "name": "query_provider_responses",
        "credentials": {
          "postgres": {
            "id": "V0REAPph5JBLqze3",
            "name": "Postgres account"
          }
        }
      },
      {
        "parameters": {
          "descriptionType": "manual",
          "toolDescription": "Query vendor rankings and scores. Returns: provider_name, overall_score (0-10), cumplimiento_porcentual (compliance %), and category scores: technical_score (40% weight), economical_score (30% weight), pre_feed_score (15%), feed_score (15%). Use for ranking questions and score comparisons.",
          "operation": "executeQuery",
          "query": "SELECT rp.provider_name, rp.overall_score, rp.cumplimiento_porcentual, rp.technical_score, rp.economical_score, rp.pre_feed_score, rp.feed_score, rp.evaluation_count, rp.last_updated FROM ranking_proveedores rp WHERE ($1 = '' OR rp.project_id::text = $1) ORDER BY rp.overall_score DESC;",
          "options": {
            "queryReplacement": "={{ $json.body.project_id || '' }}"
          }
        },
        "type": "n8n-nodes-base.postgresTool",
        "typeVersion": 2.5,
        "position": [
          -1808,
          -1568
        ],
        "id": "4dea681a-305e-4ca1-8fad-0c4fce9dbf62",
        "name": "query_ranking",
        "credentials": {
          "postgres": {
            "id": "V0REAPph5JBLqze3",
            "name": "Postgres account"
          }
        }
      },
      {
        "parameters": {
          "descriptionType": "manual",
          "toolDescription": "Query Q&A audit for technical questions and responses. Returns: provider_name, discipline (Electrica/Mecanica/Civil/Proceso/General), question, status (Pending/Approved/etc.), importance (High/Medium/Low), response. Use filter_type: 'provider' with filter_value for vendor name, 'discipline' for discipline, 'status' for status, or 'all' for everything.",
          "operation": "executeQuery",
          "query": "SELECT qa.id, qa.provider_name, qa.discipline, qa.question, qa.status, qa.importance, qa.response, qa.created_at FROM qa_audit qa WHERE (($1 = 'all') OR ($1 = 'provider' AND qa.provider_name ILIKE '%' || $2 || '%') OR ($1 = 'discipline' AND qa.discipline ILIKE '%' || $2 || '%') OR ($1 = 'status' AND qa.status ILIKE '%' || $2 || '%')) AND ($3 = '' OR qa.project_id::text = $3) ORDER BY qa.created_at DESC LIMIT 25;",
          "options": {
            "queryReplacement": "={{ $fromAI('filter_type', 'Filter type: provider, discipline, status, or all', 'string') }}, {{ $fromAI('filter_value', 'Value to filter by (provider name, discipline, or status)', 'string') }}, {{ $json.body.project_id || '' }}"
          }
        },
        "type": "n8n-nodes-base.postgresTool",
        "typeVersion": 2.5,
        "position": [
          -1680,
          -1568
        ],
        "id": "d5a4af82-309b-475e-a950-9137266e2d5d",
        "name": "query_qa_audit",
        "credentials": {
          "postgres": {
            "id": "V0REAPph5JBLqze3",
            "name": "Postgres account"
          }
        }
      },
      {
        "parameters": {
          "model": "mistral-large-latest",
          "options": {}
        },
        "type": "@n8n/n8n-nodes-langchain.lmChatMistralCloud",
        "typeVersion": 1,
        "position": [
          -2144,
          -1344
        ],
        "id": "3cbca2c5-c006-4367-9e92-d2f812a63482",
        "name": "Mistral Cloud Chat Model2",
        "credentials": {
          "mistralCloudApi": {
            "id": "tDjuOnF6lpADMmd5",
            "name": "Mistral Cloud account"
          }
        }
      },
      {
        "parameters": {
          "options": {
            "temperature": 0.1
          }
        },
        "type": "@n8n/n8n-nodes-langchain.lmChatOpenRouter",
        "typeVersion": 1,
        "position": [
          -2048,
          -1248
        ],
        "id": "238cfa05-8516-4ec8-905e-49eb5dd07d95",
        "name": "OpenRouter Chat Model",
        "credentials": {
          "openRouterApi": {
            "id": "4AyUqsh1Z35g6bci",
            "name": "OpenRouter account"
          }
        }
      },
      {
        "parameters": {
          "operation": "getAll",
          "tableId": "rfq_items_master",
          "returnAll": true,
          "matchType": "allFilters",
          "filters": {
            "conditions": [
              {
                "keyName": "evaluation_type",
                "condition": "eq",
                "keyValue": "={{ $json.tipo_evaluacion_actual }}"
              },
              {
                "keyName": "project_id",
                "condition": "eq",
                "keyValue": "={{ $('Set File ID').first().json.project_id }}"
              }
            ]
          }
        },
        "type": "n8n-nodes-base.supabase",
        "typeVersion": 1,
        "position": [
          -128,
          -1808
        ],
        "id": "143470e8-5d82-4f38-af2e-8d0dc68f8a48",
        "name": "Get many rows1",
        "credentials": {
          "supabaseApi": {
            "id": "pI4CpdYLTiEEBmnz",
            "name": "Supabase account"
          }
        }
      },
      {
        "parameters": {
          "model": "qwen3-embedding:8b"
        },
        "type": "@n8n/n8n-nodes-langchain.embeddingsOllama",
        "typeVersion": 1,
        "position": [
          2912,
          -704
        ],
        "id": "69cf4c8a-eae2-4578-b377-a729c63a5039",
        "name": "Embeddings Ollama3",
        "credentials": {
          "ollamaApi": {
            "id": "oS2Qqti9oVfsm8XZ",
            "name": "Ollama account"
          }
        }
      },
      {
        "parameters": {
          "promptType": "define",
          "text": "=### DOCUMENT AUDIT: CROSS-VALIDATION\n\n**[1. USER MANUAL SELECTION]**\n- Project: \"{{ $('Set File ID').item.json.proyect_name }}\"\n- Provider: \"{{ $('Set File ID').item.json.proveedor }}\"\n- Evaluation Type: \"{{ $('Set File ID').item.json.evaluation }}\"\n- File Name: \"{{ $('Set File ID').item.json.file_title }}\"\n\n---\n**[2. ACTUAL PDF EVIDENCE (Extracted text)]**\n{{ $json.texto_muestra }}\n\n---\n### MAPPING AND VALIDATION INSTRUCTIONS:\n\n#### RULE 1: SYNONYMS AND CANONICAL TYPES\nYou can only use these 4 exact names. Map the evidence as follows:\n- **\"Commercial Proposal\" / \"Oferta Econ√≥mica\" / \"Price Schedule\"** ‚Üí MUST BE `Economical Evaluation`.\n- **\"Technical Proposal\" / \"Scope of Work\" / \"Metodolog√≠a\"** ‚Üí MUST BE `Technical Evaluation`.\n- **\"Technical & Economical Proposal\"** ‚Üí MUST INCLUDE BOTH: `Technical Evaluation` AND `Economical Evaluation`.\n- **Drawing lists** ‚Üí `Pre-FEED Deliverables` or `FEED Deliverables`.\n\n#### RULE 2: TITLE AND FILE NAME ARE DECISIVE\n- Analyze the **File Name** and **Title** of the document. If they say \"Oferta T√©cnica\" or \"Technical Proposal\", the type is `Technical Evaluation`.\n- **IMPORTANT:** DO NOT add other types for minor mentions. Example: If a technical document mentions \"estimated prices\", DO NOT add `Economical Evaluation`. Only add it if you see a complete PRICE TABLE.\n- Be conservative: when in doubt, follow the File Name.\n\n#### RULE 3: INTENTION BALANCING\n- If the PDF is mixed but the user has selected one of the valid types present, mark `tipos_validados: true`.\n\n### OUTPUT FORMAT (SINGLE JSON):\n{\n  \"modo_usado\": \"VALIDADOR\",\n  \"proyecto_detectado\": \"Actual Name\",\n  \"proyecto_valido\": true | false,\n  \"proyecto_nota\": \"Summary\",\n  \"proveedor_detectado\": \"IDOM | SENER | TRESCA | SACYR | TECNICASREUNIDAS | EA | WORLEY\",\n  \"proveedor_valido\": true | false,\n  \"proveedor_nota\": \"Explanation\",\n  \"tipos_detectados\": [\"Technical Evaluation\", \"Economical Evaluation\", \"Pre-FEED Deliverables\", \"FEED Deliverables\"],\n  \"tipos_validados\": true | false,\n  \"tipos_nota\": \"Explain why you validated or rejected the types.\",\n  \"razonamiento\": \"Mention the File Name and Title found.\"\n}",
          "hasOutputParser": true,
          "messages": {
            "messageValues": [
              {
                "message": "=Act as a strict validator. If there are flagrant discrepancies between the user's suggestion and the actual PDF content, prioritize the PDF content and mark validation as false and report the correct provider/type.\n\nSupported providers: Tecnicas Reunidas, IDOM, SACYR, Empresarios Agrupados, SENER, TRESCA, WORLEY"
              }
            ]
          },
          "batching": {}
        },
        "type": "@n8n/n8n-nodes-langchain.chainLlm",
        "typeVersion": 1.8,
        "position": [
          2416,
          -1168
        ],
        "id": "66fe79eb-8857-451b-b875-5e81a9815f9d",
        "name": "Validador de Ofertas"
      },
      {
        "parameters": {
          "model": "mistral:7b",
          "options": {
            "temperature": 0.1,
            "numCtx": 4096,
            "numPredict": 1024
          }
        },
        "type": "@n8n/n8n-nodes-langchain.lmChatOllama",
        "typeVersion": 1,
        "position": [
          2368,
          -976
        ],
        "id": "eb08eb5f-09ad-46ee-b565-f49a6ceafcca",
        "name": "Ollama Chat Model1",
        "credentials": {
          "ollamaApi": {
            "id": "oS2Qqti9oVfsm8XZ",
            "name": "Ollama account"
          }
        }
      },
      {
        "parameters": {
          "schemaType": "manual",
          "inputSchema": "{\n  \"type\": \"object\",\n  \"properties\": {\n    \"modo_usado\": {\n      \"type\": \"string\"\n    },\n    \"proyecto_detectado\": {\n      \"type\": \"string\"\n    },\n    \"proyecto_valido\": {\n      \"type\": \"boolean\"\n    },\n    \"proyecto_nota\": {\n      \"type\": \"string\"\n    },\n    \"proveedor_detectado\": {\n      \"type\": \"string\"\n    },\n    \"proveedor_valido\": {\n      \"type\": \"boolean\",\n      \"description\": \"DEBE ser false si el proveedor detectado es distinto al que el usuario seleccion√≥.\"\n    },\n    \"proveedor_nota\": {\n      \"type\": \"string\"\n    },\n    \"tipos_detectados\": {\n      \"type\": \"array\",\n      \"items\": {\n        \"type\": \"string\"\n      },\n      \"description\": \"Array con los tipos que realmente tienen evidencia en el doc.\"\n    },\n    \"tipos_validados\": {\n      \"type\": \"boolean\",\n      \"description\": \"DEBE ser false si el tipo seleccionado por el usuario no tiene evidencia clara en el PDF.\"\n    },\n    \"tipos_nota\": {\n      \"type\": \"string\"\n    },\n    \"razonamiento\": {\n      \"type\": \"string\"\n    }\n  },\n  \"required\": [\n    \"proyecto_detectado\",\n    \"proyecto_valido\",\n    \"proveedor_detectado\",\n    \"proveedor_valido\",\n    \"tipos_validados\",\n    \"razonamiento\"\n  ]\n}"
        },
        "type": "@n8n/n8n-nodes-langchain.outputParserStructured",
        "typeVersion": 1.3,
        "position": [
          2608,
          -976
        ],
        "id": "2ce3d06d-4879-483f-97c4-d9ccd3ed41b9",
        "name": "Structured Output Parser4"
      },
      {
        "parameters": {
          "promptType": "define",
          "text": "=### TECHNICAL AND COMMERCIAL CLASSIFICATION (RFQ)\n\n### DOCUMENT SAMPLE (First 2 pages):\n{{ $json.texto_muestra }}\n\n---\n### CLASSIFICATION TASK:\nIdentify project, provider and evaluation types.\n\n**GOLDEN RULE FOR NOMENCLATURE:**\nYou must translate document titles to these exact names:\n- **\"Commercial Proposal\" / \"Oferta Econ√≥mica\"** ‚Üí MUST BE `Economical Evaluation`.\n- **\"Technical Proposal\" / \"Scope of Work\"** ‚Üí MUST BE `Technical Evaluation`.\n- **Document lists** ‚Üí `Pre-FEED Deliverables` or `FEED Deliverables` (depending on context).\n\n#### REQUIREMENTS:\n1. **PROVIDER**: Must be one of: IDOM, SENER, TRESCA, SACYR, TECNICASREUNIDAS, EA, WORLEY.\n2. **TYPES**: The `tipos_detectados` array can only contain the canonical names mentioned above.\n\n---\n### OUTPUT FORMAT (JSON):\n{\n  \"modo_usado\": \"CLASIFICADOR\",\n  \"proyecto_detectado\": \"Name\",\n  \"proveedor_detectado\": \"IDOM | SENER | TRESCA | SACYR | TECNICASREUNIDAS | EA | WORLEY\",\n  \"tipos_detectados\": [\"Technical Evaluation\", \"Economical Evaluation\"],\n  \"razonamiento\": \"Justification: 'Commercial Proposal' detected -> Economical Evaluation mapped.\"\n}",
          "hasOutputParser": true,
          "messages": {
            "messageValues": [
              {
                "message": "Identify the provider and evaluation types present in the document based only on the first pages."
              }
            ]
          },
          "batching": {}
        },
        "type": "@n8n/n8n-nodes-langchain.chainLlm",
        "typeVersion": 1.8,
        "position": [
          2416,
          -736
        ],
        "id": "e1cf988b-fb87-4107-b4ba-c1031b414555",
        "name": "Clasificador de Tipo de Evaluacion y Proveedor"
      },
      {
        "parameters": {
          "conditions": {
            "options": {
              "caseSensitive": true,
              "leftValue": "",
              "typeValidation": "strict",
              "version": 3
            },
            "conditions": [
              {
                "id": "267128b5-e2c0-44ae-9973-7f18dffe292e",
                "leftValue": "={{ $('Set File ID').item.json.proveedor }}",
                "rightValue": "",
                "operator": {
                  "type": "string",
                  "operation": "notEmpty",
                  "singleValue": true
                }
              },
              {
                "id": "a9d65ff4-430e-45db-8ca8-6078e5ee32fa",
                "leftValue": "={{ $('Set File ID').item.json.evaluation[0] }}",
                "rightValue": "",
                "operator": {
                  "type": "string",
                  "operation": "notEmpty",
                  "singleValue": true
                }
              },
              {
                "id": "d5c265e7-00e5-42f4-95ad-4eca1e3ef530",
                "leftValue": "={{ $('Set File ID').item.json.proyect_name }}",
                "rightValue": "",
                "operator": {
                  "type": "string",
                  "operation": "notEmpty",
                  "singleValue": true
                }
              }
            ],
            "combinator": "and"
          },
          "options": {}
        },
        "type": "n8n-nodes-base.if",
        "typeVersion": 2.3,
        "position": [
          2144,
          -976
        ],
        "id": "9d1e1d88-8dc5-4398-9b34-96f9e982a4de",
        "name": "If"
      },
      {
        "parameters": {
          "model": "qwen3:8b",
          "options": {
            "temperature": 0.1,
            "numCtx": 8192,
            "numPredict": 1536
          }
        },
        "type": "@n8n/n8n-nodes-langchain.lmOllama",
        "typeVersion": 1,
        "position": [
          2128,
          -1536
        ],
        "id": "20ae60ae-49ac-47de-8a92-820116f10455",
        "name": "Ollama Model1",
        "credentials": {
          "ollamaApi": {
            "id": "oS2Qqti9oVfsm8XZ",
            "name": "Ollama account"
          }
        }
      },
      {
        "parameters": {
          "model": "mistral:7b",
          "options": {
            "temperature": 0.1,
            "numCtx": 4096,
            "numPredict": 1024
          }
        },
        "type": "@n8n/n8n-nodes-langchain.lmOllama",
        "typeVersion": 1,
        "position": [
          2368,
          -528
        ],
        "id": "a53ee540-5a78-488d-b5c9-d8700b0f6838",
        "name": "Ollama Model",
        "credentials": {
          "ollamaApi": {
            "id": "oS2Qqti9oVfsm8XZ",
            "name": "Ollama account"
          }
        }
      },
      {
        "parameters": {
          "content": "### Ingesta de Ofertas de Proveedores",
          "height": 1744,
          "width": 4608,
          "color": 5
        },
        "type": "n8n-nodes-base.stickyNote",
        "typeVersion": 1,
        "position": [
          -1104,
          -2128
        ],
        "id": "5a1f5e66-a7b6-4d43-8d88-2fec03a62f79",
        "name": "Sticky Note5"
      },
      {
        "parameters": {
          "batchSize": 50,
          "options": {
            "reset": "={{ $json.reiniciar_bucle ? true : false }}"
          }
        },
        "type": "n8n-nodes-base.splitInBatches",
        "typeVersion": 3,
        "position": [
          704,
          -1744
        ],
        "id": "01603f44-2a71-4f92-b685-5195df21525d",
        "name": "Loop Over Phases"
      },
      {
        "parameters": {
          "jsCode": "// =============================================\n// NODO: Parsear y Preparar Update (SIN quoted_value)\n// =============================================\n\n// 1. Obtener TODOS los items del LLM Chain\nconst allItems = $input.all();\nconsole.log(`üì• Procesando ${allItems.length} respuestas del LLM`);\n\n// 2. Obtener la lista de requisitos V√ÅLIDOS (para validar FK)\nlet validRequirements = [];\ntry {\n  const getRowsData = $('Get many rows1').all();\n  validRequirements = getRowsData.map(item => item.json.id);\n  console.log(`‚úÖ Lista de requisitos v√°lidos: ${validRequirements.length} items`);\n} catch(e) {\n  console.error('‚ùå Error obteniendo lista de requisitos v√°lidos:', e.message);\n  return [];\n}\n\n// 3. Obtener el provider name (una sola vez, es el mismo para todos)\nlet providerName = \"OTROS\";\ntry {\n  providerName = $('Expandir por Tipo de Evaluaci√≥n').first().json.proveedor_detectado || \"OTROS\";\n} catch(e) {\n  console.warn('‚ö†Ô∏è Error obteniendo provider, usando default:', e.message);\n}\n\n// 4. Procesar CADA respuesta del LLM\nconst resultados = [];\n\nfor (let i = 0; i < allItems.length; i++) {\n  try {\n    const item = allItems[i];\n    const itemData = item.json || item;\n\n    let rawText = itemData.text || itemData.output || \"\";\n\n    if (!rawText || typeof rawText !== 'string') {\n      console.warn(`‚ö†Ô∏è Item ${i}: No se encontr√≥ campo 'text' o 'output'`);\n      continue;\n    }\n\n    let cleanText = rawText\n      .replace(/```json/g, '')\n      .replace(/```/g, '')\n      .trim();\n\n    let parsedData = null;\n\n    try {\n      const start = cleanText.indexOf('[');\n      const end = cleanText.lastIndexOf(']');\n\n      if (start >= 0 && end >= 0 && end > start) {\n        const jsonString = cleanText.substring(start, end + 1);\n        parsedData = JSON.parse(jsonString);\n      } else {\n        parsedData = JSON.parse(cleanText);\n      }\n    } catch (parseError) {\n      console.error(`‚ùå Error parseando JSON del item ${i}:`, parseError.message);\n      console.error(`Texto recibido:`, cleanText.substring(0, 200));\n      continue;\n    }\n\n    const outputArray = Array.isArray(parsedData) ? parsedData : [parsedData];\n\n    for (let j = 0; j < outputArray.length; j++) {\n      const outputItem = outputArray[j];\n\n      if (!outputItem || typeof outputItem !== 'object') {\n        console.warn(`‚ö†Ô∏è Item ${i}.${j}: Elemento de salida no es objeto`);\n        continue;\n      }\n\n      const cumple = outputItem?.cumple || \"ERROR ANALISIS\";\n      const gap = outputItem?.gap_analysis || \"Check logs\";\n      const score = outputItem?.score !== undefined ? outputItem.score : 0;\n      const requirementId = outputItem?.id || null;\n\n      const validatedScore = Math.max(0, Math.min(10, parseInt(score) || 0));\n\n      if (!requirementId) {\n        console.error(`‚ùå Item ${i}.${j}: No se encontr√≥ ID del requisito en la respuesta del LLM`);\n        continue;\n      }\n\n      if (!validRequirements.includes(requirementId)) {\n        console.error(`‚ùå Item ${i}.${j}: El requirement_id ${requirementId} NO existe en rfq_items_master. Saltando...`);\n        continue;\n      }\n\n      console.log(`‚úÖ Item ${i}.${j}: Requisito ${requirementId} - ${cumple} (${validatedScore}/10)`);\n\n      resultados.push({\n        json: {\n          requirement_id: requirementId,\n          provider_name: providerName,\n          evaluation_value: cumple,\n          comment: gap,\n          score: validatedScore\n        }\n      });\n    }\n\n  } catch (error) {\n    console.error(`‚ùå Error procesando item ${i}:`, error.message);\n    continue;\n  }\n}\n\nconsole.log(`‚úÖ Procesados ${resultados.length} de ${allItems.length} items exitosamente`);\n\nreturn resultados;"
        },
        "id": "6622d0f8-6830-4717-abae-a344dde3c03c",
        "name": "Parsear y Preparar Update",
        "type": "n8n-nodes-base.code",
        "typeVersion": 2,
        "position": [
          2656,
          -1760
        ]
      },
      {
        "parameters": {
          "promptType": "define",
          "text": "=### EVALUATION GROUP\n- Type: {{ $json.evaluation_type }}\n- Total requirements in this batch: {{ $json.total_requisitos }}\n- Batch: {{ $json.batch_index }} of {{ $json.total_batches }}\n\n### RFQ REQUIREMENTS (LIST)\nBelow is a list of RFQ requirements in JSON format. Each element includes the 'id' field and the requirement text.\n\n{{ JSON.stringify($json.requisitos, null, 2) }}\n\n### FULL PROPOSAL TEXT\n\n{{ $('Loop Over Items1').first().json.texto_oferta_completo }}\n---\n### TASK\nAnalyze the proposal and evaluate EACH requirement.\n\n### FOR TECHNICAL EVALUATIONS - Use these labels in 'cumple':\n- INCLUDED (10 pts)\n- INCLUDED WITH CAVEATS (8 pts)\n- PARTIALLY INCLUDED (6 pts)\n- NOT INCLUDED WITH ALTERNATIVE (3 pts)\n- NOT INCLUDED (0 pts)\n- NO INFORMATION (0 pts)\n\n### FOR ECONOMICAL EVALUATIONS - EXTRACT THE ACTUAL VALUE:\n**CRITICAL**: For economic items, the 'cumple' field must contain the ACTUAL VALUE found, not a label.\n\nFormat for 'cumple' field:\n- If value found: \"[VALUE] [CURRENCY/UNIT] - [DESCRIPTION]\"\n  Examples:\n  - \"84,3 ‚Ç¨/h - TARIFA (Process, Mechanical, Piping)\"\n  - \"312.640,62 ‚Ç¨ - PRE-FEED TOTAL BASE QUOTATION\"\n  - \"5.231,21 ‚Ç¨ - Geotechnical survey - Confirmed\"\n  - \"732.588,83 ‚Ç¨ - FEED TOTAL BASE QUOTATION\"\n  - \"97.935 ‚Ç¨ - EPC TENDER QUOTATION\"\n\n- If NO value found: \"NO VALUE FOUND - [REASON]\"\n  Examples:\n  - \"NO VALUE FOUND - 3D model not included in proposal\"\n  - \"NO VALUE FOUND - Methodology not specified\"\n  - \"NO VALUE FOUND - OPEX not quoted\"\n  - \"NO VALUE FOUND - No price for this optional\"\n\nScoring for Economic:\n- Value explicitly quoted: 10 pts\n- Hourly/daily rate given: 7 pts\n- Estimated/approximate value: 5 pts\n- Mentioned but no price: 3 pts\n- Not found: 0 pts\n\n### OUTPUT FORMAT (JSON)\n[\n  {\n    \"id\": \"<requirement id>\",\n    \"cumple\": \"[For Technical: label | For Economic: VALUE or NO VALUE FOUND]\",\n    \"gap_analysis\": \"[Quote from document or 'No mention found']\",\n    \"score\": [0-10]\n  }\n]\n\nJSON only, no explanations.",
          "messages": {
            "messageValues": [
              {
                "message": "=You are an expert auditor for EPC proposals.\n\nRULES:\n- For TECHNICAL: Use labels (INCLUDED, PARTIALLY INCLUDED, etc.)\n- For ECONOMICAL: Extract ACTUAL VALUES with currency/units (e.g., '312.640,62 ‚Ç¨ - PRE-FEED TOTAL'). If no value found: 'NO VALUE FOUND - [reason]'\n- Be conservative: when in doubt, score 0\n- ALL responses in ENGLISH\n- JSON only"
              }
            ]
          },
          "batching": {}
        },
        "type": "@n8n/n8n-nodes-langchain.chainLlm",
        "typeVersion": 1.7,
        "position": [
          2208,
          -1888
        ],
        "id": "ddfb00c6-a590-49e4-af7e-b6cba5d3fb04",
        "name": "LLM Chain"
      },
      {
        "parameters": {
          "operation": "upsert",
          "schema": {
            "__rl": true,
            "mode": "list",
            "value": "public"
          },
          "table": {
            "__rl": true,
            "value": "document_metadata",
            "mode": "list",
            "cachedResultName": "document_metadata"
          },
          "columns": {
            "mappingMode": "defineBelow",
            "value": {
              "id": "={{ $('Set File ID').item.json.file_id }}",
              "title": "={{ $('Set File ID').item.json.file_title }}",
              "project_name": "={{ $('Set File ID').item.json.proyect_name }}\n",
              "project_id": "={{ $('Set File ID').item.json.project_id }}",
              "evaluation_types": "={{ $('Set File ID').item.json.evaluation }}",
              "document_type": "PROPOSAL",
              "provider": "={{ $('Set File ID').item.json.proveedor }}"
            },
            "matchingColumns": [
              "id"
            ],
            "schema": [
              {
                "id": "id",
                "displayName": "id",
                "required": true,
                "defaultMatch": true,
                "display": true,
                "type": "string",
                "canBeUsedToMatch": true
              },
              {
                "id": "title",
                "displayName": "title",
                "required": false,
                "defaultMatch": false,
                "display": true,
                "type": "string",
                "canBeUsedToMatch": false
              },
              {
                "id": "project_name",
                "displayName": "project_name",
                "required": false,
                "defaultMatch": false,
                "display": true,
                "type": "string",
                "canBeUsedToMatch": false,
                "removed": false
              },
              {
                "id": "document_type",
                "displayName": "document_type",
                "required": true,
                "defaultMatch": false,
                "display": true,
                "type": "string",
                "canBeUsedToMatch": false,
                "removed": false
              },
              {
                "id": "provider",
                "displayName": "provider",
                "required": false,
                "defaultMatch": false,
                "display": true,
                "type": "string",
                "canBeUsedToMatch": false,
                "removed": false
              },
              {
                "id": "evaluation_types",
                "displayName": "evaluation_types",
                "required": false,
                "defaultMatch": false,
                "display": true,
                "type": "array",
                "canBeUsedToMatch": false,
                "removed": false
              },
              {
                "id": "created_at",
                "displayName": "created_at",
                "required": false,
                "defaultMatch": false,
                "display": true,
                "type": "dateTime",
                "canBeUsedToMatch": false,
                "removed": false
              }
            ],
            "attemptToConvertTypes": false,
            "convertFieldsToString": false
          },
          "options": {}
        },
        "type": "n8n-nodes-base.postgres",
        "typeVersion": 2.5,
        "position": [
          -96,
          -976
        ],
        "id": "8ec5d82a-9eb0-49e3-9a9d-923b9a5bc4a9",
        "name": "Insert Document Metadata",
        "executeOnce": true,
        "credentials": {
          "postgres": {
            "id": "V0REAPph5JBLqze3",
            "name": "Postgres account"
          }
        }
      },
      {
        "parameters": {
          "operation": "delete",
          "tableId": "proposals",
          "filterType": "string",
          "filterString": "=metadata->>file_id=like.*{{ $json.file_id }}*"
        },
        "id": "3468406c-1149-4256-b0f9-33e047f55354",
        "name": "Delete Old Doc Rows",
        "type": "n8n-nodes-base.supabase",
        "typeVersion": 1,
        "position": [
          -304,
          -976
        ],
        "alwaysOutputData": true,
        "credentials": {
          "supabaseApi": {
            "id": "pI4CpdYLTiEEBmnz",
            "name": "Supabase account"
          }
        }
      },
      {
        "parameters": {
          "assignments": {
            "assignments": [
              {
                "id": "10646eae-ae46-4327-a4dc-9987c2d76173",
                "name": "file_id",
                "value": "={{ $json.body.file_id }}",
                "type": "string"
              },
              {
                "id": "77d782de-169d-4a46-8a8e-a3831c04d90f",
                "name": "file_title",
                "value": "={{ $json.body.file_title }}",
                "type": "string"
              },
              {
                "id": "9bde4d7f-e4f3-4ebd-9338-dce1350f9eab",
                "name": "file_url",
                "value": "={{ $json.body.file_url }}",
                "type": "string"
              },
              {
                "id": "b1dbe9b9-248a-4593-a769-a085b34e0810",
                "name": "file_binary",
                "value": "={{ $json.body.file_binary }}",
                "type": "string"
              },
              {
                "id": "74d93dce-cddc-4947-ae19-88bc5cacd146",
                "name": "file_metadata",
                "value": "={{ $json.body.metadata }}",
                "type": "string"
              },
              {
                "id": "5e43f8d4-b48e-4188-89c8-3723f184dbeb",
                "name": "proyect_name",
                "value": "={{ $json.body.metadata.proyecto }}",
                "type": "string"
              },
              {
                "id": "1093ebc6-8dd8-4c5d-b146-b6f01b069be6",
                "name": "proveedor",
                "value": "={{ $json.body.user_proveedor }}",
                "type": "string"
              },
              {
                "id": "6e0e6e2a-9b88-403e-aa0a-da0eecccd3f9",
                "name": "evaluation",
                "value": "={{ $json.body.metadata.tipoEvaluacion }}",
                "type": "array"
              },
              {
                "id": "project-id-uuid-field",
                "name": "project_id",
                "value": "={{ $json.body.project_id }}",
                "type": "string"
              }
            ]
          },
          "options": {}
        },
        "id": "f95df030-9859-4a41-9d19-87124c1200bb",
        "name": "Set File ID",
        "type": "n8n-nodes-base.set",
        "typeVersion": 3.4,
        "position": [
          -496,
          -976
        ]
      },
      {
        "parameters": {
          "jsonMode": "expressionData",
          "jsonData": "={{ $json.text }}",
          "options": {
            "metadata": {
              "metadataValues": [
                {
                  "name": "file_id",
                  "value": "={{ $json.metadata.file_id }}"
                },
                {
                  "name": "file_title",
                  "value": "={{ $json.metadata.file_title }}"
                },
                {
                  "name": "tipo_evaluacion",
                  "value": "={{ $json.metadata.tipo_evaluacion }}"
                },
                {
                  "name": "proveedor",
                  "value": "={{ $json.metadata.proveedor }}"
                },
                {
                  "name": "project_name",
                  "value": "={{ $json.metadata.project_name }}"
                },
                {
                  "name": "project_id",
                  "value": "={{ $json.metadata.project_id }}"
                }
              ]
            }
          }
        },
        "id": "4c36ef82-d0c9-442f-b90f-3b908329ba80",
        "name": "Default Data Loader",
        "type": "@n8n/n8n-nodes-langchain.documentDefaultDataLoader",
        "typeVersion": 1,
        "position": [
          3120,
          -672
        ]
      },
      {
        "parameters": {
          "chunkSize": 1200,
          "chunkOverlap": 200,
          "options": {}
        },
        "type": "@n8n/n8n-nodes-langchain.textSplitterRecursiveCharacterTextSplitter",
        "typeVersion": 1,
        "position": [
          3024,
          -496
        ],
        "id": "5b6d02c7-d6fc-4caa-bbed-e80cecf7f6b8",
        "name": "Recursive Character Text Splitter"
      },
      {
        "parameters": {
          "mode": "insert",
          "tableName": {
            "__rl": true,
            "value": "proposals",
            "mode": "list",
            "cachedResultName": "proposals"
          },
          "options": {
            "queryName": "match_proposals"
          }
        },
        "id": "d0e20863-a491-4104-9347-2f2eb6b9996b",
        "name": "Insert into Supabase Vectorstore",
        "type": "@n8n/n8n-nodes-langchain.vectorStoreSupabase",
        "typeVersion": 1,
        "position": [
          2992,
          -992
        ],
        "credentials": {
          "supabaseApi": {
            "id": "pI4CpdYLTiEEBmnz",
            "name": "Supabase account"
          }
        }
      },
      {
        "parameters": {
          "jsCode": "// =============================================\n// NODO: Validar Contenido PDF (FIX PAGINACI√ìN)\n// =============================================\n\nconst input = $input.first().json;\n\n// Variables de inicializaci√≥n\nlet pages = [];\nlet totalChars = 0;\nlet hasTablesDetected = false;\n\n// --- 1. PROCESAMIENTO DEL TEXTO ---\n\n// CASO A: Viene desglosado por p√°ginas (Array)\nif (input.pages && Array.isArray(input.pages) && input.pages.length > 0) {\n  pages = input.pages;\n  pages.forEach(page => {\n    const text = page.text || page.pageContent || \"\";\n    totalChars += text.length;\n    // Detecci√≥n simple de tablas\n    if ((text.match(/\\s{4,}/g) || []).length > 5) hasTablesDetected = true;\n  });\n\n// CASO B: Viene todo el texto junto (String) - ESTE ES TU CASO ACTUAL\n} else if (input.text && typeof input.text === 'string') {\n  const text = input.text;\n  totalChars = text.length;\n  // Creamos una \"p√°gina √∫nica\" contenedora para no romper el flujo\n  pages = [{ text: text, pageNumber: 1 }];\n  \n  // Detectar tablas en el texto completo\n  if ((text.match(/\\s{4,}/g) || []).length > 20) hasTablesDetected = true;\n  \n} else {\n  // CASO C: Vac√≠o\n  pages = [];\n}\n\n// --- 2. C√ÅLCULO DE P√ÅGINAS REALES (FIX CR√çTICO) ---\n\n// Intentamos leer el metadato 'numpages' que se ve en tu captura\nlet realPageCount = input.numpages || input.numPages || input.numberOfPages || 0;\n\n// Si no existe el metadato, usamos la longitud del array (fallback)\nif (!realPageCount || realPageCount === 0) {\n    realPageCount = pages.length;\n}\n\n// Si sigue siendo 1 pero el texto es enorme (>10k chars), estimamos\nif (realPageCount <= 1 && totalChars > 10000) {\n    // Estimaci√≥n conservadora: 3000 caracteres por p√°gina t√©cnica\n    realPageCount = Math.ceil(totalChars / 3000);\n}\n\n// Evitar divisi√≥n por cero\nrealPageCount = Math.max(1, realPageCount);\n\n\n// --- 3. M√âTRICAS FINALES ---\n\nconst avgCharsPerPage = totalChars / realPageCount;\n\n// CRITERIO: ¬øNecesita OCR?\n// Si hay texto (< 100 chars/pag) es probable que sea escaneado.\nconst needsOCR = avgCharsPerPage < 100; \n\n// Metadatos\nlet fileId = \"unknown\";\nlet fileTitle = \"unknown\";\ntry {\n  const metaNode = $('Set File ID').first().json;\n  fileId = metaNode.file_id;\n  fileTitle = metaNode.file_title;\n} catch (e) {}\n\n// --- LOGGING ---\nconsole.log(`üìÑ An√°lisis: ${fileTitle}`);\nconsole.log(`   ‚îú‚îÄ P√°ginas (Metadato): ${input.numpages}`); \nconsole.log(`   ‚îú‚îÄ P√°ginas (Usadas): ${realPageCount}`);\nconsole.log(`   ‚îú‚îÄ Caracteres Totales: ${totalChars}`);\nconsole.log(`   ‚îú‚îÄ Promedio/P√°g: ${Math.round(avgCharsPerPage)}`);\n\nreturn {\n  json: {\n    // M√©tricas corregidas\n    totalPages: realPageCount, // Ahora dir√° 235\n    totalChars: totalChars,\n    avgCharsPerPage: Math.round(avgCharsPerPage), // Ahora ser√° un n√∫mero razonable (~2800)\n    hasTables: hasTablesDetected,\n    needsOCR: needsOCR,\n    \n    // Contenido\n    pages: pages, \n    \n    // Metadatos\n    fileId: fileId,\n    fileName: fileTitle\n  }\n};"
        },
        "type": "n8n-nodes-base.code",
        "typeVersion": 2,
        "position": [
          576,
          -976
        ],
        "id": "d25ca851-8a20-4217-bcc1-b0f967ee9d75",
        "name": "Validar Contenido PDF"
      },
      {
        "parameters": {
          "operation": "pdf",
          "options": {}
        },
        "type": "n8n-nodes-base.extractFromFile",
        "typeVersion": 1.1,
        "position": [
          304,
          -976
        ],
        "id": "13271fd6-e2bd-4553-b5b0-e75743935411",
        "name": "Extract from File"
      },
      {
        "parameters": {
          "conditions": {
            "options": {
              "caseSensitive": true,
              "leftValue": "",
              "typeValidation": "strict",
              "version": 3
            },
            "conditions": [
              {
                "id": "57b9c551-9997-4ed5-8ddd-f80c108a177c",
                "leftValue": "={{ $json.needsOCR }}",
                "rightValue": "",
                "operator": {
                  "type": "boolean",
                  "operation": "true",
                  "singleValue": true
                }
              }
            ],
            "combinator": "and"
          },
          "options": {}
        },
        "type": "n8n-nodes-base.if",
        "typeVersion": 2.3,
        "position": [
          864,
          -976
        ],
        "id": "f5375959-8762-4411-b534-3553b5084674",
        "name": "¬øNecesita OCR?"
      },
      {
        "parameters": {
          "jsCode": "// =============================================\n// NODO: Aggregate OCR Pages (CORREGIDO)\n// =============================================\n\nconst items = $input.all();\nlet fullText = \"\";\nlet pagesArray = [];\n\n// OPCI√ìN A: Si Tesseract devuelve m√∫ltiples items (1 por p√°gina)\nif (items.length > 1) {\n  items.forEach((item, idx) => {\n    const pageText = item.json.text || \"\";\n    fullText += pageText + \"\\n\\n\";\n    \n    // Construimos array compatible con vectorstore\n    pagesArray.push({\n      text: pageText,\n      pageNumber: idx + 1\n    });\n  });\n}\n// OPCI√ìN B: Si Tesseract devuelve un solo item con todo el texto\nelse if (items.length === 1) {\n  fullText = items[0].json.text || \"\";\n  pagesArray = [{\n    text: fullText,\n    pageNumber: 1\n  }];\n}\n\n// RECUPERAR METADATOS ORIGINALES (CR√çTICO)\nlet fileId, fileName, proveedor;\ntry {\n  fileId = $('Set File ID').first().json.file_id;\n  fileName = $('Set File ID').first().json.file_title;\n  proveedor = $('Set File ID').first().json.proveedor || \"OTROS\";\n} catch (e) {\n  console.error(\"‚ö†Ô∏è No se pudieron recuperar metadatos:\", e.message);\n  fileId = \"unknown\";\n  fileName = \"unknown\";\n  proveedor = \"OTROS\";\n}\n\nconsole.log(`üîÑ OCR Agregado: ${items.length} p√°ginas ‚Üí ${fullText.length} caracteres`);\n\n// ESTRUCTURA COMPATIBLE CON VECTORSTORE\nreturn {\n  json: {\n    pages: pagesArray, // ‚Üê Array de p√°ginas (requerido por Default Data Loader)\n    text: fullText, // ‚Üê Texto completo (backup)\n    \n    // Metadatos cr√≠ticos\n    file_id: fileId,\n    file_title: fileName,\n    proveedor: proveedor,\n    \n    // Marca de origen\n    origen_datos: \"OCR_TESSERACT\",\n    ocr_pages_processed: items.length,\n    ocr_total_chars: fullText.length\n  }\n};"
        },
        "type": "n8n-nodes-base.code",
        "typeVersion": 2,
        "position": [
          1504,
          -1088
        ],
        "id": "f4a9783a-6911-414d-a621-220c76cc741d",
        "name": "Aggregate OCR Pages"
      },
      {
        "parameters": {
          "jsCode": "// =============================================\n// NODO: Preparar Texto de Muestra (STRICT LIMIT)\n// =============================================\n\nconst items = $input.all();\n\nreturn items.map(item => {\n    let texto_muestra = \"SIN TEXTO\";\n\n    try {\n        if (item.json.pages && Array.isArray(item.json.pages) && item.json.pages.length > 0) {\n            // Unimos las 2 primeras p√°ginas pero limitamos el total a 3000 caracteres\n            let rawJoin = item.json.pages.slice(0, 2).map(p => p.text || \"\").join(\"\\n\\n\");\n            texto_muestra = rawJoin.substring(0, 3000);\n        } else {\n            // Fallback extremadamente corto para texto plano\n            texto_muestra = (item.json.text || \"\").substring(0, 500);\n        }\n    } catch (e) {\n        console.error(\"Error al procesar p√°ginas:\", e);\n    }\n\n    return {\n        json: {\n            ...item.json,\n            texto_muestra: texto_muestra\n        }\n    };\n});"
        },
        "id": "b2ee2443-d5bc-4428-aec2-585ed2896f66",
        "name": "Preparar Texto de Muestra",
        "type": "n8n-nodes-base.code",
        "typeVersion": 2,
        "position": [
          1952,
          -976
        ]
      },
      {
        "parameters": {
          "jsCode": "// =============================================\n// NODO: Format for Vectorstore (v3 - DIRECTO DEL USUARIO)\n// SIN clasificador ni validador LLM\n// =============================================\n\n// 1. RECUPERAR CONTENIDO\nlet fullText = \"\";\nlet totalPages = 1;\n\ntry {\n    const mergeData = $('Merge1').first().json;\n    if (mergeData.pages && mergeData.pages[0]) {\n        fullText = mergeData.pages.slice(0, 2).map(p => p.text || \"\").join(\"\\n\\n\");\n    } else {\n        fullText = mergeData.text || \"\";\n    }\n    totalPages = mergeData.totalPages || 1;\n} catch (e) {\n    console.log(\"‚ùå Error leyendo de Merge1\");\n}\n\n// 2. USAR DIRECTAMENTE DATOS DEL USUARIO (Set File ID)\nlet fileId = \"unknown\";\nlet fileTitle = \"unknown\";\nlet proveedor = \"OTROS\";\nlet tipoEval = [\"Technical Evaluation\"];\nlet proyecto = \"\";\nlet projectId = null;\n\ntry {\n    const fileNode = $('Set File ID').first().json;\n    fileId = fileNode.file_id || \"unknown\";\n    fileTitle = fileNode.file_title || \"unknown\";\n    proveedor = fileNode.proveedor || \"OTROS\";\n    proyecto = fileNode.proyect_name || \"\";\n    projectId = fileNode.project_id || null;\n    \n    if (fileNode.evaluation && Array.isArray(fileNode.evaluation) && fileNode.evaluation.length > 0) {\n        tipoEval = fileNode.evaluation;\n    } else if (fileNode.evaluation && typeof fileNode.evaluation === 'string') {\n        tipoEval = [fileNode.evaluation];\n    }\n} catch(e) {\n    console.log(\"‚ùå Error leyendo Set File ID\");\n}\n\n// 3. GENERAR SALIDA\nreturn {\n    json: {\n        text: fullText,\n        metadata: {\n            file_id: fileId,\n            file_title: fileTitle,\n            proveedor: proveedor,\n            tipo_evaluacion: tipoEval,\n            project_name: proyecto,\n            project_id: projectId,\n            processed_at: new Date().toISOString(),\n            total_pages: totalPages\n        }\n    }\n};"
        },
        "type": "n8n-nodes-base.code",
        "typeVersion": 2,
        "position": [
          2816,
          -992
        ],
        "id": "2a99d9e6-9c8f-4adb-b207-52b928d427b5",
        "name": "Format for Vectorstore"
      },
      {
        "parameters": {
          "jsCode": "// =============================================\n// NODO: Expandir por Tipo de Evaluaci√≥n (v3 - DIRECTO DEL USUARIO)\n// SIN clasificador ni validador LLM - usa datos del usuario directamente\n// =============================================\n\n// 1. RECUPERAR TEXTO Y CONTENIDO BASE\nlet fullText = \"\";\nlet totalPages = 1;\ntry {\n    const mergeData = $('Merge1').first().json;\n    fullText = (mergeData.pages && mergeData.pages[0]) \n        ? mergeData.pages.slice(0, 2).map(p => p.text || \"\").join(\"\\n\\n\") \n        : (mergeData.text || \"\");\n    totalPages = mergeData.totalPages || 1;\n} catch (e) {\n    console.error(\"‚ùå Error leyendo Merge1\");\n}\n\n// 2. USAR DIRECTAMENTE DATOS DEL USUARIO (Set File ID)\nlet fileId = \"unknown\";\nlet proveedor = \"OTROS\";\nlet tipoEval = [\"Technical Evaluation\"];\nlet projectName = \"proyecto_sin_especificar\";\n\ntry {\n    const fileData = $('Set File ID').first().json;\n    fileId = fileData.file_id || \"unknown\";\n    proveedor = fileData.proveedor || \"OTROS\";\n    projectName = fileData.proyect_name || \"proyecto_sin_especificar\";\n    \n    // Tipos de evaluaci√≥n del usuario\n    if (fileData.evaluation && Array.isArray(fileData.evaluation) && fileData.evaluation.length > 0) {\n        tipoEval = fileData.evaluation;\n    } else if (fileData.evaluation && typeof fileData.evaluation === 'string') {\n        tipoEval = [fileData.evaluation];\n    }\n    \n    console.log(`‚úÖ Usando datos del usuario directamente:`);\n    console.log(`   Proveedor: ${proveedor}`);\n    console.log(`   Proyecto: ${projectName}`);\n    console.log(`   Tipos: ${JSON.stringify(tipoEval)}`);\n} catch (e) {\n    console.error(\"‚ùå Error leyendo Set File ID:\", e.message);\n}\n\n// 3. NORMALIZAR TIPOS\nif (!Array.isArray(tipoEval)) tipoEval = [tipoEval];\ntipoEval = tipoEval.filter(t => t && t.trim() !== \"\");\nif (tipoEval.length === 0) tipoEval = [\"Technical Evaluation\"];\n\n// 4. GENERAR FILAS\nreturn tipoEval.map((tipo, idx) => ({\n    json: {\n        tipo_evaluacion_actual: tipo,\n        proveedor_detectado: proveedor,\n        proyecto_nombre: projectName,\n        texto_oferta_completo: fullText,\n        indice_actual: idx + 1,\n        total_tipos: tipoEval.length,\n        file_id: fileId\n    }\n}));"
        },
        "type": "n8n-nodes-base.code",
        "typeVersion": 2,
        "position": [
          -848,
          -1680
        ],
        "id": "bfd70129-a98d-47e2-90ba-793f213e5277",
        "name": "Expandir por Tipo de Evaluaci√≥n"
      },
      {
        "parameters": {
          "options": {}
        },
        "type": "n8n-nodes-base.splitInBatches",
        "typeVersion": 3,
        "position": [
          -544,
          -1760
        ],
        "id": "14827ded-d072-41e1-999a-03d2c9d50d10",
        "name": "Loop Over Items1"
      },
      {
        "parameters": {
          "method": "POST",
          "url": "https://unlaconic-ardelle-pretenceful.ngrok-free.dev/v1/convert/file",
          "sendBody": true,
          "contentType": "multipart-form-data",
          "bodyParameters": {
            "parameters": [
              {
                "parameterType": "formBinaryData",
                "name": "files",
                "inputDataFieldName": "data"
              }
            ]
          },
          "options": {
            "timeout": 300000
          }
        },
        "id": "c61a460e-a441-44a0-9a64-133679d83688",
        "name": "Docling OCR",
        "type": "n8n-nodes-base.httpRequest",
        "typeVersion": 4.3,
        "position": [
          1296,
          -1184
        ],
        "retryOnFail": true
      },
      {
        "parameters": {
          "schemaType": "manual",
          "inputSchema": "{\n  \"type\": \"object\",\n  \"properties\": {\n    \"proveedor_detectado\": {\n      \"type\": \"string\",\n      \"description\": \"Nombre de la empresa proveedora (Ej: SACYR, IDOM, etc.)\"\n    },\n    \"tipos_detectados\": {\n      \"type\": \"array\",\n      \"items\": {\n        \"type\": \"string\",\n        \"enum\": [\n          \"Technical Evaluation\",\n          \"Economical Evaluation\",\n          \"Pre-FEED Deliverables\",\n          \"FEED Deliverables\"\n        ]\n      },\n      \"description\": \"Lista de tipos de oferta detectados en el documento.\"\n    },\n    \"razonamiento\": {\n      \"type\": \"string\",\n      \"description\": \"Breve explicaci√≥n de por qu√© se eligieron esos tipos.\"\n    }\n  },\n  \"required\": [\n    \"proveedor_detectado\",\n    \"tipos_detectados\"\n  ]\n}"
        },
        "type": "@n8n/n8n-nodes-langchain.outputParserStructured",
        "typeVersion": 1.3,
        "position": [
          2608,
          -528
        ],
        "id": "6a5284bb-8805-4142-9b31-f32a4ffb3373",
        "name": "Structured Output Parser"
      },
      {
        "parameters": {},
        "type": "n8n-nodes-base.merge",
        "typeVersion": 3.2,
        "position": [
          1760,
          -976
        ],
        "id": "61488c9b-c0d6-40f2-afe8-6676253961d0",
        "name": "Merge1"
      },
      {
        "parameters": {
          "jsCode": "const items = $input.all();\n\nreturn items.map(item => ({\n    json: {\n        ...item.json, // Mantiene todos los datos originales (incluido tipo_evaluacion)\n        \n        // Aqu√≠ est√° la correcci√≥n: Usamos dos puntos, no el igual.\n        reiniciar_bucle: true \n    }\n}));\n"
        },
        "type": "n8n-nodes-base.code",
        "typeVersion": 2,
        "position": [
          464,
          -1808
        ],
        "id": "343a1116-28bc-4c04-8a05-bc197a7d8a55",
        "name": "Reset Items"
      },
      {
        "parameters": {
          "respondWith": "allIncomingItems",
          "options": {}
        },
        "type": "n8n-nodes-base.respondToWebhook",
        "typeVersion": 1.5,
        "position": [
          -96,
          -2032
        ],
        "id": "fb94b867-19c1-40f3-8ded-4c62c2730672",
        "name": "Respond to Webhook"
      },
      {
        "parameters": {
          "httpMethod": "POST",
          "path": "ofertas-proveedores",
          "responseMode": "responseNode",
          "options": {}
        },
        "type": "n8n-nodes-base.webhook",
        "typeVersion": 2.1,
        "position": [
          -928,
          -976
        ],
        "id": "8f5c0cc4-648d-43a0-b4b8-ce46157ef9c8",
        "name": "Webhook",
        "webhookId": "54339356-4e6d-4e22-9820-6e1e98e167a8"
      },
      {
        "parameters": {
          "jsCode": "// =============================================\n// NODO: Convertir Base64 a Binary Data (CORREGIDO v3)\n// =============================================\n\n// LEER DIRECTAMENTE DEL NODO \"Set File ID\"\nlet inputData;\ntry {\n    inputData = $('Set File ID').first().json;\n} catch (e) {\n    throw new Error(\"‚ùå No se puede acceder al nodo 'Set File ID'\");\n}\n\nconst base64Data = inputData.file_binary;\n\n// --- VALIDACI√ìN CR√çTICA ---\nif (!base64Data || base64Data === \"\") {\n    console.error(\"‚ùå ERROR: file_binary est√° vac√≠o\");\n    console.error(\"Datos en 'Set File ID':\", Object.keys(inputData));\n    console.error(\"file_id:\", inputData.file_id);\n    console.error(\"file_title:\", inputData.file_title);\n    \n    throw new Error(\n        \"‚ùå CR√çTICO: 'file_binary' no existe en 'Set File ID'. \" +\n        \"Verifica la configuraci√≥n del nodo.\"\n    );\n}\n\n// Validar que sea string\nif (typeof base64Data !== 'string') {\n    throw new Error(`‚ùå ERROR: 'file_binary' debe ser string, es ${typeof base64Data}`);\n}\n\n// Logging\nconsole.log(\"‚úÖ file_binary recibido de 'Set File ID'\");\nconsole.log(`   ‚îú‚îÄ Longitud: ${base64Data.length} caracteres`);\nconsole.log(`   ‚îú‚îÄ Archivo: ${inputData.file_title}`);\n\n// Convertir base64 a binary\nlet binaryData;\ntry {\n    binaryData = Buffer.from(base64Data, 'base64');\n} catch (e) {\n    throw new Error(`‚ùå ERROR decodificando base64: ${e.message}`);\n}\n\n// Validar tama√±o\nif (binaryData.length === 0) {\n    throw new Error(\"‚ùå ERROR: Archivo decodificado vac√≠o (0 bytes)\");\n}\n\nconsole.log(`‚úÖ Binary generado: ${binaryData.length} bytes`);\n\n// Retornar formato n8n\nreturn {\n    json: {\n        file_id: inputData.file_id,\n        file_title: inputData.file_title,\n        file_url: inputData.file_url || \"unknown\"\n    },\n    binary: {\n        data: {\n            data: binaryData.toString('base64'),\n            mimeType: 'application/pdf',\n            fileName: inputData.file_title || 'document.pdf',\n            fileSize: binaryData.length\n        }\n    }\n};"
        },
        "type": "n8n-nodes-base.code",
        "typeVersion": 2,
        "position": [
          80,
          -976
        ],
        "id": "fc8f82c4-b714-4e2d-84c2-d9049b2d37dd",
        "name": "Base64 a Binary"
      },
      {
        "parameters": {
          "jsCode": "// =============================================\n// NODO: Convertir Base64 a Binary Data (CORREGIDO v3)\n// =============================================\n\n// LEER DIRECTAMENTE DEL NODO \"Set File ID\"\nlet inputData;\ntry {\n    inputData = $('Set File ID').first().json;\n} catch (e) {\n    throw new Error(\"‚ùå No se puede acceder al nodo 'Set File ID'\");\n}\n\nconst base64Data = inputData.file_binary;\n\n// --- VALIDACI√ìN CR√çTICA ---\nif (!base64Data || base64Data === \"\") {\n    console.error(\"‚ùå ERROR: file_binary est√° vac√≠o\");\n    console.error(\"Datos en 'Set File ID':\", Object.keys(inputData));\n    console.error(\"file_id:\", inputData.file_id);\n    console.error(\"file_title:\", inputData.file_title);\n    \n    throw new Error(\n        \"‚ùå CR√çTICO: 'file_binary' no existe en 'Set File ID'. \" +\n        \"Verifica la configuraci√≥n del nodo.\"\n    );\n}\n\n// Validar que sea string\nif (typeof base64Data !== 'string') {\n    throw new Error(`‚ùå ERROR: 'file_binary' debe ser string, es ${typeof base64Data}`);\n}\n\n// Logging\nconsole.log(\"‚úÖ file_binary recibido de 'Set File ID'\");\nconsole.log(`   ‚îú‚îÄ Longitud: ${base64Data.length} caracteres`);\nconsole.log(`   ‚îú‚îÄ Archivo: ${inputData.file_title}`);\n\n// Convertir base64 a binary\nlet binaryData;\ntry {\n    binaryData = Buffer.from(base64Data, 'base64');\n} catch (e) {\n    throw new Error(`‚ùå ERROR decodificando base64: ${e.message}`);\n}\n\n// Validar tama√±o\nif (binaryData.length === 0) {\n    throw new Error(\"‚ùå ERROR: Archivo decodificado vac√≠o (0 bytes)\");\n}\n\nconsole.log(`‚úÖ Binary generado: ${binaryData.length} bytes`);\n\n// Retornar formato n8n\nreturn {\n    json: {\n        file_id: inputData.file_id,\n        file_title: inputData.file_title,\n        file_url: inputData.file_url || \"unknown\"\n    },\n    binary: {\n        data: {\n            data: binaryData.toString('base64'),\n            mimeType: 'application/pdf',\n            fileName: inputData.file_title || 'document.pdf',\n            fileSize: binaryData.length\n        }\n    }\n};"
        },
        "type": "n8n-nodes-base.code",
        "typeVersion": 2,
        "position": [
          1088,
          -1088
        ],
        "id": "46b90454-f69b-4c8b-92de-a7150b9d90a9",
        "name": "Base64 a Binary1"
      },
      {
        "parameters": {
          "jsCode": "// =============================================\n// NODO: Generate Stable ID + Detectar Modo (NOMBRES CORRECTOS)\n// =============================================\n\nfunction simpleHash(str) {\n  let hash = 0;\n  for (let i = 0; i < str.length; i++) {\n    const char = str.charCodeAt(i);\n    hash = ((hash << 5) - hash) + char;\n    hash = hash & hash;\n  }\n  return Math.abs(hash).toString(16).padStart(16, '0').substring(0, 16);\n}\n\nconst body = $json.body;\n\n// CAMPOS EXISTENTES\nconst originalFileId = body.file_id || \"unknown\";\nconst fileTitle = body.file_title || \"unknown.pdf\";\nconst fileBinary = body.file_binary || \"\";\nconst fileUrl = body.file_url || \"unknown\";\n\n// ‚úÖ EXTRAER METADATA DEL USUARIO (NOMBRES CORRECTOS)\nconst metadata = body.metadata || {};\nconst rfqProjectId = metadata.proyect_name || null;        // ‚Üê proyect_name\nconst userProveedor = metadata.proveedor || null;          // ‚Üê proveedor\nconst userTipoEval = metadata.evaluation || null;          // ‚Üê evaluation (Array)\n\n// ‚úÖ DETERMINAR MODO DE OPERACI√ìN\nlet modoOperacion = \"CLASIFICADOR\"; // Por defecto\nlet datosCompletos = false;\n\n// Verificar si tiene datos suficientes para VALIDACI√ìN\nif (userProveedor && userTipoEval && Array.isArray(userTipoEval) && userTipoEval.length > 0) {\n    modoOperacion = \"VALIDADOR\";\n    datosCompletos = true;\n} else if (userProveedor || (userTipoEval && Array.isArray(userTipoEval) && userTipoEval.length > 0)) {\n    modoOperacion = \"HIBRIDO\"; // Tiene algunos datos pero no todos\n}\n\n// Generar ID estable del archivo\nconst normalizedTitle = fileTitle.toLowerCase().trim();\nconst stableId = simpleHash(normalizedTitle);\n\n// LOGGING\nconsole.log(\"=== AN√ÅLISIS DE METADATA ===\");\nconsole.log(`Modo Operaci√≥n: ${modoOperacion}`);\nconsole.log(`RFQ Project Name: ${rfqProjectId || 'No especificado'}`);\nconsole.log(`Proveedor (Usuario): ${userProveedor || 'No especificado'}`);\nconsole.log(`Evaluation (Usuario): ${JSON.stringify(userTipoEval) || 'No especificado'}`);\nconsole.log(`Datos Completos: ${datosCompletos}`);\nconsole.log(`Original ID: ${originalFileId}`);\nconsole.log(`Nombre archivo: ${fileTitle}`);\nconsole.log(`ID ESTABLE generado: ${stableId}`);\n\n// RETORNO\nreturn {\n  json: {\n    // Datos directos en ra√≠z\n    file_id: stableId,\n    file_id_original: originalFileId,\n    file_title: fileTitle,\n    file_binary: fileBinary,\n    file_url: fileUrl,\n    \n    rfq_project_id: rfqProjectId || \"proyecto_sin_especificar\",\n    user_proveedor: userProveedor,\n    user_tipo_evaluacion: userTipoEval,\n    modo_operacion: modoOperacion,\n    datos_usuario_completos: datosCompletos,\n    \n    // Mantener body completo\n    body: {\n      ...body,\n      file_id: stableId,\n      file_id_original: originalFileId,\n      rfq_project_id: rfqProjectId || \"proyecto_sin_especificar\",\n      user_proveedor: userProveedor,\n      user_tipo_evaluacion: userTipoEval,\n      modo_operacion: modoOperacion,\n      datos_usuario_completos: datosCompletos\n    }\n  }\n};"
        },
        "type": "n8n-nodes-base.code",
        "typeVersion": 2,
        "position": [
          -688,
          -976
        ],
        "id": "670effc0-15de-44a1-9de2-6692312d95e0",
        "name": "Code in JavaScript1"
      },
      {
        "parameters": {
          "operation": "upsert",
          "schema": {
            "__rl": true,
            "mode": "list",
            "value": "public"
          },
          "table": {
            "__rl": true,
            "value": "provider_responses",
            "mode": "list",
            "cachedResultName": "provider_responses"
          },
          "columns": {
            "mappingMode": "defineBelow",
            "value": {
              "provider_name": "={{ $json.provider_name }}",
              "evaluation_value": "={{ $json.evaluation_value }}",
              "comment": "={{ $json.comment }}",
              "requirement_id": "={{ $json.requirement_id }}",
              "file_id": "={{ $('Set File ID').first().json.file_id }}",
              "score": "={{ $json.score }}",
              "project_id": "={{ $('Set File ID').first().json.project_id }}",
              "updated_at": "={{ $now }}"
            },
            "matchingColumns": [
              "requirement_id",
              "provider_name"
            ],
            "schema": [
              {
                "id": "id",
                "displayName": "id",
                "required": false,
                "defaultMatch": true,
                "display": true,
                "type": "string",
                "canBeUsedToMatch": true,
                "removed": true
              },
              {
                "id": "requirement_id",
                "displayName": "requirement_id",
                "required": false,
                "defaultMatch": false,
                "display": true,
                "type": "string",
                "canBeUsedToMatch": true,
                "removed": false
              },
              {
                "id": "provider_name",
                "displayName": "provider_name",
                "required": true,
                "defaultMatch": false,
                "display": true,
                "type": "string",
                "canBeUsedToMatch": true
              },
              {
                "id": "evaluation_value",
                "displayName": "evaluation_value",
                "required": false,
                "defaultMatch": false,
                "display": true,
                "type": "string",
                "canBeUsedToMatch": false
              },
              {
                "id": "comment",
                "displayName": "comment",
                "required": false,
                "defaultMatch": false,
                "display": true,
                "type": "string",
                "canBeUsedToMatch": false
              },
              {
                "id": "file_id",
                "displayName": "file_id",
                "required": false,
                "defaultMatch": false,
                "display": true,
                "type": "string",
                "canBeUsedToMatch": false
              },
              {
                "id": "updated_at",
                "displayName": "updated_at",
                "required": false,
                "defaultMatch": false,
                "display": true,
                "type": "dateTime",
                "canBeUsedToMatch": false
              },
              {
                "id": "score",
                "displayName": "score",
                "required": false,
                "defaultMatch": false,
                "display": true,
                "type": "number",
                "canBeUsedToMatch": false
              },
              {
                "id": "project_id",
                "displayName": "project_id",
                "required": false,
                "defaultMatch": false,
                "display": true,
                "type": "string",
                "canBeUsedToMatch": false
              }
            ],
            "attemptToConvertTypes": false,
            "convertFieldsToString": false
          },
          "options": {}
        },
        "type": "n8n-nodes-base.postgres",
        "typeVersion": 2.6,
        "position": [
          3168,
          -1536
        ],
        "id": "d17ef36b-451e-442c-8bd2-51f64adaac40",
        "name": "Insert or update rows in a table",
        "credentials": {
          "postgres": {
            "id": "V0REAPph5JBLqze3",
            "name": "Postgres account"
          }
        }
      },
      {
        "parameters": {},
        "type": "@n8n/n8n-nodes-langchain.embeddingsCohere",
        "typeVersion": 1,
        "position": [
          3040,
          -768
        ],
        "id": "b5476ad8-75ca-49e2-950f-5392f38a3dd2",
        "name": "Embeddings Cohere",
        "credentials": {
          "cohereApi": {
            "id": "KGv4zlUJIjLdxpnr",
            "name": "CohereApi account"
          }
        }
      },
      {
        "parameters": {
          "jsCode": "// =============================================\n// NODO: Preparar Todo para LLM (SIN RAG, SIN FASES)\n// Pasa TODOS los requisitos directamente al LLM\n// =============================================\n\nconst items = $input.all();\n\nconsole.log('üì• Requisitos recibidos:', items.length);\n\n// Obtener texto completo de la oferta desde Loop Over Items1\nlet textoOfertaCompleto = \"\";\nlet evaluationType = \"Technical Evaluation\";\n\ntry {\n    const loopData = $('Loop Over Items1').first().json;\n    textoOfertaCompleto = loopData.texto_oferta_completo || \"\";\n    evaluationType = loopData.tipo_evaluacion_actual || \"Technical Evaluation\";\n    console.log('‚úÖ Datos obtenidos de Loop Over Items1');\n    console.log('   ‚îú‚îÄ Tipo evaluaci√≥n:', evaluationType);\n    console.log('   ‚îî‚îÄ Texto oferta:', textoOfertaCompleto.length, 'chars');\n} catch(e) {\n    console.warn('‚ö†Ô∏è No se pudo obtener texto de oferta de Loop Over Items1:', e.message);\n    // Fallback: intentar obtener de otro lugar\n    try {\n        const expandirData = $('Expandir por Tipo de Evaluaci√≥n').first().json;\n        textoOfertaCompleto = expandirData.texto_oferta_completo || \"\";\n        evaluationType = expandirData.tipo_evaluacion_actual || \"Technical Evaluation\";\n        console.log('‚úÖ Fallback: Datos obtenidos de Expandir por Tipo de Evaluaci√≥n');\n    } catch(e2) {\n        console.error('‚ùå No se pudo obtener texto de ning√∫n nodo');\n    }\n}\n\n// Formatear TODOS los requisitos (sin batching)\nconst todosLosRequisitos = items.map(item => ({\n    id: item.json.id || \"\",\n    requirement_text: item.json.requirement_text || item.json.text || \"NO ESPECIFICADO\",\n    evaluation_type: item.json.evaluation_type || evaluationType\n}));\n\nconsole.log('üìã Preparaci√≥n directa (sin RAG ni fases):');\nconsole.log('   ‚îú‚îÄ Total requisitos:', todosLosRequisitos.length);\nconsole.log('   ‚îú‚îÄ Tipo evaluaci√≥n:', evaluationType);\nconsole.log('   ‚îî‚îÄ Tama√±o texto oferta:', textoOfertaCompleto.length, 'chars');\n\n// Retornar UN SOLO item con TODOS los requisitos\nreturn [{\n    json: {\n        evaluation_type: evaluationType,\n        requisitos: todosLosRequisitos,\n        total_requisitos: todosLosRequisitos.length,\n        batch_index: 1,\n        total_batches: 1,\n        context: textoOfertaCompleto,\n        texto_length: textoOfertaCompleto.length\n    }\n}];"
        },
        "type": "n8n-nodes-base.code",
        "typeVersion": 2,
        "position": [
          1216,
          -1888
        ],
        "id": "bbff3aea-66b8-49dc-804a-6cc5e7aaf8cc",
        "name": "Preparar Todo para LLM1"
      },
      {
        "parameters": {
          "httpMethod": "POST",
          "path": "scoring-evaluation",
          "responseMode": "responseNode",
          "options": {}
        },
        "type": "n8n-nodes-base.webhook",
        "typeVersion": 2.1,
        "position": [
          -6240,
          -640
        ],
        "id": "933caaec-51c8-4f0e-a721-30f26f57b808",
        "name": "Webhook Scoring",
        "webhookId": "scoring-eval-webhook-001"
      },
      {
        "parameters": {
          "operation": "getAll",
          "tableId": "rfq_items_master",
          "returnAll": true,
          "filters": {
            "conditions": [
              {
                "keyName": "project_id",
                "condition": "eq",
                "keyValue": "={{ $('Set Input Params1').first().json.project_id }}"
              }
            ]
          }
        },
        "type": "n8n-nodes-base.supabase",
        "typeVersion": 1,
        "position": [
          -5584,
          -736
        ],
        "id": "90601137-9005-4946-a748-d45a33f7f719",
        "name": "Fetch Requirements",
        "credentials": {
          "supabaseApi": {
            "id": "pI4CpdYLTiEEBmnz",
            "name": "Supabase account"
          }
        }
      },
      {
        "parameters": {
          "operation": "getAll",
          "tableId": "provider_responses",
          "returnAll": true,
          "filters": {
            "conditions": [
              {
                "keyName": "project_id",
                "condition": "eq",
                "keyValue": "={{ $('Set Input Params1').first().json.project_id }}"
              }
            ]
          }
        },
        "type": "n8n-nodes-base.supabase",
        "typeVersion": 1,
        "position": [
          -5584,
          -512
        ],
        "id": "b2f689dc-ea9d-45a9-92c3-c39fc480f28f",
        "name": "Fetch Provider Responses",
        "credentials": {
          "supabaseApi": {
            "id": "pI4CpdYLTiEEBmnz",
            "name": "Supabase account"
          }
        }
      },
      {
        "parameters": {},
        "type": "n8n-nodes-base.merge",
        "typeVersion": 3.2,
        "position": [
          -5360,
          -640
        ],
        "id": "f168ebd5-79a1-4785-8fc5-8e9771bceadc",
        "name": "Merge Requirements & Responses"
      },
      {
        "parameters": {
          "jsCode": "// =============================================\n// NODO: Prepare Scoring Data (v4 - New Criteria)\n// Based on RFQ requirements for engineering proposals\n// Categories: TECHNICAL (30%), ECONOMIC (35%), EXECUTION (20%), HSE_COMPLIANCE (15%)\n// =============================================\n\nconst items = $input.all();\n\nconsole.log('üìä Prepare Scoring Data - Starting...');\nconsole.log('   Items received:', items.length);\n\n/* =========================\nGet project_id from webhook\n========================= */\nlet projectId = null;\ntry {\n    projectId = $('Set Input Params1').first().json.project_id;\n    console.log('   üìã Project ID:', projectId);\n} catch (e) {\n    console.log('   ‚ö†Ô∏è Could not get project_id:', e.message);\n}\n\n/* =========================\nHelpers - Map requirements to new criteria categories\n========================= */\nfunction getCriterionFromRequirement(evalType, phase, reqText) {\n    const type = (evalType || '').toLowerCase();\n    const phaseL = (phase || '').toLowerCase();\n    const text = (reqText || '').toLowerCase();\n    \n    // TECHNICAL COMPLETENESS criteria\n    if (type.includes('technical')) {\n        if (text.includes('scope of facilities') || text.includes('hydrogen plant') || text.includes('utilities')) {\n            return 'scope_facilities';\n        }\n        if (text.includes('scope of work') || text.includes('project management') || text.includes('deliverables')) {\n            return 'scope_work';\n        }\n        if (text.includes('p&id') || text.includes('3d model') || text.includes('specification') || text.includes('datasheet')) {\n            return 'deliverables_quality';\n        }\n        return 'scope_work'; // Default technical\n    }\n    \n    // ECONOMIC COMPETITIVENESS criteria\n    if (type.includes('econom')) {\n        if (text.includes('price') || text.includes('‚Ç¨') || text.includes('fee') || text.includes('cost')) {\n            return 'total_price';\n        }\n        if (text.includes('hour') || text.includes('discipline') || text.includes('breakdown')) {\n            return 'price_breakdown';\n        }\n        if (text.includes('optional') || text.includes('geotechnical') || text.includes('topograph') || text.includes('hazid')) {\n            return 'optionals_included';\n        }\n        if (text.includes('capex') || text.includes('opex') || text.includes('aacei') || text.includes('estimate')) {\n            return 'capex_opex_methodology';\n        }\n        return 'total_price'; // Default economic\n    }\n    \n    // HSE & COMPLIANCE criteria\n    if (text.includes('hse') || text.includes('safety') || text.includes('hazop') || text.includes('hazid') || text.includes('atex') || text.includes('qra')) {\n        return 'safety_studies';\n    }\n    if (text.includes('code') || text.includes('standard') || text.includes('compliance') || text.includes('regulation')) {\n        return 'regulatory_compliance';\n    }\n    \n    // EXECUTION CAPABILITY criteria (deliverables phase)\n    if (phaseL.includes('pre-feed') || phaseL.includes('feed') || type.includes('deliverable')) {\n        if (text.includes('schedule') || text.includes('planning') || text.includes('timeline')) {\n            return 'schedule';\n        }\n        if (text.includes('exception') || text.includes('deviation') || text.includes('exclusion')) {\n            return 'exceptions';\n        }\n        return 'resources_allocation';\n    }\n    \n    return 'scope_work'; // Fallback\n}\n\nfunction classifyEval(val) {\n    const v = (val || '').toUpperCase();\n    if (v.includes('INCLUD') || v.includes('INCLUIDO') || v === 'SI' || v === 'YES') return 'INCLUDED';\n    if (v.includes('PARCIAL') || v.includes('PARTIAL')) return 'PARTIAL';\n    if (v.includes('NO INCLUD') || v.includes('NOT INCLUD') || v === 'NO') return 'NOT_INCLUDED';\n    return 'NO_INFO';\n}\n\n/* =========================\nGet data from previous nodes\n========================= */\nlet requirements = [];\nlet responses = [];\n\ntry {\n    const reqItems = $('Fetch Requirements').all();\n    requirements = reqItems.map(item => item.json);\n    console.log('   ‚úÖ Requirements from Fetch Requirements:', requirements.length);\n} catch (e) {\n    console.log('   ‚ö†Ô∏è Could not access Fetch Requirements:', e.message);\n}\n\ntry {\n    const respItems = $('Fetch Provider Responses').all();\n    responses = respItems.map(item => item.json);\n    console.log('   ‚úÖ Responses from Fetch Provider Responses:', responses.length);\n} catch (e) {\n    console.log('   ‚ö†Ô∏è Could not access Fetch Provider Responses:', e.message);\n}\n\nif (requirements.length === 0 || responses.length === 0) {\n    console.log('   üîÑ Using fallback: separating from input...');\n    items.forEach(item => {\n        const data = item.json;\n        if (data.requirement_text && !data.provider_name) {\n            requirements.push(data);\n        } else if (data.provider_name && data.requirement_id) {\n            responses.push(data);\n        }\n    });\n}\n\nif (requirements.length === 0) {\n    return [{ json: { error: 'No requirements found', items_received: items.length } }];\n}\nif (responses.length === 0) {\n    return [{ json: { error: 'No responses found', items_received: items.length } }];\n}\n\n/* =========================\nOptimization with MAPS\n========================= */\nconst requirementMap = {};\nrequirements.forEach(r => {\n    if (r.id) requirementMap[r.id] = r;\n});\n\nconst responsesByProvider = {};\nresponses.forEach(r => {\n    if (r.provider_name) {\n        if (!responsesByProvider[r.provider_name]) {\n            responsesByProvider[r.provider_name] = [];\n        }\n        responsesByProvider[r.provider_name].push(r);\n    }\n});\n\nconsole.log('   üìä Providers found:', Object.keys(responsesByProvider).join(', '));\n\n/* =========================\nProvider filter (optional)\n========================= */\nlet providerFilter = '';\ntry {\n    providerFilter = $('Set Input Params1').first().json.provider_filter || '';\n} catch (e) {}\n\nlet providers = Object.keys(responsesByProvider);\nif (providerFilter) {\n    providers = providers.filter(p => p.toLowerCase().includes(providerFilter.toLowerCase()));\n}\n\nif (providers.length === 0) {\n    return [{ json: { error: 'No providers found', filter: providerFilter } }];\n}\n\n/* =========================\nNew Criteria Weights (total = 100%)\n========================= */\nconst CRITERIA_WEIGHTS = {\n    // TECHNICAL COMPLETENESS (30%)\n    scope_facilities: 0.10,\n    scope_work: 0.10,\n    deliverables_quality: 0.10,\n    // ECONOMIC COMPETITIVENESS (35%)\n    total_price: 0.15,\n    price_breakdown: 0.08,\n    optionals_included: 0.07,\n    capex_opex_methodology: 0.05,\n    // EXECUTION CAPABILITY (20%)\n    schedule: 0.08,\n    resources_allocation: 0.06,\n    exceptions: 0.06,\n    // HSE & COMPLIANCE (15%)\n    safety_studies: 0.08,\n    regulatory_compliance: 0.07\n};\n\nconst CATEGORY_WEIGHTS = {\n    TECHNICAL: 0.30,\n    ECONOMIC: 0.35,\n    EXECUTION: 0.20,\n    HSE_COMPLIANCE: 0.15\n};\n\n/* =========================\nEvaluation by Criteria\n========================= */\nconst evaluationData = providers.map(providerName => {\n    const providerResponses = responsesByProvider[providerName] || [];\n    \n    // Initialize criteria summary\n    const criteriaScores = {};\n    Object.keys(CRITERIA_WEIGHTS).forEach(criterion => {\n        criteriaScores[criterion] = { total: 0, included: 0, partial: 0, not_included: 0, no_info: 0, scores: [] };\n    });\n    \n    providerResponses.forEach(resp => {\n        const req = requirementMap[resp.requirement_id];\n        if (!req) return;\n        \n        const criterion = getCriterionFromRequirement(req.evaluation_type, req.phase, req.requirement_text);\n        const evalClass = classifyEval(resp.evaluation_value);\n        \n        const cs = criteriaScores[criterion];\n        if (!cs) return;\n        \n        cs.total++;\n        if (evalClass === 'INCLUDED') cs.included++;\n        else if (evalClass === 'PARTIAL') cs.partial++;\n        else if (evalClass === 'NOT_INCLUDED') cs.not_included++;\n        else cs.no_info++;\n        \n        if (typeof resp.score === 'number') {\n            cs.scores.push(resp.score);\n        }\n    });\n    \n    // Calculate average scores per criterion\n    let globalScore = 0;\n    const criteriaAvgScores = {};\n    \n    Object.keys(criteriaScores).forEach(criterion => {\n        const cs = criteriaScores[criterion];\n        if (cs.scores.length > 0) {\n            cs.avg_score = Math.round((cs.scores.reduce((a, b) => a + b, 0) / cs.scores.length) * 100) / 100;\n        } else if (cs.total > 0) {\n            // Calculate from compliance\n            cs.avg_score = Math.round(((cs.included * 10 + cs.partial * 5) / cs.total) * 100) / 100;\n        } else {\n            cs.avg_score = 0;\n        }\n        criteriaAvgScores[criterion] = cs.avg_score;\n        globalScore += cs.avg_score * (CRITERIA_WEIGHTS[criterion] || 0);\n        delete cs.scores;\n    });\n    \n    globalScore = Math.round(globalScore * 100) / 100;\n    \n    // Calculate category scores\n    const categoryScores = {\n        TECHNICAL: Math.round(((criteriaAvgScores.scope_facilities || 0) + (criteriaAvgScores.scope_work || 0) + (criteriaAvgScores.deliverables_quality || 0)) / 3 * 100) / 100,\n        ECONOMIC: Math.round(((criteriaAvgScores.total_price || 0) + (criteriaAvgScores.price_breakdown || 0) + (criteriaAvgScores.optionals_included || 0) + (criteriaAvgScores.capex_opex_methodology || 0)) / 4 * 100) / 100,\n        EXECUTION: Math.round(((criteriaAvgScores.schedule || 0) + (criteriaAvgScores.resources_allocation || 0) + (criteriaAvgScores.exceptions || 0)) / 3 * 100) / 100,\n        HSE_COMPLIANCE: Math.round(((criteriaAvgScores.safety_studies || 0) + (criteriaAvgScores.regulatory_compliance || 0)) / 2 * 100) / 100\n    };\n    \n    return {\n        provider_name: providerName,\n        project_id: projectId,\n        total_responses: providerResponses.length,\n        global_score: globalScore,\n        category_scores: categoryScores,\n        criteria_scores: criteriaAvgScores,\n        criteria_summary: criteriaScores\n    };\n});\n\n/* =========================\nExecutive Ranking\n========================= */\nevaluationData\n    .sort((a, b) => b.global_score - a.global_score)\n    .forEach((item, index) => {\n        item.rank = index + 1;\n    });\n\nconsole.log('‚úÖ Scoring Data prepared for', evaluationData.length, 'providers');\nconsole.log('   Project ID included:', projectId);\n\nreturn evaluationData.map(data => ({ json: data }));"
        },
        "type": "n8n-nodes-base.code",
        "typeVersion": 2,
        "position": [
          -5136,
          -640
        ],
        "id": "92aa13d3-2a98-45fd-8544-c5495f5511dd",
        "name": "Prepare Scoring Data"
      },
      {
        "parameters": {
          "options": {
            "reset": false
          }
        },
        "type": "n8n-nodes-base.splitInBatches",
        "typeVersion": 3,
        "position": [
          -4912,
          -688
        ],
        "id": "6a045a0f-79d4-4f0f-8fba-90bf2fbd7bda",
        "name": "Loop Over Providers"
      },
      {
        "parameters": {
          "promptType": "define",
          "text": "=Score this engineering proposal provider based on RFQ compliance.\n\n## PROVIDER: {{ $json.provider_name }}\n## TOTAL RESPONSES: {{ $json.total_responses }}\n\n## CATEGORY SCORES (pre-calculated):\n{{ JSON.stringify($json.category_scores, null, 2) }}\n\n## INDIVIDUAL CRITERIA SCORES:\n{{ JSON.stringify($json.criteria_scores, null, 2) }}\n\n## CRITERIA DETAILS:\n{{ JSON.stringify($json.criteria_summary, null, 2) }}\n\n## EVALUATION CRITERIA (weights):\n### TECHNICAL COMPLETENESS (30%)\n- scope_facilities: 10% - H2 plant, BOP, utilities included\n- scope_work: 10% - PM, studies, deliverables covered\n- deliverables_quality: 10% - P&IDs, specs, 3D model quality\n\n### ECONOMIC COMPETITIVENESS (35%)\n- total_price: 15% - PRE-FEED + FEED + EPC price competitiveness\n- price_breakdown: 8% - Transparent hours/discipline, ‚Ç¨/hour\n- optionals_included: 7% - Geotechnical, topographic, 3D, HAZID in base\n- capex_opex_methodology: 5% - AACEI class, estimate robustness\n\n### EXECUTION CAPABILITY (20%)\n- schedule: 8% - Realistic timeline vs requirements\n- resources_allocation: 6% - Coherent hours per discipline\n- exceptions: 6% - Fewer exceptions = better (invert score)\n\n### HSE & COMPLIANCE (15%)\n- safety_studies: 8% - HAZID, HAZOP, QRA, ATEX included\n- regulatory_compliance: 7% - Codes, standards, safety distances\n\n## SCORING RULES:\n- included items = 10 points\n- partial items = 6 points\n- not_included items = 2 points\n- no_info items = 0 points\n- For 'exceptions': FEWER is BETTER (invert: more exceptions = lower score)\n\n## OUTPUT (JSON only):\n{\n  \"provider_name\": \"string\",\n  \"category_scores\": {\n    \"TECHNICAL\": { \"score\": number, \"weight\": 0.30 },\n    \"ECONOMIC\": { \"score\": number, \"weight\": 0.35 },\n    \"EXECUTION\": { \"score\": number, \"weight\": 0.20 },\n    \"HSE_COMPLIANCE\": { \"score\": number, \"weight\": 0.15 }\n  },\n  \"individual_scores\": {\n    \"scope_facilities\": number,\n    \"scope_work\": number,\n    \"deliverables_quality\": number,\n    \"total_price\": number,\n    \"price_breakdown\": number,\n    \"optionals_included\": number,\n    \"capex_opex_methodology\": number,\n    \"schedule\": number,\n    \"resources_allocation\": number,\n    \"exceptions\": number,\n    \"safety_studies\": number,\n    \"regulatory_compliance\": number\n  },\n  \"overall_score\": number,\n  \"compliance_percentage\": number,\n  \"evaluation_summary\": \"1-2 sentences comparing to ideal proposal\",\n  \"strengths\": [\"max 3 specific strengths\"],\n  \"weaknesses\": [\"max 3 specific areas for improvement\"]\n}",
          "hasOutputParser": true,
          "batching": {}
        },
        "type": "@n8n/n8n-nodes-langchain.chainLlm",
        "typeVersion": 1.8,
        "position": [
          -4640,
          -672
        ],
        "id": "9d1821cb-5b3b-4a8d-853b-654184e7e7c0",
        "name": "Scoring LLM Chain"
      },
      {
        "parameters": {
          "jsCode": "// =============================================\n// NODE: Calculate Weighted Scores (v4 - New Criteria)\n// Extract and structure scores for database storage\n// =============================================\n\nconst input = $input.first().json;\nconst llmOutput = input.output || input;\n\n// Get project_id\nlet projectId = null;\ntry { projectId = $('Set Input Params1').first().json.project_id; } catch(e) {}\n\n// Extract category scores\nconst cs = llmOutput.category_scores || {};\nconst tech = (cs.TECHNICAL && cs.TECHNICAL.score) || cs.TECHNICAL || 0;\nconst econ = (cs.ECONOMIC && cs.ECONOMIC.score) || cs.ECONOMIC || 0;\nconst exec = (cs.EXECUTION && cs.EXECUTION.score) || cs.EXECUTION || 0;\nconst hse = (cs.HSE_COMPLIANCE && cs.HSE_COMPLIANCE.score) || cs.HSE_COMPLIANCE || 0;\n\n// Extract individual criterion scores\nconst is = llmOutput.individual_scores || {};\n\nreturn [{\n    json: {\n        ranking: {\n            provider_name: llmOutput.provider_name,\n            project_id: projectId,\n            // Category scores\n            technical_score: tech,\n            economic_score: econ,\n            execution_score: exec,\n            hse_compliance_score: hse,\n            // TECHNICAL COMPLETENESS individual scores (30%)\n            scope_facilities_score: is.scope_facilities || 0,\n            scope_work_score: is.scope_work || 0,\n            deliverables_quality_score: is.deliverables_quality || 0,\n            // ECONOMIC COMPETITIVENESS individual scores (35%)\n            total_price_score: is.total_price || 0,\n            price_breakdown_score: is.price_breakdown || 0,\n            optionals_included_score: is.optionals_included || 0,\n            capex_opex_methodology_score: is.capex_opex_methodology || 0,\n            // EXECUTION CAPABILITY individual scores (20%)\n            schedule_score: is.schedule || 0,\n            resources_allocation_score: is.resources_allocation || 0,\n            exceptions_score: is.exceptions || 0,\n            // HSE & COMPLIANCE individual scores (15%)\n            safety_studies_score: is.safety_studies || 0,\n            regulatory_compliance_score: is.regulatory_compliance || 0,\n            // Overall metrics\n            overall_score: llmOutput.overall_score || 0,\n            compliance_percentage: llmOutput.compliance_percentage || 0,\n            evaluation_count: 1,\n            last_updated: new Date().toISOString()\n        },\n        details: {\n            strengths: llmOutput.strengths || [],\n            weaknesses: llmOutput.weaknesses || [],\n            recommendations: llmOutput.recommendations || [],\n            summary: llmOutput.evaluation_summary || ''\n        },\n        category_scores: cs,\n        individual_scores: is\n    }\n}];"
        },
        "type": "n8n-nodes-base.code",
        "typeVersion": 2,
        "position": [
          -4256,
          -672
        ],
        "id": "4753e1c9-65ba-4823-8e50-7f4cc837876d",
        "name": "Calculate Weighted Scores"
      },
      {
        "parameters": {
          "operation": "getAll",
          "tableId": "ranking_proveedores",
          "limit": 1
        },
        "type": "n8n-nodes-base.supabase",
        "typeVersion": 1,
        "position": [
          -4016,
          -672
        ],
        "id": "dff158e1-5d0f-4705-a66a-e50f665263ba",
        "name": "Check Provider Exists",
        "alwaysOutputData": true,
        "credentials": {
          "supabaseApi": {
            "id": "pI4CpdYLTiEEBmnz",
            "name": "Supabase account"
          }
        }
      },
      {
        "parameters": {
          "conditions": {
            "options": {
              "caseSensitive": true,
              "leftValue": "",
              "typeValidation": "strict",
              "version": 2
            },
            "conditions": [
              {
                "id": "provider-exists-condition",
                "leftValue": "={{ $json.provider_name }}",
                "rightValue": "={{ $('Loop Over Providers').item.json.provider_name }}",
                "operator": {
                  "type": "string",
                  "operation": "equals"
                }
              }
            ],
            "combinator": "or"
          },
          "options": {}
        },
        "type": "n8n-nodes-base.if",
        "typeVersion": 2.2,
        "position": [
          -3776,
          -672
        ],
        "id": "1ae73bf8-6164-48cb-a072-03614fffab52",
        "name": "Provider Exists?"
      },
      {
        "parameters": {
          "operation": "update",
          "tableId": "ranking_proveedores",
          "filters": {
            "conditions": [
              {
                "keyName": "provider_name",
                "condition": "eq",
                "keyValue": "={{ $('Calculate Weighted Scores').item.json.ranking.provider_name }}"
              }
            ]
          },
          "fieldsUi": {
            "fieldValues": [
              {
                "fieldId": "project_id",
                "fieldValue": "={{ $('Calculate Weighted Scores').item.json.ranking.project_id || null }}"
              },
              {
                "fieldId": "technical_score",
                "fieldValue": "={{ $('Calculate Weighted Scores').item.json.ranking.technical_score || 0 }}"
              },
              {
                "fieldId": "economic_score",
                "fieldValue": "={{ $('Calculate Weighted Scores').item.json.ranking.economic_score || 0 }}"
              },
              {
                "fieldId": "execution_score",
                "fieldValue": "={{ $('Calculate Weighted Scores').item.json.ranking.execution_score || 0 }}"
              },
              {
                "fieldId": "hse_compliance_score",
                "fieldValue": "={{ $('Calculate Weighted Scores').item.json.ranking.hse_compliance_score || 0 }}"
              },
              {
                "fieldId": "scope_facilities_score",
                "fieldValue": "={{ $('Calculate Weighted Scores').item.json.ranking.scope_facilities_score || 0 }}"
              },
              {
                "fieldId": "scope_work_score",
                "fieldValue": "={{ $('Calculate Weighted Scores').item.json.ranking.scope_work_score || 0 }}"
              },
              {
                "fieldId": "deliverables_quality_score",
                "fieldValue": "={{ $('Calculate Weighted Scores').item.json.ranking.deliverables_quality_score || 0 }}"
              },
              {
                "fieldId": "total_price_score",
                "fieldValue": "={{ $('Calculate Weighted Scores').item.json.ranking.total_price_score || 0 }}"
              },
              {
                "fieldId": "price_breakdown_score",
                "fieldValue": "={{ $('Calculate Weighted Scores').item.json.ranking.price_breakdown_score || 0 }}"
              },
              {
                "fieldId": "optionals_included_score",
                "fieldValue": "={{ $('Calculate Weighted Scores').item.json.ranking.optionals_included_score || 0 }}"
              },
              {
                "fieldId": "capex_opex_methodology_score",
                "fieldValue": "={{ $('Calculate Weighted Scores').item.json.ranking.capex_opex_methodology_score || 0 }}"
              },
              {
                "fieldId": "schedule_score",
                "fieldValue": "={{ $('Calculate Weighted Scores').item.json.ranking.schedule_score || 0 }}"
              },
              {
                "fieldId": "resources_allocation_score",
                "fieldValue": "={{ $('Calculate Weighted Scores').item.json.ranking.resources_allocation_score || 0 }}"
              },
              {
                "fieldId": "exceptions_score",
                "fieldValue": "={{ $('Calculate Weighted Scores').item.json.ranking.exceptions_score || 0 }}"
              },
              {
                "fieldId": "safety_studies_score",
                "fieldValue": "={{ $('Calculate Weighted Scores').item.json.ranking.safety_studies_score || 0 }}"
              },
              {
                "fieldId": "regulatory_compliance_score",
                "fieldValue": "={{ $('Calculate Weighted Scores').item.json.ranking.regulatory_compliance_score || 0 }}"
              },
              {
                "fieldId": "overall_score",
                "fieldValue": "={{ $('Calculate Weighted Scores').item.json.ranking.overall_score || 0 }}"
              },
              {
                "fieldId": "compliance_percentage",
                "fieldValue": "={{ $('Calculate Weighted Scores').item.json.ranking.compliance_percentage || 0 }}"
              },
              {
                "fieldId": "evaluation_count",
                "fieldValue": "={{ $('Calculate Weighted Scores').item.json.ranking.evaluation_count || 0 }}"
              },
              {
                "fieldId": "last_updated",
                "fieldValue": "={{ $('Calculate Weighted Scores').item.json.ranking.last_updated }}"
              }
            ]
          }
        },
        "type": "n8n-nodes-base.supabase",
        "typeVersion": 1,
        "position": [
          -3536,
          -768
        ],
        "id": "fe3f66ec-e183-4d05-9edd-1793b87abb01",
        "name": "Update Ranking",
        "credentials": {
          "supabaseApi": {
            "id": "pI4CpdYLTiEEBmnz",
            "name": "Supabase account"
          }
        }
      },
      {
        "parameters": {
          "tableId": "ranking_proveedores",
          "fieldsUi": {
            "fieldValues": [
              {
                "fieldId": "provider_name",
                "fieldValue": "={{ $('Calculate Weighted Scores').item.json.ranking.provider_name }}"
              },
              {
                "fieldId": "project_id",
                "fieldValue": "={{ $('Calculate Weighted Scores').item.json.ranking.project_id || null }}"
              },
              {
                "fieldId": "technical_score",
                "fieldValue": "={{ $('Calculate Weighted Scores').item.json.ranking.technical_score || 0 }}"
              },
              {
                "fieldId": "economic_score",
                "fieldValue": "={{ $('Calculate Weighted Scores').item.json.ranking.economic_score || 0 }}"
              },
              {
                "fieldId": "execution_score",
                "fieldValue": "={{ $('Calculate Weighted Scores').item.json.ranking.execution_score || 0 }}"
              },
              {
                "fieldId": "hse_compliance_score",
                "fieldValue": "={{ $('Calculate Weighted Scores').item.json.ranking.hse_compliance_score || 0 }}"
              },
              {
                "fieldId": "scope_facilities_score",
                "fieldValue": "={{ $('Calculate Weighted Scores').item.json.ranking.scope_facilities_score || 0 }}"
              },
              {
                "fieldId": "scope_work_score",
                "fieldValue": "={{ $('Calculate Weighted Scores').item.json.ranking.scope_work_score || 0 }}"
              },
              {
                "fieldId": "deliverables_quality_score",
                "fieldValue": "={{ $('Calculate Weighted Scores').item.json.ranking.deliverables_quality_score || 0 }}"
              },
              {
                "fieldId": "total_price_score",
                "fieldValue": "={{ $('Calculate Weighted Scores').item.json.ranking.total_price_score || 0 }}"
              },
              {
                "fieldId": "price_breakdown_score",
                "fieldValue": "={{ $('Calculate Weighted Scores').item.json.ranking.price_breakdown_score || 0 }}"
              },
              {
                "fieldId": "optionals_included_score",
                "fieldValue": "={{ $('Calculate Weighted Scores').item.json.ranking.optionals_included_score || 0 }}"
              },
              {
                "fieldId": "capex_opex_methodology_score",
                "fieldValue": "={{ $('Calculate Weighted Scores').item.json.ranking.capex_opex_methodology_score || 0 }}"
              },
              {
                "fieldId": "schedule_score",
                "fieldValue": "={{ $('Calculate Weighted Scores').item.json.ranking.schedule_score || 0 }}"
              },
              {
                "fieldId": "resources_allocation_score",
                "fieldValue": "={{ $('Calculate Weighted Scores').item.json.ranking.resources_allocation_score || 0 }}"
              },
              {
                "fieldId": "exceptions_score",
                "fieldValue": "={{ $('Calculate Weighted Scores').item.json.ranking.exceptions_score || 0 }}"
              },
              {
                "fieldId": "safety_studies_score",
                "fieldValue": "={{ $('Calculate Weighted Scores').item.json.ranking.safety_studies_score || 0 }}"
              },
              {
                "fieldId": "regulatory_compliance_score",
                "fieldValue": "={{ $('Calculate Weighted Scores').item.json.ranking.regulatory_compliance_score || 0 }}"
              },
              {
                "fieldId": "overall_score",
                "fieldValue": "={{ $('Calculate Weighted Scores').item.json.ranking.overall_score || 0 }}"
              },
              {
                "fieldId": "compliance_percentage",
                "fieldValue": "={{ $('Calculate Weighted Scores').item.json.ranking.compliance_percentage || 0 }}"
              },
              {
                "fieldId": "evaluation_count",
                "fieldValue": "={{ $('Calculate Weighted Scores').item.json.ranking.evaluation_count || 0 }}"
              },
              {
                "fieldId": "last_updated",
                "fieldValue": "={{ $('Calculate Weighted Scores').item.json.ranking.last_updated }}"
              }
            ]
          }
        },
        "type": "n8n-nodes-base.supabase",
        "typeVersion": 1,
        "position": [
          -3536,
          -560
        ],
        "id": "b6745f97-887d-4f96-876c-9442f2c63f5b",
        "name": "Insert Ranking",
        "credentials": {
          "supabaseApi": {
            "id": "pI4CpdYLTiEEBmnz",
            "name": "Supabase account"
          }
        }
      },
      {
        "parameters": {
          "aggregate": "aggregateAllItemData",
          "destinationFieldName": "all_rankings",
          "options": {}
        },
        "type": "n8n-nodes-base.aggregate",
        "typeVersion": 1,
        "position": [
          -4640,
          -848
        ],
        "id": "dc3956b7-8c48-476c-bd5a-f8cbeeff87d1",
        "name": "Aggregate All Rankings"
      },
      {
        "parameters": {
          "jsCode": "// =============================================\n// NODE: Generate Final Ranking with Details (v4)\n// New criteria based on RFQ requirements\n// Categories: TECHNICAL (30%), ECONOMIC (35%), EXECUTION (20%), HSE_COMPLIANCE (15%)\n// =============================================\n\nconst items = $input.all();\nlet allRankings = [];\n\nitems.forEach(item => {\n    if (item.json.all_rankings) {\n        allRankings = allRankings.concat(item.json.all_rankings);\n    } else if (item.json.ranking) {\n        allRankings.push(item.json);\n    }\n});\n\nconst sortedRankings = allRankings\n    .map(r => ({\n        ranking: r.ranking || r,\n        details: r.details || {},\n        category_scores: r.category_scores || {},\n        individual_scores: r.individual_scores || {}\n    }))\n    .sort((a, b) => (b.ranking.overall_score || 0) - (a.ranking.overall_score || 0));\n\nconst finalRanking = sortedRankings.map((r, idx) => ({\n    position: idx + 1,\n    provider_name: r.ranking.provider_name,\n    overall_score: r.ranking.overall_score,\n    compliance_percentage: r.ranking.compliance_percentage,\n    // Aggregated category scores\n    category_scores: {\n        technical: r.ranking.technical_score,\n        economic: r.ranking.economic_score,\n        execution: r.ranking.execution_score,\n        hse_compliance: r.ranking.hse_compliance_score\n    },\n    // All individual criterion scores\n    individual_scores: {\n        // TECHNICAL COMPLETENESS (30%)\n        scope_facilities: r.ranking.scope_facilities_score || r.individual_scores?.scope_facilities || 0,\n        scope_work: r.ranking.scope_work_score || r.individual_scores?.scope_work || 0,\n        deliverables_quality: r.ranking.deliverables_quality_score || r.individual_scores?.deliverables_quality || 0,\n        // ECONOMIC COMPETITIVENESS (35%)\n        total_price: r.ranking.total_price_score || r.individual_scores?.total_price || 0,\n        price_breakdown: r.ranking.price_breakdown_score || r.individual_scores?.price_breakdown || 0,\n        optionals_included: r.ranking.optionals_included_score || r.individual_scores?.optionals_included || 0,\n        capex_opex_methodology: r.ranking.capex_opex_methodology_score || r.individual_scores?.capex_opex_methodology || 0,\n        // EXECUTION CAPABILITY (20%)\n        schedule: r.ranking.schedule_score || r.individual_scores?.schedule || 0,\n        resources_allocation: r.ranking.resources_allocation_score || r.individual_scores?.resources_allocation || 0,\n        exceptions: r.ranking.exceptions_score || r.individual_scores?.exceptions || 0,\n        // HSE & COMPLIANCE (15%)\n        safety_studies: r.ranking.safety_studies_score || r.individual_scores?.safety_studies || 0,\n        regulatory_compliance: r.ranking.regulatory_compliance_score || r.individual_scores?.regulatory_compliance || 0\n    },\n    evaluation: {\n        strengths: r.details.strengths || [],\n        weaknesses: r.details.weaknesses || [],\n        recommendations: r.details.recommendations || [],\n        summary: r.details.summary || ''\n    }\n}));\n\nconst stats = {\n    total_providers: finalRanking.length,\n    average_score: finalRanking.reduce((sum, r) => sum + (r.overall_score || 0), 0) / (finalRanking.length || 1),\n    top_performer: finalRanking[0]?.provider_name || 'N/A',\n    score_range: {\n        min: Math.min(...finalRanking.map(r => r.overall_score || 0)),\n        max: Math.max(...finalRanking.map(r => r.overall_score || 0))\n    },\n    evaluation_date: new Date().toISOString(),\n    criteria_weights: {\n        TECHNICAL_COMPLETENESS: {\n            total: '30%',\n            scope_facilities: '10%',\n            scope_work: '10%',\n            deliverables_quality: '10%'\n        },\n        ECONOMIC_COMPETITIVENESS: {\n            total: '35%',\n            total_price: '15%',\n            price_breakdown: '8%',\n            optionals_included: '7%',\n            capex_opex_methodology: '5%'\n        },\n        EXECUTION_CAPABILITY: {\n            total: '20%',\n            schedule: '8%',\n            resources_allocation: '6%',\n            exceptions: '6%'\n        },\n        HSE_COMPLIANCE: {\n            total: '15%',\n            safety_studies: '8%',\n            regulatory_compliance: '7%'\n        }\n    }\n};\n\nconsole.log(`üèÜ Final Ranking Generated:`);\nfinalRanking.forEach(r => {\n    console.log(`   ${r.position}. ${r.provider_name}: ${r.overall_score} (${r.compliance_percentage}%)`);\n});\n\nreturn {\n    json: {\n        success: true,\n        ranking: finalRanking,\n        statistics: stats,\n        message: `Scoring completed for ${finalRanking.length} providers using 11 RFQ-aligned criteria`\n    }\n};"
        },
        "type": "n8n-nodes-base.code",
        "typeVersion": 2,
        "position": [
          -4352,
          -848
        ],
        "id": "30b06429-79f4-46fc-9c54-e0b1451eab53",
        "name": "Generate Final Ranking"
      },
      {
        "parameters": {
          "respondWith": "json",
          "responseBody": "={{ $json }}",
          "options": {
            "responseHeaders": {
              "entries": [
                {
                  "name": "Content-Type",
                  "value": "application/json"
                }
              ]
            }
          }
        },
        "type": "n8n-nodes-base.respondToWebhook",
        "typeVersion": 1.5,
        "position": [
          -4128,
          -848
        ],
        "id": "f2742be7-7072-48b6-b394-5a815a37de1c",
        "name": "Respond with Ranking"
      },
      {
        "parameters": {
          "content": "## Scoring Workflow - Provider Evaluation\n## RFQ-Aligned Criteria (11 criteria)\n## Based on Engineering Proposals Requirements\n\n### Category Weights:\n\n**TECHNICAL COMPLETENESS (30%)**\n- Scope of Facilities: 10%\n- Scope of Work: 10%\n- Deliverables Quality: 10%\n\n**ECONOMIC COMPETITIVENESS (35%)**\n- Total Price: 15%\n- Price Breakdown: 8%\n- Optionals Included: 7%\n- CAPEX/OPEX Methodology: 5%\n\n**EXECUTION CAPABILITY (20%)**\n- Schedule: 8%\n- Resources Allocation: 6%\n- Exceptions: 6%\n\n**HSE & COMPLIANCE (15%)**\n- Safety Studies: 8%\n- Regulatory Compliance: 7%\n\n### Endpoint:\nPOST /webhook/scoring-evaluation\n```json\n{\n  \"project_id\": \"uuid\",\n  \"provider_name\": \"filter\",\n  \"recalculate_all\": false\n}\n```",
          "height": 1264,
          "width": 3280
        },
        "type": "n8n-nodes-base.stickyNote",
        "typeVersion": 1,
        "position": [
          -6592,
          -1248
        ],
        "id": "089fd564-e227-4dfb-8798-ff3ce5f92d1c",
        "name": "Workflow Info"
      },
      {
        "parameters": {
          "content": "## AI Scoring\n\nEvaluates engineering proposals using:\n- 11 RFQ-aligned criteria\n- Value-for-money comparison\n- Strengths and weaknesses\n- Recommendations\n\nStructured JSON output",
          "height": 220,
          "width": 320,
          "color": 6
        },
        "type": "n8n-nodes-base.stickyNote",
        "typeVersion": 1,
        "position": [
          -4736,
          -1104
        ],
        "id": "dda1bd65-bffe-4301-a88e-e86b60a18e09",
        "name": "LLM Scoring Info"
      },
      {
        "parameters": {
          "assignments": {
            "assignments": [
              {
                "id": "project_id",
                "name": "project_id",
                "value": "={{ $('Webhook Scoring').first().json.body.project_id }}",
                "type": "string"
              },
              {
                "id": "provider_filter",
                "name": "provider_filter",
                "value": "={{ $('Webhook Scoring').first().json.body.provider_name || '' }}",
                "type": "string"
              },
              {
                "id": "recalculate_all",
                "name": "recalculate_all",
                "value": "={{ $('Webhook Scoring').first().json.body.recalculate_all || false }}",
                "type": "boolean"
              }
            ]
          },
          "options": {}
        },
        "type": "n8n-nodes-base.set",
        "typeVersion": 3.4,
        "position": [
          -5808,
          -640
        ],
        "id": "6856c116-27d4-4206-9d5a-d6247b703fb6",
        "name": "Set Input Params1"
      },
      {
        "parameters": {
          "schemaType": "manual",
          "inputSchema": "{\n  \"type\": \"object\",\n  \"properties\": {\n    \"provider_name\": { \"type\": \"string\" },\n    \"category_scores\": {\n      \"type\": \"object\",\n      \"properties\": {\n        \"TECHNICAL\": { \"type\": \"object\", \"properties\": { \"score\": { \"type\": \"number\" }, \"weight\": { \"type\": \"number\" } } },\n        \"ECONOMIC\": { \"type\": \"object\", \"properties\": { \"score\": { \"type\": \"number\" }, \"weight\": { \"type\": \"number\" } } },\n        \"EXECUTION\": { \"type\": \"object\", \"properties\": { \"score\": { \"type\": \"number\" }, \"weight\": { \"type\": \"number\" } } },\n        \"HSE_COMPLIANCE\": { \"type\": \"object\", \"properties\": { \"score\": { \"type\": \"number\" }, \"weight\": { \"type\": \"number\" } } }\n      }\n    },\n    \"individual_scores\": {\n      \"type\": \"object\",\n      \"properties\": {\n        \"scope_facilities\": { \"type\": \"number\" },\n        \"scope_work\": { \"type\": \"number\" },\n        \"deliverables_quality\": { \"type\": \"number\" },\n        \"total_price\": { \"type\": \"number\" },\n        \"price_breakdown\": { \"type\": \"number\" },\n        \"optionals_included\": { \"type\": \"number\" },\n        \"capex_opex_methodology\": { \"type\": \"number\" },\n        \"schedule\": { \"type\": \"number\" },\n        \"resources_allocation\": { \"type\": \"number\" },\n        \"exceptions\": { \"type\": \"number\" },\n        \"safety_studies\": { \"type\": \"number\" },\n        \"regulatory_compliance\": { \"type\": \"number\" }\n      }\n    },\n    \"overall_score\": { \"type\": \"number\" },\n    \"compliance_percentage\": { \"type\": \"number\" },\n    \"evaluation_summary\": { \"type\": \"string\" },\n    \"strengths\": { \"type\": \"array\", \"items\": { \"type\": \"string\" } },\n    \"weaknesses\": { \"type\": \"array\", \"items\": { \"type\": \"string\" } },\n    \"recommendations\": { \"type\": \"array\", \"items\": { \"type\": \"string\" } }\n  },\n  \"required\": [\"provider_name\", \"category_scores\", \"individual_scores\", \"overall_score\", \"compliance_percentage\"]\n}"
        },
        "type": "@n8n/n8n-nodes-langchain.outputParserStructured",
        "typeVersion": 1.3,
        "position": [
          -4496,
          -448
        ],
        "id": "395a4d79-b3d8-4d2d-a582-205779de365c",
        "name": "JSON Output Parser1"
      },
      {
        "parameters": {
          "model": "qwen3:8b",
          "options": {
            "temperature": 0.1,
            "numCtx": 8192,
            "numPredict": 2048
          }
        },
        "type": "@n8n/n8n-nodes-langchain.lmChatOllama",
        "typeVersion": 1,
        "position": [
          -4752,
          -464
        ],
        "id": "c90fa7ad-df69-4c62-b2c1-9fafb4924386",
        "name": "Ollama Scoring Model",
        "credentials": {
          "ollamaApi": {
            "id": "oS2Qqti9oVfsm8XZ",
            "name": "Ollama account"
          }
        }
      },
      {
        "parameters": {
          "operation": "delete",
          "tableId": "ranking_proveedores",
          "filters": {
            "conditions": [
              {
                "keyName": "provider_name",
                "condition": "neq",
                "keyValue": "R"
              }
            ]
          }
        },
        "type": "n8n-nodes-base.supabase",
        "typeVersion": 1,
        "position": [
          -6032,
          -640
        ],
        "id": "a62cf5f8-2c95-4081-b833-88518ed06b97",
        "name": "Delete a row",
        "alwaysOutputData": true,
        "credentials": {
          "supabaseApi": {
            "id": "pI4CpdYLTiEEBmnz",
            "name": "Supabase account"
          }
        }
      },
      {
        "parameters": {
          "options": {}
        },
        "type": "@n8n/n8n-nodes-langchain.lmChatOpenRouter",
        "typeVersion": 1,
        "position": [
          -4656,
          -368
        ],
        "id": "12260ff1-4e47-4d69-a207-e1d6d6181e4a",
        "name": "OpenRouter Chat Model1",
        "credentials": {
          "openRouterApi": {
            "id": "4AyUqsh1Z35g6bci",
            "name": "OpenRouter account"
          }
        }
      },
      {
        "parameters": {
          "assignments": {
            "assignments": [
              {
                "id": "6d3a985e-7c5e-4c74-8b5e-407e4d8c83a9",
                "name": "project_name",
                "value": "={{ $json.body.project_name }}",
                "type": "string"
              },
              {
                "id": "project-id-uuid-field",
                "name": "project_id",
                "value": "={{ $json.body.project_id }}",
                "type": "string"
              },
              {
                "id": "2d3a985e-7c5e-4c74-8b5e-407e4d8c83a1",
                "name": "provider_name",
                "value": "={{ $json.body.provider_key }}",
                "type": "string"
              },
              {
                "id": "3d3a985e-7c5e-4c74-8b5e-407e4d8c83a2",
                "name": "tone",
                "value": "={{ $json.body.tone }}",
                "type": "string"
              },
              {
                "id": "4d3a985e-7c5e-4c74-8b5e-407e4d8c83a3",
                "name": "qa_items",
                "value": "={{ $json.body.qa_items }}",
                "type": "array"
              }
            ]
          },
          "options": {}
        },
        "type": "n8n-nodes-base.set",
        "typeVersion": 3.4,
        "position": [
          -2720,
          -784
        ],
        "id": "17fc1691-b00c-471d-940c-e577b09aa01a",
        "name": "Edit Fields"
      },
      {
        "parameters": {
          "jsCode": "// 1. Obtenemos TODOS los datos de Supabase y de Edit Fields\nconst allOffers = $('Get Offers').all();\nconst editFields = $('Edit Fields').first().json;\nconst targetProvider = editFields.provider_name;\nconst qaItems = $('Edit Fields').first().json.qa_items || [];\n\nlet issuesFound = [];\n\n// 2. Iteramos por todos los registros\nfor (const item of allOffers) {\n  const row = item.json;\n  \n  // Solo procesamos si el proveedor coincide\n  if (row.provider_name === targetProvider) {\n    const status = (row.evaluation_value || '').trim();\n    \n    // CRITERIO: Si es distinto de \"INCLUIDO\" (ignorando may√∫sculas/min√∫sculas), es un ISSUE\n    if (status.toUpperCase() !== 'INCLUIDO') {\n      // Usar descripci√≥n legible en lugar de UUID\n      const description = row.requirement_text || row.item_description || row.comment || 'Item requires clarification';\n      issuesFound.push({\n        description: description,\n        status: status || 'NOT PROVIDED',\n        provider_comment: row.comment || ''\n      });\n    }\n  }\n}\n\n// 3. Preparar Q&A questions si existen\nconst qaQuestions = qaItems.map(q => ({\n  question: q.question || q.pregunta_texto,\n  discipline: q.discipline || q.disciplina,\n  importance: q.importance || q.importancia\n}));\n\n// 4. Devolvemos un solo objeto con toda la info para el LLM\nreturn {\n  issues: issuesFound,\n  total_issues: issuesFound.length,\n  qa_questions: qaQuestions,\n  total_qa_questions: qaQuestions.length,\n  project_id: editFields.project_id,\n  project_name: editFields.project_name,\n  provider_name: targetProvider,\n  tone: editFields.tone\n};"
        },
        "type": "n8n-nodes-base.code",
        "typeVersion": 2,
        "position": [
          -2272,
          -784
        ],
        "id": "645127fb-d184-424b-9a56-ceef64fe79cd",
        "name": "Filter and Aggregate Issues"
      },
      {
        "parameters": {
          "content": "## Email en base datos faltantes\n",
          "height": 864,
          "width": 2016,
          "color": 6
        },
        "type": "n8n-nodes-base.stickyNote",
        "typeVersion": 1,
        "position": [
          -3232,
          -1072
        ],
        "id": "be3af833-ea23-467f-b7eb-86edd2888f1d",
        "name": "Sticky Note2"
      },
      {
        "parameters": {
          "httpMethod": "POST",
          "path": "mail",
          "responseMode": "responseNode",
          "options": {}
        },
        "type": "n8n-nodes-base.webhook",
        "typeVersion": 2.1,
        "position": [
          -2944,
          -784
        ],
        "id": "22c6017f-9ca0-4442-aa6e-fadc7989eaad",
        "name": "Webhook3",
        "webhookId": "2dcca6b6-4d20-4250-9202-7b16ac06f716"
      },
      {
        "parameters": {
          "operation": "getAll",
          "tableId": "provider_responses",
          "returnAll": true,
          "filters": {
            "conditions": [
              {
                "keyName": "provider_name",
                "condition": "eq",
                "keyValue": "={{ $json.provider_name }}"
              },
              {
                "keyName": "project_id",
                "condition": "eq",
                "keyValue": "={{ $json.project_id }}"
              }
            ]
          }
        },
        "id": "f11e336c-4546-4c97-90eb-fef38ea34366",
        "name": "Get Offers",
        "type": "n8n-nodes-base.supabase",
        "typeVersion": 1,
        "position": [
          -2496,
          -784
        ],
        "alwaysOutputData": true,
        "credentials": {
          "supabaseApi": {
            "id": "pI4CpdYLTiEEBmnz",
            "name": "Supabase account"
          }
        }
      },
      {
        "parameters": {
          "model": "qwen3:8b",
          "options": {
            "temperature": 0.2,
            "numCtx": 4096,
            "numPredict": 1024
          }
        },
        "type": "@n8n/n8n-nodes-langchain.lmChatOllama",
        "typeVersion": 1,
        "position": [
          -1680,
          -560
        ],
        "id": "f9a3de66-2742-4cfe-9c44-0b8d6b6d0152",
        "name": "Ollama Chat Model",
        "credentials": {
          "ollamaApi": {
            "id": "oS2Qqti9oVfsm8XZ",
            "name": "Ollama account"
          }
        }
      },
      {
        "parameters": {
          "promptType": "define",
          "text": "=### INPUT\n\n## PROJECT: {{ $('Edit Fields').first().json.project_name }}\n\n## PROVIDER: {{ $('Edit Fields').first().json.provider_name }}\n\n## REQUIRED TONE: {{ $('Edit Fields').first().json.tone }}\n\n## ISSUES ({{ $json.total_issues }} items): {{ JSON.stringify($json.issues, null, 2) }}\n\n## TECHNICAL QUESTIONS ({{ $json.total_qa_questions }} items): {{ JSON.stringify($json.qa_questions, null, 2) }}\n\n### FINAL INSTRUCTIONS\nReturn ONLY the JSON object. Do NOT think out loud. Do NOT include any text before or after the JSON.\n",
          "messages": {
            "messageValues": [
              {
                "message": "=### ROLE\nYou are an expert Senior Project Engineer and Procurement Manager for large-scale industrial projects (P2X, Green Hydrogen). You are meticulous, diplomatic, and results-oriented.\n\n### TASK\nDraft a professional email to the Provider regarding their recent proposal for the Project. We have identified specific gaps/issues and technical questions that need to be addressed.\n\n### GUIDELINES\n1. **Subject Line**: Must be clear, professional, and reference the Project name.\n2. **Tone**: Strictly adhere to the requested 'TONE' input.\n3. **Body Content**:\n   - Briefly thank them for the proposal.\n   - State that during the review, the following points require clarification or are missing.\n   - **For ISSUES**: Group them intelligently (e.g., by category or type). For each issue, describe what is missing using the 'description' field. NEVER show any IDs, UUIDs, or internal references.\n   - **For TECHNICAL QUESTIONS**: If there are any qa_questions, add a section titled 'Technical Questions' and list them. Include the discipline and importance level for each.\n   - Ask for these specific items to be provided or clarified.\n4. **Formatting**: Use Markdown formatting (bold, bullet points) for readability.\n5. **IMPORTANT**: NEVER include any UUIDs, internal IDs, requirement_id, or database references. Use only human-readable descriptions.\n\n### CRITICAL: OUTPUT RESTRICTIONS\n- Return **ONLY** a valid JSON object.\n- **DO NOT** include any UUIDs or internal database IDs anywhere in the output.\n- **DO NOT** include any conversational text, explanations, reasoning, thoughts, or technical notes.\n- **DO NOT** use Markdown code blocks (e.g., ```json).\n- The output must start with `{` and end with `}`.\n\n### SCHEMA\n{\n  \"subject\": \"Email Subject Here\",\n  \"body\": \"Email Body Here with **bold** and - bullet points\"\n}"
              }
            ]
          },
          "batching": {}
        },
        "type": "@n8n/n8n-nodes-langchain.chainLlm",
        "typeVersion": 1.8,
        "position": [
          -2048,
          -784
        ],
        "id": "95df2c86-bd76-44a6-9c50-f2328302343a",
        "name": "Basic LLM Chain"
      },
      {
        "parameters": {
          "respondWith": "allIncomingItems",
          "options": {}
        },
        "type": "n8n-nodes-base.respondToWebhook",
        "typeVersion": 1.5,
        "position": [
          -1696,
          -784
        ],
        "id": "1e45d1af-253f-4403-8b9a-93d68493ad57",
        "name": "Respond to Webhook3"
      },
      {
        "parameters": {
          "model": "mistral-large-latest",
          "options": {
            "temperature": 0.1
          }
        },
        "type": "@n8n/n8n-nodes-langchain.lmChatMistralCloud",
        "typeVersion": 1,
        "position": [
          -2128,
          -576
        ],
        "id": "41c2b11c-3a24-4e70-ae51-1892d38bf979",
        "name": "Mistral Cloud Chat Model1",
        "credentials": {
          "mistralCloudApi": {
            "id": "tDjuOnF6lpADMmd5",
            "name": "Mistral Cloud account"
          }
        }
      },
      {
        "parameters": {
          "assignments": {
            "assignments": [
              {
                "id": "to-field",
                "name": "to",
                "value": "={{ $json.body.to }}",
                "type": "string"
              },
              {
                "id": "subject-field",
                "name": "subject",
                "value": "={{ $json.body.subject }}",
                "type": "string"
              },
              {
                "id": "body-field",
                "name": "email_body",
                "value": "={{ $json.body.body }}",
                "type": "string"
              },
              {
                "id": "provider-field",
                "name": "provider_name",
                "value": "={{ $json.body.provider_name }}",
                "type": "string"
              },
              {
                "id": "project-id-field",
                "name": "project_id",
                "value": "={{ $json.body.project_id }}",
                "type": "string"
              },
              {
                "id": "project-name-field",
                "name": "project_name",
                "value": "={{ $json.body.project_name }}",
                "type": "string"
              }
            ]
          },
          "options": {}
        },
        "type": "n8n-nodes-base.set",
        "typeVersion": 3.4,
        "position": [
          -2288,
          1408
        ],
        "id": "562cd215-3cc3-4322-bf0e-315158868bbe",
        "name": "Extract Fields"
      },
      {
        "parameters": {
          "conditions": {
            "options": {
              "caseSensitive": true,
              "leftValue": "",
              "typeValidation": "strict",
              "version": 2
            },
            "conditions": [
              {
                "id": "check-to-email",
                "leftValue": "={{ $json.to }}",
                "rightValue": "",
                "operator": {
                  "type": "string",
                  "operation": "notEmpty"
                }
              },
              {
                "id": "check-subject",
                "leftValue": "={{ $json.subject }}",
                "rightValue": "",
                "operator": {
                  "type": "string",
                  "operation": "notEmpty"
                }
              },
              {
                "id": "check-body",
                "leftValue": "={{ $json.email_body }}",
                "rightValue": "",
                "operator": {
                  "type": "string",
                  "operation": "notEmpty"
                }
              }
            ],
            "combinator": "and"
          },
          "options": {}
        },
        "type": "n8n-nodes-base.if",
        "typeVersion": 2.2,
        "position": [
          -2064,
          1408
        ],
        "id": "c1a8be10-c84a-4da4-8447-d3bacd20f18c",
        "name": "Validate Data"
      },
      {
        "parameters": {
          "jsCode": "// Convert markdown body to HTML for email\nconst markdownBody = $('Extract Fields').first().json.email_body;\n\n// Simple markdown to HTML conversion\nlet htmlBody = markdownBody\n  // Convert bold\n  .replace(/\\*\\*(.+?)\\*\\*/g, '<strong>$1</strong>')\n  // Convert italic\n  .replace(/\\*(.+?)\\*/g, '<em>$1</em>')\n  // Convert bullet points\n  .replace(/^- (.+)$/gm, '<li>$1</li>')\n  // Wrap lists\n  .replace(/(<li>.*<\\/li>\\n?)+/g, '<ul>$&</ul>')\n  // Convert line breaks to paragraphs\n  .split('\\n\\n')\n  .map(p => p.trim())\n  .filter(p => p.length > 0)\n  .map(p => {\n    if (p.startsWith('<ul>') || p.startsWith('<li>')) return p;\n    return `<p>${p}</p>`;\n  })\n  .join('\\n');\n\n// Add email styling\nconst styledHtml = `\n<!DOCTYPE html>\n<html>\n<head>\n  <style>\n    body { font-family: Arial, sans-serif; line-height: 1.6; color: #333; max-width: 800px; margin: 0 auto; padding: 20px; }\n    p { margin: 0 0 16px 0; }\n    ul { margin: 0 0 16px 0; padding-left: 24px; }\n    li { margin: 4px 0; }\n    strong { font-weight: 600; }\n  </style>\n</head>\n<body>\n${htmlBody}\n</body>\n</html>\n`;\n\nreturn {\n  html_body: styledHtml,\n  to: $('Extract Fields').first().json.to,\n  subject: $('Extract Fields').first().json.subject,\n  provider_name: $('Extract Fields').first().json.provider_name,\n  project_id: $('Extract Fields').first().json.project_id,\n  project_name: $('Extract Fields').first().json.project_name\n};"
        },
        "type": "n8n-nodes-base.code",
        "typeVersion": 2,
        "position": [
          -1840,
          1296
        ],
        "id": "476461eb-ea47-4f6a-bde2-0667e8bba7b6",
        "name": "Convert Markdown to HTML"
      },
      {
        "parameters": {
          "sendTo": "={{ $json.to }}",
          "subject": "={{ $json.subject }}",
          "message": "={{ $json.html_body }}",
          "options": {
            "appendAttribution": false
          }
        },
        "type": "n8n-nodes-base.gmail",
        "typeVersion": 2.1,
        "position": [
          -1632,
          1296
        ],
        "id": "e101ded1-61b6-4ce1-8807-460ef639976a",
        "name": "Gmail Send",
        "webhookId": "f32bcbf1-73d7-463b-b209-b7e114249ee9",
        "disabled": true
      },
      {
        "parameters": {
          "respondWith": "json",
          "responseBody": "={{ JSON.stringify({ success: false, error: 'Missing required fields: to, subject, or body' }) }}",
          "options": {
            "responseCode": 400
          }
        },
        "type": "n8n-nodes-base.respondToWebhook",
        "typeVersion": 1.5,
        "position": [
          -1840,
          1504
        ],
        "id": "18f71245-553d-4249-8438-6125cbc40089",
        "name": "Respond Error"
      },
      {
        "parameters": {
          "content": "## QA Send Email Workflow\n\nThis workflow receives email data from the Mail Dashboard and sends it via Gmail.\n\n**Expected POST body:**\n```json\n{\n  \"to\": \"recipient@email.com\",\n  \"subject\": \"Email Subject\",\n  \"body\": \"Email body in Markdown format\",\n  \"provider_name\": \"Provider Name\",\n  \"project_id\": \"project-uuid\",\n  \"project_name\": \"Project Name\"\n}\n```\n\n**IMPORTANT:** Configure Gmail OAuth2 credentials in the Gmail node.",
          "height": 340,
          "width": 380,
          "color": 6
        },
        "type": "n8n-nodes-base.stickyNote",
        "typeVersion": 1,
        "position": [
          -2704,
          1216
        ],
        "id": "d1b307b5-f1e8-40a7-9de6-debe7703c0ea",
        "name": "Instructions"
      },
      {
        "parameters": {
          "httpMethod": "POST",
          "path": "qa-send-email",
          "responseMode": "responseNode",
          "options": {}
        },
        "type": "n8n-nodes-base.webhook",
        "typeVersion": 2.1,
        "position": [
          -2512,
          1408
        ],
        "id": "537e05da-273d-4acc-ae88-3200fcdd48b5",
        "name": "Webhook2",
        "webhookId": "qa-send-email-webhook"
      },
      {
        "parameters": {
          "respondWith": "json",
          "responseBody": "={{ JSON.stringify({ success: true, message: 'Email sent successfully', to: $json.to, subject: $json.subject }) }}",
          "options": {
            "responseCode": 200
          }
        },
        "type": "n8n-nodes-base.respondToWebhook",
        "typeVersion": 1.5,
        "position": [
          -1408,
          1296
        ],
        "id": "fe3dc493-0082-4d92-972a-a4d52e5c87bf",
        "name": "Respond Success2"
      },
      {
        "parameters": {
          "httpMethod": "POST",
          "path": "qa-send-to-supplier",
          "responseMode": "responseNode",
          "options": {}
        },
        "type": "n8n-nodes-base.webhook",
        "typeVersion": 2.1,
        "position": [
          -6096,
          1008
        ],
        "id": "6c600a41-37ea-414b-b30a-3a65b5f04386",
        "name": "Webhook Receive",
        "webhookId": "qa-send-to-supplier-webhook"
      },
      {
        "parameters": {
          "conditions": {
            "options": {
              "caseSensitive": true,
              "leftValue": "",
              "typeValidation": "strict"
            },
            "conditions": [
              {
                "id": "check-email",
                "leftValue": "={{ $json.email_to }}",
                "rightValue": "",
                "operator": {
                  "type": "string",
                  "operation": "notEmpty"
                }
              }
            ],
            "combinator": "and"
          },
          "options": {}
        },
        "type": "n8n-nodes-base.if",
        "typeVersion": 2.1,
        "position": [
          -4304,
          1008
        ],
        "id": "02be58eb-7490-4fea-90f5-46ff06f6bbcb",
        "name": "Email Provided?"
      },
      {
        "parameters": {
          "sendTo": "={{ $json.email_to }}",
          "subject": "={{ $json.email_subject }}",
          "message": "={{ $json.email_html }}",
          "options": {
            "senderName": "BidEval Team"
          }
        },
        "type": "n8n-nodes-base.gmail",
        "typeVersion": 2.1,
        "position": [
          -4080,
          944
        ],
        "id": "ad49f8dd-e732-47ce-86b6-e6bd7daaaa9c",
        "name": "Send Email via Gmail",
        "webhookId": "9be31203-685f-4b78-a56d-e950bca3a806",
        "disabled": true
      },
      {
        "parameters": {
          "jsCode": "// Generate a random token without crypto module\nfunction generateToken(length = 64) {\n  const chars = 'abcdef0123456789';\n  let token = '';\n  for (let i = 0; i < length; i++) {\n    token += chars.charAt(Math.floor(Math.random() * chars.length));\n  }\n  // Add timestamp for uniqueness\n  const timestamp = Date.now().toString(16);\n  return (timestamp + token).slice(0, 64);\n}\n\nconst token = generateToken();\n\n// Calculate expiration date\nconst expiresDays = $input.first().json.expires_days || 7;\nconst expiresAt = new Date();\nexpiresAt.setDate(expiresAt.getDate() + expiresDays);\n\nreturn {\n  json: {\n    ...$input.first().json,\n    token: token,\n    expires_at: expiresAt.toISOString()\n  }\n};"
        },
        "type": "n8n-nodes-base.code",
        "typeVersion": 2,
        "position": [
          -5648,
          1008
        ],
        "id": "07fc4e8a-126b-493b-9b3a-05a52c7f0f29",
        "name": "Generate Token"
      },
      {
        "parameters": {
          "tableId": "qa_response_tokens",
          "fieldsUi": {
            "fieldValues": [
              {
                "fieldId": "project_id",
                "fieldValue": "={{ $json.project_id }}"
              },
              {
                "fieldId": "token",
                "fieldValue": "={{ $json.token }}"
              },
              {
                "fieldId": "provider_name",
                "fieldValue": "={{ $json.provider_name }}"
              },
              {
                "fieldId": "question_ids",
                "fieldValue": "={{ $json.question_ids }}"
              },
              {
                "fieldId": "expires_at",
                "fieldValue": "={{ $json.expires_at }}"
              }
            ]
          }
        },
        "type": "n8n-nodes-base.supabase",
        "typeVersion": 1,
        "position": [
          -5424,
          1008
        ],
        "id": "6ba490f0-c213-4e16-9767-d2ebf86b84d8",
        "name": "Save Token to DB",
        "credentials": {
          "supabaseApi": {
            "id": "pI4CpdYLTiEEBmnz",
            "name": "Supabase account"
          }
        }
      },
      {
        "parameters": {
          "jsCode": "// Split question_ids array into individual items\nconst questionIds = $(\"Set Input Params2\").first().json.question_ids || [];\n\n// Return each ID as a separate item\nreturn questionIds.map(id => ({\n  json: {\n    question_id: id\n  }\n}));"
        },
        "type": "n8n-nodes-base.code",
        "typeVersion": 2,
        "position": [
          -5200,
          912
        ],
        "id": "49caee51-02c6-4ed8-bb81-bc6680172b4f",
        "name": "Split Question IDs"
      },
      {
        "parameters": {
          "operation": "getAll",
          "tableId": "qa_audit",
          "limit": 1,
          "filters": {
            "conditions": [
              {
                "keyName": "id",
                "condition": "eq",
                "keyValue": "={{ $json.question_id }}"
              }
            ]
          }
        },
        "type": "n8n-nodes-base.supabase",
        "typeVersion": 1,
        "position": [
          -4976,
          912
        ],
        "id": "51abb8c7-1dd4-4c58-8e62-65b9799e96c3",
        "name": "Fetch Questions",
        "credentials": {
          "supabaseApi": {
            "id": "pI4CpdYLTiEEBmnz",
            "name": "Supabase account"
          }
        }
      },
      {
        "parameters": {
          "operation": "getAll",
          "tableId": "projects",
          "limit": 1,
          "filters": {
            "conditions": [
              {
                "keyName": "id",
                "condition": "eq",
                "keyValue": "={{ $(\"Set Input Params2\").first().json.project_id }}"
              }
            ]
          }
        },
        "type": "n8n-nodes-base.supabase",
        "typeVersion": 1,
        "position": [
          -4976,
          1104
        ],
        "id": "728d1b1c-c94e-4dd8-9f58-42f76ae118de",
        "name": "Fetch Project Name",
        "credentials": {
          "supabaseApi": {
            "id": "pI4CpdYLTiEEBmnz",
            "name": "Supabase account"
          }
        }
      },
      {
        "parameters": {
          "mode": "combine",
          "combineBy": "combineAll",
          "options": {}
        },
        "type": "n8n-nodes-base.merge",
        "typeVersion": 3,
        "position": [
          -4752,
          1008
        ],
        "id": "56fc2297-d777-4144-a556-34f986472adf",
        "name": "Merge Data"
      },
      {
        "parameters": {
          "jsCode": "const items = $input.all();\nconst inputParams = $(\"Generate Token\").first().json;\nconst projectData = items.find(i => i.json.display_name)?.json || {};\nconst questions = items.filter(i => i.json.question);\n\n// Build the response link - UPDATE THIS URL TO YOUR FRONTEND\nconst frontendUrl = 'http://localhost:3002';\nconst responseLink = `${frontendUrl}/respond/${inputParams.token}`;\n\n// Build questions HTML for email\nconst questionsHtml = questions.map((q, idx) => `\n  <tr>\n    <td style=\"padding: 12px; border-bottom: 1px solid #e2e8f0;\">${idx + 1}</td>\n    <td style=\"padding: 12px; border-bottom: 1px solid #e2e8f0;\">${q.json.discipline || 'General'}</td>\n    <td style=\"padding: 12px; border-bottom: 1px solid #e2e8f0;\">${q.json.question}</td>\n    <td style=\"padding: 12px; border-bottom: 1px solid #e2e8f0;\">\n      <span style=\"padding: 4px 8px; border-radius: 4px; font-size: 12px; background: ${q.json.importance === 'High' ? '#fee2e2' : q.json.importance === 'Medium' ? '#fef3c7' : '#dcfce7'}; color: ${q.json.importance === 'High' ? '#991b1b' : q.json.importance === 'Medium' ? '#92400e' : '#166534'};\">\n        ${q.json.importance || 'Medium'}\n      </span>\n    </td>\n  </tr>\n`).join('');\n\n// Build email HTML\nconst emailHtml = `\n<!DOCTYPE html>\n<html>\n<head>\n  <meta charset=\"utf-8\">\n  <meta name=\"viewport\" content=\"width=device-width, initial-scale=1.0\">\n</head>\n<body style=\"margin: 0; padding: 0; font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif; background-color: #f8fafc;\">\n  <div style=\"max-width: 600px; margin: 0 auto; padding: 40px 20px;\">\n    <!-- Header -->\n    <div style=\"text-align: center; margin-bottom: 32px;\">\n      <h1 style=\"margin: 0; font-size: 28px;\">\n        <span style=\"color: #1e293b;\">Bid</span><span style=\"color: #12b5b0;\">Eval</span>\n      </h1>\n      <p style=\"margin: 8px 0 0; color: #64748b;\">Technical Evaluation Platform</p>\n    </div>\n    \n    <!-- Main Card -->\n    <div style=\"background: white; border-radius: 16px; padding: 32px; box-shadow: 0 4px 24px rgba(0,0,0,0.08);\">\n      <h2 style=\"margin: 0 0 8px; color: #1e293b; font-size: 20px;\">Technical Questionnaire Request</h2>\n      <p style=\"margin: 0 0 24px; color: #64748b;\">Project: <strong>${projectData.display_name || 'N/A'}</strong></p>\n      \n      <p style=\"color: #475569; line-height: 1.6;\">\n        Dear <strong>${inputParams.provider_name}</strong> team,\n      </p>\n      <p style=\"color: #475569; line-height: 1.6;\">\n        As part of the technical evaluation process, we have prepared a questionnaire with <strong>${questions.length}</strong> questions that require your response.\n      </p>\n      \n      <!-- Questions Table -->\n      <div style=\"margin: 24px 0; overflow-x: auto;\">\n        <table style=\"width: 100%; border-collapse: collapse; font-size: 14px;\">\n          <thead>\n            <tr style=\"background: #f1f5f9;\">\n              <th style=\"padding: 12px; text-align: left; font-weight: 600; color: #475569;\">#</th>\n              <th style=\"padding: 12px; text-align: left; font-weight: 600; color: #475569;\">Discipline</th>\n              <th style=\"padding: 12px; text-align: left; font-weight: 600; color: #475569;\">Question</th>\n              <th style=\"padding: 12px; text-align: left; font-weight: 600; color: #475569;\">Priority</th>\n            </tr>\n          </thead>\n          <tbody>\n            ${questionsHtml}\n          </tbody>\n        </table>\n      </div>\n      \n      <!-- CTA Button -->\n      <div style=\"text-align: center; margin: 32px 0;\">\n        <a href=\"${responseLink}\" style=\"display: inline-block; padding: 16px 48px; background: linear-gradient(135deg, #12b5b0 0%, #0d9488 100%); color: white; text-decoration: none; border-radius: 12px; font-weight: 600; font-size: 16px;\">Respond to Questionnaire</a>\n      </div>\n      \n      <p style=\"color: #64748b; font-size: 14px;\">\n        This link will expire on <strong>${new Date(inputParams.expires_at).toLocaleDateString('en-US', { year: 'numeric', month: 'long', day: 'numeric' })}</strong>.\n      </p>\n      \n      <hr style=\"border: none; border-top: 1px solid #e2e8f0; margin: 24px 0;\">\n      \n      <p style=\"color: #94a3b8; font-size: 12px; margin: 0;\">\n        If you have any questions, please contact the evaluation team.\n      </p>\n    </div>\n    \n    <!-- Footer -->\n    <div style=\"text-align: center; margin-top: 32px; color: #94a3b8; font-size: 12px;\">\n      <p style=\"margin: 0;\">Powered by BidEval - Technical Evaluation Platform</p>\n    </div>\n  </div>\n</body>\n</html>\n`;\n\nreturn {\n  json: {\n    success: true,\n    token: inputParams.token,\n    response_link: responseLink,\n    expires_at: inputParams.expires_at,\n    project_name: projectData.display_name,\n    provider_name: inputParams.provider_name,\n    question_count: questions.length,\n    email_to: inputParams.email_to,\n    email_subject: `Technical Questionnaire - ${projectData.display_name || 'BidEval'}`,\n    email_html: emailHtml\n  }\n};"
        },
        "type": "n8n-nodes-base.code",
        "typeVersion": 2,
        "position": [
          -4528,
          1008
        ],
        "id": "6de57abd-b035-4b63-b34e-0b84a9a3ecf3",
        "name": "Build Email Content"
      },
      {
        "parameters": {
          "jsCode": "// Split question_ids for update\nconst questionIds = $(\"Set Input Params2\").first().json.question_ids || [];\nreturn questionIds.map(id => ({ json: { question_id: id } }));"
        },
        "type": "n8n-nodes-base.code",
        "typeVersion": 2,
        "position": [
          -3856,
          1008
        ],
        "id": "d4787d2c-7a74-49c7-a9d3-f3827ceefaa3",
        "name": "Split for Update"
      },
      {
        "parameters": {
          "operation": "update",
          "tableId": "qa_audit",
          "matchType": "allFilters",
          "filters": {
            "conditions": [
              {
                "keyName": "id",
                "condition": "eq",
                "keyValue": "={{ $json.question_id }}"
              }
            ]
          },
          "fieldsUi": {
            "fieldValues": [
              {
                "fieldId": "status",
                "fieldValue": "Sent"
              }
            ]
          }
        },
        "type": "n8n-nodes-base.supabase",
        "typeVersion": 1,
        "position": [
          -3632,
          1008
        ],
        "id": "507b8ee9-e4b7-485d-94c6-b08a8faab3cb",
        "name": "Update Question Status",
        "credentials": {
          "supabaseApi": {
            "id": "pI4CpdYLTiEEBmnz",
            "name": "Supabase account"
          }
        }
      },
      {
        "parameters": {
          "assignments": {
            "assignments": [
              {
                "id": "project_id",
                "name": "project_id",
                "value": "={{ $json.body?.project_id || $json.project_id }}",
                "type": "string"
              },
              {
                "id": "provider_name",
                "name": "provider_name",
                "value": "={{ $json.body?.provider_name || $json.provider_name }}",
                "type": "string"
              },
              {
                "id": "question_ids",
                "name": "question_ids",
                "value": "={{ $json.body?.question_ids || $json.question_ids }}",
                "type": "array"
              },
              {
                "id": "email_to",
                "name": "email_to",
                "value": "={{ $json.body?.email_to || $json.email_to || '' }}",
                "type": "string"
              },
              {
                "id": "expires_days",
                "name": "expires_days",
                "value": "={{ $json.body?.expires_days || $json.expires_days || 7 }}",
                "type": "number"
              }
            ]
          },
          "options": {}
        },
        "type": "n8n-nodes-base.set",
        "typeVersion": 3.4,
        "position": [
          -5872,
          1008
        ],
        "id": "d4695b61-cd28-43be-91ab-84fef06ec15b",
        "name": "Set Input Params2"
      },
      {
        "parameters": {
          "respondWith": "json",
          "responseBody": "={{ $(\"Build Email Content\").first().json }}",
          "options": {}
        },
        "type": "n8n-nodes-base.respondToWebhook",
        "typeVersion": 1.5,
        "position": [
          -3408,
          1008
        ],
        "id": "4b8c7f69-137f-432f-ab2d-9a7b45eecf85",
        "name": "Respond to Webhook2"
      },
      {
        "parameters": {
          "content": "## QA Send to Supplier Workflow\n\n**Purpose:** Generate a unique token, send email via Gmail, and create response link for suppliers.\n\n**Input (POST body):**\n```json\n{\n  \"project_id\": \"uuid\",\n  \"provider_name\": \"IDOM\",\n  \"question_ids\": [\"uuid1\", \"uuid2\"],\n  \"email_to\": \"supplier@example.com\",\n  \"expires_days\": 7\n}\n```\n\n**Flow:**\n1. Generate 64-char token\n2. Save to `qa_response_tokens`\n3. Build HTML email\n4. If email_to provided ‚Üí Send via Gmail\n5. Update questions status to 'Sent'\n6. Return response link\n\n**Gmail Setup:**\nConfigure Gmail OAuth2 credentials in n8n.",
          "height": 400,
          "width": 320,
          "color": 7
        },
        "type": "n8n-nodes-base.stickyNote",
        "typeVersion": 1,
        "position": [
          -6096,
          768
        ],
        "id": "e916e255-ae40-49e6-81bc-8a0e3f81c0d9",
        "name": "Sticky Note3"
      },
      {
        "parameters": {
          "httpMethod": "POST",
          "path": "qa-audit-generator",
          "responseMode": "responseNode",
          "options": {}
        },
        "type": "n8n-nodes-base.webhook",
        "typeVersion": 2.1,
        "position": [
          -3136,
          80
        ],
        "id": "2e8198fa-bb18-40b2-b589-54b7fb907e67",
        "name": "Webhook Inbound",
        "webhookId": "0496e481-bb76-42f1-b3d5-734935b4b631"
      },
      {
        "parameters": {
          "assignments": {
            "assignments": [
              {
                "id": "project_id",
                "name": "project_id",
                "value": "={{ $json.body.project_id }}",
                "type": "string"
              },
              {
                "id": "provider",
                "name": "provider",
                "value": "={{ $json.body.provider }}",
                "type": "string"
              }
            ]
          },
          "options": {}
        },
        "type": "n8n-nodes-base.set",
        "typeVersion": 3.4,
        "position": [
          -2912,
          80
        ],
        "id": "8b3b8f15-474f-4507-a00f-af37dafc7266",
        "name": "Set Input Params"
      },
      {
        "parameters": {
          "operation": "getAll",
          "tableId": "provider_responses",
          "returnAll": true,
          "matchType": "allFilters",
          "filters": {
            "conditions": [
              {
                "keyName": "provider_name",
                "condition": "eq",
                "keyValue": "={{ $json.provider }}"
              },
              {
                "keyName": "evaluation_value",
                "condition": "neq",
                "keyValue": "INCLUIDO"
              },
              {
                "keyName": "project_id",
                "condition": "eq",
                "keyValue": "={{ $json.project_id }}"
              }
            ]
          }
        },
        "type": "n8n-nodes-base.supabase",
        "typeVersion": 1,
        "position": [
          -2704,
          80
        ],
        "id": "c75924e0-ff9b-47f4-a6e7-d48de02efa02",
        "name": "Fetch Missing Items",
        "credentials": {
          "supabaseApi": {
            "id": "pI4CpdYLTiEEBmnz",
            "name": "Supabase account"
          }
        }
      },
      {
        "parameters": {
          "operation": "getAll",
          "tableId": "rfq_items_master",
          "limit": 1,
          "filters": {
            "conditions": [
              {
                "keyName": "id",
                "condition": "eq",
                "keyValue": "={{ $json.requirement_id }}"
              }
            ]
          }
        },
        "type": "n8n-nodes-base.supabase",
        "typeVersion": 1,
        "position": [
          -2464,
          80
        ],
        "id": "c0a9c906-2e55-4108-ac24-1c5a9a8c7f42",
        "name": "Fetch Requirement Specs",
        "credentials": {
          "supabaseApi": {
            "id": "pI4CpdYLTiEEBmnz",
            "name": "Supabase account"
          }
        }
      },
      {
        "parameters": {
          "aggregate": "aggregateAllItemData",
          "destinationFieldName": "total_deficiencies",
          "options": {}
        },
        "type": "n8n-nodes-base.aggregate",
        "typeVersion": 1,
        "position": [
          -2272,
          80
        ],
        "id": "2320ff2e-62c5-4eb3-86f5-1e57cbc4bf5c",
        "name": "Consolidate Deficiencies"
      },
      {
        "parameters": {
          "promptType": "define",
          "text": "=Generate technical audit questions in English based on the following deficiencies detected for the provider {{ $(\"Set Input Params\").first().json.provider }}.\n\n**IMPORTANT**: Each deficiency has an \"id\" field which is the requirement_id. You MUST include this requirement_id with each question you generate, linking the question back to its source deficiency.\n\nDEFICIENCIES:\n{{ JSON.stringify($json.total_deficiencies) }}\n\n### INSTRUCTIONS:\n1.  **Link to Requirement**: Each question MUST include the \"requirement_id\" (the \"id\" field from the deficiency it relates to).\n2.  **Analyze & Classify**: For each deficiency, determine its specific engineering field.\n    - If it involves cables, power, or circuits -> **Electrical**\n    - If it involves machinery, pumps, or piping -> **Mechanical**\n    - If it involves structures, foundations, or concrete -> **Civil**\n    - If it involves workflows, chemical stages, or P&IDs -> **Process**\n    - Only if it is administrative or multi-disciplinary -> **General**\n3.  **Language**: All questions and text MUST be in English.\n4.  **Strictness**: Do not label everything as \"General\". Be as specific as possible.\n5.  **Format**: Respond strictly with the JSON object following the schema.\n\n### OUTPUT SCHEMA:\n{\n  \"questions\": [\n    {\n      \"requirement_id\": \"uuid-from-deficiency-id-field\",\n      \"discipline\": \"Electrical\" | \"Mechanical\" | \"Civil\" | \"Process\" | \"General\",\n      \"question\": \"The specific question in English\",\n      \"importance\": \"High\" | \"Medium\" | \"Low\"\n    }\n  ]\n}",
          "hasOutputParser": true,
          "batching": {}
        },
        "type": "@n8n/n8n-nodes-langchain.chainLlm",
        "typeVersion": 1.8,
        "position": [
          -2080,
          80
        ],
        "id": "f0fbafa9-6168-4ae6-af79-0b641e9c3f2d",
        "name": "QA Generation Chain"
      },
      {
        "parameters": {
          "schemaType": "manual",
          "inputSchema": "{\n  \"type\": \"object\",\n  \"properties\": {\n    \"questions\": {\n      \"type\": \"array\",\n      \"items\": {\n        \"type\": \"object\",\n        \"properties\": {\n          \"requirement_id\": { \"type\": \"string\" },\n          \"discipline\": { \"type\": \"string\" },\n          \"question\": { \"type\": \"string\" },\n          \"importance\": { \"type\": \"string\" }\n        }\n      }\n    }\n  }\n}"
        },
        "type": "@n8n/n8n-nodes-langchain.outputParserStructured",
        "typeVersion": 1.3,
        "position": [
          -1856,
          288
        ],
        "id": "d2a100c7-5253-4e91-a85f-5eafaf9fe16a",
        "name": "JSON Output Parser"
      },
      {
        "parameters": {
          "fieldToSplitOut": "output.questions",
          "include": "allOtherFields",
          "options": {}
        },
        "type": "n8n-nodes-base.itemLists",
        "typeVersion": 3.1,
        "position": [
          -1760,
          80
        ],
        "id": "e1569d96-f5f6-4327-8f7e-2c3e19145ccc",
        "name": "Split Questions List"
      },
      {
        "parameters": {
          "tableId": "qa_audit",
          "fieldsUi": {
            "fieldValues": [
              {
                "fieldId": "question",
                "fieldValue": "={{ $json['output.questions'].question }}"
              },
              {
                "fieldId": "importance",
                "fieldValue": "={{ $json['output.questions'].importance }}"
              },
              {
                "fieldId": "discipline",
                "fieldValue": "={{ $json['output.questions'].discipline }}"
              },
              {
                "fieldId": "provider_name",
                "fieldValue": "={{ $(\"Set Input Params\").first().json.provider }}"
              },
              {
                "fieldId": "project_id",
                "fieldValue": "={{ $(\"Set Input Params\").first().json.project_id }}"
              },
              {
                "fieldId": "requirement_id",
                "fieldValue": "={{ $json['output.questions'].requirement_id }}"
              },
              {
                "fieldId": "status",
                "fieldValue": "Pending"
              }
            ]
          }
        },
        "type": "n8n-nodes-base.supabase",
        "typeVersion": 1,
        "position": [
          -1600,
          80
        ],
        "id": "cf3c90a4-1dcf-4ade-98fd-3d80013f5509",
        "name": "Supabase Insert",
        "credentials": {
          "supabaseApi": {
            "id": "pI4CpdYLTiEEBmnz",
            "name": "Supabase account"
          }
        }
      },
      {
        "parameters": {
          "respondWith": "allIncomingItems",
          "options": {}
        },
        "type": "n8n-nodes-base.respondToWebhook",
        "typeVersion": 1.5,
        "position": [
          -1392,
          80
        ],
        "id": "c2b18e2d-f872-4bb1-bc20-b8a9a3d4446b",
        "name": "Respond to Webhook1"
      },
      {
        "parameters": {
          "content": "## Q&A Generator\n\n**Updated**: Now includes requirement_id with each question for linking back to requirements.\n\n**Flow**:\n1. Receive project_id and provider\n2. Fetch deficiencies (provider_responses where evaluation != INCLUIDO)\n3. Fetch requirement details for each\n4. Generate questions with LLM (including requirement_id)\n5. Save to qa_audit with requirement_id",
          "height": 656,
          "width": 2048,
          "color": 7
        },
        "type": "n8n-nodes-base.stickyNote",
        "typeVersion": 1,
        "position": [
          -3232,
          -144
        ],
        "id": "7c6ee1ef-ff5b-45ea-83f6-ed616b15f957",
        "name": "Sticky Note1"
      },
      {
        "parameters": {
          "model": "qwen3:8b",
          "options": {
            "temperature": 0.1,
            "numCtx": 8192,
            "numPredict": 1536
          }
        },
        "type": "@n8n/n8n-nodes-langchain.lmOllama",
        "typeVersion": 1,
        "position": [
          -2176,
          336
        ],
        "id": "955f765c-52e2-4157-a4fe-38ebf08c16f7",
        "name": "Ollama Model2",
        "credentials": {
          "ollamaApi": {
            "id": "oS2Qqti9oVfsm8XZ",
            "name": "Ollama account"
          }
        }
      },
      {
        "parameters": {
          "model": "mistral-large-latest",
          "options": {
            "temperature": 0.1
          }
        },
        "type": "@n8n/n8n-nodes-langchain.lmChatMistralCloud",
        "typeVersion": 1,
        "position": [
          -2048,
          432
        ],
        "id": "778c394b-3e01-4cf7-9ccb-ca1805527849",
        "name": "Mistral Cloud Chat Model",
        "credentials": {
          "mistralCloudApi": {
            "id": "tDjuOnF6lpADMmd5",
            "name": "Mistral Cloud account"
          }
        }
      },
      {
        "parameters": {
          "operation": "getAll",
          "tableId": "qa_response_tokens",
          "limit": 1,
          "filters": {
            "conditions": [
              {
                "keyName": "token",
                "condition": "eq",
                "keyValue": "={{ $json.token }}"
              }
            ]
          }
        },
        "type": "n8n-nodes-base.supabase",
        "typeVersion": 1,
        "position": [
          -6320,
          1856
        ],
        "id": "5e6ead20-ec60-46b4-9d5d-40dca30b23e3",
        "name": "Validate Token",
        "credentials": {
          "supabaseApi": {
            "id": "pI4CpdYLTiEEBmnz",
            "name": "Supabase account"
          }
        }
      },
      {
        "parameters": {
          "conditions": {
            "options": {
              "caseSensitive": true,
              "leftValue": "",
              "typeValidation": "strict"
            },
            "conditions": [
              {
                "id": "token-valid",
                "leftValue": "={{ $json.status }}",
                "rightValue": "responded",
                "operator": {
                  "type": "string",
                  "operation": "notEquals"
                }
              },
              {
                "id": "not-expired",
                "leftValue": "={{ new Date($json.expires_at) > new Date() }}",
                "rightValue": true,
                "operator": {
                  "type": "boolean",
                  "operation": "equals"
                }
              }
            ],
            "combinator": "and"
          },
          "options": {}
        },
        "type": "n8n-nodes-base.if",
        "typeVersion": 2.2,
        "position": [
          -6096,
          1856
        ],
        "id": "edbc1f4c-6c06-4107-86b2-c6b8e8405d3a",
        "name": "Token Valid?"
      },
      {
        "parameters": {
          "respondWith": "json",
          "responseBody": "={\n  \"success\": false,\n  \"error\": \"Token is invalid, expired, or already used\"\n}",
          "options": {
            "responseCode": 400
          }
        },
        "type": "n8n-nodes-base.respondToWebhook",
        "typeVersion": 1.5,
        "position": [
          -5872,
          2032
        ],
        "id": "07ccb6d8-e161-445e-854c-8f511c3b6f20",
        "name": "Respond Invalid"
      },
      {
        "parameters": {
          "jsCode": "// Get responses from the original input and token data\nconst inputParams = $('Set Input Params3').first().json;\nconst tokenData = $input.first().json;\n\nconst responses = inputParams.responses || [];\n\n// Return each response as a separate item with all context needed\nreturn responses.map(response => ({\n  json: {\n    // Token data\n    token_id: tokenData.id,\n    project_id: tokenData.project_id,\n    provider_name: tokenData.provider_name,\n    token: tokenData.token,\n    // Question data\n    question_id: response.question_id,\n    response_text: response.response_text\n  }\n}));"
        },
        "type": "n8n-nodes-base.code",
        "typeVersion": 2,
        "position": [
          -5872,
          1856
        ],
        "id": "48d07bd0-ff94-4e9f-8dbc-9b412b397acc",
        "name": "Split Responses"
      },
      {
        "parameters": {
          "options": {}
        },
        "type": "n8n-nodes-base.splitInBatches",
        "typeVersion": 3,
        "position": [
          -5648,
          1856
        ],
        "id": "06010b24-ae87-4f37-a8f8-d77630f23933",
        "name": "Loop Over Items"
      },
      {
        "parameters": {
          "operation": "update",
          "tableId": "qa_audit",
          "matchType": "allFilters",
          "filters": {
            "conditions": [
              {
                "keyName": "id",
                "condition": "eq",
                "keyValue": "={{ $json.question_id }}"
              }
            ]
          },
          "fieldsUi": {
            "fieldValues": [
              {
                "fieldId": "response",
                "fieldValue": "={{ $json.response_text }}"
              },
              {
                "fieldId": "status",
                "fieldValue": "Answered"
              },
              {
                "fieldId": "responded_at",
                "fieldValue": "={{ new Date().toISOString() }}"
              },
              {
                "fieldId": "response_source",
                "fieldValue": "portal"
              }
            ]
          }
        },
        "type": "n8n-nodes-base.supabase",
        "typeVersion": 1,
        "position": [
          -5424,
          1856
        ],
        "id": "08c62d50-d537-4e83-9eb3-d38210485f03",
        "name": "Save Response to QA Audit",
        "credentials": {
          "supabaseApi": {
            "id": "pI4CpdYLTiEEBmnz",
            "name": "Supabase account"
          }
        }
      },
      {
        "parameters": {
          "operation": "getAll",
          "tableId": "qa_audit",
          "limit": 1,
          "filters": {
            "conditions": [
              {
                "keyName": "id",
                "condition": "eq",
                "keyValue": "={{ $('Loop Over Items').item.json.question_id }}"
              }
            ]
          }
        },
        "type": "n8n-nodes-base.supabase",
        "typeVersion": 1,
        "position": [
          -5200,
          1856
        ],
        "id": "508def41-cf34-4c97-8028-9d5861d4b622",
        "name": "Fetch Question Details",
        "alwaysOutputData": true,
        "credentials": {
          "supabaseApi": {
            "id": "pI4CpdYLTiEEBmnz",
            "name": "Supabase account"
          }
        }
      },
      {
        "parameters": {
          "conditions": {
            "options": {
              "caseSensitive": true,
              "leftValue": "",
              "typeValidation": "strict",
              "version": 2
            },
            "conditions": [
              {
                "id": "has-requirement",
                "leftValue": "={{ $json.requirement_id }}",
                "rightValue": "",
                "operator": {
                  "type": "string",
                  "operation": "notEmpty"
                }
              }
            ],
            "combinator": "and"
          },
          "options": {}
        },
        "type": "n8n-nodes-base.if",
        "typeVersion": 2.2,
        "position": [
          -4976,
          1856
        ],
        "id": "c86b585f-f3a9-4025-a8b6-9419254712b7",
        "name": "Has Requirement?"
      },
      {
        "parameters": {
          "operation": "getAll",
          "tableId": "rfq_items_master",
          "limit": 1,
          "filters": {
            "conditions": [
              {
                "keyName": "id",
                "condition": "eq",
                "keyValue": "={{ $('Fetch Question Details').first().json.requirement_id }}"
              }
            ]
          }
        },
        "type": "n8n-nodes-base.supabase",
        "typeVersion": 1,
        "position": [
          -4752,
          1744
        ],
        "id": "3decfffe-cd8a-47d6-9d29-07a01dbbe029",
        "name": "Fetch Requirement",
        "alwaysOutputData": true,
        "credentials": {
          "supabaseApi": {
            "id": "pI4CpdYLTiEEBmnz",
            "name": "Supabase account"
          }
        }
      },
      {
        "parameters": {
          "operation": "getAll",
          "tableId": "provider_responses",
          "returnAll": true,
          "matchType": "allFilters",
          "filters": {
            "conditions": [
              {
                "keyName": "requirement_id",
                "condition": "eq",
                "keyValue": "={{ $('Fetch Question Details').first().json.requirement_id }}"
              },
              {
                "keyName": "provider_name",
                "condition": "eq",
                "keyValue": "={{ $('Loop Over Items').item.json.provider_name }}"
              }
            ]
          }
        },
        "type": "n8n-nodes-base.supabase",
        "typeVersion": 1,
        "position": [
          -4528,
          1744
        ],
        "id": "bdd2b223-e13f-4deb-b272-5e645eea5ecd",
        "name": "Fetch Current Evaluation",
        "alwaysOutputData": true,
        "credentials": {
          "supabaseApi": {
            "id": "pI4CpdYLTiEEBmnz",
            "name": "Supabase account"
          }
        }
      },
      {
        "parameters": {
          "promptType": "define",
          "text": "=You are a technical evaluation expert. Based on a supplier's clarifying response, re-evaluate if a requirement is now better satisfied.\n\n**ORIGINAL REQUIREMENT:**\n{{ $('Fetch Requirement').first().json.requirement_text }}\n\n**CURRENT EVALUATION:**\nStatus: {{ $json.evaluation_value || 'NO INCLUIDO' }}\nScore: {{ $json.score || 0 }}/10\nComment: {{ $json.comment || 'Not evaluated' }}\n\n**SUPPLIER'S CLARIFYING RESPONSE:**\n{{ $('Loop Over Items').item.json.response_text }}\n\n**INSTRUCTIONS:**\n1. Analyze if the supplier's response addresses the gaps in the original requirement.\n2. Determine if the evaluation should be improved.\n3. Only improve the score if the response provides substantial new information.\n4. Be conservative - don't upgrade unless clearly justified.\n\n**RESPOND STRICTLY WITH JSON:**\n{\n  \"should_update\": true/false,\n  \"new_evaluation_value\": \"INCLUIDO\" | \"PARCIAL\" | \"NO INCLUIDO\",\n  \"new_score\": 0-10,\n  \"new_comment\": \"Brief explanation of change or why no change\",\n  \"confidence\": 0-100\n}",
          "hasOutputParser": true,
          "batching": {}
        },
        "type": "@n8n/n8n-nodes-langchain.chainLlm",
        "typeVersion": 1.8,
        "position": [
          -4304,
          1744
        ],
        "id": "73ea1537-3738-4993-9cc3-e65f9c3a6e1a",
        "name": "LLM Re-evaluate"
      },
      {
        "parameters": {
          "conditions": {
            "options": {
              "caseSensitive": true,
              "leftValue": "",
              "typeValidation": "strict"
            },
            "conditions": [
              {
                "id": "should-update",
                "leftValue": "={{ $json.output.should_update }}",
                "rightValue": true,
                "operator": {
                  "type": "boolean",
                  "operation": "equals"
                }
              },
              {
                "id": "high-confidence",
                "leftValue": "={{ $json.output.confidence }}",
                "rightValue": 70,
                "operator": {
                  "type": "number",
                  "operation": "gte"
                }
              }
            ],
            "combinator": "and"
          },
          "options": {}
        },
        "type": "n8n-nodes-base.if",
        "typeVersion": 2.2,
        "position": [
          -4080,
          1744
        ],
        "id": "e7100e68-2df8-473c-8dd0-ff09db84f613",
        "name": "Should Update?"
      },
      {
        "parameters": {
          "operation": "update",
          "tableId": "provider_responses",
          "matchType": "allFilters",
          "filters": {
            "conditions": [
              {
                "keyName": "requirement_id",
                "condition": "eq",
                "keyValue": "={{ $('Fetch Question Details').first().json.requirement_id }}"
              },
              {
                "keyName": "provider_name",
                "condition": "eq",
                "keyValue": "={{ $('Loop Over Items').item.json.provider_name }}"
              }
            ]
          },
          "fieldsUi": {
            "fieldValues": [
              {
                "fieldId": "evaluation_value",
                "fieldValue": "={{ $json.output.new_evaluation_value }}"
              },
              {
                "fieldId": "score",
                "fieldValue": "={{ $json.output.new_score }}"
              },
              {
                "fieldId": "comment",
                "fieldValue": "={{ $json.output.new_comment + ' [Updated after supplier response]' }}"
              }
            ]
          }
        },
        "type": "n8n-nodes-base.supabase",
        "typeVersion": 1,
        "position": [
          -3856,
          1664
        ],
        "id": "bd2010ce-ceea-4605-a0c0-a0d235ca8205",
        "name": "Update Provider Response",
        "credentials": {
          "supabaseApi": {
            "id": "pI4CpdYLTiEEBmnz",
            "name": "Supabase account"
          }
        }
      },
      {
        "parameters": {},
        "type": "n8n-nodes-base.noOp",
        "typeVersion": 1,
        "position": [
          -3856,
          1824
        ],
        "id": "39551565-4148-4bc0-9910-8d62d3c47cfe",
        "name": "Skip Update"
      },
      {
        "parameters": {},
        "type": "n8n-nodes-base.noOp",
        "typeVersion": 1,
        "position": [
          -4752,
          1968
        ],
        "id": "9f856c33-2542-44b6-a13c-3e4eca505b53",
        "name": "No Requirement"
      },
      {
        "parameters": {},
        "type": "n8n-nodes-base.merge",
        "typeVersion": 3,
        "position": [
          -3632,
          1856
        ],
        "id": "c19c20ce-ce61-4aae-b94b-3f00d34d9d99",
        "name": "Merge Results"
      },
      {
        "parameters": {
          "operation": "update",
          "tableId": "qa_response_tokens",
          "matchType": "allFilters",
          "filters": {
            "conditions": [
              {
                "keyName": "token",
                "condition": "eq",
                "keyValue": "={{ $('Set Input Params3').first().json.token }}"
              }
            ]
          },
          "fieldsUi": {
            "fieldValues": [
              {
                "fieldId": "status",
                "fieldValue": "responded"
              },
              {
                "fieldId": "responded_at",
                "fieldValue": "={{ new Date().toISOString() }}"
              }
            ]
          }
        },
        "type": "n8n-nodes-base.supabase",
        "typeVersion": 1,
        "position": [
          -3408,
          1856
        ],
        "id": "7503367f-91f5-46e9-9862-33af8abc614d",
        "name": "Mark Token Responded",
        "credentials": {
          "supabaseApi": {
            "id": "pI4CpdYLTiEEBmnz",
            "name": "Supabase account"
          }
        }
      },
      {
        "parameters": {
          "tableId": "qa_notifications",
          "fieldsUi": {
            "fieldValues": [
              {
                "fieldId": "project_id",
                "fieldValue": "={{ $('Validate Token').first().json.project_id }}"
              },
              {
                "fieldId": "provider_name",
                "fieldValue": "={{ $('Validate Token').first().json.provider_name }}"
              },
              {
                "fieldId": "notification_type",
                "fieldValue": "supplier_responded"
              },
              {
                "fieldId": "title",
                "fieldValue": "=Supplier {{ $('Validate Token').first().json.provider_name }} has responded"
              },
              {
                "fieldId": "message",
                "fieldValue": "={{ $('Set Input Params3').first().json.responses.length || 0 }} question(s) answered via the supplier portal"
              },
              {
                "fieldId": "metadata",
                "fieldValue": "={{ JSON.stringify({ response_count: $('Set Input Params3').first().json.responses.length || 0, token: $('Set Input Params3').first().json.token }) }}"
              }
            ]
          }
        },
        "type": "n8n-nodes-base.supabase",
        "typeVersion": 1,
        "position": [
          -3184,
          1856
        ],
        "id": "1ec2ebcb-2722-4346-b9f0-ed46ad9c25ee",
        "name": "Create Notification",
        "credentials": {
          "supabaseApi": {
            "id": "pI4CpdYLTiEEBmnz",
            "name": "Supabase account"
          }
        }
      },
      {
        "parameters": {
          "respondWith": "json",
          "responseBody": "={\n  \"success\": true,\n  \"message\": \"Responses processed and evaluations updated\",\n  \"processed_count\": {{ $('Set Input Params3').first().json.responses.length || 0 }}\n}",
          "options": {}
        },
        "type": "n8n-nodes-base.respondToWebhook",
        "typeVersion": 1.5,
        "position": [
          -2960,
          1856
        ],
        "id": "9bacb9a1-e3d0-41b9-8a52-cef14b8716c9",
        "name": "Respond Success"
      },
      {
        "parameters": {
          "httpMethod": "POST",
          "path": "qa-process-responses",
          "responseMode": "responseNode",
          "options": {}
        },
        "type": "n8n-nodes-base.webhook",
        "typeVersion": 2.1,
        "position": [
          -6752,
          1856
        ],
        "id": "9be6dc4b-726d-493f-9c66-1940474a9b0b",
        "name": "Webhook Receive1",
        "webhookId": "qa-process-responses-webhook"
      },
      {
        "parameters": {
          "assignments": {
            "assignments": [
              {
                "id": "token",
                "name": "token",
                "value": "={{ $json.body?.token || $json.token }}",
                "type": "string"
              },
              {
                "id": "responses",
                "name": "responses",
                "value": "={{ $json.body?.responses || $json.responses }}",
                "type": "array"
              }
            ]
          },
          "options": {}
        },
        "type": "n8n-nodes-base.set",
        "typeVersion": 3.4,
        "position": [
          -6528,
          1856
        ],
        "id": "11361bb3-b3b1-4054-a99d-151bae04116b",
        "name": "Set Input Params3"
      },
      {
        "parameters": {
          "schemaType": "manual",
          "inputSchema": "{\n  \"type\": \"object\",\n  \"properties\": {\n    \"should_update\": { \"type\": \"boolean\" },\n    \"new_evaluation_value\": { \"type\": \"string\" },\n    \"new_score\": { \"type\": \"number\" },\n    \"new_comment\": { \"type\": \"string\" },\n    \"confidence\": { \"type\": \"number\" }\n  }\n}"
        },
        "type": "@n8n/n8n-nodes-langchain.outputParserStructured",
        "typeVersion": 1.3,
        "position": [
          -4304,
          1984
        ],
        "id": "ea184b89-cb96-4a12-b80c-fa228cfe2c90",
        "name": "JSON Output Parser2"
      },
      {
        "parameters": {
          "model": "mistral-large-latest",
          "options": {
            "temperature": 0.1
          }
        },
        "type": "@n8n/n8n-nodes-langchain.lmChatMistralCloud",
        "typeVersion": 1,
        "position": [
          -4304,
          2112
        ],
        "id": "c6d25f34-baf8-4ab8-a52f-e8c777b95b39",
        "name": "Mistral Cloud Chat Model4",
        "credentials": {
          "mistralCloudApi": {
            "id": "tDjuOnF6lpADMmd5",
            "name": "Mistral Cloud account"
          }
        }
      },
      {
        "parameters": {
          "content": "## QA Process Responses Workflow\n\n**Purpose:** Process supplier responses using a Loop for reliable item-by-item processing.\n\n**Data Model:**\n- `qa_audit.requirement_id` links to `rfq_items_master.id`\n- This allows re-evaluation of requirements based on supplier responses\n\n**Input (POST body):**\n```json\n{\n  \"token\": \"abc123xyz...\",\n  \"responses\": [\n    {\n      \"question_id\": \"uuid\",\n      \"response_text\": \"Supplier's answer...\"\n    }\n  ]\n}\n```\n\n**Process:**\n1. Validate token (not expired, not used)\n2. Split responses into items\n3. **Loop Over Items** - process each response:\n   - Save response to qa_audit\n   - Fetch question details (including requirement_id)\n   - If has requirement_id:\n     - Fetch requirement from rfq_items_master\n     - Fetch current evaluation\n     - Re-evaluate with LLM\n     - Update if confidence >= 70%\n4. After loop: Mark token as responded\n5. Create notification\n6. Respond with success\n\n**Tables Updated:**\n- `qa_audit` - response, status, responded_at, response_source\n- `provider_responses` - evaluation_value, score, comment\n- `qa_response_tokens` - status, responded_at\n- `qa_notifications` - new notification created",
          "height": 700,
          "width": 450,
          "color": 7
        },
        "type": "n8n-nodes-base.stickyNote",
        "typeVersion": 1,
        "position": [
          -6752,
          1232
        ],
        "id": "a9eaba74-937e-4fb4-90f3-86453d631cc9",
        "name": "Sticky Note6"
      }
    ],
    "connections": {
      "Webhook RFQ": {
        "main": [
          [
            {
              "node": "Generate IDs1",
              "type": "main",
              "index": 0
            }
          ]
        ]
      },
      "Preparar Texto1": {
        "main": [
          [
            {
              "node": "Clasificador de Tipos1",
              "type": "main",
              "index": 0
            }
          ]
        ]
      },
      "Clasificador de Tipos1": {
        "main": [
          [
            {
              "node": "Insert Document Metadata2",
              "type": "main",
              "index": 0
            }
          ]
        ]
      },
      "Ollama Clasificador1": {
        "ai_languageModel": [
          [
            {
              "node": "Clasificador de Tipos1",
              "type": "ai_languageModel",
              "index": 0
            }
          ]
        ]
      },
      "Output Parser1": {
        "ai_outputParser": [
          [
            {
              "node": "Clasificador de Tipos1",
              "type": "ai_outputParser",
              "index": 0
            }
          ]
        ]
      },
      "Expandir por Tipo1": {
        "main": [
          [
            {
              "node": "Loop por Tipo1",
              "type": "main",
              "index": 0
            }
          ]
        ]
      },
      "Loop por Tipo1": {
        "main": [
          [
            {
              "node": "Resumen Final1",
              "type": "main",
              "index": 0
            }
          ],
          [
            {
              "node": "Dividir en Trozos1",
              "type": "main",
              "index": 0
            }
          ]
        ]
      },
      "Parsear Items1": {
        "main": [
          [
            {
              "node": "Create a row",
              "type": "main",
              "index": 0
            }
          ]
        ]
      },
      "Agregar Resultados1": {
        "main": [
          [
            {
              "node": "Loop por Trozo1",
              "type": "main",
              "index": 0
            }
          ]
        ]
      },
      "Resumen Final1": {
        "main": [
          [
            {
              "node": "Respond Success1",
              "type": "main",
              "index": 0
            }
          ]
        ]
      },
      "Base64 a Binary3": {
        "main": [
          [
            {
              "node": "Extract from File3",
              "type": "main",
              "index": 0
            }
          ]
        ]
      },
      "Extract from File3": {
        "main": [
          [
            {
              "node": "Preparar Texto1",
              "type": "main",
              "index": 0
            }
          ]
        ]
      },
      "Generate IDs1": {
        "main": [
          [
            {
              "node": "Delete Old Doc Rows1",
              "type": "main",
              "index": 0
            }
          ]
        ]
      },
      "Switch1": {
        "main": [
          [
            {
              "node": "LLM Extractor Tech-Econ",
              "type": "main",
              "index": 0
            }
          ],
          [
            {
              "node": "LLM Extractor - Deliverables",
              "type": "main",
              "index": 0
            }
          ]
        ]
      },
      "Ollama Extractor2": {
        "ai_languageModel": [
          [
            {
              "node": "LLM Extractor - Deliverables",
              "type": "ai_languageModel",
              "index": 0
            }
          ]
        ]
      },
      "LLM Extractor - Deliverables": {
        "main": [
          [
            {
              "node": "Parsear deliverables",
              "type": "main",
              "index": 0
            }
          ]
        ]
      },
      "Parsear deliverables": {
        "main": [
          [
            {
              "node": "Create a row",
              "type": "main",
              "index": 0
            }
          ]
        ]
      },
      "Ollama Extractor1": {
        "ai_languageModel": [
          [
            {
              "node": "LLM Extractor Tech-Econ",
              "type": "ai_languageModel",
              "index": 0
            }
          ]
        ]
      },
      "Dividir en Trozos1": {
        "main": [
          [
            {
              "node": "Reset Items1",
              "type": "main",
              "index": 0
            }
          ]
        ]
      },
      "Loop por Trozo1": {
        "main": [
          [
            {
              "node": "Loop por Tipo1",
              "type": "main",
              "index": 0
            }
          ],
          [
            {
              "node": "Switch1",
              "type": "main",
              "index": 0
            }
          ]
        ]
      },
      "Reset Items1": {
        "main": [
          [
            {
              "node": "Loop por Trozo1",
              "type": "main",
              "index": 0
            }
          ]
        ]
      },
      "Embeddings Ollama1": {
        "ai_embedding": [
          [
            {
              "node": "Insert into Supabase Vectorstore1",
              "type": "ai_embedding",
              "index": 0
            }
          ]
        ]
      },
      "Insert into Supabase Vectorstore1": {
        "main": [
          [
            {
              "node": "Expandir por Tipo1",
              "type": "main",
              "index": 0
            }
          ]
        ]
      },
      "Recursive Character Text Splitter1": {
        "ai_textSplitter": [
          [
            {
              "node": "Default Data Loader1",
              "type": "ai_textSplitter",
              "index": 0
            }
          ]
        ]
      },
      "Default Data Loader1": {
        "ai_document": [
          [
            {
              "node": "Insert into Supabase Vectorstore1",
              "type": "ai_document",
              "index": 0
            }
          ]
        ]
      },
      "Create a row": {
        "main": [
          [
            {
              "node": "Agregar Resultados1",
              "type": "main",
              "index": 0
            }
          ]
        ]
      },
      "Delete Old Doc Rows1": {
        "main": [
          [
            {
              "node": "Base64 a Binary3",
              "type": "main",
              "index": 0
            }
          ]
        ]
      },
      "Insert Document Metadata2": {
        "main": [
          [
            {
              "node": "Insert into Supabase Vectorstore1",
              "type": "main",
              "index": 0
            }
          ]
        ]
      },
      "LLM Extractor Tech-Econ": {
        "main": [
          [
            {
              "node": "Parsear Items1",
              "type": "main",
              "index": 0
            }
          ]
        ]
      },
      "Webhook1": {
        "main": [
          [
            {
              "node": "Chat AI Agent",
              "type": "main",
              "index": 0
            }
          ]
        ]
      },
      "Postgres Chat Memory": {
        "ai_memory": [
          [
            {
              "node": "Chat AI Agent",
              "type": "ai_memory",
              "index": 0
            }
          ]
        ]
      },
      "Embeddings Ollama": {
        "ai_embedding": [
          [
            {
              "node": "Revisar RFQs",
              "type": "ai_embedding",
              "index": 0
            }
          ]
        ]
      },
      "Chat AI Agent": {
        "main": [
          [
            {
              "node": "Respond to Webhook5",
              "type": "main",
              "index": 0
            }
          ]
        ]
      },
      "Revisar-ofertas": {
        "ai_tool": [
          [
            {
              "node": "Chat AI Agent",
              "type": "ai_tool",
              "index": 0
            }
          ]
        ]
      },
      "Revisar RFQs": {
        "ai_tool": [
          [
            {
              "node": "Chat AI Agent",
              "type": "ai_tool",
              "index": 0
            }
          ]
        ]
      },
      "Embeddings Ollama5": {
        "ai_embedding": [
          [
            {
              "node": "Revisar-ofertas",
              "type": "ai_embedding",
              "index": 0
            }
          ]
        ]
      },
      "query_requirements": {
        "ai_tool": [
          [
            {
              "node": "Chat AI Agent",
              "type": "ai_tool",
              "index": 0
            }
          ]
        ]
      },
      "query_provider_responses": {
        "ai_tool": [
          [
            {
              "node": "Chat AI Agent",
              "type": "ai_tool",
              "index": 0
            }
          ]
        ]
      },
      "query_ranking": {
        "ai_tool": [
          [
            {
              "node": "Chat AI Agent",
              "type": "ai_tool",
              "index": 0
            }
          ]
        ]
      },
      "query_qa_audit": {
        "ai_tool": [
          [
            {
              "node": "Chat AI Agent",
              "type": "ai_tool",
              "index": 0
            }
          ]
        ]
      },
      "Mistral Cloud Chat Model2": {
        "ai_languageModel": [
          [
            {
              "node": "Chat AI Agent",
              "type": "ai_languageModel",
              "index": 0
            }
          ]
        ]
      },
      "Get many rows1": {
        "main": [
          [
            {
              "node": "Reset Items",
              "type": "main",
              "index": 0
            }
          ]
        ]
      },
      "Validador de Ofertas": {
        "main": [
          [
            {
              "node": "Format for Vectorstore",
              "type": "main",
              "index": 0
            }
          ]
        ]
      },
      "Ollama Chat Model1": {
        "ai_languageModel": [
          [
            {
              "node": "Validador de Ofertas",
              "type": "ai_languageModel",
              "index": 0
            }
          ]
        ]
      },
      "Structured Output Parser4": {
        "ai_outputParser": [
          [
            {
              "node": "Validador de Ofertas",
              "type": "ai_outputParser",
              "index": 0
            }
          ]
        ]
      },
      "Clasificador de Tipo de Evaluacion y Proveedor": {
        "main": [
          [
            {
              "node": "Format for Vectorstore",
              "type": "main",
              "index": 0
            }
          ]
        ]
      },
      "If": {
        "main": [
          [
            {
              "node": "Format for Vectorstore",
              "type": "main",
              "index": 0
            }
          ],
          [
            {
              "node": "Format for Vectorstore",
              "type": "main",
              "index": 0
            }
          ]
        ]
      },
      "Ollama Model1": {
        "ai_languageModel": [
          [
            {
              "node": "LLM Chain",
              "type": "ai_languageModel",
              "index": 0
            }
          ]
        ]
      },
      "Ollama Model": {
        "ai_languageModel": [
          [
            {
              "node": "Clasificador de Tipo de Evaluacion y Proveedor",
              "type": "ai_languageModel",
              "index": 0
            }
          ]
        ]
      },
      "Loop Over Phases": {
        "main": [
          [
            {
              "node": "Loop Over Items1",
              "type": "main",
              "index": 0
            }
          ],
          [
            {
              "node": "Preparar Todo para LLM1",
              "type": "main",
              "index": 0
            }
          ]
        ]
      },
      "Parsear y Preparar Update": {
        "main": [
          [
            {
              "node": "Insert or update rows in a table",
              "type": "main",
              "index": 0
            }
          ]
        ]
      },
      "LLM Chain": {
        "main": [
          [
            {
              "node": "Parsear y Preparar Update",
              "type": "main",
              "index": 0
            }
          ]
        ]
      },
      "Insert Document Metadata": {
        "main": [
          [
            {
              "node": "Base64 a Binary",
              "type": "main",
              "index": 0
            }
          ]
        ]
      },
      "Delete Old Doc Rows": {
        "main": [
          [
            {
              "node": "Insert Document Metadata",
              "type": "main",
              "index": 0
            }
          ]
        ]
      },
      "Set File ID": {
        "main": [
          [
            {
              "node": "Delete Old Doc Rows",
              "type": "main",
              "index": 0
            }
          ]
        ]
      },
      "Default Data Loader": {
        "ai_document": [
          [
            {
              "node": "Insert into Supabase Vectorstore",
              "type": "ai_document",
              "index": 0
            }
          ]
        ]
      },
      "Recursive Character Text Splitter": {
        "ai_textSplitter": [
          [
            {
              "node": "Default Data Loader",
              "type": "ai_textSplitter",
              "index": 0
            }
          ]
        ]
      },
      "Insert into Supabase Vectorstore": {
        "main": [
          [
            {
              "node": "Expandir por Tipo de Evaluaci√≥n",
              "type": "main",
              "index": 0
            }
          ]
        ]
      },
      "Validar Contenido PDF": {
        "main": [
          [
            {
              "node": "¬øNecesita OCR?",
              "type": "main",
              "index": 0
            }
          ]
        ]
      },
      "Extract from File": {
        "main": [
          [
            {
              "node": "Validar Contenido PDF",
              "type": "main",
              "index": 0
            }
          ]
        ]
      },
      "¬øNecesita OCR?": {
        "main": [
          [
            {
              "node": "Base64 a Binary1",
              "type": "main",
              "index": 0
            }
          ],
          [
            {
              "node": "Merge1",
              "type": "main",
              "index": 1
            }
          ]
        ]
      },
      "Aggregate OCR Pages": {
        "main": [
          [
            {
              "node": "Merge1",
              "type": "main",
              "index": 0
            }
          ]
        ]
      },
      "Preparar Texto de Muestra": {
        "main": [
          [
            {
              "node": "Format for Vectorstore",
              "type": "main",
              "index": 0
            }
          ]
        ]
      },
      "Format for Vectorstore": {
        "main": [
          [
            {
              "node": "Insert into Supabase Vectorstore",
              "type": "main",
              "index": 0
            }
          ]
        ]
      },
      "Expandir por Tipo de Evaluaci√≥n": {
        "main": [
          [
            {
              "node": "Loop Over Items1",
              "type": "main",
              "index": 0
            }
          ]
        ]
      },
      "Loop Over Items1": {
        "main": [
          [
            {
              "node": "Respond to Webhook",
              "type": "main",
              "index": 0
            }
          ],
          [
            {
              "node": "Get many rows1",
              "type": "main",
              "index": 0
            }
          ]
        ]
      },
      "Docling OCR": {
        "main": [
          [
            {
              "node": "Aggregate OCR Pages",
              "type": "main",
              "index": 0
            }
          ]
        ]
      },
      "Structured Output Parser": {
        "ai_outputParser": [
          [
            {
              "node": "Clasificador de Tipo de Evaluacion y Proveedor",
              "type": "ai_outputParser",
              "index": 0
            }
          ]
        ]
      },
      "Merge1": {
        "main": [
          [
            {
              "node": "Preparar Texto de Muestra",
              "type": "main",
              "index": 0
            }
          ]
        ]
      },
      "Reset Items": {
        "main": [
          [
            {
              "node": "Loop Over Phases",
              "type": "main",
              "index": 0
            }
          ]
        ]
      },
      "Webhook": {
        "main": [
          [
            {
              "node": "Code in JavaScript1",
              "type": "main",
              "index": 0
            }
          ]
        ]
      },
      "Base64 a Binary": {
        "main": [
          [
            {
              "node": "Extract from File",
              "type": "main",
              "index": 0
            }
          ]
        ]
      },
      "Base64 a Binary1": {
        "main": [
          [
            {
              "node": "Docling OCR",
              "type": "main",
              "index": 0
            }
          ]
        ]
      },
      "Code in JavaScript1": {
        "main": [
          [
            {
              "node": "Set File ID",
              "type": "main",
              "index": 0
            }
          ]
        ]
      },
      "Insert or update rows in a table": {
        "main": [
          [
            {
              "node": "Loop Over Phases",
              "type": "main",
              "index": 0
            }
          ]
        ]
      },
      "Embeddings Cohere": {
        "ai_embedding": [
          [
            {
              "node": "Insert into Supabase Vectorstore",
              "type": "ai_embedding",
              "index": 0
            }
          ]
        ]
      },
      "Preparar Todo para LLM1": {
        "main": [
          [
            {
              "node": "LLM Chain",
              "type": "main",
              "index": 0
            }
          ]
        ]
      },
      "Webhook Scoring": {
        "main": [
          [
            {
              "node": "Delete a row",
              "type": "main",
              "index": 0
            }
          ]
        ]
      },
      "Fetch Requirements": {
        "main": [
          [
            {
              "node": "Merge Requirements & Responses",
              "type": "main",
              "index": 0
            }
          ]
        ]
      },
      "Fetch Provider Responses": {
        "main": [
          [
            {
              "node": "Merge Requirements & Responses",
              "type": "main",
              "index": 1
            }
          ]
        ]
      },
      "Merge Requirements & Responses": {
        "main": [
          [
            {
              "node": "Prepare Scoring Data",
              "type": "main",
              "index": 0
            }
          ]
        ]
      },
      "Prepare Scoring Data": {
        "main": [
          [
            {
              "node": "Loop Over Providers",
              "type": "main",
              "index": 0
            }
          ]
        ]
      },
      "Loop Over Providers": {
        "main": [
          [
            {
              "node": "Aggregate All Rankings",
              "type": "main",
              "index": 0
            }
          ],
          [
            {
              "node": "Scoring LLM Chain",
              "type": "main",
              "index": 0
            }
          ]
        ]
      },
      "Scoring LLM Chain": {
        "main": [
          [
            {
              "node": "Calculate Weighted Scores",
              "type": "main",
              "index": 0
            }
          ]
        ]
      },
      "Calculate Weighted Scores": {
        "main": [
          [
            {
              "node": "Check Provider Exists",
              "type": "main",
              "index": 0
            }
          ]
        ]
      },
      "Check Provider Exists": {
        "main": [
          [
            {
              "node": "Provider Exists?",
              "type": "main",
              "index": 0
            }
          ]
        ]
      },
      "Provider Exists?": {
        "main": [
          [
            {
              "node": "Update Ranking",
              "type": "main",
              "index": 0
            }
          ],
          [
            {
              "node": "Insert Ranking",
              "type": "main",
              "index": 0
            }
          ]
        ]
      },
      "Update Ranking": {
        "main": [
          [
            {
              "node": "Loop Over Providers",
              "type": "main",
              "index": 0
            }
          ]
        ]
      },
      "Insert Ranking": {
        "main": [
          [
            {
              "node": "Loop Over Providers",
              "type": "main",
              "index": 0
            }
          ]
        ]
      },
      "Aggregate All Rankings": {
        "main": [
          [
            {
              "node": "Generate Final Ranking",
              "type": "main",
              "index": 0
            }
          ]
        ]
      },
      "Generate Final Ranking": {
        "main": [
          [
            {
              "node": "Respond with Ranking",
              "type": "main",
              "index": 0
            }
          ]
        ]
      },
      "Set Input Params1": {
        "main": [
          [
            {
              "node": "Fetch Requirements",
              "type": "main",
              "index": 0
            },
            {
              "node": "Fetch Provider Responses",
              "type": "main",
              "index": 0
            }
          ]
        ]
      },
      "JSON Output Parser1": {
        "ai_outputParser": [
          [
            {
              "node": "Scoring LLM Chain",
              "type": "ai_outputParser",
              "index": 0
            }
          ]
        ]
      },
      "Delete a row": {
        "main": [
          [
            {
              "node": "Set Input Params1",
              "type": "main",
              "index": 0
            }
          ]
        ]
      },
      "OpenRouter Chat Model1": {
        "ai_languageModel": [
          [
            {
              "node": "Scoring LLM Chain",
              "type": "ai_languageModel",
              "index": 0
            }
          ]
        ]
      },
      "Edit Fields": {
        "main": [
          [
            {
              "node": "Get Offers",
              "type": "main",
              "index": 0
            }
          ]
        ]
      },
      "Filter and Aggregate Issues": {
        "main": [
          [
            {
              "node": "Basic LLM Chain",
              "type": "main",
              "index": 0
            }
          ]
        ]
      },
      "Webhook3": {
        "main": [
          [
            {
              "node": "Edit Fields",
              "type": "main",
              "index": 0
            }
          ]
        ]
      },
      "Get Offers": {
        "main": [
          [
            {
              "node": "Filter and Aggregate Issues",
              "type": "main",
              "index": 0
            }
          ]
        ]
      },
      "Basic LLM Chain": {
        "main": [
          [
            {
              "node": "Respond to Webhook3",
              "type": "main",
              "index": 0
            }
          ]
        ]
      },
      "Mistral Cloud Chat Model1": {
        "ai_languageModel": [
          [
            {
              "node": "Basic LLM Chain",
              "type": "ai_languageModel",
              "index": 0
            }
          ]
        ]
      },
      "Extract Fields": {
        "main": [
          [
            {
              "node": "Validate Data",
              "type": "main",
              "index": 0
            }
          ]
        ]
      },
      "Validate Data": {
        "main": [
          [
            {
              "node": "Convert Markdown to HTML",
              "type": "main",
              "index": 0
            }
          ],
          [
            {
              "node": "Respond Error",
              "type": "main",
              "index": 0
            }
          ]
        ]
      },
      "Convert Markdown to HTML": {
        "main": [
          [
            {
              "node": "Gmail Send",
              "type": "main",
              "index": 0
            }
          ]
        ]
      },
      "Gmail Send": {
        "main": [
          [
            {
              "node": "Respond Success2",
              "type": "main",
              "index": 0
            }
          ]
        ]
      },
      "Webhook2": {
        "main": [
          [
            {
              "node": "Extract Fields",
              "type": "main",
              "index": 0
            }
          ]
        ]
      },
      "Webhook Receive": {
        "main": [
          [
            {
              "node": "Set Input Params2",
              "type": "main",
              "index": 0
            }
          ]
        ]
      },
      "Email Provided?": {
        "main": [
          [
            {
              "node": "Send Email via Gmail",
              "type": "main",
              "index": 0
            }
          ],
          [
            {
              "node": "Split for Update",
              "type": "main",
              "index": 0
            }
          ]
        ]
      },
      "Send Email via Gmail": {
        "main": [
          [
            {
              "node": "Split for Update",
              "type": "main",
              "index": 0
            }
          ]
        ]
      },
      "Generate Token": {
        "main": [
          [
            {
              "node": "Save Token to DB",
              "type": "main",
              "index": 0
            }
          ]
        ]
      },
      "Save Token to DB": {
        "main": [
          [
            {
              "node": "Split Question IDs",
              "type": "main",
              "index": 0
            },
            {
              "node": "Fetch Project Name",
              "type": "main",
              "index": 0
            }
          ]
        ]
      },
      "Split Question IDs": {
        "main": [
          [
            {
              "node": "Fetch Questions",
              "type": "main",
              "index": 0
            }
          ]
        ]
      },
      "Fetch Questions": {
        "main": [
          [
            {
              "node": "Merge Data",
              "type": "main",
              "index": 0
            }
          ]
        ]
      },
      "Fetch Project Name": {
        "main": [
          [
            {
              "node": "Merge Data",
              "type": "main",
              "index": 1
            }
          ]
        ]
      },
      "Merge Data": {
        "main": [
          [
            {
              "node": "Build Email Content",
              "type": "main",
              "index": 0
            }
          ]
        ]
      },
      "Build Email Content": {
        "main": [
          [
            {
              "node": "Email Provided?",
              "type": "main",
              "index": 0
            }
          ]
        ]
      },
      "Split for Update": {
        "main": [
          [
            {
              "node": "Update Question Status",
              "type": "main",
              "index": 0
            }
          ]
        ]
      },
      "Update Question Status": {
        "main": [
          [
            {
              "node": "Respond to Webhook2",
              "type": "main",
              "index": 0
            }
          ]
        ]
      },
      "Set Input Params2": {
        "main": [
          [
            {
              "node": "Generate Token",
              "type": "main",
              "index": 0
            }
          ]
        ]
      },
      "Webhook Inbound": {
        "main": [
          [
            {
              "node": "Set Input Params",
              "type": "main",
              "index": 0
            }
          ]
        ]
      },
      "Set Input Params": {
        "main": [
          [
            {
              "node": "Fetch Missing Items",
              "type": "main",
              "index": 0
            }
          ]
        ]
      },
      "Fetch Missing Items": {
        "main": [
          [
            {
              "node": "Fetch Requirement Specs",
              "type": "main",
              "index": 0
            }
          ]
        ]
      },
      "Fetch Requirement Specs": {
        "main": [
          [
            {
              "node": "Consolidate Deficiencies",
              "type": "main",
              "index": 0
            }
          ]
        ]
      },
      "Consolidate Deficiencies": {
        "main": [
          [
            {
              "node": "QA Generation Chain",
              "type": "main",
              "index": 0
            }
          ]
        ]
      },
      "QA Generation Chain": {
        "main": [
          [
            {
              "node": "Split Questions List",
              "type": "main",
              "index": 0
            }
          ]
        ]
      },
      "JSON Output Parser": {
        "ai_outputParser": [
          [
            {
              "node": "QA Generation Chain",
              "type": "ai_outputParser",
              "index": 0
            }
          ]
        ]
      },
      "Split Questions List": {
        "main": [
          [
            {
              "node": "Supabase Insert",
              "type": "main",
              "index": 0
            }
          ]
        ]
      },
      "Supabase Insert": {
        "main": [
          [
            {
              "node": "Respond to Webhook1",
              "type": "main",
              "index": 0
            }
          ]
        ]
      },
      "Mistral Cloud Chat Model": {
        "ai_languageModel": [
          [
            {
              "node": "QA Generation Chain",
              "type": "ai_languageModel",
              "index": 0
            }
          ]
        ]
      },
      "Validate Token": {
        "main": [
          [
            {
              "node": "Token Valid?",
              "type": "main",
              "index": 0
            }
          ]
        ]
      },
      "Token Valid?": {
        "main": [
          [
            {
              "node": "Split Responses",
              "type": "main",
              "index": 0
            }
          ],
          [
            {
              "node": "Respond Invalid",
              "type": "main",
              "index": 0
            }
          ]
        ]
      },
      "Split Responses": {
        "main": [
          [
            {
              "node": "Loop Over Items",
              "type": "main",
              "index": 0
            }
          ]
        ]
      },
      "Loop Over Items": {
        "main": [
          [
            {
              "node": "Mark Token Responded",
              "type": "main",
              "index": 0
            }
          ],
          [
            {
              "node": "Save Response to QA Audit",
              "type": "main",
              "index": 0
            }
          ]
        ]
      },
      "Save Response to QA Audit": {
        "main": [
          [
            {
              "node": "Fetch Question Details",
              "type": "main",
              "index": 0
            }
          ]
        ]
      },
      "Fetch Question Details": {
        "main": [
          [
            {
              "node": "Has Requirement?",
              "type": "main",
              "index": 0
            }
          ]
        ]
      },
      "Has Requirement?": {
        "main": [
          [
            {
              "node": "Fetch Requirement",
              "type": "main",
              "index": 0
            }
          ],
          [
            {
              "node": "No Requirement",
              "type": "main",
              "index": 0
            }
          ]
        ]
      },
      "Fetch Requirement": {
        "main": [
          [
            {
              "node": "Fetch Current Evaluation",
              "type": "main",
              "index": 0
            }
          ]
        ]
      },
      "Fetch Current Evaluation": {
        "main": [
          [
            {
              "node": "LLM Re-evaluate",
              "type": "main",
              "index": 0
            }
          ]
        ]
      },
      "LLM Re-evaluate": {
        "main": [
          [
            {
              "node": "Should Update?",
              "type": "main",
              "index": 0
            }
          ]
        ]
      },
      "Should Update?": {
        "main": [
          [
            {
              "node": "Update Provider Response",
              "type": "main",
              "index": 0
            }
          ],
          [
            {
              "node": "Skip Update",
              "type": "main",
              "index": 0
            }
          ]
        ]
      },
      "Update Provider Response": {
        "main": [
          [
            {
              "node": "Merge Results",
              "type": "main",
              "index": 0
            }
          ]
        ]
      },
      "Skip Update": {
        "main": [
          [
            {
              "node": "Merge Results",
              "type": "main",
              "index": 0
            }
          ]
        ]
      },
      "No Requirement": {
        "main": [
          [
            {
              "node": "Merge Results",
              "type": "main",
              "index": 0
            }
          ]
        ]
      },
      "Merge Results": {
        "main": [
          [
            {
              "node": "Loop Over Items",
              "type": "main",
              "index": 0
            }
          ]
        ]
      },
      "Mark Token Responded": {
        "main": [
          [
            {
              "node": "Create Notification",
              "type": "main",
              "index": 0
            }
          ]
        ]
      },
      "Create Notification": {
        "main": [
          [
            {
              "node": "Respond Success",
              "type": "main",
              "index": 0
            }
          ]
        ]
      },
      "Webhook Receive1": {
        "main": [
          [
            {
              "node": "Set Input Params3",
              "type": "main",
              "index": 0
            }
          ]
        ]
      },
      "Set Input Params3": {
        "main": [
          [
            {
              "node": "Validate Token",
              "type": "main",
              "index": 0
            }
          ]
        ]
      },
      "JSON Output Parser2": {
        "ai_outputParser": [
          [
            {
              "node": "LLM Re-evaluate",
              "type": "ai_outputParser",
              "index": 0
            }
          ]
        ]
      },
      "Mistral Cloud Chat Model4": {
        "ai_languageModel": [
          [
            {
              "node": "LLM Re-evaluate",
              "type": "ai_languageModel",
              "index": 0
            }
          ]
        ]
      }
    },
    "pinData": {},
    "meta": {
      "templateCredsSetupCompleted": true,
      "instanceId": "53140335eaf11280ef77ef2f5a378f48c2b28e822e3e0d96563cdd92175c0eff"
    }
  }