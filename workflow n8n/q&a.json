{
  "nodes": [
    {
      "parameters": {
        "httpMethod": "POST",
        "path": "qa-audit-generator",
        "responseMode": "responseNode",
        "options": {}
      },
      "type": "n8n-nodes-base.webhook",
      "typeVersion": 2.1,
      "position": [
        -3168,
        176
      ],
      "id": "7310a149-8927-430a-9799-31065d9283b5",
      "name": "Webhook Inbound",
      "webhookId": "41c26ac0-0585-4697-91c8-1a4b4851fee3"
    },
    {
      "parameters": {
        "assignments": {
          "assignments": [
            {
              "id": "project_id",
              "name": "project_id",
              "value": "={{ $json.body.project_id }}",
              "type": "string"
            },
            {
              "id": "provider",
              "name": "provider",
              "value": "={{ $json.body.provider }}",
              "type": "string"
            }
          ]
        },
        "options": {}
      },
      "type": "n8n-nodes-base.set",
      "typeVersion": 3.4,
      "position": [
        -2944,
        176
      ],
      "id": "484ed7a1-9154-4637-a943-c561b4e479f8",
      "name": "Set Input Params"
    },
    {
      "parameters": {
        "operation": "getAll",
        "tableId": "provider_responses",
        "returnAll": true,
        "matchType": "allFilters",
        "filters": {
          "conditions": [
            {
              "keyName": "provider_name",
              "condition": "eq",
              "keyValue": "={{ $json.provider }}"
            },
            {
              "keyName": "evaluation_value",
              "condition": "neq",
              "keyValue": "INCLUIDO"
            }
          ]
        }
      },
      "type": "n8n-nodes-base.supabase",
      "typeVersion": 1,
      "position": [
        -2736,
        176
      ],
      "id": "c1dbd462-f994-45ed-9a61-09ce5dd2ebb3",
      "name": "Fetch Missing Items",
      "credentials": {
        "supabaseApi": {
          "id": "pI4CpdYLTiEEBmnz",
          "name": "Supabase account"
        }
      }
    },
    {
      "parameters": {
        "operation": "getAll",
        "tableId": "rfq_items_master",
        "limit": 1,
        "filters": {
          "conditions": [
            {
              "keyName": "id",
              "condition": "eq",
              "keyValue": "={{ $json.requirement_id }}"
            }
          ]
        }
      },
      "type": "n8n-nodes-base.supabase",
      "typeVersion": 1,
      "position": [
        -2496,
        176
      ],
      "id": "51285618-6b53-41e8-9ba7-bb4977cff35d",
      "name": "Fetch Requirement Specs",
      "credentials": {
        "supabaseApi": {
          "id": "pI4CpdYLTiEEBmnz",
          "name": "Supabase account"
        }
      }
    },
    {
      "parameters": {
        "aggregate": "aggregateAllItemData",
        "destinationFieldName": "total_deficiencies",
        "options": {}
      },
      "type": "n8n-nodes-base.aggregate",
      "typeVersion": 1,
      "position": [
        -2304,
        176
      ],
      "id": "ec63befe-cae6-4123-8f86-8b7ddbaf1194",
      "name": "Consolidate Deficiencies"
    },
    {
      "parameters": {
        "promptType": "define",
        "text": "=Generate a MAXIMUM of 20-25 technical audit questions for provider {{ $(\"Set Input Params\").first().json.provider }}.\n\nDEFICIENCIES:\n{{ JSON.stringify($json.total_deficiencies) }}\n\n### INSTRUCTIONS:\n1. **LIMIT**: 15-25 questions MAX. Quality over quantity.\n2. **GROUP**: Combine similar deficiencies into single comprehensive questions.\n3. **PRIORITIZE**: Focus on the most critical gaps affecting project viability.\n4. **DISCIPLINES** (EXACT names only): Electrical, Mechanical, Civil, Process, General, Cost\n5. **IMPORTANCE**: Use \"High\" sparingly (only truly critical). Most should be \"Medium\" or \"Low\".\n6. **Language**: All in English.\n\n### OUTPUT SCHEMA:\n{\n  \"type\": \"object\",\n  \"properties\": {\n    \"questions\": {\n      \"type\": \"array\",\n      \"maxItems\": 25,\n      \"items\": {\n        \"type\": \"object\",\n        \"properties\": {\n          \"discipline\": { \"type\": \"string\", \"enum\": [\"Electrical\", \"Mechanical\", \"Civil\", \"Process\", \"General\", \"Cost\"] },\n          \"question\": { \"type\": \"string\" },\n          \"importance\": { \"type\": \"string\", \"enum\": [\"High\", \"Medium\", \"Low\"] }\n        }\n      }\n    }\n  }\n}",
        "hasOutputParser": true,
        "batching": {}
      },
      "type": "@n8n/n8n-nodes-langchain.chainLlm",
      "typeVersion": 1.8,
      "position": [
        -2112,
        176
      ],
      "id": "1349ebb2-17bf-42d9-97ad-82304ac47598",
      "name": "QA Generation Chain"
    },
    {
      "parameters": {
        "model": "mistral-large-latest",
        "options": {
          "temperature": 0
        }
      },
      "type": "@n8n/n8n-nodes-langchain.lmChatMistralCloud",
      "typeVersion": 1,
      "position": [
        -2192,
        384
      ],
      "id": "aca8e8e6-3a23-44d7-a0c4-899c6203e239",
      "name": "Mistral Model",
      "credentials": {
        "mistralCloudApi": {
          "id": "tDjuOnF6lpADMmd5",
          "name": "Mistral Cloud account"
        }
      }
    },
    {
      "parameters": {
        "schemaType": "manual",
        "inputSchema": "{\n  \"type\": \"object\",\n  \"properties\": {\n    \"questions\": {\n      \"type\": \"array\",\n      \"items\": {\n        \"type\": \"object\",\n        \"properties\": {\n          \"discipline\": { \"type\": \"string\", \"enum\": [\"Electrical\", \"Mechanical\", \"Civil\", \"Process\", \"General\", \"Cost\"] },\n          \"question\": { \"type\": \"string\" },\n          \"importance\": { \"type\": \"string\", \"enum\": [\"High\", \"Medium\", \"Low\"] }\n        }\n      }\n    }\n  }\n}"
      },
      "type": "@n8n/n8n-nodes-langchain.outputParserStructured",
      "typeVersion": 1.3,
      "position": [
        -1888,
        384
      ],
      "id": "5e5275ec-3091-4414-9b57-62277337d276",
      "name": "JSON Output Parser"
    },
    {
      "parameters": {
        "fieldToSplitOut": "output.questions",
        "include": "allOtherFields",
        "options": {}
      },
      "type": "n8n-nodes-base.itemLists",
      "typeVersion": 3.1,
      "position": [
        -1792,
        176
      ],
      "id": "80005628-c970-49ae-9492-af72cd753f53",
      "name": "Split Questions List"
    },
    {
      "parameters": {
        "tableId": "qa_audit",
        "fieldsUi": {
          "fieldValues": [
            {
              "fieldId": "question",
              "fieldValue": "={{ $json['output.questions'].question }}"
            },
            {
              "fieldId": "importance",
              "fieldValue": "={{ $json['output.questions'].importance }}"
            },
            {
              "fieldId": "discipline",
              "fieldValue": "={{ $json['output.questions'].discipline }}"
            },
            {
              "fieldId": "provider_name",
              "fieldValue": "={{ $(\"Set Input Params\").first().json.provider }}"
            },
            {
              "fieldId": "project_name",
              "fieldValue": "={{ $(\"Set Input Params\").first().json.project_id }}"
            },
            {
              "fieldId": "status",
              "fieldValue": "Pending"
            }
          ]
        }
      },
      "type": "n8n-nodes-base.supabase",
      "typeVersion": 1,
      "position": [
        -1632,
        176
      ],
      "id": "3e2e04fd-2f56-4cc4-961f-0e7e0dfc2618",
      "name": "Supabase Insert",
      "credentials": {
        "supabaseApi": {
          "id": "pI4CpdYLTiEEBmnz",
          "name": "Supabase account"
        }
      }
    },
    {
      "parameters": {
        "respondWith": "allIncomingItems",
        "options": {}
      },
      "type": "n8n-nodes-base.respondToWebhook",
      "typeVersion": 1.5,
      "position": [
        -1424,
        176
      ],
      "id": "aace1027-dd6f-4af9-afd3-74397f893e83",
      "name": "Respond to Webhook1"
    },
    {
      "parameters": {
        "content": "## Q&A",
        "height": 656,
        "width": 2048,
        "color": 7
      },
      "type": "n8n-nodes-base.stickyNote",
      "typeVersion": 1,
      "position": [
        -3264,
        -48
      ],
      "id": "b0fc1116-609b-4ead-affe-27f525ad3bed",
      "name": "Sticky Note1"
    }
  ],
  "connections": {
    "Webhook Inbound": {
      "main": [
        [
          {
            "node": "Set Input Params",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Set Input Params": {
      "main": [
        [
          {
            "node": "Fetch Missing Items",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Fetch Missing Items": {
      "main": [
        [
          {
            "node": "Fetch Requirement Specs",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Fetch Requirement Specs": {
      "main": [
        [
          {
            "node": "Consolidate Deficiencies",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Consolidate Deficiencies": {
      "main": [
        [
          {
            "node": "QA Generation Chain",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "QA Generation Chain": {
      "main": [
        [
          {
            "node": "Split Questions List",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Mistral Model": {
      "ai_languageModel": [
        [
          {
            "node": "QA Generation Chain",
            "type": "ai_languageModel",
            "index": 0
          }
        ]
      ]
    },
    "JSON Output Parser": {
      "ai_outputParser": [
        [
          {
            "node": "QA Generation Chain",
            "type": "ai_outputParser",
            "index": 0
          }
        ]
      ]
    },
    "Split Questions List": {
      "main": [
        [
          {
            "node": "Supabase Insert",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Supabase Insert": {
      "main": [
        [
          {
            "node": "Respond to Webhook1",
            "type": "main",
            "index": 0
          }
        ]
      ]
    }
  },
  "pinData": {},
  "meta": {
    "templateCredsSetupCompleted": true,
    "instanceId": "53140335eaf11280ef77ef2f5a378f48c2b28e822e3e0d96563cdd92175c0eff"
  }
}