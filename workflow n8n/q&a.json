{
  "nodes": [
    {
      "parameters": {
        "httpMethod": "POST",
        "path": "qa-audit-generator",
        "responseMode": "responseNode",
        "options": {}
      },
      "type": "n8n-nodes-base.webhook",
      "typeVersion": 2.1,
      "position": [
        -3136,
        80
      ],
      "id": "2e8198fa-bb18-40b2-b589-54b7fb907e67",
      "name": "Webhook Inbound",
      "webhookId": "0496e481-bb76-42f1-b3d5-734935b4b631"
    },
    {
      "parameters": {
        "assignments": {
          "assignments": [
            {
              "id": "project_id",
              "name": "project_id",
              "value": "={{ $json.body.project_id }}",
              "type": "string"
            },
            {
              "id": "provider",
              "name": "provider",
              "value": "={{ $json.body.provider }}",
              "type": "string"
            }
          ]
        },
        "options": {}
      },
      "type": "n8n-nodes-base.set",
      "typeVersion": 3.4,
      "position": [
        -2912,
        80
      ],
      "id": "8b3b8f15-474f-4507-a00f-af37dafc7266",
      "name": "Set Input Params"
    },
    {
      "parameters": {
        "operation": "getAll",
        "tableId": "provider_responses",
        "returnAll": true,
        "matchType": "allFilters",
        "filters": {
          "conditions": [
            {
              "keyName": "provider_name",
              "condition": "eq",
              "keyValue": "={{ $json.provider }}"
            },
            {
              "keyName": "project_id",
              "condition": "eq",
              "keyValue": "={{ $json.project_id }}"
            }
          ]
        }
      },
      "type": "n8n-nodes-base.supabase",
      "typeVersion": 1,
      "position": [
        -2704,
        80
      ],
      "id": "c75924e0-ff9b-47f4-a6e7-d48de02efa02",
      "name": "Fetch All Provider Responses",
      "credentials": {
        "supabaseApi": {
          "id": "pI4CpdYLTiEEBmnz",
          "name": "Supabase account"
        }
      }
    },
    {
      "parameters": {
        "jsCode": "// =============================================\n// NODO: Filter Deficiencies Only\n// Solo incluye items que realmente son deficiencias\n// =============================================\n\nconst items = $input.all();\n\n// Valores que indican deficiencias (necesitan Q&A)\nconst DEFICIENCY_VALUES = [\n  'PARTIALLY INCLUDED',\n  'NOT INCLUDED WITH ALTERNATIVE',\n  'NOT INCLUDED',\n  'NO INFORMATION'\n];\n\n// Valores que NO son deficiencias (no necesitan Q&A)\nconst OK_VALUES = [\n  'INCLUDED',\n  'INCLUDED WITH CAVEATS'\n];\n\nconst filteredItems = items.filter(item => {\n  const evalValue = (item.json.evaluation_value || '').toUpperCase().trim();\n  \n  // Si es un valor OK, excluir\n  if (OK_VALUES.some(v => evalValue === v.toUpperCase())) {\n    return false;\n  }\n  \n  // Caso 1: Es uno de los valores de deficiencia conocidos\n  if (DEFICIENCY_VALUES.some(v => evalValue.includes(v.toUpperCase()))) {\n    return true;\n  }\n  \n  // Caso 2: Empieza con \"NO VALUE FOUND\" (evaluaci贸n econ贸mica sin valor)\n  if (evalValue.startsWith('NO VALUE FOUND')) {\n    return true;\n  }\n  \n  // Caso 3: Score bajo (menor a 5) como indicador de deficiencia\n  const score = item.json.score || 0;\n  if (score < 5) {\n    return true;\n  }\n  \n  // Por defecto, excluir (valores econ贸micos con precios, etc.)\n  return false;\n});\n\nconsole.log(` Filtrado de deficiencias:`);\nconsole.log(`    Total recibidos: ${items.length}`);\nconsole.log(`    Deficiencias encontradas: ${filteredItems.length}`);\n\n// Log de valores excluidos para debug\nconst excluded = items.length - filteredItems.length;\nif (excluded > 0) {\n  console.log(`    Excluidos (valores OK o econ贸micos): ${excluded}`);\n}\n\nreturn filteredItems;"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        -2504,
        80
      ],
      "id": "filter-deficiencies-node",
      "name": "Filter Deficiencies Only"
    },
    {
      "parameters": {
        "operation": "getAll",
        "tableId": "rfq_items_master",
        "limit": 1,
        "filters": {
          "conditions": [
            {
              "keyName": "id",
              "condition": "eq",
              "keyValue": "={{ $json.requirement_id }}"
            }
          ]
        }
      },
      "type": "n8n-nodes-base.supabase",
      "typeVersion": 1,
      "position": [
        -2304,
        80
      ],
      "id": "c0a9c906-2e55-4108-ac24-1c5a9a8c7f42",
      "name": "Fetch Requirement Specs",
      "credentials": {
        "supabaseApi": {
          "id": "pI4CpdYLTiEEBmnz",
          "name": "Supabase account"
        }
      }
    },
    {
      "parameters": {
        "aggregate": "aggregateAllItemData",
        "destinationFieldName": "total_deficiencies",
        "options": {}
      },
      "type": "n8n-nodes-base.aggregate",
      "typeVersion": 1,
      "position": [
        -2104,
        80
      ],
      "id": "2320ff2e-62c5-4eb3-86f5-1e57cbc4bf5c",
      "name": "Consolidate Deficiencies"
    },
    {
      "parameters": {
        "promptType": "define",
        "text": "=Generate technical audit questions in English based on the following deficiencies detected for the provider {{ $(\"Set Input Params\").first().json.provider }}.\n\n**IMPORTANT**: Each deficiency has an \"id\" field which is the requirement_id. You MUST include this requirement_id with each question you generate, linking the question back to its source deficiency.\n\nDEFICIENCIES:\n{{ JSON.stringify($json.total_deficiencies) }}\n\n### INSTRUCTIONS:\n1.  **Link to Requirement**: Each question MUST include the \"requirement_id\" (the \"id\" field from the deficiency it relates to).\n2.  **Analyze & Classify**: For each deficiency, determine its specific engineering field.\n    - If it involves cables, power, or circuits -> **Electrical**\n    - If it involves machinery, pumps, or piping -> **Mechanical**\n    - If it involves structures, foundations, or concrete -> **Civil**\n    - If it involves workflows, chemical stages, or P&IDs -> **Process**\n    - Only if it is administrative or multi-disciplinary -> **General**\n3.  **Language**: All questions and text MUST be in English.\n4.  **Strictness**: Do not label everything as \"General\". Be as specific as possible.\n5.  **Format**: Respond strictly with the JSON object following the schema.\n\n### OUTPUT SCHEMA:\n{\n  \"questions\": [\n    {\n      \"requirement_id\": \"uuid-from-deficiency-id-field\",\n      \"discipline\": \"Electrical\" | \"Mechanical\" | \"Civil\" | \"Process\" | \"General\",\n      \"question\": \"The specific question in English\",\n      \"importance\": \"High\" | \"Medium\" | \"Low\"\n    }\n  ]\n}",
        "hasOutputParser": true,
        "batching": {}
      },
      "type": "@n8n/n8n-nodes-langchain.chainLlm",
      "typeVersion": 1.8,
      "position": [
        -1912,
        80
      ],
      "id": "f0fbafa9-6168-4ae6-af79-0b641e9c3f2d",
      "name": "QA Generation Chain"
    },
    {
      "parameters": {
        "schemaType": "manual",
        "inputSchema": "{\n  \"type\": \"object\",\n  \"properties\": {\n    \"questions\": {\n      \"type\": \"array\",\n      \"items\": {\n        \"type\": \"object\",\n        \"properties\": {\n          \"requirement_id\": { \"type\": \"string\" },\n          \"discipline\": { \"type\": \"string\" },\n          \"question\": { \"type\": \"string\" },\n          \"importance\": { \"type\": \"string\" }\n        }\n      }\n    }\n  }\n}"
      },
      "type": "@n8n/n8n-nodes-langchain.outputParserStructured",
      "typeVersion": 1.3,
      "position": [
        -1688,
        288
      ],
      "id": "d2a100c7-5253-4e91-a85f-5eafaf9fe16a",
      "name": "JSON Output Parser"
    },
    {
      "parameters": {
        "fieldToSplitOut": "output.questions",
        "include": "allOtherFields",
        "options": {}
      },
      "type": "n8n-nodes-base.itemLists",
      "typeVersion": 3.1,
      "position": [
        -1592,
        80
      ],
      "id": "e1569d96-f5f6-4327-8f7e-2c3e19145ccc",
      "name": "Split Questions List"
    },
    {
      "parameters": {
        "tableId": "qa_audit",
        "fieldsUi": {
          "fieldValues": [
            {
              "fieldId": "question",
              "fieldValue": "={{ $json['output.questions'].question }}"
            },
            {
              "fieldId": "importance",
              "fieldValue": "={{ $json['output.questions'].importance }}"
            },
            {
              "fieldId": "discipline",
              "fieldValue": "={{ $json['output.questions'].discipline }}"
            },
            {
              "fieldId": "provider_name",
              "fieldValue": "={{ $(\"Set Input Params\").first().json.provider }}"
            },
            {
              "fieldId": "project_id",
              "fieldValue": "={{ $(\"Set Input Params\").first().json.project_id }}"
            },
            {
              "fieldId": "requirement_id",
              "fieldValue": "={{ $json['output.questions'].requirement_id }}"
            },
            {
              "fieldId": "status",
              "fieldValue": "Pending"
            }
          ]
        }
      },
      "type": "n8n-nodes-base.supabase",
      "typeVersion": 1,
      "position": [
        -1432,
        80
      ],
      "id": "cf3c90a4-1dcf-4ade-98fd-3d80013f5509",
      "name": "Supabase Insert",
      "credentials": {
        "supabaseApi": {
          "id": "pI4CpdYLTiEEBmnz",
          "name": "Supabase account"
        }
      }
    },
    {
      "parameters": {
        "respondWith": "allIncomingItems",
        "options": {}
      },
      "type": "n8n-nodes-base.respondToWebhook",
      "typeVersion": 1.5,
      "position": [
        -1224,
        80
      ],
      "id": "c2b18e2d-f872-4bb1-bc20-b8a9a3d4446b",
      "name": "Respond to Webhook1"
    },
    {
      "parameters": {
        "content": "## Q&A Generator\n\n**Updated**: Now filters only real deficiencies before generating questions.\n\n**Deficiencies filtered**:\n- PARTIALLY INCLUDED\n- NOT INCLUDED WITH ALTERNATIVE\n- NOT INCLUDED\n- NO INFORMATION\n- NO VALUE FOUND - *\n- Any item with score < 5\n\n**Excluded** (not deficiencies):\n- INCLUDED\n- INCLUDED WITH CAVEATS\n- Economic values (prices, hours, etc.)\n\n**Flow**:\n1. Receive project_id and provider\n2. Fetch ALL provider_responses\n3. Filter only deficiencies (Code node)\n4. Fetch requirement details for each\n5. Generate questions with LLM\n6. Save to qa_audit",
        "height": 656,
        "width": 2200,
        "color": 7
      },
      "type": "n8n-nodes-base.stickyNote",
      "typeVersion": 1,
      "position": [
        -3232,
        -144
      ],
      "id": "7c6ee1ef-ff5b-45ea-83f6-ed616b15f957",
      "name": "Sticky Note1"
    },
    {
      "parameters": {
        "model": "qwen3:8b",
        "options": {
          "temperature": 0.1,
          "numCtx": 8192,
          "numPredict": 1536
        }
      },
      "type": "@n8n/n8n-nodes-langchain.lmOllama",
      "typeVersion": 1,
      "position": [
        -2008,
        336
      ],
      "id": "955f765c-52e2-4157-a4fe-38ebf08c16f7",
      "name": "Ollama Model2",
      "credentials": {
        "ollamaApi": {
          "id": "oS2Qqti9oVfsm8XZ",
          "name": "Ollama account"
        }
      }
    },
    {
      "parameters": {
        "model": "mistral-large-latest",
        "options": {
          "temperature": 0.1
        }
      },
      "type": "@n8n/n8n-nodes-langchain.lmChatMistralCloud",
      "typeVersion": 1,
      "position": [
        -1832,
        384
      ],
      "id": "778c394b-3e01-4cf7-9ccb-ca1805527849",
      "name": "Mistral Cloud Chat Model",
      "credentials": {
        "mistralCloudApi": {
          "id": "tDjuOnF6lpADMmd5",
          "name": "Mistral Cloud account"
        }
      }
    }
  ],
  "connections": {
    "Webhook Inbound": {
      "main": [
        [
          {
            "node": "Set Input Params",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Set Input Params": {
      "main": [
        [
          {
            "node": "Fetch All Provider Responses",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Fetch All Provider Responses": {
      "main": [
        [
          {
            "node": "Filter Deficiencies Only",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Filter Deficiencies Only": {
      "main": [
        [
          {
            "node": "Fetch Requirement Specs",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Fetch Requirement Specs": {
      "main": [
        [
          {
            "node": "Consolidate Deficiencies",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Consolidate Deficiencies": {
      "main": [
        [
          {
            "node": "QA Generation Chain",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "QA Generation Chain": {
      "main": [
        [
          {
            "node": "Split Questions List",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "JSON Output Parser": {
      "ai_outputParser": [
        [
          {
            "node": "QA Generation Chain",
            "type": "ai_outputParser",
            "index": 0
          }
        ]
      ]
    },
    "Split Questions List": {
      "main": [
        [
          {
            "node": "Supabase Insert",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Supabase Insert": {
      "main": [
        [
          {
            "node": "Respond to Webhook1",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Mistral Cloud Chat Model": {
      "ai_languageModel": [
        [
          {
            "node": "QA Generation Chain",
            "type": "ai_languageModel",
            "index": 0
          }
        ]
      ]
    }
  },
  "pinData": {},
  "meta": {
    "templateCredsSetupCompleted": true,
    "instanceId": "53140335eaf11280ef77ef2f5a378f48c2b28e822e3e0d96563cdd92175c0eff"
  }
}
