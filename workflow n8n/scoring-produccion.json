{
    "nodes": [
        {
            "parameters": {
                "useCustomSchema": true,
                "schema": "public",
                "operation": "getAll",
                "tableId": "rfq_items_master",
                "returnAll": true,
                "matchType": "allFilters",
                "filters": {
                    "conditions": [
                        {
                            "keyName": "project_id",
                            "condition": "eq",
                            "keyValue": "={{ $('Set Input Params1').first().json.project_id }}"
                        }
                    ]
                }
            },
            "type": "n8n-nodes-base.supabase",
            "typeVersion": 1,
            "position": [
                -9504,
                5680
            ],
            "id": "4afee5c8-6520-49f8-b9f6-6247fc418ed2",
            "name": "Fetch Requirements",
            "credentials": {
                "supabaseApi": {
                    "id": "pI4CpdYLTiEEBmnz",
                    "name": "Supabase account"
                }
            }
        },
        {
            "parameters": {
                "useCustomSchema": true,
                "schema": "public",
                "operation": "getAll",
                "tableId": "provider_responses",
                "returnAll": true,
                "filters": {
                    "conditions": [
                        {
                            "keyName": "project_id",
                            "condition": "eq",
                            "keyValue": "={{ $('Set Input Params1').first().json.project_id }}"
                        }
                    ]
                }
            },
            "type": "n8n-nodes-base.supabase",
            "typeVersion": 1,
            "position": [
                -9504,
                5920
            ],
            "id": "e9eb593d-3ebd-417d-ab63-87f4a3d561ad",
            "name": "Fetch Provider Responses",
            "credentials": {
                "supabaseApi": {
                    "id": "pI4CpdYLTiEEBmnz",
                    "name": "Supabase account"
                }
            }
        },
        {
            "parameters": {
                "useCustomSchema": true,
                "schema": "public",
                "operation": "getAll",
                "tableId": "scoring_configuration_summary",
                "returnAll": true,
                "filters": {
                    "conditions": [
                        {
                            "keyName": "project_id",
                            "condition": "eq",
                            "keyValue": "={{ $('Set Input Params1').first().json.project_id }}"
                        }
                    ]
                }
            },
            "type": "n8n-nodes-base.supabase",
            "typeVersion": 1,
            "position": [
                -9504,
                6144
            ],
            "id": "5259df98-4163-4507-a8df-2e87a96d34a5",
            "name": "Fetch Scoring Configuration",
            "alwaysOutputData": true,
            "credentials": {
                "supabaseApi": {
                    "id": "pI4CpdYLTiEEBmnz",
                    "name": "Supabase account"
                }
            }
        },
        {
            "parameters": {
                "useCustomSchema": true,
                "schema": "public",
                "operation": "getAll",
                "tableId": "economic_offers",
                "returnAll": true,
                "filters": {
                    "conditions": [
                        {
                            "keyName": "project_id",
                            "condition": "eq",
                            "keyValue": "={{ $('Set Input Params1').first().json.project_id }}"
                        }
                    ]
                }
            },
            "type": "n8n-nodes-base.supabase",
            "typeVersion": 1,
            "position": [
                -9504,
                6368
            ],
            "id": "a1b2c3d4-econ-4507-a8df-economic00001",
            "name": "Fetch Economic Offers",
            "alwaysOutputData": true,
            "credentials": {
                "supabaseApi": {
                    "id": "pI4CpdYLTiEEBmnz",
                    "name": "Supabase account"
                }
            }
        },
        {
            "parameters": {
                "numberInputs": 4
            },
            "type": "n8n-nodes-base.merge",
            "typeVersion": 3.2,
            "position": [
                -9280,
                5776
            ],
            "id": "dd362288-174f-4358-99cd-fdd50cfb371b",
            "name": "Merge Requirements & Responses"
        },
        {
            "parameters": {
                "jsCode": "// =============================================\n// NODO: Prepare Scoring Data (v5 - Dynamic Criteria Support)\n// Supports both hardcoded defaults and dynamic criteria from database\n// =============================================\n\nconst items = $input.all();\n\nconsole.log('ðŸ“Š Prepare Scoring Data - Starting...');\nconsole.log('   Items received:', items.length);\n\n/* =========================\nGet project_id from webhook\n========================= */\nlet projectId = null;\ntry {\n    projectId = $('Set Input Params1').first().json.project_id;\n    console.log('   ðŸ“‹ Project ID:', projectId);\n} catch (e) {\n    console.log('   âš ï¸ Could not get project_id:', e.message);\n}\n\n/* =========================\nGet Dynamic Scoring Configuration (if exists)\n========================= */\nlet dynamicConfig = null;\nlet useDynamicConfig = false;\ntry {\n    const configItems = $('Fetch Scoring Configuration').all();\n    if (configItems && configItems.length > 0 && configItems[0].json.category_name) {\n        // Parse configuration into structured format\n        const configData = configItems.map(item => item.json);\n        dynamicConfig = {\n            categories: {},\n            criteria: {},\n            criteriaWeights: {},\n            categoryWeights: {}\n        };\n        \n        configData.forEach(row => {\n            const catName = row.category_name;\n            const catWeight = parseFloat(row.category_weight) || 0;\n            \n            if (!dynamicConfig.categories[catName]) {\n                dynamicConfig.categories[catName] = {\n                    name: catName,\n                    display_name: row.category_display_name,\n                    weight: catWeight,\n                    color: row.category_color,\n                    criteria: []\n                };\n                dynamicConfig.categoryWeights[catName.toUpperCase()] = catWeight / 100;\n            }\n            \n            if (row.criterion_name) {\n                const critName = row.criterion_name;\n                const critWeight = parseFloat(row.criterion_weight) || 0;\n                const actualWeight = (critWeight * catWeight) / 10000; // criterion_weight% of category_weight%\n                \n                dynamicConfig.criteria[critName] = {\n                    name: critName,\n                    display_name: row.criterion_display_name,\n                    description: row.criterion_description,\n                    category: catName,\n                    weight: critWeight,\n                    keywords: row.criterion_keywords || []\n                };\n                dynamicConfig.criteriaWeights[critName] = actualWeight;\n                dynamicConfig.categories[catName].criteria.push(critName);\n            }\n        });\n        \n        useDynamicConfig = Object.keys(dynamicConfig.criteria).length > 0;\n        console.log('   âœ… Dynamic configuration loaded:', Object.keys(dynamicConfig.criteria).length, 'criteria');\n    }\n} catch (e) {\n    console.log('   âš ï¸ Could not load dynamic config:', e.message);\n}\n\n/* =========================\nDefault Criteria (fallback)\n========================= */\nconst DEFAULT_CRITERIA_WEIGHTS = {\n    scope_facilities: 0.10,\n    scope_work: 0.10,\n    deliverables_quality: 0.10,\n    total_price: 0.15,\n    price_breakdown: 0.08,\n    optionals_included: 0.07,\n    capex_opex_methodology: 0.05,\n    schedule: 0.08,\n    resources_allocation: 0.06,\n    exceptions: 0.06,\n    safety_studies: 0.08,\n    regulatory_compliance: 0.07\n};\n\nconst DEFAULT_CATEGORY_WEIGHTS = {\n    TECHNICAL: 0.30,\n    ECONOMIC: 0.35,\n    EXECUTION: 0.20,\n    HSE_COMPLIANCE: 0.15\n};\n\n// Use dynamic or default\nconst CRITERIA_WEIGHTS = useDynamicConfig ? dynamicConfig.criteriaWeights : DEFAULT_CRITERIA_WEIGHTS;\nconst CATEGORY_WEIGHTS = useDynamicConfig ? dynamicConfig.categoryWeights : DEFAULT_CATEGORY_WEIGHTS;\n\nconsole.log('   ðŸ“Š Using', useDynamicConfig ? 'DYNAMIC' : 'DEFAULT', 'configuration');\nconsole.log('   ðŸ“Š Criteria:', Object.keys(CRITERIA_WEIGHTS).join(', '));\n\n/* =========================\nHelpers - Map requirements to criteria\n========================= */\nfunction getCriterionFromRequirement(evalType, phase, reqText, keywords) {\n    const type = (evalType || '').toLowerCase();\n    const phaseL = (phase || '').toLowerCase();\n    const text = (reqText || '').toLowerCase();\n    \n    // If using dynamic config, try to match by keywords first\n    if (useDynamicConfig && dynamicConfig.criteria) {\n        for (const [critName, critInfo] of Object.entries(dynamicConfig.criteria)) {\n            const kws = critInfo.keywords || [];\n            for (const kw of kws) {\n                if (text.includes(kw.toLowerCase())) {\n                    return critName;\n                }\n            }\n        }\n    }\n    \n    // Fallback to default mapping logic\n    if (type.includes('technical')) {\n        if (text.includes('scope of facilities') || text.includes('hydrogen plant') || text.includes('utilities')) {\n            return 'scope_facilities';\n        }\n        if (text.includes('scope of work') || text.includes('project management') || text.includes('deliverables')) {\n            return 'scope_work';\n        }\n        if (text.includes('p&id') || text.includes('3d model') || text.includes('specification') || text.includes('datasheet')) {\n            return 'deliverables_quality';\n        }\n        return 'scope_work';\n    }\n    \n    if (type.includes('econom')) {\n        if (text.includes('price') || text.includes('â‚¬') || text.includes('fee') || text.includes('cost')) {\n            return 'total_price';\n        }\n        if (text.includes('hour') || text.includes('discipline') || text.includes('breakdown')) {\n            return 'price_breakdown';\n        }\n        if (text.includes('optional') || text.includes('geotechnical') || text.includes('topograph') || text.includes('hazid')) {\n            return 'optionals_included';\n        }\n        if (text.includes('capex') || text.includes('opex') || text.includes('aacei') || text.includes('estimate')) {\n            return 'capex_opex_methodology';\n        }\n        return 'total_price';\n    }\n    \n    if (text.includes('hse') || text.includes('safety') || text.includes('hazop') || text.includes('hazid') || text.includes('atex') || text.includes('qra')) {\n        return 'safety_studies';\n    }\n    if (text.includes('code') || text.includes('standard') || text.includes('compliance') || text.includes('regulation')) {\n        return 'regulatory_compliance';\n    }\n    \n    if (phaseL.includes('pre-feed') || phaseL.includes('feed') || type.includes('deliverable')) {\n        if (text.includes('schedule') || text.includes('planning') || text.includes('timeline')) {\n            return 'schedule';\n        }\n        if (text.includes('exception') || text.includes('deviation') || text.includes('exclusion')) {\n            return 'exceptions';\n        }\n        return 'resources_allocation';\n    }\n    \n    return 'scope_work';\n}\n\nfunction classifyEval(val) {\n    const v = (val || '').toUpperCase();\n    if (v.includes('INCLUD') || v.includes('INCLUIDO') || v === 'SI' || v === 'YES') return 'INCLUDED';\n    if (v.includes('PARCIAL') || v.includes('PARTIAL')) return 'PARTIAL';\n    if (v.includes('NO INCLUD') || v.includes('NOT INCLUD') || v === 'NO') return 'NOT_INCLUDED';\n    return 'NO_INFO';\n}\n\n/* =========================\nGet data from previous nodes\n========================= */\nlet requirements = [];\nlet responses = [];\n\ntry {\n    const reqItems = $('Fetch Requirements').all();\n    requirements = reqItems.map(item => item.json);\n    console.log('   âœ… Requirements from Fetch Requirements:', requirements.length);\n} catch (e) {\n    console.log('   âš ï¸ Could not access Fetch Requirements:', e.message);\n}\n\ntry {\n    const respItems = $('Fetch Provider Responses').all();\n    responses = respItems.map(item => item.json);\n    console.log('   âœ… Responses from Fetch Provider Responses:', responses.length);\n} catch (e) {\n    console.log('   âš ï¸ Could not access Fetch Provider Responses:', e.message);\n}\n\nif (requirements.length === 0 || responses.length === 0) {\n    console.log('   ðŸ”„ Using fallback: separating from input...');\n    items.forEach(item => {\n        const data = item.json;\n        if (data.requirement_text && !data.provider_name) {\n            requirements.push(data);\n        } else if (data.provider_name && data.requirement_id) {\n            responses.push(data);\n        }\n    });\n}\n\nif (requirements.length === 0) {\n    return [{ json: { error: 'No requirements found', items_received: items.length } }];\n}\nif (responses.length === 0) {\n    return [{ json: { error: 'No responses found', items_received: items.length } }];\n}\n\n/* =========================\nOptimization with MAPS\n========================= */\nconst requirementMap = {};\nrequirements.forEach(r => {\n    if (r.id) requirementMap[r.id] = r;\n});\n\nconst responsesByProvider = {};\nresponses.forEach(r => {\n    if (r.provider_name) {\n        if (!responsesByProvider[r.provider_name]) {\n            responsesByProvider[r.provider_name] = [];\n        }\n        responsesByProvider[r.provider_name].push(r);\n    }\n});\n\nconsole.log('   ðŸ“Š Providers found:', Object.keys(responsesByProvider).join(', '));\n\n/* =========================\nGet Economic Offers Data\n========================= */\nlet economicOffers = [];\ntry {\n    const econItems = $('Fetch Economic Offers').all();\n    economicOffers = econItems.map(item => item.json);\n    console.log('   âœ… Economic Offers:', economicOffers.length);\n} catch (e) {\n    console.log('   âš ï¸ Could not access Economic Offers:', e.message);\n}\n\nconst economicByProvider = {};\neconomicOffers.forEach(offer => {\n    if (offer.provider_name) {\n        economicByProvider[offer.provider_name] = offer;\n        economicByProvider[offer.provider_name.toUpperCase()] = offer;\n    }\n});\n\nconsole.log('   ðŸ’° Economic data for:', economicOffers.map(o => o.provider_name).join(', '));\n\n/* =========================\nHelper: Score economic criteria from economic_offers\n========================= */\nfunction getEconomicScore(criterionName, keywords, providerOffer, allOffers) {\n    if (!providerOffer) return null;\n    const name = (criterionName || '').toLowerCase();\n    const kws = (keywords || []).map(k => k.toLowerCase());\n    \n    // TCO / Total Price / Total Cost\n    if (name.includes('tco') || name.includes('total_cost') || name.includes('total_price') ||\n        kws.some(k => k.includes('tco') || k.includes('total cost') || k.includes('investment') || k.includes('coste total'))) {\n        const myPrice = providerOffer.tco_value || providerOffer.total_price;\n        if (!myPrice) return null;\n        const prices = allOffers.filter(o => (o.tco_value || o.total_price) > 0).map(o => o.tco_value || o.total_price);\n        if (prices.length <= 1) return 7;\n        const minP = Math.min(...prices);\n        const maxP = Math.max(...prices);\n        if (minP === maxP) return 7;\n        return Math.round((9 - ((myPrice - minP) / (maxP - minP)) * 5) * 100) / 100;\n    }\n    \n    // Price Breakdown / Transparency\n    if (name.includes('breakdown') || name.includes('transparency') || name.includes('desglose') || name.includes('capex') ||\n        kws.some(k => k.includes('breakdown') || k.includes('itemized') || k.includes('desglose') || k.includes('capex') || k.includes('opex'))) {\n        const bd = providerOffer.price_breakdown;\n        if (!bd || typeof bd !== 'object') return 2;\n        const entries = Object.keys(bd).length;\n        if (entries >= 5) return 9;\n        if (entries >= 3) return 7;\n        if (entries >= 1) return 5;\n        return 2;\n    }\n    \n    // Energy Efficiency / Savings / PUE\n    if (name.includes('energy') || name.includes('efficiency') || name.includes('savings') || name.includes('pue') ||\n        kws.some(k => k.includes('energy') || k.includes('pue') || k.includes('efficiency') || k.includes('roi'))) {\n        const tcoB = providerOffer.tco_breakdown;\n        if (tcoB && typeof tcoB === 'object') {\n            const eKeys = Object.keys(tcoB).filter(k =>\n                k.toLowerCase().includes('energy') || k.toLowerCase().includes('electric') ||\n                k.toLowerCase().includes('pue') || k.toLowerCase().includes('cooling'));\n            if (eKeys.length > 0) return 7;\n        }\n        const opts = providerOffer.optional_items || [];\n        const eOpts = opts.filter(o => {\n            const d = (o.description || '').toLowerCase();\n            return d.includes('energy') || d.includes('efficiency') || d.includes('pue') || d.includes('solar');\n        });\n        if (eOpts.length > 0) return 6;\n        if (providerOffer.total_price) return 3;\n        return null;\n    }\n    \n    // Payment Terms / Milestones\n    if (name.includes('payment') || name.includes('milestone') || name.includes('pago') || name.includes('plazo') ||\n        kws.some(k => k.includes('payment') || k.includes('milestone') || k.includes('pago') || k.includes('financing'))) {\n        const hasPT = providerOffer.payment_terms && providerOffer.payment_terms.trim().length > 0;\n        const hasPS = providerOffer.payment_schedule && providerOffer.payment_schedule.length > 0;\n        if (hasPT && hasPS) return 8;\n        if (hasPT || hasPS) return 5;\n        if (providerOffer.discount_percentage > 0) return 4;\n        return null;\n    }\n    \n    // Discount / Optionals\n    if (name.includes('optional') || name.includes('discount') || name.includes('descuento') ||\n        kws.some(k => k.includes('optional') || k.includes('discount') || k.includes('alternative'))) {\n        let s = 3;\n        if ((providerOffer.optional_items || []).length > 0) s += 2;\n        if ((providerOffer.alternative_offers || []).length > 0) s += 2;\n        if ((providerOffer.discount_percentage || 0) > 0) s += 2;\n        return Math.min(s, 9);\n    }\n    \n    // Schedule / Timeline\n    if (name.includes('schedule') || name.includes('timeline') || name.includes('cronograma') ||\n        kws.some(k => k.includes('schedule') || k.includes('timeline') || k.includes('gantt'))) {\n        if (providerOffer.validity_days > 0) return 5;\n        return null;\n    }\n    \n    return null;\n}\n\n/* =========================\nProvider filter (optional)\n========================= */\nlet providerFilter = '';\ntry {\n    providerFilter = $('Set Input Params1').first().json.provider_filter || '';\n} catch (e) {}\n\nlet providers = Object.keys(responsesByProvider);\nif (providerFilter) {\n    providers = providers.filter(p => p.toLowerCase().includes(providerFilter.toLowerCase()));\n}\n\nif (providers.length === 0) {\n    return [{ json: { error: 'No providers found', filter: providerFilter } }];\n}\n\n/* =========================\nEvaluation by Criteria\n========================= */\nconst evaluationData = providers.map(providerName => {\n    const providerResponses = responsesByProvider[providerName] || [];\n    \n    // Initialize criteria summary\n    const criteriaScores = {};\n    Object.keys(CRITERIA_WEIGHTS).forEach(criterion => {\n        criteriaScores[criterion] = { total: 0, included: 0, partial: 0, not_included: 0, no_info: 0, scores: [], comments: [] };\n    });\n    \n    providerResponses.forEach(resp => {\n        const req = requirementMap[resp.requirement_id];\n        if (!req) return;\n        \n        const criterion = getCriterionFromRequirement(req.evaluation_type, req.phase, req.requirement_text);\n        const evalClass = classifyEval(resp.evaluation_value);\n        \n        const cs = criteriaScores[criterion];\n        if (!cs) return;\n        \n        cs.total++;\n        if (evalClass === 'INCLUDED') cs.included++;\n        else if (evalClass === 'PARTIAL') cs.partial++;\n        else if (evalClass === 'NOT_INCLUDED') cs.not_included++;\n        else cs.no_info++; if (resp.comment && resp.comment.trim().length > 0) { cs.comments.push(resp.comment.trim().substring(0, 400)); }\n        \n        if (typeof resp.score === 'number' && resp.score > 0) {\n            cs.scores.push(resp.score);\n        }\n    });\n    \n    // Calculate average scores per criterion\n    let globalScore = 0;\n    const criteriaAvgScores = {};\n    \n    Object.keys(criteriaScores).forEach(criterion => {\n        const cs = criteriaScores[criterion];\n        if (cs.scores.length > 0) {\n            cs.avg_score = Math.round((cs.scores.reduce((a, b) => a + b, 0) / cs.scores.length) * 100) / 100;\n        } else if (cs.total > 0) {\n            // Calculate based on items with actual evaluations (exclude no_info from denominator)\n            const evaluated = cs.included + cs.partial + cs.not_included;\n            if (evaluated > 0) {\n                cs.avg_score = Math.round(((cs.included * 9 + cs.partial * 6 + cs.not_included * 2) / evaluated) * 100) / 100;\n            } else {\n                cs.avg_score = 0;\n            }\n        } else {\n            cs.avg_score = 0;\n        }\n        criteriaAvgScores[criterion] = cs.avg_score;\n        globalScore += cs.avg_score * (CRITERIA_WEIGHTS[criterion] || 0);\n        delete cs.scores;\n    });\n    \n    globalScore = Math.round(globalScore * 100) / 100;\n    \n    // === ECONOMIC ENRICHMENT: Use economic_offers data to improve scores ===\n    const providerEconOffer = economicByProvider[providerName] || economicByProvider[providerName.toUpperCase()];\n    if (providerEconOffer) {\n        console.log('   ðŸ’° Enriching scores for', providerName, 'with economic data');\n        let enrichedCount = 0;\n        globalScore = 0;\n        \n        Object.keys(criteriaAvgScores).forEach(crit => {\n            const critInfo = useDynamicConfig && dynamicConfig.criteria[crit] ? dynamicConfig.criteria[crit] : null;\n            const kws = critInfo ? critInfo.keywords : [];\n            const econScore = getEconomicScore(crit, kws, providerEconOffer, economicOffers);\n            \n            if (econScore !== null && (((c => c === 'total_price' || c.includes('tco') || c.includes('total_cost'))(crit.toLowerCase())) || econScore > criteriaAvgScores[crit])) {\n                console.log('     ðŸ’°', crit, ':', criteriaAvgScores[crit], 'â†’', econScore, '(economic data)');\n                criteriaAvgScores[crit] = econScore;\n                enrichedCount++;\n            }\n            \n            globalScore += criteriaAvgScores[crit] * (CRITERIA_WEIGHTS[crit] || 0);\n        });\n        \n        globalScore = Math.round(globalScore * 100) / 100;\n        console.log('   ðŸ’° Enriched', enrichedCount, 'criteria â†’ new global:', globalScore);\n    }\n    \n    // Calculate category scores dynamically\n    let categoryScores = {};\n    if (useDynamicConfig) {\n        for (const [catName, catInfo] of Object.entries(dynamicConfig.categories)) {\n            const catCriteria = catInfo.criteria || [];\n            const scores = catCriteria.map(c => criteriaAvgScores[c] || 0);\n            const avg = scores.length > 0 ? scores.reduce((a, b) => a + b, 0) / scores.length : 0;\n            categoryScores[catName.toUpperCase()] = Math.round(avg * 100) / 100;\n        }\n    } else {\n        categoryScores = {\n            TECHNICAL: Math.round(((criteriaAvgScores.scope_facilities || 0) + (criteriaAvgScores.scope_work || 0) + (criteriaAvgScores.deliverables_quality || 0)) / 3 * 100) / 100,\n            ECONOMIC: Math.round(((criteriaAvgScores.total_price || 0) + (criteriaAvgScores.price_breakdown || 0) + (criteriaAvgScores.optionals_included || 0) + (criteriaAvgScores.capex_opex_methodology || 0)) / 4 * 100) / 100,\n            EXECUTION: Math.round(((criteriaAvgScores.schedule || 0) + (criteriaAvgScores.resources_allocation || 0) + (criteriaAvgScores.exceptions || 0)) / 3 * 100) / 100,\n            HSE_COMPLIANCE: Math.round(((criteriaAvgScores.safety_studies || 0) + (criteriaAvgScores.regulatory_compliance || 0)) / 2 * 100) / 100\n        };\n    }\n    \n    return {\n        provider_name: providerName,\n        project_id: projectId,\n        total_responses: providerResponses.length,\n        global_score: globalScore,\n        category_scores: categoryScores,\n        criteria_scores: criteriaAvgScores,\n        criteria_summary: criteriaScores,\n        config_type: useDynamicConfig ? 'dynamic' : 'default',\n        scoring_config: useDynamicConfig ? dynamicConfig : null,\n        economic_data: economicByProvider[providerName] || economicByProvider[providerName.toUpperCase()] || null\n    };\n});\n\n/* =========================\nExecutive Ranking\n========================= */\nevaluationData\n    .sort((a, b) => b.global_score - a.global_score)\n    .forEach((item, index) => {\n        item.rank = index + 1;\n    });\n\nconsole.log('âœ… Scoring Data prepared for', evaluationData.length, 'providers');\nconsole.log('   Project ID included:', projectId);\nconsole.log('   Config type:', useDynamicConfig ? 'DYNAMIC' : 'DEFAULT');\n\n/* === Cross-provider relative normalization (non-price criteria) === */ const _nCrit = Object.keys(CRITERIA_WEIGHTS).filter(c => c !== 'total_price' && !c.includes('tco') && !c.includes('total_cost')); if (evaluationData.length > 1) { _nCrit.forEach(crit => { const _sc = evaluationData.map(d => d.criteria_scores[crit] || 0).filter(s => s > 0); if (_sc.length < 2) return; const _mn = Math.min(..._sc), _mx = Math.max(..._sc); if (_mx - _mn < 0.2) return; evaluationData.forEach(d => { const r = d.criteria_scores[crit]; if (r > 0) d.criteria_scores[crit] = Math.round((4 + ((r - _mn) / (_mx - _mn)) * 5) * 100) / 100; }); }); evaluationData.forEach(d => { d.global_score = Math.round(Object.entries(CRITERIA_WEIGHTS).reduce((s, [c, w]) => s + (d.criteria_scores[c] || 0) * w, 0) * 100) / 100; if (useDynamicConfig && dynamicConfig) { for (const [cat, info] of Object.entries(dynamicConfig.categories)) { const avg = (info.criteria || []).reduce((s, c) => s + (d.criteria_scores[c] || 0), 0) / Math.max(1, (info.criteria || []).length); d.category_scores[cat.toUpperCase()] = Math.round(avg * 100) / 100; } } else { d.category_scores.TECHNICAL = Math.round(((d.criteria_scores.scope_facilities || 0) + (d.criteria_scores.scope_work || 0) + (d.criteria_scores.deliverables_quality || 0)) / 3 * 100) / 100; d.category_scores.ECONOMIC = Math.round(((d.criteria_scores.total_price || 0) + (d.criteria_scores.price_breakdown || 0) + (d.criteria_scores.optionals_included || 0) + (d.criteria_scores.capex_opex_methodology || 0)) / 4 * 100) / 100; d.category_scores.EXECUTION = Math.round(((d.criteria_scores.schedule || 0) + (d.criteria_scores.resources_allocation || 0) + (d.criteria_scores.exceptions || 0)) / 3 * 100) / 100; d.category_scores.HSE_COMPLIANCE = Math.round(((d.criteria_scores.safety_studies || 0) + (d.criteria_scores.regulatory_compliance || 0)) / 2 * 100) / 100; } }); console.log('   âœ… Cross-provider normalization:', _nCrit.length, 'criteria'); } return evaluationData.map(data => ({ json: data }));"
            },
            "type": "n8n-nodes-base.code",
            "typeVersion": 2,
            "position": [
                -9056,
                5776
            ],
            "id": "45f08135-4ab9-4941-bbcd-32e7017dc691",
            "name": "Prepare Scoring Data"
        },
        {
            "parameters": {
                "options": {
                    "reset": false
                }
            },
            "type": "n8n-nodes-base.splitInBatches",
            "typeVersion": 3,
            "position": [
                -8832,
                5728
            ],
            "id": "e3025a5a-e310-43ea-a1e4-2a3e51ebd070",
            "name": "Loop Over Providers"
        },
        {
            "parameters": {
                "promptType": "define",
                "text": "=You are a procurement evaluation assistant. Score this provider's proposal.\n\nOUTPUT LANGUAGE: {{ $('Set Input Params1').first().json.language === 'en' ? 'ENGLISH - Write evaluation_summary, strengths and weaknesses in English.' : 'ESPAÃ‘OL - Escribe evaluation_summary, strengths y weaknesses en espaÃ±ol.' }}\n\nPROVIDER: {{ $json.provider_name }}\nTOTAL RESPONSES: {{ $json.total_responses }}\nPROJECT CONTEXT: {{ $('Fetch Project Context Scoring').first().json.ai_context || 'Procurement evaluation' }}\n\nCURRENCY: {{ $('Set Input Params1').first().json.currency || 'EUR' }} (use this currency when referencing monetary values)\n\nECONOMIC DATA (from economic_offers table):\n{{ $json.economic_data ? JSON.stringify($json.economic_data) : 'No economic data available' }}\n\nPRE-CALCULATED COMPLIANCE DATA:\nCategory scores: {{ JSON.stringify($json.category_scores) }}\nCriteria scores: {{ JSON.stringify($json.criteria_scores) }}\n\nCRITERIA DETAILS (included/partial/not_included/no_info counts):\n{{ JSON.stringify($json.criteria_summary) }}\n\nSCORING METHODOLOGY:\n- Scale: 0-10 per criterion\n- Use the pre-calculated scores as your STARTING POINT\n- Scoring is a MIX of compliance + quality. Both matter:\n  * Compliance (baseline): INCLUDED = provider covers the requirement, NOT_INCLUDED = critical gap\n  * Quality (your adjustment): HOW WELL they cover it â€” specificity, methodology, evidence, detail level\n- The pre-calculated scores reflect RELATIVE compliance across all providers (already normalized)\n- Adjust scores based on the 'comments' text in criteria_summary â€” that is the actual text from provider documents\n- NO fixed cap: if the evidence strongly justifies it, adjust Â±3 or more from the baseline\n- A provider that checks a box with vague text is NOT the same as one that provides detailed methodology\n\nRESPONSE QUALITY GUIDE (read the 'comments' in criteria_summary):\n- 9-10: Specific methodology, quantified results, proven track record, unique technical advantage\n- 7-8: Clear approach with some specifics, relevant experience, solid but not exceptional\n- 5-6: Generic/boilerplate response, technically present but no depth or evidence\n- 3-4: Vague or templated â€” even if marked INCLUDED, substance is minimal\n- 1-2: No meaningful content, or clear inability to meet the requirement\n\nCOMPLIANCE SIGNAL:\n- NOT_INCLUDED on key requirements: drop score significantly (2-3 range)\n- PARTIAL: score 4-6 depending on what is actually missing\n- INCLUDED with quality content: 7-10 depending on how well\n- INCLUDED with no substance: 4-6 maximum\n\nCRITICAL â€” DIFFERENTIATION IS MANDATORY:\n- You MUST score providers differently. If all providers receive 6-8 on every criterion, the evaluation has failed its purpose.\n- Read the comments carefully. Providers that write more specific, detailed, evidence-backed responses MUST score higher.\n- Use the full 0-10 scale. Typical spread between best and worst provider on a criterion: 2-5 points.\n- Do NOT give the same score to all providers on any criterion unless their responses are truly identical.\n\nRETURN ONLY valid JSON with this exact structure:\n{\n  \"provider_name\": \"{{ $json.provider_name }}\",\n  \"category_scores\": {\n    {{ $json.scoring_config ? Object.keys($json.scoring_config.categories).map(name => `\"${name.toUpperCase()}\": { \"score\": 7.0, \"weight\": ${$json.scoring_config.categories[name].weight / 100} }`).join(',\\n    ') : `\"TECHNICAL\": { \"score\": 7.0, \"weight\": 0.30 },\\n    \"ECONOMIC\": { \"score\": 7.0, \"weight\": 0.35 },\\n    \"EXECUTION\": { \"score\": 7.0, \"weight\": 0.20 },\\n    \"HSE_COMPLIANCE\": { \"score\": 7.0, \"weight\": 0.15 }` }}\n  },\n  \"individual_scores\": {\n    {{ Object.keys($json.criteria_scores).map(k => `\"${k}\": ${$json.criteria_scores[k] || 5.0}`).join(',\\n    ') }}\n  },\n  \"overall_score\": {{ $json.global_score || 5.0 }},\n  \"compliance_percentage\": 70,\n  \"evaluation_summary\": \"Brief 1-2 sentence evaluation in {{ $('Set Input Params1').first().json.language === 'en' ? 'English' : 'Spanish' }}\",\n  \"strengths\": [\"strength 1\", \"strength 2\"],\n  \"weaknesses\": [\"weakness 1\", \"weakness 2\"]\n}\n\nIMPORTANT: Replace the example numbers with your REAL scores based on compliance + quality analysis. Read provider comments in criteria_summary. Differentiate between providers â€” identical scores defeat the purpose. All number fields must be actual numbers (not strings). Write text fields in {{ $('Set Input Params1').first().json.language === 'en' ? 'English' : 'Spanish' }}.",
                "hasOutputParser": true,
                "batching": {}
            },
            "type": "@n8n/n8n-nodes-langchain.chainLlm",
            "typeVersion": 1.8,
            "position": [
                -8560,
                5744
            ],
            "id": "3c4d2014-f632-4ee8-b898-1e50cbab8af3",
            "name": "Scoring LLM Chain",
            "continueOnFail": true,
            "alwaysOutputData": true
        },
        {
            "parameters": {
                "jsCode": "// =============================================\n// NODO: Calculate Weighted Scores (v8 - Resilient to LLM failures)\n// FIX: Gets project_id from Set Input Params1 (not LLM output)\n// FIX: Falls back to pre-calculated scores when LLM returns zeros or errors\n// FIX: Handles LLM chain continueOnFail error items\n// =============================================\n\nconst input = $input.first().json;\n\n// Check if LLM chain failed (continueOnFail produces error items)\nconst isLlmError = input.error || input.errorMessage || !input.output;\nif (isLlmError) {\n    console.log('Calculate Weighted Scores v8 - LLM FAILED, using pre-calculated scores only');\n    console.log('  Error:', input.error || input.errorMessage || 'No output from LLM');\n}\n\nconst llmOutput = (!isLlmError && input.output) ? input.output : {};\n\nconsole.log('Calculate Weighted Scores v8 - Starting...');\nconsole.log('  LLM output keys:', Object.keys(llmOutput).join(', '));\n\n// === FIX 1: Get project_id from webhook params (NOT from LLM) ===\nlet projectId = null;\ntry {\n    projectId = $('Set Input Params1').first().json.project_id;\n} catch(e) {\n    console.log('  Could not get project_id:', e.message);\n}\n\n// === FIX 2: Get pre-calculated scores from Prepare Scoring Data ===\nlet configType = 'default';\nlet scoringConfig = null;\nlet preCalcCriteria = {};\nlet preCalcCategory = {};\nlet preCalcGlobal = 0;\ntry {\n    const allPrepared = $('Prepare Scoring Data').all();\n    const providerName = llmOutput.provider_name || '';\n    const match = allPrepared.find(item => item.json.provider_name === providerName);\n    if (match) {\n        configType = match.json.config_type || 'default';\n        scoringConfig = match.json.scoring_config || null;\n        preCalcCriteria = match.json.criteria_scores || {};\n        preCalcCategory = match.json.category_scores || {};\n        preCalcGlobal = match.json.global_score || 0;\n        console.log('  Pre-calculated scores found for', providerName);\n        console.log('  Pre-calc criteria:', JSON.stringify(preCalcCriteria));\n        console.log('  Pre-calc categories:', JSON.stringify(preCalcCategory));\n        console.log('  Pre-calc global:', preCalcGlobal);\n    } else {\n        console.log('  No pre-calculated match for:', providerName);\n    }\n} catch(e) {\n    console.log('  Could not get pre-calculated scores:', e.message);\n}\n\n// === Extract LLM category scores ===\nconst llmCatScores = llmOutput.category_scores || {};\nconst getScore = (cat) => {\n    const v = llmCatScores[cat];\n    if (!v) return 0;\n    return (typeof v === 'object' && v.score) ? v.score : (typeof v === 'number' ? v : 0);\n};\n\n// === FIX 3: Build individual scores with fallback to pre-calculated ===\nconst llmIndividual = llmOutput.individual_scores || {};\nconst is = {};\nconst allCriteriaKeys = new Set([\n    ...Object.keys(llmIndividual),\n    ...Object.keys(preCalcCriteria)\n]);\nfor (const key of allCriteriaKeys) {\n    const llmVal = llmIndividual[key];\n    const preVal = preCalcCriteria[key];\n    // Use LLM value only if it's a real positive number\n    const _isPrice = (key === 'total_price' || key.includes('tco') || key.includes('total_cost')); if (_isPrice && typeof preVal === 'number' && preVal > 0) { is[key] = preVal; } else if (typeof llmVal === 'number' && llmVal > 0 && typeof preVal === 'number' && preVal > 0) { is[key] = Math.round(Math.max(0, Math.min(10, Math.max(preVal - 3, Math.min(preVal + 3, llmVal)))) * 100) / 100; } else { is[key] = (typeof llmVal === 'number' && llmVal > 0) ? Math.round(Math.min(10, llmVal) * 100) / 100 : (preVal || 0); }\n}\nconsole.log('  Final individual_scores:', JSON.stringify(is));\n\n// === Build category scores with fallback ===\nconst categoryScoresClean = {};\nconst allCatKeys = new Set([\n    ...Object.keys(llmCatScores),\n    ...Object.keys(preCalcCategory)\n]);\nfor (const catKey of allCatKeys) {\n    const llmCatVal = llmCatScores[catKey];\n    const preCatVal = preCalcCategory[catKey];\n    const llmScore = (typeof llmCatVal === 'object' && llmCatVal?.score)\n        ? llmCatVal.score\n        : (typeof llmCatVal === 'number' ? llmCatVal : 0);\n    const _isEcon = (catKey === 'ECONOMIC' || catKey === 'economic'); if (_isEcon && typeof preCatVal === 'number' && preCatVal > 0) { categoryScoresClean[catKey] = preCatVal; } else if (llmScore > 0 && typeof preCatVal === 'number' && preCatVal > 0) { categoryScoresClean[catKey] = Math.round(Math.max(0, Math.min(10, Math.max(preCatVal - 3, Math.min(preCatVal + 3, llmScore)))) * 100) / 100; } else { categoryScoresClean[catKey] = llmScore > 0 ? Math.round(Math.min(10, llmScore) * 100) / 100 : (preCatVal || 0); }\n}\nconsole.log('  Final category_scores:', JSON.stringify(categoryScoresClean));\n\n// === Calculate overall score with fallback ===\nconst llmOverall = llmOutput.overall_score || 0;\nconst overallScore = (() => { const cw = (configType === 'dynamic' && scoringConfig && scoringConfig.categories) ? Object.fromEntries(Object.entries(scoringConfig.categories).map(([k,v]) => [k.toUpperCase(), v.weight/100])) : {'TECHNICAL':0.30,'ECONOMIC':0.35,'EXECUTION':0.20,'HSE_COMPLIANCE':0.15}; const r = Object.entries(cw).reduce((s,[k,w]) => s+(categoryScoresClean[k]||0)*w, 0); const rc = Object.values(cw).reduce((a,b)=>a+b,0); return rc > 0 ? Math.round(r/rc*100)/100 : (llmOverall > 0 ? llmOverall : preCalcGlobal); })();\n\n// === Calculate compliance percentage with fallback ===\nconst llmCompliance = llmOutput.compliance_percentage || 0;\nconst compliancePercentage = llmCompliance > 0 ? llmCompliance : Math.round(overallScore * 10);\n\n// Build ranking object\nconst ranking = {\n    provider_name: llmOutput.provider_name || input.provider_name || 'UNKNOWN',\n    project_id: projectId,\n    // Legacy fixed fields\n    technical_score: categoryScoresClean.TECHNICAL || categoryScoresClean.technical || 0,\n    economic_score: categoryScoresClean.ECONOMIC || categoryScoresClean.economic || 0,\n    execution_score: categoryScoresClean.EXECUTION || categoryScoresClean.execution || 0,\n    hse_compliance_score: categoryScoresClean.HSE_COMPLIANCE || categoryScoresClean.hse_compliance || 0,\n    scope_facilities_score: is.scope_facilities || 0,\n    scope_work_score: is.scope_work || 0,\n    deliverables_quality_score: is.deliverables_quality || 0,\n    total_price_score: is.total_price || 0,\n    price_breakdown_score: is.price_breakdown || 0,\n    optionals_included_score: is.optionals_included || 0,\n    capex_opex_methodology_score: is.capex_opex_methodology || 0,\n    schedule_score: is.schedule || 0,\n    resources_allocation_score: is.resources_allocation || 0,\n    exceptions_score: is.exceptions || 0,\n    safety_studies_score: is.safety_studies || 0,\n    regulatory_compliance_score: is.regulatory_compliance || 0,\n    // Dynamic JSONB fields\n    category_scores_json: categoryScoresClean,\n    individual_scores_json: is,\n    evaluation_details: {\n        strengths: llmOutput.strengths || [],\n        weaknesses: llmOutput.weaknesses || [],\n        recommendations: llmOutput.recommendations || [],\n        summary: llmOutput.evaluation_summary || ''\n    },\n    overall_score: overallScore,\n    compliance_percentage: compliancePercentage,\n    evaluation_count: 1,\n    last_updated: new Date().toISOString()\n};\n\nconsole.log('  FINAL ranking for', ranking.provider_name, ':', ranking.overall_score);\n\nreturn [{\n    json: {\n        ranking,\n        details: ranking.evaluation_details,\n        category_scores: categoryScoresClean,\n        individual_scores: is,\n        config_type: configType,\n        scoring_config: scoringConfig\n    }\n}];"
            },
            "type": "n8n-nodes-base.code",
            "typeVersion": 2,
            "position": [
                -8176,
                5744
            ],
            "id": "c4726a6c-e79c-4877-a992-b3d3d4c98830",
            "name": "Calculate Weighted Scores"
        },
        {
            "parameters": {
                "useCustomSchema": true,
                "schema": "public",
                "operation": "getAll",
                "tableId": "ranking_proveedores",
                "limit": 1,
                "filters": {
                    "conditions": [
                        {
                            "keyName": "provider_name",
                            "condition": "eq",
                            "keyValue": "={{ $('Calculate Weighted Scores').first().json.ranking.provider_name }}"
                        },
                        {
                            "keyName": "project_id",
                            "condition": "eq",
                            "keyValue": "={{ $('Set Input Params1').first().json.project_id }}"
                        }
                    ]
                }
            },
            "type": "n8n-nodes-base.supabase",
            "typeVersion": 1,
            "position": [
                -7936,
                5744
            ],
            "id": "925ba79f-6ed7-44a0-af36-17ed3197503b",
            "name": "Check Provider Exists",
            "alwaysOutputData": true,
            "credentials": {
                "supabaseApi": {
                    "id": "pI4CpdYLTiEEBmnz",
                    "name": "Supabase account"
                }
            }
        },
        {
            "parameters": {
                "conditions": {
                    "options": {
                        "caseSensitive": true,
                        "leftValue": "",
                        "typeValidation": "strict",
                        "version": 2
                    },
                    "conditions": [
                        {
                            "id": "provider-exists-condition",
                            "leftValue": "={{ $input.all().length }}",
                            "rightValue": 0,
                            "operator": {
                                "type": "number",
                                "operation": "gt"
                            }
                        }
                    ],
                    "combinator": "and"
                },
                "options": {}
            },
            "type": "n8n-nodes-base.if",
            "typeVersion": 2.2,
            "position": [
                -7696,
                5744
            ],
            "id": "108672ef-e653-4198-a0fb-2c7b66515059",
            "name": "Provider Exists?",
            "disabled": true
        },
        {
            "parameters": {
                "operation": "update",
                "tableId": "ranking_proveedores",
                "matchType": "allFilters",
                "filters": {
                    "conditions": [
                        {
                            "keyName": "provider_name",
                            "condition": "eq",
                            "keyValue": "={{ $('Calculate Weighted Scores').first().json.ranking.provider_name }}"
                        },
                        {
                            "keyName": "project_id",
                            "condition": "eq",
                            "keyValue": "={{ $('Set Input Params1').first().json.project_id }}"
                        }
                    ]
                },
                "fieldsUi": {
                    "fieldValues": [
                        {
                            "fieldId": "project_id",
                            "fieldValue": "={{ $('Set Input Params1').first().json.project_id }}"
                        },
                        {
                            "fieldId": "technical_score",
                            "fieldValue": "={{ $('Calculate Weighted Scores').first().json.ranking.technical_score || 0 }}"
                        },
                        {
                            "fieldId": "economic_score",
                            "fieldValue": "={{ $('Calculate Weighted Scores').first().json.ranking.economic_score || 0 }}"
                        },
                        {
                            "fieldId": "execution_score",
                            "fieldValue": "={{ $('Calculate Weighted Scores').first().json.ranking.execution_score || 0 }}"
                        },
                        {
                            "fieldId": "hse_compliance_score",
                            "fieldValue": "={{ $('Calculate Weighted Scores').first().json.ranking.hse_compliance_score || 0 }}"
                        },
                        {
                            "fieldId": "scope_facilities_score",
                            "fieldValue": "={{ $('Calculate Weighted Scores').first().json.ranking.scope_facilities_score || 0 }}"
                        },
                        {
                            "fieldId": "scope_work_score",
                            "fieldValue": "={{ $('Calculate Weighted Scores').first().json.ranking.scope_work_score || 0 }}"
                        },
                        {
                            "fieldId": "deliverables_quality_score",
                            "fieldValue": "={{ $('Calculate Weighted Scores').first().json.ranking.deliverables_quality_score || 0 }}"
                        },
                        {
                            "fieldId": "total_price_score",
                            "fieldValue": "={{ $('Calculate Weighted Scores').first().json.ranking.total_price_score || 0 }}"
                        },
                        {
                            "fieldId": "price_breakdown_score",
                            "fieldValue": "={{ $('Calculate Weighted Scores').first().json.ranking.price_breakdown_score || 0 }}"
                        },
                        {
                            "fieldId": "optionals_included_score",
                            "fieldValue": "={{ $('Calculate Weighted Scores').first().json.ranking.optionals_included_score || 0 }}"
                        },
                        {
                            "fieldId": "capex_opex_methodology_score",
                            "fieldValue": "={{ $('Calculate Weighted Scores').first().json.ranking.capex_opex_methodology_score || 0 }}"
                        },
                        {
                            "fieldId": "schedule_score",
                            "fieldValue": "={{ $('Calculate Weighted Scores').first().json.ranking.schedule_score || 0 }}"
                        },
                        {
                            "fieldId": "resources_allocation_score",
                            "fieldValue": "={{ $('Calculate Weighted Scores').first().json.ranking.resources_allocation_score || 0 }}"
                        },
                        {
                            "fieldId": "exceptions_score",
                            "fieldValue": "={{ $('Calculate Weighted Scores').first().json.ranking.exceptions_score || 0 }}"
                        },
                        {
                            "fieldId": "safety_studies_score",
                            "fieldValue": "={{ $('Calculate Weighted Scores').first().json.ranking.safety_studies_score || 0 }}"
                        },
                        {
                            "fieldId": "regulatory_compliance_score",
                            "fieldValue": "={{ $('Calculate Weighted Scores').first().json.ranking.regulatory_compliance_score || 0 }}"
                        },
                        {
                            "fieldId": "overall_score",
                            "fieldValue": "={{ $('Calculate Weighted Scores').first().json.ranking.overall_score || 0 }}"
                        },
                        {
                            "fieldId": "compliance_percentage",
                            "fieldValue": "={{ $('Calculate Weighted Scores').first().json.ranking.compliance_percentage || 0 }}"
                        },
                        {
                            "fieldId": "evaluation_count",
                            "fieldValue": "={{ $('Calculate Weighted Scores').first().json.ranking.evaluation_count || 0 }}"
                        },
                        {
                            "fieldId": "last_updated",
                            "fieldValue": "={{ $('Calculate Weighted Scores').first().json.ranking.last_updated }}"
                        }
                    ]
                }
            },
            "type": "n8n-nodes-base.supabase",
            "typeVersion": 1,
            "position": [
                -7456,
                5648
            ],
            "id": "8cab51ab-83de-416e-b217-07fd3a7019e9",
            "name": "Update Ranking",
            "alwaysOutputData": false,
            "credentials": {
                "supabaseApi": {
                    "id": "pI4CpdYLTiEEBmnz",
                    "name": "Supabase account"
                }
            },
            "disabled": true,
            "continueOnFail": true
        },
        {
            "parameters": {
                "useCustomSchema": true,
                "schema": "public",
                "tableId": "ranking_proveedores",
                "fieldsUi": {
                    "fieldValues": [
                        {
                            "fieldId": "provider_name",
                            "fieldValue": "={{ $('Calculate Weighted Scores').first().json.ranking.provider_name }}"
                        },
                        {
                            "fieldId": "project_id",
                            "fieldValue": "={{ $('Set Input Params1').first().json.project_id }}"
                        },
                        {
                            "fieldId": "technical_score",
                            "fieldValue": "={{ $('Calculate Weighted Scores').first().json.ranking.technical_score || 0 }}"
                        },
                        {
                            "fieldId": "economic_score",
                            "fieldValue": "={{ $('Calculate Weighted Scores').first().json.ranking.economic_score || 0 }}"
                        },
                        {
                            "fieldId": "execution_score",
                            "fieldValue": "={{ $('Calculate Weighted Scores').first().json.ranking.execution_score || 0 }}"
                        },
                        {
                            "fieldId": "hse_compliance_score",
                            "fieldValue": "={{ $('Calculate Weighted Scores').first().json.ranking.hse_compliance_score || 0 }}"
                        },
                        {
                            "fieldId": "scope_facilities_score",
                            "fieldValue": "={{ $('Calculate Weighted Scores').first().json.ranking.scope_facilities_score || 0 }}"
                        },
                        {
                            "fieldId": "scope_work_score",
                            "fieldValue": "={{ $('Calculate Weighted Scores').first().json.ranking.scope_work_score || 0 }}"
                        },
                        {
                            "fieldId": "deliverables_quality_score",
                            "fieldValue": "={{ $('Calculate Weighted Scores').first().json.ranking.deliverables_quality_score || 0 }}"
                        },
                        {
                            "fieldId": "total_price_score",
                            "fieldValue": "={{ $('Calculate Weighted Scores').first().json.ranking.total_price_score || 0 }}"
                        },
                        {
                            "fieldId": "price_breakdown_score",
                            "fieldValue": "={{ $('Calculate Weighted Scores').first().json.ranking.price_breakdown_score || 0 }}"
                        },
                        {
                            "fieldId": "optionals_included_score",
                            "fieldValue": "={{ $('Calculate Weighted Scores').first().json.ranking.optionals_included_score || 0 }}"
                        },
                        {
                            "fieldId": "capex_opex_methodology_score",
                            "fieldValue": "={{ $('Calculate Weighted Scores').first().json.ranking.capex_opex_methodology_score || 0 }}"
                        },
                        {
                            "fieldId": "schedule_score",
                            "fieldValue": "={{ $('Calculate Weighted Scores').first().json.ranking.schedule_score || 0 }}"
                        },
                        {
                            "fieldId": "resources_allocation_score",
                            "fieldValue": "={{ $('Calculate Weighted Scores').first().json.ranking.resources_allocation_score || 0 }}"
                        },
                        {
                            "fieldId": "exceptions_score",
                            "fieldValue": "={{ $('Calculate Weighted Scores').first().json.ranking.exceptions_score || 0 }}"
                        },
                        {
                            "fieldId": "safety_studies_score",
                            "fieldValue": "={{ $('Calculate Weighted Scores').first().json.ranking.safety_studies_score || 0 }}"
                        },
                        {
                            "fieldId": "regulatory_compliance_score",
                            "fieldValue": "={{ $('Calculate Weighted Scores').first().json.ranking.regulatory_compliance_score || 0 }}"
                        },
                        {
                            "fieldId": "overall_score",
                            "fieldValue": "={{ $('Calculate Weighted Scores').first().json.ranking.overall_score || 0 }}"
                        },
                        {
                            "fieldId": "compliance_percentage",
                            "fieldValue": "={{ $('Calculate Weighted Scores').first().json.ranking.compliance_percentage || 0 }}"
                        },
                        {
                            "fieldId": "evaluation_count",
                            "fieldValue": "={{ $('Calculate Weighted Scores').first().json.ranking.evaluation_count || 0 }}"
                        },
                        {
                            "fieldId": "last_updated",
                            "fieldValue": "={{ $('Calculate Weighted Scores').first().json.ranking.last_updated }}"
                        },
                        {
                            "fieldId": "category_scores_json",
                            "fieldValue": "={{ $('Calculate Weighted Scores').first().json.ranking.category_scores_json }}"
                        },
                        {
                            "fieldId": "individual_scores_json",
                            "fieldValue": "={{ $('Calculate Weighted Scores').first().json.ranking.individual_scores_json }}"
                        },
                        {
                            "fieldId": "evaluation_details",
                            "fieldValue": "={{ $('Calculate Weighted Scores').first().json.ranking.evaluation_details }}"
                        }
                    ]
                }
            },
            "type": "n8n-nodes-base.supabase",
            "typeVersion": 1,
            "position": [
                -7456,
                5872
            ],
            "id": "3a352917-d237-41b2-978c-d6b120f3e2e2",
            "name": "Insert Ranking",
            "alwaysOutputData": false,
            "credentials": {
                "supabaseApi": {
                    "id": "pI4CpdYLTiEEBmnz",
                    "name": "Supabase account"
                }
            },
            "continueOnFail": true
        },
        {
            "parameters": {
                "aggregate": "aggregateAllItemData",
                "destinationFieldName": "all_rankings",
                "options": {}
            },
            "type": "n8n-nodes-base.aggregate",
            "typeVersion": 1,
            "position": [
                -8560,
                5568
            ],
            "id": "3f30baa8-1195-4040-894d-87885684de6d",
            "name": "Aggregate All Rankings"
        },
        {
            "parameters": {
                "jsCode": "// =============================================\n// NODE: Generate Final Ranking with Details (v6 - Fully Dynamic Criteria)\n// Passes individual_scores and category scores as dynamic objects\n// =============================================\n\nconst items = $input.all();\nlet allRankings = [];\n\nitems.forEach(item => {\n    if (item.json.all_rankings) {\n        allRankings = allRankings.concat(item.json.all_rankings);\n    } else if (item.json.ranking) {\n        allRankings.push(item.json);\n    }\n});\n\nconst sortedRankings = allRankings\n    .map(r => ({\n        ranking: r.ranking || r,\n        details: r.details || {},\n        category_scores: r.category_scores || {},\n        individual_scores: r.individual_scores || {},\n        config_type: r.config_type || 'default'\n    }))\n    .sort((a, b) => (b.ranking.overall_score || 0) - (a.ranking.overall_score || 0));\n\nconst finalRanking = sortedRankings.map((r, idx) => {\n    // Build dynamic category scores object\n    const categoryScores = r.ranking.category_scores_json || {};\n    // Also populate legacy fields for backward compatibility\n    const scores = {\n        technical: categoryScores.TECHNICAL || categoryScores.technical || r.ranking.technical_score || 0,\n        economic: categoryScores.ECONOMIC || categoryScores.economic || r.ranking.economic_score || 0,\n        execution: categoryScores.EXECUTION || categoryScores.execution || r.ranking.execution_score || 0,\n        hse_compliance: categoryScores.HSE_COMPLIANCE || categoryScores.hse_compliance || r.ranking.hse_compliance_score || 0\n    };\n    // Add any dynamic categories that aren't in the legacy set\n    for (const [catKey, catScore] of Object.entries(categoryScores)) {\n        const normalizedKey = catKey.toLowerCase();\n        if (!scores[normalizedKey]) {\n            scores[normalizedKey] = catScore;\n        }\n    }\n\n    // Build dynamic individual_scores from JSONB or fallback to legacy fields\n    const dynamicIndividual = r.ranking.individual_scores_json || r.individual_scores || {};\n    // Merge with legacy fixed fields as fallback\n    const individualScores = { ...dynamicIndividual };\n    const legacyFields = [\n        'scope_facilities', 'scope_work', 'deliverables_quality',\n        'total_price', 'price_breakdown', 'optionals_included', 'capex_opex_methodology',\n        'schedule', 'resources_allocation', 'exceptions',\n        'safety_studies', 'regulatory_compliance'\n    ];\n    legacyFields.forEach(f => {\n        if (!(f in individualScores) || !individualScores[f]) {\n            individualScores[f] = r.ranking[f + '_score'] || r.individual_scores?.[f] || 0;\n        }\n    });\n\n    return {\n        position: idx + 1,\n        provider_name: r.ranking.provider_name,\n        overall_score: r.ranking.overall_score,\n        compliance_percentage: r.ranking.compliance_percentage,\n        scores,\n        individual_scores: individualScores,\n        evaluation: {\n            strengths: r.details.strengths || [],\n            weaknesses: r.details.weaknesses || [],\n            recommendations: r.details.recommendations || [],\n            summary: r.details.summary || ''\n        }\n    };\n});\n\nconst configType = sortedRankings[0]?.config_type || 'default';\n\nconst stats = {\n    total_providers: finalRanking.length,\n    average_score: finalRanking.reduce((sum, r) => sum + (r.overall_score || 0), 0) / (finalRanking.length || 1),\n    top_performer: finalRanking[0]?.provider_name || 'N/A',\n    score_range: {\n        min: Math.min(...finalRanking.map(r => r.overall_score || 0)),\n        max: Math.max(...finalRanking.map(r => r.overall_score || 0))\n    },\n    evaluation_date: new Date().toISOString(),\n    config_type: configType\n};\n\nconsole.log(`Final Ranking Generated (${configType} config):`);\nfinalRanking.forEach(r => {\n    console.log(`   ${r.position}. ${r.provider_name}: ${r.overall_score} (${r.compliance_percentage}%)`);\n});\n\nreturn {\n    json: {\n        success: true,\n        ranking: finalRanking,\n        statistics: stats,\n        message: `Scoring completed for ${finalRanking.length} providers using ${configType} criteria configuration`\n    }\n};"
            },
            "type": "n8n-nodes-base.code",
            "typeVersion": 2,
            "position": [
                -8272,
                5568
            ],
            "id": "0f08c4da-219f-4f5a-80b2-2640f88d4578",
            "name": "Generate Final Ranking"
        },
        {
            "parameters": {
                "respondWith": "json",
                "responseBody": "={{ $json }}",
                "options": {
                    "responseHeaders": {
                        "entries": [
                            {
                                "name": "Content-Type",
                                "value": "application/json"
                            }
                        ]
                    }
                }
            },
            "type": "n8n-nodes-base.respondToWebhook",
            "typeVersion": 1.5,
            "position": [
                -8048,
                5568
            ],
            "id": "4c3bb523-9388-4929-9d5f-282483f4fd27",
            "name": "Respond with Ranking"
        },
        {
            "parameters": {
                "content": "## Scoring Workflow - Provider Evaluation (v5)\n## Dynamic Criteria Support\n\nThis workflow now supports:\n1. **Default criteria** - 11 hardcoded criteria for engineering proposals\n2. **Dynamic criteria** - Custom criteria loaded from `scoring_configuration_summary` view\n\n### How it works:\n1. Fetches scoring configuration for the project\n2. If configuration exists, uses dynamic criteria and weights\n3. If no configuration, falls back to default criteria\n\n### Default Category Weights:\n- **TECHNICAL COMPLETENESS (30%)**\n- **ECONOMIC COMPETITIVENESS (35%)**\n- **EXECUTION CAPABILITY (20%)**\n- **HSE & COMPLIANCE (15%)**\n\n### Endpoint:\nPOST /webhook/scoring-evaluation\n```json\n{\n  \"project_id\": \"uuid\",\n  \"provider_name\": \"filter\",\n  \"recalculate_all\": false\n}\n```\n\n### Response includes:\n- `config_type`: 'dynamic' or 'default'\n- `ranking`: Sorted provider scores\n- `statistics`: Summary stats",
                "height": 1264,
                "width": 3280
            },
            "type": "n8n-nodes-base.stickyNote",
            "typeVersion": 1,
            "position": [
                -10512,
                5168
            ],
            "id": "0e69cfda-0a54-4fb8-aa49-745cbce209be",
            "name": "Workflow Info"
        },
        {
            "parameters": {
                "content": "## AI Scoring (v5)\n\nEvaluates engineering proposals using:\n- Dynamic OR default criteria\n- Custom weights from database\n- Value-for-money comparison\n- Strengths and weaknesses\n\nStructured JSON output",
                "height": 220,
                "width": 320,
                "color": 6
            },
            "type": "n8n-nodes-base.stickyNote",
            "typeVersion": 1,
            "position": [
                -8656,
                5328
            ],
            "id": "ef3b717d-4084-417a-b921-0598de90f08c",
            "name": "LLM Scoring Info"
        },
        {
            "parameters": {
                "assignments": {
                    "assignments": [
                        {
                            "id": "project_id",
                            "name": "project_id",
                            "value": "={{ $('Webhook Scoring').first().json.body.project_id }}",
                            "type": "string"
                        },
                        {
                            "id": "provider_filter",
                            "name": "provider_filter",
                            "value": "={{ $('Webhook Scoring').first().json.body.provider_name || '' }}",
                            "type": "string"
                        },
                        {
                            "id": "recalculate_all",
                            "name": "recalculate_all",
                            "value": "={{ $('Webhook Scoring').first().json.body.recalculate_all || false }}",
                            "type": "boolean"
                        },
                        {
                            "id": "language-field-scoring",
                            "name": "language",
                            "value": "={{ $('Webhook Scoring').first().json.body.language || 'es' }}",
                            "type": "string"
                        },
                        {
                            "id": "currency-field-scoring",
                            "name": "currency",
                            "value": "={{ $('Webhook Scoring').first().json.body.currency || 'EUR' }}",
                            "type": "string"
                        }
                    ]
                },
                "options": {}
            },
            "type": "n8n-nodes-base.set",
            "typeVersion": 3.4,
            "position": [
                -9728,
                5776
            ],
            "id": "23fedfcc-a1a5-4ab5-a53d-0a7d563ffa77",
            "name": "Set Input Params1"
        },
        {
            "parameters": {
                "schemaType": "manual",
                "inputSchema": "{\n  \"type\": \"object\",\n  \"properties\": {\n    \"provider_name\": { \"type\": \"string\" },\n    \"category_scores\": {\n      \"type\": \"object\",\n      \"additionalProperties\": {\n        \"type\": \"object\",\n        \"properties\": {\n          \"score\": { \"type\": \"number\" },\n          \"weight\": { \"type\": \"number\" }\n        }\n      }\n    },\n    \"individual_scores\": {\n      \"type\": \"object\",\n      \"additionalProperties\": { \"type\": \"number\" }\n    },\n    \"overall_score\": { \"type\": \"number\" },\n    \"compliance_percentage\": { \"type\": \"number\" },\n    \"evaluation_summary\": { \"type\": \"string\" },\n    \"strengths\": { \"type\": \"array\", \"items\": { \"type\": \"string\" } },\n    \"weaknesses\": { \"type\": \"array\", \"items\": { \"type\": \"string\" } },\n    \"recommendations\": { \"type\": \"array\", \"items\": { \"type\": \"string\" } }\n  },\n  \"required\": [\"provider_name\", \"category_scores\", \"individual_scores\", \"overall_score\", \"compliance_percentage\"]\n}"
            },
            "type": "@n8n/n8n-nodes-langchain.outputParserStructured",
            "typeVersion": 1.3,
            "position": [
                -8416,
                5984
            ],
            "id": "33198f80-00ee-4106-bbe2-47c5a816cea8",
            "name": "JSON Output Parser1"
        },
        {
            "parameters": {
                "model": "qwen3:8b",
                "options": {
                    "temperature": 0.1,
                    "numCtx": 8192,
                    "numPredict": 2048
                }
            },
            "type": "@n8n/n8n-nodes-langchain.lmChatOllama",
            "typeVersion": 1,
            "position": [
                -8672,
                5968
            ],
            "id": "9ce78129-c263-4438-8827-04546c3a8403",
            "name": "Ollama Scoring Model",
            "credentials": {
                "ollamaApi": {
                    "id": "oS2Qqti9oVfsm8XZ",
                    "name": "Ollama account"
                }
            }
        },
        {
            "parameters": {
                "useCustomSchema": true,
                "schema": "public",
                "operation": "delete",
                "tableId": "ranking_proveedores",
                "filters": {
                    "conditions": [
                        {
                            "keyName": "project_id",
                            "condition": "eq",
                            "keyValue": "={{ $('Webhook Scoring').first().json.body.project_id }}"
                        }
                    ]
                }
            },
            "type": "n8n-nodes-base.supabase",
            "typeVersion": 1,
            "position": [
                -9952,
                5776
            ],
            "id": "4d329d02-4800-46a3-bbfa-64c7906606af",
            "name": "Delete a row",
            "alwaysOutputData": true,
            "credentials": {
                "supabaseApi": {
                    "id": "pI4CpdYLTiEEBmnz",
                    "name": "Supabase account"
                }
            }
        },
        {
            "parameters": {
                "options": {}
            },
            "type": "@n8n/n8n-nodes-langchain.lmChatOpenRouter",
            "typeVersion": 1,
            "position": [
                -8576,
                6064
            ],
            "id": "7ce4aad9-0f6e-46c0-a739-d4300c8e9040",
            "name": "OpenRouter Chat Model1",
            "credentials": {
                "openRouterApi": {
                    "id": "4AyUqsh1Z35g6bci",
                    "name": "OpenRouter account"
                }
            }
        },
        {
            "parameters": {
                "httpMethod": "POST",
                "path": "scoring-evaluation",
                "responseMode": "responseNode",
                "options": {}
            },
            "type": "n8n-nodes-base.webhook",
            "typeVersion": 2.1,
            "position": [
                -10256,
                5776
            ],
            "id": "c7f134c8-9043-4147-966c-72b79c53d714",
            "name": "Webhook Scoring",
            "webhookId": "scoring-eval-webhook-001"
        },
        {
            "parameters": {
                "useCustomSchema": true,
                "schema": "public",
                "operation": "get",
                "tableId": "projects",
                "filters": {
                    "conditions": [
                        {
                            "keyName": "id",
                            "keyValue": "={{ $('Set Input Params1').first().json.project_id }}"
                        }
                    ]
                }
            },
            "id": "4a25bcdf-f36a-4d60-8535-23db5746800f",
            "name": "Fetch Project Context Scoring",
            "type": "n8n-nodes-base.supabase",
            "typeVersion": 1,
            "position": [
                -9472,
                5776
            ],
            "credentials": {
                "supabaseApi": {
                    "id": "pI4CpdYLTiEEBmnz",
                    "name": "Supabase account"
                }
            }
        }
    ],
    "connections": {
        "Fetch Requirements": {
            "main": [
                [
                    {
                        "node": "Merge Requirements & Responses",
                        "type": "main",
                        "index": 0
                    }
                ]
            ]
        },
        "Fetch Provider Responses": {
            "main": [
                [
                    {
                        "node": "Merge Requirements & Responses",
                        "type": "main",
                        "index": 1
                    }
                ]
            ]
        },
        "Fetch Scoring Configuration": {
            "main": [
                [
                    {
                        "node": "Merge Requirements & Responses",
                        "type": "main",
                        "index": 2
                    }
                ]
            ]
        },
        "Fetch Economic Offers": {
            "main": [
                [
                    {
                        "node": "Merge Requirements & Responses",
                        "type": "main",
                        "index": 3
                    }
                ]
            ]
        },
        "Merge Requirements & Responses": {
            "main": [
                [
                    {
                        "node": "Prepare Scoring Data",
                        "type": "main",
                        "index": 0
                    }
                ]
            ]
        },
        "Prepare Scoring Data": {
            "main": [
                [
                    {
                        "node": "Loop Over Providers",
                        "type": "main",
                        "index": 0
                    }
                ]
            ]
        },
        "Loop Over Providers": {
            "main": [
                [
                    {
                        "node": "Aggregate All Rankings",
                        "type": "main",
                        "index": 0
                    }
                ],
                [
                    {
                        "node": "Scoring LLM Chain",
                        "type": "main",
                        "index": 0
                    }
                ]
            ]
        },
        "Scoring LLM Chain": {
            "main": [
                [
                    {
                        "node": "Calculate Weighted Scores",
                        "type": "main",
                        "index": 0
                    }
                ]
            ]
        },
        "Calculate Weighted Scores": {
            "main": [
                [
                    {
                        "node": "Check Provider Exists",
                        "type": "main",
                        "index": 0
                    }
                ]
            ]
        },
        "Check Provider Exists": {
            "main": [
                [
                    {
                        "node": "Insert Ranking",
                        "type": "main",
                        "index": 0
                    }
                ]
            ]
        },
        "Provider Exists?": {
            "main": [
                [
                    {
                        "node": "Update Ranking",
                        "type": "main",
                        "index": 0
                    }
                ],
                [
                    {
                        "node": "Insert Ranking",
                        "type": "main",
                        "index": 0
                    }
                ]
            ]
        },
        "Update Ranking": {
            "main": [
                [
                    {
                        "node": "Loop Over Providers",
                        "type": "main",
                        "index": 0
                    }
                ]
            ]
        },
        "Insert Ranking": {
            "main": [
                [
                    {
                        "node": "Loop Over Providers",
                        "type": "main",
                        "index": 0
                    }
                ]
            ]
        },
        "Aggregate All Rankings": {
            "main": [
                [
                    {
                        "node": "Generate Final Ranking",
                        "type": "main",
                        "index": 0
                    }
                ]
            ]
        },
        "Generate Final Ranking": {
            "main": [
                [
                    {
                        "node": "Respond with Ranking",
                        "type": "main",
                        "index": 0
                    }
                ]
            ]
        },
        "Set Input Params1": {
            "main": [
                [
                    {
                        "node": "Fetch Project Context Scoring",
                        "type": "main",
                        "index": 0
                    }
                ]
            ]
        },
        "JSON Output Parser1": {
            "ai_outputParser": [
                [
                    {
                        "node": "Scoring LLM Chain",
                        "type": "ai_outputParser",
                        "index": 0
                    }
                ]
            ]
        },
        "Delete a row": {
            "main": [
                [
                    {
                        "node": "Set Input Params1",
                        "type": "main",
                        "index": 0
                    }
                ]
            ]
        },
        "OpenRouter Chat Model1": {
            "ai_languageModel": [
                [
                    {
                        "node": "Scoring LLM Chain",
                        "type": "ai_languageModel",
                        "index": 0
                    }
                ]
            ]
        },
        "Webhook Scoring": {
            "main": [
                [
                    {
                        "node": "Delete a row",
                        "type": "main",
                        "index": 0
                    }
                ]
            ]
        },
        "Fetch Project Context Scoring": {
            "main": [
                [
                    {
                        "node": "Fetch Requirements",
                        "type": "main",
                        "index": 0
                    },
                    {
                        "node": "Fetch Provider Responses",
                        "type": "main",
                        "index": 0
                    },
                    {
                        "node": "Fetch Scoring Configuration",
                        "type": "main",
                        "index": 0
                    },
                    {
                        "node": "Fetch Economic Offers",
                        "type": "main",
                        "index": 0
                    }
                ]
            ]
        }
    },
    "pinData": {},
    "meta": {
        "templateCredsSetupCompleted": true,
        "instanceId": "53140335eaf11280ef77ef2f5a378f48c2b28e822e3e0d96563cdd92175c0eff"
    }
}