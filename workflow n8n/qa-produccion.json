{
    "nodes": [
        {
            "parameters": {
                "httpMethod": "POST",
                "path": "qa-audit-generator",
                "responseMode": "responseNode",
                "options": {}
            },
            "type": "n8n-nodes-base.webhook",
            "typeVersion": 2.1,
            "position": [
                -10448,
                3344
            ],
            "id": "012de05a-d137-4c90-b797-448f396a6bf4",
            "name": "Webhook Inbound",
            "webhookId": "0496e481-bb76-42f1-b3d5-734935b4b631"
        },
        {
            "parameters": {
                "assignments": {
                    "assignments": [
                        {
                            "id": "project_id",
                            "name": "project_id",
                            "value": "={{ $json.body.project_id }}",
                            "type": "string"
                        },
                        {
                            "id": "provider",
                            "name": "provider",
                            "value": "={{ $json.body.provider }}",
                            "type": "string"
                        },
                        {
                            "id": "language-field-qa",
                            "name": "language",
                            "value": "={{ $json.body.language || 'es' }}",
                            "type": "string"
                        },
                        {
                            "id": "currency-field-qa",
                            "name": "currency",
                            "value": "={{ $json.body.currency || 'EUR' }}",
                            "type": "string"
                        },
                        {
                            "id": "project-type-field-qa",
                            "name": "project_type",
                            "value": "={{ $json.body.project_type || 'RFP' }}",
                            "type": "string"
                        }
                    ]
                },
                "options": {}
            },
            "type": "n8n-nodes-base.set",
            "typeVersion": 3.4,
            "position": [
                -10224,
                3344
            ],
            "id": "0bc3cb6a-7af2-41c8-8dea-67e0bec8e368",
            "name": "Set Input Params"
        },
        {
            "parameters": {
                "useCustomSchema": true,
                "operation": "getAll",
                "tableId": "provider_responses",
                "returnAll": true,
                "matchType": "allFilters",
                "filters": {
                    "conditions": [
                        {
                            "keyName": "provider_name",
                            "condition": "eq",
                            "keyValue": "={{ $('Webhook Inbound').first().json.body.provider }}"
                        },
                        {
                            "keyName": "project_id",
                            "condition": "eq",
                            "keyValue": "={{ $('Webhook Inbound').first().json.body.project_id }}"
                        }
                    ]
                }
            },
            "type": "n8n-nodes-base.supabase",
            "typeVersion": 1,
            "position": [
                -9776,
                3344
            ],
            "id": "7ed8cb66-cbb7-409d-929b-1208ce0b01fd",
            "name": "Fetch All Provider Responses",
            "credentials": {
                "supabaseApi": {
                    "id": "pI4CpdYLTiEEBmnz",
                    "name": "Supabase account"
                }
            }
        },
        {
            "parameters": {
                "jsCode": "// =============================================\n// NODO: Filter Deficiencies Only\n// Solo incluye items que realmente son deficiencias\n// =============================================\n\nconst items = $input.all();\n\n// Valores que indican deficiencias (necesitan Q&A)\nconst DEFICIENCY_VALUES = [\n  'PARTIALLY INCLUDED',\n  'NOT INCLUDED WITH ALTERNATIVE',\n  'NOT INCLUDED',\n  'NO INFORMATION'\n];\n\n// Valores que NO son deficiencias (no necesitan Q&A)\nconst OK_VALUES = [\n  'INCLUDED',\n  'INCLUDED WITH CAVEATS'\n];\n\nconst filteredItems = items.filter(item => {\n  const evalValue = (item.json.evaluation_value || '').toUpperCase().trim();\n  \n  // Si es un valor OK, excluir\n  if (OK_VALUES.some(v => evalValue === v.toUpperCase())) {\n    return false;\n  }\n  \n  // Caso 1: Es uno de los valores de deficiencia conocidos\n  if (DEFICIENCY_VALUES.some(v => evalValue.includes(v.toUpperCase()))) {\n    return true;\n  }\n  \n  // Caso 2: Empieza con \"NO VALUE FOUND\" (evaluaciÃ³n econÃ³mica sin valor)\n  if (evalValue.startsWith('NO VALUE FOUND')) {\n    return true;\n  }\n  \n  // Caso 3: Score bajo (menor a 5) como indicador de deficiencia\n  const score = item.json.score || 0;\n  if (score < 5) {\n    return true;\n  }\n  \n  // Por defecto, excluir (valores econÃ³micos con precios, etc.)\n  return false;\n});\n\nconsole.log(`ðŸ“‹ Filtrado de deficiencias:`);\nconsole.log(`   â”œâ”€ Total recibidos: ${items.length}`);\nconsole.log(`   â””â”€ Deficiencias encontradas: ${filteredItems.length}`);\n\n// Log de valores excluidos para debug\nconst excluded = items.length - filteredItems.length;\nif (excluded > 0) {\n  console.log(`   â”œâ”€ Excluidos (valores OK o econÃ³micos): ${excluded}`);\n}\n\nreturn filteredItems;"
            },
            "type": "n8n-nodes-base.code",
            "typeVersion": 2,
            "position": [
                -9552,
                3344
            ],
            "id": "c998c32a-b464-41bb-9328-442d3ee5ed9a",
            "name": "Filter Deficiencies Only"
        },
        {
            "parameters": {
                "useCustomSchema": true,
                "operation": "getAll",
                "tableId": "rfq_items_master",
                "limit": 1,
                "filters": {
                    "conditions": [
                        {
                            "keyName": "id",
                            "condition": "eq",
                            "keyValue": "={{ $json.requirement_id }}"
                        }
                    ]
                }
            },
            "type": "n8n-nodes-base.supabase",
            "typeVersion": 1,
            "position": [
                -9328,
                3344
            ],
            "id": "f9b517e9-7acc-48ea-8e4f-2be328a351de",
            "name": "Fetch Requirement Specs",
            "credentials": {
                "supabaseApi": {
                    "id": "pI4CpdYLTiEEBmnz",
                    "name": "Supabase account"
                }
            }
        },
        {
            "parameters": {
                "aggregate": "aggregateAllItemData",
                "destinationFieldName": "total_deficiencies",
                "options": {}
            },
            "type": "n8n-nodes-base.aggregate",
            "typeVersion": 1,
            "position": [
                -9104,
                3344
            ],
            "id": "300419d0-db38-430c-b79c-d4ebf488440c",
            "name": "Consolidate Deficiencies"
        },
        {
            "parameters": {
                "promptType": "define",
                "text": "=Generate technical audit questions based on the following deficiencies detected for the provider {{ $(\"Set Input Params\").first().json.provider }}.\n\n**OUTPUT LANGUAGE**: {{ $('Set Input Params').first().json.language === 'en' ? 'ENGLISH - All questions and text must be in English.' : 'SPANISH - All questions and text must be in Spanish.' }}\n**CURRENCY**: {{ $('Set Input Params').first().json.currency || 'EUR' }} (use this currency when referencing monetary values in questions)\n\n**PROJECT TYPE**: {{ $('Set Input Params').first().json.project_type || 'RFP' }}\n{{ $('Set Input Params').first().json.project_type === 'RFI' ? '**RFI MODE**: Generate questions focused on technical capability, experience, and information completeness. Do NOT generate questions about pricing or commercial terms.' : ($('Set Input Params').first().json.project_type === 'RFQ' ? '**RFQ MODE**: Prioritize questions about pricing clarity, payment conditions, cost breakdown, and commercial terms. Include technical questions only when pricing depends on technical scope.' : '**RFP MODE**: Generate balanced questions covering both technical gaps and commercial/pricing clarifications.') }}\n\n**CRITICAL â€” VALID requirement_id VALUES**: The ONLY valid UUIDs you can use as requirement_id are listed below. Copy them CHARACTER BY CHARACTER. Do NOT invent or modify them.\n{{ $json.total_deficiencies.map(d => 'â€¢ \"' + (d.id || '') + '\" â†’ ' + (d.requirement_text || '').substring(0, 80)).join('\\n') }}\n\nEach question MUST use one of the above UUIDs as its requirement_id, linking the question to its source deficiency.\n\nDEFICIENCIES (full details):\n{{ JSON.stringify($json.total_deficiencies) }}\n\n## PROJECT CONTEXT: {{ $('Fetch Project Context QA').first().json.ai_context }}\n\n## DISCIPLINES:\n{{ $('Fetch Project Context QA').first().json.disciplines ? 'Use ONLY these project-specific disciplines: ' + $('Fetch Project Context QA').first().json.disciplines.join(', ') : 'No disciplines defined yet for this project. You MUST first determine the appropriate engineering disciplines based on the project context and the deficiencies provided. Typical disciplines include: Electrical, Mechanical, Civil, Process, Instrumentation, Structural, Environmental, General, etc. Choose the ones that best fit this specific project.' }}\n\n### INSTRUCTIONS:\n1.  **Link to Requirement**: Each question MUST include the \"requirement_id\" (the \"id\" field from the deficiency it relates to).\n2.  **Determine Disciplines**: First, identify the relevant engineering disciplines for THIS project based on the deficiencies and project context. Then classify each question into the most specific discipline.\n    - Be as specific as possible. Do not label everything as \"General\".\n    - Only use \"General\" if it is truly administrative or multi-disciplinary.\n3.  **Language**: All questions and text MUST be in {{ $('Set Input Params').first().json.language === 'en' ? 'English' : 'Spanish' }}.\n4.  **Format**: Respond strictly with the JSON object following the schema.\n\n### OUTPUT SCHEMA:\n{\n  \"disciplines\": [\"list of all unique discipline names used in the questions below\"],\n  \"questions\": [\n    {\n      \"requirement_id\": \"uuid-from-deficiency-id-field\",\n      \"discipline\": \"One of the disciplines listed above\",\n      \"question\": \"The specific question in {{ $('Set Input Params').first().json.language === 'en' ? 'English' : 'Spanish' }}\",\n      \"importance\": \"High\" | \"Medium\" | \"Low\"\n    }\n  ]\n}",
                "hasOutputParser": true,
                "batching": {}
            },
            "type": "@n8n/n8n-nodes-langchain.chainLlm",
            "typeVersion": 1.8,
            "position": [
                -8880,
                3344
            ],
            "id": "9f8972f0-9b36-4dad-aff7-d368790c41e7",
            "name": "QA Generation Chain"
        },
        {
            "parameters": {
                "schemaType": "manual",
                "inputSchema": "{\n  \"type\": \"object\",\n  \"properties\": {\n    \"disciplines\": {\n      \"type\": \"array\",\n      \"items\": { \"type\": \"string\" }\n    },\n    \"questions\": {\n      \"type\": \"array\",\n      \"items\": {\n        \"type\": \"object\",\n        \"properties\": {\n          \"requirement_id\": { \"type\": \"string\" },\n          \"discipline\": { \"type\": \"string\" },\n          \"question\": { \"type\": \"string\" },\n          \"importance\": { \"type\": \"string\" }\n        }\n      }\n    }\n  }\n}"
            },
            "type": "@n8n/n8n-nodes-langchain.outputParserStructured",
            "typeVersion": 1.3,
            "position": [
                -8736,
                3568
            ],
            "id": "04c42a54-173d-4662-b8e1-a79d00cd5784",
            "name": "JSON Output Parser"
        },
        {
            "parameters": {
                "fieldToSplitOut": "output.questions",
                "include": "allOtherFields",
                "options": {}
            },
            "type": "n8n-nodes-base.itemLists",
            "typeVersion": 3.1,
            "position": [
                -8528,
                3344
            ],
            "id": "6c6ed9d6-df97-4bea-a59d-b4e58c8e5d8c",
            "name": "Split Questions List"
        },
        {
            "parameters": {
                "jsCode": "// =============================================\n// NODO: Validate Requirement IDs\n// Filtra/corrige preguntas cuyo requirement_id\n// no existe en rfq_items_master\n// Matching por hex32: tolerante a un char extra/faltante\n// Modo: Run Once for All Items\n// =============================================\n\nconst normalize = s => (s || '').toString().trim().toLowerCase();\n// Hex32: elimina guiones y trunca a 32 chars â€” identifica un UUID sin importar chars extra al final\nconst toHex32 = s => normalize(s).replace(/-/g, '').substring(0, 32);\n\nconst items = $input.all();\nconst result = [];\n\n// Log una vez\nconst firstItem = items[0];\nif (firstItem) {\n  const sampleDefs = firstItem.json.total_deficiencies || [];\n  console.log(`ðŸ” total items: ${items.length}, total_deficiencies: ${sampleDefs.length}`);\n  if (sampleDefs[0]) {\n    console.log(`   keys: ${Object.keys(sampleDefs[0]).join(', ')}`);\n    console.log(`   sample id: ${sampleDefs[0].id}`);\n  }\n}\n\nfor (const item of items) {\n  const question = item.json['output.questions'];\n  const deficiencies = item.json.total_deficiencies || [];\n\n  // Mapas de lookup\n  const exactMap = new Map(); // normalizedFull â†’ original UUID\n  const hexMap = new Map();   // hex32 â†’ original UUID\n  for (const d of deficiencies) {\n    const orig = d.id || d.item_id || d.requirement_id;\n    if (!orig) continue;\n    exactMap.set(normalize(orig), orig);\n    hexMap.set(toHex32(orig), orig);\n  }\n\n  // Fail-open: sin referencia, dejar pasar\n  if (exactMap.size === 0) {\n    result.push(item);\n    continue;\n  }\n\n  const rawReqId = question?.requirement_id;\n\n  // 1. Match exacto\n  if (exactMap.has(normalize(rawReqId))) {\n    result.push(item);\n    continue;\n  }\n\n  // 2. Match hex32 (tolera 1 char extra/faltante al final del UUID)\n  const hexMatch = hexMap.get(toHex32(rawReqId));\n  if (hexMatch) {\n    console.log(`ðŸ”§ UUID corregido: \"${rawReqId}\" â†’ \"${hexMatch}\"`);\n    item.json['output.questions'].requirement_id = hexMatch;\n    result.push(item);\n    continue;\n  }\n\n  // 3. Sin match â†’ descartar\n  console.log(`âš ï¸ No match para requirement_id: \"${rawReqId}\" â€” descartando`);\n}\n\nconsole.log(`âœ… Pasados: ${result.length}/${items.length}`);\nreturn result;"
            },
            "type": "n8n-nodes-base.code",
            "typeVersion": 2,
            "position": [
                -8416,
                3344
            ],
            "id": "a1b2c3d4-e5f6-7890-abcd-ef1234567890",
            "name": "Validate Requirement IDs"
        },
        {
            "parameters": {
                "useCustomSchema": true,
                "tableId": "qa_audit",
                "fieldsUi": {
                    "fieldValues": [
                        {
                            "fieldId": "question",
                            "fieldValue": "={{ $json['output.questions'].question }}"
                        },
                        {
                            "fieldId": "importance",
                            "fieldValue": "={{ $json['output.questions'].importance }}"
                        },
                        {
                            "fieldId": "discipline",
                            "fieldValue": "={{ $json['output.questions'].discipline }}"
                        },
                        {
                            "fieldId": "provider_name",
                            "fieldValue": "={{ $(\"Set Input Params\").first().json.provider }}"
                        },
                        {
                            "fieldId": "project_id",
                            "fieldValue": "={{ $(\"Set Input Params\").first().json.project_id }}"
                        },
                        {
                            "fieldId": "requirement_id",
                            "fieldValue": "={{ $json['output.questions'].requirement_id }}"
                        },
                        {
                            "fieldId": "status",
                            "fieldValue": "Pending"
                        }
                    ]
                }
            },
            "type": "n8n-nodes-base.supabase",
            "typeVersion": 1,
            "position": [
                -8304,
                3344
            ],
            "id": "07803b46-78a5-4741-8a7c-107b4ece4a06",
            "name": "Supabase Insert",
            "credentials": {
                "supabaseApi": {
                    "id": "pI4CpdYLTiEEBmnz",
                    "name": "Supabase account"
                }
            }
        },
        {
            "parameters": {
                "jsCode": "// Extract unique disciplines from the QA Generation Chain output\n// and merge with existing project disciplines\nconst qaOutput = $('QA Generation Chain').first().json.output || {};\nconst generatedDisciplines = qaOutput.disciplines || [];\nconst existingDisciplines = $('Fetch Project Context QA').first().json.disciplines || [];\n\n// Merge: existing + new, deduplicated\nconst allDisciplines = [...new Set([...existingDisciplines, ...generatedDisciplines])];\nconst projectId = $('Set Input Params').first().json.project_id;\n\n// Format as PostgreSQL array literal for safe Supabase handling\nconst pgArray = '{' + allDisciplines.map(d => '\"' + d.replace(/\"/g, '\\\\\"') + '\"').join(',') + '}';\n\nconsole.log(`ðŸ“‹ Disciplines for project ${projectId}:`);\nconsole.log(`   â”œâ”€ Existing: ${existingDisciplines.join(', ') || 'none'}`);\nconsole.log(`   â”œâ”€ Generated: ${generatedDisciplines.join(', ')}`);\nconsole.log(`   â””â”€ Merged (${allDisciplines.length}): ${allDisciplines.join(', ')}`);\n\nreturn [{ json: { project_id: projectId, disciplines: pgArray } }];"
            },
            "type": "n8n-nodes-base.code",
            "typeVersion": 2,
            "position": [
                -8080,
                3344
            ],
            "id": "686ff9d7-b1f9-4a80-84f3-8e8fae695ba0",
            "name": "Extract Disciplines"
        },
        {
            "parameters": {
                "useCustomSchema": true,
                "schema": "public",
                "operation": "update",
                "tableId": "projects",
                "matchType": "allFilters",
                "filters": {
                    "conditions": [
                        {
                            "keyName": "id",
                            "condition": "eq",
                            "keyValue": "={{ $json.project_id }}"
                        }
                    ]
                },
                "fieldsUi": {
                    "fieldValues": [
                        {
                            "fieldId": "disciplines",
                            "fieldValue": "={{ $json.disciplines }}"
                        }
                    ]
                }
            },
            "type": "n8n-nodes-base.supabase",
            "typeVersion": 1,
            "position": [
                -7856,
                3344
            ],
            "id": "b4c5a78a-638e-4dbe-a901-116e3e10fde0",
            "name": "Save Project Disciplines",
            "credentials": {
                "supabaseApi": {
                    "id": "pI4CpdYLTiEEBmnz",
                    "name": "Supabase account"
                }
            }
        },
        {
            "parameters": {
                "respondWith": "allIncomingItems",
                "options": {}
            },
            "type": "n8n-nodes-base.respondToWebhook",
            "typeVersion": 1.5,
            "position": [
                -7632,
                3344
            ],
            "id": "d5b13d5b-3187-41b6-b36a-13c9566a0227",
            "name": "Respond to Webhook1"
        },
        {
            "parameters": {
                "content": "## Q&A Generator\n\n**Updated**: Dynamic disciplines per project + deficiency filtering.\n\n**Disciplines**:\n- Generated dynamically by the LLM based on project context\n- Saved to `projects.disciplines` for reuse in future runs\n- If project already has disciplines, LLM uses those\n- Merged: existing + new, deduplicated\n\n**Deficiencies filtered**:\n- PARTIALLY INCLUDED\n- NOT INCLUDED WITH ALTERNATIVE\n- NOT INCLUDED\n- NO INFORMATION\n- NO VALUE FOUND - *\n- Any item with score < 5\n\n**Excluded** (not deficiencies):\n- INCLUDED\n- INCLUDED WITH CAVEATS\n- Economic values (prices, hours, etc.)\n\n**Flow**:\n1. Receive project_id and provider\n2. Fetch project context (incl. existing disciplines)\n3. Fetch ALL provider_responses\n4. Filter only deficiencies (Code node)\n5. Fetch requirement details for each\n6. Generate questions + disciplines with LLM\n7. Save questions to qa_audit\n8. Extract & merge disciplines\n9. Save disciplines to project",
                "height": 1232,
                "width": 3448,
                "color": 7
            },
            "type": "n8n-nodes-base.stickyNote",
            "typeVersion": 1,
            "position": [
                -10816,
                2720
            ],
            "id": "12a6d899-9d67-4d05-b25e-feef4239abc0",
            "name": "Sticky Note1"
        },
        {
            "parameters": {
                "useCustomSchema": true,
                "operation": "get",
                "tableId": "projects",
                "filters": {
                    "conditions": [
                        {
                            "keyName": "id",
                            "keyValue": "={{ $('Set Input Params').first().json.project_id }}"
                        }
                    ]
                }
            },
            "id": "7eebbbcb-47a7-4a8b-ba24-735a27f90927",
            "name": "Fetch Project Context QA",
            "type": "n8n-nodes-base.supabase",
            "typeVersion": 1,
            "position": [
                -10000,
                3344
            ],
            "credentials": {
                "supabaseApi": {
                    "id": "pI4CpdYLTiEEBmnz",
                    "name": "Supabase account"
                }
            }
        },
        {
            "parameters": {
                "options": {
                    "temperature": 0.1
                }
            },
            "type": "@n8n/n8n-nodes-langchain.lmChatOpenRouter",
            "typeVersion": 1,
            "position": [
                -9136,
                3616
            ],
            "id": "804ebfad-6676-441a-b071-4c8653efbd41",
            "name": "OpenRouter Chat Model4",
            "credentials": {
                "openRouterApi": {
                    "id": "4AyUqsh1Z35g6bci",
                    "name": "OpenRouter account"
                }
            }
        }
    ],
    "connections": {
        "Webhook Inbound": {
            "main": [
                [
                    {
                        "node": "Set Input Params",
                        "type": "main",
                        "index": 0
                    }
                ]
            ]
        },
        "Set Input Params": {
            "main": [
                [
                    {
                        "node": "Fetch Project Context QA",
                        "type": "main",
                        "index": 0
                    }
                ]
            ]
        },
        "Fetch All Provider Responses": {
            "main": [
                [
                    {
                        "node": "Filter Deficiencies Only",
                        "type": "main",
                        "index": 0
                    }
                ]
            ]
        },
        "Filter Deficiencies Only": {
            "main": [
                [
                    {
                        "node": "Fetch Requirement Specs",
                        "type": "main",
                        "index": 0
                    }
                ]
            ]
        },
        "Fetch Requirement Specs": {
            "main": [
                [
                    {
                        "node": "Consolidate Deficiencies",
                        "type": "main",
                        "index": 0
                    }
                ]
            ]
        },
        "Consolidate Deficiencies": {
            "main": [
                [
                    {
                        "node": "QA Generation Chain",
                        "type": "main",
                        "index": 0
                    }
                ]
            ]
        },
        "QA Generation Chain": {
            "main": [
                [
                    {
                        "node": "Split Questions List",
                        "type": "main",
                        "index": 0
                    }
                ]
            ]
        },
        "JSON Output Parser": {
            "ai_outputParser": [
                [
                    {
                        "node": "QA Generation Chain",
                        "type": "ai_outputParser",
                        "index": 0
                    }
                ]
            ]
        },
        "Split Questions List": {
            "main": [
                [
                    {
                        "node": "Validate Requirement IDs",
                        "type": "main",
                        "index": 0
                    }
                ]
            ]
        },
        "Validate Requirement IDs": {
            "main": [
                [
                    {
                        "node": "Supabase Insert",
                        "type": "main",
                        "index": 0
                    }
                ]
            ]
        },
        "Supabase Insert": {
            "main": [
                [
                    {
                        "node": "Extract Disciplines",
                        "type": "main",
                        "index": 0
                    }
                ]
            ]
        },
        "Extract Disciplines": {
            "main": [
                [
                    {
                        "node": "Save Project Disciplines",
                        "type": "main",
                        "index": 0
                    }
                ]
            ]
        },
        "Save Project Disciplines": {
            "main": [
                [
                    {
                        "node": "Respond to Webhook1",
                        "type": "main",
                        "index": 0
                    }
                ]
            ]
        },
        "Fetch Project Context QA": {
            "main": [
                [
                    {
                        "node": "Fetch All Provider Responses",
                        "type": "main",
                        "index": 0
                    }
                ]
            ]
        },
        "OpenRouter Chat Model4": {
            "ai_languageModel": [
                [
                    {
                        "node": "QA Generation Chain",
                        "type": "ai_languageModel",
                        "index": 0
                    }
                ]
            ]
        }
    },
    "pinData": {},
    "meta": {
        "templateCredsSetupCompleted": true,
        "instanceId": "53140335eaf11280ef77ef2f5a378f48c2b28e822e3e0d96563cdd92175c0eff"
    }
}