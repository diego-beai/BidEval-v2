{
    "nodes": [
        {
            "parameters": {
                "model": "mistral-large-latest",
                "options": {}
            },
            "type": "@n8n/n8n-nodes-langchain.lmChatMistralCloud",
            "typeVersion": 1,
            "position": [
                -2496,
                640
            ],
            "id": "eac1e249-f3ab-4e28-8a8d-39979ef9c183",
            "name": "Mistral Cloud Chat Model2",
            "credentials": {
                "mistralCloudApi": {
                    "id": "tDjuOnF6lpADMmd5",
                    "name": "Mistral Cloud account"
                }
            }
        },
        {
            "parameters": {
                "model": "qwen3:14b",
                "options": {}
            },
            "type": "@n8n/n8n-nodes-langchain.lmChatOllama",
            "typeVersion": 1,
            "position": [
                -2320,
                656
            ],
            "id": "81c53cf6-dd7d-4eb9-b169-2e614d9bfd02",
            "name": "Ollama Chat Model",
            "credentials": {
                "ollamaApi": {
                    "id": "oS2Qqti9oVfsm8XZ",
                    "name": "Ollama account"
                }
            }
        },
        {
            "parameters": {
                "promptType": "define",
                "text": "=### INPUT\n\n## PRROYECTO: {{ $('Edit Fields').first().json.project_name }}\n\n## PROVEEDOR: {{ $('Edit Fields').first().json.provider_name }}\n\n## TONO DEL MENSAJE REQUERIDO: {{ $('Edit Fields').first().json.tone }}\n\n## ISSUES: {{ JSON.stringify($json.issues, null, 2) }}\n\n\n\n### FINAL INSTRUCTIONS\nReturn ONLY the JSON object. Do NOT think out loud. Do NOT include any text before or after the JSON.\n",
                "messages": {
                    "messageValues": [
                        {
                            "message": "=### ROLE\nYou are an expert Senior Project Engineer and Procurement Manager for large-scale industrial projects (P2X, Green Hydrogen). You are meticulous, diplomatic, and results-oriented.\n\n### TASK\nDraft a professional email to the Provider regarding their recent proposal for the Project. We have identified specific gaps/issues that need to be addressed.\n\n### GUIDELINES\n1. **Subject Line**: Must be clear, professional, and reference the Project.\n2. **Tone**: Strictly adhere to the requested 'TONE' input.\n3. **Body Content**:\n   - Briefly thank them for the proposal.\n   - State that during the review, the following points require clarification or are missing:\n   - **Critical**: Iterate through the 'ISSUES' list provided in the input. Group them intelligently (e.g., by Phase or Evaluation Type) to make the email readable.\n   - For each issue, clearly mention the *Requirement* ('requirement' field) and the *Current Status* ('status' field).\n   - Ask for these specific items to be provided or clarified.\n4. **Formatting**: Use clean line breaks (\\n) for readability in the JSON string.\n\n### CRITICAL: OUTPUT RESTRICTIONS\n- Return **ONLY** a valid JSON object.\n- **DO NOT** include any conversational text, explanations, reasoning, thoughts, or technical notes.\n- **DO NOT** use Markdown code blocks (e.g., ```json).\n- The output must start with `{` and end with `}`.\n\n### SCHEMA\n{\n  \"subject\": \"Email Subject Here\",\n  \"body\": \"Email Body Here \\n\\n Point 1... \\n Point 2...\"\n}"
                        }
                    ]
                },
                "batching": {}
            },
            "type": "@n8n/n8n-nodes-langchain.chainLlm",
            "typeVersion": 1.8,
            "position": [
                -2576,
                416
            ],
            "id": "766e1ef9-a2d0-4a53-8d3e-9af3ebef9ca1",
            "name": "Basic LLM Chain"
        },
        {
            "parameters": {
                "assignments": {
                    "assignments": [
                        {
                            "id": "6d3a985e-7c5e-4c74-8b5e-407e4d8c83a9",
                            "name": "project_name",
                            "value": "={{ $json.body.project_name }}",
                            "type": "string"
                        },
                        {
                            "id": "2d3a985e-7c5e-4c74-8b5e-407e4d8c83a1",
                            "name": "provider_name",
                            "value": "={{ $json.body.provider_key }}",
                            "type": "string"
                        },
                        {
                            "id": "3d3a985e-7c5e-4c74-8b5e-407e4d8c83a2",
                            "name": "tone",
                            "value": "={{ $json.body.tone }}",
                            "type": "string"
                        }
                    ]
                },
                "options": {}
            },
            "type": "n8n-nodes-base.set",
            "typeVersion": 3.4,
            "position": [
                -3696,
                416
            ],
            "id": "198418ce-5f17-4443-b853-f92c8b896bf4",
            "name": "Edit Fields"
        },
        {
            "parameters": {
                "numberInputs": 7
            },
            "type": "n8n-nodes-base.merge",
            "typeVersion": 3.2,
            "position": [
                -3024,
                336
            ],
            "id": "743625e7-55e2-4372-b7b2-838ce4ffc920",
            "name": "Merge2"
        },
        {
            "parameters": {
                "jsCode": "const items = $input.all();\nconst issues = [];\n// 1. Get the target provider name from the initial webhook/edit fields\nconst providerKey = $('Edit Fields').first().json.provider_name;\n\n// 2. Iterate through all items fetched from the DB for this project\nfor (const item of items) {\n  const row = item.json;\n  \n  // 3. Get the value of the column corresponding to the provider\n  const val = row[providerKey] || '';\n  \n  if (typeof val === 'string') {\n    const upper = val.toUpperCase();\n    \n    // 4. Apply the OR filter\n    if (upper.includes('NO INCLUIDO') || \n        upper.includes('PARCIAL') || \n        upper.includes('NO CUMPLE') || \n        upper.includes('SIN INFORMACIÓN') || \n        upper.includes('NO COTIZADO') || \n        upper.includes('SIN COTIZACIÓN') ||\n        upper.includes('SIN VALOR DETECTADO')) {\n          \n          // 5. Add to issues list with valid schema from user sample\n          issues.push({\n            evaluation_type: row['evaluation'] || row['Evaluation'] || 'General',\n            phase: row['fase'] || 'N/A',\n            requirement: row['requisito_rfq'] || row['rfq_requisito'] || '',\n            status: val\n          });\n    }\n  }\n}\n\n// 6. Return the aggregated list of issues to the LLM\nreturn {\n  json: {\n    issues: issues,\n    count: issues.length\n  }\n};"
            },
            "type": "n8n-nodes-base.code",
            "typeVersion": 2,
            "position": [
                -2800,
                416
            ],
            "id": "c67af467-738c-402f-bf06-7980203e9921",
            "name": "Filter and Aggregate Issues"
        },
        {
            "parameters": {
                "rules": {
                    "values": [
                        {
                            "conditions": {
                                "options": {
                                    "caseSensitive": true,
                                    "leftValue": "",
                                    "typeValidation": "strict",
                                    "version": 3
                                },
                                "conditions": [
                                    {
                                        "leftValue": "={{ $json.provider_name }}",
                                        "rightValue": "TECNICASREUNIDAS",
                                        "operator": {
                                            "type": "string",
                                            "operation": "equals"
                                        },
                                        "id": "f3688704-f30f-4143-8008-ae6c1a06eea1"
                                    }
                                ],
                                "combinator": "and"
                            }
                        },
                        {
                            "conditions": {
                                "options": {
                                    "caseSensitive": true,
                                    "leftValue": "",
                                    "typeValidation": "strict",
                                    "version": 3
                                },
                                "conditions": [
                                    {
                                        "id": "c2c6726d-ea3f-4909-a535-6f402eef63b8",
                                        "leftValue": "={{ $json.provider_name }}",
                                        "rightValue": "IDOM",
                                        "operator": {
                                            "type": "string",
                                            "operation": "equals"
                                        }
                                    }
                                ],
                                "combinator": "and"
                            }
                        },
                        {
                            "conditions": {
                                "options": {
                                    "caseSensitive": true,
                                    "leftValue": "",
                                    "typeValidation": "strict",
                                    "version": 3
                                },
                                "conditions": [
                                    {
                                        "id": "a64d8e41-6f32-489d-bf60-3bd22c9c9374",
                                        "leftValue": "={{ $json.provider_name }}",
                                        "rightValue": "SACYR",
                                        "operator": {
                                            "type": "string",
                                            "operation": "equals"
                                        }
                                    }
                                ],
                                "combinator": "and"
                            }
                        },
                        {
                            "conditions": {
                                "options": {
                                    "caseSensitive": true,
                                    "leftValue": "",
                                    "typeValidation": "strict",
                                    "version": 3
                                },
                                "conditions": [
                                    {
                                        "id": "42a16d6b-db65-401d-abb0-f8ae9aefff12",
                                        "leftValue": "={{ $json.provider_name }}",
                                        "rightValue": "EA",
                                        "operator": {
                                            "type": "string",
                                            "operation": "equals",
                                            "name": "filter.operator.equals"
                                        }
                                    }
                                ],
                                "combinator": "and"
                            }
                        },
                        {
                            "conditions": {
                                "options": {
                                    "caseSensitive": true,
                                    "leftValue": "",
                                    "typeValidation": "strict",
                                    "version": 3
                                },
                                "conditions": [
                                    {
                                        "id": "79599b4a-f8d0-4078-913a-2b40bea117c4",
                                        "leftValue": "={{ $json.provider_name }}",
                                        "rightValue": "SENER",
                                        "operator": {
                                            "type": "string",
                                            "operation": "equals",
                                            "name": "filter.operator.equals"
                                        }
                                    }
                                ],
                                "combinator": "and"
                            }
                        },
                        {
                            "conditions": {
                                "options": {
                                    "caseSensitive": true,
                                    "leftValue": "",
                                    "typeValidation": "strict",
                                    "version": 3
                                },
                                "conditions": [
                                    {
                                        "id": "59b13bbc-96bb-4e22-8fde-5c2fb10c8675",
                                        "leftValue": "={{ $json.provider_name }}",
                                        "rightValue": "TRESCA",
                                        "operator": {
                                            "type": "string",
                                            "operation": "equals",
                                            "name": "filter.operator.equals"
                                        }
                                    }
                                ],
                                "combinator": "and"
                            }
                        },
                        {
                            "conditions": {
                                "options": {
                                    "caseSensitive": true,
                                    "leftValue": "",
                                    "typeValidation": "strict",
                                    "version": 3
                                },
                                "conditions": [
                                    {
                                        "id": "d1601299-eed6-4754-b538-5e32d16a2a40",
                                        "leftValue": "={{ $json.provider_name }}",
                                        "rightValue": "WORLEY",
                                        "operator": {
                                            "type": "string",
                                            "operation": "equals",
                                            "name": "filter.operator.equals"
                                        }
                                    }
                                ],
                                "combinator": "and"
                            }
                        }
                    ]
                },
                "options": {
                    "fallbackOutput": "extra"
                }
            },
            "type": "n8n-nodes-base.switch",
            "typeVersion": 3.4,
            "position": [
                -3472,
                320
            ],
            "id": "796a9f63-971f-4256-ba0b-f407ff43d4e8",
            "name": "Switch2"
        },
        {
            "parameters": {
                "operation": "get",
                "dataTableId": {
                    "__rl": true,
                    "value": "hwY1VFb924Ptf1P6",
                    "mode": "list",
                    "cachedResultName": "Tabla-RFQ-v1",
                    "cachedResultUrl": "/projects/YoqFb1alZvPQmuNs/datatables/hwY1VFb924Ptf1P6"
                },
                "filters": {
                    "conditions": [
                        {
                            "keyName": "project_name",
                            "keyValue": "={{ $json.project_name }}"
                        }
                    ]
                },
                "returnAll": true
            },
            "id": "d9a2f9ad-2eeb-4ed5-a5bc-fc3a77340ecf",
            "name": "Get RFQ IDOM1",
            "type": "n8n-nodes-base.dataTable",
            "typeVersion": 1,
            "position": [
                -3248,
                32
            ]
        },
        {
            "parameters": {
                "operation": "get",
                "dataTableId": {
                    "__rl": true,
                    "value": "hwY1VFb924Ptf1P6",
                    "mode": "list",
                    "cachedResultName": "Tabla-RFQ-v1",
                    "cachedResultUrl": "/projects/YoqFb1alZvPQmuNs/datatables/hwY1VFb924Ptf1P6"
                },
                "filters": {
                    "conditions": [
                        {
                            "keyName": "project_name",
                            "keyValue": "={{ $json.project_name }}"
                        }
                    ]
                },
                "returnAll": true
            },
            "id": "e0c6086a-7d9b-4d68-b62b-22d038dca67f",
            "name": "Get RFQ TR1",
            "type": "n8n-nodes-base.dataTable",
            "typeVersion": 1,
            "position": [
                -3248,
                -160
            ]
        },
        {
            "parameters": {
                "operation": "get",
                "dataTableId": {
                    "__rl": true,
                    "value": "hwY1VFb924Ptf1P6",
                    "mode": "list",
                    "cachedResultName": "Tabla-RFQ-v1",
                    "cachedResultUrl": "/projects/YoqFb1alZvPQmuNs/datatables/hwY1VFb924Ptf1P6"
                },
                "filters": {
                    "conditions": [
                        {
                            "keyName": "project_name",
                            "keyValue": "={{ $json.project_name }}"
                        }
                    ]
                },
                "returnAll": true
            },
            "id": "2247fa17-96c8-47be-b23b-a97e50f90859",
            "name": "Get RFQ SACYR1",
            "type": "n8n-nodes-base.dataTable",
            "typeVersion": 1,
            "position": [
                -3248,
                224
            ]
        },
        {
            "parameters": {
                "operation": "get",
                "dataTableId": {
                    "__rl": true,
                    "value": "hwY1VFb924Ptf1P6",
                    "mode": "list",
                    "cachedResultName": "Tabla-RFQ-v1",
                    "cachedResultUrl": "/projects/YoqFb1alZvPQmuNs/datatables/hwY1VFb924Ptf1P6"
                },
                "filters": {
                    "conditions": [
                        {
                            "keyName": "project_name",
                            "keyValue": "={{ $json.project_name }}"
                        }
                    ]
                },
                "returnAll": true
            },
            "id": "87a62a17-c24f-405a-b3df-174b82b4e063",
            "name": "Get RFQ EA1",
            "type": "n8n-nodes-base.dataTable",
            "typeVersion": 1,
            "position": [
                -3248,
                416
            ]
        },
        {
            "parameters": {
                "operation": "get",
                "dataTableId": {
                    "__rl": true,
                    "value": "hwY1VFb924Ptf1P6",
                    "mode": "list",
                    "cachedResultName": "Tabla-RFQ-v1",
                    "cachedResultUrl": "/projects/YoqFb1alZvPQmuNs/datatables/hwY1VFb924Ptf1P6"
                },
                "filters": {
                    "conditions": [
                        {
                            "keyName": "project_name",
                            "keyValue": "={{ $json.project_name }}"
                        }
                    ]
                },
                "returnAll": true
            },
            "id": "bb19ec1a-848c-451f-947f-11d173100706",
            "name": "Get RFQ SENER1",
            "type": "n8n-nodes-base.dataTable",
            "typeVersion": 1,
            "position": [
                -3248,
                608
            ]
        },
        {
            "parameters": {
                "operation": "get",
                "dataTableId": {
                    "__rl": true,
                    "value": "hwY1VFb924Ptf1P6",
                    "mode": "list",
                    "cachedResultName": "Tabla-RFQ-v1",
                    "cachedResultUrl": "/projects/YoqFb1alZvPQmuNs/datatables/hwY1VFb924Ptf1P6"
                },
                "filters": {
                    "conditions": [
                        {
                            "keyName": "project_name",
                            "keyValue": "={{ $json.project_name }}"
                        }
                    ]
                },
                "returnAll": true
            },
            "id": "95b174e1-9dbc-4bd2-8574-11ed18490648",
            "name": "Get RFQ TRESCA1",
            "type": "n8n-nodes-base.dataTable",
            "typeVersion": 1,
            "position": [
                -3248,
                800
            ]
        },
        {
            "parameters": {
                "operation": "get",
                "dataTableId": {
                    "__rl": true,
                    "value": "hwY1VFb924Ptf1P6",
                    "mode": "list",
                    "cachedResultName": "Tabla-RFQ-v1",
                    "cachedResultUrl": "/projects/YoqFb1alZvPQmuNs/datatables/hwY1VFb924Ptf1P6"
                },
                "filters": {
                    "conditions": [
                        {
                            "keyName": "project_name",
                            "keyValue": "={{ $json.project_name }}"
                        }
                    ]
                },
                "returnAll": true
            },
            "id": "121f0a34-6258-4842-b2b6-181f46d0d7a9",
            "name": "Get RFQ WORLEY1",
            "type": "n8n-nodes-base.dataTable",
            "typeVersion": 1,
            "position": [
                -3248,
                992
            ]
        },
        {
            "parameters": {
                "content": "## Email en base datos faltantes\n",
                "height": 1328,
                "width": 1936,
                "color": 6
            },
            "type": "n8n-nodes-base.stickyNote",
            "typeVersion": 1,
            "position": [
                -3984,
                -176
            ],
            "id": "103923a4-a4a3-4f1e-ba15-1d668b22e4a7",
            "name": "Sticky Note2"
        },
        {
            "parameters": {
                "respondWith": "json",
                "responseBody": "={{ JSON.parse($json.text.match(/\\{[\\s\\S]*\\}/)[0]) }}",
                "options": {}
            },
            "type": "n8n-nodes-base.respondToWebhook",
            "typeVersion": 1.5,
            "position": [
                -2224,
                416
            ],
            "id": "3614a8fc-20d9-4387-b463-bbb44ea72e4f",
            "name": "Respond to Webhook3"
        },
        {
            "parameters": {
                "httpMethod": "POST",
                "path": "mail",
                "responseMode": "responseNode",
                "options": {}
            },
            "type": "n8n-nodes-base.webhook",
            "typeVersion": 2.1,
            "position": [
                -3920,
                416
            ],
            "id": "c7e52a62-8b2d-47ab-9e94-3d7d47864e6d",
            "name": "Webhook3",
            "webhookId": "b4d3f7cc-0697-40d9-85f0-83ed38a9feed"
        }
    ],
    "connections": {
        "Mistral Cloud Chat Model2": {
            "ai_languageModel": [
                [
                    {
                        "node": "Basic LLM Chain",
                        "type": "ai_languageModel",
                        "index": 0
                    }
                ]
            ]
        },
        "Basic LLM Chain": {
            "main": [
                [
                    {
                        "node": "Respond to Webhook3",
                        "type": "main",
                        "index": 0
                    }
                ]
            ]
        },
        "Edit Fields": {
            "main": [
                [
                    {
                        "node": "Switch2",
                        "type": "main",
                        "index": 0
                    }
                ]
            ]
        },
        "Merge2": {
            "main": [
                [
                    {
                        "node": "Filter and Aggregate Issues",
                        "type": "main",
                        "index": 0
                    }
                ]
            ]
        },
        "Filter and Aggregate Issues": {
            "main": [
                [
                    {
                        "node": "Basic LLM Chain",
                        "type": "main",
                        "index": 0
                    }
                ]
            ]
        },
        "Switch2": {
            "main": [
                [
                    {
                        "node": "Get RFQ TR1",
                        "type": "main",
                        "index": 0
                    }
                ],
                [
                    {
                        "node": "Get RFQ IDOM1",
                        "type": "main",
                        "index": 0
                    }
                ],
                [
                    {
                        "node": "Get RFQ SACYR1",
                        "type": "main",
                        "index": 0
                    }
                ],
                [
                    {
                        "node": "Get RFQ EA1",
                        "type": "main",
                        "index": 0
                    }
                ],
                [
                    {
                        "node": "Get RFQ SENER1",
                        "type": "main",
                        "index": 0
                    }
                ],
                [
                    {
                        "node": "Get RFQ TRESCA1",
                        "type": "main",
                        "index": 0
                    }
                ],
                [
                    {
                        "node": "Get RFQ WORLEY1",
                        "type": "main",
                        "index": 0
                    }
                ]
            ]
        },
        "Get RFQ IDOM1": {
            "main": [
                [
                    {
                        "node": "Merge2",
                        "type": "main",
                        "index": 1
                    }
                ]
            ]
        },
        "Get RFQ TR1": {
            "main": [
                [
                    {
                        "node": "Merge2",
                        "type": "main",
                        "index": 0
                    }
                ]
            ]
        },
        "Get RFQ SACYR1": {
            "main": [
                [
                    {
                        "node": "Merge2",
                        "type": "main",
                        "index": 2
                    }
                ]
            ]
        },
        "Get RFQ EA1": {
            "main": [
                [
                    {
                        "node": "Merge2",
                        "type": "main",
                        "index": 3
                    }
                ]
            ]
        },
        "Get RFQ SENER1": {
            "main": [
                [
                    {
                        "node": "Merge2",
                        "type": "main",
                        "index": 4
                    }
                ]
            ]
        },
        "Get RFQ TRESCA1": {
            "main": [
                [
                    {
                        "node": "Merge2",
                        "type": "main",
                        "index": 5
                    }
                ]
            ]
        },
        "Get RFQ WORLEY1": {
            "main": [
                [
                    {
                        "node": "Merge2",
                        "type": "main",
                        "index": 6
                    }
                ]
            ]
        },
        "Webhook3": {
            "main": [
                [
                    {
                        "node": "Edit Fields",
                        "type": "main",
                        "index": 0
                    }
                ]
            ]
        }
    },
    "pinData": {},
    "meta": {
        "templateCredsSetupCompleted": true,
        "instanceId": "53140335eaf11280ef77ef2f5a378f48c2b28e822e3e0d96563cdd92175c0eff"
    }
}