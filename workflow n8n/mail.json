{
  "nodes": [
    {
      "parameters": {
        "assignments": {
          "assignments": [
            {
              "id": "6d3a985e-7c5e-4c74-8b5e-407e4d8c83a9",
              "name": "project_name",
              "value": "={{ $json.body.project_name }}",
              "type": "string"
            },
            {
              "id": "2d3a985e-7c5e-4c74-8b5e-407e4d8c83a1",
              "name": "provider_name",
              "value": "={{ $json.body.provider_key }}",
              "type": "string"
            },
            {
              "id": "3d3a985e-7c5e-4c74-8b5e-407e4d8c83a2",
              "name": "tone",
              "value": "={{ $json.body.tone }}",
              "type": "string"
            },
            {
              "id": "4d3a985e-7c5e-4c74-8b5e-407e4d8c83a3",
              "name": "qa_items",
              "value": "={{ $json.body.qa_items || [] }}",
              "type": "array"
            }
          ]
        },
        "options": {}
      },
      "type": "n8n-nodes-base.set",
      "typeVersion": 3.4,
      "position": [
        -2720,
        -768
      ],
      "id": "f539bc69-b8a7-434a-8580-1e5293d559e0",
      "name": "Edit Fields"
    },
    {
      "parameters": {
        "jsCode": "// 1. Obtenemos TODOS los datos de Supabase y de Edit Fields\nconst allOffers = $('Get Offers').all();\nconst editFields = $('Edit Fields').first().json;\nconst targetProvider = editFields.provider_name;\nconst qaItems = editFields.qa_items || [];\n\nlet issuesFound = [];\n\n// 2. Iteramos por todos los registros\nfor (const item of allOffers) {\n  const row = item.json;\n  \n  // Solo procesamos si el proveedor coincide\n  if (row.provider_name === targetProvider) {\n    const status = (row.evaluation_value || '').trim();\n    \n    // CRITERIO: Si es distinto de \"INCLUIDO\" (ignorando mayúsculas/minúsculas), es un ISSUE\n    if (status.toUpperCase() !== 'INCLUIDO') {\n      issuesFound.push({\n        requirement: row.requirement_id || 'Requisito no identificado',\n        status: status || 'VACÍO',\n        comment: row.comment || 'Sin comentarios adicionales'\n      });\n    }\n  }\n}\n\n// 3. Devolvemos un solo objeto con toda la info para el LLM\n// Esto evita el \"undefined\" porque el LLM recibirá estos campos directamente\nreturn {\n  issues: issuesFound,\n  total_count: issuesFound.length,\n  project_name: editFields.project_name,\n  provider_name: targetProvider,\n  tone: editFields.tone,\n  qa_items: qaItems\n};"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        -2272,
        -768
      ],
      "id": "8c1616cb-7389-4634-8aaa-bfbd4059832a",
      "name": "Filter and Aggregate Issues"
    },
    {
      "parameters": {
        "content": "## Email en base datos faltantes\n",
        "height": 864,
        "width": 2016,
        "color": 6
      },
      "type": "n8n-nodes-base.stickyNote",
      "typeVersion": 1,
      "position": [
        -3232,
        -1056
      ],
      "id": "b3c0b3b6-fd03-4e0c-aef8-e653638e5694",
      "name": "Sticky Note2"
    },
    {
      "parameters": {
        "httpMethod": "POST",
        "path": "mail",
        "responseMode": "responseNode",
        "options": {}
      },
      "type": "n8n-nodes-base.webhook",
      "typeVersion": 2.1,
      "position": [
        -2944,
        -768
      ],
      "id": "969b5546-0213-4cfc-af6e-57c5c529e6ee",
      "name": "Webhook3",
      "webhookId": "e5929c60-27f5-441b-88a7-c01dae141abe",
      "disabled": true
    },
    {
      "parameters": {
        "operation": "getAll",
        "tableId": "provider_responses",
        "returnAll": true,
        "filters": {
          "conditions": [
            {
              "keyName": "provider_name",
              "condition": "eq",
              "keyValue": "={{ $json.provider_name }}"
            }
          ]
        }
      },
      "id": "18a8dc24-8c44-452b-9066-44ed41fab18c",
      "name": "Get Offers",
      "type": "n8n-nodes-base.supabase",
      "typeVersion": 1,
      "position": [
        -2496,
        -768
      ],
      "alwaysOutputData": true,
      "credentials": {
        "supabaseApi": {
          "id": "pI4CpdYLTiEEBmnz",
          "name": "Supabase account"
        }
      }
    },
    {
      "parameters": {
        "model": "ministral-8b-latest",
        "options": {
          "temperature": 0
        }
      },
      "type": "@n8n/n8n-nodes-langchain.lmChatMistralCloud",
      "typeVersion": 1,
      "position": [
        -1984,
        -544
      ],
      "id": "70babbf1-b944-4135-9c77-765ccfe20f74",
      "name": "Mistral Cloud Chat Model2",
      "credentials": {
        "mistralCloudApi": {
          "id": "tDjuOnF6lpADMmd5",
          "name": "Mistral Cloud account"
        }
      }
    },
    {
      "parameters": {
        "model": "qwen3:14b",
        "options": {}
      },
      "type": "@n8n/n8n-nodes-langchain.lmChatOllama",
      "typeVersion": 1,
      "position": [
        -1680,
        -544
      ],
      "id": "e48109b0-fbf2-42a8-a3d8-7eceed6af3c0",
      "name": "Ollama Chat Model",
      "credentials": {
        "ollamaApi": {
          "id": "oS2Qqti9oVfsm8XZ",
          "name": "Ollama account"
        }
      }
    },
    {
      "parameters": {
        "promptType": "define",
        "text": "=### INPUT DATA\nPROJECT: {{ $('Edit Fields').first().json.project_name }}\nPROVIDER: {{ $('Edit Fields').first().json.provider_name }}\nTONE: {{ $('Edit Fields').first().json.tone }}\nISSUES: {{ JSON.stringify($json.issues) }}\nQA_QUESTIONS: {{ JSON.stringify($json.qa_items) }}\n\n### OUTPUT REQUIREMENT\nReturn ONLY a valid JSON object. No markdown, no explanations. Start with { end with }",
        "messages": {
          "messageValues": [
            {
              "message": "=You are writing a professional email requesting clarifications from a supplier for an engineering project.\n\nWrite a complete email with the following structure:\n\n**OPENING PARAGRAPH (3-4 sentences):**\nThank the supplier for their proposal. Mention the project name. Explain that your team has completed a thorough technical and commercial review. State that before advancing to the next evaluation stage, you need clarification on several items.\n\n**BODY SECTIONS:**\nFor each category of issues, write:\n1. A section header\n2. An introductory sentence explaining what you need\n3. Bullet points with specific items (clear and descriptive, 8-15 words each)\n\nCategories to include:\n- Scope & Deliverables - Items not confirmed as included or unclear\n- Commercial & Pricing - Cost items requiring clarification (if any)\n- Technical Questions - Questions from QA_QUESTIONS array (include full question text)\n\n**CLOSING PARAGRAPH (2-3 sentences):**\nRequest a written response by a specific date. Offer to schedule a call if needed.\n\n**SIGNATURE:**\nBest regards,\nProject Evaluation Team\n\n---\n\n**IMPORTANT - ADAPT TO TONE:**\nThe TONE parameter is: Use the tone from the input data.\n\nIf TONE is 'formal':\n- Use formal language: \"We would like to request...\", \"Please be advised...\"\n- Maintain professional distance\n- Use complete sentences and formal closings\n- Subject: \"Request for Clarification - [Provider] Proposal\"\n\nIf TONE is 'urgent':\n- Emphasize time sensitivity: \"We urgently require...\", \"Time-critical response needed\"\n- Add deadline pressure: \"Response required within 48 hours\"\n- Use words like: immediately, critical, priority, time-sensitive\n- Subject: \"URGENT: Clarification Required - [Provider] Proposal\"\n\nIf TONE is 'friendly':\n- Use warmer language: \"We hope this finds you well\", \"We appreciate your partnership\"\n- Be collaborative: \"We'd love to understand better...\", \"Could you help us clarify...\"\n- Add positive reinforcement about the proposal\n- Subject: \"Quick Questions on Your Proposal - [Provider]\"\n\n---\n\n**OUTPUT FORMAT:**\nReturn ONLY a valid JSON object with two keys:\n- \"subject\": Subject line adapted to the tone\n- \"body\": The complete email body with proper line breaks (use \\n\\n for paragraph breaks)\n\nNo markdown code blocks. Start with { end with }"
            }
          ]
        },
        "batching": {}
      },
      "type": "@n8n/n8n-nodes-langchain.chainLlm",
      "typeVersion": 1.8,
      "position": [
        -2048,
        -768
      ],
      "id": "bb1fc506-a116-43da-93a5-f82f309d78b9",
      "name": "Basic LLM Chain"
    },
    {
      "parameters": {
        "respondWith": "allIncomingItems",
        "options": {}
      },
      "type": "n8n-nodes-base.respondToWebhook",
      "typeVersion": 1.5,
      "position": [
        -1696,
        -768
      ],
      "id": "009a3688-d4bb-46e2-9c83-695519810cd9",
      "name": "Respond to Webhook3"
    }
  ],
  "connections": {
    "Edit Fields": {
      "main": [
        [
          {
            "node": "Get Offers",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Filter and Aggregate Issues": {
      "main": [
        [
          {
            "node": "Basic LLM Chain",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Webhook3": {
      "main": [
        [
          {
            "node": "Edit Fields",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Get Offers": {
      "main": [
        [
          {
            "node": "Filter and Aggregate Issues",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Mistral Cloud Chat Model2": {
      "ai_languageModel": [
        [
          {
            "node": "Basic LLM Chain",
            "type": "ai_languageModel",
            "index": 0
          }
        ]
      ]
    },
    "Basic LLM Chain": {
      "main": [
        [
          {
            "node": "Respond to Webhook3",
            "type": "main",
            "index": 0
          }
        ]
      ]
    }
  },
  "pinData": {},
  "meta": {
    "templateCredsSetupCompleted": true,
    "instanceId": "53140335eaf11280ef77ef2f5a378f48c2b28e822e3e0d96563cdd92175c0eff"
  }
}