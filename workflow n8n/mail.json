{
  "nodes": [
    {
      "parameters": {
        "httpMethod": "POST",
        "path": "webhook/mail",
        "responseMode": "responseNode",
        "options": {}
      },
      "type": "n8n-nodes-base.webhook",
      "typeVersion": 2.1,
      "position": [-3400, -400],
      "id": "webhook-mail",
      "name": "Webhook Mail"
    },
    {
      "parameters": {
        "assignments": {
          "assignments": [
            {
              "id": "project-name",
              "name": "project_name",
              "value": "={{ $json.body.project_name }}",
              "type": "string"
            },
            {
              "id": "provider-name",
              "name": "provider_name", 
              "value": "={{ $json.body.provider_name }}",
              "type": "string"
            },
            {
              "id": "provider-key",
              "name": "provider_key",
              "value": "={{ $json.body.provider_key }}",
              "type": "string"
            },
            {
              "id": "tone",
              "name": "tone",
              "value": "={{ $json.body.tone }}",
              "type": "string"
            }
          ]
        },
        "options": {}
      },
      "type": "n8n-nodes-base.set",
      "typeVersion": 3.4,
      "position": [-3160, -400],
      "id": "extract-metadata",
      "name": "Extract Metadata"
    },
    {
      "parameters": {
        "jsCode": "// Simple issue generation for testing\nconst providerKey = $('Extract Metadata').first().json.provider_key;\nconst projectName = $('Extract Metadata').first().json.project_name;\n\n// Mock issues based on provider\nconst mockIssues = {\n  'IDOM': [\n    {\n      evaluation_type: 'Technical',\n      phase: 'FEED',\n      requirement: 'Cooling System Design and Specification',\n      status: 'Partially included',\n      id: 'c6fb5e89-aac8-4e7d-aa47-8289acceb5d5'\n    },\n    {\n      evaluation_type: 'Commercial',\n      phase: 'Economic',\n      requirement: 'Operating and Maintenance Cost Estimate',\n      status: 'Not evaluated',\n      id: 'f74dc1a7-e45c-45b3-b610-98c25b45554d'\n    }\n  ],\n  'TECNICASREUNIDAS': [\n    {\n      evaluation_type: 'Technical',\n      phase: 'Process',\n      requirement: 'System Efficiency Guarantee',\n      status: 'No incluido',\n      id: 'tr-001'\n    }\n  ]\n};\n\nconst issues = mockIssues[providerKey] || [];\n\nreturn {\n  json: {\n    issues: issues,\n    count: issues.length,\n    provider: providerKey\n  }\n};"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [-2920, -400],
      "id": "generate-issues",
      "name": "Generate Issues"
    },
    {
      "parameters": {
        "model": "deepseek-r1:14b",
        "options": {}
      },
      "type": "@n8n/n8n-nodes-langchain.lmChatOllama",
      "typeVersion": 1,
      "position": [-2680, -400],
      "id": "ollama-model",
      "name": "Ollama Model",
      "credentials": {
        "ollamaApi": {
          "id": "oS2Qqti9oVfsm8XZ",
          "name": "Ollama account"
        }
      }
    },
    {
      "parameters": {
        "promptType": "define",
        "text": "=Generate professional email for project: {{ $('Extract Metadata').first().json.project_name }}\nProvider: {{ $('Extract Metadata').first().json.provider_name }}\nTone: {{ $('Extract Metadata').first().json.tone }}\n\nIssues: {{ JSON.stringify($('Generate Issues').first().json.issues, null, 2) }}\n\nReturn ONLY JSON: {\"subject\": \"...\", \"body\": \"...\"}",
        "messages": {
          "messageValues": [
            {
              "message": "=You are an expert Senior Project Engineer. Generate professional emails addressing proposal issues."
            }
          ]
        },
        "batching": {}
      },
      "type": "@n8n/n8n-nodes-langchain.chainLlm",
      "typeVersion": 1.8,
      "position": [-2440, -400],
      "id": "generate-email",
      "name": "Generate Email"
    },
    {
      "parameters": {
        "jsCode": "// Clean LLM response and return proper JSON\nconst response = $input.first().json;\n\nlet subject = 'Proposal Clarifications Required';\nlet body = '';\n\n// Extract from output field if exists\nif (response.output) {\n  try {\n    const parsed = typeof response.output === 'string' ? JSON.parse(response.output) : response.output;\n    subject = parsed.subject || subject;\n    body = parsed.body || '';\n  } catch (e) {\n    body = response.output || '';\n  }\n} else {\n  // Direct response\n  subject = response.subject || subject;\n  body = response.body || '';\n}\n\nreturn {\n  json: {\n    subject: subject.trim(),\n    body: body.trim()\n  }\n};"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [-2200, -400],
      "id": "clean-response",
      "name": "Clean Response"
    },
    {
      "parameters": {
        "respondWith": "json",
        "responseBody": "={{ $json }}",
        "options": {}
      },
      "type": "n8n-nodes-base.respondToWebhook",
      "typeVersion": 1.5,
      "position": [-1960, -400],
      "id": "webhook-response",
      "name": "Response"
    }
  ],
  "connections": {
    "Webhook Mail": {
      "main": [
        [
          {
            "node": "Extract Metadata",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Extract Metadata": {
      "main": [
        [
          {
            "node": "Generate Issues",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Generate Issues": {
      "main": [
        [
          {
            "node": "Generate Email",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Generate Email": {
      "main": [
        [
          {
            "node": "Clean Response",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Clean Response": {
      "main": [
        [
          {
            "node": "Response",
            "type": "main",
            "index": 0
          }
        ]
      ]
    }
  },
  "pinData": {},
  "meta": {
    "templateCredsSetupCompleted": true,
    "instanceId": "mail-workflow-fixed"
  }
}