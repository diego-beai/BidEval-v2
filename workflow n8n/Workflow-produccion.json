{
  "nodes": [
    {
      "parameters": {
        "assignments": {
          "assignments": [
            {
              "id": "to-field",
              "name": "to",
              "value": "={{ $json.body.to }}",
              "type": "string"
            },
            {
              "id": "subject-field",
              "name": "subject",
              "value": "={{ $json.body.subject }}",
              "type": "string"
            },
            {
              "id": "body-field",
              "name": "email_body",
              "value": "={{ $json.body.body }}",
              "type": "string"
            },
            {
              "id": "provider-field",
              "name": "provider_name",
              "value": "={{ $json.body.provider_name }}",
              "type": "string"
            },
            {
              "id": "project-id-field",
              "name": "project_id",
              "value": "={{ $json.body.project_id }}",
              "type": "string"
            },
            {
              "id": "project-name-field",
              "name": "project_name",
              "value": "={{ $json.body.project_name }}",
              "type": "string"
            }
          ]
        },
        "options": {}
      },
      "type": "n8n-nodes-base.set",
      "typeVersion": 3.4,
      "position": [
        -6592,
        6240
      ],
      "id": "69c17988-039a-4b07-ab6d-fce3abbc013f",
      "name": "Extract Fields"
    },
    {
      "parameters": {
        "conditions": {
          "options": {
            "caseSensitive": true,
            "leftValue": "",
            "typeValidation": "strict",
            "version": 2
          },
          "conditions": [
            {
              "id": "check-to-email",
              "leftValue": "={{ $json.to }}",
              "rightValue": "",
              "operator": {
                "type": "string",
                "operation": "notEmpty"
              }
            },
            {
              "id": "check-subject",
              "leftValue": "={{ $json.subject }}",
              "rightValue": "",
              "operator": {
                "type": "string",
                "operation": "notEmpty"
              }
            },
            {
              "id": "check-body",
              "leftValue": "={{ $json.email_body }}",
              "rightValue": "",
              "operator": {
                "type": "string",
                "operation": "notEmpty"
              }
            }
          ],
          "combinator": "and"
        },
        "options": {}
      },
      "type": "n8n-nodes-base.if",
      "typeVersion": 2.2,
      "position": [
        -6368,
        6240
      ],
      "id": "9438488b-dfe5-4315-a3b7-c45dc7d098aa",
      "name": "Validate Data"
    },
    {
      "parameters": {
        "jsCode": "// Convert markdown body to HTML for email\nconst markdownBody = $('Extract Fields').first().json.email_body;\n\n// Simple markdown to HTML conversion\nlet htmlBody = markdownBody\n  // Convert bold\n  .replace(/\\*\\*(.+?)\\*\\*/g, '<strong>$1</strong>')\n  // Convert italic\n  .replace(/\\*(.+?)\\*/g, '<em>$1</em>')\n  // Convert bullet points\n  .replace(/^- (.+)$/gm, '<li>$1</li>')\n  // Wrap lists\n  .replace(/(<li>.*<\\/li>\\n?)+/g, '<ul>$&</ul>')\n  // Convert line breaks to paragraphs\n  .split('\\n\\n')\n  .map(p => p.trim())\n  .filter(p => p.length > 0)\n  .map(p => {\n    if (p.startsWith('<ul>') || p.startsWith('<li>')) return p;\n    return `<p>${p}</p>`;\n  })\n  .join('\\n');\n\n// Add email styling\nconst styledHtml = `\n<!DOCTYPE html>\n<html>\n<head>\n  <style>\n    body { font-family: Arial, sans-serif; line-height: 1.6; color: #333; max-width: 800px; margin: 0 auto; padding: 20px; }\n    p { margin: 0 0 16px 0; }\n    ul { margin: 0 0 16px 0; padding-left: 24px; }\n    li { margin: 4px 0; }\n    strong { font-weight: 600; }\n  </style>\n</head>\n<body>\n${htmlBody}\n</body>\n</html>\n`;\n\nreturn {\n  html_body: styledHtml,\n  to: $('Extract Fields').first().json.to,\n  subject: $('Extract Fields').first().json.subject,\n  provider_name: $('Extract Fields').first().json.provider_name,\n  project_id: $('Extract Fields').first().json.project_id,\n  project_name: $('Extract Fields').first().json.project_name\n};"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        -6144,
        6128
      ],
      "id": "8f9b683c-8c98-4bcf-aae7-d2861422de70",
      "name": "Convert Markdown to HTML"
    },
    {
      "parameters": {
        "sendTo": "={{ $json.to }}",
        "subject": "={{ $json.subject }}",
        "message": "={{ $json.html_body }}",
        "options": {
          "appendAttribution": false
        }
      },
      "type": "n8n-nodes-base.gmail",
      "typeVersion": 2.1,
      "position": [
        -5936,
        6128
      ],
      "id": "4033e36c-b89f-418a-86c7-fc4e4f2f2877",
      "name": "Gmail Send",
      "webhookId": "f32bcbf1-73d7-463b-b209-b7e114249ee9",
      "disabled": true
    },
    {
      "parameters": {
        "respondWith": "json",
        "responseBody": "={{ JSON.stringify({ success: false, error: 'Missing required fields: to, subject, or body' }) }}",
        "options": {
          "responseCode": 400
        }
      },
      "type": "n8n-nodes-base.respondToWebhook",
      "typeVersion": 1.5,
      "position": [
        -6144,
        6336
      ],
      "id": "ffa6b5bd-6a05-420a-a84a-a376b5550e91",
      "name": "Respond Error"
    },
    {
      "parameters": {
        "content": "## QA Send Email Workflow\n\nThis workflow receives email data from the Mail Dashboard and sends it via Gmail.\n\n**Expected POST body:**\n```json\n{\n  \"to\": \"recipient@email.com\",\n  \"subject\": \"Email Subject\",\n  \"body\": \"Email body in Markdown format\",\n  \"provider_name\": \"Provider Name\",\n  \"project_id\": \"project-uuid\",\n  \"project_name\": \"Project Name\"\n}\n```\n\n**IMPORTANT:** Configure Gmail OAuth2 credentials in the Gmail node.",
        "height": 724,
        "width": 1788,
        "color": 6
      },
      "type": "n8n-nodes-base.stickyNote",
      "typeVersion": 1,
      "position": [
        -7120,
        5776
      ],
      "id": "2d10d316-65ef-466a-a357-8e02842f152d",
      "name": "Instructions"
    },
    {
      "parameters": {
        "httpMethod": "POST",
        "path": "qa-send-email",
        "responseMode": "responseNode",
        "options": {}
      },
      "type": "n8n-nodes-base.webhook",
      "typeVersion": 2.1,
      "position": [
        -6816,
        6240
      ],
      "id": "25fca609-23dc-4fd2-9e1e-93302cc9f4a3",
      "name": "Webhook2",
      "webhookId": "qa-send-email-webhook"
    },
    {
      "parameters": {
        "respondWith": "json",
        "responseBody": "={{ JSON.stringify({ success: true, message: 'Email sent successfully', to: $json.to, subject: $json.subject }) }}",
        "options": {
          "responseCode": 200
        }
      },
      "type": "n8n-nodes-base.respondToWebhook",
      "typeVersion": 1.5,
      "position": [
        -5712,
        6128
      ],
      "id": "2af0747d-7350-4a7f-93ce-7b00f9664e5c",
      "name": "Respond Success2"
    },
    {
      "parameters": {
        "httpMethod": "POST",
        "path": "qa-send-to-supplier",
        "responseMode": "responseNode",
        "options": {}
      },
      "type": "n8n-nodes-base.webhook",
      "typeVersion": 2.1,
      "position": [
        -4608,
        7408
      ],
      "id": "c477a525-6c28-464b-aca5-b177bd6fa320",
      "name": "Webhook Receive",
      "webhookId": "qa-send-to-supplier-webhook"
    },
    {
      "parameters": {
        "conditions": {
          "options": {
            "caseSensitive": true,
            "leftValue": "",
            "typeValidation": "strict"
          },
          "conditions": [
            {
              "id": "check-email",
              "leftValue": "={{ $json.email_to }}",
              "rightValue": "",
              "operator": {
                "type": "string",
                "operation": "notEmpty"
              }
            }
          ],
          "combinator": "and"
        },
        "options": {}
      },
      "type": "n8n-nodes-base.if",
      "typeVersion": 2.1,
      "position": [
        -2816,
        7408
      ],
      "id": "11de72c8-54a7-42da-a751-0b22357e1d87",
      "name": "Email Provided?"
    },
    {
      "parameters": {
        "sendTo": "={{ $json.email_to }}",
        "subject": "={{ $json.email_subject }}",
        "message": "={{ $json.email_html }}",
        "options": {
          "senderName": "BidEval Team"
        }
      },
      "type": "n8n-nodes-base.gmail",
      "typeVersion": 2.1,
      "position": [
        -2592,
        7344
      ],
      "id": "9a6fd727-628a-4f5f-b303-7929fd753bcd",
      "name": "Send Email via Gmail",
      "webhookId": "9be31203-685f-4b78-a56d-e950bca3a806",
      "disabled": true
    },
    {
      "parameters": {
        "jsCode": "// Generate a random token without crypto module\nfunction generateToken(length = 64) {\n  const chars = 'abcdef0123456789';\n  let token = '';\n  for (let i = 0; i < length; i++) {\n    token += chars.charAt(Math.floor(Math.random() * chars.length));\n  }\n  // Add timestamp for uniqueness\n  const timestamp = Date.now().toString(16);\n  return (timestamp + token).slice(0, 64);\n}\n\nconst token = generateToken();\n\n// Calculate expiration date\nconst expiresDays = $input.first().json.expires_days || 7;\nconst expiresAt = new Date();\nexpiresAt.setDate(expiresAt.getDate() + expiresDays);\n\nreturn {\n  json: {\n    ...$input.first().json,\n    token: token,\n    expires_at: expiresAt.toISOString()\n  }\n};"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        -4160,
        7408
      ],
      "id": "6359c599-55dc-493e-92a0-542991a5243b",
      "name": "Generate Token"
    },
    {
      "parameters": {
        "useCustomSchema": true,
        "schema": "public",
        "tableId": "qa_response_tokens",
        "fieldsUi": {
          "fieldValues": [
            {
              "fieldId": "project_id",
              "fieldValue": "={{ $json.project_id }}"
            },
            {
              "fieldId": "token",
              "fieldValue": "={{ $json.token }}"
            },
            {
              "fieldId": "provider_name",
              "fieldValue": "={{ $json.provider_name }}"
            },
            {
              "fieldId": "question_ids",
              "fieldValue": "={{ $json.question_ids }}"
            },
            {
              "fieldId": "expires_at",
              "fieldValue": "={{ $json.expires_at }}"
            }
          ]
        }
      },
      "type": "n8n-nodes-base.supabase",
      "typeVersion": 1,
      "position": [
        -3936,
        7408
      ],
      "id": "226f878d-3d34-4bdc-8648-c2f4a5a2fb2b",
      "name": "Save Token to DB",
      "credentials": {
        "supabaseApi": {
          "id": "pI4CpdYLTiEEBmnz",
          "name": "Supabase account"
        }
      }
    },
    {
      "parameters": {
        "jsCode": "// Split question_ids array into individual items\nconst questionIds = $(\"Set Input Params2\").first().json.question_ids || [];\n\n// Return each ID as a separate item\nreturn questionIds.map(id => ({\n  json: {\n    question_id: id\n  }\n}));"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        -3712,
        7312
      ],
      "id": "1633369d-bc4b-4a7f-81cd-f012c98deb8b",
      "name": "Split Question IDs"
    },
    {
      "parameters": {
        "useCustomSchema": true,
        "schema": "public",
        "operation": "getAll",
        "tableId": "qa_audit",
        "limit": 1,
        "filters": {
          "conditions": [
            {
              "keyName": "id",
              "condition": "eq",
              "keyValue": "={{ $json.question_id }}"
            }
          ]
        }
      },
      "type": "n8n-nodes-base.supabase",
      "typeVersion": 1,
      "position": [
        -3488,
        7312
      ],
      "id": "253b10a8-78b7-44b0-b0ea-58b5dbb9dad7",
      "name": "Fetch Questions",
      "credentials": {
        "supabaseApi": {
          "id": "pI4CpdYLTiEEBmnz",
          "name": "Supabase account"
        }
      }
    },
    {
      "parameters": {
        "useCustomSchema": true,
        "schema": "public",
        "operation": "getAll",
        "tableId": "projects",
        "limit": 1,
        "filters": {
          "conditions": [
            {
              "keyName": "id",
              "condition": "eq",
              "keyValue": "={{ $(\"Set Input Params2\").first().json.project_id }}"
            }
          ]
        }
      },
      "type": "n8n-nodes-base.supabase",
      "typeVersion": 1,
      "position": [
        -3488,
        7504
      ],
      "id": "7d7e7a87-8207-46fc-93ca-34b4aa70a627",
      "name": "Fetch Project Name",
      "credentials": {
        "supabaseApi": {
          "id": "pI4CpdYLTiEEBmnz",
          "name": "Supabase account"
        }
      }
    },
    {
      "parameters": {
        "mode": "combine",
        "combineBy": "combineAll",
        "options": {}
      },
      "type": "n8n-nodes-base.merge",
      "typeVersion": 3,
      "position": [
        -3264,
        7408
      ],
      "id": "c5919d65-3458-43b5-afec-2a3814e2b52b",
      "name": "Merge Data"
    },
    {
      "parameters": {
        "jsCode": "const items = $input.all();\nconst inputParams = $(\"Generate Token\").first().json;\nconst projectData = items.find(i => i.json.display_name)?.json || {};\nconst questions = items.filter(i => i.json.question);\n\n// Build the response link - UPDATE THIS URL TO YOUR FRONTEND\nconst frontendUrl = 'http://portalia.ignisenergia.es:9102';\nconst responseLink = `${frontendUrl}/respond/${inputParams.token}`;\n\n// Build questions HTML for email\nconst questionsHtml = questions.map((q, idx) => `\n  <tr>\n    <td style=\"padding: 12px; border-bottom: 1px solid #e2e8f0;\">${idx + 1}</td>\n    <td style=\"padding: 12px; border-bottom: 1px solid #e2e8f0;\">${q.json.discipline || 'General'}</td>\n    <td style=\"padding: 12px; border-bottom: 1px solid #e2e8f0;\">${q.json.question}</td>\n    <td style=\"padding: 12px; border-bottom: 1px solid #e2e8f0;\">\n      <span style=\"padding: 4px 8px; border-radius: 4px; font-size: 12px; background: ${q.json.importance === 'High' ? '#fee2e2' : q.json.importance === 'Medium' ? '#fef3c7' : '#dcfce7'}; color: ${q.json.importance === 'High' ? '#991b1b' : q.json.importance === 'Medium' ? '#92400e' : '#166534'};\">\n        ${q.json.importance || 'Medium'}\n      </span>\n    </td>\n  </tr>\n`).join('');\n\n// Build email HTML\nconst emailHtml = `\n<!DOCTYPE html>\n<html>\n<head>\n  <meta charset=\"utf-8\">\n  <meta name=\"viewport\" content=\"width=device-width, initial-scale=1.0\">\n</head>\n<body style=\"margin: 0; padding: 0; font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif; background-color: #f8fafc;\">\n  <div style=\"max-width: 600px; margin: 0 auto; padding: 40px 20px;\">\n    <!-- Header -->\n    <div style=\"text-align: center; margin-bottom: 32px;\">\n      <h1 style=\"margin: 0; font-size: 28px;\">\n        <span style=\"color: #1e293b;\">Bid</span><span style=\"color: #12b5b0;\">Eval</span>\n      </h1>\n      <p style=\"margin: 8px 0 0; color: #64748b;\">Technical Evaluation Platform</p>\n    </div>\n    \n    <!-- Main Card -->\n    <div style=\"background: white; border-radius: 16px; padding: 32px; box-shadow: 0 4px 24px rgba(0,0,0,0.08);\">\n      <h2 style=\"margin: 0 0 8px; color: #1e293b; font-size: 20px;\">Technical Questionnaire Request</h2>\n      <p style=\"margin: 0 0 24px; color: #64748b;\">Project: <strong>${projectData.display_name || 'N/A'}</strong></p>\n      \n      <p style=\"color: #475569; line-height: 1.6;\">\n        Dear <strong>${inputParams.provider_name}</strong> team,\n      </p>\n      <p style=\"color: #475569; line-height: 1.6;\">\n        As part of the technical evaluation process, we have prepared a questionnaire with <strong>${questions.length}</strong> questions that require your response.\n      </p>\n      \n      <!-- Questions Table -->\n      <div style=\"margin: 24px 0; overflow-x: auto;\">\n        <table style=\"width: 100%; border-collapse: collapse; font-size: 14px;\">\n          <thead>\n            <tr style=\"background: #f1f5f9;\">\n              <th style=\"padding: 12px; text-align: left; font-weight: 600; color: #475569;\">#</th>\n              <th style=\"padding: 12px; text-align: left; font-weight: 600; color: #475569;\">Discipline</th>\n              <th style=\"padding: 12px; text-align: left; font-weight: 600; color: #475569;\">Question</th>\n              <th style=\"padding: 12px; text-align: left; font-weight: 600; color: #475569;\">Priority</th>\n            </tr>\n          </thead>\n          <tbody>\n            ${questionsHtml}\n          </tbody>\n        </table>\n      </div>\n      \n      <!-- CTA Button -->\n      <div style=\"text-align: center; margin: 32px 0;\">\n        <a href=\"${responseLink}\" style=\"display: inline-block; padding: 16px 48px; background: linear-gradient(135deg, #12b5b0 0%, #0d9488 100%); color: white; text-decoration: none; border-radius: 12px; font-weight: 600; font-size: 16px;\">Respond to Questionnaire</a>\n      </div>\n      \n      <p style=\"color: #64748b; font-size: 14px;\">\n        This link will expire on <strong>${new Date(inputParams.expires_at).toLocaleDateString('en-US', { year: 'numeric', month: 'long', day: 'numeric' })}</strong>.\n      </p>\n      \n      <hr style=\"border: none; border-top: 1px solid #e2e8f0; margin: 24px 0;\">\n      \n      <p style=\"color: #94a3b8; font-size: 12px; margin: 0;\">\n        If you have any questions, please contact the evaluation team.\n      </p>\n    </div>\n    \n    <!-- Footer -->\n    <div style=\"text-align: center; margin-top: 32px; color: #94a3b8; font-size: 12px;\">\n      <p style=\"margin: 0;\">Powered by BidEval - Technical Evaluation Platform</p>\n    </div>\n  </div>\n</body>\n</html>\n`;\n\nreturn {\n  json: {\n    success: true,\n    token: inputParams.token,\n    response_link: responseLink,\n    expires_at: inputParams.expires_at,\n    project_name: projectData.display_name,\n    provider_name: inputParams.provider_name,\n    question_count: questions.length,\n    email_to: inputParams.email_to,\n    email_subject: `Technical Questionnaire - ${projectData.display_name || 'BidEval'}`,\n    email_html: emailHtml\n  }\n};"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        -3040,
        7408
      ],
      "id": "14e564ea-6559-4b59-9f87-f23e35142a6d",
      "name": "Build Email Content"
    },
    {
      "parameters": {
        "jsCode": "// Split question_ids for update\nconst questionIds = $(\"Set Input Params2\").first().json.question_ids || [];\nreturn questionIds.map(id => ({ json: { question_id: id } }));"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        -2368,
        7408
      ],
      "id": "966b88da-77d8-4ee3-be73-fae8c74358e4",
      "name": "Split for Update"
    },
    {
      "parameters": {
        "useCustomSchema": true,
        "schema": "public",
        "operation": "update",
        "tableId": "qa_audit",
        "matchType": "allFilters",
        "filters": {
          "conditions": [
            {
              "keyName": "id",
              "condition": "eq",
              "keyValue": "={{ $json.question_id }}"
            }
          ]
        },
        "fieldsUi": {
          "fieldValues": [
            {
              "fieldId": "status",
              "fieldValue": "Sent"
            }
          ]
        }
      },
      "type": "n8n-nodes-base.supabase",
      "typeVersion": 1,
      "position": [
        -2144,
        7408
      ],
      "id": "34a7cb20-7539-4222-9bc4-487672718153",
      "name": "Update Question Status",
      "credentials": {
        "supabaseApi": {
          "id": "pI4CpdYLTiEEBmnz",
          "name": "Supabase account"
        }
      }
    },
    {
      "parameters": {
        "assignments": {
          "assignments": [
            {
              "id": "project_id",
              "name": "project_id",
              "value": "={{ $json.body?.project_id || $json.project_id }}",
              "type": "string"
            },
            {
              "id": "provider_name",
              "name": "provider_name",
              "value": "={{ $json.body?.provider_name || $json.provider_name }}",
              "type": "string"
            },
            {
              "id": "question_ids",
              "name": "question_ids",
              "value": "={{ $json.body?.question_ids || $json.question_ids }}",
              "type": "array"
            },
            {
              "id": "email_to",
              "name": "email_to",
              "value": "={{ $json.body?.email_to || $json.email_to || '' }}",
              "type": "string"
            },
            {
              "id": "expires_days",
              "name": "expires_days",
              "value": "={{ $json.body?.expires_days || $json.expires_days || 7 }}",
              "type": "number"
            }
          ]
        },
        "options": {}
      },
      "type": "n8n-nodes-base.set",
      "typeVersion": 3.4,
      "position": [
        -4384,
        7408
      ],
      "id": "f21e93d0-8033-44db-8017-947827c53bdb",
      "name": "Set Input Params2"
    },
    {
      "parameters": {
        "respondWith": "json",
        "responseBody": "={{ $(\"Build Email Content\").first().json }}",
        "options": {}
      },
      "type": "n8n-nodes-base.respondToWebhook",
      "typeVersion": 1.5,
      "position": [
        -1920,
        7408
      ],
      "id": "2a4f631d-c773-4856-ade9-745763a87410",
      "name": "Respond to Webhook2"
    },
    {
      "parameters": {
        "content": "## QA Send to Supplier Workflow\n\n**Purpose:** Generate a unique token, send email via Gmail, and create response link for suppliers.\n\n**Input (POST body):**\n```json\n{\n  \"project_id\": \"uuid\",\n  \"provider_name\": \"IDOM\",\n  \"question_ids\": [\"uuid1\", \"uuid2\"],\n  \"email_to\": \"supplier@example.com\",\n  \"expires_days\": 7\n}\n```\n\n**Flow:**\n1. Generate 64-char token\n2. Save to `qa_response_tokens`\n3. Build HTML email\n4. If email_to provided â†’ Send via Gmail\n5. Update questions status to 'Sent'\n6. Return response link\n\n**Gmail Setup:**\nConfigure Gmail OAuth2 credentials in n8n.",
        "height": 688,
        "width": 3328,
        "color": 2
      },
      "type": "n8n-nodes-base.stickyNote",
      "typeVersion": 1,
      "position": [
        -4976,
        7024
      ],
      "id": "16775f3a-341c-4f64-9d0c-29dfd5596bcd",
      "name": "Sticky Note3"
    },
    {
      "parameters": {
        "useCustomSchema": true,
        "schema": "public",
        "operation": "getAll",
        "tableId": "qa_response_tokens",
        "limit": 1,
        "filters": {
          "conditions": [
            {
              "keyName": "token",
              "condition": "eq",
              "keyValue": "={{ $json.token }}"
            }
          ]
        }
      },
      "type": "n8n-nodes-base.supabase",
      "typeVersion": 1,
      "position": [
        -8768,
        7184
      ],
      "id": "a99a3e06-a4ee-4e01-b40b-c9f68b83a6f2",
      "name": "Validate Token",
      "credentials": {
        "supabaseApi": {
          "id": "pI4CpdYLTiEEBmnz",
          "name": "Supabase account"
        }
      }
    },
    {
      "parameters": {
        "conditions": {
          "options": {
            "caseSensitive": true,
            "leftValue": "",
            "typeValidation": "strict"
          },
          "conditions": [
            {
              "id": "token-valid",
              "leftValue": "={{ $json.status }}",
              "rightValue": "responded",
              "operator": {
                "type": "string",
                "operation": "notEquals"
              }
            },
            {
              "id": "not-expired",
              "leftValue": "={{ new Date($json.expires_at) > new Date() }}",
              "rightValue": true,
              "operator": {
                "type": "boolean",
                "operation": "equals"
              }
            }
          ],
          "combinator": "and"
        },
        "options": {}
      },
      "type": "n8n-nodes-base.if",
      "typeVersion": 2.2,
      "position": [
        -8544,
        7184
      ],
      "id": "ab981098-e5e5-48e3-ac04-6153ae270694",
      "name": "Token Valid?"
    },
    {
      "parameters": {
        "respondWith": "json",
        "responseBody": "={\n  \"success\": false,\n  \"error\": \"Token is invalid, expired, or already used\"\n}",
        "options": {
          "responseCode": 400
        }
      },
      "type": "n8n-nodes-base.respondToWebhook",
      "typeVersion": 1.5,
      "position": [
        -8320,
        7360
      ],
      "id": "e2c032a5-f218-4de2-b029-8766bfa66961",
      "name": "Respond Invalid"
    },
    {
      "parameters": {
        "jsCode": "// Get responses from the original input and token data\nconst inputParams = $('Set Input Params3').first().json;\nconst tokenData = $input.first().json;\n\nconst responses = inputParams.responses || [];\n\n// Return each response as a separate item with all context needed\nreturn responses.map(response => ({\n  json: {\n    // Token data\n    token_id: tokenData.id,\n    project_id: tokenData.project_id,\n    provider_name: tokenData.provider_name,\n    token: tokenData.token,\n    // Question data\n    question_id: response.question_id,\n    response_text: response.response_text\n  }\n}));"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        -8320,
        7184
      ],
      "id": "cc576dac-dea1-406f-9bd5-a5a2d17462a9",
      "name": "Split Responses"
    },
    {
      "parameters": {
        "options": {}
      },
      "type": "n8n-nodes-base.splitInBatches",
      "typeVersion": 3,
      "position": [
        -8096,
        7184
      ],
      "id": "cb55bfb8-658b-404b-a8da-7d5ee4ed18c8",
      "name": "Loop Over Items"
    },
    {
      "parameters": {
        "useCustomSchema": true,
        "schema": "public",
        "operation": "update",
        "tableId": "qa_audit",
        "matchType": "allFilters",
        "filters": {
          "conditions": [
            {
              "keyName": "id",
              "condition": "eq",
              "keyValue": "={{ $json.question_id }}"
            }
          ]
        },
        "fieldsUi": {
          "fieldValues": [
            {
              "fieldId": "response",
              "fieldValue": "={{ $json.response_text }}"
            },
            {
              "fieldId": "status",
              "fieldValue": "Answered"
            },
            {
              "fieldId": "responded_at",
              "fieldValue": "={{ new Date().toISOString() }}"
            },
            {
              "fieldId": "response_source",
              "fieldValue": "portal"
            }
          ]
        }
      },
      "type": "n8n-nodes-base.supabase",
      "typeVersion": 1,
      "position": [
        -7872,
        7184
      ],
      "id": "2be5a204-84cb-41c1-bac6-219c203f715e",
      "name": "Save Response to QA Audit",
      "credentials": {
        "supabaseApi": {
          "id": "pI4CpdYLTiEEBmnz",
          "name": "Supabase account"
        }
      }
    },
    {
      "parameters": {
        "useCustomSchema": true,
        "schema": "public",
        "operation": "getAll",
        "tableId": "qa_audit",
        "limit": 1,
        "filters": {
          "conditions": [
            {
              "keyName": "id",
              "condition": "eq",
              "keyValue": "={{ $('Loop Over Items').item.json.question_id }}"
            }
          ]
        }
      },
      "type": "n8n-nodes-base.supabase",
      "typeVersion": 1,
      "position": [
        -7648,
        7184
      ],
      "id": "e7946e59-3686-4503-ac88-b8c90d627065",
      "name": "Fetch Question Details",
      "alwaysOutputData": true,
      "credentials": {
        "supabaseApi": {
          "id": "pI4CpdYLTiEEBmnz",
          "name": "Supabase account"
        }
      }
    },
    {
      "parameters": {
        "conditions": {
          "options": {
            "caseSensitive": true,
            "leftValue": "",
            "typeValidation": "strict",
            "version": 2
          },
          "conditions": [
            {
              "id": "has-requirement",
              "leftValue": "={{ $json.requirement_id }}",
              "rightValue": "",
              "operator": {
                "type": "string",
                "operation": "notEmpty"
              }
            }
          ],
          "combinator": "and"
        },
        "options": {}
      },
      "type": "n8n-nodes-base.if",
      "typeVersion": 2.2,
      "position": [
        -7424,
        7184
      ],
      "id": "c51508ef-b9d5-408a-ab7e-5628d1a3ab43",
      "name": "Has Requirement?"
    },
    {
      "parameters": {
        "useCustomSchema": true,
        "schema": "public",
        "operation": "getAll",
        "tableId": "rfq_items_master",
        "limit": 1,
        "filters": {
          "conditions": [
            {
              "keyName": "id",
              "condition": "eq",
              "keyValue": "={{ $('Fetch Question Details').first().json.requirement_id }}"
            }
          ]
        }
      },
      "type": "n8n-nodes-base.supabase",
      "typeVersion": 1,
      "position": [
        -7200,
        7072
      ],
      "id": "19df42e3-95b3-4e64-97ee-b593e2ed4cfc",
      "name": "Fetch Requirement",
      "alwaysOutputData": true,
      "credentials": {
        "supabaseApi": {
          "id": "pI4CpdYLTiEEBmnz",
          "name": "Supabase account"
        }
      }
    },
    {
      "parameters": {
        "useCustomSchema": true,
        "schema": "public",
        "operation": "getAll",
        "tableId": "provider_responses",
        "returnAll": true,
        "matchType": "allFilters",
        "filters": {
          "conditions": [
            {
              "keyName": "requirement_id",
              "condition": "eq",
              "keyValue": "={{ $('Fetch Question Details').first().json.requirement_id }}"
            },
            {
              "keyName": "provider_name",
              "condition": "eq",
              "keyValue": "={{ $('Loop Over Items').item.json.provider_name }}"
            }
          ]
        }
      },
      "type": "n8n-nodes-base.supabase",
      "typeVersion": 1,
      "position": [
        -6976,
        7072
      ],
      "id": "6840862c-a4b5-4150-835c-7be35694e10c",
      "name": "Fetch Current Evaluation",
      "alwaysOutputData": true,
      "credentials": {
        "supabaseApi": {
          "id": "pI4CpdYLTiEEBmnz",
          "name": "Supabase account"
        }
      }
    },
    {
      "parameters": {
        "promptType": "define",
        "text": "=You are a technical evaluation expert. Based on a supplier's clarifying response, re-evaluate if a requirement is now better satisfied.\n\n**ORIGINAL REQUIREMENT:**\n{{ $('Fetch Requirement').first().json.requirement_text }}\n\n**CURRENT EVALUATION:**\nStatus: {{ $json.evaluation_value || 'NO INCLUIDO' }}\nScore: {{ $json.score || 0 }}/10\nComment: {{ $json.comment || 'Not evaluated' }}\n\n**SUPPLIER'S CLARIFYING RESPONSE:**\n{{ $('Loop Over Items').item.json.response_text }}\n\n**INSTRUCTIONS:**\n1. Analyze if the supplier's response addresses the gaps in the original requirement.\n2. Determine if the evaluation should be improved.\n3. Only improve the score if the response provides substantial new information.\n4. Be conservative - don't upgrade unless clearly justified.\n\n**RESPOND STRICTLY WITH JSON:**\n{\n  \"should_update\": true/false,\n  \"new_evaluation_value\": \"INCLUIDO\" | \"PARCIAL\" | \"NO INCLUIDO\",\n  \"new_score\": 0-10,\n  \"new_comment\": \"Brief explanation of change or why no change\",\n  \"confidence\": 0-100\n}",
        "hasOutputParser": true,
        "batching": {}
      },
      "type": "@n8n/n8n-nodes-langchain.chainLlm",
      "typeVersion": 1.8,
      "position": [
        -6752,
        7072
      ],
      "id": "25fa6bf9-d8e9-4399-8796-49a2d1b231c3",
      "name": "LLM Re-evaluate"
    },
    {
      "parameters": {
        "conditions": {
          "options": {
            "caseSensitive": true,
            "leftValue": "",
            "typeValidation": "strict"
          },
          "conditions": [
            {
              "id": "should-update",
              "leftValue": "={{ $json.output.should_update }}",
              "rightValue": true,
              "operator": {
                "type": "boolean",
                "operation": "equals"
              }
            },
            {
              "id": "high-confidence",
              "leftValue": "={{ $json.output.confidence }}",
              "rightValue": 70,
              "operator": {
                "type": "number",
                "operation": "gte"
              }
            }
          ],
          "combinator": "and"
        },
        "options": {}
      },
      "type": "n8n-nodes-base.if",
      "typeVersion": 2.2,
      "position": [
        -6528,
        7072
      ],
      "id": "9f080776-ffeb-4077-9a45-bbad292815a1",
      "name": "Should Update?"
    },
    {
      "parameters": {
        "useCustomSchema": true,
        "schema": "public",
        "operation": "update",
        "tableId": "provider_responses",
        "matchType": "allFilters",
        "filters": {
          "conditions": [
            {
              "keyName": "requirement_id",
              "condition": "eq",
              "keyValue": "={{ $('Fetch Question Details').first().json.requirement_id }}"
            },
            {
              "keyName": "provider_name",
              "condition": "eq",
              "keyValue": "={{ $('Loop Over Items').item.json.provider_name }}"
            }
          ]
        },
        "fieldsUi": {
          "fieldValues": [
            {
              "fieldId": "evaluation_value",
              "fieldValue": "={{ $json.output.new_evaluation_value }}"
            },
            {
              "fieldId": "score",
              "fieldValue": "={{ $json.output.new_score }}"
            },
            {
              "fieldId": "comment",
              "fieldValue": "={{ $json.output.new_comment + ' [Updated after supplier response]' }}"
            }
          ]
        }
      },
      "type": "n8n-nodes-base.supabase",
      "typeVersion": 1,
      "position": [
        -6304,
        6992
      ],
      "id": "692337e7-04a7-4cdf-b5a7-5b27a8a46cfa",
      "name": "Update Provider Response",
      "credentials": {
        "supabaseApi": {
          "id": "pI4CpdYLTiEEBmnz",
          "name": "Supabase account"
        }
      }
    },
    {
      "parameters": {},
      "type": "n8n-nodes-base.noOp",
      "typeVersion": 1,
      "position": [
        -6304,
        7152
      ],
      "id": "3e8a8804-8208-4dfd-b817-ff3e883c1541",
      "name": "Skip Update"
    },
    {
      "parameters": {},
      "type": "n8n-nodes-base.noOp",
      "typeVersion": 1,
      "position": [
        -7200,
        7296
      ],
      "id": "8a5e356c-7272-42ae-b6c7-0ecaaa8f8107",
      "name": "No Requirement"
    },
    {
      "parameters": {},
      "type": "n8n-nodes-base.merge",
      "typeVersion": 3,
      "position": [
        -6080,
        7184
      ],
      "id": "a7fc0f3a-90d6-45ee-ac5c-9fc1a6c3f9dd",
      "name": "Merge Results"
    },
    {
      "parameters": {
        "useCustomSchema": true,
        "schema": "public",
        "operation": "update",
        "tableId": "qa_response_tokens",
        "matchType": "allFilters",
        "filters": {
          "conditions": [
            {
              "keyName": "token",
              "condition": "eq",
              "keyValue": "={{ $('Set Input Params3').first().json.token }}"
            }
          ]
        },
        "fieldsUi": {
          "fieldValues": [
            {
              "fieldId": "status",
              "fieldValue": "responded"
            },
            {
              "fieldId": "responded_at",
              "fieldValue": "={{ new Date().toISOString() }}"
            }
          ]
        }
      },
      "type": "n8n-nodes-base.supabase",
      "typeVersion": 1,
      "position": [
        -5856,
        7184
      ],
      "id": "ae8222aa-21f3-475b-a179-6e13d3266a8b",
      "name": "Mark Token Responded",
      "credentials": {
        "supabaseApi": {
          "id": "pI4CpdYLTiEEBmnz",
          "name": "Supabase account"
        }
      }
    },
    {
      "parameters": {
        "useCustomSchema": true,
        "schema": "public",
        "tableId": "qa_notifications",
        "fieldsUi": {
          "fieldValues": [
            {
              "fieldId": "project_id",
              "fieldValue": "={{ $('Validate Token').first().json.project_id }}"
            },
            {
              "fieldId": "provider_name",
              "fieldValue": "={{ $('Validate Token').first().json.provider_name }}"
            },
            {
              "fieldId": "notification_type",
              "fieldValue": "supplier_responded"
            },
            {
              "fieldId": "title",
              "fieldValue": "=Supplier {{ $('Validate Token').first().json.provider_name }} has responded"
            },
            {
              "fieldId": "message",
              "fieldValue": "={{ $('Set Input Params3').first().json.responses.length || 0 }} question(s) answered via the supplier portal"
            },
            {
              "fieldId": "metadata",
              "fieldValue": "={{ JSON.stringify({ response_count: $('Set Input Params3').first().json.responses.length || 0, token: $('Set Input Params3').first().json.token }) }}"
            }
          ]
        }
      },
      "type": "n8n-nodes-base.supabase",
      "typeVersion": 1,
      "position": [
        -5632,
        7184
      ],
      "id": "e9f0b735-198d-4339-b014-5790acc668b6",
      "name": "Create Notification",
      "credentials": {
        "supabaseApi": {
          "id": "pI4CpdYLTiEEBmnz",
          "name": "Supabase account"
        }
      }
    },
    {
      "parameters": {
        "respondWith": "json",
        "responseBody": "={\n  \"success\": true,\n  \"message\": \"Responses processed and evaluations updated\",\n  \"processed_count\": {{ $('Set Input Params3').first().json.responses.length || 0 }}\n}",
        "options": {}
      },
      "type": "n8n-nodes-base.respondToWebhook",
      "typeVersion": 1.5,
      "position": [
        -5408,
        7184
      ],
      "id": "fa3c3f9e-08e6-41cd-821b-7879ed03919d",
      "name": "Respond Success"
    },
    {
      "parameters": {
        "httpMethod": "POST",
        "path": "qa-process-responses",
        "responseMode": "responseNode",
        "options": {}
      },
      "type": "n8n-nodes-base.webhook",
      "typeVersion": 2.1,
      "position": [
        -9200,
        7184
      ],
      "id": "3077418c-e304-4db2-b4ae-4836b329bec0",
      "name": "Webhook Receive1",
      "webhookId": "qa-process-responses-webhook"
    },
    {
      "parameters": {
        "assignments": {
          "assignments": [
            {
              "id": "token",
              "name": "token",
              "value": "={{ $json.body?.token || $json.token }}",
              "type": "string"
            },
            {
              "id": "responses",
              "name": "responses",
              "value": "={{ $json.body?.responses || $json.responses }}",
              "type": "array"
            }
          ]
        },
        "options": {}
      },
      "type": "n8n-nodes-base.set",
      "typeVersion": 3.4,
      "position": [
        -8976,
        7184
      ],
      "id": "ddf0c147-dfdd-4a6c-bda3-40378d9ba8bc",
      "name": "Set Input Params3"
    },
    {
      "parameters": {
        "schemaType": "manual",
        "inputSchema": "{\n  \"type\": \"object\",\n  \"properties\": {\n    \"should_update\": { \"type\": \"boolean\" },\n    \"new_evaluation_value\": { \"type\": \"string\" },\n    \"new_score\": { \"type\": \"number\" },\n    \"new_comment\": { \"type\": \"string\" },\n    \"confidence\": { \"type\": \"number\" }\n  }\n}"
      },
      "type": "@n8n/n8n-nodes-langchain.outputParserStructured",
      "typeVersion": 1.3,
      "position": [
        -6752,
        7312
      ],
      "id": "881059cc-ca4b-4875-847f-6dfe58954479",
      "name": "JSON Output Parser2"
    },
    {
      "parameters": {
        "model": "mistral-large-latest",
        "options": {
          "temperature": 0.1
        }
      },
      "type": "@n8n/n8n-nodes-langchain.lmChatMistralCloud",
      "typeVersion": 1,
      "position": [
        -6752,
        7440
      ],
      "id": "6983bd45-3b26-42dd-bb67-eff4382e2b10",
      "name": "Mistral Cloud Chat Model4",
      "credentials": {
        "mistralCloudApi": {
          "id": "tDjuOnF6lpADMmd5",
          "name": "Mistral Cloud account"
        }
      }
    },
    {
      "parameters": {
        "content": "## QA Process Responses Workflow\n\n**Purpose:** Process supplier responses using a Loop for reliable item-by-item processing.\n\n**Data Model:**\n- `qa_audit.requirement_id` links to `rfq_items_master.id`\n- This allows re-evaluation of requirements based on supplier responses\n\n**Input (POST body):**\n```json\n{\n  \"token\": \"abc123xyz...\",\n  \"responses\": [\n    {\n      \"question_id\": \"uuid\",\n      \"response_text\": \"Supplier's answer...\"\n    }\n  ]\n}\n```\n\n**Process:**\n1. Validate token (not expired, not used)\n2. Split responses into items\n3. **Loop Over Items** - process each response:\n   - Save response to qa_audit\n   - Fetch question details (including requirement_id)\n   - If has requirement_id:\n     - Fetch requirement from rfq_items_master\n     - Fetch current evaluation\n     - Re-evaluate with LLM\n     - Update if confidence >= 70%\n4. After loop: Mark token as responded\n5. Create notification\n6. Respond with success\n\n**Tables Updated:**\n- `qa_audit` - response, status, responded_at, response_source\n- `provider_responses` - evaluation_value, score, comment\n- `qa_response_tokens` - status, responded_at\n- `qa_notifications` - new notification created",
        "height": 1020,
        "width": 4418,
        "color": 3
      },
      "type": "n8n-nodes-base.stickyNote",
      "typeVersion": 1,
      "position": [
        -9552,
        6592
      ],
      "id": "6e643536-b349-42f3-8469-243c5673aebf",
      "name": "Sticky Note6"
    },
    {
      "parameters": {
        "content": "## /qa-process-email-response - AI Email Response Mapper\n\nProcesses supplier email responses and maps them to original Q&A questions using AI.\n\n**Method**: POST\n**Body**: { project_id, provider_name, email_content }\n\n**Flow**: Webhook â†’ Set Fields â†’ Fetch Q&A Questions â†’ Build AI Context â†’ LLM Chain â†’ Parse Output â†’ Respond\n\n**Returns**: { success, processed_count, mappings: [{ question_id, question_text, response_text, confidence, matched }] }",
        "height": 400,
        "width": 2400,
        "color": 7
      },
      "type": "n8n-nodes-base.stickyNote",
      "typeVersion": 1,
      "position": [
        -1552,
        7056
      ],
      "id": "7c039932-584f-497c-be93-13db1ef2f936",
      "name": "Sticky Note QA Email"
    },
    {
      "parameters": {
        "httpMethod": "POST",
        "path": "qa-process-email-response",
        "responseMode": "responseNode",
        "options": {}
      },
      "type": "n8n-nodes-base.webhook",
      "typeVersion": 2.1,
      "position": [
        -1136,
        7296
      ],
      "id": "d7a195c3-6e7b-4254-9342-ceebecf0c6d6",
      "name": "Webhook QA Email Response",
      "webhookId": "qa-email-response-webhook-001"
    },
    {
      "parameters": {
        "assignments": {
          "assignments": [
            {
              "id": "qa-email-project-id",
              "name": "project_id",
              "value": "={{ $json.body.project_id }}",
              "type": "string"
            },
            {
              "id": "qa-email-provider",
              "name": "provider_name",
              "value": "={{ $json.body.provider_name }}",
              "type": "string"
            },
            {
              "id": "qa-email-content",
              "name": "email_content",
              "value": "={{ $json.body.email_content }}",
              "type": "string"
            }
          ]
        },
        "options": {}
      },
      "type": "n8n-nodes-base.set",
      "typeVersion": 3.4,
      "position": [
        -912,
        7296
      ],
      "id": "cd9e982d-43ea-49de-a011-069cd6a2305e",
      "name": "Set QA Email Params"
    },
    {
      "parameters": {
        "useCustomSchema": true,
        "schema": "public",
        "operation": "getAll",
        "tableId": "qa_audit",
        "returnAll": true,
        "matchType": "allFilters",
        "filters": {
          "conditions": [
            {
              "keyName": "project_id",
              "condition": "eq",
              "keyValue": "={{ $json.project_id }}"
            },
            {
              "keyName": "provider_name",
              "condition": "eq",
              "keyValue": "={{ $json.provider_name }}"
            }
          ]
        }
      },
      "type": "n8n-nodes-base.supabase",
      "typeVersion": 1,
      "position": [
        -688,
        7296
      ],
      "id": "d0d1ae67-6ca0-433e-9e8a-9c19773ac611",
      "name": "Fetch QA Questions",
      "alwaysOutputData": true,
      "credentials": {
        "supabaseApi": {
          "id": "pI4CpdYLTiEEBmnz",
          "name": "Supabase account"
        }
      }
    },
    {
      "parameters": {
        "jsCode": "// Build context for LLM: combine Q&A questions with email content\nconst questions = $('Fetch QA Questions').all();\nconst params = $('Set QA Email Params').first().json;\n\nconst questionList = questions.map(q => ({\n  id: q.json.id,\n  question: q.json.question,\n  discipline: q.json.discipline,\n  importance: q.json.importance,\n  status: q.json.status\n}));\n\nconsole.log(`ðŸ“§ Processing email response:`);\nconsole.log(`   â”œâ”€ Provider: ${params.provider_name}`);\nconsole.log(`   â”œâ”€ Questions found: ${questionList.length}`);\nconsole.log(`   â””â”€ Email length: ${(params.email_content || '').length} chars`);\n\nreturn [{\n  json: {\n    project_id: params.project_id,\n    provider_name: params.provider_name,\n    email_content: params.email_content,\n    questions: questionList,\n    total_questions: questionList.length\n  }\n}];"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        -464,
        7296
      ],
      "id": "14fccf74-6309-4f87-9e6f-d64ab4018df4",
      "name": "Build AI Context"
    },
    {
      "parameters": {
        "promptType": "define",
        "text": "=### INPUT\n\n## PROVIDER: {{ $json.provider_name }}\n\n## ORIGINAL QUESTIONS ({{ $json.total_questions }} items):\n{{ JSON.stringify($json.questions, null, 2) }}\n\n## SUPPLIER EMAIL RESPONSE:\n{{ $json.email_content }}\n\n### INSTRUCTIONS\nAnalyze the supplier's email response and map each answer to its most likely original question.\nFor each mapping, provide a confidence score (0.0 to 1.0) indicating how certain you are of the match.\nIf a question has no corresponding answer in the email, set matched=false and response_text to empty string.\n\nReturn ONLY the JSON object. Do NOT include any text before or after the JSON.\n\n### OUTPUT SCHEMA\n{\n  \"success\": true,\n  \"processed_count\": <number of matched responses>,\n  \"mappings\": [\n    {\n      \"question_id\": \"<uuid from original question>\",\n      \"question_text\": \"<original question text>\",\n      \"response_text\": \"<extracted response from email>\",\n      \"confidence\": <0.0 to 1.0>,\n      \"matched\": <true/false>\n    }\n  ]\n}",
        "messages": {
          "messageValues": [
            {
              "message": "You are an expert AI assistant specialized in analyzing supplier email responses for procurement Q&A processes.\n\n### ROLE\nYou analyze email responses from suppliers and map each answer to its original technical question from a Q&A audit.\n\n### GUIDELINES\n1. Read the email carefully and identify distinct answers or response sections.\n2. Match each answer to the most relevant original question based on content, keywords, and context.\n3. Extract the exact response text from the email for each matched question.\n4. Assign confidence scores: 0.9+ for clear matches, 0.6-0.8 for likely matches, below 0.5 for uncertain.\n5. If a question has no answer in the email, mark it as not matched.\n6. Preserve the original question_id UUID exactly as provided.\n\n### CRITICAL: OUTPUT RESTRICTIONS\n- Return **ONLY** a valid JSON object.\n- **DO NOT** include any conversational text, explanations, or reasoning.\n- **DO NOT** use Markdown code blocks.\n- The output must start with `{` and end with `}`."
            }
          ]
        },
        "batching": {}
      },
      "type": "@n8n/n8n-nodes-langchain.chainLlm",
      "typeVersion": 1.8,
      "position": [
        -240,
        7296
      ],
      "id": "d86c1b4b-48af-4afc-b454-4e25ba738ab7",
      "name": "QA Email Mapping Chain"
    },
    {
      "parameters": {
        "model": "mistral-large-latest",
        "options": {
          "temperature": 0.1
        }
      },
      "type": "@n8n/n8n-nodes-langchain.lmChatMistralCloud",
      "typeVersion": 1,
      "position": [
        0,
        7424
      ],
      "id": "d9f2e45d-a004-4bb4-ab84-4477da88125a",
      "name": "Mistral QA Email Model",
      "credentials": {
        "mistralCloudApi": {
          "id": "tDjuOnF6lpADMmd5",
          "name": "Mistral Cloud account"
        }
      }
    },
    {
      "parameters": {
        "jsCode": "// Parse LLM output and ensure correct response format\nconst llmOutput = $input.first().json;\nlet result;\n\ntry {\n  // The LLM chain returns output in .text or .output\n  const rawText = llmOutput.text || llmOutput.output || JSON.stringify(llmOutput);\n  \n  // Try to parse as JSON\n  let parsed;\n  if (typeof rawText === 'string') {\n    // Clean potential markdown code blocks\n    const cleaned = rawText.replace(/```json\\n?/g, '').replace(/```\\n?/g, '').trim();\n    parsed = JSON.parse(cleaned);\n  } else {\n    parsed = rawText;\n  }\n  \n  // Validate and normalize\n  const mappings = (parsed.mappings || []).map(m => ({\n    question_id: m.question_id || '',\n    question_text: m.question_text || '',\n    response_text: m.response_text || '',\n    confidence: typeof m.confidence === 'number' ? m.confidence : 0,\n    matched: m.matched === true\n  }));\n  \n  const matchedCount = mappings.filter(m => m.matched).length;\n  \n  result = {\n    success: true,\n    processed_count: matchedCount,\n    mappings: mappings,\n    message: `Processed ${matchedCount} of ${mappings.length} questions from email`\n  };\n  \n  console.log(`âœ… QA Email Response processed:`);\n  console.log(`   â”œâ”€ Total mappings: ${mappings.length}`);\n  console.log(`   â””â”€ Matched: ${matchedCount}`);\n} catch (err) {\n  console.error('âŒ Error parsing LLM output:', err.message);\n  result = {\n    success: false,\n    processed_count: 0,\n    mappings: [],\n    message: 'Error parsing AI response: ' + err.message\n  };\n}\n\nreturn [{ json: result }];"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        112,
        7296
      ],
      "id": "4ccea6b1-5d36-4a66-80b4-067a278bfa1e",
      "name": "Parse QA Email Output"
    },
    {
      "parameters": {
        "respondWith": "allIncomingItems",
        "options": {}
      },
      "type": "n8n-nodes-base.respondToWebhook",
      "typeVersion": 1.5,
      "position": [
        336,
        7296
      ],
      "id": "dbb102f6-6d98-4346-8b41-b1bb50797e7b",
      "name": "Respond QA Email Response"
    },
    {
      "parameters": {
        "content": "## RFQ Chat - Full Database Access",
        "height": 832,
        "width": 2016,
        "color": 3
      },
      "type": "n8n-nodes-base.stickyNote",
      "typeVersion": 1,
      "position": [
        -7120,
        3888
      ],
      "id": "71286cd9-81ad-458d-8860-8b246cf56534",
      "name": "Sticky Note4"
    },
    {
      "parameters": {
        "options": {}
      },
      "type": "n8n-nodes-base.respondToWebhook",
      "typeVersion": 1.5,
      "position": [
        -5360,
        4080
      ],
      "id": "4cf348e7-2c0c-4b98-b9e0-8b713a443ef8",
      "name": "Respond to Webhook5"
    },
    {
      "parameters": {
        "model": "qwen3:8b",
        "options": {
          "temperature": 0.2,
          "numCtx": 8192,
          "numPredict": 1024
        }
      },
      "type": "@n8n/n8n-nodes-langchain.lmChatOllama",
      "typeVersion": 1,
      "position": [
        -6832,
        4448
      ],
      "id": "5564d5e0-b825-461e-869f-8ef3670019a0",
      "name": "Ollama Chat Model3",
      "credentials": {
        "ollamaApi": {
          "id": "oS2Qqti9oVfsm8XZ",
          "name": "Ollama account"
        }
      }
    },
    {
      "parameters": {
        "httpMethod": "POST",
        "path": "chat-rfq",
        "responseMode": "responseNode",
        "options": {}
      },
      "type": "n8n-nodes-base.webhook",
      "typeVersion": 2.1,
      "position": [
        -7008,
        4080
      ],
      "id": "ef181791-47b4-4518-bee7-4d0c5ebee533",
      "name": "Webhook1",
      "webhookId": "chat-rfq"
    },
    {
      "parameters": {
        "sessionIdType": "customKey",
        "sessionKey": "={{ $json.body.sessionId }}"
      },
      "id": "c7a4eb93-fbba-448a-8e7b-5407e42476e7",
      "name": "Postgres Chat Memory",
      "type": "@n8n/n8n-nodes-langchain.memoryPostgresChat",
      "typeVersion": 1,
      "position": [
        -6656,
        4304
      ],
      "notesInFlow": false,
      "credentials": {
        "postgres": {
          "id": "V0REAPph5JBLqze3",
          "name": "Postgres account"
        }
      }
    },
    {
      "parameters": {
        "model": "qwen3-embedding:8b"
      },
      "type": "@n8n/n8n-nodes-langchain.embeddingsOllama",
      "typeVersion": 1,
      "position": [
        -6160,
        4512
      ],
      "id": "398eeef4-1b48-415c-8561-ec52bae8281e",
      "name": "Embeddings Ollama",
      "credentials": {
        "ollamaApi": {
          "id": "oS2Qqti9oVfsm8XZ",
          "name": "Ollama account"
        }
      }
    },
    {
      "parameters": {
        "promptType": "define",
        "text": "={{ $json.body.chatInput }}",
        "options": {
          "systemMessage": "=CRITICAL RULES - YOU MUST FOLLOW THESE:\n1. ALWAYS respond in {{ $json.body.language === 'en' ? 'ENGLISH' : 'SPANISH' }}.\n2. NEVER use emojis or emoticons in your responses.\n3. When referencing monetary values or prices, ALWAYS use {{ $json.body.currency || 'EUR' }} as the currency.\n\nYou are an expert assistant specialized in analyzing vendor proposals for RFQ evaluations.\n\nVENDORS: IDOM, SACYR, TECNICASREUNIDAS (TR), EA, SENER, TRESCA, WORLEY\n\n## AVAILABLE TOOLS\n\n### Vector Search Tools (for narrative/document content):\n- **consultar_ofertas_proveedores**: Search vendor proposal documents for detailed text, technical descriptions, and narrative content.\n- **consultar_documentos_rfq**: Search original RFQ documents for client requirements and specifications.\n\n### SQL Tools (for structured data):\n- **query_requirements**: Query rfq_items_master with provider_responses. Returns: requirement_text, evaluation_type (Technical/Economical/Pre-FEED/FEED), phase, provider evaluations (evaluation_value, comment).\n- **query_provider_responses**: Query provider_responses table. Filter by provider_name to get detailed vendor responses with comments.\n- **query_ranking**: Query ranking_proveedores table. Returns: overall_score (0-10 scale), compliance_percentage (%), category scores (0-10 scale), individual criterion scores (JSONB), and evaluation details with strengths/weaknesses (JSONB). Categories and weights are dynamic per project. IMPORTANT: Present data exactly as returned by the query, never invent or estimate scores.\n- **query_qa_audit**: Query qa_audit table. Filter by: provider, discipline (Electrica/Mecanica/Civil/Proceso/General), status, or all.\n\n## TOOL SELECTION GUIDE\n\n| Question Type | Tool to Use |\n|---------------|-------------|\n| Overall ranking, who is best? | query_ranking |\n| Category scores (technical, economic, execution, HSE) | query_ranking |\n| Requirement compliance details | query_requirements |\n| Vendor evaluation details and comments | query_provider_responses |\n| Pending Q&A questions | query_qa_audit |\n| Document text, technical details | consultar_ofertas_proveedores |\n| Original RFQ specifications | consultar_documentos_rfq |\n\n## SCORING\n- All scores are on a 0-10 scale.\n- Scoring categories and weights are DYNAMIC per project. Do NOT assume fixed categories or weights.\n- Always retrieve actual scores from query_ranking and present them exactly as returned.\n- NEVER invent, estimate, or hallucinate scores. If query_ranking returns no data, say so.\n\n## INSTRUCTIONS\n1. ALWAYS use tools to retrieve data before answering. Never guess.\n2. For comparisons, query multiple sources if needed.\n3. Be concise (2-3 sentences max).\n4. Remember: respond in {{ $json.body.language === 'en' ? 'English' : 'Spanish' }}, no emojis, use {{ $json.body.currency || 'EUR' }} for monetary values."
        }
      },
      "id": "822277cc-e5b9-42c6-9c5a-4b01ef0d0670",
      "name": "Chat AI Agent",
      "type": "@n8n/n8n-nodes-langchain.agent",
      "typeVersion": 1.6,
      "position": [
        -6128,
        4080
      ]
    },
    {
      "parameters": {
        "mode": "retrieve-as-tool",
        "toolName": "consultar_ofertas_proveedores",
        "toolDescription": "Search vendor technical proposals for narrative content, technical descriptions, pricing details, and compliance explanations. Use when you need detailed text from proposal documents.",
        "tableName": {
          "__rl": true,
          "value": "proposals",
          "mode": "list",
          "cachedResultName": "proposals"
        },
        "topK": 10,
        "options": {
          "queryName": "match_proposals"
        }
      },
      "type": "@n8n/n8n-nodes-langchain.vectorStoreSupabase",
      "typeVersion": 1,
      "position": [
        -6528,
        4304
      ],
      "id": "6aee44da-d52a-4df6-8243-f72f8ccd2279",
      "name": "Revisar-ofertas",
      "credentials": {
        "supabaseApi": {
          "id": "pI4CpdYLTiEEBmnz",
          "name": "Supabase account"
        }
      }
    },
    {
      "parameters": {
        "mode": "retrieve-as-tool",
        "toolName": "consultar_documentos_rfq",
        "toolDescription": "Search original RFQ documents for client requirements, technical specifications, scope of work, and tender documentation. Use when you need the original request details.",
        "tableName": {
          "__rl": true,
          "value": "rfq",
          "mode": "list",
          "cachedResultName": "rfq"
        },
        "topK": 10,
        "options": {
          "queryName": "match_rfq"
        }
      },
      "type": "@n8n/n8n-nodes-langchain.vectorStoreSupabase",
      "typeVersion": 1,
      "position": [
        -6240,
        4304
      ],
      "id": "8c016715-e973-4d70-a725-6a078b33f079",
      "name": "Revisar RFQs",
      "credentials": {
        "supabaseApi": {
          "id": "pI4CpdYLTiEEBmnz",
          "name": "Supabase account"
        }
      }
    },
    {
      "parameters": {
        "model": "qwen3-embedding:8b"
      },
      "type": "@n8n/n8n-nodes-langchain.embeddingsOllama",
      "typeVersion": 1,
      "position": [
        -6448,
        4512
      ],
      "id": "8fa7363b-ab9c-404c-b728-6af052de26a2",
      "name": "Embeddings Ollama5",
      "credentials": {
        "ollamaApi": {
          "id": "oS2Qqti9oVfsm8XZ",
          "name": "Ollama account"
        }
      }
    },
    {
      "parameters": {
        "descriptionType": "manual",
        "toolDescription": "Query RFQ requirements with optional vendor responses. Use to find: requirement_text, evaluation_type (Technical/Economical/Pre-FEED/FEED), phase, and provider evaluations. Provide a search_term to filter requirements.",
        "operation": "executeQuery",
        "query": "SELECT rim.id, rim.evaluation_type, rim.phase, rim.requirement_text, pr.provider_name, pr.evaluation_value, pr.comment FROM rfq_items_master rim LEFT JOIN provider_responses pr ON rim.id = pr.requirement_id WHERE (rim.requirement_text ILIKE '%' || $1 || '%' OR rim.evaluation_type ILIKE '%' || $1 || '%') AND ($2 = '' OR rim.project_id::text = $2) ORDER BY rim.id LIMIT 30;",
        "options": {
          "queryReplacement": "={{ $fromAI('search_term', 'Keyword to search in requirements', 'string') }}, {{ $json.body.project_id || '' }}"
        }
      },
      "type": "n8n-nodes-base.postgresTool",
      "typeVersion": 2.5,
      "position": [
        -5952,
        4304
      ],
      "id": "498801e8-1682-4b43-8ad7-dcaee1f8aa60",
      "name": "query_requirements",
      "credentials": {
        "postgres": {
          "id": "V0REAPph5JBLqze3",
          "name": "Postgres account"
        }
      }
    },
    {
      "parameters": {
        "descriptionType": "manual",
        "toolDescription": "Query detailed vendor responses with comments. Use to find: evaluation_value, comment, provider_name. Provide provider_name to filter by vendor (IDOM, SACYR, TECNICASREUNIDAS, EA, SENER, TRESCA, WORLEY) or leave empty for all.",
        "operation": "executeQuery",
        "query": "SELECT pr.id, pr.provider_name, pr.evaluation_value, pr.comment, rim.requirement_text, rim.evaluation_type, rim.phase FROM provider_responses pr LEFT JOIN rfq_items_master rim ON pr.requirement_id = rim.id WHERE ($1 = '' OR pr.provider_name ILIKE '%' || $1 || '%') AND ($2 = '' OR pr.project_id::text = $2) ORDER BY pr.provider_name LIMIT 30;",
        "options": {
          "queryReplacement": "={{ $fromAI('provider_name', 'Provider name to filter (or empty for all)', 'string') }}, {{ $json.body.project_id || '' }}"
        }
      },
      "type": "n8n-nodes-base.postgresTool",
      "typeVersion": 2.5,
      "position": [
        -5824,
        4304
      ],
      "id": "c4a43da5-9748-4475-8166-2b132d159357",
      "name": "query_provider_responses",
      "credentials": {
        "postgres": {
          "id": "V0REAPph5JBLqze3",
          "name": "Postgres account"
        }
      }
    },
    {
      "parameters": {
        "descriptionType": "manual",
        "toolDescription": "Query vendor rankings and scores. Returns provider_name, overall_score (0-10 scale), compliance_percentage (%), category scores (0-10 scale), individual criterion scores (JSONB), and evaluation details with strengths/weaknesses (JSONB). Categories and weights are dynamic per project. Use for ranking questions and score comparisons. Always present the data exactly as returned, never invent or estimate scores.",
        "operation": "executeQuery",
        "query": "SELECT rp.provider_name, ROUND(rp.overall_score / 10, 2) as overall_score, rp.compliance_percentage, ROUND(rp.technical_score / 10, 2) as technical_score, ROUND(rp.economic_score / 10, 2) as economic_score, ROUND(rp.execution_score / 10, 2) as execution_score, ROUND(rp.hse_compliance_score / 10, 2) as hse_compliance_score, rp.category_scores_json, rp.individual_scores_json, rp.evaluation_details, rp.evaluation_count, rp.last_updated FROM ranking_proveedores rp WHERE ($1 = '' OR rp.project_id::text = $1) ORDER BY rp.overall_score DESC;",
        "options": {
          "queryReplacement": "={{ $json.body.project_id || '' }}"
        }
      },
      "type": "n8n-nodes-base.postgresTool",
      "typeVersion": 2.5,
      "position": [
        -5696,
        4304
      ],
      "id": "c6be0d63-8b4f-4d29-a3da-dced9a958a09",
      "name": "query_ranking",
      "credentials": {
        "postgres": {
          "id": "V0REAPph5JBLqze3",
          "name": "Postgres account"
        }
      }
    },
    {
      "parameters": {
        "descriptionType": "manual",
        "toolDescription": "Query Q&A audit for technical questions and responses. Returns: provider_name, discipline (Electrica/Mecanica/Civil/Proceso/General), question, status (Pending/Approved/etc.), importance (High/Medium/Low), response. Use filter_type: 'provider' with filter_value for vendor name, 'discipline' for discipline, 'status' for status, or 'all' for everything.",
        "operation": "executeQuery",
        "query": "SELECT qa.id, qa.provider_name, qa.discipline, qa.question, qa.status, qa.importance, qa.response, qa.created_at FROM qa_audit qa WHERE (($1 = 'all') OR ($1 = 'provider' AND qa.provider_name ILIKE '%' || $2 || '%') OR ($1 = 'discipline' AND qa.discipline ILIKE '%' || $2 || '%') OR ($1 = 'status' AND qa.status ILIKE '%' || $2 || '%')) AND ($3 = '' OR qa.project_id::text = $3) ORDER BY qa.created_at DESC LIMIT 25;",
        "options": {
          "queryReplacement": "={{ $fromAI('filter_type', 'Filter type: provider, discipline, status, or all', 'string') }}, {{ $fromAI('filter_value', 'Value to filter by (provider name, discipline, or status)', 'string') }}, {{ $json.body.project_id || '' }}"
        }
      },
      "type": "n8n-nodes-base.postgresTool",
      "typeVersion": 2.5,
      "position": [
        -5568,
        4304
      ],
      "id": "6c2c6d02-611b-42e1-b17a-a3e4d564c372",
      "name": "query_qa_audit",
      "credentials": {
        "postgres": {
          "id": "V0REAPph5JBLqze3",
          "name": "Postgres account"
        }
      }
    },
    {
      "parameters": {
        "model": "mistral-large-latest",
        "options": {}
      },
      "type": "@n8n/n8n-nodes-langchain.lmChatMistralCloud",
      "typeVersion": 1,
      "position": [
        -6032,
        4528
      ],
      "id": "d20d529c-6f20-4f57-9aaa-fee29792a1b5",
      "name": "Mistral Cloud Chat Model2",
      "credentials": {
        "mistralCloudApi": {
          "id": "tDjuOnF6lpADMmd5",
          "name": "Mistral Cloud account"
        }
      }
    },
    {
      "parameters": {
        "options": {
          "temperature": 0.1
        }
      },
      "type": "@n8n/n8n-nodes-langchain.lmChatOpenRouter",
      "typeVersion": 1,
      "position": [
        -5936,
        4624
      ],
      "id": "6efd54cc-d3a5-4ab2-8f27-2cca8de5e834",
      "name": "OpenRouter Chat Model",
      "credentials": {
        "openRouterApi": {
          "id": "4AyUqsh1Z35g6bci",
          "name": "OpenRouter account"
        }
      }
    },
    {
      "parameters": {
        "assignments": {
          "assignments": [
            {
              "id": "6d3a985e-7c5e-4c74-8b5e-407e4d8c83a9",
              "name": "project_name",
              "value": "={{ $json.body.project_name }}",
              "type": "string"
            },
            {
              "id": "project-id-uuid-field",
              "name": "project_id",
              "value": "={{ $json.body.project_id }}",
              "type": "string"
            },
            {
              "id": "2d3a985e-7c5e-4c74-8b5e-407e4d8c83a1",
              "name": "provider_name",
              "value": "={{ $json.body.provider_key }}",
              "type": "string"
            },
            {
              "id": "3d3a985e-7c5e-4c74-8b5e-407e4d8c83a2",
              "name": "tone",
              "value": "={{ $json.body.tone }}",
              "type": "string"
            },
            {
              "id": "4d3a985e-7c5e-4c74-8b5e-407e4d8c83a3",
              "name": "qa_items",
              "value": "={{ $json.body.qa_items }}",
              "type": "array"
            },
            {
              "id": "language-field-email",
              "name": "language",
              "value": "={{ $json.body.language || 'es' }}",
              "type": "string"
            },
            {
              "id": "currency-field-email",
              "name": "currency",
              "value": "={{ $json.body.currency || 'EUR' }}",
              "type": "string"
            }
          ]
        },
        "options": {}
      },
      "type": "n8n-nodes-base.set",
      "typeVersion": 3.4,
      "position": [
        -6608,
        5120
      ],
      "id": "573b9f43-8b56-4b37-82f1-bbde6c2377ea",
      "name": "Edit Fields"
    },
    {
      "parameters": {
        "jsCode": "// 1. Obtenemos TODOS los datos de Supabase y de Edit Fields\nconst allOffers = $('Get Offers').all();\nconst editFields = $('Edit Fields').first().json;\nconst targetProvider = editFields.provider_name;\nconst qaItems = $('Edit Fields').first().json.qa_items || [];\n\nlet issuesFound = [];\n\n// 2. Iteramos por todos los registros\nfor (const item of allOffers) {\n  const row = item.json;\n  \n  // Solo procesamos si el proveedor coincide\n  if (row.provider_name === targetProvider) {\n    const status = (row.evaluation_value || '').trim();\n    \n    // CRITERIO: Si es distinto de \"INCLUIDO\" (ignorando mayÃºsculas/minÃºsculas), es un ISSUE\n    if (status.toUpperCase() !== 'INCLUIDO') {\n      // Usar descripciÃ³n legible en lugar de UUID\n      const description = row.requirement_text || row.item_description || row.comment || 'Item requires clarification';\n      issuesFound.push({\n        description: description,\n        status: status || 'NOT PROVIDED',\n        provider_comment: row.comment || ''\n      });\n    }\n  }\n}\n\n// 3. Preparar Q&A questions si existen\nconst qaQuestions = qaItems.map(q => ({\n  question: q.question || q.pregunta_texto,\n  discipline: q.discipline || q.disciplina,\n  importance: q.importance || q.importancia\n}));\n\n// 4. Devolvemos un solo objeto con toda la info para el LLM\nreturn {\n  issues: issuesFound,\n  total_issues: issuesFound.length,\n  qa_questions: qaQuestions,\n  total_qa_questions: qaQuestions.length,\n  project_id: editFields.project_id,\n  project_name: editFields.project_name,\n  provider_name: targetProvider,\n  tone: editFields.tone\n};"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        -6160,
        5120
      ],
      "id": "95a168bc-1af3-4b9a-a14c-c020bc4a7257",
      "name": "Filter and Aggregate Issues"
    },
    {
      "parameters": {
        "content": "## Email en base datos faltantes\n",
        "height": 864,
        "width": 2016,
        "color": 6
      },
      "type": "n8n-nodes-base.stickyNote",
      "typeVersion": 1,
      "position": [
        -7120,
        4832
      ],
      "id": "1df95a50-b40e-4ddd-ad45-90bf51818f20",
      "name": "Sticky Note2"
    },
    {
      "parameters": {
        "httpMethod": "POST",
        "path": "mail",
        "responseMode": "responseNode",
        "options": {}
      },
      "type": "n8n-nodes-base.webhook",
      "typeVersion": 2.1,
      "position": [
        -6832,
        5120
      ],
      "id": "7ac71ce3-cef6-46a3-8cc5-6394509a9caf",
      "name": "Webhook3",
      "webhookId": "2dcca6b6-4d20-4250-9202-7b16ac06f716"
    },
    {
      "parameters": {
        "useCustomSchema": true,
        "schema": "public",
        "operation": "getAll",
        "tableId": "provider_responses",
        "returnAll": true,
        "filters": {
          "conditions": [
            {
              "keyName": "provider_name",
              "condition": "eq",
              "keyValue": "={{ $json.provider_name }}"
            },
            {
              "keyName": "project_id",
              "condition": "eq",
              "keyValue": "={{ $json.project_id }}"
            }
          ]
        }
      },
      "id": "19ab7dda-2b42-4de7-b52d-4440e727b6e3",
      "name": "Get Offers",
      "type": "n8n-nodes-base.supabase",
      "typeVersion": 1,
      "position": [
        -6384,
        5328
      ],
      "alwaysOutputData": true,
      "credentials": {
        "supabaseApi": {
          "id": "pI4CpdYLTiEEBmnz",
          "name": "Supabase account"
        }
      }
    },
    {
      "parameters": {
        "model": "qwen3:8b",
        "options": {
          "temperature": 0.2,
          "numCtx": 4096,
          "numPredict": 1024
        }
      },
      "type": "@n8n/n8n-nodes-langchain.lmChatOllama",
      "typeVersion": 1,
      "position": [
        -5568,
        5344
      ],
      "id": "70e32eb5-158d-4a04-b583-3b5251232321",
      "name": "Ollama Chat Model",
      "credentials": {
        "ollamaApi": {
          "id": "oS2Qqti9oVfsm8XZ",
          "name": "Ollama account"
        }
      }
    },
    {
      "parameters": {
        "promptType": "define",
        "text": "=### INPUT\n\n## PROJECT: {{ $('Edit Fields').first().json.project_name }}\n\n## PROVIDER: {{ $('Edit Fields').first().json.provider_name }}\n\n## REQUIRED TONE: {{ $('Edit Fields').first().json.tone }}\n\n## ISSUES ({{ $json.total_issues }} items): {{ JSON.stringify($json.issues, null, 2) }}\n\n## TECHNICAL QUESTIONS ({{ $json.total_qa_questions }} items): {{ JSON.stringify($json.qa_questions, null, 2) }}\n\n\\n## PROJECT CONTEXT: {{ $('Fetch Project Context Email').first().json.ai_context }}\\n\\n### FINAL INSTRUCTIONS\nReturn ONLY the JSON object. Do NOT think out loud. Do NOT include any text before or after the JSON.\n",
        "messages": {
          "messageValues": [
            {
              "message": "=### ROLE\nYou are an expert Senior Project Engineer and Procurement Manager for large-scale industrial projects (P2X, Green Hydrogen). You are meticulous, diplomatic, and results-oriented.\n\n### TASK\nDraft a professional email to the Provider regarding their recent proposal for the Project. We have identified specific gaps/issues and technical questions that need to be addressed.\n\n### LANGUAGE & CURRENCY\n- Write the email in {{ $('Edit Fields').first().json.language === 'en' ? 'ENGLISH' : 'SPANISH' }}.\n- When referencing monetary values, use {{ $('Edit Fields').first().json.currency || 'EUR' }} as currency.\n\n### GUIDELINES\n1. **Subject Line**: Must be clear, professional, and reference the Project name.\n2. **Tone**: Strictly adhere to the requested 'TONE' input.\n3. **Body Content**:\n   - Briefly thank them for the proposal.\n   - State that during the review, the following points require clarification or are missing.\n   - **For ISSUES**: Group them intelligently (e.g., by category or type). For each issue, describe what is missing using the 'description' field. NEVER show any IDs, UUIDs, or internal references.\n   - **For TECHNICAL QUESTIONS**: If there are any qa_questions, add a section titled 'Technical Questions' and list them. Include the discipline and importance level for each.\n   - Ask for these specific items to be provided or clarified.\n4. **Formatting**: Use Markdown formatting (bold, bullet points) for readability.\n5. **IMPORTANT**: NEVER include any UUIDs, internal IDs, requirement_id, or database references. Use only human-readable descriptions.\n\n### CRITICAL: OUTPUT RESTRICTIONS\n- Return **ONLY** a valid JSON object.\n- **DO NOT** include any UUIDs or internal database IDs anywhere in the output.\n- **DO NOT** include any conversational text, explanations, reasoning, thoughts, or technical notes.\n- **DO NOT** use Markdown code blocks (e.g., ```json).\n- The output must start with `{` and end with `}`.\n\n### SCHEMA\n{\n  \"subject\": \"Email Subject Here\",\n  \"body\": \"Email Body Here with **bold** and - bullet points\"\n}"
            }
          ]
        },
        "batching": {}
      },
      "type": "@n8n/n8n-nodes-langchain.chainLlm",
      "typeVersion": 1.8,
      "position": [
        -5936,
        5120
      ],
      "id": "e7a8783d-ec1a-4fea-806d-2d3d13379afe",
      "name": "Basic LLM Chain"
    },
    {
      "parameters": {
        "respondWith": "allIncomingItems",
        "options": {}
      },
      "type": "n8n-nodes-base.respondToWebhook",
      "typeVersion": 1.5,
      "position": [
        -5584,
        5120
      ],
      "id": "5ca0caa8-1013-4636-a5d8-b2173c951ea3",
      "name": "Respond to Webhook3"
    },
    {
      "parameters": {
        "model": "mistral-large-latest",
        "options": {
          "temperature": 0.1
        }
      },
      "type": "@n8n/n8n-nodes-langchain.lmChatMistralCloud",
      "typeVersion": 1,
      "position": [
        -6016,
        5328
      ],
      "id": "91ecad12-b29b-4a82-8d90-27b50464b9ab",
      "name": "Mistral Cloud Chat Model1",
      "credentials": {
        "mistralCloudApi": {
          "id": "tDjuOnF6lpADMmd5",
          "name": "Mistral Cloud account"
        }
      }
    },
    {
      "parameters": {
        "useCustomSchema": true,
        "schema": "public",
        "operation": "get",
        "tableId": "projects",
        "filters": {
          "conditions": [
            {
              "keyName": "id",
              "keyValue": "={{ $('Edit Fields').first().json.project_id }}"
            }
          ]
        }
      },
      "id": "c0cd0d6b-4da6-40e8-8159-fa836aab0bcc",
      "name": "Fetch Project Context Email",
      "type": "n8n-nodes-base.supabase",
      "typeVersion": 1,
      "position": [
        -6352,
        5120
      ],
      "credentials": {
        "supabaseApi": {
          "id": "pI4CpdYLTiEEBmnz",
          "name": "Supabase account"
        }
      }
    },
    {
      "parameters": {
        "useCustomSchema": true,
        "schema": "public",
        "operation": "getAll",
        "tableId": "rfq_items_master",
        "returnAll": true,
        "matchType": "allFilters",
        "filters": {
          "conditions": [
            {
              "keyName": "evaluation_type",
              "condition": "eq",
              "keyValue": "={{ $json.tipo_evaluacion_actual }}"
            },
            {
              "keyName": "project_id",
              "condition": "eq",
              "keyValue": "={{ $('Set File ID').first().json.project_id }}"
            }
          ]
        }
      },
      "type": "n8n-nodes-base.supabase",
      "typeVersion": 1,
      "position": [
        -3936,
        3984
      ],
      "id": "ca86f0e2-e5eb-4bd5-8e24-9c452946f148",
      "name": "Get many rows1",
      "credentials": {
        "supabaseApi": {
          "id": "pI4CpdYLTiEEBmnz",
          "name": "Supabase account"
        }
      }
    },
    {
      "parameters": {
        "model": "qwen3-embedding:8b"
      },
      "type": "@n8n/n8n-nodes-langchain.embeddingsOllama",
      "typeVersion": 1,
      "position": [
        -896,
        5088
      ],
      "id": "864990fa-e90a-4293-9b52-9ef7a70e9c6d",
      "name": "Embeddings Ollama3",
      "credentials": {
        "ollamaApi": {
          "id": "oS2Qqti9oVfsm8XZ",
          "name": "Ollama account"
        }
      }
    },
    {
      "parameters": {
        "promptType": "define",
        "text": "=### DOCUMENT AUDIT: CROSS-VALIDATION\n\n**[1. USER MANUAL SELECTION]**\n- Project: \"{{ $('Set File ID').item.json.proyect_name }}\"\n- Provider: \"{{ $('Set File ID').item.json.proveedor }}\"\n- Evaluation Type: \"{{ $('Set File ID').item.json.evaluation }}\"\n- File Name: \"{{ $('Set File ID').item.json.file_title }}\"\n\n---\n**[2. ACTUAL PDF EVIDENCE (Extracted text)]**\n{{ $json.texto_muestra }}\n\n---\n### MAPPING AND VALIDATION INSTRUCTIONS:\n\n#### RULE 1: SYNONYMS AND CANONICAL TYPES\nYou can only use these 4 exact names. Map the evidence as follows:\n- **\"Commercial Proposal\" / \"Oferta EconÃ³mica\" / \"Price Schedule\"** â†’ MUST BE `Economical Evaluation`.\n- **\"Technical Proposal\" / \"Scope of Work\" / \"MetodologÃ­a\"** â†’ MUST BE `Technical Evaluation`.\n- **\"Technical & Economical Proposal\"** â†’ MUST INCLUDE BOTH: `Technical Evaluation` AND `Economical Evaluation`.\n- **Drawing lists** â†’ `Pre-FEED Deliverables` or `FEED Deliverables`.\n\n#### RULE 2: TITLE AND FILE NAME ARE DECISIVE\n- Analyze the **File Name** and **Title** of the document. If they say \"Oferta TÃ©cnica\" or \"Technical Proposal\", the type is `Technical Evaluation`.\n- **IMPORTANT:** DO NOT add other types for minor mentions. Example: If a technical document mentions \"estimated prices\", DO NOT add `Economical Evaluation`. Only add it if you see a complete PRICE TABLE.\n- Be conservative: when in doubt, follow the File Name.\n\n#### RULE 3: INTENTION BALANCING\n- If the PDF is mixed but the user has selected one of the valid types present, mark `tipos_validados: true`.\n\n### OUTPUT FORMAT (SINGLE JSON):\n{\n  \"modo_usado\": \"VALIDADOR\",\n  \"proyecto_detectado\": \"Actual Name\",\n  \"proyecto_valido\": true | false,\n  \"proyecto_nota\": \"Summary\",\n  \"proveedor_detectado\": \"IDOM | SENER | TRESCA | SACYR | TECNICASREUNIDAS | EA | WORLEY\",\n  \"proveedor_valido\": true | false,\n  \"proveedor_nota\": \"Explanation\",\n  \"tipos_detectados\": [\"Technical Evaluation\", \"Economical Evaluation\", \"Pre-FEED Deliverables\", \"FEED Deliverables\"],\n  \"tipos_validados\": true | false,\n  \"tipos_nota\": \"Explain why you validated or rejected the types.\",\n  \"razonamiento\": \"Mention the File Name and Title found.\"\n}",
        "hasOutputParser": true,
        "messages": {
          "messageValues": [
            {
              "message": "=Act as a strict validator. If there are flagrant discrepancies between the user's suggestion and the actual PDF content, prioritize the PDF content and mark validation as false and report the correct provider/type.\n\nSupported providers: Tecnicas Reunidas, IDOM, SACYR, Empresarios Agrupados, SENER, TRESCA, WORLEY"
            }
          ]
        },
        "batching": {}
      },
      "type": "@n8n/n8n-nodes-langchain.chainLlm",
      "typeVersion": 1.8,
      "position": [
        -1392,
        4624
      ],
      "id": "89a8a43a-1f92-4db0-ae83-a6c5d238fd33",
      "name": "Validador de Ofertas"
    },
    {
      "parameters": {
        "model": "mistral:7b",
        "options": {
          "temperature": 0.1,
          "numCtx": 4096,
          "numPredict": 1024
        }
      },
      "type": "@n8n/n8n-nodes-langchain.lmChatOllama",
      "typeVersion": 1,
      "position": [
        -1440,
        4816
      ],
      "id": "ddf01374-8b84-40c7-bc5b-7b320a8d5ac7",
      "name": "Ollama Chat Model1",
      "credentials": {
        "ollamaApi": {
          "id": "oS2Qqti9oVfsm8XZ",
          "name": "Ollama account"
        }
      }
    },
    {
      "parameters": {
        "schemaType": "manual",
        "inputSchema": "{\n  \"type\": \"object\",\n  \"properties\": {\n    \"modo_usado\": {\n      \"type\": \"string\"\n    },\n    \"proyecto_detectado\": {\n      \"type\": \"string\"\n    },\n    \"proyecto_valido\": {\n      \"type\": \"boolean\"\n    },\n    \"proyecto_nota\": {\n      \"type\": \"string\"\n    },\n    \"proveedor_detectado\": {\n      \"type\": \"string\"\n    },\n    \"proveedor_valido\": {\n      \"type\": \"boolean\",\n      \"description\": \"DEBE ser false si el proveedor detectado es distinto al que el usuario seleccionÃ³.\"\n    },\n    \"proveedor_nota\": {\n      \"type\": \"string\"\n    },\n    \"tipos_detectados\": {\n      \"type\": \"array\",\n      \"items\": {\n        \"type\": \"string\"\n      },\n      \"description\": \"Array con los tipos que realmente tienen evidencia en el doc.\"\n    },\n    \"tipos_validados\": {\n      \"type\": \"boolean\",\n      \"description\": \"DEBE ser false si el tipo seleccionado por el usuario no tiene evidencia clara en el PDF.\"\n    },\n    \"tipos_nota\": {\n      \"type\": \"string\"\n    },\n    \"razonamiento\": {\n      \"type\": \"string\"\n    }\n  },\n  \"required\": [\n    \"proyecto_detectado\",\n    \"proyecto_valido\",\n    \"proveedor_detectado\",\n    \"proveedor_valido\",\n    \"tipos_validados\",\n    \"razonamiento\"\n  ]\n}"
      },
      "type": "@n8n/n8n-nodes-langchain.outputParserStructured",
      "typeVersion": 1.3,
      "position": [
        -1200,
        4816
      ],
      "id": "8cefb503-12fd-4aa4-b202-3256b313c01e",
      "name": "Structured Output Parser4"
    },
    {
      "parameters": {
        "promptType": "define",
        "text": "=### TECHNICAL AND COMMERCIAL CLASSIFICATION (RFQ)\n\n### DOCUMENT SAMPLE (First 2 pages):\n{{ $json.texto_muestra }}\n\n---\n### CLASSIFICATION TASK:\nIdentify project, provider and evaluation types.\n\n**GOLDEN RULE FOR NOMENCLATURE:**\nYou must translate document titles to these exact names:\n- **\"Commercial Proposal\" / \"Oferta EconÃ³mica\"** â†’ MUST BE `Economical Evaluation`.\n- **\"Technical Proposal\" / \"Scope of Work\"** â†’ MUST BE `Technical Evaluation`.\n- **Document lists** â†’ `Pre-FEED Deliverables` or `FEED Deliverables` (depending on context).\n\n#### REQUIREMENTS:\n1. **PROVIDER**: Must be one of: IDOM, SENER, TRESCA, SACYR, TECNICASREUNIDAS, EA, WORLEY.\n2. **TYPES**: The `tipos_detectados` array can only contain the canonical names mentioned above.\n\n---\n### OUTPUT FORMAT (JSON):\n{\n  \"modo_usado\": \"CLASIFICADOR\",\n  \"proyecto_detectado\": \"Name\",\n  \"proveedor_detectado\": \"IDOM | SENER | TRESCA | SACYR | TECNICASREUNIDAS | EA | WORLEY\",\n  \"tipos_detectados\": [\"Technical Evaluation\", \"Economical Evaluation\"],\n  \"razonamiento\": \"Justification: 'Commercial Proposal' detected -> Economical Evaluation mapped.\"\n}",
        "hasOutputParser": true,
        "messages": {
          "messageValues": [
            {
              "message": "Identify the provider and evaluation types present in the document based only on the first pages."
            }
          ]
        },
        "batching": {}
      },
      "type": "@n8n/n8n-nodes-langchain.chainLlm",
      "typeVersion": 1.8,
      "position": [
        -1392,
        5056
      ],
      "id": "ca9c7627-a9cb-4c0a-a92a-1c8016242c51",
      "name": "Clasificador de Tipo de Evaluacion y Proveedor"
    },
    {
      "parameters": {
        "conditions": {
          "options": {
            "caseSensitive": true,
            "leftValue": "",
            "typeValidation": "strict",
            "version": 3
          },
          "conditions": [
            {
              "id": "267128b5-e2c0-44ae-9973-7f18dffe292e",
              "leftValue": "={{ $('Set File ID').item.json.proveedor }}",
              "rightValue": "",
              "operator": {
                "type": "string",
                "operation": "notEmpty",
                "singleValue": true
              }
            },
            {
              "id": "a9d65ff4-430e-45db-8ca8-6078e5ee32fa",
              "leftValue": "={{ $('Set File ID').item.json.evaluation[0] }}",
              "rightValue": "",
              "operator": {
                "type": "string",
                "operation": "notEmpty",
                "singleValue": true
              }
            },
            {
              "id": "d5c265e7-00e5-42f4-95ad-4eca1e3ef530",
              "leftValue": "={{ $('Set File ID').item.json.proyect_name }}",
              "rightValue": "",
              "operator": {
                "type": "string",
                "operation": "notEmpty",
                "singleValue": true
              }
            }
          ],
          "combinator": "and"
        },
        "options": {}
      },
      "type": "n8n-nodes-base.if",
      "typeVersion": 2.3,
      "position": [
        -1664,
        4816
      ],
      "id": "92e51aa1-7c7e-4175-b53f-df10ea4f9e56",
      "name": "If"
    },
    {
      "parameters": {
        "model": "qwen3:8b",
        "options": {
          "temperature": 0.1,
          "numCtx": 8192,
          "numPredict": 1536
        }
      },
      "type": "@n8n/n8n-nodes-langchain.lmOllama",
      "typeVersion": 1,
      "position": [
        -1680,
        4256
      ],
      "id": "3971e1b7-b4f3-445c-9dab-07dfdb51dd61",
      "name": "Ollama Model1",
      "credentials": {
        "ollamaApi": {
          "id": "oS2Qqti9oVfsm8XZ",
          "name": "Ollama account"
        }
      }
    },
    {
      "parameters": {
        "model": "mistral:7b",
        "options": {
          "temperature": 0.1,
          "numCtx": 4096,
          "numPredict": 1024
        }
      },
      "type": "@n8n/n8n-nodes-langchain.lmOllama",
      "typeVersion": 1,
      "position": [
        -1440,
        5264
      ],
      "id": "63d763a9-6651-4f63-a0d4-4071656bc429",
      "name": "Ollama Model",
      "credentials": {
        "ollamaApi": {
          "id": "oS2Qqti9oVfsm8XZ",
          "name": "Ollama account"
        }
      }
    },
    {
      "parameters": {
        "content": "### Ingesta de Ofertas de Proveedores",
        "height": 1744,
        "width": 4608,
        "color": 5
      },
      "type": "n8n-nodes-base.stickyNote",
      "typeVersion": 1,
      "position": [
        -4912,
        3664
      ],
      "id": "21c91ca2-3d2b-4316-9102-bb6aea60fcd1",
      "name": "Sticky Note5"
    },
    {
      "parameters": {
        "batchSize": 50,
        "options": {
          "reset": "={{ $json.reiniciar_bucle ? true : false }}"
        }
      },
      "type": "n8n-nodes-base.splitInBatches",
      "typeVersion": 3,
      "position": [
        -3104,
        4048
      ],
      "id": "d2834f44-0806-4e87-817d-014543e91e75",
      "name": "Loop Over Phases"
    },
    {
      "parameters": {
        "jsCode": "// =============================================\n// NODO: Parsear y Preparar Update (con merge inteligente)\n// =============================================\n\n// Valores que indican 'sin datos' - no deben sobreescribir datos reales\nconst NO_DATA_VALUES = new Set(['NO INFORMATION', 'NOT QUOTED', 'NO COTIZADO', 'SIN INFORMACIÃ“N', 'ERROR ANALISIS']);\n\n// 1. Obtener TODOS los items del LLM Chain\nconst allItems = $input.all();\nconsole.log(`ðŸ“¥ Procesando ${allItems.length} respuestas del LLM`);\n\n// 2. Obtener la lista de requisitos VÃLIDOS (para validar FK)\nlet validRequirements = [];\ntry {\n  const getRowsData = $('Get many rows1').all();\n  validRequirements = getRowsData.map(item => item.json.id);\n  console.log(`âœ… Lista de requisitos vÃ¡lidos: ${validRequirements.length} items`);\n} catch(e) {\n  console.error('âŒ Error obteniendo lista de requisitos vÃ¡lidos:', e.message);\n  return [];\n}\n\n// 3. Obtener el provider name (una sola vez, es el mismo para todos)\nlet providerName = \"OTROS\";\ntry {\n  providerName = $('Expandir por Tipo de EvaluaciÃ³n').first().json.proveedor_detectado || \"OTROS\";\n} catch(e) {\n  console.warn('âš ï¸ Error obteniendo provider, usando default:', e.message);\n}\n\n// 4. Procesar CADA respuesta del LLM\nconst resultados = [];\nlet skippedNoData = 0;\n\nfor (let i = 0; i < allItems.length; i++) {\n  try {\n    const item = allItems[i];\n    const itemData = item.json || item;\n\n    let rawText = itemData.text || itemData.output || \"\";\n\n    if (!rawText || typeof rawText !== 'string') {\n      console.warn(`âš ï¸ Item ${i}: No se encontrÃ³ campo 'text' o 'output'`);\n      continue;\n    }\n\n    let cleanText = rawText\n      .replace(/```json/g, '')\n      .replace(/```/g, '')\n      .trim();\n\n    let parsedData = null;\n\n    try {\n      const start = cleanText.indexOf('[');\n      const end = cleanText.lastIndexOf(']');\n\n      if (start >= 0 && end >= 0 && end > start) {\n        const jsonString = cleanText.substring(start, end + 1);\n        parsedData = JSON.parse(jsonString);\n      } else {\n        parsedData = JSON.parse(cleanText);\n      }\n    } catch (parseError) {\n      console.error(`âŒ Error parseando JSON del item ${i}:`, parseError.message);\n      console.error(`Texto recibido:`, cleanText.substring(0, 200));\n      continue;\n    }\n\n    const outputArray = Array.isArray(parsedData) ? parsedData : [parsedData];\n\n    for (let j = 0; j < outputArray.length; j++) {\n      const outputItem = outputArray[j];\n\n      if (!outputItem || typeof outputItem !== 'object') {\n        console.warn(`âš ï¸ Item ${i}.${j}: Elemento de salida no es objeto`);\n        continue;\n      }\n\n      const cumple = outputItem?.cumple || \"ERROR ANALISIS\";\n      const gap = outputItem?.gap_analysis || \"Check logs\";\n      const score = outputItem?.score !== undefined ? outputItem.score : 0;\n      const requirementId = outputItem?.id || null;\n\n      const validatedScore = Math.max(0, Math.min(10, parseInt(score) || 0));\n\n      if (!requirementId) {\n        console.error(`âŒ Item ${i}.${j}: No se encontrÃ³ ID del requisito en la respuesta del LLM`);\n        continue;\n      }\n\n      if (!validRequirements.includes(requirementId)) {\n        console.error(`âŒ Item ${i}.${j}: El requirement_id ${requirementId} NO existe en rfq_items_master. Saltando...`);\n        continue;\n      }\n\n      // MERGE INTELIGENTE: Filtrar items sin datos para no sobreescribir evaluaciones reales\n      if (NO_DATA_VALUES.has(cumple.toUpperCase())) {\n        skippedNoData++;\n        continue;\n      }\n\n      console.log(`âœ… Item ${i}.${j}: Requisito ${requirementId} - ${cumple} (${validatedScore}/10)`);\n\n      resultados.push({\n        json: {\n          requirement_id: requirementId,\n          provider_name: providerName,\n          evaluation_value: cumple,\n          comment: gap,\n          score: validatedScore\n        }\n      });\n    }\n\n  } catch (error) {\n    console.error(`âŒ Error procesando item ${i}:`, error.message);\n    continue;\n  }\n}\n\nconsole.log(`âœ… Procesados ${resultados.length} de ${allItems.length} items exitosamente (${skippedNoData} sin datos filtrados)`);\n\nreturn resultados;"
      },
      "id": "e053364d-1fc9-4b22-89cb-4a5e56c6f1fb",
      "name": "Parsear y Preparar Update",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        -1152,
        4032
      ]
    },
    {
      "parameters": {
        "promptType": "define",
        "text": "=### GRUPO DE EVALUACIÃ“N\n- Tipo: {{ $json.evaluation_type }}\n- Total requisitos en este lote: {{ $json.total_requisitos }}\n- Lote: {{ $json.batch_index }} de {{ $json.total_batches }}\n\n### IDIOMA DE RESPUESTA: {{ $('Set File ID').first().json.language === 'en' ? 'ENGLISH' : 'ESPAÃ‘OL' }}\n**IMPORTANTE**: {{ $('Set File ID').first().json.language === 'en' ? 'Respond ALWAYS in English. All gap_analysis fields must be in English. Use labels: INCLUDED, PARTIALLY INCLUDED, NOT INCLUDED, NO INFORMATION.' : 'Responde SIEMPRE en espaÃ±ol. Todos los campos gap_analysis deben estar en espaÃ±ol. Usa etiquetas: INCLUIDO, PARCIALMENTE INCLUIDO, NO INCLUIDO, SIN INFORMACIÃ“N.' }}\n\n### REQUISITOS DEL RFQ (LISTA)\nA continuaciÃ³n los requisitos del RFQ a evaluar. Cada uno tiene un 'id' y un 'requirement_text' que describe lo que el proveedor debe cumplir.\n\n{{ JSON.stringify($json.requisitos, null, 2) }}\n\n### TEXTO COMPLETO DE LA PROPUESTA\n\n{{ $('Loop Over Items1').first().json.texto_oferta_completo }}\n---\n### TAREA\nPara CADA requisito, busca en el texto de la propuesta y determina si el proveedor lo aborda.\n\n### CRITERIOS DE EVALUACIÃ“N PARA REQUISITOS TÃ‰CNICOS:\n\n**INCLUIDO** - Usar cuando CUALQUIERA de estos aplique:\n- La propuesta menciona o aborda explÃ­citamente el requisito\n- La propuesta describe trabajo, metodologÃ­a o entregables que cubren este requisito\n- La propuesta referencia normas, estÃ¡ndares o cÃ³digos aplicables al requisito\n- La propuesta incluye este elemento en su alcance de trabajo, aunque lo describa de forma diferente\n- El requisito estÃ¡ cubierto implÃ­citamente por declaraciones mÃ¡s amplias (ej: 'servicios completos de ingenierÃ­a' cubre disciplinas individuales)\n\n**PARCIALMENTE INCLUIDO** - Usar cuando:\n- La propuesta menciona el tema pero con menos detalle o alcance del requerido\n- Solo parte del requisito estÃ¡ abordada\n- La propuesta lo menciona como opcional o condicional\n- Se describe trabajo relacionado pero no este elemento especÃ­fico\n\n**NO INCLUIDO** - Usar SOLO cuando:\n- NO hay menciÃ³n ni referencia a este requisito en ningÃºn lugar de la propuesta\n- La propuesta excluye explÃ­citamente este elemento\n- Tras bÃºsqueda exhaustiva, nada en la propuesta se relaciona con este requisito\n\n### GUÃAS IMPORTANTES DE MATCHING:\n- Busca coincidencias SEMÃNTICAS, no solo texto exacto. Las propuestas usan terminologÃ­a diferente al RFQ.\n- Una propuesta que dice 'entregaremos todos los documentos de ingenierÃ­a por disciplina' cubre requisitos individuales de documentos.\n- Considera que las propuestas a menudo agrupan elementos de forma diferente a como los lista el RFQ.\n- En caso de duda entre INCLUIDO y PARCIALMENTE INCLUIDO, elige INCLUIDO.\n- En caso de duda entre PARCIALMENTE INCLUIDO y NO INCLUIDO, elige PARCIALMENTE INCLUIDO.\n- Las propuestas reales tÃ­picamente abordan 60-80% de los requisitos. Si encuentras menos de 40% INCLUIDO, reconsidera tus criterios de matching.\n\n### PARA EVALUACIONES ECONÃ“MICAS - EXTRAER EL VALOR REAL:\n**CRÃTICO**: Para Ã­tems econÃ³micos, el campo 'cumple' debe contener el VALOR REAL encontrado, no una etiqueta.\n\nFormato del campo 'cumple':\n- Si se encuentra valor: \"[VALOR] [MONEDA/UNIDAD] - [DESCRIPCIÃ“N]\"\n  Ejemplos:\n  - \"84,3 EUR/h - TARIFA (Process, Mechanical, Piping)\"\n  - \"312.640,62 EUR - COTIZACIÃ“N BASE TOTAL PRE-FEED\"\n  - \"5.231,21 EUR - Estudio geotÃ©cnico - Confirmado\"\n\n- Si NO se encuentra valor: \"SIN INFORMACIÃ“N - [RAZÃ“N]\"\n\n### FORMATO DE SALIDA (JSON)\n[\n  {\n    \"id\": \"<id del requisito>\",\n    \"cumple\": \"{{ $('Set File ID').first().json.language === 'en' ? '[Technical: INCLUDED/PARTIALLY INCLUDED/NOT INCLUDED | Economic: VALUE or NO INFORMATION]' : '[TÃ©cnicos: INCLUIDO/PARCIALMENTE INCLUIDO/NO INCLUIDO | EconÃ³micos: VALOR o SIN INFORMACIÃ“N]' }}\",\n    \"gap_analysis\": \"{{ $('Set File ID').first().json.language === 'en' ? '[Brief quote or evidence from proposal in ENGLISH, or No mention found]' : '[Cita breve o evidencia de la propuesta EN ESPAÃ‘OL, o No se encontrÃ³ menciÃ³n]' }}\"\n  }\n]\n\nSolo JSON, sin explicaciones.",
        "messages": {
          "messageValues": [
            {
              "message": "=You are an expert procurement evaluator analyzing supplier proposals against RFQ/RFP requirements.\n\nLANGUAGE: {{ $('Set File ID').first().json.language === 'en' ? 'ENGLISH' : 'SPANISH' }}\n\nRULES:\n- For TECHNICAL: Use labels {{ $('Set File ID').first().json.language === 'en' ? 'INCLUDED, PARTIALLY INCLUDED, or NOT INCLUDED' : 'INCLUIDO, PARCIALMENTE INCLUIDO, or NO INCLUIDO' }}\n- For ECONOMICAL: Extract ACTUAL VALUES with currency/units. If no value found: '{{ $('Set File ID').first().json.language === 'en' ? 'NO INFORMATION' : 'SIN INFORMACIÃ“N' }}'\n- Look for SEMANTIC matches - proposals often use different terminology than the RFQ\n- Be thorough: search the ENTIRE proposal text for each requirement before marking NOT INCLUDED\n- A well-prepared proposal typically addresses most requirements. If your analysis shows very few INCLUDED, you may be matching too strictly.\n- ALL responses in {{ $('Set File ID').first().json.language === 'en' ? 'ENGLISH' : 'SPANISH' }}\n- JSON only"
            }
          ]
        },
        "batching": {}
      },
      "type": "@n8n/n8n-nodes-langchain.chainLlm",
      "typeVersion": 1.7,
      "position": [
        -1600,
        3904
      ],
      "id": "b36929ff-0937-4297-9419-7b800b1b0790",
      "name": "LLM Chain"
    },
    {
      "parameters": {
        "operation": "upsert",
        "schema": {
          "__rl": true,
          "mode": "list",
          "value": "public"
        },
        "table": {
          "__rl": true,
          "value": "document_metadata",
          "mode": "list",
          "cachedResultName": "document_metadata"
        },
        "columns": {
          "mappingMode": "defineBelow",
          "value": {
            "id": "={{ $('Set File ID').first().json.file_id }}",
            "title": "={{ $('Set File ID').item.json.file_title }}",
            "project_id": "={{ $('Set File ID').item.json.project_id }}",
            "evaluation_types": "={{ $('Set File ID').item.json.evaluation }}",
            "document_type": "PROPOSAL",
            "provider": "={{ $('Set File ID').item.json.proveedor }}"
          },
          "matchingColumns": [
            "id"
          ],
          "schema": [
            {
              "id": "id",
              "displayName": "id",
              "required": true,
              "defaultMatch": true,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            },
            {
              "id": "title",
              "displayName": "title",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            },
            {
              "id": "project_id",
              "displayName": "project_id",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            },
            {
              "id": "document_type",
              "displayName": "document_type",
              "required": true,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": false
            },
            {
              "id": "provider",
              "displayName": "provider",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": false
            },
            {
              "id": "evaluation_types",
              "displayName": "evaluation_types",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "array",
              "canBeUsedToMatch": true,
              "removed": false
            },
            {
              "id": "created_at",
              "displayName": "created_at",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "dateTime",
              "canBeUsedToMatch": true,
              "removed": false
            }
          ],
          "attemptToConvertTypes": false,
          "convertFieldsToString": false
        },
        "options": {}
      },
      "type": "n8n-nodes-base.postgres",
      "typeVersion": 2.5,
      "position": [
        -3904,
        4816
      ],
      "id": "7f9e0bb6-4ad9-4525-a172-9d442f4759a9",
      "name": "Insert Document Metadata",
      "executeOnce": true,
      "credentials": {
        "postgres": {
          "id": "V0REAPph5JBLqze3",
          "name": "Postgres account"
        }
      }
    },
    {
      "parameters": {
        "useCustomSchema": true,
        "schema": "public",
        "operation": "delete",
        "tableId": "proposals",
        "filterType": "string",
        "filterString": "=metadata->>file_id=like.*{{ $json.file_id }}*"
      },
      "id": "1ebb771b-4d2f-4229-84f9-4260d763b6a7",
      "name": "Delete Old Doc Rows",
      "type": "n8n-nodes-base.supabase",
      "typeVersion": 1,
      "position": [
        -4112,
        4816
      ],
      "alwaysOutputData": true,
      "credentials": {
        "supabaseApi": {
          "id": "pI4CpdYLTiEEBmnz",
          "name": "Supabase account"
        }
      }
    },
    {
      "parameters": {
        "assignments": {
          "assignments": [
            {
              "id": "10646eae-ae46-4327-a4dc-9987c2d76173",
              "name": "file_id",
              "value": "={{ $json.body.file_id }}",
              "type": "string"
            },
            {
              "id": "77d782de-169d-4a46-8a8e-a3831c04d90f",
              "name": "file_title",
              "value": "={{ $json.body.file_title }}",
              "type": "string"
            },
            {
              "id": "9bde4d7f-e4f3-4ebd-9338-dce1350f9eab",
              "name": "file_url",
              "value": "={{ $json.body.file_url }}",
              "type": "string"
            },
            {
              "id": "b1dbe9b9-248a-4593-a769-a085b34e0810",
              "name": "file_binary",
              "value": "={{ $json.body.file_binary }}",
              "type": "string"
            },
            {
              "id": "74d93dce-cddc-4947-ae19-88bc5cacd146",
              "name": "file_metadata",
              "value": "={{ $json.body.metadata }}",
              "type": "string"
            },
            {
              "id": "5e43f8d4-b48e-4188-89c8-3723f184dbeb",
              "name": "proyect_name",
              "value": "={{ $json.body.metadata.proyecto }}",
              "type": "string"
            },
            {
              "id": "1093ebc6-8dd8-4c5d-b146-b6f01b069be6",
              "name": "proveedor",
              "value": "={{ $json.body.user_proveedor }}",
              "type": "string"
            },
            {
              "id": "6e0e6e2a-9b88-403e-aa0a-da0eecccd3f9",
              "name": "evaluation",
              "value": "={{ $json.body.metadata.tipoEvaluacion }}",
              "type": "array"
            },
            {
              "id": "project-id-uuid-field",
              "name": "project_id",
              "value": "={{ $json.body.project_id }}",
              "type": "string"
            },
            {
              "id": "language-field-001",
              "name": "language",
              "value": "={{ $json.body.language || 'es' }}",
              "type": "string"
            },
            {
              "id": "currency-field-001",
              "name": "currency",
              "value": "={{ $json.body.currency || 'EUR' }}",
              "type": "string"
            }
          ]
        },
        "options": {}
      },
      "id": "317fddf0-100d-4c08-abef-bc3e4a3136cc",
      "name": "Set File ID",
      "type": "n8n-nodes-base.set",
      "typeVersion": 3.4,
      "position": [
        -4304,
        4816
      ]
    },
    {
      "parameters": {
        "jsonMode": "expressionData",
        "jsonData": "={{ $json.text }}",
        "options": {
          "metadata": {
            "metadataValues": [
              {
                "name": "file_id",
                "value": "={{ $json.metadata.file_id }}"
              },
              {
                "name": "file_title",
                "value": "={{ $json.metadata.file_title }}"
              },
              {
                "name": "tipo_evaluacion",
                "value": "={{ $json.metadata.tipo_evaluacion }}"
              },
              {
                "name": "proveedor",
                "value": "={{ $json.metadata.proveedor }}"
              },
              {
                "name": "project_name",
                "value": "={{ $json.metadata.project_name }}"
              },
              {
                "name": "project_id",
                "value": "={{ $json.metadata.project_id }}"
              }
            ]
          }
        }
      },
      "id": "fac104ac-7be3-4e3f-87eb-96bde7dc18d1",
      "name": "Default Data Loader",
      "type": "@n8n/n8n-nodes-langchain.documentDefaultDataLoader",
      "typeVersion": 1,
      "position": [
        -688,
        5120
      ]
    },
    {
      "parameters": {
        "chunkSize": 1200,
        "chunkOverlap": 200,
        "options": {}
      },
      "type": "@n8n/n8n-nodes-langchain.textSplitterRecursiveCharacterTextSplitter",
      "typeVersion": 1,
      "position": [
        -784,
        5296
      ],
      "id": "9f686263-e89a-4a1f-a11a-9c17635d6a2b",
      "name": "Recursive Character Text Splitter"
    },
    {
      "parameters": {
        "mode": "insert",
        "tableName": {
          "__rl": true,
          "value": "proposals",
          "mode": "list",
          "cachedResultName": "proposals"
        },
        "options": {
          "queryName": "match_proposals"
        }
      },
      "id": "0bee0e20-d47b-4773-928b-262780076f82",
      "name": "Insert into Supabase Vectorstore",
      "type": "@n8n/n8n-nodes-langchain.vectorStoreSupabase",
      "typeVersion": 1,
      "position": [
        -816,
        4800
      ],
      "credentials": {
        "supabaseApi": {
          "id": "pI4CpdYLTiEEBmnz",
          "name": "Supabase account"
        }
      },
      "disabled": true
    },
    {
      "parameters": {
        "jsCode": "// =============================================\n// NODO: Validar Contenido PDF (FIX PAGINACIÃ“N)\n// =============================================\n\nconst input = $input.first().json;\n\n// Variables de inicializaciÃ³n\nlet pages = [];\nlet totalChars = 0;\nlet hasTablesDetected = false;\n\n// --- 1. PROCESAMIENTO DEL TEXTO ---\n\n// CASO A: Viene desglosado por pÃ¡ginas (Array)\nif (input.pages && Array.isArray(input.pages) && input.pages.length > 0) {\n  pages = input.pages;\n  pages.forEach(page => {\n    const text = page.text || page.pageContent || \"\";\n    totalChars += text.length;\n    // DetecciÃ³n simple de tablas\n    if ((text.match(/\\s{4,}/g) || []).length > 5) hasTablesDetected = true;\n  });\n\n// CASO B: Viene todo el texto junto (String) - ESTE ES TU CASO ACTUAL\n} else if (input.text && typeof input.text === 'string') {\n  const text = input.text;\n  totalChars = text.length;\n  // Creamos una \"pÃ¡gina Ãºnica\" contenedora para no romper el flujo\n  pages = [{ text: text, pageNumber: 1 }];\n  \n  // Detectar tablas en el texto completo\n  if ((text.match(/\\s{4,}/g) || []).length > 20) hasTablesDetected = true;\n  \n} else {\n  // CASO C: VacÃ­o\n  pages = [];\n}\n\n// --- 2. CÃLCULO DE PÃGINAS REALES (FIX CRÃTICO) ---\n\n// Intentamos leer el metadato 'numpages' que se ve en tu captura\nlet realPageCount = input.numpages || input.numPages || input.numberOfPages || 0;\n\n// Si no existe el metadato, usamos la longitud del array (fallback)\nif (!realPageCount || realPageCount === 0) {\n    realPageCount = pages.length;\n}\n\n// Si sigue siendo 1 pero el texto es enorme (>10k chars), estimamos\nif (realPageCount <= 1 && totalChars > 10000) {\n    // EstimaciÃ³n conservadora: 3000 caracteres por pÃ¡gina tÃ©cnica\n    realPageCount = Math.ceil(totalChars / 3000);\n}\n\n// Evitar divisiÃ³n por cero\nrealPageCount = Math.max(1, realPageCount);\n\n\n// --- 3. MÃ‰TRICAS FINALES ---\n\nconst avgCharsPerPage = totalChars / realPageCount;\n\n// CRITERIO: Â¿Necesita OCR?\n// Si hay texto (< 100 chars/pag) es probable que sea escaneado.\nconst needsOCR = avgCharsPerPage < 100; \n\n// Metadatos\nlet fileId = \"unknown\";\nlet fileTitle = \"unknown\";\ntry {\n  const metaNode = $('Set File ID').first().json;\n  fileId = metaNode.file_id;\n  fileTitle = metaNode.file_title;\n} catch (e) {}\n\n// --- LOGGING ---\nconsole.log(`ðŸ“„ AnÃ¡lisis: ${fileTitle}`);\nconsole.log(`   â”œâ”€ PÃ¡ginas (Metadato): ${input.numpages}`); \nconsole.log(`   â”œâ”€ PÃ¡ginas (Usadas): ${realPageCount}`);\nconsole.log(`   â”œâ”€ Caracteres Totales: ${totalChars}`);\nconsole.log(`   â”œâ”€ Promedio/PÃ¡g: ${Math.round(avgCharsPerPage)}`);\n\nreturn {\n  json: {\n    // MÃ©tricas corregidas\n    totalPages: realPageCount, // Ahora dirÃ¡ 235\n    totalChars: totalChars,\n    avgCharsPerPage: Math.round(avgCharsPerPage), // Ahora serÃ¡ un nÃºmero razonable (~2800)\n    hasTables: hasTablesDetected,\n    needsOCR: needsOCR,\n    \n    // Contenido\n    pages: pages, \n    \n    // Metadatos\n    fileId: fileId,\n    fileName: fileTitle\n  }\n};"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        -3232,
        4816
      ],
      "id": "443a9ce5-3462-4831-a89c-aa4718d6db25",
      "name": "Validar Contenido PDF"
    },
    {
      "parameters": {
        "operation": "pdf",
        "options": {}
      },
      "type": "n8n-nodes-base.extractFromFile",
      "typeVersion": 1.1,
      "position": [
        -3504,
        4816
      ],
      "id": "c299c9fb-fb79-4d0c-b5a7-00fa4fd4a648",
      "name": "Extract from File"
    },
    {
      "parameters": {
        "conditions": {
          "options": {
            "caseSensitive": true,
            "leftValue": "",
            "typeValidation": "strict",
            "version": 3
          },
          "conditions": [
            {
              "id": "57b9c551-9997-4ed5-8ddd-f80c108a177c",
              "leftValue": "={{ $json.needsOCR }}",
              "rightValue": "",
              "operator": {
                "type": "boolean",
                "operation": "true",
                "singleValue": true
              }
            }
          ],
          "combinator": "and"
        },
        "options": {}
      },
      "type": "n8n-nodes-base.if",
      "typeVersion": 2.3,
      "position": [
        -2944,
        4816
      ],
      "id": "e7eebfee-bbbd-4d9d-bdc8-6f4d16fe45c7",
      "name": "Â¿Necesita OCR?"
    },
    {
      "parameters": {
        "jsCode": "// =============================================\n// NODO: Aggregate OCR Pages (CORREGIDO)\n// =============================================\n\nconst items = $input.all();\nlet fullText = \"\";\nlet pagesArray = [];\n\n// OPCIÃ“N A: Si Tesseract devuelve mÃºltiples items (1 por pÃ¡gina)\nif (items.length > 1) {\n  items.forEach((item, idx) => {\n    const pageText = item.json.text || \"\";\n    fullText += pageText + \"\\n\\n\";\n    \n    // Construimos array compatible con vectorstore\n    pagesArray.push({\n      text: pageText,\n      pageNumber: idx + 1\n    });\n  });\n}\n// OPCIÃ“N B: Si Tesseract devuelve un solo item con todo el texto\nelse if (items.length === 1) {\n  fullText = items[0].json.text || \"\";\n  pagesArray = [{\n    text: fullText,\n    pageNumber: 1\n  }];\n}\n\n// RECUPERAR METADATOS ORIGINALES (CRÃTICO)\nlet fileId, fileName, proveedor;\ntry {\n  fileId = $('Set File ID').first().json.file_id;\n  fileName = $('Set File ID').first().json.file_title;\n  proveedor = $('Set File ID').first().json.proveedor || \"OTROS\";\n} catch (e) {\n  console.error(\"âš ï¸ No se pudieron recuperar metadatos:\", e.message);\n  fileId = \"unknown\";\n  fileName = \"unknown\";\n  proveedor = \"OTROS\";\n}\n\nconsole.log(`ðŸ”„ OCR Agregado: ${items.length} pÃ¡ginas â†’ ${fullText.length} caracteres`);\n\n// ESTRUCTURA COMPATIBLE CON VECTORSTORE\nreturn {\n  json: {\n    pages: pagesArray, // â† Array de pÃ¡ginas (requerido por Default Data Loader)\n    text: fullText, // â† Texto completo (backup)\n    \n    // Metadatos crÃ­ticos\n    file_id: fileId,\n    file_title: fileName,\n    proveedor: proveedor,\n    \n    // Marca de origen\n    origen_datos: \"OCR_TESSERACT\",\n    ocr_pages_processed: items.length,\n    ocr_total_chars: fullText.length\n  }\n};"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        -2304,
        4704
      ],
      "id": "fee0cf5a-4b6a-47cd-8a25-579d149fb616",
      "name": "Aggregate OCR Pages"
    },
    {
      "parameters": {
        "jsCode": "// =============================================\n// NODO: Preparar Texto de Muestra (STRICT LIMIT)\n// =============================================\n\nconst items = $input.all();\n\nreturn items.map(item => {\n    let texto_muestra = \"SIN TEXTO\";\n\n    try {\n        if (item.json.pages && Array.isArray(item.json.pages) && item.json.pages.length > 0) {\n            // Unimos las 2 primeras pÃ¡ginas pero limitamos el total a 3000 caracteres\n            let rawJoin = item.json.pages.slice(0, 2).map(p => p.text || \"\").join(\"\\n\\n\");\n            texto_muestra = rawJoin.substring(0, 3000);\n        } else {\n            // Fallback extremadamente corto para texto plano\n            texto_muestra = (item.json.text || \"\").substring(0, 500);\n        }\n    } catch (e) {\n        console.error(\"Error al procesar pÃ¡ginas:\", e);\n    }\n\n    return {\n        json: {\n            ...item.json,\n            texto_muestra: texto_muestra\n        }\n    };\n});"
      },
      "id": "45746bbf-5304-41d6-9c2a-8e9298d43e46",
      "name": "Preparar Texto de Muestra",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        -1856,
        4816
      ]
    },
    {
      "parameters": {
        "jsCode": "// =============================================\n// NODO: Format for Vectorstore (v3 - DIRECTO DEL USUARIO)\n// SIN clasificador ni validador LLM\n// =============================================\n\n// 1. RECUPERAR CONTENIDO\nlet fullText = \"\";\nlet totalPages = 1;\n\ntry {\n    const mergeData = $('Merge1').first().json;\n    if (mergeData.pages && mergeData.pages[0]) {\n        fullText = mergeData.pages.slice(0, 2).map(p => p.text || \"\").join(\"\\n\\n\");\n    } else {\n        fullText = mergeData.text || \"\";\n    }\n    totalPages = mergeData.totalPages || 1;\n} catch (e) {\n    console.log(\"âŒ Error leyendo de Merge1\");\n}\n\n// 2. USAR DIRECTAMENTE DATOS DEL USUARIO (Set File ID)\nlet fileId = \"unknown\";\nlet fileTitle = \"unknown\";\nlet proveedor = \"OTROS\";\nlet tipoEval = [\"Technical Evaluation\"];\nlet proyecto = \"\";\nlet projectId = null;\n\ntry {\n    const fileNode = $('Set File ID').first().json;\n    fileId = fileNode.file_id || \"unknown\";\n    fileTitle = fileNode.file_title || \"unknown\";\n    proveedor = fileNode.proveedor || \"OTROS\";\n    proyecto = fileNode.proyect_name || \"\";\n    projectId = fileNode.project_id || null;\n    \n    if (fileNode.evaluation && Array.isArray(fileNode.evaluation) && fileNode.evaluation.length > 0) {\n        tipoEval = fileNode.evaluation;\n    } else if (fileNode.evaluation && typeof fileNode.evaluation === 'string') {\n        tipoEval = [fileNode.evaluation];\n    }\n} catch(e) {\n    console.log(\"âŒ Error leyendo Set File ID\");\n}\n\n// 3. GENERAR SALIDA\nreturn {\n    json: {\n        text: fullText,\n        metadata: {\n            file_id: fileId,\n            file_title: fileTitle,\n            proveedor: proveedor,\n            tipo_evaluacion: tipoEval,\n            project_name: proyecto,\n            project_id: projectId,\n            processed_at: new Date().toISOString(),\n            total_pages: totalPages\n        }\n    }\n};"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        -992,
        4800
      ],
      "id": "218c6556-e327-410a-aa78-95360b4a7030",
      "name": "Format for Vectorstore"
    },
    {
      "parameters": {
        "jsCode": "// =============================================\n// NODO: Expandir por Tipo de EvaluaciÃ³n (v3 - DIRECTO DEL USUARIO)\n// SIN clasificador ni validador LLM - usa datos del usuario directamente\n// =============================================\n\n// 1. RECUPERAR TEXTO Y CONTENIDO BASE\nlet fullText = \"\";\nlet totalPages = 1;\ntry {\n    const mergeData = $('Merge1').first().json;\n    fullText = (mergeData.pages && mergeData.pages[0]) \n        ? mergeData.pages.slice(0, 2).map(p => p.text || \"\").join(\"\\n\\n\") \n        : (mergeData.text || \"\");\n    totalPages = mergeData.totalPages || 1;\n} catch (e) {\n    console.error(\"âŒ Error leyendo Merge1\");\n}\n\n// 2. USAR DIRECTAMENTE DATOS DEL USUARIO (Set File ID)\nlet fileId = \"unknown\";\nlet proveedor = \"OTROS\";\nlet tipoEval = [\"Technical Evaluation\"];\nlet projectName = \"proyecto_sin_especificar\";\n\ntry {\n    const fileData = $('Set File ID').first().json;\n    fileId = fileData.file_id || \"unknown\";\n    proveedor = fileData.proveedor || \"OTROS\";\n    projectName = fileData.proyect_name || \"proyecto_sin_especificar\";\n    \n    // Tipos de evaluaciÃ³n del usuario\n    if (fileData.evaluation && Array.isArray(fileData.evaluation) && fileData.evaluation.length > 0) {\n        tipoEval = fileData.evaluation;\n    } else if (fileData.evaluation && typeof fileData.evaluation === 'string') {\n        tipoEval = [fileData.evaluation];\n    }\n    \n    console.log(`âœ… Usando datos del usuario directamente:`);\n    console.log(`   Proveedor: ${proveedor}`);\n    console.log(`   Proyecto: ${projectName}`);\n    console.log(`   Tipos: ${JSON.stringify(tipoEval)}`);\n} catch (e) {\n    console.error(\"âŒ Error leyendo Set File ID:\", e.message);\n}\n\n// 3. NORMALIZAR TIPOS\nif (!Array.isArray(tipoEval)) tipoEval = [tipoEval];\ntipoEval = tipoEval.filter(t => t && t.trim() !== \"\");\nif (tipoEval.length === 0) tipoEval = [\"Technical Evaluation\"];\n\n// Normalizar tipos antiguos (Deliverables, FEED) a Others\ntipoEval = tipoEval.map(t => {\n    if (t === 'Technical Evaluation' || t === 'Economical Evaluation' || t === 'Others') return t;\n    if (t.includes('Deliverables') || t.includes('FEED')) return 'Others';\n    return t;\n});\ntipoEval = [...new Set(tipoEval)]; // Eliminar duplicados tras mapeo\n\n// 4. GENERAR FILAS\nreturn tipoEval.map((tipo, idx) => ({\n    json: {\n        tipo_evaluacion_actual: tipo,\n        proveedor_detectado: proveedor,\n        proyecto_nombre: projectName,\n        texto_oferta_completo: fullText,\n        indice_actual: idx + 1,\n        total_tipos: tipoEval.length,\n        file_id: fileId\n    }\n}));"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        -4656,
        4112
      ],
      "id": "6b0b9106-5977-4b17-83b2-f27bc698bd45",
      "name": "Expandir por Tipo de EvaluaciÃ³n"
    },
    {
      "parameters": {
        "options": {}
      },
      "type": "n8n-nodes-base.splitInBatches",
      "typeVersion": 3,
      "position": [
        -4352,
        4032
      ],
      "id": "b0f31275-dc0e-46ad-a065-370f2a0dec28",
      "name": "Loop Over Items1"
    },
    {
      "parameters": {
        "method": "POST",
        "url": "https://unlaconic-ardelle-pretenceful.ngrok-free.dev/v1/convert/file",
        "sendBody": true,
        "contentType": "multipart-form-data",
        "bodyParameters": {
          "parameters": [
            {
              "parameterType": "formBinaryData",
              "name": "files",
              "inputDataFieldName": "data"
            }
          ]
        },
        "options": {
          "timeout": 300000
        }
      },
      "id": "eecffe29-3912-437c-b1d1-7254730197c1",
      "name": "Docling OCR",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.3,
      "position": [
        -2512,
        4608
      ],
      "retryOnFail": true
    },
    {
      "parameters": {
        "schemaType": "manual",
        "inputSchema": "{\n  \"type\": \"object\",\n  \"properties\": {\n    \"proveedor_detectado\": {\n      \"type\": \"string\",\n      \"description\": \"Nombre de la empresa proveedora (Ej: SACYR, IDOM, etc.)\"\n    },\n    \"tipos_detectados\": {\n      \"type\": \"array\",\n      \"items\": {\n        \"type\": \"string\",\n        \"enum\": [\n          \"Technical Evaluation\",\n          \"Economical Evaluation\",\n          \"Pre-FEED Deliverables\",\n          \"FEED Deliverables\"\n        ]\n      },\n      \"description\": \"Lista de tipos de oferta detectados en el documento.\"\n    },\n    \"razonamiento\": {\n      \"type\": \"string\",\n      \"description\": \"Breve explicaciÃ³n de por quÃ© se eligieron esos tipos.\"\n    }\n  },\n  \"required\": [\n    \"proveedor_detectado\",\n    \"tipos_detectados\"\n  ]\n}"
      },
      "type": "@n8n/n8n-nodes-langchain.outputParserStructured",
      "typeVersion": 1.3,
      "position": [
        -1200,
        5264
      ],
      "id": "adaa211e-5616-462f-a86c-f965b75ad9de",
      "name": "Structured Output Parser"
    },
    {
      "parameters": {},
      "type": "n8n-nodes-base.merge",
      "typeVersion": 3.2,
      "position": [
        -2048,
        4816
      ],
      "id": "5a1d630a-dcfb-4d8f-af2f-47354a76dc19",
      "name": "Merge1"
    },
    {
      "parameters": {
        "jsCode": "const items = $input.all();\n\nreturn items.map(item => ({\n    json: {\n        ...item.json, // Mantiene todos los datos originales (incluido tipo_evaluacion)\n        \n        // AquÃ­ estÃ¡ la correcciÃ³n: Usamos dos puntos, no el igual.\n        reiniciar_bucle: true \n    }\n}));\n"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        -3344,
        3984
      ],
      "id": "f9c83eee-24a3-42d2-bd71-0f030101da60",
      "name": "Reset Items"
    },
    {
      "parameters": {
        "respondWith": "allIncomingItems",
        "options": {}
      },
      "type": "n8n-nodes-base.respondToWebhook",
      "typeVersion": 1.5,
      "position": [
        -3904,
        3760
      ],
      "id": "a70f2556-8734-447e-9233-4f19c9be3d9b",
      "name": "Respond to Webhook"
    },
    {
      "parameters": {
        "httpMethod": "POST",
        "path": "ofertas",
        "responseMode": "responseNode",
        "options": {}
      },
      "type": "n8n-nodes-base.webhook",
      "typeVersion": 2.1,
      "position": [
        -4736,
        4816
      ],
      "id": "bb3ee3d2-f35d-43ca-bd64-d63585a7cde6",
      "name": "Webhook",
      "webhookId": "54339356-4e6d-4e22-9820-6e1e98e167a8"
    },
    {
      "parameters": {
        "jsCode": "// =============================================\n// NODO: Convertir Base64 a Binary Data (CORREGIDO v3)\n// =============================================\n\n// LEER DIRECTAMENTE DEL NODO \"Set File ID\"\nlet inputData;\ntry {\n    inputData = $('Set File ID').first().json;\n} catch (e) {\n    throw new Error(\"âŒ No se puede acceder al nodo 'Set File ID'\");\n}\n\nconst base64Data = inputData.file_binary;\n\n// --- VALIDACIÃ“N CRÃTICA ---\nif (!base64Data || base64Data === \"\") {\n    console.error(\"âŒ ERROR: file_binary estÃ¡ vacÃ­o\");\n    console.error(\"Datos en 'Set File ID':\", Object.keys(inputData));\n    console.error(\"file_id:\", inputData.file_id);\n    console.error(\"file_title:\", inputData.file_title);\n    \n    throw new Error(\n        \"âŒ CRÃTICO: 'file_binary' no existe en 'Set File ID'. \" +\n        \"Verifica la configuraciÃ³n del nodo.\"\n    );\n}\n\n// Validar que sea string\nif (typeof base64Data !== 'string') {\n    throw new Error(`âŒ ERROR: 'file_binary' debe ser string, es ${typeof base64Data}`);\n}\n\n// Logging\nconsole.log(\"âœ… file_binary recibido de 'Set File ID'\");\nconsole.log(`   â”œâ”€ Longitud: ${base64Data.length} caracteres`);\nconsole.log(`   â”œâ”€ Archivo: ${inputData.file_title}`);\n\n// Convertir base64 a binary\nlet binaryData;\ntry {\n    binaryData = Buffer.from(base64Data, 'base64');\n} catch (e) {\n    throw new Error(`âŒ ERROR decodificando base64: ${e.message}`);\n}\n\n// Validar tamaÃ±o\nif (binaryData.length === 0) {\n    throw new Error(\"âŒ ERROR: Archivo decodificado vacÃ­o (0 bytes)\");\n}\n\nconsole.log(`âœ… Binary generado: ${binaryData.length} bytes`);\n\n// Retornar formato n8n\nreturn {\n    json: {\n        file_id: inputData.file_id,\n        file_title: inputData.file_title,\n        file_url: inputData.file_url || \"unknown\"\n    },\n    binary: {\n        data: {\n            data: binaryData.toString('base64'),\n            mimeType: 'application/pdf',\n            fileName: inputData.file_title || 'document.pdf',\n            fileSize: binaryData.length\n        }\n    }\n};"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        -3728,
        4816
      ],
      "id": "d73cff13-3e79-444e-b673-6a2540b77387",
      "name": "Base64 a Binary"
    },
    {
      "parameters": {
        "jsCode": "// =============================================\n// NODO: Convertir Base64 a Binary Data (CORREGIDO v3)\n// =============================================\n\n// LEER DIRECTAMENTE DEL NODO \"Set File ID\"\nlet inputData;\ntry {\n    inputData = $('Set File ID').first().json;\n} catch (e) {\n    throw new Error(\"âŒ No se puede acceder al nodo 'Set File ID'\");\n}\n\nconst base64Data = inputData.file_binary;\n\n// --- VALIDACIÃ“N CRÃTICA ---\nif (!base64Data || base64Data === \"\") {\n    console.error(\"âŒ ERROR: file_binary estÃ¡ vacÃ­o\");\n    console.error(\"Datos en 'Set File ID':\", Object.keys(inputData));\n    console.error(\"file_id:\", inputData.file_id);\n    console.error(\"file_title:\", inputData.file_title);\n    \n    throw new Error(\n        \"âŒ CRÃTICO: 'file_binary' no existe en 'Set File ID'. \" +\n        \"Verifica la configuraciÃ³n del nodo.\"\n    );\n}\n\n// Validar que sea string\nif (typeof base64Data !== 'string') {\n    throw new Error(`âŒ ERROR: 'file_binary' debe ser string, es ${typeof base64Data}`);\n}\n\n// Logging\nconsole.log(\"âœ… file_binary recibido de 'Set File ID'\");\nconsole.log(`   â”œâ”€ Longitud: ${base64Data.length} caracteres`);\nconsole.log(`   â”œâ”€ Archivo: ${inputData.file_title}`);\n\n// Convertir base64 a binary\nlet binaryData;\ntry {\n    binaryData = Buffer.from(base64Data, 'base64');\n} catch (e) {\n    throw new Error(`âŒ ERROR decodificando base64: ${e.message}`);\n}\n\n// Validar tamaÃ±o\nif (binaryData.length === 0) {\n    throw new Error(\"âŒ ERROR: Archivo decodificado vacÃ­o (0 bytes)\");\n}\n\nconsole.log(`âœ… Binary generado: ${binaryData.length} bytes`);\n\n// Retornar formato n8n\nreturn {\n    json: {\n        file_id: inputData.file_id,\n        file_title: inputData.file_title,\n        file_url: inputData.file_url || \"unknown\"\n    },\n    binary: {\n        data: {\n            data: binaryData.toString('base64'),\n            mimeType: 'application/pdf',\n            fileName: inputData.file_title || 'document.pdf',\n            fileSize: binaryData.length\n        }\n    }\n};"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        -2720,
        4704
      ],
      "id": "161906d1-ac8f-4c07-a24e-c5c609eabb02",
      "name": "Base64 a Binary1"
    },
    {
      "parameters": {
        "jsCode": "// =============================================\n// NODO: Generate Stable ID + Detectar Modo (NOMBRES CORRECTOS)\n// =============================================\n\nfunction simpleHash(str) {\n  let hash = 0;\n  for (let i = 0; i < str.length; i++) {\n    const char = str.charCodeAt(i);\n    hash = ((hash << 5) - hash) + char;\n    hash = hash & hash;\n  }\n  return Math.abs(hash).toString(16).padStart(16, '0').substring(0, 16);\n}\n\nconst body = $json.body;\n\n// CAMPOS EXISTENTES\nconst originalFileId = body.file_id || \"unknown\";\nconst fileTitle = body.file_title || \"unknown.pdf\";\nconst fileBinary = body.file_binary || \"\";\nconst fileUrl = body.file_url || \"unknown\";\n\n// âœ… EXTRAER METADATA DEL USUARIO (NOMBRES CORRECTOS)\nconst metadata = body.metadata || {};\nconst rfqProjectId = metadata.proyect_name || null;        // â† proyect_name\nconst userProveedor = metadata.proveedor || null;          // â† proveedor\nconst userTipoEval = metadata.evaluation || null;          // â† evaluation (Array)\n\n// âœ… DETERMINAR MODO DE OPERACIÃ“N\nlet modoOperacion = \"CLASIFICADOR\"; // Por defecto\nlet datosCompletos = false;\n\n// Verificar si tiene datos suficientes para VALIDACIÃ“N\nif (userProveedor && userTipoEval && Array.isArray(userTipoEval) && userTipoEval.length > 0) {\n    modoOperacion = \"VALIDADOR\";\n    datosCompletos = true;\n} else if (userProveedor || (userTipoEval && Array.isArray(userTipoEval) && userTipoEval.length > 0)) {\n    modoOperacion = \"HIBRIDO\"; // Tiene algunos datos pero no todos\n}\n\n// Generar ID estable del archivo (incluye project_id para evitar colisiones entre proyectos)\nconst projectId = body.project_id || metadata.project_id || '';\nconst normalizedTitle = fileTitle.toLowerCase().trim();\nconst stableId = simpleHash(normalizedTitle + '_' + projectId);\n\n// LOGGING\nconsole.log(\"=== ANÃLISIS DE METADATA ===\");\nconsole.log(`Modo OperaciÃ³n: ${modoOperacion}`);\nconsole.log(`RFQ Project Name: ${rfqProjectId || 'No especificado'}`);\nconsole.log(`Proveedor (Usuario): ${userProveedor || 'No especificado'}`);\nconsole.log(`Evaluation (Usuario): ${JSON.stringify(userTipoEval) || 'No especificado'}`);\nconsole.log(`Datos Completos: ${datosCompletos}`);\nconsole.log(`Original ID: ${originalFileId}`);\nconsole.log(`Nombre archivo: ${fileTitle}`);\nconsole.log(`ID ESTABLE generado: ${stableId}`);\n\n// RETORNO\nreturn {\n  json: {\n    // Datos directos en raÃ­z\n    file_id: stableId,\n    file_id_original: originalFileId,\n    file_title: fileTitle,\n    file_binary: fileBinary,\n    file_url: fileUrl,\n    \n    rfq_project_id: rfqProjectId || \"proyecto_sin_especificar\",\n    user_proveedor: userProveedor,\n    user_tipo_evaluacion: userTipoEval,\n    modo_operacion: modoOperacion,\n    datos_usuario_completos: datosCompletos,\n    \n    // Mantener body completo\n    body: {\n      ...body,\n      file_id: stableId,\n      file_id_original: originalFileId,\n      rfq_project_id: rfqProjectId || \"proyecto_sin_especificar\",\n      user_proveedor: userProveedor,\n      user_tipo_evaluacion: userTipoEval,\n      modo_operacion: modoOperacion,\n      datos_usuario_completos: datosCompletos\n    }\n  }\n};"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        -4496,
        4816
      ],
      "id": "dcc29856-90dc-4c0c-a9b0-663370f25405",
      "name": "Code in JavaScript1"
    },
    {
      "parameters": {
        "operation": "upsert",
        "schema": {
          "__rl": true,
          "mode": "list",
          "value": "public"
        },
        "table": {
          "__rl": true,
          "value": "provider_responses",
          "mode": "list",
          "cachedResultName": "provider_responses"
        },
        "columns": {
          "mappingMode": "defineBelow",
          "value": {
            "provider_name": "={{ $json.provider_name }}",
            "evaluation_value": "={{ $json.evaluation_value }}",
            "comment": "={{ $json.comment }}",
            "requirement_id": "={{ $json.requirement_id }}",
            "file_id": "={{ $('Set File ID').first().json.file_id }}",
            "project_id": "={{ $('Set File ID').first().json.project_id }}",
            "updated_at": "={{ $now }}"
          },
          "matchingColumns": [
            "provider_name",
            "requirement_id"
          ],
          "schema": [
            {
              "id": "id",
              "displayName": "id",
              "required": false,
              "defaultMatch": true,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": true
            },
            {
              "id": "requirement_id",
              "displayName": "requirement_id",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": false
            },
            {
              "id": "provider_name",
              "displayName": "provider_name",
              "required": true,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": false
            },
            {
              "id": "evaluation_value",
              "displayName": "evaluation_value",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": false
            },
            {
              "id": "comment",
              "displayName": "comment",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": false
            },
            {
              "id": "file_id",
              "displayName": "file_id",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": false
            },
            {
              "id": "updated_at",
              "displayName": "updated_at",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "dateTime",
              "canBeUsedToMatch": false
            },
            {
              "id": "project_id",
              "displayName": "project_id",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": false
            },
            {
              "id": "score",
              "displayName": "score",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "number",
              "canBeUsedToMatch": false,
              "removed": true
            }
          ],
          "attemptToConvertTypes": false,
          "convertFieldsToString": false
        },
        "options": {}
      },
      "type": "n8n-nodes-base.postgres",
      "typeVersion": 2.6,
      "position": [
        -640,
        4256
      ],
      "id": "8f21f9b6-a9bf-45a9-9e75-c16647b2d7b7",
      "name": "Insert or update rows in a table",
      "credentials": {
        "postgres": {
          "id": "V0REAPph5JBLqze3",
          "name": "Postgres account"
        }
      }
    },
    {
      "parameters": {
        "jsCode": "// =============================================\n// NODO: Preparar Todo para LLM (SIN RAG, SIN FASES)\n// Pasa TODOS los requisitos directamente al LLM\n// =============================================\n\nconst items = $input.all();\n\nconsole.log('ðŸ“¥ Requisitos recibidos:', items.length);\n\n// Obtener texto completo de la oferta desde Loop Over Items1\nlet textoOfertaCompleto = \"\";\nlet evaluationType = \"Technical Evaluation\";\n\ntry {\n    const loopData = $('Loop Over Items1').first().json;\n    textoOfertaCompleto = loopData.texto_oferta_completo || \"\";\n    evaluationType = loopData.tipo_evaluacion_actual || \"Technical Evaluation\";\n    console.log('âœ… Datos obtenidos de Loop Over Items1');\n    console.log('   â”œâ”€ Tipo evaluaciÃ³n:', evaluationType);\n    console.log('   â””â”€ Texto oferta:', textoOfertaCompleto.length, 'chars');\n} catch(e) {\n    console.warn('âš ï¸ No se pudo obtener texto de oferta de Loop Over Items1:', e.message);\n    // Fallback: intentar obtener de otro lugar\n    try {\n        const expandirData = $('Expandir por Tipo de EvaluaciÃ³n').first().json;\n        textoOfertaCompleto = expandirData.texto_oferta_completo || \"\";\n        evaluationType = expandirData.tipo_evaluacion_actual || \"Technical Evaluation\";\n        console.log('âœ… Fallback: Datos obtenidos de Expandir por Tipo de EvaluaciÃ³n');\n    } catch(e2) {\n        console.error('âŒ No se pudo obtener texto de ningÃºn nodo');\n    }\n}\n\n// Formatear TODOS los requisitos (sin batching)\nconst todosLosRequisitos = items.map(item => ({\n    id: item.json.id || \"\",\n    requirement_text: item.json.requirement_text || item.json.text || \"NO ESPECIFICADO\",\n    evaluation_type: item.json.evaluation_type || evaluationType\n}));\n\nconsole.log('ðŸ“‹ PreparaciÃ³n directa (sin RAG ni fases):');\nconsole.log('   â”œâ”€ Total requisitos:', todosLosRequisitos.length);\nconsole.log('   â”œâ”€ Tipo evaluaciÃ³n:', evaluationType);\nconsole.log('   â””â”€ TamaÃ±o texto oferta:', textoOfertaCompleto.length, 'chars');\n\n// Retornar UN SOLO item con TODOS los requisitos\nreturn [{\n    json: {\n        evaluation_type: evaluationType,\n        requisitos: todosLosRequisitos,\n        total_requisitos: todosLosRequisitos.length,\n        batch_index: 1,\n        total_batches: 1,\n        context: textoOfertaCompleto,\n        texto_length: textoOfertaCompleto.length\n    }\n}];"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        -2592,
        3904
      ],
      "id": "0f3f5469-c2d0-420b-b15c-fbeae5bd1bf7",
      "name": "Preparar Todo para LLM1"
    },
    {
      "parameters": {
        "model": "mistral-large-latest",
        "options": {}
      },
      "type": "@n8n/n8n-nodes-langchain.lmChatMistralCloud",
      "typeVersion": 1,
      "position": [
        -1664,
        4112
      ],
      "id": "ad85c622-7017-4347-8f02-8796e637fa54",
      "name": "Mistral Cloud Chat Model3",
      "credentials": {
        "mistralCloudApi": {
          "id": "tDjuOnF6lpADMmd5",
          "name": "Mistral Cloud account"
        }
      }
    },
    {
      "parameters": {
        "model": "ministral-14b-latest",
        "options": {}
      },
      "type": "@n8n/n8n-nodes-langchain.lmChatMistralCloud",
      "typeVersion": 1,
      "position": [
        -1408,
        4928
      ],
      "id": "05be3ca1-dc0b-4422-bc5b-bebabc910162",
      "name": "Mistral Cloud Chat Model5",
      "credentials": {
        "mistralCloudApi": {
          "id": "tDjuOnF6lpADMmd5",
          "name": "Mistral Cloud account"
        }
      }
    },
    {
      "parameters": {
        "model": "ministral-14b-latest",
        "options": {}
      },
      "type": "@n8n/n8n-nodes-langchain.lmChatMistralCloud",
      "typeVersion": 1,
      "position": [
        -1328,
        5264
      ],
      "id": "f9a468f1-9242-4ab1-883c-ca62322752a3",
      "name": "Mistral Cloud Chat Model6",
      "credentials": {
        "mistralCloudApi": {
          "id": "tDjuOnF6lpADMmd5",
          "name": "Mistral Cloud account"
        }
      }
    },
    {
      "parameters": {
        "conditions": {
          "options": {
            "caseSensitive": false,
            "leftValue": ""
          },
          "conditions": [
            {
              "id": "check-has-economic-type",
              "leftValue": "={{ ($('Set File ID').first().json.evaluation || []).join(',').toLowerCase() }}",
              "rightValue": "econom",
              "operator": {
                "type": "string",
                "operation": "contains"
              }
            }
          ],
          "combinator": "and"
        },
        "options": {}
      },
      "type": "n8n-nodes-base.if",
      "typeVersion": 2.2,
      "position": [
        -2288,
        3664
      ],
      "id": "0fe6b866-f01d-47ed-adcd-dfdd9454f0bd",
      "name": "Has Economic Evaluation?"
    },
    {
      "parameters": {
        "content": "## Economic Data Extraction (T8)\n\nExtracts structured economic/financial data from supplier proposals.\nOnly triggered when the offer includes Economical Evaluation type.\n\n**Flow**: Merge1 -> IF (Has Economic?) -> Check If Economic -> Extract Economic Data (LLM) -> Parse Economic JSON -> Save Economic Offer (Supabase UPSERT)\n\n**Target table**: economic_offers (project_id, provider_name unique constraint)",
        "height": 520,
        "width": 2500,
        "color": 5
      },
      "type": "n8n-nodes-base.stickyNote",
      "typeVersion": 1,
      "position": [
        -2368,
        3344
      ],
      "id": "2b4807b0-0517-4cb6-ab02-edcea8321a61",
      "name": "Sticky Note Economic"
    },
    {
      "parameters": {
        "jsCode": "// =============================================\n// NODE: Check If Economic Offer\n// Determines if this supplier proposal contains economic/pricing data\n// and prepares text for LLM extraction.\n// =============================================\n\n// Get the merged proposal data\nconst mergeData = $input.first().json;\n\n// Get metadata from Set File ID\nlet providerName = 'UNKNOWN';\nlet projectId = null;\nlet projectName = '';\nlet evaluationTypes = [];\n\ntry {\n    const fileData = $('Set File ID').first().json;\n    providerName = fileData.proveedor || 'UNKNOWN';\n    projectId = fileData.project_id || null;\n    projectName = fileData.proyect_name || '';\n    \n    if (fileData.evaluation && Array.isArray(fileData.evaluation)) {\n        evaluationTypes = fileData.evaluation;\n    } else if (fileData.evaluation && typeof fileData.evaluation === 'string') {\n        evaluationTypes = [fileData.evaluation];\n    }\n} catch (e) {\n    console.log('Warning: Could not read Set File ID:', e.message);\n}\n\n// Check if evaluation types include economic\nconst hasEconomic = evaluationTypes.some(t => \n    t.toLowerCase().includes('econom') || \n    t.toLowerCase().includes('commercial') ||\n    t.toLowerCase().includes('pricing')\n);\n\n// Also check text content for economic indicators as fallback\nlet fullText = '';\ntry {\n    if (mergeData.pages && Array.isArray(mergeData.pages)) {\n        fullText = mergeData.pages.map(p => p.text || '').join('\\n\\n');\n    } else {\n        fullText = mergeData.text || '';\n    }\n} catch (e) {\n    fullText = '';\n}\n\n// Economic indicators in text\nconst economicKeywords = ['total price', 'precio total', 'price breakdown', 'desglose', \n    'payment terms', 'condiciones de pago', 'discount', 'descuento', 'EUR/h', 'USD/h',\n    'lump sum', 'suma alzada', 'cost estimate', 'presupuesto', 'budget',\n    'fee schedule', 'tarifa', 'quotation', 'cotizacion', 'oferta economica',\n    'commercial proposal', 'propuesta economica', 'pricing schedule'];\n\nconst textLower = fullText.substring(0, 50000).toLowerCase();\nconst textHasEconomic = economicKeywords.some(kw => textLower.includes(kw));\n\nconst shouldExtract = hasEconomic || textHasEconomic;\n\nconsole.log(`Economic Check:`);\nconsole.log(`  Provider: ${providerName}`);\nconsole.log(`  Project ID: ${projectId}`);\nconsole.log(`  Eval types: ${JSON.stringify(evaluationTypes)}`);\nconsole.log(`  Has economic type: ${hasEconomic}`);\nconsole.log(`  Text has economic keywords: ${textHasEconomic}`);\nconsole.log(`  Should extract: ${shouldExtract}`);\n\nif (!shouldExtract) {\n    console.log('Skipping economic extraction - no economic content detected');\n    return [];\n}\n\n// Limit text to ~60k chars for LLM context\nconst textForExtraction = fullText.substring(0, 60000);\n\nreturn [{\n    json: {\n        provider_name: providerName,\n        project_id: projectId,\n        project_name: projectName,\n        proposal_text: textForExtraction,\n        text_length: fullText.length,\n        evaluation_types: evaluationTypes\n    }\n}];"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        -2048,
        3664
      ],
      "id": "cbaa80d5-e60a-4897-8f9d-0239b9ce8d7a",
      "name": "Check If Economic Offer"
    },
    {
      "parameters": {
        "promptType": "define",
        "text": "=### PROPUESTA DE PROVEEDOR - EXTRACCIÃ“N DE DATOS ECONÃ“MICOS\n\n## PROYECTO: {{ $json.project_name }}\n## PROVEEDOR: {{ $json.provider_name }}\n\n### TEXTO DE LA PROPUESTA:\n{{ $json.proposal_text }}\n\n---\n### INSTRUCCIONES:\nExtrae TODOS los datos econÃ³micos y financieros de esta propuesta de proveedor.\nDevuelve SOLO un objeto JSON vÃ¡lido. NO incluyas bloques de cÃ³digo markdown.\nSi un campo no se encuentra en el texto, usa null.\n\n**IDIOMA**: {{ $('Set File ID').first().json.language === 'en' ? 'All text fields (payment_terms, discount_conditions, price_escalation, guarantees, raw_notes, descriptions) must be in ENGLISH.' : 'Todos los campos de texto (payment_terms, discount_conditions, price_escalation, guarantees, raw_notes, descripciones) deben estar en ESPAÃ‘OL.' }}\n\nPara total_price, busca el importe total de la oferta, suma alzada o coste total.\nPara price_breakdown, extrae partidas, coste por disciplina o coste por fase.\nPara payment_terms, busca condiciones de pago (% anticipo, hitos, plazos, etc.).\n\nDevuelve SOLO JSON vÃ¡lido comenzando con { y terminando con }.",
        "messages": {
          "messageValues": [
            {
              "message": "You are an expert procurement analyst specializing in extracting economic and financial data from supplier proposals for large-scale industrial projects (EPC, P2X, Green Hydrogen, Energy).\n\n### TASK\nExtract all economic/financial data from the supplier proposal text.\n\n### OUTPUT SCHEMA (return ONLY this JSON structure):\n{\n  \"total_price\": <number or null>,\n  \"currency\": \"<ISO 4217 code, default {{ $('Set File ID').first().json.currency || 'EUR' }}>\",\n  \"price_breakdown\": <object with line items like {\"engineering\": X, \"procurement\": Y, \"construction\": Z} or null>,\n  \"discount_percentage\": <number, 0 if none>,\n  \"discount_conditions\": <string or null>,\n  \"tco_value\": <number or null>,\n  \"tco_period_years\": <number or null>,\n  \"tco_breakdown\": <object like {\"capex\": X, \"opex_annual\": Y} or null>,\n  \"payment_terms\": <string describing terms like \"Net 60\" or \"30/40/30\" or null>,\n  \"payment_schedule\": <array of {\"milestone\": \"percentage\", \"event\": \"description\"} or null>,\n  \"validity_days\": <number, default 90>,\n  \"price_escalation\": <string describing escalation clauses or null>,\n  \"guarantees\": <string describing financial/performance guarantees or null>,\n  \"insurance_included\": <boolean>,\n  \"taxes_included\": <boolean>,\n  \"optional_items\": <array of {\"description\": \"X\", \"price\": Y} or null>,\n  \"alternative_offers\": <array of {\"description\": \"X\", \"total_price\": Y, \"details\": \"...\"} or null>,\n  \"extraction_confidence\": <number 0.0-1.0>,\n  \"raw_notes\": <string with any additional economic observations>\n}\n\n### CRITICAL RULES:\n1. Return ONLY the JSON object. No explanations, no markdown.\n2. Numbers must be actual numbers, not strings (e.g., 1500000 not \"1,500,000\").\n3. The project's default currency is {{ $('Set File ID').first().json.currency || 'EUR' }}. Use this as the default currency. If you find prices in different currencies, note the original and convert to {{ $('Set File ID').first().json.currency || 'EUR' }} if possible.\n4. For price_breakdown, use descriptive keys in English.\n5. extraction_confidence should reflect how much economic data you actually found (0.1 = almost nothing, 0.9 = very detailed).\n6. Be thorough: check tables, headers, footers, appendices for pricing data.\n7. Look for both explicit prices and calculated totals."
            }
          ]
        },
        "batching": {}
      },
      "type": "@n8n/n8n-nodes-langchain.chainLlm",
      "typeVersion": 1.8,
      "position": [
        -1728,
        3664
      ],
      "id": "8037c916-dc60-4e42-8d8f-099c775a777b",
      "name": "Extract Economic Data"
    },
    {
      "parameters": {
        "model": "mistral-large-latest",
        "options": {
          "temperature": 0.1
        }
      },
      "type": "@n8n/n8n-nodes-langchain.lmChatMistralCloud",
      "typeVersion": 1,
      "position": [
        -1728,
        3872
      ],
      "id": "4d0c4bf7-0a51-458c-b2ea-2839851b7725",
      "name": "Mistral Economic Model",
      "credentials": {
        "mistralCloudApi": {
          "id": "tDjuOnF6lpADMmd5",
          "name": "Mistral Cloud account"
        }
      }
    },
    {
      "parameters": {
        "jsCode": "// =============================================\n// NODE: Parse Economic JSON\n// Parses and validates the LLM economic extraction output\n// =============================================\n\nconst llmOutput = $input.first().json;\nconst inputData = $('Check If Economic Offer').first().json;\n\nlet parsed = null;\n\ntry {\n    // The LLM chain returns output in .text or .output\n    let rawText = llmOutput.text || llmOutput.output || JSON.stringify(llmOutput);\n    \n    if (typeof rawText === 'string') {\n        // Clean potential markdown code blocks\n        rawText = rawText.replace(/```json\\n?/g, '').replace(/```\\n?/g, '').trim();\n        \n        // Find JSON boundaries\n        const start = rawText.indexOf('{');\n        const end = rawText.lastIndexOf('}');\n        if (start !== -1 && end !== -1 && end > start) {\n            rawText = rawText.substring(start, end + 1);\n        }\n        \n        parsed = JSON.parse(rawText);\n    } else {\n        parsed = rawText;\n    }\n} catch (err) {\n    console.error('Error parsing economic JSON:', err.message);\n    // Return minimal valid record so we still save something\n    parsed = {\n        total_price: null,\n        currency: 'EUR',\n        extraction_confidence: 0.0,\n        raw_notes: 'LLM output could not be parsed: ' + err.message\n    };\n}\n\n// Helper to safely convert to number\nfunction toNumber(val) {\n    if (val === null || val === undefined) return null;\n    if (typeof val === 'number') return val;\n    if (typeof val === 'string') {\n        // Remove currency symbols, commas, spaces\n        const cleaned = val.replace(/[^0-9.-]/g, '');\n        const num = parseFloat(cleaned);\n        return isNaN(num) ? null : num;\n    }\n    return null;\n}\n\n// Helper to safely convert to JSON string for Supabase JSONB columns\nfunction toJsonString(val) {\n    if (val === null || val === undefined) return null;\n    if (typeof val === 'string') return val;\n    return JSON.stringify(val);\n}\n\n// Build the record for Supabase\nconst record = {\n    project_id: inputData.project_id,\n    provider_name: inputData.provider_name,\n    \n    // Core pricing\n    total_price: toNumber(parsed.total_price),\n    currency: parsed.currency || 'EUR',\n    price_breakdown: toJsonString(parsed.price_breakdown || {}),\n    \n    // Payment terms\n    payment_terms: parsed.payment_terms || null,\n    payment_schedule: toJsonString(parsed.payment_schedule || []),\n    \n    // Discounts\n    discount_percentage: toNumber(parsed.discount_percentage) || 0,\n    discount_conditions: parsed.discount_conditions || null,\n    \n    // TCO\n    tco_value: toNumber(parsed.tco_value),\n    tco_period_years: parsed.tco_period_years ? parseInt(parsed.tco_period_years) : null,\n    tco_breakdown: toJsonString(parsed.tco_breakdown || {}),\n    \n    // Additional\n    validity_days: parsed.validity_days ? parseInt(parsed.validity_days) : 90,\n    price_escalation: parsed.price_escalation || null,\n    guarantees: parsed.guarantees || null,\n    insurance_included: parsed.insurance_included === true,\n    taxes_included: parsed.taxes_included === true,\n    \n    // Optional / alternatives\n    optional_items: toJsonString(parsed.optional_items || []),\n    alternative_offers: toJsonString(parsed.alternative_offers || []),\n    \n    // AI metadata\n    extraction_confidence: toNumber(parsed.extraction_confidence) || 0,\n    raw_notes: parsed.raw_notes || null\n};\n\nconsole.log('Economic data parsed successfully:');\nconsole.log(`  Provider: ${record.provider_name}`);\nconsole.log(`  Total price: ${record.total_price} ${record.currency}`);\nconsole.log(`  Confidence: ${record.extraction_confidence}`);\nconsole.log(`  Has breakdown: ${record.price_breakdown !== '{}'}`);\nconsole.log(`  Has payment terms: ${!!record.payment_terms}`);\n\n// Validate: skip save if no project_id or provider_name\nif (!record.project_id || !record.provider_name || record.provider_name === 'UNKNOWN') {\n    console.log('WARNING: Missing project_id or provider_name, skipping save');\n    return [];\n}\n\nreturn [{ json: record }];"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        -1408,
        3664
      ],
      "id": "11a01b32-c6d4-41ee-b7b4-e1edc85896d0",
      "name": "Parse Economic JSON"
    },
    {
      "parameters": {
        "operation": "upsert",
        "schema": {
          "__rl": true,
          "value": "=public",
          "mode": "name"
        },
        "table": {
          "__rl": true,
          "value": "economic_offers",
          "mode": "list",
          "cachedResultName": "economic_offers"
        },
        "columns": {
          "mappingMode": "defineBelow",
          "value": {
            "insurance_included": "={{ $json.insurance_included }}",
            "taxes_included": "={{ $json.taxes_included }}",
            "total_price": "={{ $json.total_price }}",
            "discount_percentage": "={{ $json.discount_percentage }}",
            "tco_value": "={{ $json.tco_value }}",
            "tco_period_years": "={{ $json.tco_period_years }}",
            "validity_days": "={{ $json.validity_days }}",
            "extraction_confidence": "={{ $json.extraction_confidence }}",
            "project_id": "={{ $json.project_id }}",
            "provider_name": "={{ $json.provider_name }}",
            "currency": "={{ $json.currency }}",
            "price_breakdown": "={{ $json.price_breakdown }}",
            "payment_terms": "={{ $json.payment_terms }}",
            "discount_conditions": "={{ $json.discount_conditions }}",
            "tco_breakdown": "={{ $json.tco_breakdown }}",
            "price_escalation": "={{ $json.price_escalation }}",
            "guarantees": "={{ $json.guarantees }}",
            "alternative_offers": "={{ $json.alternative_offers }}",
            "raw_notes": "={{ $json.raw_notes }}",
            "created_at": "={{ $now.toISO() }}",
            "updated_at": "={{ $now.toISO() }}",
            "payment_schedule": "={{ $json.payment_schedule }}",
            "optional_items": "={{ $json.optional_items }}"
          },
          "matchingColumns": [
            "project_id",
            "provider_name"
          ],
          "schema": [
            {
              "id": "id",
              "displayName": "id",
              "required": false,
              "defaultMatch": true,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": true
            },
            {
              "id": "project_id",
              "displayName": "project_id",
              "required": true,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": false
            },
            {
              "id": "provider_name",
              "displayName": "provider_name",
              "required": true,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": false
            },
            {
              "id": "total_price",
              "displayName": "total_price",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "number",
              "canBeUsedToMatch": false
            },
            {
              "id": "currency",
              "displayName": "currency",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": false
            },
            {
              "id": "price_breakdown",
              "displayName": "price_breakdown",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": false
            },
            {
              "id": "payment_terms",
              "displayName": "payment_terms",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": false
            },
            {
              "id": "payment_schedule",
              "displayName": "payment_schedule",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": false
            },
            {
              "id": "discount_percentage",
              "displayName": "discount_percentage",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "number",
              "canBeUsedToMatch": false
            },
            {
              "id": "discount_conditions",
              "displayName": "discount_conditions",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": false
            },
            {
              "id": "tco_value",
              "displayName": "tco_value",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "number",
              "canBeUsedToMatch": false
            },
            {
              "id": "tco_period_years",
              "displayName": "tco_period_years",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "number",
              "canBeUsedToMatch": false
            },
            {
              "id": "tco_breakdown",
              "displayName": "tco_breakdown",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": false
            },
            {
              "id": "validity_days",
              "displayName": "validity_days",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "number",
              "canBeUsedToMatch": false
            },
            {
              "id": "price_escalation",
              "displayName": "price_escalation",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": false
            },
            {
              "id": "guarantees",
              "displayName": "guarantees",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": false
            },
            {
              "id": "insurance_included",
              "displayName": "insurance_included",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "boolean",
              "canBeUsedToMatch": false
            },
            {
              "id": "taxes_included",
              "displayName": "taxes_included",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "boolean",
              "canBeUsedToMatch": false
            },
            {
              "id": "optional_items",
              "displayName": "optional_items",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": false
            },
            {
              "id": "alternative_offers",
              "displayName": "alternative_offers",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": false
            },
            {
              "id": "extraction_confidence",
              "displayName": "extraction_confidence",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "number",
              "canBeUsedToMatch": false
            },
            {
              "id": "raw_notes",
              "displayName": "raw_notes",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": false
            },
            {
              "id": "created_at",
              "displayName": "created_at",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "dateTime",
              "canBeUsedToMatch": false
            },
            {
              "id": "updated_at",
              "displayName": "updated_at",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "dateTime",
              "canBeUsedToMatch": false
            }
          ],
          "attemptToConvertTypes": false,
          "convertFieldsToString": false
        },
        "options": {}
      },
      "type": "n8n-nodes-base.postgres",
      "typeVersion": 2.5,
      "position": [
        -1056,
        3664
      ],
      "id": "0ee04420-80bd-4b8e-b4d5-3e6a8e8863d9",
      "name": "Save Economic Offer",
      "credentials": {
        "postgres": {
          "id": "V0REAPph5JBLqze3",
          "name": "Postgres account"
        }
      }
    },
    {
      "parameters": {
        "httpMethod": "POST",
        "path": "qa-audit-generator",
        "responseMode": "responseNode",
        "options": {}
      },
      "type": "n8n-nodes-base.webhook",
      "typeVersion": 2.1,
      "position": [
        -10320,
        4464
      ],
      "id": "e71392ad-3ac4-4b45-8ee0-a27d8df460a1",
      "name": "Webhook Inbound",
      "webhookId": "0496e481-bb76-42f1-b3d5-734935b4b631"
    },
    {
      "parameters": {
        "assignments": {
          "assignments": [
            {
              "id": "project_id",
              "name": "project_id",
              "value": "={{ $json.body.project_id }}",
              "type": "string"
            },
            {
              "id": "provider",
              "name": "provider",
              "value": "={{ $json.body.provider }}",
              "type": "string"
            },
            {
              "id": "language-field-qa",
              "name": "language",
              "value": "={{ $json.body.language || 'es' }}",
              "type": "string"
            },
            {
              "id": "currency-field-qa",
              "name": "currency",
              "value": "={{ $json.body.currency || 'EUR' }}",
              "type": "string"
            }
          ]
        },
        "options": {}
      },
      "type": "n8n-nodes-base.set",
      "typeVersion": 3.4,
      "position": [
        -10096,
        4464
      ],
      "id": "a1a5573a-13be-493e-abd8-6d3eee927263",
      "name": "Set Input Params"
    },
    {
      "parameters": {
        "useCustomSchema": true,
        "schema": "public",
        "operation": "getAll",
        "tableId": "provider_responses",
        "returnAll": true,
        "matchType": "allFilters",
        "filters": {
          "conditions": [
            {
              "keyName": "provider_name",
              "condition": "eq",
              "keyValue": "={{ $('Webhook Inbound').first().json.body.provider }}"
            },
            {
              "keyName": "project_id",
              "condition": "eq",
              "keyValue": "={{ $('Webhook Inbound').first().json.body.project_id }}"
            }
          ]
        }
      },
      "type": "n8n-nodes-base.supabase",
      "typeVersion": 1,
      "position": [
        -9648,
        4464
      ],
      "id": "21bb6d3d-7b1b-4371-aa82-d69d1a2d3800",
      "name": "Fetch All Provider Responses",
      "credentials": {
        "supabaseApi": {
          "id": "pI4CpdYLTiEEBmnz",
          "name": "Supabase account"
        }
      }
    },
    {
      "parameters": {
        "jsCode": "// =============================================\n// NODO: Filter Deficiencies Only\n// Solo incluye items que realmente son deficiencias\n// =============================================\n\nconst items = $input.all();\n\n// Valores que indican deficiencias (necesitan Q&A)\nconst DEFICIENCY_VALUES = [\n  'PARTIALLY INCLUDED',\n  'NOT INCLUDED WITH ALTERNATIVE',\n  'NOT INCLUDED',\n  'NO INFORMATION'\n];\n\n// Valores que NO son deficiencias (no necesitan Q&A)\nconst OK_VALUES = [\n  'INCLUDED',\n  'INCLUDED WITH CAVEATS'\n];\n\nconst filteredItems = items.filter(item => {\n  const evalValue = (item.json.evaluation_value || '').toUpperCase().trim();\n  \n  // Si es un valor OK, excluir\n  if (OK_VALUES.some(v => evalValue === v.toUpperCase())) {\n    return false;\n  }\n  \n  // Caso 1: Es uno de los valores de deficiencia conocidos\n  if (DEFICIENCY_VALUES.some(v => evalValue.includes(v.toUpperCase()))) {\n    return true;\n  }\n  \n  // Caso 2: Empieza con \"NO VALUE FOUND\" (evaluaciÃ³n econÃ³mica sin valor)\n  if (evalValue.startsWith('NO VALUE FOUND')) {\n    return true;\n  }\n  \n  // Caso 3: Score bajo (menor a 5) como indicador de deficiencia\n  const score = item.json.score || 0;\n  if (score < 5) {\n    return true;\n  }\n  \n  // Por defecto, excluir (valores econÃ³micos con precios, etc.)\n  return false;\n});\n\nconsole.log(`ðŸ“‹ Filtrado de deficiencias:`);\nconsole.log(`   â”œâ”€ Total recibidos: ${items.length}`);\nconsole.log(`   â””â”€ Deficiencias encontradas: ${filteredItems.length}`);\n\n// Log de valores excluidos para debug\nconst excluded = items.length - filteredItems.length;\nif (excluded > 0) {\n  console.log(`   â”œâ”€ Excluidos (valores OK o econÃ³micos): ${excluded}`);\n}\n\nreturn filteredItems;"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        -9424,
        4464
      ],
      "id": "259fcd0c-fc98-4177-a81e-7a7e46018b6a",
      "name": "Filter Deficiencies Only"
    },
    {
      "parameters": {
        "useCustomSchema": true,
        "schema": "public",
        "operation": "getAll",
        "tableId": "rfq_items_master",
        "limit": 1,
        "filters": {
          "conditions": [
            {
              "keyName": "id",
              "condition": "eq",
              "keyValue": "={{ $json.requirement_id }}"
            }
          ]
        }
      },
      "type": "n8n-nodes-base.supabase",
      "typeVersion": 1,
      "position": [
        -9200,
        4464
      ],
      "id": "db47659d-0ef5-4c4d-9fa9-75d695303602",
      "name": "Fetch Requirement Specs",
      "credentials": {
        "supabaseApi": {
          "id": "pI4CpdYLTiEEBmnz",
          "name": "Supabase account"
        }
      }
    },
    {
      "parameters": {
        "aggregate": "aggregateAllItemData",
        "destinationFieldName": "total_deficiencies",
        "options": {}
      },
      "type": "n8n-nodes-base.aggregate",
      "typeVersion": 1,
      "position": [
        -8976,
        4464
      ],
      "id": "ea7dc177-812c-46cb-9775-38950cdc50d0",
      "name": "Consolidate Deficiencies"
    },
    {
      "parameters": {
        "promptType": "define",
        "text": "=Generate technical audit questions based on the following deficiencies detected for the provider {{ $(\"Set Input Params\").first().json.provider }}.\n\n**OUTPUT LANGUAGE**: {{ $('Set Input Params').first().json.language === 'en' ? 'ENGLISH - All questions and text must be in English.' : 'SPANISH - All questions and text must be in Spanish.' }}\n**CURRENCY**: {{ $('Set Input Params').first().json.currency || 'EUR' }} (use this currency when referencing monetary values in questions)\n\n**IMPORTANT**: Each deficiency has an \"id\" field which is the requirement_id. You MUST include this requirement_id with each question you generate, linking the question back to its source deficiency.\n\nDEFICIENCIES:\n{{ JSON.stringify($json.total_deficiencies) }}\n\n## PROJECT CONTEXT: {{ $('Fetch Project Context QA').first().json.ai_context }}\n\n## DISCIPLINES:\n{{ $('Fetch Project Context QA').first().json.disciplines ? 'Use ONLY these project-specific disciplines: ' + $('Fetch Project Context QA').first().json.disciplines.join(', ') : 'No disciplines defined yet for this project. You MUST first determine the appropriate engineering disciplines based on the project context and the deficiencies provided. Typical disciplines include: Electrical, Mechanical, Civil, Process, Instrumentation, Structural, Environmental, General, etc. Choose the ones that best fit this specific project.' }}\n\n### INSTRUCTIONS:\n1.  **Link to Requirement**: Each question MUST include the \"requirement_id\" (the \"id\" field from the deficiency it relates to).\n2.  **Determine Disciplines**: First, identify the relevant engineering disciplines for THIS project based on the deficiencies and project context. Then classify each question into the most specific discipline.\n    - Be as specific as possible. Do not label everything as \"General\".\n    - Only use \"General\" if it is truly administrative or multi-disciplinary.\n3.  **Language**: All questions and text MUST be in {{ $('Set Input Params').first().json.language === 'en' ? 'English' : 'Spanish' }}.\n4.  **Format**: Respond strictly with the JSON object following the schema.\n\n### OUTPUT SCHEMA:\n{\n  \"disciplines\": [\"list of all unique discipline names used in the questions below\"],\n  \"questions\": [\n    {\n      \"requirement_id\": \"uuid-from-deficiency-id-field\",\n      \"discipline\": \"One of the disciplines listed above\",\n      \"question\": \"The specific question in {{ $('Set Input Params').first().json.language === 'en' ? 'English' : 'Spanish' }}\",\n      \"importance\": \"High\" | \"Medium\" | \"Low\"\n    }\n  ]\n}",
        "hasOutputParser": true,
        "batching": {}
      },
      "type": "@n8n/n8n-nodes-langchain.chainLlm",
      "typeVersion": 1.8,
      "position": [
        -8752,
        4464
      ],
      "id": "6f6a7ac3-8c58-460c-bb29-a9937675dc1b",
      "name": "QA Generation Chain"
    },
    {
      "parameters": {
        "schemaType": "manual",
        "inputSchema": "{\n  \"type\": \"object\",\n  \"properties\": {\n    \"disciplines\": {\n      \"type\": \"array\",\n      \"items\": { \"type\": \"string\" }\n    },\n    \"questions\": {\n      \"type\": \"array\",\n      \"items\": {\n        \"type\": \"object\",\n        \"properties\": {\n          \"requirement_id\": { \"type\": \"string\" },\n          \"discipline\": { \"type\": \"string\" },\n          \"question\": { \"type\": \"string\" },\n          \"importance\": { \"type\": \"string\" }\n        }\n      }\n    }\n  }\n}"
      },
      "type": "@n8n/n8n-nodes-langchain.outputParserStructured",
      "typeVersion": 1.3,
      "position": [
        -8608,
        4688
      ],
      "id": "e6d53368-cf44-4ada-91c3-096d98deb1b7",
      "name": "JSON Output Parser"
    },
    {
      "parameters": {
        "fieldToSplitOut": "output.questions",
        "include": "allOtherFields",
        "options": {}
      },
      "type": "n8n-nodes-base.itemLists",
      "typeVersion": 3.1,
      "position": [
        -8400,
        4464
      ],
      "id": "dc3bcf6e-b4a3-4b13-bce2-049b0d78efac",
      "name": "Split Questions List"
    },
    {
      "parameters": {
        "useCustomSchema": true,
        "schema": "public",
        "tableId": "qa_audit",
        "fieldsUi": {
          "fieldValues": [
            {
              "fieldId": "question",
              "fieldValue": "={{ $json['output.questions'].question }}"
            },
            {
              "fieldId": "importance",
              "fieldValue": "={{ $json['output.questions'].importance }}"
            },
            {
              "fieldId": "discipline",
              "fieldValue": "={{ $json['output.questions'].discipline }}"
            },
            {
              "fieldId": "provider_name",
              "fieldValue": "={{ $(\"Set Input Params\").first().json.provider }}"
            },
            {
              "fieldId": "project_id",
              "fieldValue": "={{ $(\"Set Input Params\").first().json.project_id }}"
            },
            {
              "fieldId": "requirement_id",
              "fieldValue": "={{ $json['output.questions'].requirement_id }}"
            },
            {
              "fieldId": "status",
              "fieldValue": "Pending"
            }
          ]
        }
      },
      "type": "n8n-nodes-base.supabase",
      "typeVersion": 1,
      "position": [
        -8176,
        4464
      ],
      "id": "b867b031-b883-4625-8a0f-40ab87bc564f",
      "name": "Supabase Insert",
      "credentials": {
        "supabaseApi": {
          "id": "pI4CpdYLTiEEBmnz",
          "name": "Supabase account"
        }
      }
    },
    {
      "parameters": {
        "jsCode": "// Extract unique disciplines from the QA Generation Chain output\n// and merge with existing project disciplines\nconst qaOutput = $('QA Generation Chain').first().json.output || {};\nconst generatedDisciplines = qaOutput.disciplines || [];\nconst existingDisciplines = $('Fetch Project Context QA').first().json.disciplines || [];\n\n// Merge: existing + new, deduplicated\nconst allDisciplines = [...new Set([...existingDisciplines, ...generatedDisciplines])];\nconst projectId = $('Set Input Params').first().json.project_id;\n\n// Format as PostgreSQL array literal for safe Supabase handling\nconst pgArray = '{' + allDisciplines.map(d => '\"' + d.replace(/\"/g, '\\\\\"') + '\"').join(',') + '}';\n\nconsole.log(`ðŸ“‹ Disciplines for project ${projectId}:`);\nconsole.log(`   â”œâ”€ Existing: ${existingDisciplines.join(', ') || 'none'}`);\nconsole.log(`   â”œâ”€ Generated: ${generatedDisciplines.join(', ')}`);\nconsole.log(`   â””â”€ Merged (${allDisciplines.length}): ${allDisciplines.join(', ')}`);\n\nreturn [{ json: { project_id: projectId, disciplines: pgArray } }];"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        -7952,
        4464
      ],
      "id": "b3476e83-b750-41ba-af86-5d67593eb62e",
      "name": "Extract Disciplines"
    },
    {
      "parameters": {
        "useCustomSchema": true,
        "schema": "public",
        "operation": "update",
        "tableId": "projects",
        "fieldsUi": {
          "fieldValues": [
            {
              "fieldId": "id",
              "fieldValue": "={{ $json.project_id }}"
            },
            {
              "fieldId": "disciplines",
              "fieldValue": "={{ $json.disciplines }}"
            }
          ]
        }
      },
      "type": "n8n-nodes-base.supabase",
      "typeVersion": 1,
      "position": [
        -7728,
        4464
      ],
      "id": "334caf93-14cd-4f05-957d-38bb047b53ed",
      "name": "Save Project Disciplines",
      "credentials": {
        "supabaseApi": {
          "id": "pI4CpdYLTiEEBmnz",
          "name": "Supabase account"
        }
      }
    },
    {
      "parameters": {
        "respondWith": "allIncomingItems",
        "options": {}
      },
      "type": "n8n-nodes-base.respondToWebhook",
      "typeVersion": 1.5,
      "position": [
        -7504,
        4464
      ],
      "id": "f57a840d-918f-46b9-97d0-587157a8accb",
      "name": "Respond to Webhook1"
    },
    {
      "parameters": {
        "content": "## Q&A Generator\n\n**Updated**: Dynamic disciplines per project + deficiency filtering.\n\n**Disciplines**:\n- Generated dynamically by the LLM based on project context\n- Saved to `projects.disciplines` for reuse in future runs\n- If project already has disciplines, LLM uses those\n- Merged: existing + new, deduplicated\n\n**Deficiencies filtered**:\n- PARTIALLY INCLUDED\n- NOT INCLUDED WITH ALTERNATIVE\n- NOT INCLUDED\n- NO INFORMATION\n- NO VALUE FOUND - *\n- Any item with score < 5\n\n**Excluded** (not deficiencies):\n- INCLUDED\n- INCLUDED WITH CAVEATS\n- Economic values (prices, hours, etc.)\n\n**Flow**:\n1. Receive project_id and provider\n2. Fetch project context (incl. existing disciplines)\n3. Fetch ALL provider_responses\n4. Filter only deficiencies (Code node)\n5. Fetch requirement details for each\n6. Generate questions + disciplines with LLM\n7. Save questions to qa_audit\n8. Extract & merge disciplines\n9. Save disciplines to project",
        "height": 1232,
        "width": 3448,
        "color": 7
      },
      "type": "n8n-nodes-base.stickyNote",
      "typeVersion": 1,
      "position": [
        -10688,
        3840
      ],
      "id": "1957c32d-4ccc-4f96-b2b8-f972839b446d",
      "name": "Sticky Note1"
    },
    {
      "parameters": {
        "model": "mistral-large-latest",
        "options": {
          "temperature": 0.1
        }
      },
      "type": "@n8n/n8n-nodes-langchain.lmChatMistralCloud",
      "typeVersion": 1,
      "position": [
        -8736,
        4688
      ],
      "id": "f7bbb317-a4c6-4d8f-9cf7-c04d36b8c69b",
      "name": "Mistral Cloud Chat Model",
      "credentials": {
        "mistralCloudApi": {
          "id": "tDjuOnF6lpADMmd5",
          "name": "Mistral Cloud account"
        }
      }
    },
    {
      "parameters": {
        "useCustomSchema": true,
        "schema": "public",
        "operation": "get",
        "tableId": "projects",
        "filters": {
          "conditions": [
            {
              "keyName": "id",
              "keyValue": "={{ $('Set Input Params').first().json.project_id }}"
            }
          ]
        }
      },
      "id": "f3ae2d6e-31f8-4a97-8d8e-29fb7f2c6760",
      "name": "Fetch Project Context QA",
      "type": "n8n-nodes-base.supabase",
      "typeVersion": 1,
      "position": [
        -9872,
        4464
      ],
      "credentials": {
        "supabaseApi": {
          "id": "pI4CpdYLTiEEBmnz",
          "name": "Supabase account"
        }
      }
    },
    {
      "parameters": {
        "content": "### Ingesta de RFQ, actualizaciÃ³n de requisitos",
        "height": 1280,
        "width": 4390,
        "color": 4
      },
      "type": "n8n-nodes-base.stickyNote",
      "typeVersion": 1,
      "position": [
        -4896,
        5552
      ],
      "id": "14a8a5c8-f50c-45d7-8510-484a74d45fe7",
      "name": "Sticky Note"
    },
    {
      "parameters": {
        "httpMethod": "POST",
        "path": "ingesta-rfq",
        "responseMode": "responseNode",
        "options": {}
      },
      "type": "n8n-nodes-base.webhook",
      "typeVersion": 2.1,
      "position": [
        -4784,
        5776
      ],
      "id": "5d91594a-0f60-4c83-9be5-822b98130e51",
      "name": "Webhook RFQ",
      "webhookId": "86850b01-70b4-4c99-a63a-6ccad35c0be2"
    },
    {
      "parameters": {
        "jsCode": "// =============================================\n// NODO: Preparar Texto (Agregador de PÃ¡ginas)\n// =============================================\n\nconst items = $input.all();\nif (!items || items.length === 0) {\n    return { json: { error: \"No input items received\" } };\n}\n\n// Recuperar metadatos del inicio del flujo (Generate IDs1)\nlet metadata = {};\ntry {\n    metadata = $('Generate IDs1').first().json;\n} catch (e) {\n    console.log(\"âš ï¸ No se pudo recuperar metadata de Generate IDs1\");\n}\n\n// 1. Agregado de Texto Completo (todas las pÃ¡ginas)\n// Intentamos md_content primero (mejor para LLMs), luego text\nlet fullText = items.map(item => item.json.md_content || item.json.text || \"\").join('\\n\\n').trim();\n\nif (!fullText) {\n    console.log(\"âš ï¸ Advertencia: No se extrajo texto del documento.\");\n}\n\n// 2. Limpieza bÃ¡sica\nfullText = fullText.replace(/\\x00/g, ''); // Eliminar caracteres nulos\n\n// 3. Preparar fragmento para clasificaciÃ³n (mÃ¡x 40k chars para no saturar context)\nconst textForClassification = fullText.substring(0, 40000);\n\nconsole.log(`âœ… Texto preparado: ${items.length} pÃ¡ginas aggregadas. Chars: ${fullText.length}`);\n\nreturn {\n    json: {\n        rfq_project_id: metadata.rfq_project_id || \"unknown\",\n        rfq_document_id: metadata.rfq_document_id || \"unknown\",\n        project_name: metadata.project_name || \"Sin Nombre\",\n        file_title: metadata.file_title || \"document.pdf\",\n        text: fullText, \n        text_for_classification: textForClassification || \"SIN TEXTO DETECTADO\",\n        pages_count: items.length\n    }\n};"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        -3664,
        5776
      ],
      "id": "f8fa7db0-0d68-4782-a7b4-05e71cd03fc8",
      "name": "Preparar Texto1"
    },
    {
      "parameters": {
        "promptType": "define",
        "text": "=### DOCUMENTO RFQ\n\nNombre del Archivo: {{ $json.file_title }}\nNombre Proyect: {{ $('Webhook RFQ').item.json.body.project_name }}\n### CONTENIDO (FRAGMENTO):\n{{ $json.pages ? $json.pages.slice(0, 1).map(p => p.text).join('\\n\\n') : ($json.text ? $json.text.substring(0, 2000) : 'SIN TEXTO') }}",
        "hasOutputParser": true,
        "messages": {
          "messageValues": [
            {
              "message": "=## TAREA: CLASIFICAR UN DOCUMENTO EN EXACTAMENTE 1 TIPO DE EVALUACIÃ“N\n\nEres un clasificador de documentos de licitaciÃ³n.\nCada documento pertenece a UN SOLO tipo. No hay excepciones.\n\n### REGLA ABSOLUTA\n**1 documento = 1 tipo. Siempre.**\nEl array tipos_detectados SIEMPRE debe contener EXACTAMENTE 1 elemento.\nNunca 2, nunca 3. Siempre 1.\n\n### LOS 3 TIPOS (elige UNO)\n\n1. **Economical Evaluation** â† Prioridad alta si hay precios\n   - Tablas de precios, tarifas, rates, EUR/h, USD/day\n   - Pricing schedule, cost breakdown, budget\n   - Condiciones de pago, garantÃ­as financieras\n   - CotizaciÃ³n econÃ³mica, commercial proposal\n\n2. **Technical Evaluation** â† Prioridad media\n   - Scope of Work, especificaciones tÃ©cnicas\n   - Requisitos de ingenierÃ­a, metodologÃ­a, normativas\n   - Entregables tÃ©cnicos, deliverables, listas de documentos\n   - Criterios de diseÃ±o, requisitos de personal\n   - Fases de proyecto (Pre-FEED, FEED, EPC, etc.)\n\n3. **Others** â† Todo lo demÃ¡s\n   - InformaciÃ³n administrativa, legal, contractual\n   - DocumentaciÃ³n general, Ã­ndices, portadas\n   - Cualquier cosa que no sea claramente tÃ©cnica ni econÃ³mica\n\n### CÃ“MO DECIDIR\n\n- Â¿El documento habla PRINCIPALMENTE de precios, costes o tarifas? â†’ **Economical Evaluation**\n- Â¿El documento habla PRINCIPALMENTE de requisitos tÃ©cnicos, alcance o entregables? â†’ **Technical Evaluation**\n- Â¿No encaja claramente en ninguno de los dos anteriores? â†’ **Others**\n\nEl nombre del archivo (RFQ, RFP, etc.) NO determina el tipo. Solo el CONTENIDO real del documento determina el tipo.\n\n### FORMATO DE SALIDA (JSON PLANO â€“ ESTRICTO)\n\n1. Devuelve **ÃšNICAMENTE** un objeto JSON que empiece por `{` y termine por `}`.\n2. **PROHIBIDO** devolver el JSON dentro de una lista o array `[]`.\n3. **PROHIBIDO** usar claves contenedoras como `\"output\"`, `\"response\"` o `\"json\"`.\n4. No incluyas bloques de cÃ³digo markdown (\\`\\`\\`json). Solo el texto plano del JSON.\n5. tipos_detectados DEBE tener EXACTAMENTE 1 elemento.\n\n**EJEMPLO CORRECTO:**\n{\n  \"tipos_detectados\": [\"Technical Evaluation\"],\n  \"razonamiento\": \"El documento describe el alcance tÃ©cnico del proyecto con requisitos de ingenierÃ­a.\"\n}"
            }
          ]
        },
        "batching": {}
      },
      "type": "@n8n/n8n-nodes-langchain.chainLlm",
      "typeVersion": 1.8,
      "position": [
        -3968,
        6016
      ],
      "id": "30a2332d-0f64-4ab8-954b-ad5165661f53",
      "name": "Clasificador de Tipos1"
    },
    {
      "parameters": {
        "model": "mistral:7b",
        "options": {
          "temperature": 0.1
        }
      },
      "type": "@n8n/n8n-nodes-langchain.lmOllama",
      "typeVersion": 1,
      "position": [
        -4016,
        6240
      ],
      "id": "9aca0338-9cc2-4d6b-9f34-c325355babb4",
      "name": "Ollama Clasificador1",
      "credentials": {
        "ollamaApi": {
          "id": "oS2Qqti9oVfsm8XZ",
          "name": "Ollama account"
        }
      }
    },
    {
      "parameters": {
        "schemaType": "manual",
        "inputSchema": "{\n  \"type\": \"object\",\n  \"properties\": {\n    \"tipos_detectados\": {\n      \"type\": \"array\",\n      \"items\": {\n        \"type\": \"string\",\n        \"enum\": [\"Technical Evaluation\", \"Economical Evaluation\", \"Others\"]\n      },\n      \"minItems\": 1,\n      \"maxItems\": 1\n    },\n    \"razonamiento\": {\n      \"type\": \"string\"\n    }\n  },\n  \"required\": [\"tipos_detectados\"]\n}"
      },
      "type": "@n8n/n8n-nodes-langchain.outputParserStructured",
      "typeVersion": 1.3,
      "position": [
        -3776,
        6240
      ],
      "id": "57a366c6-7880-4019-8d34-d3a6a89241b9",
      "name": "Output Parser1"
    },
    {
      "parameters": {
        "jsCode": "// =============================================\n// NODO: Expandir por Tipo (CORREGIDO)\n// =============================================\n\n// 1. Recuperar metadatos de nodos anteriores\nlet projectId = \"unknown\";\nlet documentId = \"unknown\";\nlet fileTitle = \"unknown\";\nlet fullText = \"\";\nlet metadataProjectName = \"\";\n\ntry {\n    const textNode = $('Preparar Texto1').first().json;\n    projectId = textNode.rfq_project_id || \"unknown\";\n    documentId = textNode.rfq_document_id || \"unknown\";\n    fileTitle = textNode.file_title || \"unknown\";\n    fullText = textNode.text || \"\";\n    metadataProjectName = textNode.project_name || \"\"; \n} catch(e) {\n    console.log(\"âš ï¸ No se pudieron leer metadatos de Preparar Texto1\");\n}\n\n// 2. Obtener los tipos DIRECTAMENTE del Clasificador (no del input actual)\nlet tipos = [];\nlet nombreProyecto = \"\";\n\ntry {\n    const clasificadorData = $('Clasificador de Tipos1').first().json;\n    \n    // El clasificador puede devolver el output de diferentes formas\n    let output = clasificadorData.output || clasificadorData;\n    \n    // Intentar parsear si es string\n    if (typeof output === 'string') {\n        try {\n            const clean = output.replace(/```json/gi, '').replace(/```/g, '').trim();\n            const start = clean.indexOf('{');\n            const end = clean.lastIndexOf('}');\n            if (start !== -1 && end !== -1) {\n                output = JSON.parse(clean.substring(start, end + 1));\n            } else {\n                output = JSON.parse(clean);\n            }\n        } catch(e) {\n            console.log(\"âš ï¸ Error parseando output del clasificador\");\n        }\n    }\n    \n    // Extraer tipos y nombre del proyecto\n    tipos = output.tipos_detectados || [];\n    nombreProyecto = output.nombre_proyecto || \"\";\n    \n    console.log(`âœ… Tipos detectados por IA: ${JSON.stringify(tipos)}`);\n} catch(e) {\n    console.log(\"âš ï¸ Error recuperando datos del Clasificador de Tipos1\");\n}\n\n// 3. ValidaciÃ³n y fallback SOLO si NO hay tipos\nif (!Array.isArray(tipos)) tipos = [];\n\nif (tipos.length === 0) {\n    // Fallback: si el clasificador fallÃ³, asignar Technical por defecto\n    tipos = [\"Technical Evaluation\"];\n    console.log(\"âš ï¸ Fallback: Clasificador fallÃ³, usando Technical Evaluation por defecto\");\n}\n\n// Forzar siempre 1 solo tipo (el primero detectado)\nif (tipos.length > 1) {\n    console.log(`âš ï¸ Clasificador devolviÃ³ ${tipos.length} tipos: ${tipos.join(', ')}. Usando solo el primero.`);\n    tipos = [tipos[0]];\n}\n\n// Normalizar tipos: mapear tipos antiguos a los 3 vÃ¡lidos\nconst VALID_TYPES = ['Technical Evaluation', 'Economical Evaluation', 'Others'];\ntipos = tipos.map(t => {\n    if (VALID_TYPES.includes(t)) return t;\n    if (t.includes('Deliverables') || t.includes('FEED')) return 'Others';\n    return 'Others';\n});\n\n// Eliminar duplicados\ntipos = [...new Set(tipos)];\n\n// 4. Nombre del Proyecto\nlet finalProjectName = nombreProyecto || metadataProjectName;\n\nif (!finalProjectName || finalProjectName === \"Sin Nombre\" || finalProjectName.includes(\"La Zaida\")) {\n    finalProjectName = fileTitle.replace(/\\.pdf$/i, '') + \" (Project)\";\n}\n\nconsole.log(`ðŸ“‹ Expandiendo ${tipos.length} tipos: ${tipos.join(', ')}`);\n\n// 5. Generar Salida (Expandir items)\nreturn tipos.map((tipo, idx) => ({\n    json: {\n        tipo_evaluacion: tipo,\n        rfq_project_id: projectId,\n        rfq_document_id: documentId,\n        nombre_proyecto: finalProjectName,\n        file_title: fileTitle,\n        texto_rfq: fullText,\n        indice: idx + 1,\n        total_tipos: tipos.length\n    }\n}));"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        -3008,
        6016
      ],
      "id": "46fefed6-9983-49f8-bb58-1e1a8e8fca6f",
      "name": "Expandir por Tipo1"
    },
    {
      "parameters": {
        "options": {}
      },
      "type": "n8n-nodes-base.splitInBatches",
      "typeVersion": 3,
      "position": [
        -2800,
        6016
      ],
      "id": "e75fc86d-2d9c-444c-af2a-0ba84dc89ba0",
      "name": "Loop por Tipo1"
    },
    {
      "parameters": {
        "jsCode": "// =============================================\n// NODO: Parsear Final (Con Nombre Proyecto)\n// =============================================\nconst inputJson = $input.first().json;\n// Asegurar que sea string\nlet llmOutput = \"\";\nif (typeof inputJson === 'string') llmOutput = inputJson;\nelse if (inputJson.text && typeof inputJson.text === 'string') llmOutput = inputJson.text;\nelse if (inputJson.output && typeof inputJson.output === 'string') llmOutput = inputJson.output;\nelse if (inputJson.content && typeof inputJson.content === 'string') llmOutput = inputJson.content;\nelse llmOutput = JSON.stringify(inputJson.text || inputJson.output || inputJson.content || inputJson);\n\nllmOutput = String(llmOutput || \"[]\");\n\n// 1. Recuperar Contexto del Loop\nlet projectId = \"unknown\";\nlet documentId = \"unknown\";\nlet tipoEvaluacion = \"Unknown\";\nlet nombreProyecto = \"Sin Nombre\";\n\ntry {\n    const loopData = $('Loop por Tipo1').first().json;\n    projectId = loopData.rfq_project_id;\n    documentId = loopData.rfq_document_id;\n    tipoEvaluacion = loopData.tipo_evaluacion;\n    nombreProyecto = loopData.nombre_proyecto || \"Sin Nombre\";\n} catch(e) {}\n\n// 2. LÃ³gica de Parsing\nlet items = [];\n\ntry {\n    let clean = llmOutput.replace(/```json/gi, '').replace(/```/g, '').trim();\n    const start = clean.indexOf('[');\n    const end = clean.lastIndexOf(']');\n    if (start !== -1 && end !== -1) {\n        items = JSON.parse(clean.substring(start, end + 1));\n    }\n} catch(e) {}\n\nif (items.length === 0) {\n    const lines = llmOutput.split('\\n');\n    let currentPhase = \"General\";\n    for (let i = 0; i < lines.length; i++) {\n        const line = lines[i].trim();\n        if (!line) continue;\n        if (/^\\d+\\./.test(line) && !line.includes('Estimate')) {\n            const text = line.replace(/^\\d+\\.\\s*/, '').trim();\n            if (i+1 < lines.length && (lines[i+1].trim().startsWith('-') || lines[i+1].trim().startsWith('â€¢'))) {\n                currentPhase = text;\n            } else {\n                 items.push({ fase: \"General\", requisito_rfq: text });\n            }\n        }\n        else if (line.startsWith('-') || line.startsWith('â€¢')) {\n            items.push({ fase: currentPhase, requisito_rfq: line.replace(/^[-â€¢]\\s*/, '').trim() });\n        }\n    }\n}\n\nfunction generateId(str) {\n    let hash = 0;\n    for (let i = 0; i < str.length; i++) {\n        hash = ((hash << 5) - hash) + str.charCodeAt(i);\n        hash = hash & hash;\n    }\n    return 'item_' + Math.abs(hash).toString(16).padStart(12, '0');\n}\n\nreturn items.map(item => ({\n    json: {\n        rfq_project_id: projectId,\n        project_name: nombreProyecto,\n        rfq_document_id: documentId,\n        evaluation: tipoEvaluacion,\n        fase: item.fase || \"General\",\n        requisito_rfq: item.requisito_rfq || \"Sin Nombre\"\n    }\n}));"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        -1232,
        5952
      ],
      "id": "934f1445-0ca8-4d44-b59c-0f6ccd29fe95",
      "name": "Parsear Items1"
    },
    {
      "parameters": {
        "jsCode": "// =============================================\n// NODO: Agregar Resultados del Tipo Actual\n// =============================================\n\nconst items = $input.all();\n\n// Contar items insertados\nconst totalInserted = items.length;\n\n// Recuperar info del tipo actual\nlet tipoActual = \"unknown\";\ntry {\n    tipoActual = $('Loop por Tipo1').first().json.tipo_evaluacion;\n} catch(e) {}\n\nconsole.log(`âœ… Tipo ${tipoActual}: ${totalInserted} items insertados`);\n\nreturn {\n    json: {\n        tipo_procesado: tipoActual,\n        items_insertados: totalInserted,\n        continuar_loop: true\n    }\n};"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        -704,
        6144
      ],
      "id": "81c783fd-cf97-400a-be23-018f5e08e157",
      "name": "Agregar Resultados1"
    },
    {
      "parameters": {
        "jsCode": "// =============================================\n// NODO: Resumen Final\n// =============================================\n\n// Recuperar datos del proyecto\nlet projectId = \"unknown\";\nlet fileTitle = \"unknown\";\nlet tiposDetectados = [];\n\ntry {\n    const projectNode = $('Generate IDs1').first().json;\n    projectId = projectNode.rfq_project_id;\n    fileTitle = projectNode.file_title;\n} catch(e) {}\n\ntry {\n    const clasificador = $('Clasificador de Tipos1').first().json;\n    const output = clasificador.output || clasificador;\n    tiposDetectados = output.tipos_detectados || [];\n} catch(e) {}\n\nconsole.log(\"========================================\");\nconsole.log(\"âœ… PROCESAMIENTO RFQ COMPLETADO\");\nconsole.log(`   Proyecto: ${projectId}`);\nconsole.log(`   Archivo: ${fileTitle}`);\nconsole.log(`   Tipos procesados: ${tiposDetectados.length}`);\nconsole.log(\"========================================\");\n\nreturn {\n    json: {\n        success: true,\n        rfq_project_id: projectId,\n        file_title: fileTitle,\n        tipos_procesados: tiposDetectados,\n        mensaje: `RFQ procesada correctamente. ${tiposDetectados.length} tipo(s) de evaluaciÃ³n detectados y poblados.`\n    }\n};"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        -1504,
        5616
      ],
      "id": "a420c9af-56ae-414d-b373-a1b1650e4101",
      "name": "Resumen Final1"
    },
    {
      "parameters": {
        "respondWith": "json",
        "responseBody": "={{ JSON.stringify($json) }}",
        "options": {}
      },
      "type": "n8n-nodes-base.respondToWebhook",
      "typeVersion": 1.5,
      "position": [
        -1216,
        5616
      ],
      "id": "cd322166-6d26-481a-ad6a-71d97bffa0eb",
      "name": "Respond Success1"
    },
    {
      "parameters": {
        "jsCode": "// =============================================\n// NODO: Base64 a Binary\n// =============================================\n\n// Recuperar metadatos del inicio del flujo (Generate IDs1)\nlet inputData = {};\ntry {\n    inputData = $('Generate IDs1').first().json;\n} catch (e) {\n    inputData = $json; // Fallback\n}\n\nconst base64Data = inputData.file_binary;\n\nif (!base64Data || base64Data === \"\") {\n    throw new Error(\"âŒ CRÃTICO: 'file_binary' estÃ¡ vacÃ­o\");\n}\n\nconst binaryData = Buffer.from(base64Data, 'base64');\n\nconsole.log(`âœ… PDF convertido: ${binaryData.length} bytes`);\n\nreturn {\n    json: {\n        rfq_project_id: inputData.rfq_project_id || \"unknown\",\n        rfq_document_id: inputData.rfq_document_id || \"unknown\",\n        project_name: inputData.project_name || \"Sin Nombre\",\n        file_title: inputData.file_title || \"document.pdf\"\n    },\n    binary: {\n        data: {\n            data: binaryData.toString('base64'),\n            mimeType: 'application/pdf',\n            fileName: inputData.file_title || 'rfq.pdf',\n            fileSize: binaryData.length\n        }\n    }\n};"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        -4112,
        5776
      ],
      "id": "3ac1a502-91ab-42d7-8d0a-1d6a646fc43e",
      "name": "Base64 a Binary3"
    },
    {
      "parameters": {
        "operation": "pdf",
        "options": {}
      },
      "type": "n8n-nodes-base.extractFromFile",
      "typeVersion": 1.1,
      "position": [
        -3888,
        5776
      ],
      "id": "ea4ebbf7-ea2a-43b8-a58a-cff8a6411517",
      "name": "Extract from File3"
    },
    {
      "parameters": {
        "jsCode": "// =============================================\n// NODO: Generate Stable ID + Detectar Modo (CORREGIDO)\n// Con soporte para project_id (UUID) del frontend\n// =============================================\n\nfunction simpleHash(str) {\n  let hash = 0;\n  for (let i = 0; i < str.length; i++) {\n    const char = str.charCodeAt(i);\n    hash = ((hash << 5) - hash) + char;\n    hash = hash & hash;\n  }\n  return Math.abs(hash).toString(16).padStart(16, '0').substring(0, 16);\n}\n\n// Aseguramos capturar el body correctamente desde el nodo anterior\nconst body = $json.body || $json;\n\n// CAMPOS BÃSICOS\nconst originalFileId = body.file_id || \"unknown\";\nconst fileTitle = body.file_title || \"unknown.pdf\";\nconst fileBinary = body.file_binary || \"\";\nconst fileUrl = body.file_url || \"unknown\";\n\n// âœ… EXTRAER project_id (UUID) del payload del frontend\nconst projectIdFromPayload = body.project_id || null;\n\n// âœ… EXTRAER METADATA DEL USUARIO\n// Usamos el operador ?. para evitar errores si metadata no existe\nconst metadata = body.metadata || {};\nconst rfqProjectName = metadata.proyect_name || body.project_name || null;\nconst userProveedor = metadata.proveedor || null;\nconst userTipoEval = metadata.evaluation || null;\nconst language = body.language || metadata.language || 'es'; \n\n// âœ… DETERMINAR MODO DE OPERACIÃ“N\nlet modoOperacion = \"CLASIFICADOR\"; \nlet datosCompletos = false;\n\nif (userProveedor && userTipoEval && Array.isArray(userTipoEval) && userTipoEval.length > 0) {\n    modoOperacion = \"VALIDADOR\";\n    datosCompletos = true;\n} else if (userProveedor || (userTipoEval && Array.isArray(userTipoEval) && userTipoEval.length > 0)) {\n    modoOperacion = \"HIBRIDO\";\n}\n\n// Generar ID estable basado en tÃ­tulo + project_id (evita colisiones entre proyectos)\nconst normalizedTitle = fileTitle.toLowerCase().trim();\nconst stableId = simpleHash(normalizedTitle + '_' + (projectIdFromPayload || ''));\n\n// ID de Documento (Ãºnico por contenido + proyecto)\nconst documentId = 'doc_' + stableId;\n\nconsole.log('ðŸ“‹ Generate IDs - project_id from frontend:', projectIdFromPayload);\n\nreturn {\n  json: {\n    file_id: stableId, // Este es tu ID estable\n    rfq_document_id: documentId,\n    file_id_original: originalFileId,\n    file_title: fileTitle,\n    file_binary: fileBinary,\n    file_url: fileUrl,\n    \n    // âœ… project_id (UUID) real del frontend - usado para filtrar por proyecto\n    project_id: projectIdFromPayload,\n    \n    // Si no hay nombre de proyecto, usamos el nombre del archivo como fallback\n    project_name: rfqProjectName || fileTitle.replace(/\\.[^/.]+$/, \"\"),\n    rfq_project_id: projectIdFromPayload || (rfqProjectName ? 'proj_' + simpleHash(rfqProjectName.toLowerCase().trim()) : 'proj_generic'),\n    \n    user_proveedor: userProveedor,\n    user_tipo_evaluacion: userTipoEval,\n    modo_operacion: modoOperacion,\n    datos_usuario_completos: datosCompletos,\n    \n    // Idioma para salidas LLM\n    language: language,\n    \n    // Guardamos una copia limpia para los nodos siguientes\n    metadata_limpia: {\n        proyect_name: rfqProjectName,\n        proveedor: userProveedor,\n        evaluation: userTipoEval\n    }\n  }\n};"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        -4560,
        5776
      ],
      "id": "14901eeb-a440-410e-a71f-c28bb605618b",
      "name": "Generate IDs1"
    },
    {
      "parameters": {
        "rules": {
          "values": [
            {
              "conditions": {
                "options": {
                  "caseSensitive": true,
                  "leftValue": "",
                  "typeValidation": "strict",
                  "version": 3
                },
                "conditions": [
                  {
                    "leftValue": "={{ $json.tipo_evaluacion }}",
                    "rightValue": "Evaluation",
                    "operator": {
                      "type": "string",
                      "operation": "contains"
                    },
                    "id": "c3ac36b0-dcd7-4e84-a72a-7e88b6f2fc2a"
                  }
                ],
                "combinator": "and"
              }
            },
            {
              "conditions": {
                "options": {
                  "caseSensitive": true,
                  "leftValue": "",
                  "typeValidation": "strict",
                  "version": 3
                },
                "conditions": [
                  {
                    "id": "529ee554-7a05-413a-9782-710d0deb6365",
                    "leftValue": "={{ $json.tipo_evaluacion }}",
                    "rightValue": "Others",
                    "operator": {
                      "type": "string",
                      "operation": "contains"
                    }
                  }
                ],
                "combinator": "and"
              }
            }
          ]
        },
        "options": {}
      },
      "type": "n8n-nodes-base.switch",
      "typeVersion": 3.4,
      "position": [
        -1904,
        6144
      ],
      "id": "1df4655a-1f61-44d2-9ed3-8a8b5c1b1042",
      "name": "Switch1"
    },
    {
      "parameters": {
        "model": "qwen3:8b",
        "options": {
          "temperature": 0.1,
          "numCtx": 8192,
          "numPredict": 2048
        }
      },
      "type": "@n8n/n8n-nodes-langchain.lmOllama",
      "typeVersion": 1,
      "position": [
        -1648,
        6592
      ],
      "id": "d4fac804-e734-4610-8de3-a72ce0a5e4e6",
      "name": "Ollama Extractor2",
      "credentials": {
        "ollamaApi": {
          "id": "oS2Qqti9oVfsm8XZ",
          "name": "Ollama account"
        }
      }
    },
    {
      "parameters": {
        "promptType": "define",
        "text": "=### {{ $('Generate IDs1').first().json.language === 'en' ? 'TASK: MASSIVE DELIVERABLES EXTRACTION' : 'TAREA: EXTRACCION MASIVA DE ENTREGABLES (DELIVERABLES)' }}\n\nOutput language: {{ $('Generate IDs1').first().json.language === 'en' ? 'ENGLISH' : 'ESPANOL' }}\n\n{{ $('Generate IDs1').first().json.language === 'en' ? '**OBJECTIVE:** Extract **ALL** documents, drawings and deliverables listed. **TOTAL EXHAUSTIVENESS**.\\n\\n### CRITICAL INSTRUCTIONS (DO NOT SUMMARIZE):\\n1. **TABLES:** If you find a table, extract **EACH ROW**. If there are 140 rows, return 140 items.\\n2. **DO NOT GROUP:** Maintain granularity.\\n3. **PHASES:** Infer the phase/discipline. If not possible, use General.' : '**OBJETIVO:** Extraer **TODOS** los documentos, planos y entregables listados. **EXHAUSTIVIDAD TOTAL**.\\n\\n### INSTRUCCIONES CRITICAS (NO RESUMIR):\\n1. **TABLAS:** Si encuentras una tabla, extrae **CADA FILA**. Si hay 140 filas, devuelve 140 items.\\n2. **NO AGRUPES:** Manten la granularidad.\\n3. **FASES:** Infiere la fase/disciplina. Si no, usa General.' }}\n\nProyecto: {{ $json.nombre_proyecto }}\nEvaluacion: {{ $('Loop por Tipo1').item.json.tipo_evaluacion }}\nArchivo: {{ $('Generate IDs1').first().json.file_title }}\n\n### {{ $('Generate IDs1').first().json.language === 'en' ? 'PDF TEXT' : 'TEXTO DEL PDF' }}:\n{{ $json.texto_chunk }}\n\n### {{ $('Generate IDs1').first().json.language === 'en' ? 'OUTPUT FORMAT' : 'FORMATO DE SALIDA' }}:\n```json\n[\n  { \"fase\": \"Process\", \"requisito_rfq\": \"PFD\" },\n  { \"fase\": \"Civil\", \"requisito_rfq\": \"Foundation Layout\" }\n]\n```\n\n**{{ $('Generate IDs1').first().json.language === 'en' ? 'RESPONSE (PURE JSON):' : 'RESPUESTA (JSON PURO):' }}**",
        "messages": {
          "messageValues": [
            {
              "message": "={{ $('Generate IDs1').first().json.language === 'en' ? 'You are a JSON API.\\n- DO NOT greet.\\n- DO NOT explain.\\n- DO NOT use markdown outside JSON.\\n- Your output MUST start with [ and end with ].\\n- Write all text in ENGLISH.' : 'Eres una API que devuelve JSON.\\n- NO saludes.\\n- NO expliques.\\n- NO uses markdown fuera del JSON.\\n- Tu salida DEBE empezar con [ y terminar con ].\\n- Escribe todo el texto en ESPANOL.' }}"
            }
          ]
        },
        "batching": {}
      },
      "type": "@n8n/n8n-nodes-langchain.chainLlm",
      "typeVersion": 1.7,
      "position": [
        -1584,
        6368
      ],
      "id": "3885f7cc-4f8c-4d86-aa3d-63a81b04dbce",
      "name": "LLM Extractor - Deliverables"
    },
    {
      "parameters": {
        "jsCode": "// =============================================\n// NODO: Parsear Deliverables (ROBUST FALLBACK)\n// =============================================\n\nconst inputJson = $input.first().json;\n\n// 1. RECOGIDA DE DATOS RAW\nlet rawOutput = \"\";\nif (inputJson.output && typeof inputJson.output === 'string') rawOutput = inputJson.output;\nelse if (inputJson.text && typeof inputJson.text === 'string') rawOutput = inputJson.text;\nelse if (inputJson.content && typeof inputJson.content === 'string') rawOutput = inputJson.content;\nelse if (typeof inputJson === 'string') rawOutput = inputJson;\n\n// 2. INTENTO A: EXTRAER JSON\nlet items = [];\ntry {\n    const clean = rawOutput.replace(/```json/gi, '').replace(/```/g, '').trim();\n    const start = clean.indexOf('[');\n    const end = clean.lastIndexOf(']');\n    if (start !== -1 && end !== -1) {\n        items = JSON.parse(clean.substring(start, end + 1));\n    }\n} catch(e) {}\n\n// 3. INTENTO B: FALLBACK DE LISTA\nif (items.length === 0 && rawOutput) {\n    const lines = rawOutput.split('\\n');\n    let currentPhase = \"General\";\n    lines.forEach(line => {\n        const trimmed = line.trim();\n        if (!trimmed) return;\n        const numberMatch = trimmed.match(/^\\d+\\.\\s*(.*)/);\n        const bulletMatch = trimmed.match(/^[-â€¢*]\\s*(.*)/);\n        if (numberMatch) {\n            items.push({ fase: currentPhase, requisito_rfq: numberMatch[1] });\n        } else if (bulletMatch) {\n             items.push({ fase: currentPhase, requisito_rfq: bulletMatch[1] });\n        }\n    });\n}\n\n// 4. HELPER: GENERAR ID ESTABLE\nfunction generateId(str) {\n    let hash = 0;\n    for (let i = 0; i < str.length; i++) {\n        hash = ((hash << 5) - hash) + str.charCodeAt(i);\n        hash = hash & hash;\n    }\n    return 'item_' + Math.abs(hash).toString(16).padStart(12, '0');\n}\n\n// 5. NORMALIZAR Y RETORNAR\nlet loopCtx = {};\ntry {\n   const outerLoop = $('Loop por Tipo1').first().json;\n   loopCtx = {\n       rfq_project_id: outerLoop.rfq_project_id,\n       rfq_document_id: outerLoop.rfq_document_id,\n       project_name: outerLoop.nombre_proyecto,\n       tipo_evaluacion: outerLoop.tipo_evaluacion\n   };\n} catch(e){}\n\nreturn items.map(item => {\n    const phase = item.fase || \"General\";\n    const req = item.requisito_rfq || \"Sin Nombre\";\n    return {\n        json: {\n            rfq_project_id: loopCtx.rfq_project_id || \"unknown\",\n            rfq_document_id: loopCtx.rfq_document_id || \"unknown\",\n            project_name: loopCtx.project_name || \"Unknown\",\n            evaluation: loopCtx.tipo_evaluacion || \"Deliverables\",\n            fase: phase,\n            requisito_rfq: req\n        }\n    };\n});"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        -1232,
        6368
      ],
      "id": "be0ccbda-0d9e-4675-b522-3c8e5ab833df",
      "name": "Parsear deliverables"
    },
    {
      "parameters": {
        "model": "qwen3:8b",
        "options": {
          "temperature": 0.1,
          "numCtx": 8192,
          "numPredict": 2048
        }
      },
      "type": "@n8n/n8n-nodes-langchain.lmOllama",
      "typeVersion": 1,
      "position": [
        -1648,
        6144
      ],
      "id": "861bc914-72ba-45f1-a7e1-d19bc607830d",
      "name": "Ollama Extractor1",
      "credentials": {
        "ollamaApi": {
          "id": "oS2Qqti9oVfsm8XZ",
          "name": "Ollama account"
        }
      }
    },
    {
      "parameters": {
        "schemaType": "manual",
        "inputSchema": "{\n  \"type\": \"array\",\n  \"items\": {\n    \"type\": \"object\",\n    \"properties\": {\n      \"fase\": {\n        \"type\": \"string\",\n        \"description\": \"Nombre de la disciplina o Ã¡rea (ej: Process Engineering, Mechanical Engineering, Civil and Structural, Electrical Engineering, etc.)\"\n      },\n      \"requisito_rfq\": {\n        \"type\": \"string\",\n        \"description\": \"Nombre del documento o entregable especÃ­fico\"\n      }\n    },\n    \"required\": [\"fase\", \"requisito_rfq\"]\n  }\n}"
      },
      "type": "@n8n/n8n-nodes-langchain.outputParserStructured",
      "typeVersion": 1.3,
      "position": [
        -1344,
        6576
      ],
      "id": "29eb135c-7781-4f80-ab92-ccadd516330e",
      "name": "Structured Output Parser1"
    },
    {
      "parameters": {
        "schemaType": "manual",
        "inputSchema": "{\n  \"type\": \"array\",\n  \"items\": {\n    \"type\": \"object\",\n    \"properties\": {\n      \"fase\": {\n        \"type\": \"string\",\n        \"description\": \"Fase del proyecto o disciplina (ej: PRE-FEED, FEED, EPC, Process Engineering, etc.)\"\n      },\n      \"requisito_rfq\": {\n        \"type\": \"string\",\n        \"description\": \"Requisito tÃ©cnico o econÃ³mico especÃ­fico\"\n      }\n    },\n    \"required\": [\"fase\", \"requisito_rfq\"]\n  }\n}"
      },
      "type": "@n8n/n8n-nodes-langchain.outputParserStructured",
      "typeVersion": 1.3,
      "position": [
        -1408,
        6144
      ],
      "id": "f4f2c5d0-8e71-4cd8-9aab-ca19533cb9e7",
      "name": "Structured Output Parser2"
    },
    {
      "parameters": {
        "jsCode": "// =============================================\n// NODO: Dividir en Trozos (Chunking)\n// =============================================\n\nconst input = $input.first().json;\nconst fullText = input.texto_rfq || \"\";\n\n// OPTIMIZADO: Chunks mÃ¡s pequeÃ±os para procesamiento mÃ¡s rÃ¡pido\n// ~6000 caracteres (aprox 1.5k-2k tokens) = respuestas en 10-15 seg\nconst chunkSize = 6000;\nconst overlap = 400;\nconst chunks = [];\n\nif (fullText.length <= chunkSize) {\n    chunks.push({\n        ...input,\n        texto_chunk: fullText,\n        chunk_index: 1,\n        total_chunks: 1\n    });\n} else {\n    let start = 0;\n    while (start < fullText.length) {\n        let end = start + chunkSize;\n        let chunk = fullText.substring(start, end);\n        \n        chunks.push({\n            ...input,\n            texto_chunk: chunk,\n            chunk_index: chunks.length + 1\n        });\n\n        start += (chunkSize - overlap);\n        if (start >= fullText.length) break;\n    }\n    chunks.forEach(c => c.total_chunks = chunks.length);\n}\n\nreturn chunks;"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        -2512,
        6128
      ],
      "id": "b5bd6b51-fd47-41c6-ba0c-b1babcb14320",
      "name": "Dividir en Trozos1"
    },
    {
      "parameters": {
        "options": {
          "reset": "={{ $json.reiniciar_bucle ? true : false }}"
        }
      },
      "type": "n8n-nodes-base.splitInBatches",
      "typeVersion": 3,
      "position": [
        -2160,
        6128
      ],
      "id": "313207de-ac57-4db2-8cff-1b56663ca766",
      "name": "Loop por Trozo1"
    },
    {
      "parameters": {
        "jsCode": "const items = $input.all();\n\nreturn items.map(item => ({\n    json: {\n        ...item.json, // Mantiene todos los datos originales (incluido tipo_evaluacion)\n        \n        // AquÃ­ estÃ¡ la correcciÃ³n: Usamos dos puntos, no el igual.\n        reiniciar_bucle: true \n    }\n}));\n"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        -2336,
        6128
      ],
      "id": "2d11250a-3d10-4357-8cbc-dce19a5514cb",
      "name": "Reset Items1"
    },
    {
      "parameters": {
        "model": "qwen3-embedding:8b"
      },
      "type": "@n8n/n8n-nodes-langchain.embeddingsOllama",
      "typeVersion": 1,
      "position": [
        -3440,
        6240
      ],
      "id": "2705de24-9383-4fbd-bad4-8d61f839133e",
      "name": "Embeddings Ollama1",
      "credentials": {
        "ollamaApi": {
          "id": "oS2Qqti9oVfsm8XZ",
          "name": "Ollama account"
        }
      }
    },
    {
      "parameters": {
        "mode": "insert",
        "tableName": {
          "__rl": true,
          "value": "rfq",
          "mode": "list",
          "cachedResultName": "rfq"
        },
        "options": {
          "queryName": "match_rfq"
        }
      },
      "id": "2f824b78-b144-4927-993d-4ddf6116e9cf",
      "name": "Insert into Supabase Vectorstore1",
      "type": "@n8n/n8n-nodes-langchain.vectorStoreSupabase",
      "typeVersion": 1,
      "position": [
        -3360,
        6016
      ],
      "credentials": {
        "supabaseApi": {
          "id": "1lXSDxSKEJxdyGOO",
          "name": "Supabase Nube Diego"
        }
      }
    },
    {
      "parameters": {
        "chunkSize": 800,
        "chunkOverlap": 150,
        "options": {}
      },
      "type": "@n8n/n8n-nodes-langchain.textSplitterRecursiveCharacterTextSplitter",
      "typeVersion": 1,
      "position": [
        -3184,
        6448
      ],
      "id": "27d1c133-3c5d-408d-98ca-a82c88f17f53",
      "name": "Recursive Character Text Splitter1"
    },
    {
      "parameters": {
        "jsonMode": "expressionData",
        "jsonData": "={{ $('Preparar Texto1').item.json.text_for_classification }}",
        "options": {
          "metadata": {
            "metadataValues": [
              {
                "name": "file_id",
                "value": "={{ $('Generate IDs1').first().json.rfq_document_id }}"
              },
              {
                "name": "file_title",
                "value": "={{ $('Generate IDs1').first().json.file_title }}"
              },
              {
                "name": "tipo_evaluacion",
                "value": "={{ $('Clasificador de Tipos1').item.json.output.tipos_detectados }}"
              },
              {
                "name": "tipo-doc",
                "value": "RFQ"
              }
            ]
          }
        }
      },
      "id": "755f1731-1ce6-4f6a-a4eb-786eeba5e29b",
      "name": "Default Data Loader1",
      "type": "@n8n/n8n-nodes-langchain.documentDefaultDataLoader",
      "typeVersion": 1,
      "position": [
        -3264,
        6240
      ]
    },
    {
      "parameters": {
        "useCustomSchema": true,
        "schema": "public",
        "tableId": "rfq_items_master",
        "fieldsUi": {
          "fieldValues": [
            {
              "fieldId": "project_id",
              "fieldValue": "={{ $('Generate IDs1').first().json.project_id }}"
            },
            {
              "fieldId": "evaluation_type",
              "fieldValue": "={{ $json.evaluation }}"
            },
            {
              "fieldId": "phase",
              "fieldValue": "={{ $json.fase }}"
            },
            {
              "fieldId": "requirement_text",
              "fieldValue": "={{ $json.requisito_rfq }}"
            }
          ]
        }
      },
      "type": "n8n-nodes-base.supabase",
      "typeVersion": 1,
      "position": [
        -912,
        6144
      ],
      "id": "6e019de7-1556-4f64-878f-c590d9e2c7e2",
      "name": "Create a row",
      "credentials": {
        "supabaseApi": {
          "id": "pI4CpdYLTiEEBmnz",
          "name": "Supabase account"
        }
      }
    },
    {
      "parameters": {
        "operation": "delete",
        "tableId": "rfq",
        "filterType": "string",
        "filterString": "=metadata->>file_id=like.*{{ $json.file_id }}*"
      },
      "id": "027001ed-6067-45bf-b448-cbb8c186b6be",
      "name": "Delete Old Doc Rows1",
      "type": "n8n-nodes-base.supabase",
      "typeVersion": 1,
      "position": [
        -4336,
        5776
      ],
      "alwaysOutputData": true,
      "credentials": {
        "supabaseApi": {
          "id": "1lXSDxSKEJxdyGOO",
          "name": "Supabase Nube Diego"
        }
      }
    },
    {
      "parameters": {
        "operation": "upsert",
        "schema": {
          "__rl": true,
          "mode": "list",
          "value": "public"
        },
        "table": {
          "__rl": true,
          "value": "document_metadata",
          "mode": "list",
          "cachedResultName": "document_metadata"
        },
        "columns": {
          "mappingMode": "defineBelow",
          "value": {
            "id": "={{ $('Generate IDs1').first().json.rfq_document_id }}",
            "title": "={{ $('Generate IDs1').first().json.file_title }}",
            "document_type": "=RFQ",
            "evaluation_types": "={{ $json.output.tipos_detectados }}",
            "created_at": "2026-02-11T15:13:51",
            "project_id": "={{ $('Webhook RFQ').first().json.body.project_id }}"
          },
          "matchingColumns": [
            "id"
          ],
          "schema": [
            {
              "id": "id",
              "displayName": "id",
              "required": true,
              "defaultMatch": true,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            },
            {
              "id": "title",
              "displayName": "title",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": false
            },
            {
              "id": "project_id",
              "displayName": "project_id",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": false,
              "removed": false
            },
            {
              "id": "document_type",
              "displayName": "document_type",
              "required": true,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": false,
              "removed": false
            },
            {
              "id": "provider",
              "displayName": "provider",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": false,
              "removed": false
            },
            {
              "id": "evaluation_types",
              "displayName": "evaluation_types",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "array",
              "canBeUsedToMatch": false,
              "removed": false
            },
            {
              "id": "created_at",
              "displayName": "created_at",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "dateTime",
              "canBeUsedToMatch": false,
              "removed": false
            }
          ],
          "attemptToConvertTypes": false,
          "convertFieldsToString": false
        },
        "options": {}
      },
      "type": "n8n-nodes-base.postgres",
      "typeVersion": 2.5,
      "position": [
        -3584,
        6016
      ],
      "id": "cc55314f-e471-49ea-9890-ccd5eb4a09b3",
      "name": "Insert Document Metadata2",
      "executeOnce": true,
      "credentials": {
        "postgres": {
          "id": "V0REAPph5JBLqze3",
          "name": "Postgres account"
        }
      }
    },
    {
      "parameters": {
        "promptType": "define",
        "text": "=### EXTRACCION DE REQUISITOS RFQ\n\nIdioma de salida: {{ $('Generate IDs1').first().json.language === 'en' ? 'ENGLISH' : 'ESPANOL' }}\nProyecto: {{ $json.nombre_proyecto }}\nTipo: {{ $json.tipo_evaluacion }}\nArchivo: {{ $json.file_title }}\n\n### TEXTO:\n{{ $json.texto_chunk }}\n\n---\n### INSTRUCCIONES:\n\n{{ $('Generate IDs1').first().json.language === 'en' ? 'Extract all EVALUABLE REQUIREMENTS from the text. An evaluable requirement is something concrete that a provider must comply with, deliver or demonstrate.' : 'Extrae los REQUISITOS EVALUABLES del texto. Un requisito evaluable es algo concreto que un proveedor debe cumplir, entregar o demostrar.' }}\n\n{{ $('Generate IDs1').first().json.language === 'en' ? '### WHAT IS A REQUIREMENT (extract):\\n- Concrete obligations: shall, must, will provide\\n- Specific deliverables: documents, drawings, reports\\n- Technical specifications with concrete values (standards, codes)\\n- Economic items or quotation lines (if Economical type)\\n- Personnel requirements, certifications or minimum experience\\n- Milestones with specific dates' : '### QUE ES UN REQUISITO (extraer):\\n- Obligaciones concretas: shall, must, will provide, se requiere\\n- Entregables especificos: documentos, planos, informes a entregar\\n- Especificaciones tecnicas con valores concretos (normas, estandares, codigos)\\n- Partidas economicas o lineas de cotizacion (si tipo Economical)\\n- Requisitos de personal, certificaciones o experiencia minima\\n- Plazos o hitos con fechas concretas' }}\n\n{{ $('Generate IDs1').first().json.language === 'en' ? '### WHAT IS NOT A REQUIREMENT (DO NOT extract):\\n- Introductory text, general descriptions or project context\\n- Definitions, abbreviations, glossaries\\n- Reference information that does not imply provider obligation\\n- Repetitions of the same requirement with different wording\\n- Section titles, headers, footers\\n- Generic phrases without specifying which standard' : '### QUE NO ES UN REQUISITO (NO extraer):\\n- Texto introductorio, descripciones generales o contexto del proyecto\\n- Definiciones, abreviaturas, glosarios\\n- Informacion de referencia que no implica obligacion del proveedor\\n- Repeticiones del mismo requisito con diferente redaccion\\n- Titulos de seccion, encabezados, pies de pagina\\n- Frases genericas sin especificar cual norma' }}\n\n{{ $('Generate IDs1').first().json.language === 'en' ? '### GRANULARITY LEVEL:\\n- Group related requirements from the same section into a single item\\n- DO NOT create a requirement for each sentence or bullet point\\n- A 10-page document should produce 15-40 requirements, not hundreds\\n- If a table has 20 rows of the same type, group into 1-3 requirements per category' : '### NIVEL DE GRANULARIDAD:\\n- Agrupar requisitos relacionados de una misma seccion en un solo item\\n- NO crear un requisito por cada frase o bullet point individual\\n- Un documento de 10 paginas deberia producir entre 15-40 requisitos, no cientos\\n- Si una tabla tiene 20 filas del mismo tipo, agrupar en 1-3 requisitos por categoria' }}\n\n{{ $('Generate IDs1').first().json.language === 'en' ? '### RULES:\\n1. ONLY REAL REQUIREMENTS: That the provider can answer with compliant / non-compliant\\n2. GROUP RELATED: Do not over-fragment\\n3. FAITHFUL TO TEXT: Use the original document language\\n4. DO NOT INVENT: If no clear requirements in text, return empty array []' : '### REGLAS:\\n1. SOLO REQUISITOS REALES: Que el proveedor pueda responder con cumplimos / no cumplimos\\n2. AGRUPAR LO RELACIONADO: No fragmentar en exceso\\n3. FIEL AL TEXTO: Usar el lenguaje original del documento\\n4. NO INVENTAR: Si no hay requisitos claros en el texto, devolver array vacio []' }}\n\n### FORMATO:\n```json\n[\n  { \"fase\": \"{{ $('Generate IDs1').first().json.language === 'en' ? 'Document section' : 'Seccion del documento' }}\", \"requisito_rfq\": \"{{ $('Generate IDs1').first().json.language === 'en' ? 'Requirement description' : 'Descripcion del requisito' }}\" }\n]\n```\n\n**{{ $('Generate IDs1').first().json.language === 'en' ? 'RESPONSE:' : 'RESPUESTA:' }}**",
        "messages": {
          "messageValues": [
            {
              "message": "={{ $('Generate IDs1').first().json.language === 'en' ? 'You are a Requirements Extractor for procurement processes (RFP/RFQ/RFI) in any sector.\\nYour job is to identify EVALUABLE requirements that a provider would need to comply with.\\nBe SELECTIVE: extract only concrete and verifiable obligations, not filler text.\\nGroup related requirements from the same section. Do not over-fragment.\\nA typical 10-page document should produce 15-40 requirements.\\nDO NOT invent requirements not in the text.\\nWrite requirement descriptions in ENGLISH.\\nUse strict JSON.' : 'Eres un Extractor de Requisitos para licitaciones (RFP/RFQ/RFI) de cualquier sector.\\nTu trabajo es identificar los requisitos EVALUABLES que un proveedor tendria que cumplir.\\nSe SELECTIVO: extrae solo obligaciones concretas y verificables, no texto de relleno.\\nAgrupa requisitos relacionados de la misma seccion. No fragmentes en exceso.\\nUn documento tipico de 10 paginas deberia producir entre 15-40 requisitos.\\nNO inventes requisitos que no esten en el texto.\\nEscribe las descripciones de requisitos en ESPANOL.\\nUsa JSON estricto.' }}"
            }
          ]
        },
        "batching": {}
      },
      "type": "@n8n/n8n-nodes-langchain.chainLlm",
      "typeVersion": 1.7,
      "position": [
        -1600,
        5952
      ],
      "id": "4a0b4b79-cb27-460c-a769-e1414aba12a9",
      "name": "LLM Extractor Tech-Econ"
    },
    {
      "parameters": {
        "model": "mistral-large-latest",
        "options": {}
      },
      "type": "@n8n/n8n-nodes-langchain.lmChatMistralCloud",
      "typeVersion": 1,
      "position": [
        -1536,
        6128
      ],
      "id": "ac0f3aef-458c-4526-a64b-de86236e531e",
      "name": "Mistral Cloud Chat Model7",
      "credentials": {
        "mistralCloudApi": {
          "id": "tDjuOnF6lpADMmd5",
          "name": "Mistral Cloud account"
        }
      }
    },
    {
      "parameters": {
        "model": "mistral-large-latest",
        "options": {}
      },
      "type": "@n8n/n8n-nodes-langchain.lmChatMistralCloud",
      "typeVersion": 1,
      "position": [
        -1520,
        6576
      ],
      "id": "9fa61558-ac80-48f4-ae00-89598a50523b",
      "name": "Mistral Cloud Chat Model8",
      "credentials": {
        "mistralCloudApi": {
          "id": "tDjuOnF6lpADMmd5",
          "name": "Mistral Cloud account"
        }
      }
    },
    {
      "parameters": {
        "options": {}
      },
      "type": "@n8n/n8n-nodes-langchain.lmChatMistralCloud",
      "typeVersion": 1,
      "position": [
        -3936,
        6368
      ],
      "id": "ee782931-ff9a-44fa-afd5-db42d8b7fe1c",
      "name": "Mistral Cloud Chat Model9",
      "credentials": {
        "mistralCloudApi": {
          "id": "tDjuOnF6lpADMmd5",
          "name": "Mistral Cloud account"
        }
      }
    },
    {
      "parameters": {
        "content": "## /rfp-generate - AI RFP Document Generator\n\nGenerates a complete RFP/RFQ/RFI document using AI based on project requirements.\n\n**Method**: POST\n**Body**: { project_id, project_name, project_type, description, requirements, providers?, criteria?, deadlines?, language?, sections? }\n\n**Flow**: Webhook â†’ Set Fields â†’ LLM Chain â†’ Parse & Structure Output â†’ Respond\n\n**Returns**: { success, document, title, sections: [{title, content}], metadata: {word_count, generated_at, model} }",
        "height": 400,
        "width": 2200,
        "color": 6
      },
      "type": "n8n-nodes-base.stickyNote",
      "typeVersion": 1,
      "position": [
        -1536,
        7616
      ],
      "id": "d891d3eb-2679-4bb6-bdc0-66903a92e2d0",
      "name": "Sticky Note RFP Generate"
    },
    {
      "parameters": {
        "httpMethod": "POST",
        "path": "rfp-generate",
        "responseMode": "responseNode",
        "options": {}
      },
      "type": "n8n-nodes-base.webhook",
      "typeVersion": 2.1,
      "position": [
        -1456,
        7776
      ],
      "id": "3fa0ef18-7fe2-49e6-90b2-8d479e2c753f",
      "name": "Webhook RFP Generate",
      "webhookId": "rfp-generate-webhook-001"
    },
    {
      "parameters": {
        "assignments": {
          "assignments": [
            {
              "id": "rfp-project-id",
              "name": "project_id",
              "value": "={{ $json.body.project_id }}",
              "type": "string"
            },
            {
              "id": "rfp-project-name",
              "name": "project_name",
              "value": "={{ $json.body.project_name }}",
              "type": "string"
            },
            {
              "id": "rfp-project-type",
              "name": "project_type",
              "value": "={{ $json.body.project_type || 'RFP' }}",
              "type": "string"
            },
            {
              "id": "rfp-description",
              "name": "description",
              "value": "={{ $json.body.description }}",
              "type": "string"
            },
            {
              "id": "rfp-requirements",
              "name": "requirements",
              "value": "={{ $json.body.requirements }}",
              "type": "string"
            },
            {
              "id": "rfp-language",
              "name": "language",
              "value": "={{ $json.body.language || 'es' }}",
              "type": "string"
            },
            {
              "id": "rfp-currency",
              "name": "currency",
              "value": "={{ $json.body.currency || 'EUR' }}",
              "type": "string"
            },
            {
              "id": "rfp-sections",
              "name": "sections",
              "value": "={{ $json.body.sections }}",
              "type": "array"
            },
            {
              "id": "rfp-criteria",
              "name": "criteria",
              "value": "={{ $json.body.criteria }}",
              "type": "array"
            },
            {
              "id": "rfp-deadlines",
              "name": "deadlines",
              "value": "={{ $json.body.deadlines }}",
              "type": "object"
            },
            {
              "id": "rfp-providers",
              "name": "providers",
              "value": "={{ $json.body.providers }}",
              "type": "array"
            }
          ]
        },
        "options": {}
      },
      "type": "n8n-nodes-base.set",
      "typeVersion": 3.4,
      "position": [
        -1248,
        7776
      ],
      "id": "90d9b111-3270-43e4-8784-e9606da4b2b4",
      "name": "Set RFP Params"
    },
    {
      "parameters": {
        "promptType": "define",
        "text": "=### INPUT\n\n## PROJECT: {{ $json.project_name }}\n## TYPE: {{ $json.project_type }}\n## LANGUAGE: {{ $json.language }}\n## CURRENCY: {{ $json.currency || 'EUR' }}\n\n## DESCRIPTION:\n{{ $json.description }}\n\n## REQUIREMENTS:\n{{ $json.requirements }}\n\n## SECTIONS TO INCLUDE:\n{{ JSON.stringify($json.sections) }}\n\n## EVALUATION CRITERIA:\n{{ JSON.stringify($json.criteria) }}\n\n## DEADLINES:\n{{ JSON.stringify($json.deadlines) }}\n\n## INVITED PROVIDERS:\n{{ JSON.stringify($json.providers) }}\n\n### INSTRUCTIONS\nGenerate a complete, professional {{ $json.project_type }} document with ALL the requested sections.\nThe document must be in {{ $json.language === 'en' ? 'English' : 'Spanish' }}.\nAll monetary references and pricing sections must use {{ $json.currency || 'EUR' }} as the currency.\nUse Markdown formatting for the document body.\nEach section should be comprehensive and detailed.\nInclude the evaluation criteria and deadlines in the appropriate sections.\n\nReturn ONLY the JSON object. Do NOT include any text before or after the JSON.\n\n### OUTPUT SCHEMA\n{\n  \"title\": \"Document title\",\n  \"document\": \"Full document content in Markdown\",\n  \"sections\": [\n    { \"title\": \"Section Name\", \"content\": \"Section content in Markdown\" }\n  ]\n}",
        "messages": {
          "messageValues": [
            {
              "message": "=You are an expert procurement specialist and technical writer with extensive experience in industrial projects (energy, P2X, green hydrogen, EPC).\n\n### ROLE\nGenerate formal {{ $json.project_type }} (Request for Proposal/Quotation/Information) documents that are professional, comprehensive, and aligned with industry best practices.\n\n### GUIDELINES\n1. **Structure**: Follow standard {{ $json.project_type }} format with clear sections, numbering, and professional language.\n2. **Content**: Each section must be substantive (not just headers). Include specific requirements, evaluation methodology, and clear instructions for bidders.\n3. **Evaluation Criteria**: If criteria with weights are provided, include them in a dedicated section with a clear scoring methodology.\n4. **Deadlines**: If deadlines are provided, include a timeline section with key dates.\n5. **Providers**: If invited providers are listed, reference the closed bidding process.\n6. **Language**: Write entirely in the requested language. Use formal, professional tone.\n7. **Formatting**: Use Markdown (headers ##, bold **, bullet points -, tables |) for readability.\n\n### CRITICAL: OUTPUT RESTRICTIONS\n- Return **ONLY** a valid JSON object.\n- **DO NOT** include any conversational text, explanations, or reasoning.\n- **DO NOT** use Markdown code blocks (e.g., ```json).\n- The output must start with `{` and end with `}`.\n- The 'document' field must contain the FULL document text, not just a summary."
            }
          ]
        },
        "batching": {}
      },
      "type": "@n8n/n8n-nodes-langchain.chainLlm",
      "typeVersion": 1.8,
      "position": [
        -1056,
        7776
      ],
      "id": "a16c1c71-7f55-40f4-a972-f016ba7e9775",
      "name": "RFP Generation Chain"
    },
    {
      "parameters": {
        "model": "mistral-large-latest",
        "options": {
          "temperature": 0.2
        }
      },
      "type": "@n8n/n8n-nodes-langchain.lmChatMistralCloud",
      "typeVersion": 1,
      "position": [
        -1056,
        7984
      ],
      "id": "06128c31-2afe-4044-9a2f-c6299cbb4d2c",
      "name": "Mistral RFP Model",
      "credentials": {
        "mistralCloudApi": {
          "id": "tDjuOnF6lpADMmd5",
          "name": "Mistral Cloud account"
        }
      }
    },
    {
      "parameters": {
        "jsCode": "// Parse LLM output and structure the RFP response\nconst llmOutput = $input.first().json;\nconst params = $('Set RFP Params').first().json;\nlet result;\n\nconst logoPlaceholderRegex = /(?:^|\\n)\\s*!?\\[\\s*(?:logo(?:\\s+de\\s+la)?(?:\\s+empresa)?|company\\s+logo)\\s*\\](?:\\([^\\)]*\\))?\\s*(?=\\n|$)/gi;\n\nconst cleanDoc = (text) => String(text || '')\n  .replace(logoPlaceholderRegex, '\\n')\n  .replace(/\\n{3,}/g, '\\n\\n')\n  .trim();\n\nconst tryParseJson = (source) => {\n  const attempts = [];\n\n  // 1) Raw text (without markdown fences)\n  attempts.push(source.replace(/```json\\n?/gi, '').replace(/```\\n?/g, '').trim());\n\n  // 2) Extract probable JSON object/array block from noisy text\n  const firstObj = source.indexOf('{');\n  const firstArr = source.indexOf('[');\n  let start = -1;\n  if (firstObj >= 0 && firstArr >= 0) start = Math.min(firstObj, firstArr);\n  else start = Math.max(firstObj, firstArr);\n  if (start >= 0) {\n    const lastObj = source.lastIndexOf('}');\n    const lastArr = source.lastIndexOf(']');\n    const end = Math.max(lastObj, lastArr);\n    if (end > start) attempts.push(source.slice(start, end + 1).trim());\n  }\n\n  const parseAttempt = (candidate) => {\n    // A) direct parse\n    try { return JSON.parse(candidate); } catch (_) {}\n\n    // B) escape control chars inside strings\n    let sanitized = '';\n    let inStr = false;\n    let esc = false;\n    for (let i = 0; i < candidate.length; i++) {\n      const ch = candidate[i];\n      const code = candidate.charCodeAt(i);\n      if (esc) { sanitized += ch; esc = false; continue; }\n      if (ch === '\\\\' && inStr) { sanitized += ch; esc = true; continue; }\n      if (ch === '\"') { inStr = !inStr; sanitized += ch; continue; }\n      if (inStr && code <= 0x1f) {\n        if (ch === '\\n') sanitized += '\\\\n';\n        else if (ch === '\\r') sanitized += '\\\\r';\n        else if (ch === '\\t') sanitized += '\\\\t';\n        continue;\n      }\n      sanitized += ch;\n    }\n    try { return JSON.parse(sanitized); } catch (_) {}\n\n    // C) remove trailing commas before } or ]\n    const noTrailingCommas = sanitized.replace(/,\\s*([}\\]])/g, '$1');\n    try { return JSON.parse(noTrailingCommas); } catch (_) {}\n\n    return null;\n  };\n\n  for (const candidate of attempts) {\n    const parsed = parseAttempt(candidate);\n    if (parsed) return parsed;\n  }\n\n  return null;\n};\n\ntry {\n  const rawText = llmOutput.text || llmOutput.output || JSON.stringify(llmOutput);\n  let parsed = null;\n\n  if (typeof rawText === 'string') {\n    parsed = tryParseJson(rawText);\n  } else if (rawText && typeof rawText === 'object') {\n    parsed = rawText;\n  }\n\n  // Fallback: if the model returned plain markdown/text, keep it as document\n  if (!parsed) {\n    const fallbackDocument = cleanDoc(String(rawText || ''));\n    const wordCount = fallbackDocument.split(/\\s+/).filter(w => w.length > 0).length;\n\n    result = {\n      success: true,\n      title: `${params.project_type} - ${params.project_name}`,\n      document: fallbackDocument,\n      sections: [],\n      metadata: {\n        word_count: wordCount,\n        generated_at: new Date().toISOString(),\n        model: 'mistral-large-latest'\n      },\n      message: `RFP generated with fallback text (${wordCount} words)`\n    };\n\n    console.log('âš ï¸ RFP output was not valid JSON; used fallback document text');\n    return [{ json: result }];\n  }\n\n  const sections = Array.isArray(parsed.sections)\n    ? parsed.sections.map(s => ({\n        title: s?.title || 'Untitled Section',\n        content: s?.content || ''\n      }))\n    : [];\n\n  const document = cleanDoc(\n    parsed.document || sections.map(s => `## ${s.title}\\n\\n${s.content}`).join('\\n\\n')\n  );\n\n  const wordCount = document.split(/\\s+/).filter(w => w.length > 0).length;\n\n  result = {\n    success: true,\n    title: parsed.title || `${params.project_type} - ${params.project_name}`,\n    document,\n    sections,\n    metadata: {\n      word_count: wordCount,\n      generated_at: new Date().toISOString(),\n      model: 'mistral-large-latest'\n    },\n    message: `RFP generated successfully (${wordCount} words, ${sections.length} sections)`\n  };\n\n  console.log('âœ… RFP Generated:');\n  console.log(`   â”œâ”€ Title: ${result.title}`);\n  console.log(`   â”œâ”€ Sections: ${sections.length}`);\n  console.log(`   â””â”€ Words: ${wordCount}`);\n} catch (err) {\n  console.error('âŒ Error parsing RFP output:', err.message);\n  result = {\n    success: false,\n    title: '',\n    document: '',\n    sections: [],\n    metadata: { word_count: 0, generated_at: new Date().toISOString(), model: 'mistral-large-latest' },\n    message: 'Error generating RFP: ' + err.message\n  };\n}\n\nreturn [{ json: result }];\n"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        -848,
        7776
      ],
      "id": "c799b332-7d61-4a14-be62-d356ab630381",
      "name": "Parse RFP Output"
    },
    {
      "parameters": {
        "respondWith": "allIncomingItems",
        "options": {}
      },
      "type": "n8n-nodes-base.respondToWebhook",
      "typeVersion": 1.5,
      "position": [
        -656,
        7776
      ],
      "id": "578cb8ed-a63c-45ea-bc36-0c6799b249ac",
      "name": "Respond RFP Generate"
    },
    {
      "parameters": {
        "useCustomSchema": true,
        "schema": "public",
        "operation": "getAll",
        "tableId": "rfq_items_master",
        "returnAll": true,
        "matchType": "allFilters",
        "filters": {
          "conditions": [
            {
              "keyName": "project_id",
              "condition": "eq",
              "keyValue": "={{ $('Set Input Params1').first().json.project_id }}"
            }
          ]
        }
      },
      "type": "n8n-nodes-base.supabase",
      "typeVersion": 1,
      "position": [
        -9520,
        5696
      ],
      "id": "c96983b9-7bae-4f4c-9886-93924398cf37",
      "name": "Fetch Requirements",
      "credentials": {
        "supabaseApi": {
          "id": "pI4CpdYLTiEEBmnz",
          "name": "Supabase account"
        }
      }
    },
    {
      "parameters": {
        "useCustomSchema": true,
        "schema": "public",
        "operation": "getAll",
        "tableId": "provider_responses",
        "returnAll": true,
        "filters": {
          "conditions": [
            {
              "keyName": "project_id",
              "condition": "eq",
              "keyValue": "={{ $('Set Input Params1').first().json.project_id }}"
            }
          ]
        }
      },
      "type": "n8n-nodes-base.supabase",
      "typeVersion": 1,
      "position": [
        -9520,
        5936
      ],
      "id": "b0f73327-b68f-465d-958f-5d97c74dfea2",
      "name": "Fetch Provider Responses",
      "credentials": {
        "supabaseApi": {
          "id": "pI4CpdYLTiEEBmnz",
          "name": "Supabase account"
        }
      }
    },
    {
      "parameters": {
        "useCustomSchema": true,
        "schema": "public",
        "operation": "getAll",
        "tableId": "scoring_configuration_summary",
        "returnAll": true,
        "filters": {
          "conditions": [
            {
              "keyName": "project_id",
              "condition": "eq",
              "keyValue": "={{ $('Set Input Params1').first().json.project_id }}"
            }
          ]
        }
      },
      "type": "n8n-nodes-base.supabase",
      "typeVersion": 1,
      "position": [
        -9520,
        6160
      ],
      "id": "71905e95-3344-43be-8930-9ac6f699e838",
      "name": "Fetch Scoring Configuration",
      "alwaysOutputData": true,
      "credentials": {
        "supabaseApi": {
          "id": "pI4CpdYLTiEEBmnz",
          "name": "Supabase account"
        }
      }
    },
    {
      "parameters": {
        "useCustomSchema": true,
        "schema": "public",
        "operation": "getAll",
        "tableId": "economic_offers",
        "returnAll": true,
        "filters": {
          "conditions": [
            {
              "keyName": "project_id",
              "condition": "eq",
              "keyValue": "={{ $('Set Input Params1').first().json.project_id }}"
            }
          ]
        }
      },
      "type": "n8n-nodes-base.supabase",
      "typeVersion": 1,
      "position": [
        -9520,
        6384
      ],
      "id": "4434e2ba-1c74-416c-b30b-4675a84fb3b8",
      "name": "Fetch Economic Offers",
      "alwaysOutputData": true,
      "credentials": {
        "supabaseApi": {
          "id": "pI4CpdYLTiEEBmnz",
          "name": "Supabase account"
        }
      }
    },
    {
      "parameters": {
        "numberInputs": 4
      },
      "type": "n8n-nodes-base.merge",
      "typeVersion": 3.2,
      "position": [
        -9296,
        5792
      ],
      "id": "51834e21-4397-480e-9329-e563868d2575",
      "name": "Merge Requirements & Responses"
    },
    {
      "parameters": {
        "jsCode": "// =============================================\n// NODO: Prepare Scoring Data (v5 - Dynamic Criteria Support)\n// Supports both hardcoded defaults and dynamic criteria from database\n// =============================================\n\nconst items = $input.all();\n\nconsole.log('ðŸ“Š Prepare Scoring Data - Starting...');\nconsole.log('   Items received:', items.length);\n\n/* =========================\nGet project_id from webhook\n========================= */\nlet projectId = null;\ntry {\n    projectId = $('Set Input Params1').first().json.project_id;\n    console.log('   ðŸ“‹ Project ID:', projectId);\n} catch (e) {\n    console.log('   âš ï¸ Could not get project_id:', e.message);\n}\n\n/* =========================\nGet Dynamic Scoring Configuration (if exists)\n========================= */\nlet dynamicConfig = null;\nlet useDynamicConfig = false;\ntry {\n    const configItems = $('Fetch Scoring Configuration').all();\n    if (configItems && configItems.length > 0 && configItems[0].json.category_name) {\n        // Parse configuration into structured format\n        const configData = configItems.map(item => item.json);\n        dynamicConfig = {\n            categories: {},\n            criteria: {},\n            criteriaWeights: {},\n            categoryWeights: {}\n        };\n        \n        configData.forEach(row => {\n            const catName = row.category_name;\n            const catWeight = parseFloat(row.category_weight) || 0;\n            \n            if (!dynamicConfig.categories[catName]) {\n                dynamicConfig.categories[catName] = {\n                    name: catName,\n                    display_name: row.category_display_name,\n                    weight: catWeight,\n                    color: row.category_color,\n                    criteria: []\n                };\n                dynamicConfig.categoryWeights[catName.toUpperCase()] = catWeight / 100;\n            }\n            \n            if (row.criterion_name) {\n                const critName = row.criterion_name;\n                const critWeight = parseFloat(row.criterion_weight) || 0;\n                const actualWeight = (critWeight * catWeight) / 10000; // criterion_weight% of category_weight%\n                \n                dynamicConfig.criteria[critName] = {\n                    name: critName,\n                    display_name: row.criterion_display_name,\n                    description: row.criterion_description,\n                    category: catName,\n                    weight: critWeight,\n                    keywords: row.criterion_keywords || []\n                };\n                dynamicConfig.criteriaWeights[critName] = actualWeight;\n                dynamicConfig.categories[catName].criteria.push(critName);\n            }\n        });\n        \n        useDynamicConfig = Object.keys(dynamicConfig.criteria).length > 0;\n        console.log('   âœ… Dynamic configuration loaded:', Object.keys(dynamicConfig.criteria).length, 'criteria');\n    }\n} catch (e) {\n    console.log('   âš ï¸ Could not load dynamic config:', e.message);\n}\n\n/* =========================\nDefault Criteria (fallback)\n========================= */\nconst DEFAULT_CRITERIA_WEIGHTS = {\n    scope_facilities: 0.10,\n    scope_work: 0.10,\n    deliverables_quality: 0.10,\n    total_price: 0.15,\n    price_breakdown: 0.08,\n    optionals_included: 0.07,\n    capex_opex_methodology: 0.05,\n    schedule: 0.08,\n    resources_allocation: 0.06,\n    exceptions: 0.06,\n    safety_studies: 0.08,\n    regulatory_compliance: 0.07\n};\n\nconst DEFAULT_CATEGORY_WEIGHTS = {\n    TECHNICAL: 0.30,\n    ECONOMIC: 0.35,\n    EXECUTION: 0.20,\n    HSE_COMPLIANCE: 0.15\n};\n\n// Use dynamic or default\nconst CRITERIA_WEIGHTS = useDynamicConfig ? dynamicConfig.criteriaWeights : DEFAULT_CRITERIA_WEIGHTS;\nconst CATEGORY_WEIGHTS = useDynamicConfig ? dynamicConfig.categoryWeights : DEFAULT_CATEGORY_WEIGHTS;\n\nconsole.log('   ðŸ“Š Using', useDynamicConfig ? 'DYNAMIC' : 'DEFAULT', 'configuration');\nconsole.log('   ðŸ“Š Criteria:', Object.keys(CRITERIA_WEIGHTS).join(', '));\n\n/* =========================\nHelpers - Map requirements to criteria\n========================= */\nfunction getCriterionFromRequirement(evalType, phase, reqText, keywords) {\n    const type = (evalType || '').toLowerCase();\n    const phaseL = (phase || '').toLowerCase();\n    const text = (reqText || '').toLowerCase();\n    \n    // If using dynamic config, try to match by keywords first\n    if (useDynamicConfig && dynamicConfig.criteria) {\n        for (const [critName, critInfo] of Object.entries(dynamicConfig.criteria)) {\n            const kws = critInfo.keywords || [];\n            for (const kw of kws) {\n                if (text.includes(kw.toLowerCase())) {\n                    return critName;\n                }\n            }\n        }\n    }\n    \n    // Fallback to default mapping logic\n    if (type.includes('technical')) {\n        if (text.includes('scope of facilities') || text.includes('hydrogen plant') || text.includes('utilities')) {\n            return 'scope_facilities';\n        }\n        if (text.includes('scope of work') || text.includes('project management') || text.includes('deliverables')) {\n            return 'scope_work';\n        }\n        if (text.includes('p&id') || text.includes('3d model') || text.includes('specification') || text.includes('datasheet')) {\n            return 'deliverables_quality';\n        }\n        return 'scope_work';\n    }\n    \n    if (type.includes('econom')) {\n        if (text.includes('price') || text.includes('â‚¬') || text.includes('fee') || text.includes('cost')) {\n            return 'total_price';\n        }\n        if (text.includes('hour') || text.includes('discipline') || text.includes('breakdown')) {\n            return 'price_breakdown';\n        }\n        if (text.includes('optional') || text.includes('geotechnical') || text.includes('topograph') || text.includes('hazid')) {\n            return 'optionals_included';\n        }\n        if (text.includes('capex') || text.includes('opex') || text.includes('aacei') || text.includes('estimate')) {\n            return 'capex_opex_methodology';\n        }\n        return 'total_price';\n    }\n    \n    if (text.includes('hse') || text.includes('safety') || text.includes('hazop') || text.includes('hazid') || text.includes('atex') || text.includes('qra')) {\n        return 'safety_studies';\n    }\n    if (text.includes('code') || text.includes('standard') || text.includes('compliance') || text.includes('regulation')) {\n        return 'regulatory_compliance';\n    }\n    \n    if (phaseL.includes('pre-feed') || phaseL.includes('feed') || type.includes('deliverable')) {\n        if (text.includes('schedule') || text.includes('planning') || text.includes('timeline')) {\n            return 'schedule';\n        }\n        if (text.includes('exception') || text.includes('deviation') || text.includes('exclusion')) {\n            return 'exceptions';\n        }\n        return 'resources_allocation';\n    }\n    \n    return 'scope_work';\n}\n\nfunction classifyEval(val) {\n    const v = (val || '').toUpperCase();\n    if (v.includes('INCLUD') || v.includes('INCLUIDO') || v === 'SI' || v === 'YES') return 'INCLUDED';\n    if (v.includes('PARCIAL') || v.includes('PARTIAL')) return 'PARTIAL';\n    if (v.includes('NO INCLUD') || v.includes('NOT INCLUD') || v === 'NO') return 'NOT_INCLUDED';\n    return 'NO_INFO';\n}\n\n/* =========================\nGet data from previous nodes\n========================= */\nlet requirements = [];\nlet responses = [];\n\ntry {\n    const reqItems = $('Fetch Requirements').all();\n    requirements = reqItems.map(item => item.json);\n    console.log('   âœ… Requirements from Fetch Requirements:', requirements.length);\n} catch (e) {\n    console.log('   âš ï¸ Could not access Fetch Requirements:', e.message);\n}\n\ntry {\n    const respItems = $('Fetch Provider Responses').all();\n    responses = respItems.map(item => item.json);\n    console.log('   âœ… Responses from Fetch Provider Responses:', responses.length);\n} catch (e) {\n    console.log('   âš ï¸ Could not access Fetch Provider Responses:', e.message);\n}\n\nif (requirements.length === 0 || responses.length === 0) {\n    console.log('   ðŸ”„ Using fallback: separating from input...');\n    items.forEach(item => {\n        const data = item.json;\n        if (data.requirement_text && !data.provider_name) {\n            requirements.push(data);\n        } else if (data.provider_name && data.requirement_id) {\n            responses.push(data);\n        }\n    });\n}\n\nif (requirements.length === 0) {\n    return [{ json: { error: 'No requirements found', items_received: items.length } }];\n}\nif (responses.length === 0) {\n    return [{ json: { error: 'No responses found', items_received: items.length } }];\n}\n\n/* =========================\nOptimization with MAPS\n========================= */\nconst requirementMap = {};\nrequirements.forEach(r => {\n    if (r.id) requirementMap[r.id] = r;\n});\n\nconst responsesByProvider = {};\nresponses.forEach(r => {\n    if (r.provider_name) {\n        if (!responsesByProvider[r.provider_name]) {\n            responsesByProvider[r.provider_name] = [];\n        }\n        responsesByProvider[r.provider_name].push(r);\n    }\n});\n\nconsole.log('   ðŸ“Š Providers found:', Object.keys(responsesByProvider).join(', '));\n\n/* =========================\nGet Economic Offers Data\n========================= */\nlet economicOffers = [];\ntry {\n    const econItems = $('Fetch Economic Offers').all();\n    economicOffers = econItems.map(item => item.json);\n    console.log('   âœ… Economic Offers:', economicOffers.length);\n} catch (e) {\n    console.log('   âš ï¸ Could not access Economic Offers:', e.message);\n}\n\nconst economicByProvider = {};\neconomicOffers.forEach(offer => {\n    if (offer.provider_name) {\n        economicByProvider[offer.provider_name] = offer;\n        economicByProvider[offer.provider_name.toUpperCase()] = offer;\n    }\n});\n\nconsole.log('   ðŸ’° Economic data for:', economicOffers.map(o => o.provider_name).join(', '));\n\n/* =========================\nHelper: Score economic criteria from economic_offers\n========================= */\nfunction getEconomicScore(criterionName, keywords, providerOffer, allOffers) {\n    if (!providerOffer) return null;\n    const name = (criterionName || '').toLowerCase();\n    const kws = (keywords || []).map(k => k.toLowerCase());\n    \n    // TCO / Total Price / Total Cost\n    if (name.includes('tco') || name.includes('total_cost') || name.includes('total_price') ||\n        kws.some(k => k.includes('tco') || k.includes('total cost') || k.includes('investment') || k.includes('coste total'))) {\n        const myPrice = providerOffer.tco_value || providerOffer.total_price;\n        if (!myPrice) return null;\n        const prices = allOffers.filter(o => (o.tco_value || o.total_price) > 0).map(o => o.tco_value || o.total_price);\n        if (prices.length <= 1) return 7;\n        const minP = Math.min(...prices);\n        const maxP = Math.max(...prices);\n        if (minP === maxP) return 7;\n        return Math.round((9 - ((myPrice - minP) / (maxP - minP)) * 5) * 100) / 100;\n    }\n    \n    // Price Breakdown / Transparency\n    if (name.includes('breakdown') || name.includes('transparency') || name.includes('desglose') || name.includes('capex') ||\n        kws.some(k => k.includes('breakdown') || k.includes('itemized') || k.includes('desglose') || k.includes('capex') || k.includes('opex'))) {\n        const bd = providerOffer.price_breakdown;\n        if (!bd || typeof bd !== 'object') return 2;\n        const entries = Object.keys(bd).length;\n        if (entries >= 5) return 9;\n        if (entries >= 3) return 7;\n        if (entries >= 1) return 5;\n        return 2;\n    }\n    \n    // Energy Efficiency / Savings / PUE\n    if (name.includes('energy') || name.includes('efficiency') || name.includes('savings') || name.includes('pue') ||\n        kws.some(k => k.includes('energy') || k.includes('pue') || k.includes('efficiency') || k.includes('roi'))) {\n        const tcoB = providerOffer.tco_breakdown;\n        if (tcoB && typeof tcoB === 'object') {\n            const eKeys = Object.keys(tcoB).filter(k =>\n                k.toLowerCase().includes('energy') || k.toLowerCase().includes('electric') ||\n                k.toLowerCase().includes('pue') || k.toLowerCase().includes('cooling'));\n            if (eKeys.length > 0) return 7;\n        }\n        const opts = providerOffer.optional_items || [];\n        const eOpts = opts.filter(o => {\n            const d = (o.description || '').toLowerCase();\n            return d.includes('energy') || d.includes('efficiency') || d.includes('pue') || d.includes('solar');\n        });\n        if (eOpts.length > 0) return 6;\n        if (providerOffer.total_price) return 3;\n        return null;\n    }\n    \n    // Payment Terms / Milestones\n    if (name.includes('payment') || name.includes('milestone') || name.includes('pago') || name.includes('plazo') ||\n        kws.some(k => k.includes('payment') || k.includes('milestone') || k.includes('pago') || k.includes('financing'))) {\n        const hasPT = providerOffer.payment_terms && providerOffer.payment_terms.trim().length > 0;\n        const hasPS = providerOffer.payment_schedule && providerOffer.payment_schedule.length > 0;\n        if (hasPT && hasPS) return 8;\n        if (hasPT || hasPS) return 5;\n        if (providerOffer.discount_percentage > 0) return 4;\n        return null;\n    }\n    \n    // Discount / Optionals\n    if (name.includes('optional') || name.includes('discount') || name.includes('descuento') ||\n        kws.some(k => k.includes('optional') || k.includes('discount') || k.includes('alternative'))) {\n        let s = 3;\n        if ((providerOffer.optional_items || []).length > 0) s += 2;\n        if ((providerOffer.alternative_offers || []).length > 0) s += 2;\n        if ((providerOffer.discount_percentage || 0) > 0) s += 2;\n        return Math.min(s, 9);\n    }\n    \n    // Schedule / Timeline\n    if (name.includes('schedule') || name.includes('timeline') || name.includes('cronograma') ||\n        kws.some(k => k.includes('schedule') || k.includes('timeline') || k.includes('gantt'))) {\n        if (providerOffer.validity_days > 0) return 5;\n        return null;\n    }\n    \n    return null;\n}\n\n/* =========================\nProvider filter (optional)\n========================= */\nlet providerFilter = '';\ntry {\n    providerFilter = $('Set Input Params1').first().json.provider_filter || '';\n} catch (e) {}\n\nlet providers = Object.keys(responsesByProvider);\nif (providerFilter) {\n    providers = providers.filter(p => p.toLowerCase().includes(providerFilter.toLowerCase()));\n}\n\nif (providers.length === 0) {\n    return [{ json: { error: 'No providers found', filter: providerFilter } }];\n}\n\n/* =========================\nEvaluation by Criteria\n========================= */\nconst evaluationData = providers.map(providerName => {\n    const providerResponses = responsesByProvider[providerName] || [];\n    \n    // Initialize criteria summary\n    const criteriaScores = {};\n    Object.keys(CRITERIA_WEIGHTS).forEach(criterion => {\n        criteriaScores[criterion] = { total: 0, included: 0, partial: 0, not_included: 0, no_info: 0, scores: [] };\n    });\n    \n    providerResponses.forEach(resp => {\n        const req = requirementMap[resp.requirement_id];\n        if (!req) return;\n        \n        const criterion = getCriterionFromRequirement(req.evaluation_type, req.phase, req.requirement_text);\n        const evalClass = classifyEval(resp.evaluation_value);\n        \n        const cs = criteriaScores[criterion];\n        if (!cs) return;\n        \n        cs.total++;\n        if (evalClass === 'INCLUDED') cs.included++;\n        else if (evalClass === 'PARTIAL') cs.partial++;\n        else if (evalClass === 'NOT_INCLUDED') cs.not_included++;\n        else cs.no_info++;\n        \n        if (typeof resp.score === 'number' && resp.score > 0) {\n            cs.scores.push(resp.score);\n        }\n    });\n    \n    // Calculate average scores per criterion\n    let globalScore = 0;\n    const criteriaAvgScores = {};\n    \n    Object.keys(criteriaScores).forEach(criterion => {\n        const cs = criteriaScores[criterion];\n        if (cs.scores.length > 0) {\n            cs.avg_score = Math.round((cs.scores.reduce((a, b) => a + b, 0) / cs.scores.length) * 100) / 100;\n        } else if (cs.total > 0) {\n            // Calculate based on items with actual evaluations (exclude no_info from denominator)\n            const evaluated = cs.included + cs.partial + cs.not_included;\n            if (evaluated > 0) {\n                cs.avg_score = Math.round(((cs.included * 9 + cs.partial * 6 + cs.not_included * 2) / evaluated) * 100) / 100;\n            } else {\n                cs.avg_score = 0;\n            }\n        } else {\n            cs.avg_score = 0;\n        }\n        criteriaAvgScores[criterion] = cs.avg_score;\n        globalScore += cs.avg_score * (CRITERIA_WEIGHTS[criterion] || 0);\n        delete cs.scores;\n    });\n    \n    globalScore = Math.round(globalScore * 100) / 100;\n    \n    // === ECONOMIC ENRICHMENT: Use economic_offers data to improve scores ===\n    const providerEconOffer = economicByProvider[providerName] || economicByProvider[providerName.toUpperCase()];\n    if (providerEconOffer) {\n        console.log('   ðŸ’° Enriching scores for', providerName, 'with economic data');\n        let enrichedCount = 0;\n        globalScore = 0;\n        \n        Object.keys(criteriaAvgScores).forEach(crit => {\n            const critInfo = useDynamicConfig && dynamicConfig.criteria[crit] ? dynamicConfig.criteria[crit] : null;\n            const kws = critInfo ? critInfo.keywords : [];\n            const econScore = getEconomicScore(crit, kws, providerEconOffer, economicOffers);\n            \n            if (econScore !== null && econScore > criteriaAvgScores[crit]) {\n                console.log('     ðŸ’°', crit, ':', criteriaAvgScores[crit], 'â†’', econScore, '(economic data)');\n                criteriaAvgScores[crit] = econScore;\n                enrichedCount++;\n            }\n            \n            globalScore += criteriaAvgScores[crit] * (CRITERIA_WEIGHTS[crit] || 0);\n        });\n        \n        globalScore = Math.round(globalScore * 100) / 100;\n        console.log('   ðŸ’° Enriched', enrichedCount, 'criteria â†’ new global:', globalScore);\n    }\n    \n    // Calculate category scores dynamically\n    let categoryScores = {};\n    if (useDynamicConfig) {\n        for (const [catName, catInfo] of Object.entries(dynamicConfig.categories)) {\n            const catCriteria = catInfo.criteria || [];\n            const scores = catCriteria.map(c => criteriaAvgScores[c] || 0);\n            const avg = scores.length > 0 ? scores.reduce((a, b) => a + b, 0) / scores.length : 0;\n            categoryScores[catName.toUpperCase()] = Math.round(avg * 100) / 100;\n        }\n    } else {\n        categoryScores = {\n            TECHNICAL: Math.round(((criteriaAvgScores.scope_facilities || 0) + (criteriaAvgScores.scope_work || 0) + (criteriaAvgScores.deliverables_quality || 0)) / 3 * 100) / 100,\n            ECONOMIC: Math.round(((criteriaAvgScores.total_price || 0) + (criteriaAvgScores.price_breakdown || 0) + (criteriaAvgScores.optionals_included || 0) + (criteriaAvgScores.capex_opex_methodology || 0)) / 4 * 100) / 100,\n            EXECUTION: Math.round(((criteriaAvgScores.schedule || 0) + (criteriaAvgScores.resources_allocation || 0) + (criteriaAvgScores.exceptions || 0)) / 3 * 100) / 100,\n            HSE_COMPLIANCE: Math.round(((criteriaAvgScores.safety_studies || 0) + (criteriaAvgScores.regulatory_compliance || 0)) / 2 * 100) / 100\n        };\n    }\n    \n    return {\n        provider_name: providerName,\n        project_id: projectId,\n        total_responses: providerResponses.length,\n        global_score: globalScore,\n        category_scores: categoryScores,\n        criteria_scores: criteriaAvgScores,\n        criteria_summary: criteriaScores,\n        config_type: useDynamicConfig ? 'dynamic' : 'default',\n        scoring_config: useDynamicConfig ? dynamicConfig : null,\n        economic_data: economicByProvider[providerName] || economicByProvider[providerName.toUpperCase()] || null\n    };\n});\n\n/* =========================\nExecutive Ranking\n========================= */\nevaluationData\n    .sort((a, b) => b.global_score - a.global_score)\n    .forEach((item, index) => {\n        item.rank = index + 1;\n    });\n\nconsole.log('âœ… Scoring Data prepared for', evaluationData.length, 'providers');\nconsole.log('   Project ID included:', projectId);\nconsole.log('   Config type:', useDynamicConfig ? 'DYNAMIC' : 'DEFAULT');\n\nreturn evaluationData.map(data => ({ json: data }));"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        -9072,
        5792
      ],
      "id": "1aafd7f9-2447-460d-8bd4-fb56d43d1606",
      "name": "Prepare Scoring Data"
    },
    {
      "parameters": {
        "options": {
          "reset": false
        }
      },
      "type": "n8n-nodes-base.splitInBatches",
      "typeVersion": 3,
      "position": [
        -8848,
        5744
      ],
      "id": "949aa4f2-e750-406a-8b76-3809785f7346",
      "name": "Loop Over Providers"
    },
    {
      "parameters": {
        "promptType": "define",
        "text": "=You are a procurement evaluation assistant. Score this provider's proposal.\n\nOUTPUT LANGUAGE: {{ $('Set Input Params1').first().json.language === 'en' ? 'ENGLISH - Write evaluation_summary, strengths and weaknesses in English.' : 'ESPAÃ‘OL - Escribe evaluation_summary, strengths y weaknesses en espaÃ±ol.' }}\n\nPROVIDER: {{ $json.provider_name }}\nTOTAL RESPONSES: {{ $json.total_responses }}\nPROJECT CONTEXT: {{ $('Fetch Project Context Scoring').first().json.ai_context || 'Procurement evaluation' }}\n\nCURRENCY: {{ $('Set Input Params1').first().json.currency || 'EUR' }} (use this currency when referencing monetary values)\n\nECONOMIC DATA (from economic_offers table):\n{{ $json.economic_data ? JSON.stringify($json.economic_data) : 'No economic data available' }}\n\nPRE-CALCULATED COMPLIANCE DATA:\nCategory scores: {{ JSON.stringify($json.category_scores) }}\nCriteria scores: {{ JSON.stringify($json.criteria_scores) }}\n\nCRITERIA DETAILS (included/partial/not_included/no_info counts):\n{{ JSON.stringify($json.criteria_summary) }}\n\nSCORING METHODOLOGY:\n- Scale: 0-10 per criterion\n- Use the pre-calculated scores as your STARTING POINT\n- You may adjust each criterion score UP or DOWN by up to 1.5 points based on your analysis\n- Adjustments should reflect qualitative factors not captured in simple compliance counts\n\nSCORE INTERPRETATION:\n- 8-10: Excellent compliance, provider fully addresses the requirement\n- 6-7.9: Good compliance, minor gaps or less detail than ideal\n- 4-5.9: Partial compliance, significant gaps but some coverage\n- 2-3.9: Poor compliance, minimal coverage\n- 0-1.9: No compliance or no information\n\nTYPICAL EXPECTATIONS:\n- A competitive proposal that addresses most requirements should score 6-8 overall\n- Very few providers score above 9 (exceptional) or below 3 (non-responsive)\n- If the pre-calculated scores seem too low relative to the compliance data, adjust upward\n- A criterion with majority INCLUDED items should score at least 6.0\n- A criterion with majority PARTIAL items should score at least 4.0\n\nRETURN ONLY valid JSON with this exact structure:\n{\n  \"provider_name\": \"{{ $json.provider_name }}\",\n  \"category_scores\": {\n    {{ $json.scoring_config ? Object.keys($json.scoring_config.categories).map(name => `\"${name.toUpperCase()}\": { \"score\": 7.0, \"weight\": ${$json.scoring_config.categories[name].weight / 100} }`).join(',\\n    ') : `\"TECHNICAL\": { \"score\": 7.0, \"weight\": 0.30 },\\n    \"ECONOMIC\": { \"score\": 7.0, \"weight\": 0.35 },\\n    \"EXECUTION\": { \"score\": 7.0, \"weight\": 0.20 },\\n    \"HSE_COMPLIANCE\": { \"score\": 7.0, \"weight\": 0.15 }` }}\n  },\n  \"individual_scores\": {\n    {{ Object.keys($json.criteria_scores).map(k => `\"${k}\": ${$json.criteria_scores[k] || 5.0}`).join(',\\n    ') }}\n  },\n  \"overall_score\": {{ $json.global_score || 5.0 }},\n  \"compliance_percentage\": 70,\n  \"evaluation_summary\": \"Brief 1-2 sentence evaluation in {{ $('Set Input Params1').first().json.language === 'en' ? 'English' : 'Spanish' }}\",\n  \"strengths\": [\"strength 1\", \"strength 2\"],\n  \"weaknesses\": [\"weakness 1\", \"weakness 2\"]\n}\n\nIMPORTANT: Replace the example numbers with your actual scores. Use the pre-calculated scores as your starting point and adjust based on qualitative analysis. All number fields must be actual numbers (not strings). Write text fields in {{ $('Set Input Params1').first().json.language === 'en' ? 'English' : 'Spanish' }}.",
        "hasOutputParser": true,
        "batching": {}
      },
      "type": "@n8n/n8n-nodes-langchain.chainLlm",
      "typeVersion": 1.8,
      "position": [
        -8576,
        5760
      ],
      "id": "44d25e9f-a661-4733-b9c2-e106ba61e82b",
      "name": "Scoring LLM Chain",
      "alwaysOutputData": true,
      "continueOnFail": true
    },
    {
      "parameters": {
        "jsCode": "// =============================================\n// NODO: Calculate Weighted Scores (v8 - Resilient to LLM failures)\n// FIX: Gets project_id from Set Input Params1 (not LLM output)\n// FIX: Falls back to pre-calculated scores when LLM returns zeros or errors\n// FIX: Handles LLM chain continueOnFail error items\n// =============================================\n\nconst input = $input.first().json;\n\n// Check if LLM chain failed (continueOnFail produces error items)\nconst isLlmError = input.error || input.errorMessage || !input.output;\nif (isLlmError) {\n    console.log('Calculate Weighted Scores v8 - LLM FAILED, using pre-calculated scores only');\n    console.log('  Error:', input.error || input.errorMessage || 'No output from LLM');\n}\n\nconst llmOutput = (!isLlmError && input.output) ? input.output : {};\n\nconsole.log('Calculate Weighted Scores v8 - Starting...');\nconsole.log('  LLM output keys:', Object.keys(llmOutput).join(', '));\n\n// === FIX 1: Get project_id from webhook params (NOT from LLM) ===\nlet projectId = null;\ntry {\n    projectId = $('Set Input Params1').first().json.project_id;\n} catch(e) {\n    console.log('  Could not get project_id:', e.message);\n}\n\n// === FIX 2: Get pre-calculated scores from Prepare Scoring Data ===\nlet configType = 'default';\nlet scoringConfig = null;\nlet preCalcCriteria = {};\nlet preCalcCategory = {};\nlet preCalcGlobal = 0;\ntry {\n    const allPrepared = $('Prepare Scoring Data').all();\n    const providerName = llmOutput.provider_name || '';\n    const match = allPrepared.find(item => item.json.provider_name === providerName);\n    if (match) {\n        configType = match.json.config_type || 'default';\n        scoringConfig = match.json.scoring_config || null;\n        preCalcCriteria = match.json.criteria_scores || {};\n        preCalcCategory = match.json.category_scores || {};\n        preCalcGlobal = match.json.global_score || 0;\n        console.log('  Pre-calculated scores found for', providerName);\n        console.log('  Pre-calc criteria:', JSON.stringify(preCalcCriteria));\n        console.log('  Pre-calc categories:', JSON.stringify(preCalcCategory));\n        console.log('  Pre-calc global:', preCalcGlobal);\n    } else {\n        console.log('  No pre-calculated match for:', providerName);\n    }\n} catch(e) {\n    console.log('  Could not get pre-calculated scores:', e.message);\n}\n\n// === Extract LLM category scores ===\nconst llmCatScores = llmOutput.category_scores || {};\nconst getScore = (cat) => {\n    const v = llmCatScores[cat];\n    if (!v) return 0;\n    return (typeof v === 'object' && v.score) ? v.score : (typeof v === 'number' ? v : 0);\n};\n\n// === FIX 3: Build individual scores with fallback to pre-calculated ===\nconst llmIndividual = llmOutput.individual_scores || {};\nconst is = {};\nconst allCriteriaKeys = new Set([\n    ...Object.keys(llmIndividual),\n    ...Object.keys(preCalcCriteria)\n]);\nfor (const key of allCriteriaKeys) {\n    const llmVal = llmIndividual[key];\n    const preVal = preCalcCriteria[key];\n    // Use LLM value only if it's a real positive number\n    is[key] = (typeof llmVal === 'number' && llmVal > 0) ? llmVal : (preVal || 0);\n}\nconsole.log('  Final individual_scores:', JSON.stringify(is));\n\n// === Build category scores with fallback ===\nconst categoryScoresClean = {};\nconst allCatKeys = new Set([\n    ...Object.keys(llmCatScores),\n    ...Object.keys(preCalcCategory)\n]);\nfor (const catKey of allCatKeys) {\n    const llmCatVal = llmCatScores[catKey];\n    const preCatVal = preCalcCategory[catKey];\n    const llmScore = (typeof llmCatVal === 'object' && llmCatVal?.score)\n        ? llmCatVal.score\n        : (typeof llmCatVal === 'number' ? llmCatVal : 0);\n    categoryScoresClean[catKey] = (llmScore > 0) ? llmScore : (preCatVal || 0);\n}\nconsole.log('  Final category_scores:', JSON.stringify(categoryScoresClean));\n\n// === Calculate overall score with fallback ===\nconst llmOverall = llmOutput.overall_score || 0;\nconst overallScore = llmOverall > 0 ? llmOverall : preCalcGlobal;\n\n// === Calculate compliance percentage with fallback ===\nconst llmCompliance = llmOutput.compliance_percentage || 0;\nconst compliancePercentage = llmCompliance > 0 ? llmCompliance : Math.round(overallScore * 10);\n\n// Build ranking object\nconst ranking = {\n    provider_name: llmOutput.provider_name || input.provider_name || 'UNKNOWN',\n    project_id: projectId,\n    // Legacy fixed fields\n    technical_score: categoryScoresClean.TECHNICAL || categoryScoresClean.technical || 0,\n    economic_score: categoryScoresClean.ECONOMIC || categoryScoresClean.economic || 0,\n    execution_score: categoryScoresClean.EXECUTION || categoryScoresClean.execution || 0,\n    hse_compliance_score: categoryScoresClean.HSE_COMPLIANCE || categoryScoresClean.hse_compliance || 0,\n    scope_facilities_score: is.scope_facilities || 0,\n    scope_work_score: is.scope_work || 0,\n    deliverables_quality_score: is.deliverables_quality || 0,\n    total_price_score: is.total_price || 0,\n    price_breakdown_score: is.price_breakdown || 0,\n    optionals_included_score: is.optionals_included || 0,\n    capex_opex_methodology_score: is.capex_opex_methodology || 0,\n    schedule_score: is.schedule || 0,\n    resources_allocation_score: is.resources_allocation || 0,\n    exceptions_score: is.exceptions || 0,\n    safety_studies_score: is.safety_studies || 0,\n    regulatory_compliance_score: is.regulatory_compliance || 0,\n    // Dynamic JSONB fields\n    category_scores_json: categoryScoresClean,\n    individual_scores_json: is,\n    evaluation_details: {\n        strengths: llmOutput.strengths || [],\n        weaknesses: llmOutput.weaknesses || [],\n        recommendations: llmOutput.recommendations || [],\n        summary: llmOutput.evaluation_summary || ''\n    },\n    overall_score: overallScore,\n    compliance_percentage: compliancePercentage,\n    evaluation_count: 1,\n    last_updated: new Date().toISOString()\n};\n\nconsole.log('  FINAL ranking for', ranking.provider_name, ':', ranking.overall_score);\n\nreturn [{\n    json: {\n        ranking,\n        details: ranking.evaluation_details,\n        category_scores: categoryScoresClean,\n        individual_scores: is,\n        config_type: configType,\n        scoring_config: scoringConfig\n    }\n}];"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        -8192,
        5760
      ],
      "id": "17c4fc68-d944-4b5b-81a0-59bd54a65292",
      "name": "Calculate Weighted Scores"
    },
    {
      "parameters": {
        "useCustomSchema": true,
        "schema": "public",
        "operation": "getAll",
        "tableId": "ranking_proveedores",
        "limit": 1,
        "filters": {
          "conditions": [
            {
              "keyName": "provider_name",
              "condition": "eq",
              "keyValue": "={{ $('Calculate Weighted Scores').first().json.ranking.provider_name }}"
            },
            {
              "keyName": "project_id",
              "condition": "eq",
              "keyValue": "={{ $('Set Input Params1').first().json.project_id }}"
            }
          ]
        }
      },
      "type": "n8n-nodes-base.supabase",
      "typeVersion": 1,
      "position": [
        -7952,
        5760
      ],
      "id": "2983bc1d-531e-4d24-9937-07d51da279f1",
      "name": "Check Provider Exists",
      "alwaysOutputData": true,
      "credentials": {
        "supabaseApi": {
          "id": "pI4CpdYLTiEEBmnz",
          "name": "Supabase account"
        }
      }
    },
    {
      "parameters": {
        "conditions": {
          "options": {
            "caseSensitive": true,
            "leftValue": "",
            "typeValidation": "strict",
            "version": 2
          },
          "conditions": [
            {
              "id": "provider-exists-condition",
              "leftValue": "={{ $input.all().length }}",
              "rightValue": 0,
              "operator": {
                "type": "number",
                "operation": "gt"
              }
            }
          ],
          "combinator": "and"
        },
        "options": {}
      },
      "type": "n8n-nodes-base.if",
      "typeVersion": 2.2,
      "position": [
        -7712,
        5760
      ],
      "id": "0cdeb1f7-681d-4feb-b2a1-6d7e161beaf6",
      "name": "Provider Exists?",
      "disabled": true
    },
    {
      "parameters": {
        "operation": "update",
        "tableId": "ranking_proveedores",
        "matchType": "allFilters",
        "filters": {
          "conditions": [
            {
              "keyName": "provider_name",
              "condition": "eq",
              "keyValue": "={{ $('Calculate Weighted Scores').first().json.ranking.provider_name }}"
            },
            {
              "keyName": "project_id",
              "condition": "eq",
              "keyValue": "={{ $('Set Input Params1').first().json.project_id }}"
            }
          ]
        },
        "fieldsUi": {
          "fieldValues": [
            {
              "fieldId": "project_id",
              "fieldValue": "={{ $('Set Input Params1').first().json.project_id }}"
            },
            {
              "fieldId": "technical_score",
              "fieldValue": "={{ $('Calculate Weighted Scores').first().json.ranking.technical_score || 0 }}"
            },
            {
              "fieldId": "economic_score",
              "fieldValue": "={{ $('Calculate Weighted Scores').first().json.ranking.economic_score || 0 }}"
            },
            {
              "fieldId": "execution_score",
              "fieldValue": "={{ $('Calculate Weighted Scores').first().json.ranking.execution_score || 0 }}"
            },
            {
              "fieldId": "hse_compliance_score",
              "fieldValue": "={{ $('Calculate Weighted Scores').first().json.ranking.hse_compliance_score || 0 }}"
            },
            {
              "fieldId": "scope_facilities_score",
              "fieldValue": "={{ $('Calculate Weighted Scores').first().json.ranking.scope_facilities_score || 0 }}"
            },
            {
              "fieldId": "scope_work_score",
              "fieldValue": "={{ $('Calculate Weighted Scores').first().json.ranking.scope_work_score || 0 }}"
            },
            {
              "fieldId": "deliverables_quality_score",
              "fieldValue": "={{ $('Calculate Weighted Scores').first().json.ranking.deliverables_quality_score || 0 }}"
            },
            {
              "fieldId": "total_price_score",
              "fieldValue": "={{ $('Calculate Weighted Scores').first().json.ranking.total_price_score || 0 }}"
            },
            {
              "fieldId": "price_breakdown_score",
              "fieldValue": "={{ $('Calculate Weighted Scores').first().json.ranking.price_breakdown_score || 0 }}"
            },
            {
              "fieldId": "optionals_included_score",
              "fieldValue": "={{ $('Calculate Weighted Scores').first().json.ranking.optionals_included_score || 0 }}"
            },
            {
              "fieldId": "capex_opex_methodology_score",
              "fieldValue": "={{ $('Calculate Weighted Scores').first().json.ranking.capex_opex_methodology_score || 0 }}"
            },
            {
              "fieldId": "schedule_score",
              "fieldValue": "={{ $('Calculate Weighted Scores').first().json.ranking.schedule_score || 0 }}"
            },
            {
              "fieldId": "resources_allocation_score",
              "fieldValue": "={{ $('Calculate Weighted Scores').first().json.ranking.resources_allocation_score || 0 }}"
            },
            {
              "fieldId": "exceptions_score",
              "fieldValue": "={{ $('Calculate Weighted Scores').first().json.ranking.exceptions_score || 0 }}"
            },
            {
              "fieldId": "safety_studies_score",
              "fieldValue": "={{ $('Calculate Weighted Scores').first().json.ranking.safety_studies_score || 0 }}"
            },
            {
              "fieldId": "regulatory_compliance_score",
              "fieldValue": "={{ $('Calculate Weighted Scores').first().json.ranking.regulatory_compliance_score || 0 }}"
            },
            {
              "fieldId": "overall_score",
              "fieldValue": "={{ $('Calculate Weighted Scores').first().json.ranking.overall_score || 0 }}"
            },
            {
              "fieldId": "compliance_percentage",
              "fieldValue": "={{ $('Calculate Weighted Scores').first().json.ranking.compliance_percentage || 0 }}"
            },
            {
              "fieldId": "evaluation_count",
              "fieldValue": "={{ $('Calculate Weighted Scores').first().json.ranking.evaluation_count || 0 }}"
            },
            {
              "fieldId": "last_updated",
              "fieldValue": "={{ $('Calculate Weighted Scores').first().json.ranking.last_updated }}"
            }
          ]
        }
      },
      "type": "n8n-nodes-base.supabase",
      "typeVersion": 1,
      "position": [
        -7472,
        5664
      ],
      "id": "9585e068-3b6f-42a5-9b7c-e8d3072dafeb",
      "name": "Update Ranking",
      "alwaysOutputData": false,
      "credentials": {
        "supabaseApi": {
          "id": "pI4CpdYLTiEEBmnz",
          "name": "Supabase account"
        }
      },
      "disabled": true,
      "continueOnFail": true
    },
    {
      "parameters": {
        "useCustomSchema": true,
        "schema": "public",
        "tableId": "ranking_proveedores",
        "fieldsUi": {
          "fieldValues": [
            {
              "fieldId": "provider_name",
              "fieldValue": "={{ $('Calculate Weighted Scores').first().json.ranking.provider_name }}"
            },
            {
              "fieldId": "project_id",
              "fieldValue": "={{ $('Set Input Params1').first().json.project_id }}"
            },
            {
              "fieldId": "technical_score",
              "fieldValue": "={{ $('Calculate Weighted Scores').first().json.ranking.technical_score || 0 }}"
            },
            {
              "fieldId": "economic_score",
              "fieldValue": "={{ $('Calculate Weighted Scores').first().json.ranking.economic_score || 0 }}"
            },
            {
              "fieldId": "execution_score",
              "fieldValue": "={{ $('Calculate Weighted Scores').first().json.ranking.execution_score || 0 }}"
            },
            {
              "fieldId": "hse_compliance_score",
              "fieldValue": "={{ $('Calculate Weighted Scores').first().json.ranking.hse_compliance_score || 0 }}"
            },
            {
              "fieldId": "scope_facilities_score",
              "fieldValue": "={{ $('Calculate Weighted Scores').first().json.ranking.scope_facilities_score || 0 }}"
            },
            {
              "fieldId": "scope_work_score",
              "fieldValue": "={{ $('Calculate Weighted Scores').first().json.ranking.scope_work_score || 0 }}"
            },
            {
              "fieldId": "deliverables_quality_score",
              "fieldValue": "={{ $('Calculate Weighted Scores').first().json.ranking.deliverables_quality_score || 0 }}"
            },
            {
              "fieldId": "total_price_score",
              "fieldValue": "={{ $('Calculate Weighted Scores').first().json.ranking.total_price_score || 0 }}"
            },
            {
              "fieldId": "price_breakdown_score",
              "fieldValue": "={{ $('Calculate Weighted Scores').first().json.ranking.price_breakdown_score || 0 }}"
            },
            {
              "fieldId": "optionals_included_score",
              "fieldValue": "={{ $('Calculate Weighted Scores').first().json.ranking.optionals_included_score || 0 }}"
            },
            {
              "fieldId": "capex_opex_methodology_score",
              "fieldValue": "={{ $('Calculate Weighted Scores').first().json.ranking.capex_opex_methodology_score || 0 }}"
            },
            {
              "fieldId": "schedule_score",
              "fieldValue": "={{ $('Calculate Weighted Scores').first().json.ranking.schedule_score || 0 }}"
            },
            {
              "fieldId": "resources_allocation_score",
              "fieldValue": "={{ $('Calculate Weighted Scores').first().json.ranking.resources_allocation_score || 0 }}"
            },
            {
              "fieldId": "exceptions_score",
              "fieldValue": "={{ $('Calculate Weighted Scores').first().json.ranking.exceptions_score || 0 }}"
            },
            {
              "fieldId": "safety_studies_score",
              "fieldValue": "={{ $('Calculate Weighted Scores').first().json.ranking.safety_studies_score || 0 }}"
            },
            {
              "fieldId": "regulatory_compliance_score",
              "fieldValue": "={{ $('Calculate Weighted Scores').first().json.ranking.regulatory_compliance_score || 0 }}"
            },
            {
              "fieldId": "overall_score",
              "fieldValue": "={{ $('Calculate Weighted Scores').first().json.ranking.overall_score || 0 }}"
            },
            {
              "fieldId": "compliance_percentage",
              "fieldValue": "={{ $('Calculate Weighted Scores').first().json.ranking.compliance_percentage || 0 }}"
            },
            {
              "fieldId": "evaluation_count",
              "fieldValue": "={{ $('Calculate Weighted Scores').first().json.ranking.evaluation_count || 0 }}"
            },
            {
              "fieldId": "last_updated",
              "fieldValue": "={{ $('Calculate Weighted Scores').first().json.ranking.last_updated }}"
            },
            {
              "fieldId": "category_scores_json",
              "fieldValue": "={{ $('Calculate Weighted Scores').first().json.ranking.category_scores_json }}"
            },
            {
              "fieldId": "individual_scores_json",
              "fieldValue": "={{ $('Calculate Weighted Scores').first().json.ranking.individual_scores_json }}"
            },
            {
              "fieldId": "evaluation_details",
              "fieldValue": "={{ $('Calculate Weighted Scores').first().json.ranking.evaluation_details }}"
            }
          ]
        }
      },
      "type": "n8n-nodes-base.supabase",
      "typeVersion": 1,
      "position": [
        -7472,
        5888
      ],
      "id": "309650c1-a6b2-41d2-850f-c4879aa863aa",
      "name": "Insert Ranking",
      "alwaysOutputData": false,
      "credentials": {
        "supabaseApi": {
          "id": "pI4CpdYLTiEEBmnz",
          "name": "Supabase account"
        }
      },
      "continueOnFail": true
    },
    {
      "parameters": {
        "aggregate": "aggregateAllItemData",
        "destinationFieldName": "all_rankings",
        "options": {}
      },
      "type": "n8n-nodes-base.aggregate",
      "typeVersion": 1,
      "position": [
        -8576,
        5584
      ],
      "id": "8462763e-2f3c-49a4-95b1-8388f4031fd8",
      "name": "Aggregate All Rankings"
    },
    {
      "parameters": {
        "jsCode": "// =============================================\n// NODE: Generate Final Ranking with Details (v6 - Fully Dynamic Criteria)\n// Passes individual_scores and category scores as dynamic objects\n// =============================================\n\nconst items = $input.all();\nlet allRankings = [];\n\nitems.forEach(item => {\n    if (item.json.all_rankings) {\n        allRankings = allRankings.concat(item.json.all_rankings);\n    } else if (item.json.ranking) {\n        allRankings.push(item.json);\n    }\n});\n\nconst sortedRankings = allRankings\n    .map(r => ({\n        ranking: r.ranking || r,\n        details: r.details || {},\n        category_scores: r.category_scores || {},\n        individual_scores: r.individual_scores || {},\n        config_type: r.config_type || 'default'\n    }))\n    .sort((a, b) => (b.ranking.overall_score || 0) - (a.ranking.overall_score || 0));\n\nconst finalRanking = sortedRankings.map((r, idx) => {\n    // Build dynamic category scores object\n    const categoryScores = r.ranking.category_scores_json || {};\n    // Also populate legacy fields for backward compatibility\n    const scores = {\n        technical: categoryScores.TECHNICAL || categoryScores.technical || r.ranking.technical_score || 0,\n        economic: categoryScores.ECONOMIC || categoryScores.economic || r.ranking.economic_score || 0,\n        execution: categoryScores.EXECUTION || categoryScores.execution || r.ranking.execution_score || 0,\n        hse_compliance: categoryScores.HSE_COMPLIANCE || categoryScores.hse_compliance || r.ranking.hse_compliance_score || 0\n    };\n    // Add any dynamic categories that aren't in the legacy set\n    for (const [catKey, catScore] of Object.entries(categoryScores)) {\n        const normalizedKey = catKey.toLowerCase();\n        if (!scores[normalizedKey]) {\n            scores[normalizedKey] = catScore;\n        }\n    }\n\n    // Build dynamic individual_scores from JSONB or fallback to legacy fields\n    const dynamicIndividual = r.ranking.individual_scores_json || r.individual_scores || {};\n    // Merge with legacy fixed fields as fallback\n    const individualScores = { ...dynamicIndividual };\n    const legacyFields = [\n        'scope_facilities', 'scope_work', 'deliverables_quality',\n        'total_price', 'price_breakdown', 'optionals_included', 'capex_opex_methodology',\n        'schedule', 'resources_allocation', 'exceptions',\n        'safety_studies', 'regulatory_compliance'\n    ];\n    legacyFields.forEach(f => {\n        if (!(f in individualScores) || !individualScores[f]) {\n            individualScores[f] = r.ranking[f + '_score'] || r.individual_scores?.[f] || 0;\n        }\n    });\n\n    return {\n        position: idx + 1,\n        provider_name: r.ranking.provider_name,\n        overall_score: r.ranking.overall_score,\n        compliance_percentage: r.ranking.compliance_percentage,\n        scores,\n        individual_scores: individualScores,\n        evaluation: {\n            strengths: r.details.strengths || [],\n            weaknesses: r.details.weaknesses || [],\n            recommendations: r.details.recommendations || [],\n            summary: r.details.summary || ''\n        }\n    };\n});\n\nconst configType = sortedRankings[0]?.config_type || 'default';\n\nconst stats = {\n    total_providers: finalRanking.length,\n    average_score: finalRanking.reduce((sum, r) => sum + (r.overall_score || 0), 0) / (finalRanking.length || 1),\n    top_performer: finalRanking[0]?.provider_name || 'N/A',\n    score_range: {\n        min: Math.min(...finalRanking.map(r => r.overall_score || 0)),\n        max: Math.max(...finalRanking.map(r => r.overall_score || 0))\n    },\n    evaluation_date: new Date().toISOString(),\n    config_type: configType\n};\n\nconsole.log(`Final Ranking Generated (${configType} config):`);\nfinalRanking.forEach(r => {\n    console.log(`   ${r.position}. ${r.provider_name}: ${r.overall_score} (${r.compliance_percentage}%)`);\n});\n\nreturn {\n    json: {\n        success: true,\n        ranking: finalRanking,\n        statistics: stats,\n        message: `Scoring completed for ${finalRanking.length} providers using ${configType} criteria configuration`\n    }\n};"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        -8288,
        5584
      ],
      "id": "8fe14604-a6a2-4ca0-bf96-8272875f7805",
      "name": "Generate Final Ranking"
    },
    {
      "parameters": {
        "respondWith": "json",
        "responseBody": "={{ $json }}",
        "options": {
          "responseHeaders": {
            "entries": [
              {
                "name": "Content-Type",
                "value": "application/json"
              }
            ]
          }
        }
      },
      "type": "n8n-nodes-base.respondToWebhook",
      "typeVersion": 1.5,
      "position": [
        -8064,
        5584
      ],
      "id": "15429587-9bdc-45e7-abdf-ec3a7de124f0",
      "name": "Respond with Ranking"
    },
    {
      "parameters": {
        "content": "## Scoring Workflow - Provider Evaluation (v5)\n## Dynamic Criteria Support\n\nThis workflow now supports:\n1. **Default criteria** - 11 hardcoded criteria for engineering proposals\n2. **Dynamic criteria** - Custom criteria loaded from `scoring_configuration_summary` view\n\n### How it works:\n1. Fetches scoring configuration for the project\n2. If configuration exists, uses dynamic criteria and weights\n3. If no configuration, falls back to default criteria\n\n### Default Category Weights:\n- **TECHNICAL COMPLETENESS (30%)**\n- **ECONOMIC COMPETITIVENESS (35%)**\n- **EXECUTION CAPABILITY (20%)**\n- **HSE & COMPLIANCE (15%)**\n\n### Endpoint:\nPOST /webhook/scoring-evaluation\n```json\n{\n  \"project_id\": \"uuid\",\n  \"provider_name\": \"filter\",\n  \"recalculate_all\": false\n}\n```\n\n### Response includes:\n- `config_type`: 'dynamic' or 'default'\n- `ranking`: Sorted provider scores\n- `statistics`: Summary stats",
        "height": 1264,
        "width": 3280
      },
      "type": "n8n-nodes-base.stickyNote",
      "typeVersion": 1,
      "position": [
        -10528,
        5184
      ],
      "id": "e58b8660-ac3a-4af1-945c-cbc6bd3c6a85",
      "name": "Workflow Info"
    },
    {
      "parameters": {
        "content": "## AI Scoring (v5)\n\nEvaluates engineering proposals using:\n- Dynamic OR default criteria\n- Custom weights from database\n- Value-for-money comparison\n- Strengths and weaknesses\n\nStructured JSON output",
        "height": 220,
        "width": 320,
        "color": 6
      },
      "type": "n8n-nodes-base.stickyNote",
      "typeVersion": 1,
      "position": [
        -8672,
        5344
      ],
      "id": "b3ec6a1f-0eba-4c6f-9a2e-95491a7078a5",
      "name": "LLM Scoring Info"
    },
    {
      "parameters": {
        "assignments": {
          "assignments": [
            {
              "id": "project_id",
              "name": "project_id",
              "value": "={{ $('Webhook Scoring').first().json.body.project_id }}",
              "type": "string"
            },
            {
              "id": "provider_filter",
              "name": "provider_filter",
              "value": "={{ $('Webhook Scoring').first().json.body.provider_name || '' }}",
              "type": "string"
            },
            {
              "id": "recalculate_all",
              "name": "recalculate_all",
              "value": "={{ $('Webhook Scoring').first().json.body.recalculate_all || false }}",
              "type": "boolean"
            },
            {
              "id": "language-field-scoring",
              "name": "language",
              "value": "={{ $('Webhook Scoring').first().json.body.language || 'es' }}",
              "type": "string"
            },
            {
              "id": "currency-field-scoring",
              "name": "currency",
              "value": "={{ $('Webhook Scoring').first().json.body.currency || 'EUR' }}",
              "type": "string"
            }
          ]
        },
        "options": {}
      },
      "type": "n8n-nodes-base.set",
      "typeVersion": 3.4,
      "position": [
        -9744,
        5792
      ],
      "id": "24825480-f415-4916-8088-cd2f4ea041ef",
      "name": "Set Input Params1"
    },
    {
      "parameters": {
        "schemaType": "manual",
        "inputSchema": "{\n  \"type\": \"object\",\n  \"properties\": {\n    \"provider_name\": { \"type\": \"string\" },\n    \"category_scores\": {\n      \"type\": \"object\",\n      \"additionalProperties\": {\n        \"type\": \"object\",\n        \"properties\": {\n          \"score\": { \"type\": \"number\" },\n          \"weight\": { \"type\": \"number\" }\n        }\n      }\n    },\n    \"individual_scores\": {\n      \"type\": \"object\",\n      \"additionalProperties\": { \"type\": \"number\" }\n    },\n    \"overall_score\": { \"type\": \"number\" },\n    \"compliance_percentage\": { \"type\": \"number\" },\n    \"evaluation_summary\": { \"type\": \"string\" },\n    \"strengths\": { \"type\": \"array\", \"items\": { \"type\": \"string\" } },\n    \"weaknesses\": { \"type\": \"array\", \"items\": { \"type\": \"string\" } },\n    \"recommendations\": { \"type\": \"array\", \"items\": { \"type\": \"string\" } }\n  },\n  \"required\": [\"provider_name\", \"category_scores\", \"individual_scores\", \"overall_score\", \"compliance_percentage\"]\n}"
      },
      "type": "@n8n/n8n-nodes-langchain.outputParserStructured",
      "typeVersion": 1.3,
      "position": [
        -8432,
        6000
      ],
      "id": "2b10b92a-9561-4ff8-97f7-5e677e1c65a9",
      "name": "JSON Output Parser1"
    },
    {
      "parameters": {
        "model": "qwen3:8b",
        "options": {
          "temperature": 0.1,
          "numCtx": 8192,
          "numPredict": 2048
        }
      },
      "type": "@n8n/n8n-nodes-langchain.lmChatOllama",
      "typeVersion": 1,
      "position": [
        -8688,
        5984
      ],
      "id": "1378f663-6f5b-4555-be9c-257aee74d788",
      "name": "Ollama Scoring Model",
      "credentials": {
        "ollamaApi": {
          "id": "oS2Qqti9oVfsm8XZ",
          "name": "Ollama account"
        }
      }
    },
    {
      "parameters": {
        "useCustomSchema": true,
        "schema": "public",
        "operation": "delete",
        "tableId": "ranking_proveedores",
        "filters": {
          "conditions": [
            {
              "keyName": "project_id",
              "condition": "eq",
              "keyValue": "={{ $('Webhook Scoring').first().json.body.project_id }}"
            }
          ]
        }
      },
      "type": "n8n-nodes-base.supabase",
      "typeVersion": 1,
      "position": [
        -9968,
        5792
      ],
      "id": "fcafedef-6a86-4e1b-8d8a-a78d9f1d8f1c",
      "name": "Delete a row",
      "alwaysOutputData": true,
      "credentials": {
        "supabaseApi": {
          "id": "pI4CpdYLTiEEBmnz",
          "name": "Supabase account"
        }
      }
    },
    {
      "parameters": {
        "options": {}
      },
      "type": "@n8n/n8n-nodes-langchain.lmChatOpenRouter",
      "typeVersion": 1,
      "position": [
        -8592,
        6080
      ],
      "id": "f3d958bd-8a61-4a89-8760-be9c31270f7a",
      "name": "OpenRouter Chat Model1",
      "credentials": {
        "openRouterApi": {
          "id": "4AyUqsh1Z35g6bci",
          "name": "OpenRouter account"
        }
      }
    },
    {
      "parameters": {
        "httpMethod": "POST",
        "path": "scoring-evaluation",
        "responseMode": "responseNode",
        "options": {}
      },
      "type": "n8n-nodes-base.webhook",
      "typeVersion": 2.1,
      "position": [
        -10272,
        5792
      ],
      "id": "3939eff7-14f5-4b97-a2ac-0c85a035c258",
      "name": "Webhook Scoring",
      "webhookId": "scoring-eval-webhook-001"
    },
    {
      "parameters": {
        "useCustomSchema": true,
        "schema": "public",
        "operation": "get",
        "tableId": "projects",
        "filters": {
          "conditions": [
            {
              "keyName": "id",
              "keyValue": "={{ $('Set Input Params1').first().json.project_id }}"
            }
          ]
        }
      },
      "id": "b29e3cd0-2bfb-4906-9a93-46fc82a26481",
      "name": "Fetch Project Context Scoring",
      "type": "n8n-nodes-base.supabase",
      "typeVersion": 1,
      "position": [
        -9488,
        5792
      ],
      "credentials": {
        "supabaseApi": {
          "id": "pI4CpdYLTiEEBmnz",
          "name": "Supabase account"
        }
      }
    }
  ],
  "connections": {
    "Extract Fields": {
      "main": [
        [
          {
            "node": "Validate Data",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Validate Data": {
      "main": [
        [
          {
            "node": "Convert Markdown to HTML",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Respond Error",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Convert Markdown to HTML": {
      "main": [
        [
          {
            "node": "Gmail Send",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Gmail Send": {
      "main": [
        [
          {
            "node": "Respond Success2",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Webhook2": {
      "main": [
        [
          {
            "node": "Extract Fields",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Webhook Receive": {
      "main": [
        [
          {
            "node": "Set Input Params2",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Email Provided?": {
      "main": [
        [
          {
            "node": "Send Email via Gmail",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Split for Update",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Send Email via Gmail": {
      "main": [
        [
          {
            "node": "Split for Update",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Generate Token": {
      "main": [
        [
          {
            "node": "Save Token to DB",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Save Token to DB": {
      "main": [
        [
          {
            "node": "Split Question IDs",
            "type": "main",
            "index": 0
          },
          {
            "node": "Fetch Project Name",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Split Question IDs": {
      "main": [
        [
          {
            "node": "Fetch Questions",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Fetch Questions": {
      "main": [
        [
          {
            "node": "Merge Data",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Fetch Project Name": {
      "main": [
        [
          {
            "node": "Merge Data",
            "type": "main",
            "index": 1
          }
        ]
      ]
    },
    "Merge Data": {
      "main": [
        [
          {
            "node": "Build Email Content",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Build Email Content": {
      "main": [
        [
          {
            "node": "Email Provided?",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Split for Update": {
      "main": [
        [
          {
            "node": "Update Question Status",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Update Question Status": {
      "main": [
        [
          {
            "node": "Respond to Webhook2",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Set Input Params2": {
      "main": [
        [
          {
            "node": "Generate Token",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Validate Token": {
      "main": [
        [
          {
            "node": "Token Valid?",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Token Valid?": {
      "main": [
        [
          {
            "node": "Split Responses",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Respond Invalid",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Split Responses": {
      "main": [
        [
          {
            "node": "Loop Over Items",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Loop Over Items": {
      "main": [
        [
          {
            "node": "Mark Token Responded",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Save Response to QA Audit",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Save Response to QA Audit": {
      "main": [
        [
          {
            "node": "Fetch Question Details",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Fetch Question Details": {
      "main": [
        [
          {
            "node": "Has Requirement?",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Has Requirement?": {
      "main": [
        [
          {
            "node": "Fetch Requirement",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "No Requirement",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Fetch Requirement": {
      "main": [
        [
          {
            "node": "Fetch Current Evaluation",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Fetch Current Evaluation": {
      "main": [
        [
          {
            "node": "LLM Re-evaluate",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "LLM Re-evaluate": {
      "main": [
        [
          {
            "node": "Should Update?",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Should Update?": {
      "main": [
        [
          {
            "node": "Update Provider Response",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Skip Update",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Update Provider Response": {
      "main": [
        [
          {
            "node": "Merge Results",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Skip Update": {
      "main": [
        [
          {
            "node": "Merge Results",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "No Requirement": {
      "main": [
        [
          {
            "node": "Merge Results",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Merge Results": {
      "main": [
        [
          {
            "node": "Loop Over Items",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Mark Token Responded": {
      "main": [
        [
          {
            "node": "Create Notification",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Create Notification": {
      "main": [
        [
          {
            "node": "Respond Success",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Webhook Receive1": {
      "main": [
        [
          {
            "node": "Set Input Params3",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Set Input Params3": {
      "main": [
        [
          {
            "node": "Validate Token",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "JSON Output Parser2": {
      "ai_outputParser": [
        [
          {
            "node": "LLM Re-evaluate",
            "type": "ai_outputParser",
            "index": 0
          }
        ]
      ]
    },
    "Mistral Cloud Chat Model4": {
      "ai_languageModel": [
        [
          {
            "node": "LLM Re-evaluate",
            "type": "ai_languageModel",
            "index": 0
          }
        ]
      ]
    },
    "Webhook QA Email Response": {
      "main": [
        [
          {
            "node": "Set QA Email Params",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Set QA Email Params": {
      "main": [
        [
          {
            "node": "Fetch QA Questions",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Fetch QA Questions": {
      "main": [
        [
          {
            "node": "Build AI Context",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Build AI Context": {
      "main": [
        [
          {
            "node": "QA Email Mapping Chain",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "QA Email Mapping Chain": {
      "main": [
        [
          {
            "node": "Parse QA Email Output",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Mistral QA Email Model": {
      "ai_languageModel": [
        [
          {
            "node": "QA Email Mapping Chain",
            "type": "ai_languageModel",
            "index": 0
          }
        ]
      ]
    },
    "Parse QA Email Output": {
      "main": [
        [
          {
            "node": "Respond QA Email Response",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Webhook1": {
      "main": [
        [
          {
            "node": "Chat AI Agent",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Postgres Chat Memory": {
      "ai_memory": [
        [
          {
            "node": "Chat AI Agent",
            "type": "ai_memory",
            "index": 0
          }
        ]
      ]
    },
    "Embeddings Ollama": {
      "ai_embedding": [
        [
          {
            "node": "Revisar RFQs",
            "type": "ai_embedding",
            "index": 0
          }
        ]
      ]
    },
    "Chat AI Agent": {
      "main": [
        [
          {
            "node": "Respond to Webhook5",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Revisar-ofertas": {
      "ai_tool": [
        [
          {
            "node": "Chat AI Agent",
            "type": "ai_tool",
            "index": 0
          }
        ]
      ]
    },
    "Revisar RFQs": {
      "ai_tool": [
        [
          {
            "node": "Chat AI Agent",
            "type": "ai_tool",
            "index": 0
          }
        ]
      ]
    },
    "Embeddings Ollama5": {
      "ai_embedding": [
        [
          {
            "node": "Revisar-ofertas",
            "type": "ai_embedding",
            "index": 0
          }
        ]
      ]
    },
    "query_requirements": {
      "ai_tool": [
        [
          {
            "node": "Chat AI Agent",
            "type": "ai_tool",
            "index": 0
          }
        ]
      ]
    },
    "query_provider_responses": {
      "ai_tool": [
        [
          {
            "node": "Chat AI Agent",
            "type": "ai_tool",
            "index": 0
          }
        ]
      ]
    },
    "query_ranking": {
      "ai_tool": [
        [
          {
            "node": "Chat AI Agent",
            "type": "ai_tool",
            "index": 0
          }
        ]
      ]
    },
    "query_qa_audit": {
      "ai_tool": [
        [
          {
            "node": "Chat AI Agent",
            "type": "ai_tool",
            "index": 0
          }
        ]
      ]
    },
    "Mistral Cloud Chat Model2": {
      "ai_languageModel": [
        [
          {
            "node": "Chat AI Agent",
            "type": "ai_languageModel",
            "index": 0
          }
        ]
      ]
    },
    "Edit Fields": {
      "main": [
        [
          {
            "node": "Get Offers",
            "type": "main",
            "index": 0
          },
          {
            "node": "Fetch Project Context Email",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Filter and Aggregate Issues": {
      "main": [
        [
          {
            "node": "Basic LLM Chain",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Webhook3": {
      "main": [
        [
          {
            "node": "Edit Fields",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Get Offers": {
      "main": [
        [
          {
            "node": "Filter and Aggregate Issues",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Basic LLM Chain": {
      "main": [
        [
          {
            "node": "Respond to Webhook3",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Mistral Cloud Chat Model1": {
      "ai_languageModel": [
        [
          {
            "node": "Basic LLM Chain",
            "type": "ai_languageModel",
            "index": 0
          }
        ]
      ]
    },
    "Fetch Project Context Email": {
      "main": [
        [
          {
            "node": "Filter and Aggregate Issues",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Get many rows1": {
      "main": [
        [
          {
            "node": "Reset Items",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Embeddings Ollama3": {
      "ai_embedding": [
        [
          {
            "node": "Insert into Supabase Vectorstore",
            "type": "ai_embedding",
            "index": 0
          }
        ]
      ]
    },
    "Validador de Ofertas": {
      "main": [
        [
          {
            "node": "Format for Vectorstore",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Structured Output Parser4": {
      "ai_outputParser": [
        [
          {
            "node": "Validador de Ofertas",
            "type": "ai_outputParser",
            "index": 0
          }
        ]
      ]
    },
    "Clasificador de Tipo de Evaluacion y Proveedor": {
      "main": [
        [
          {
            "node": "Format for Vectorstore",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "If": {
      "main": [
        [
          {
            "node": "Format for Vectorstore",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Format for Vectorstore",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Loop Over Phases": {
      "main": [
        [
          {
            "node": "Loop Over Items1",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Preparar Todo para LLM1",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Parsear y Preparar Update": {
      "main": [
        [
          {
            "node": "Insert or update rows in a table",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "LLM Chain": {
      "main": [
        [
          {
            "node": "Parsear y Preparar Update",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Insert Document Metadata": {
      "main": [
        [
          {
            "node": "Base64 a Binary",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Delete Old Doc Rows": {
      "main": [
        [
          {
            "node": "Insert Document Metadata",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Set File ID": {
      "main": [
        [
          {
            "node": "Delete Old Doc Rows",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Default Data Loader": {
      "ai_document": [
        [
          {
            "node": "Insert into Supabase Vectorstore",
            "type": "ai_document",
            "index": 0
          }
        ]
      ]
    },
    "Recursive Character Text Splitter": {
      "ai_textSplitter": [
        [
          {
            "node": "Default Data Loader",
            "type": "ai_textSplitter",
            "index": 0
          }
        ]
      ]
    },
    "Insert into Supabase Vectorstore": {
      "main": [
        [
          {
            "node": "Expandir por Tipo de EvaluaciÃ³n",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Validar Contenido PDF": {
      "main": [
        [
          {
            "node": "Â¿Necesita OCR?",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Extract from File": {
      "main": [
        [
          {
            "node": "Validar Contenido PDF",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Â¿Necesita OCR?": {
      "main": [
        [
          {
            "node": "Base64 a Binary1",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Merge1",
            "type": "main",
            "index": 1
          }
        ]
      ]
    },
    "Aggregate OCR Pages": {
      "main": [
        [
          {
            "node": "Merge1",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Preparar Texto de Muestra": {
      "main": [
        [
          {
            "node": "Format for Vectorstore",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Format for Vectorstore": {
      "main": [
        [
          {
            "node": "Insert into Supabase Vectorstore",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Expandir por Tipo de EvaluaciÃ³n": {
      "main": [
        [
          {
            "node": "Loop Over Items1",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Loop Over Items1": {
      "main": [
        [
          {
            "node": "Respond to Webhook",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Get many rows1",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Docling OCR": {
      "main": [
        [
          {
            "node": "Aggregate OCR Pages",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Structured Output Parser": {
      "ai_outputParser": [
        [
          {
            "node": "Clasificador de Tipo de Evaluacion y Proveedor",
            "type": "ai_outputParser",
            "index": 0
          }
        ]
      ]
    },
    "Merge1": {
      "main": [
        [
          {
            "node": "Has Economic Evaluation?",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Reset Items": {
      "main": [
        [
          {
            "node": "Loop Over Phases",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Webhook": {
      "main": [
        [
          {
            "node": "Code in JavaScript1",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Base64 a Binary": {
      "main": [
        [
          {
            "node": "Extract from File",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Base64 a Binary1": {
      "main": [
        [
          {
            "node": "Docling OCR",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Code in JavaScript1": {
      "main": [
        [
          {
            "node": "Set File ID",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Insert or update rows in a table": {
      "main": [
        [
          {
            "node": "Loop Over Phases",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Preparar Todo para LLM1": {
      "main": [
        [
          {
            "node": "LLM Chain",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Mistral Cloud Chat Model3": {
      "ai_languageModel": [
        [
          {
            "node": "LLM Chain",
            "type": "ai_languageModel",
            "index": 0
          }
        ]
      ]
    },
    "Mistral Cloud Chat Model5": {
      "ai_languageModel": [
        [
          {
            "node": "Validador de Ofertas",
            "type": "ai_languageModel",
            "index": 0
          }
        ]
      ]
    },
    "Mistral Cloud Chat Model6": {
      "ai_languageModel": [
        [
          {
            "node": "Clasificador de Tipo de Evaluacion y Proveedor",
            "type": "ai_languageModel",
            "index": 0
          }
        ]
      ]
    },
    "Has Economic Evaluation?": {
      "main": [
        [
          {
            "node": "Check If Economic Offer",
            "type": "main",
            "index": 0
          },
          {
            "node": "Preparar Texto de Muestra",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Preparar Texto de Muestra",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Check If Economic Offer": {
      "main": [
        [
          {
            "node": "Extract Economic Data",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Extract Economic Data": {
      "main": [
        [
          {
            "node": "Parse Economic JSON",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Mistral Economic Model": {
      "ai_languageModel": [
        [
          {
            "node": "Extract Economic Data",
            "type": "ai_languageModel",
            "index": 0
          }
        ]
      ]
    },
    "Parse Economic JSON": {
      "main": [
        [
          {
            "node": "Save Economic Offer",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Webhook Inbound": {
      "main": [
        [
          {
            "node": "Set Input Params",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Set Input Params": {
      "main": [
        [
          {
            "node": "Fetch Project Context QA",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Fetch All Provider Responses": {
      "main": [
        [
          {
            "node": "Filter Deficiencies Only",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Filter Deficiencies Only": {
      "main": [
        [
          {
            "node": "Fetch Requirement Specs",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Fetch Requirement Specs": {
      "main": [
        [
          {
            "node": "Consolidate Deficiencies",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Consolidate Deficiencies": {
      "main": [
        [
          {
            "node": "QA Generation Chain",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "QA Generation Chain": {
      "main": [
        [
          {
            "node": "Split Questions List",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "JSON Output Parser": {
      "ai_outputParser": [
        [
          {
            "node": "QA Generation Chain",
            "type": "ai_outputParser",
            "index": 0
          }
        ]
      ]
    },
    "Split Questions List": {
      "main": [
        [
          {
            "node": "Supabase Insert",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Supabase Insert": {
      "main": [
        [
          {
            "node": "Extract Disciplines",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Extract Disciplines": {
      "main": [
        [
          {
            "node": "Save Project Disciplines",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Save Project Disciplines": {
      "main": [
        [
          {
            "node": "Respond to Webhook1",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Mistral Cloud Chat Model": {
      "ai_languageModel": [
        [
          {
            "node": "QA Generation Chain",
            "type": "ai_languageModel",
            "index": 0
          }
        ]
      ]
    },
    "Fetch Project Context QA": {
      "main": [
        [
          {
            "node": "Fetch All Provider Responses",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Webhook RFQ": {
      "main": [
        [
          {
            "node": "Generate IDs1",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Preparar Texto1": {
      "main": [
        [
          {
            "node": "Clasificador de Tipos1",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Clasificador de Tipos1": {
      "main": [
        [
          {
            "node": "Insert Document Metadata2",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Output Parser1": {
      "ai_outputParser": [
        [
          {
            "node": "Clasificador de Tipos1",
            "type": "ai_outputParser",
            "index": 0
          }
        ]
      ]
    },
    "Expandir por Tipo1": {
      "main": [
        [
          {
            "node": "Loop por Tipo1",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Loop por Tipo1": {
      "main": [
        [
          {
            "node": "Resumen Final1",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Dividir en Trozos1",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Parsear Items1": {
      "main": [
        [
          {
            "node": "Create a row",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Agregar Resultados1": {
      "main": [
        [
          {
            "node": "Loop por Trozo1",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Resumen Final1": {
      "main": [
        [
          {
            "node": "Respond Success1",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Base64 a Binary3": {
      "main": [
        [
          {
            "node": "Extract from File3",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Extract from File3": {
      "main": [
        [
          {
            "node": "Preparar Texto1",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Generate IDs1": {
      "main": [
        [
          {
            "node": "Delete Old Doc Rows1",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Switch1": {
      "main": [
        [
          {
            "node": "LLM Extractor Tech-Econ",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "LLM Extractor - Deliverables",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "LLM Extractor - Deliverables": {
      "main": [
        [
          {
            "node": "Parsear deliverables",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Parsear deliverables": {
      "main": [
        [
          {
            "node": "Create a row",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Dividir en Trozos1": {
      "main": [
        [
          {
            "node": "Reset Items1",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Loop por Trozo1": {
      "main": [
        [
          {
            "node": "Loop por Tipo1",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Switch1",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Reset Items1": {
      "main": [
        [
          {
            "node": "Loop por Trozo1",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Embeddings Ollama1": {
      "ai_embedding": [
        [
          {
            "node": "Insert into Supabase Vectorstore1",
            "type": "ai_embedding",
            "index": 0
          }
        ]
      ]
    },
    "Insert into Supabase Vectorstore1": {
      "main": [
        [
          {
            "node": "Expandir por Tipo1",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Recursive Character Text Splitter1": {
      "ai_textSplitter": [
        [
          {
            "node": "Default Data Loader1",
            "type": "ai_textSplitter",
            "index": 0
          }
        ]
      ]
    },
    "Default Data Loader1": {
      "ai_document": [
        [
          {
            "node": "Insert into Supabase Vectorstore1",
            "type": "ai_document",
            "index": 0
          }
        ]
      ]
    },
    "Create a row": {
      "main": [
        [
          {
            "node": "Agregar Resultados1",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Delete Old Doc Rows1": {
      "main": [
        [
          {
            "node": "Base64 a Binary3",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Insert Document Metadata2": {
      "main": [
        [
          {
            "node": "Insert into Supabase Vectorstore1",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "LLM Extractor Tech-Econ": {
      "main": [
        [
          {
            "node": "Parsear Items1",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Mistral Cloud Chat Model7": {
      "ai_languageModel": [
        [
          {
            "node": "LLM Extractor Tech-Econ",
            "type": "ai_languageModel",
            "index": 0
          }
        ]
      ]
    },
    "Mistral Cloud Chat Model8": {
      "ai_languageModel": [
        [
          {
            "node": "LLM Extractor - Deliverables",
            "type": "ai_languageModel",
            "index": 0
          }
        ]
      ]
    },
    "Mistral Cloud Chat Model9": {
      "ai_languageModel": [
        [
          {
            "node": "Clasificador de Tipos1",
            "type": "ai_languageModel",
            "index": 0
          }
        ]
      ]
    },
    "Webhook RFP Generate": {
      "main": [
        [
          {
            "node": "Set RFP Params",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Set RFP Params": {
      "main": [
        [
          {
            "node": "RFP Generation Chain",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "RFP Generation Chain": {
      "main": [
        [
          {
            "node": "Parse RFP Output",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Mistral RFP Model": {
      "ai_languageModel": [
        [
          {
            "node": "RFP Generation Chain",
            "type": "ai_languageModel",
            "index": 0
          }
        ]
      ]
    },
    "Parse RFP Output": {
      "main": [
        [
          {
            "node": "Respond RFP Generate",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Fetch Requirements": {
      "main": [
        [
          {
            "node": "Merge Requirements & Responses",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Fetch Provider Responses": {
      "main": [
        [
          {
            "node": "Merge Requirements & Responses",
            "type": "main",
            "index": 1
          }
        ]
      ]
    },
    "Fetch Scoring Configuration": {
      "main": [
        [
          {
            "node": "Merge Requirements & Responses",
            "type": "main",
            "index": 2
          }
        ]
      ]
    },
    "Fetch Economic Offers": {
      "main": [
        [
          {
            "node": "Merge Requirements & Responses",
            "type": "main",
            "index": 3
          }
        ]
      ]
    },
    "Merge Requirements & Responses": {
      "main": [
        [
          {
            "node": "Prepare Scoring Data",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Prepare Scoring Data": {
      "main": [
        [
          {
            "node": "Loop Over Providers",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Loop Over Providers": {
      "main": [
        [
          {
            "node": "Aggregate All Rankings",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Scoring LLM Chain",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Scoring LLM Chain": {
      "main": [
        [
          {
            "node": "Calculate Weighted Scores",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Calculate Weighted Scores": {
      "main": [
        [
          {
            "node": "Check Provider Exists",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Check Provider Exists": {
      "main": [
        [
          {
            "node": "Insert Ranking",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Provider Exists?": {
      "main": [
        [
          {
            "node": "Update Ranking",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Insert Ranking",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Update Ranking": {
      "main": [
        [
          {
            "node": "Loop Over Providers",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Insert Ranking": {
      "main": [
        [
          {
            "node": "Loop Over Providers",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Aggregate All Rankings": {
      "main": [
        [
          {
            "node": "Generate Final Ranking",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Generate Final Ranking": {
      "main": [
        [
          {
            "node": "Respond with Ranking",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Set Input Params1": {
      "main": [
        [
          {
            "node": "Fetch Project Context Scoring",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "JSON Output Parser1": {
      "ai_outputParser": [
        [
          {
            "node": "Scoring LLM Chain",
            "type": "ai_outputParser",
            "index": 0
          }
        ]
      ]
    },
    "Delete a row": {
      "main": [
        [
          {
            "node": "Set Input Params1",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "OpenRouter Chat Model1": {
      "ai_languageModel": [
        [
          {
            "node": "Scoring LLM Chain",
            "type": "ai_languageModel",
            "index": 0
          }
        ]
      ]
    },
    "Webhook Scoring": {
      "main": [
        [
          {
            "node": "Delete a row",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Fetch Project Context Scoring": {
      "main": [
        [
          {
            "node": "Fetch Requirements",
            "type": "main",
            "index": 0
          },
          {
            "node": "Fetch Provider Responses",
            "type": "main",
            "index": 0
          },
          {
            "node": "Fetch Scoring Configuration",
            "type": "main",
            "index": 0
          },
          {
            "node": "Fetch Economic Offers",
            "type": "main",
            "index": 0
          }
        ]
      ]
    }
  },
  "pinData": {
    "Webhook": [
      {
        "headers": {
          "host": "n8n.beaienergy.com",
          "user-agent": "Mozilla/5.0 (Macintosh; Intel Mac OS X 10_15_7) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/144.0.0.0 Safari/537.36",
          "content-length": "23892",
          "accept": "*/*",
          "accept-encoding": "gzip, deflate, br, zstd",
          "accept-language": "es-ES,es;q=0.9",
          "content-type": "application/json",
          "origin": "http://localhost:9102",
          "referer": "http://localhost:9102/",
          "sec-ch-ua": "\"Not(A:Brand\";v=\"8\", \"Chromium\";v=\"144\", \"Google Chrome\";v=\"144\"",
          "sec-ch-ua-mobile": "?0",
          "sec-ch-ua-platform": "\"macOS\"",
          "sec-fetch-dest": "empty",
          "sec-fetch-mode": "cors",
          "sec-fetch-site": "same-origin",
          "x-forwarded-for": "92.187.62.136",
          "x-forwarded-host": "n8n.beaienergy.com",
          "x-forwarded-port": "443",
          "x-forwarded-proto": "https",
          "x-forwarded-server": "0a67c8c4e180",
          "x-real-ip": "92.187.62.136"
        },
        "params": {},
        "query": {},
        "body": {
          "file_id": "rfq-1770822363670-tr6npw211",
          "file_title": "Oferta_Tecnica.pdf",
          "file_url": "",
          "file_binary": "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eXBlIC9Gb250Cj4+CmVuZG9iagoyOCAwIG9iago8PAovRm9udCA8PC9GMSAyNSAwIFIKL0YyIDI2IDAgUgovRjMgMjcgMCBSPj4KL1Byb2NTZXQgWy9QREYgL1RleHQgL0ltYWdlQiAvSW1hZ2VDIC9JbWFnZUldCj4+CmVuZG9iagoyOSAwIG9iago8PAovRm9udCA8PC9GMSAyNSAwIFIKL0YyIDI2IDAgUgovRjMgMjcgMCBSPj4KL1Byb2NTZXQgWy9QREYgL1RleHQgL0ltYWdlQiAvSW1hZ2VDIC9JbWFnZUldCj4+CmVuZG9iagozMCAwIG9iago8PAovRm9udCA8PC9GMSAyNSAwIFIKL0YyIDI2IDAgUgovRjMgMjcgMCBSPj4KL1Byb2NTZXQgWy9QREYgL1RleHQgL0ltYWdlQiAvSW1hZ2VDIC9JbWFnZUldCj4+CmVuZG9iagozMSAwIG9iago8PAovRm9udCA8PC9GMSAyNSAwIFIKL0YyIDI2IDAgUgovRjMgMjcgMCBSPj4KL1Byb2NTZXQgWy9QREYgL1RleHQgL0ltYWdlQiAvSW1hZ2VDIC9JbWFnZUldCj4+CmVuZG9iagozMiAwIG9iago8PAovRm9udCA8PC9GMSAyNSAwIFIKL0YyIDI2IDAgUgovRjMgMjcgMCBSPj4KL1Byb2NTZXQgWy9QREYgL1RleHQgL0ltYWdlQiAvSW1hZ2VDIC9JbWFnZUldCj4+CmVuZG9iagozMyAwIG9iago8PAovRm9udCA8PC9GMSAyNSAwIFIKL0YyIDI2IDAgUgovRjMgMjcgMCBSPj4KL1Byb2NTZXQgWy9QREYgL1RleHQgL0ltYWdlQiAvSW1hZ2VDIC9JbWFnZUldCj4+CmVuZG9iagozNCAwIG9iago8PAovRm9udCA8PC9GMSAyNSAwIFIKL0YyIDI2IDAgUgovRjMgMjcgMCBSPj4KL1Byb2NTZXQgWy9QREYgL1RleHQgL0ltYWdlQiAvSW1hZ2VDIC9JbWFnZUldCj4+CmVuZG9iagozNSAwIG9iago8PAovRm9udCA8PC9GMSAyNSAwIFIKL0YyIDI2IDAgUgovRjMgMjcgMCBSPj4KL1Byb2NTZXQgWy9QREYgL1RleHQgL0ltYWdlQiAvSW1hZ2VDIC9JbWFnZUldCj4+CmVuZG9iagozNiAwIG9iago8PAovRm9udCA8PC9GMSAyNSAwIFIKL0YyIDI2IDAgUgovRjMgMjcgMCBSPj4KL1Byb2NTZXQgWy9QREYgL1RleHQgL0ltYWdlQiAvSW1hZ2VDIC9JbWFnZUldCj4+CmVuZG9iagozNyAwIG9iago8PAovRm9udCA8PC9GMSAyNSAwIFIKL0YyIDI2IDAgUgovRjMgMjcgMCBSPj4KL1Byb2NTZXQgWy9QREYgL1RleHQgL0ltYWdlQiAvSW1hZ2VDIC9JbWFnZUldCj4+CmVuZG9iagozOCAwIG9iago8PAovRm9udCA8PC9GMSAyNSAwIFIKL0YyIDI2IDAgUgovRjMgMjcgMCBSPj4KL1Byb2NTZXQgWy9QREYgL1RleHQgL0ltYWdlQiAvSW1hZ2VDIC9JbWFnZUldCj4+CmVuZG9iagozOSAwIG9iago8PAovQ3JlYXRpb25EYXRlIChEOjIwMjYwMjEwMjE0MjIxWikKPj4KZW5kb2JqCnhyZWYKMCA0MAowMDAwMDAwMDAwIDY1NTM1IGYgCjAwMDAwMDAwMDkgMDAwMDAgbiAKMDAwMDAwMDE2NCAwMDAwMCBuIAowMDAwMDAwMjY3IDAwMDAwIG4gCjAwMDAwMDAzNDggMDAwMDAgbiAKMDAwMDAwMDkzOCAwMDAwMCBuIAowMDAwMDAxMDE5IDAwMDAwIG4gCjAwMDAwMDIxNzMgMDAwMDAgbiAKMDAwMDAwMjI1NCAwMDAwMCBuIAowMDAwMDAzNDM1IDAwMDAwIG4gCjAwMDAwMDM1MTcgMDAwMDAgbiAKMDAwMDAwNDU2MCAwMDAwMCBuIAowMDAwMDA0NjQzIDAwMDAwIG4gCjAwMDAwMDU2MDIgMDAwMDAgbiAKMDAwMDAwNTY4NSAwMDAwMCBuIAowMDAwMDA3NTY5IDAwMDAwIG4gCjAwMDAwMDc2NTIgMDAwMDAgbiAKMDAwMDAwODgxNyAwMDAwMCBuIAowMDAwMDA4OTAwIDAwMDAwIG4gCjAwMDAwMTA0NTMgMDAwMDAgbiAKMDAwMDAxMDUzNiAwMDAwMCBuIAowMDAwMDEyMjQ3IDAwMDAwIG4gCjAwMDAwMTIzMzAgMDAwMDAgbiAKMDAwMDAxMzc1MCAwMDAwMCBuIAowMDAwMDEzODMzIDAwMDAwIG4gCjAwMDAwMTUwMTMgMDAwMDAgbiAKMDAwMDAxNTExNiAwMDAwMCBuIAowMDAwMDE1MjE0IDAwMDAwIG4gCjAwMDAwMTUzMjAgMDAwMDAgbiAKMDAwMDAxNTQzMSAwMDAwMCBuIAowMDAwMDE1NTQyIDAwMDAwIG4gCjAwMDAwMTU2NTMgMDAwMDAgbiAKMDAwMDAxNTc2NCAwMDAwMCBuIAowMDAwMDE1ODc1IDAwMDAwIG4gCjAwMDAwMTU5ODYgMDAwMDAgbiAKMDAwMDAxNjA5NyAwMDAwMCBuIAowMDAwMDE2MjA4IDAwMDAwIG4gCjAwMDAwMTYzMTkgMDAwMDAgbiAKMDAwMDAxNjQzMCAwMDAwMCBuIAowMDAwMDE2NTQxIDAwMDAwIG4gCnRyYWlsZXIKPDwKL1NpemUgNDAKL1Jvb3QgMiAwIFIKL0luZm8gMzkgMCBSCi9JRCBbPEZEMEFBOEIyRUM0QUU2ODI4Q0E0Q0ZCNkRFOUY2NjM4PjxGRDBBQThCMkVDNEFFNjgyOENBNENGQjZERTlGNjYzOD5dCj4+CnN0YXJ0eHJlZgoxNjU5NwolJUVPRgo=",
          "project_id": "cfbb3a8d-6262-47b0-bda4-6d5c6475d4d6",
          "metadata": {
            "uploadedAt": "2026-02-11T15:06:03.673Z",
            "fileName": "Oferta_Tecnica.pdf",
            "fileSize": 17552,
            "fileId": "rfq-1770822363670-tr6npw211",
            "project_id": "cfbb3a8d-6262-47b0-bda4-6d5c6475d4d6",
            "proyecto": "RenovaciÃ³n Centro de Datos - Madrid",
            "proveedor": "GLOBAL PROCESS ENGINEERING LTD",
            "tipoEvaluacion": [
              "Technical Evaluation"
            ]
          }
        },
        "webhookUrl": "https://n8n.beaienergy.com/webhook/ofertas",
        "executionMode": "production"
      }
    ]
  },
  "meta": {
    "templateCredsSetupCompleted": true,
    "instanceId": "53140335eaf11280ef77ef2f5a378f48c2b28e822e3e0d96563cdd92175c0eff"
  }
}