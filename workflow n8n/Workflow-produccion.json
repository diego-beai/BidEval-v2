{
  "nodes": [
    {
      "parameters": {
        "assignments": {
          "assignments": [
            {
              "id": "to-field",
              "name": "to",
              "value": "={{ $json.body.to }}",
              "type": "string"
            },
            {
              "id": "subject-field",
              "name": "subject",
              "value": "={{ $json.body.subject }}",
              "type": "string"
            },
            {
              "id": "body-field",
              "name": "email_body",
              "value": "={{ $json.body.body }}",
              "type": "string"
            },
            {
              "id": "provider-field",
              "name": "provider_name",
              "value": "={{ $json.body.provider_name }}",
              "type": "string"
            },
            {
              "id": "project-id-field",
              "name": "project_id",
              "value": "={{ $json.body.project_id }}",
              "type": "string"
            },
            {
              "id": "project-name-field",
              "name": "project_name",
              "value": "={{ $json.body.project_name }}",
              "type": "string"
            }
          ]
        },
        "options": {}
      },
      "type": "n8n-nodes-base.set",
      "typeVersion": 3.4,
      "position": [
        -6720,
        5120
      ],
      "id": "a889b394-0627-4bc2-b6ef-10c30bae3c65",
      "name": "Extract Fields"
    },
    {
      "parameters": {
        "conditions": {
          "options": {
            "caseSensitive": true,
            "leftValue": "",
            "typeValidation": "strict",
            "version": 2
          },
          "conditions": [
            {
              "id": "check-to-email",
              "leftValue": "={{ $json.to }}",
              "rightValue": "",
              "operator": {
                "type": "string",
                "operation": "notEmpty"
              }
            },
            {
              "id": "check-subject",
              "leftValue": "={{ $json.subject }}",
              "rightValue": "",
              "operator": {
                "type": "string",
                "operation": "notEmpty"
              }
            },
            {
              "id": "check-body",
              "leftValue": "={{ $json.email_body }}",
              "rightValue": "",
              "operator": {
                "type": "string",
                "operation": "notEmpty"
              }
            }
          ],
          "combinator": "and"
        },
        "options": {}
      },
      "type": "n8n-nodes-base.if",
      "typeVersion": 2.2,
      "position": [
        -6496,
        5120
      ],
      "id": "5bbfc522-c1a8-48e2-8f09-fae681726be7",
      "name": "Validate Data"
    },
    {
      "parameters": {
        "jsCode": "// Convert markdown body to HTML for email\nconst markdownBody = $('Extract Fields').first().json.email_body;\n\n// Simple markdown to HTML conversion\nlet htmlBody = markdownBody\n  // Convert bold\n  .replace(/\\*\\*(.+?)\\*\\*/g, '<strong>$1</strong>')\n  // Convert italic\n  .replace(/\\*(.+?)\\*/g, '<em>$1</em>')\n  // Convert bullet points\n  .replace(/^- (.+)$/gm, '<li>$1</li>')\n  // Wrap lists\n  .replace(/(<li>.*<\\/li>\\n?)+/g, '<ul>$&</ul>')\n  // Convert line breaks to paragraphs\n  .split('\\n\\n')\n  .map(p => p.trim())\n  .filter(p => p.length > 0)\n  .map(p => {\n    if (p.startsWith('<ul>') || p.startsWith('<li>')) return p;\n    return `<p>${p}</p>`;\n  })\n  .join('\\n');\n\n// Add email styling\nconst styledHtml = `\n<!DOCTYPE html>\n<html>\n<head>\n  <style>\n    body { font-family: Arial, sans-serif; line-height: 1.6; color: #333; max-width: 800px; margin: 0 auto; padding: 20px; }\n    p { margin: 0 0 16px 0; }\n    ul { margin: 0 0 16px 0; padding-left: 24px; }\n    li { margin: 4px 0; }\n    strong { font-weight: 600; }\n  </style>\n</head>\n<body>\n${htmlBody}\n</body>\n</html>\n`;\n\nreturn {\n  html_body: styledHtml,\n  to: $('Extract Fields').first().json.to,\n  subject: $('Extract Fields').first().json.subject,\n  provider_name: $('Extract Fields').first().json.provider_name,\n  project_id: $('Extract Fields').first().json.project_id,\n  project_name: $('Extract Fields').first().json.project_name\n};"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        -6272,
        5008
      ],
      "id": "02630d8a-1222-4bf7-80ec-e3becc68733c",
      "name": "Convert Markdown to HTML"
    },
    {
      "parameters": {
        "sendTo": "={{ $json.to }}",
        "subject": "={{ $json.subject }}",
        "message": "={{ $json.html_body }}",
        "options": {
          "appendAttribution": false
        }
      },
      "type": "n8n-nodes-base.gmail",
      "typeVersion": 2.1,
      "position": [
        -6064,
        5008
      ],
      "id": "de7f8272-a0b2-4df7-8d17-920fe11b8460",
      "name": "Gmail Send",
      "webhookId": "f32bcbf1-73d7-463b-b209-b7e114249ee9",
      "disabled": true
    },
    {
      "parameters": {
        "respondWith": "json",
        "responseBody": "={{ JSON.stringify({ success: false, error: 'Missing required fields: to, subject, or body' }) }}",
        "options": {
          "responseCode": 400
        }
      },
      "type": "n8n-nodes-base.respondToWebhook",
      "typeVersion": 1.5,
      "position": [
        -6272,
        5216
      ],
      "id": "adc219e4-0d1c-474b-9c98-7810d98d3dfe",
      "name": "Respond Error"
    },
    {
      "parameters": {
        "content": "## QA Send Email Workflow\n\nThis workflow receives email data from the Mail Dashboard and sends it via Gmail.\n\n**Expected POST body:**\n```json\n{\n  \"to\": \"recipient@email.com\",\n  \"subject\": \"Email Subject\",\n  \"body\": \"Email body in Markdown format\",\n  \"provider_name\": \"Provider Name\",\n  \"project_id\": \"project-uuid\",\n  \"project_name\": \"Project Name\"\n}\n```\n\n**IMPORTANT:** Configure Gmail OAuth2 credentials in the Gmail node.",
        "height": 724,
        "width": 1788,
        "color": 6
      },
      "type": "n8n-nodes-base.stickyNote",
      "typeVersion": 1,
      "position": [
        -7248,
        4656
      ],
      "id": "22e1eb7b-7f83-417f-b9fa-5f98a5d94cc6",
      "name": "Instructions"
    },
    {
      "parameters": {
        "httpMethod": "POST",
        "path": "qa-send-email",
        "responseMode": "responseNode",
        "options": {}
      },
      "type": "n8n-nodes-base.webhook",
      "typeVersion": 2.1,
      "position": [
        -6944,
        5120
      ],
      "id": "74c7e7df-c8f3-4f9a-8be0-56f393384e92",
      "name": "Webhook2",
      "webhookId": "qa-send-email-webhook"
    },
    {
      "parameters": {
        "respondWith": "json",
        "responseBody": "={{ JSON.stringify({ success: true, message: 'Email sent successfully', to: $json.to, subject: $json.subject }) }}",
        "options": {
          "responseCode": 200
        }
      },
      "type": "n8n-nodes-base.respondToWebhook",
      "typeVersion": 1.5,
      "position": [
        -5840,
        5008
      ],
      "id": "cfb53b8a-09a0-4560-8524-1ce59ab4655b",
      "name": "Respond Success2"
    },
    {
      "parameters": {
        "httpMethod": "POST",
        "path": "qa-send-to-supplier",
        "responseMode": "responseNode",
        "options": {}
      },
      "type": "n8n-nodes-base.webhook",
      "typeVersion": 2.1,
      "position": [
        -4736,
        6288
      ],
      "id": "e1278189-f426-4ec9-9657-1f76ff996055",
      "name": "Webhook Receive",
      "webhookId": "qa-send-to-supplier-webhook"
    },
    {
      "parameters": {
        "conditions": {
          "options": {
            "caseSensitive": true,
            "leftValue": "",
            "typeValidation": "strict"
          },
          "conditions": [
            {
              "id": "check-email",
              "leftValue": "={{ $json.email_to }}",
              "rightValue": "",
              "operator": {
                "type": "string",
                "operation": "notEmpty"
              }
            }
          ],
          "combinator": "and"
        },
        "options": {}
      },
      "type": "n8n-nodes-base.if",
      "typeVersion": 2.1,
      "position": [
        -2944,
        6288
      ],
      "id": "dda7aebd-f00e-418c-bbb9-bf5bf7177204",
      "name": "Email Provided?"
    },
    {
      "parameters": {
        "sendTo": "={{ $json.email_to }}",
        "subject": "={{ $json.email_subject }}",
        "message": "={{ $json.email_html }}",
        "options": {
          "senderName": "BidEval Team"
        }
      },
      "type": "n8n-nodes-base.gmail",
      "typeVersion": 2.1,
      "position": [
        -2720,
        6224
      ],
      "id": "fae250bd-78ca-40a3-9270-2a0329f34017",
      "name": "Send Email via Gmail",
      "webhookId": "9be31203-685f-4b78-a56d-e950bca3a806",
      "disabled": true
    },
    {
      "parameters": {
        "jsCode": "// Generate a random token without crypto module\nfunction generateToken(length = 64) {\n  const chars = 'abcdef0123456789';\n  let token = '';\n  for (let i = 0; i < length; i++) {\n    token += chars.charAt(Math.floor(Math.random() * chars.length));\n  }\n  // Add timestamp for uniqueness\n  const timestamp = Date.now().toString(16);\n  return (timestamp + token).slice(0, 64);\n}\n\nconst token = generateToken();\n\n// Calculate expiration date\nconst expiresDays = $input.first().json.expires_days || 7;\nconst expiresAt = new Date();\nexpiresAt.setDate(expiresAt.getDate() + expiresDays);\n\nreturn {\n  json: {\n    ...$input.first().json,\n    token: token,\n    expires_at: expiresAt.toISOString()\n  }\n};"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        -4288,
        6288
      ],
      "id": "ac9745b3-5695-482f-acbc-f117f5c9e054",
      "name": "Generate Token"
    },
    {
      "parameters": {
        "useCustomSchema": true,
        "tableId": "qa_response_tokens",
        "fieldsUi": {
          "fieldValues": [
            {
              "fieldId": "project_id",
              "fieldValue": "={{ $json.project_id }}"
            },
            {
              "fieldId": "token",
              "fieldValue": "={{ $json.token }}"
            },
            {
              "fieldId": "provider_name",
              "fieldValue": "={{ $json.provider_name }}"
            },
            {
              "fieldId": "question_ids",
              "fieldValue": "={{ $json.question_ids }}"
            },
            {
              "fieldId": "expires_at",
              "fieldValue": "={{ $json.expires_at }}"
            }
          ]
        }
      },
      "type": "n8n-nodes-base.supabase",
      "typeVersion": 1,
      "position": [
        -4064,
        6288
      ],
      "id": "e2774fd8-7a73-4f2f-8807-9919c27b41ea",
      "name": "Save Token to DB",
      "credentials": {
        "supabaseApi": {
          "id": "pI4CpdYLTiEEBmnz",
          "name": "Supabase account"
        }
      }
    },
    {
      "parameters": {
        "jsCode": "// Split question_ids array into individual items\nconst questionIds = $(\"Set Input Params2\").first().json.question_ids || [];\n\n// Return each ID as a separate item\nreturn questionIds.map(id => ({\n  json: {\n    question_id: id\n  }\n}));"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        -3840,
        6192
      ],
      "id": "427d7fa4-990b-4021-b041-785b4b8b1a68",
      "name": "Split Question IDs"
    },
    {
      "parameters": {
        "useCustomSchema": true,
        "operation": "getAll",
        "tableId": "qa_audit",
        "limit": 1,
        "filters": {
          "conditions": [
            {
              "keyName": "id",
              "condition": "eq",
              "keyValue": "={{ $json.question_id }}"
            }
          ]
        }
      },
      "type": "n8n-nodes-base.supabase",
      "typeVersion": 1,
      "position": [
        -3616,
        6192
      ],
      "id": "6fb23413-b824-4741-92a2-1b09233bc8b7",
      "name": "Fetch Questions",
      "credentials": {
        "supabaseApi": {
          "id": "pI4CpdYLTiEEBmnz",
          "name": "Supabase account"
        }
      }
    },
    {
      "parameters": {
        "useCustomSchema": true,
        "operation": "getAll",
        "tableId": "projects",
        "limit": 1,
        "filters": {
          "conditions": [
            {
              "keyName": "id",
              "condition": "eq",
              "keyValue": "={{ $(\"Set Input Params2\").first().json.project_id }}"
            }
          ]
        }
      },
      "type": "n8n-nodes-base.supabase",
      "typeVersion": 1,
      "position": [
        -3616,
        6384
      ],
      "id": "387c90e7-b159-4d8b-90dd-4b26eae62ba7",
      "name": "Fetch Project Name",
      "credentials": {
        "supabaseApi": {
          "id": "pI4CpdYLTiEEBmnz",
          "name": "Supabase account"
        }
      }
    },
    {
      "parameters": {
        "mode": "combine",
        "combineBy": "combineAll",
        "options": {}
      },
      "type": "n8n-nodes-base.merge",
      "typeVersion": 3,
      "position": [
        -3392,
        6288
      ],
      "id": "cde2624d-1a4a-492a-a05a-97feafed5f5f",
      "name": "Merge Data"
    },
    {
      "parameters": {
        "jsCode": "const items = $input.all();\nconst inputParams = $(\"Generate Token\").first().json;\nconst projectData = items.find(i => i.json.display_name)?.json || {};\nconst questions = items.filter(i => i.json.question);\n\n// Build the response link - UPDATE THIS URL TO YOUR FRONTEND\nconst frontendUrl = 'http://portalia.ignisenergia.es:9102';\nconst responseLink = `${frontendUrl}/respond/${inputParams.token}`;\n\n// Build questions HTML for email\nconst questionsHtml = questions.map((q, idx) => `\n  <tr>\n    <td style=\"padding: 12px; border-bottom: 1px solid #e2e8f0;\">${idx + 1}</td>\n    <td style=\"padding: 12px; border-bottom: 1px solid #e2e8f0;\">${q.json.discipline || 'General'}</td>\n    <td style=\"padding: 12px; border-bottom: 1px solid #e2e8f0;\">${q.json.question}</td>\n    <td style=\"padding: 12px; border-bottom: 1px solid #e2e8f0;\">\n      <span style=\"padding: 4px 8px; border-radius: 4px; font-size: 12px; background: ${q.json.importance === 'High' ? '#fee2e2' : q.json.importance === 'Medium' ? '#fef3c7' : '#dcfce7'}; color: ${q.json.importance === 'High' ? '#991b1b' : q.json.importance === 'Medium' ? '#92400e' : '#166534'};\">\n        ${q.json.importance || 'Medium'}\n      </span>\n    </td>\n  </tr>\n`).join('');\n\n// Build email HTML\nconst emailHtml = `\n<!DOCTYPE html>\n<html>\n<head>\n  <meta charset=\"utf-8\">\n  <meta name=\"viewport\" content=\"width=device-width, initial-scale=1.0\">\n</head>\n<body style=\"margin: 0; padding: 0; font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif; background-color: #f8fafc;\">\n  <div style=\"max-width: 600px; margin: 0 auto; padding: 40px 20px;\">\n    <!-- Header -->\n    <div style=\"text-align: center; margin-bottom: 32px;\">\n      <h1 style=\"margin: 0; font-size: 28px;\">\n        <span style=\"color: #1e293b;\">Bid</span><span style=\"color: #12b5b0;\">Eval</span>\n      </h1>\n      <p style=\"margin: 8px 0 0; color: #64748b;\">Technical Evaluation Platform</p>\n    </div>\n    \n    <!-- Main Card -->\n    <div style=\"background: white; border-radius: 16px; padding: 32px; box-shadow: 0 4px 24px rgba(0,0,0,0.08);\">\n      <h2 style=\"margin: 0 0 8px; color: #1e293b; font-size: 20px;\">Technical Questionnaire Request</h2>\n      <p style=\"margin: 0 0 24px; color: #64748b;\">Project: <strong>${projectData.display_name || 'N/A'}</strong></p>\n      \n      <p style=\"color: #475569; line-height: 1.6;\">\n        Dear <strong>${inputParams.provider_name}</strong> team,\n      </p>\n      <p style=\"color: #475569; line-height: 1.6;\">\n        As part of the technical evaluation process, we have prepared a questionnaire with <strong>${questions.length}</strong> questions that require your response.\n      </p>\n      \n      <!-- Questions Table -->\n      <div style=\"margin: 24px 0; overflow-x: auto;\">\n        <table style=\"width: 100%; border-collapse: collapse; font-size: 14px;\">\n          <thead>\n            <tr style=\"background: #f1f5f9;\">\n              <th style=\"padding: 12px; text-align: left; font-weight: 600; color: #475569;\">#</th>\n              <th style=\"padding: 12px; text-align: left; font-weight: 600; color: #475569;\">Discipline</th>\n              <th style=\"padding: 12px; text-align: left; font-weight: 600; color: #475569;\">Question</th>\n              <th style=\"padding: 12px; text-align: left; font-weight: 600; color: #475569;\">Priority</th>\n            </tr>\n          </thead>\n          <tbody>\n            ${questionsHtml}\n          </tbody>\n        </table>\n      </div>\n      \n      <!-- CTA Button -->\n      <div style=\"text-align: center; margin: 32px 0;\">\n        <a href=\"${responseLink}\" style=\"display: inline-block; padding: 16px 48px; background: linear-gradient(135deg, #12b5b0 0%, #0d9488 100%); color: white; text-decoration: none; border-radius: 12px; font-weight: 600; font-size: 16px;\">Respond to Questionnaire</a>\n      </div>\n      \n      <p style=\"color: #64748b; font-size: 14px;\">\n        This link will expire on <strong>${new Date(inputParams.expires_at).toLocaleDateString('en-US', { year: 'numeric', month: 'long', day: 'numeric' })}</strong>.\n      </p>\n      \n      <hr style=\"border: none; border-top: 1px solid #e2e8f0; margin: 24px 0;\">\n      \n      <p style=\"color: #94a3b8; font-size: 12px; margin: 0;\">\n        If you have any questions, please contact the evaluation team.\n      </p>\n    </div>\n    \n    <!-- Footer -->\n    <div style=\"text-align: center; margin-top: 32px; color: #94a3b8; font-size: 12px;\">\n      <p style=\"margin: 0;\">Powered by BidEval - Technical Evaluation Platform</p>\n    </div>\n  </div>\n</body>\n</html>\n`;\n\nreturn {\n  json: {\n    success: true,\n    token: inputParams.token,\n    response_link: responseLink,\n    expires_at: inputParams.expires_at,\n    project_name: projectData.display_name,\n    provider_name: inputParams.provider_name,\n    question_count: questions.length,\n    email_to: inputParams.email_to,\n    email_subject: `Technical Questionnaire - ${projectData.display_name || 'BidEval'}`,\n    email_html: emailHtml\n  }\n};"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        -3168,
        6288
      ],
      "id": "ad482d81-a0b4-4fdf-b2e9-dd21b02339f9",
      "name": "Build Email Content"
    },
    {
      "parameters": {
        "jsCode": "// Split question_ids for update\nconst questionIds = $(\"Set Input Params2\").first().json.question_ids || [];\nreturn questionIds.map(id => ({ json: { question_id: id } }));"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        -2496,
        6288
      ],
      "id": "dee668eb-5e52-4342-a18f-30af79b438a4",
      "name": "Split for Update"
    },
    {
      "parameters": {
        "useCustomSchema": true,
        "operation": "update",
        "tableId": "qa_audit",
        "matchType": "allFilters",
        "filters": {
          "conditions": [
            {
              "keyName": "id",
              "condition": "eq",
              "keyValue": "={{ $json.question_id }}"
            }
          ]
        },
        "fieldsUi": {
          "fieldValues": [
            {
              "fieldId": "status",
              "fieldValue": "Sent"
            }
          ]
        }
      },
      "type": "n8n-nodes-base.supabase",
      "typeVersion": 1,
      "position": [
        -2272,
        6288
      ],
      "id": "feb0f73a-7725-4e5c-b382-4fec3d56341a",
      "name": "Update Question Status",
      "credentials": {
        "supabaseApi": {
          "id": "pI4CpdYLTiEEBmnz",
          "name": "Supabase account"
        }
      }
    },
    {
      "parameters": {
        "assignments": {
          "assignments": [
            {
              "id": "project_id",
              "name": "project_id",
              "value": "={{ $json.body?.project_id || $json.project_id }}",
              "type": "string"
            },
            {
              "id": "provider_name",
              "name": "provider_name",
              "value": "={{ $json.body?.provider_name || $json.provider_name }}",
              "type": "string"
            },
            {
              "id": "question_ids",
              "name": "question_ids",
              "value": "={{ $json.body?.question_ids || $json.question_ids }}",
              "type": "array"
            },
            {
              "id": "email_to",
              "name": "email_to",
              "value": "={{ $json.body?.email_to || $json.email_to || '' }}",
              "type": "string"
            },
            {
              "id": "expires_days",
              "name": "expires_days",
              "value": "={{ $json.body?.expires_days || $json.expires_days || 7 }}",
              "type": "number"
            }
          ]
        },
        "options": {}
      },
      "type": "n8n-nodes-base.set",
      "typeVersion": 3.4,
      "position": [
        -4512,
        6288
      ],
      "id": "b3ec3f54-39fc-447a-9c34-a4f89ac27789",
      "name": "Set Input Params2"
    },
    {
      "parameters": {
        "respondWith": "json",
        "responseBody": "={{ $(\"Build Email Content\").first().json }}",
        "options": {}
      },
      "type": "n8n-nodes-base.respondToWebhook",
      "typeVersion": 1.5,
      "position": [
        -2048,
        6288
      ],
      "id": "74f0932d-08ed-4710-a476-041430940a30",
      "name": "Respond to Webhook2"
    },
    {
      "parameters": {
        "content": "## QA Send to Supplier Workflow\n\n**Purpose:** Generate a unique token, send email via Gmail, and create response link for suppliers.\n\n**Input (POST body):**\n```json\n{\n  \"project_id\": \"uuid\",\n  \"provider_name\": \"IDOM\",\n  \"question_ids\": [\"uuid1\", \"uuid2\"],\n  \"email_to\": \"supplier@example.com\",\n  \"expires_days\": 7\n}\n```\n\n**Flow:**\n1. Generate 64-char token\n2. Save to `qa_response_tokens`\n3. Build HTML email\n4. If email_to provided â†’ Send via Gmail\n5. Update questions status to 'Sent'\n6. Return response link\n\n**Gmail Setup:**\nConfigure Gmail OAuth2 credentials in n8n.",
        "height": 688,
        "width": 3328,
        "color": 2
      },
      "type": "n8n-nodes-base.stickyNote",
      "typeVersion": 1,
      "position": [
        -5104,
        5904
      ],
      "id": "d8a31664-33c8-4541-bca6-33663d26ea3b",
      "name": "Sticky Note3"
    },
    {
      "parameters": {
        "useCustomSchema": true,
        "operation": "getAll",
        "tableId": "qa_response_tokens",
        "limit": 1,
        "filters": {
          "conditions": [
            {
              "keyName": "token",
              "condition": "eq",
              "keyValue": "={{ $json.token }}"
            }
          ]
        }
      },
      "type": "n8n-nodes-base.supabase",
      "typeVersion": 1,
      "position": [
        -8896,
        6064
      ],
      "id": "0f2b1089-c132-4c2c-a4b4-e6c08ce4e6c3",
      "name": "Validate Token",
      "credentials": {
        "supabaseApi": {
          "id": "pI4CpdYLTiEEBmnz",
          "name": "Supabase account"
        }
      }
    },
    {
      "parameters": {
        "conditions": {
          "options": {
            "caseSensitive": true,
            "leftValue": "",
            "typeValidation": "strict"
          },
          "conditions": [
            {
              "id": "token-valid",
              "leftValue": "={{ $json.status }}",
              "rightValue": "responded",
              "operator": {
                "type": "string",
                "operation": "notEquals"
              }
            },
            {
              "id": "not-expired",
              "leftValue": "={{ new Date($json.expires_at) > new Date() }}",
              "rightValue": true,
              "operator": {
                "type": "boolean",
                "operation": "equals"
              }
            }
          ],
          "combinator": "and"
        },
        "options": {}
      },
      "type": "n8n-nodes-base.if",
      "typeVersion": 2.2,
      "position": [
        -8672,
        6064
      ],
      "id": "372357fd-e53c-438b-b629-67276f268f08",
      "name": "Token Valid?"
    },
    {
      "parameters": {
        "respondWith": "json",
        "responseBody": "={\n  \"success\": false,\n  \"error\": \"Token is invalid, expired, or already used\"\n}",
        "options": {
          "responseCode": 400
        }
      },
      "type": "n8n-nodes-base.respondToWebhook",
      "typeVersion": 1.5,
      "position": [
        -8448,
        6240
      ],
      "id": "2d79fbb9-f865-475c-bd83-9a57e0ead70c",
      "name": "Respond Invalid"
    },
    {
      "parameters": {
        "jsCode": "// Get responses from the original input and token data\nconst inputParams = $('Set Input Params3').first().json;\nconst tokenData = $input.first().json;\n\nconst responses = inputParams.responses || [];\n\n// Return each response as a separate item with all context needed\nreturn responses.map(response => ({\n  json: {\n    // Token data\n    token_id: tokenData.id,\n    project_id: tokenData.project_id,\n    provider_name: tokenData.provider_name,\n    token: tokenData.token,\n    // Question data\n    question_id: response.question_id,\n    response_text: response.response_text\n  }\n}));"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        -8448,
        6064
      ],
      "id": "18f2314b-d36d-47d4-9cec-1a4e5ca0c7ce",
      "name": "Split Responses"
    },
    {
      "parameters": {
        "options": {}
      },
      "type": "n8n-nodes-base.splitInBatches",
      "typeVersion": 3,
      "position": [
        -8224,
        6064
      ],
      "id": "8101a674-c1a3-4b6c-80ac-e41100133e7e",
      "name": "Loop Over Items"
    },
    {
      "parameters": {
        "useCustomSchema": true,
        "operation": "update",
        "tableId": "qa_audit",
        "matchType": "allFilters",
        "filters": {
          "conditions": [
            {
              "keyName": "id",
              "condition": "eq",
              "keyValue": "={{ $json.question_id }}"
            }
          ]
        },
        "fieldsUi": {
          "fieldValues": [
            {
              "fieldId": "response",
              "fieldValue": "={{ $json.response_text }}"
            },
            {
              "fieldId": "status",
              "fieldValue": "Answered"
            },
            {
              "fieldId": "responded_at",
              "fieldValue": "={{ new Date().toISOString() }}"
            },
            {
              "fieldId": "response_source",
              "fieldValue": "portal"
            }
          ]
        }
      },
      "type": "n8n-nodes-base.supabase",
      "typeVersion": 1,
      "position": [
        -8000,
        6064
      ],
      "id": "181608e0-febe-449f-b3a5-77283d50a3e4",
      "name": "Save Response to QA Audit",
      "credentials": {
        "supabaseApi": {
          "id": "pI4CpdYLTiEEBmnz",
          "name": "Supabase account"
        }
      }
    },
    {
      "parameters": {
        "useCustomSchema": true,
        "operation": "getAll",
        "tableId": "qa_audit",
        "limit": 1,
        "filters": {
          "conditions": [
            {
              "keyName": "id",
              "condition": "eq",
              "keyValue": "={{ $('Loop Over Items').item.json.question_id }}"
            }
          ]
        }
      },
      "type": "n8n-nodes-base.supabase",
      "typeVersion": 1,
      "position": [
        -7776,
        6064
      ],
      "id": "d5be2bd0-1ce6-4fe2-ab1a-c76af2dacfee",
      "name": "Fetch Question Details",
      "alwaysOutputData": true,
      "credentials": {
        "supabaseApi": {
          "id": "pI4CpdYLTiEEBmnz",
          "name": "Supabase account"
        }
      }
    },
    {
      "parameters": {
        "conditions": {
          "options": {
            "caseSensitive": true,
            "leftValue": "",
            "typeValidation": "strict",
            "version": 2
          },
          "conditions": [
            {
              "id": "has-requirement",
              "leftValue": "={{ $json.requirement_id }}",
              "rightValue": "",
              "operator": {
                "type": "string",
                "operation": "notEmpty"
              }
            }
          ],
          "combinator": "and"
        },
        "options": {}
      },
      "type": "n8n-nodes-base.if",
      "typeVersion": 2.2,
      "position": [
        -7552,
        6064
      ],
      "id": "28c9215c-e748-4dc0-82d6-d6a926ce80af",
      "name": "Has Requirement?"
    },
    {
      "parameters": {
        "useCustomSchema": true,
        "operation": "getAll",
        "tableId": "rfq_items_master",
        "limit": 1,
        "filters": {
          "conditions": [
            {
              "keyName": "id",
              "condition": "eq",
              "keyValue": "={{ $('Fetch Question Details').first().json.requirement_id }}"
            }
          ]
        }
      },
      "type": "n8n-nodes-base.supabase",
      "typeVersion": 1,
      "position": [
        -7328,
        5952
      ],
      "id": "1cfa4566-bafd-4787-a02e-3dc4c9356fd6",
      "name": "Fetch Requirement",
      "alwaysOutputData": true,
      "credentials": {
        "supabaseApi": {
          "id": "pI4CpdYLTiEEBmnz",
          "name": "Supabase account"
        }
      }
    },
    {
      "parameters": {
        "useCustomSchema": true,
        "operation": "getAll",
        "tableId": "provider_responses",
        "returnAll": true,
        "matchType": "allFilters",
        "filters": {
          "conditions": [
            {
              "keyName": "requirement_id",
              "condition": "eq",
              "keyValue": "={{ $('Fetch Question Details').first().json.requirement_id }}"
            },
            {
              "keyName": "provider_name",
              "condition": "eq",
              "keyValue": "={{ $('Loop Over Items').item.json.provider_name }}"
            }
          ]
        }
      },
      "type": "n8n-nodes-base.supabase",
      "typeVersion": 1,
      "position": [
        -7104,
        5952
      ],
      "id": "dd7b0b2a-f836-47fe-b7c6-83f7578a4897",
      "name": "Fetch Current Evaluation",
      "alwaysOutputData": true,
      "credentials": {
        "supabaseApi": {
          "id": "pI4CpdYLTiEEBmnz",
          "name": "Supabase account"
        }
      }
    },
    {
      "parameters": {
        "promptType": "define",
        "text": "=You are a technical evaluation expert. Based on a supplier's clarifying response, re-evaluate if a requirement is now better satisfied.\n\n**ORIGINAL REQUIREMENT:**\n{{ $('Fetch Requirement').first().json.requirement_text }}\n\n**CURRENT EVALUATION:**\nStatus: {{ $json.evaluation_value || 'NO INCLUIDO' }}\nScore: {{ $json.score || 0 }}/10\nComment: {{ $json.comment || 'Not evaluated' }}\n\n**SUPPLIER'S CLARIFYING RESPONSE:**\n{{ $('Loop Over Items').item.json.response_text }}\n\n**INSTRUCTIONS:**\n1. Analyze if the supplier's response addresses the gaps in the original requirement.\n2. Determine if the evaluation should be improved.\n3. Only improve the score if the response provides substantial new information.\n4. Be conservative - don't upgrade unless clearly justified.\n\n**RESPOND STRICTLY WITH JSON:**\n{\n  \"should_update\": true/false,\n  \"new_evaluation_value\": \"INCLUIDO\" | \"PARCIAL\" | \"NO INCLUIDO\",\n  \"new_score\": 0-10,\n  \"new_comment\": \"Brief explanation of change or why no change\",\n  \"confidence\": 0-100\n}",
        "hasOutputParser": true,
        "batching": {}
      },
      "type": "@n8n/n8n-nodes-langchain.chainLlm",
      "typeVersion": 1.8,
      "position": [
        -6880,
        5952
      ],
      "id": "106ccc45-1430-45bf-beb5-d7171afc2da1",
      "name": "LLM Re-evaluate"
    },
    {
      "parameters": {
        "conditions": {
          "options": {
            "caseSensitive": true,
            "leftValue": "",
            "typeValidation": "strict"
          },
          "conditions": [
            {
              "id": "should-update",
              "leftValue": "={{ $json.output.should_update }}",
              "rightValue": true,
              "operator": {
                "type": "boolean",
                "operation": "equals"
              }
            },
            {
              "id": "high-confidence",
              "leftValue": "={{ $json.output.confidence }}",
              "rightValue": 70,
              "operator": {
                "type": "number",
                "operation": "gte"
              }
            }
          ],
          "combinator": "and"
        },
        "options": {}
      },
      "type": "n8n-nodes-base.if",
      "typeVersion": 2.2,
      "position": [
        -6656,
        5952
      ],
      "id": "f5613ba0-8bed-4afd-a01d-0f84474d1aa7",
      "name": "Should Update?"
    },
    {
      "parameters": {
        "useCustomSchema": true,
        "operation": "update",
        "tableId": "provider_responses",
        "matchType": "allFilters",
        "filters": {
          "conditions": [
            {
              "keyName": "requirement_id",
              "condition": "eq",
              "keyValue": "={{ $('Fetch Question Details').first().json.requirement_id }}"
            },
            {
              "keyName": "provider_name",
              "condition": "eq",
              "keyValue": "={{ $('Loop Over Items').item.json.provider_name }}"
            }
          ]
        },
        "fieldsUi": {
          "fieldValues": [
            {
              "fieldId": "evaluation_value",
              "fieldValue": "={{ $json.output.new_evaluation_value }}"
            },
            {
              "fieldId": "comment",
              "fieldValue": "={{ $json.output.new_comment + ' [Updated after supplier response]' }}"
            }
          ]
        }
      },
      "type": "n8n-nodes-base.supabase",
      "typeVersion": 1,
      "position": [
        -6432,
        5872
      ],
      "id": "0d20f7ad-8439-4194-b607-78c5e158847d",
      "name": "Update Provider Response",
      "credentials": {
        "supabaseApi": {
          "id": "pI4CpdYLTiEEBmnz",
          "name": "Supabase account"
        }
      }
    },
    {
      "parameters": {},
      "type": "n8n-nodes-base.noOp",
      "typeVersion": 1,
      "position": [
        -6432,
        6032
      ],
      "id": "7a4e21c6-a028-4383-a6b7-c987c4a5b1f2",
      "name": "Skip Update"
    },
    {
      "parameters": {},
      "type": "n8n-nodes-base.noOp",
      "typeVersion": 1,
      "position": [
        -7328,
        6176
      ],
      "id": "a796b68d-03e3-45ff-a098-bdc09ec8d7c8",
      "name": "No Requirement"
    },
    {
      "parameters": {},
      "type": "n8n-nodes-base.merge",
      "typeVersion": 3,
      "position": [
        -6208,
        6064
      ],
      "id": "daa32020-3dd2-4762-a61c-85cdf3800ea4",
      "name": "Merge Results"
    },
    {
      "parameters": {
        "useCustomSchema": true,
        "operation": "update",
        "tableId": "qa_response_tokens",
        "matchType": "allFilters",
        "filters": {
          "conditions": [
            {
              "keyName": "token",
              "condition": "eq",
              "keyValue": "={{ $('Set Input Params3').first().json.token }}"
            }
          ]
        },
        "fieldsUi": {
          "fieldValues": [
            {
              "fieldId": "status",
              "fieldValue": "responded"
            },
            {
              "fieldId": "responded_at",
              "fieldValue": "={{ new Date().toISOString() }}"
            }
          ]
        }
      },
      "type": "n8n-nodes-base.supabase",
      "typeVersion": 1,
      "position": [
        -5984,
        6064
      ],
      "id": "a43f16f6-8187-4417-9650-cd20e20db889",
      "name": "Mark Token Responded",
      "credentials": {
        "supabaseApi": {
          "id": "pI4CpdYLTiEEBmnz",
          "name": "Supabase account"
        }
      }
    },
    {
      "parameters": {
        "useCustomSchema": true,
        "tableId": "qa_notifications",
        "fieldsUi": {
          "fieldValues": [
            {
              "fieldId": "project_id",
              "fieldValue": "={{ $('Validate Token').first().json.project_id }}"
            },
            {
              "fieldId": "provider_name",
              "fieldValue": "={{ $('Validate Token').first().json.provider_name }}"
            },
            {
              "fieldId": "notification_type",
              "fieldValue": "supplier_responded"
            },
            {
              "fieldId": "title",
              "fieldValue": "=Supplier {{ $('Validate Token').first().json.provider_name }} has responded"
            },
            {
              "fieldId": "message",
              "fieldValue": "={{ $('Set Input Params3').first().json.responses.length || 0 }} question(s) answered via the supplier portal"
            },
            {
              "fieldId": "metadata",
              "fieldValue": "={{ JSON.stringify({ response_count: $('Set Input Params3').first().json.responses.length || 0, token: $('Set Input Params3').first().json.token }) }}"
            }
          ]
        }
      },
      "type": "n8n-nodes-base.supabase",
      "typeVersion": 1,
      "position": [
        -5760,
        6064
      ],
      "id": "9e25f034-32c6-4dbb-aaac-fd7fcc60d6a7",
      "name": "Create Notification",
      "credentials": {
        "supabaseApi": {
          "id": "pI4CpdYLTiEEBmnz",
          "name": "Supabase account"
        }
      }
    },
    {
      "parameters": {
        "respondWith": "json",
        "responseBody": "={\n  \"success\": true,\n  \"message\": \"Responses processed and evaluations updated\",\n  \"processed_count\": {{ $('Set Input Params3').first().json.responses.length || 0 }}\n}",
        "options": {}
      },
      "type": "n8n-nodes-base.respondToWebhook",
      "typeVersion": 1.5,
      "position": [
        -5536,
        6064
      ],
      "id": "a5f2b726-9408-4cbc-b294-63905ca44b2f",
      "name": "Respond Success"
    },
    {
      "parameters": {
        "httpMethod": "POST",
        "path": "qa-process-responses",
        "responseMode": "responseNode",
        "options": {}
      },
      "type": "n8n-nodes-base.webhook",
      "typeVersion": 2.1,
      "position": [
        -9328,
        6064
      ],
      "id": "45fe8e32-f477-4f83-b9b7-b357167e22fb",
      "name": "Webhook Receive1",
      "webhookId": "qa-process-responses-webhook"
    },
    {
      "parameters": {
        "assignments": {
          "assignments": [
            {
              "id": "token",
              "name": "token",
              "value": "={{ $json.body?.token || $json.token }}",
              "type": "string"
            },
            {
              "id": "responses",
              "name": "responses",
              "value": "={{ $json.body?.responses || $json.responses }}",
              "type": "array"
            }
          ]
        },
        "options": {}
      },
      "type": "n8n-nodes-base.set",
      "typeVersion": 3.4,
      "position": [
        -9104,
        6064
      ],
      "id": "fe01a080-9727-40b4-902c-bea68e41d982",
      "name": "Set Input Params3"
    },
    {
      "parameters": {
        "schemaType": "manual",
        "inputSchema": "{\n  \"type\": \"object\",\n  \"properties\": {\n    \"should_update\": { \"type\": \"boolean\" },\n    \"new_evaluation_value\": { \"type\": \"string\" },\n    \"new_score\": { \"type\": \"number\" },\n    \"new_comment\": { \"type\": \"string\" },\n    \"confidence\": { \"type\": \"number\" }\n  }\n}"
      },
      "type": "@n8n/n8n-nodes-langchain.outputParserStructured",
      "typeVersion": 1.3,
      "position": [
        -6880,
        6192
      ],
      "id": "26d591db-17b0-4aff-9e98-2fcece0d9038",
      "name": "JSON Output Parser2"
    },
    {
      "parameters": {
        "content": "## QA Process Responses Workflow\n\n**Purpose:** Process supplier responses using a Loop for reliable item-by-item processing.\n\n**Data Model:**\n- `qa_audit.requirement_id` links to `rfq_items_master.id`\n- This allows re-evaluation of requirements based on supplier responses\n\n**Input (POST body):**\n```json\n{\n  \"token\": \"abc123xyz...\",\n  \"responses\": [\n    {\n      \"question_id\": \"uuid\",\n      \"response_text\": \"Supplier's answer...\"\n    }\n  ]\n}\n```\n\n**Process:**\n1. Validate token (not expired, not used)\n2. Split responses into items\n3. **Loop Over Items** - process each response:\n   - Save response to qa_audit\n   - Fetch question details (including requirement_id)\n   - If has requirement_id:\n     - Fetch requirement from rfq_items_master\n     - Fetch current evaluation\n     - Re-evaluate with LLM\n     - Update if confidence >= 70%\n4. After loop: Mark token as responded\n5. Create notification\n6. Respond with success\n\n**Tables Updated:**\n- `qa_audit` - response, status, responded_at, response_source\n- `provider_responses` - evaluation_value, score, comment\n- `qa_response_tokens` - status, responded_at\n- `qa_notifications` - new notification created",
        "height": 1020,
        "width": 4418,
        "color": 3
      },
      "type": "n8n-nodes-base.stickyNote",
      "typeVersion": 1,
      "position": [
        -9680,
        5472
      ],
      "id": "38ef0448-7ad3-44e4-8436-751425a295b3",
      "name": "Sticky Note6"
    },
    {
      "parameters": {
        "content": "## /qa-process-email-response - AI Email Response Mapper\n\nProcesses supplier email responses and maps them to original Q&A questions using AI.\n\n**Method**: POST\n**Body**: { project_id, provider_name, email_content }\n\n**Flow**: Webhook â†’ Set Fields â†’ Fetch Q&A Questions â†’ Build AI Context â†’ LLM Chain â†’ Parse Output â†’ Respond\n\n**Returns**: { success, processed_count, mappings: [{ question_id, question_text, response_text, confidence, matched }] }",
        "height": 400,
        "width": 2400,
        "color": 7
      },
      "type": "n8n-nodes-base.stickyNote",
      "typeVersion": 1,
      "position": [
        -1680,
        5936
      ],
      "id": "14dbedd9-3cc7-4ffe-8406-b3d39df4ac50",
      "name": "Sticky Note QA Email"
    },
    {
      "parameters": {
        "httpMethod": "POST",
        "path": "qa-process-email-response",
        "responseMode": "responseNode",
        "options": {}
      },
      "type": "n8n-nodes-base.webhook",
      "typeVersion": 2.1,
      "position": [
        -1264,
        6176
      ],
      "id": "4668236e-17f9-401b-9ee1-14c5bcfb2eb2",
      "name": "Webhook QA Email Response",
      "webhookId": "qa-email-response-webhook-001"
    },
    {
      "parameters": {
        "assignments": {
          "assignments": [
            {
              "id": "qa-email-project-id",
              "name": "project_id",
              "value": "={{ $json.body.project_id }}",
              "type": "string"
            },
            {
              "id": "qa-email-provider",
              "name": "provider_name",
              "value": "={{ $json.body.provider_name }}",
              "type": "string"
            },
            {
              "id": "qa-email-content",
              "name": "email_content",
              "value": "={{ $json.body.email_content }}",
              "type": "string"
            }
          ]
        },
        "options": {}
      },
      "type": "n8n-nodes-base.set",
      "typeVersion": 3.4,
      "position": [
        -1040,
        6176
      ],
      "id": "20365396-960a-4220-ac7e-ba9dbbf99079",
      "name": "Set QA Email Params"
    },
    {
      "parameters": {
        "useCustomSchema": true,
        "operation": "getAll",
        "tableId": "qa_audit",
        "returnAll": true,
        "matchType": "allFilters",
        "filters": {
          "conditions": [
            {
              "keyName": "project_id",
              "condition": "eq",
              "keyValue": "={{ $json.project_id }}"
            },
            {
              "keyName": "provider_name",
              "condition": "eq",
              "keyValue": "={{ $json.provider_name }}"
            }
          ]
        }
      },
      "type": "n8n-nodes-base.supabase",
      "typeVersion": 1,
      "position": [
        -816,
        6176
      ],
      "id": "2f3cd97a-56c0-4e30-8ca1-851b18bb83b9",
      "name": "Fetch QA Questions",
      "alwaysOutputData": true,
      "credentials": {
        "supabaseApi": {
          "id": "pI4CpdYLTiEEBmnz",
          "name": "Supabase account"
        }
      }
    },
    {
      "parameters": {
        "jsCode": "// Build context for LLM: combine Q&A questions with email content\nconst questions = $('Fetch QA Questions').all();\nconst params = $('Set QA Email Params').first().json;\n\nconst questionList = questions.map(q => ({\n  id: q.json.id,\n  question: q.json.question,\n  discipline: q.json.discipline,\n  importance: q.json.importance,\n  status: q.json.status\n}));\n\nconsole.log(`ðŸ“§ Processing email response:`);\nconsole.log(`   â”œâ”€ Provider: ${params.provider_name}`);\nconsole.log(`   â”œâ”€ Questions found: ${questionList.length}`);\nconsole.log(`   â””â”€ Email length: ${(params.email_content || '').length} chars`);\n\nreturn [{\n  json: {\n    project_id: params.project_id,\n    provider_name: params.provider_name,\n    email_content: params.email_content,\n    questions: questionList,\n    total_questions: questionList.length\n  }\n}];"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        -592,
        6176
      ],
      "id": "085cc77f-2d51-48a2-922b-160c39229b53",
      "name": "Build AI Context"
    },
    {
      "parameters": {
        "promptType": "define",
        "text": "=### INPUT\n\n## PROVIDER: {{ $json.provider_name }}\n\n## ORIGINAL QUESTIONS ({{ $json.total_questions }} items):\n{{ JSON.stringify($json.questions, null, 2) }}\n\n## SUPPLIER EMAIL RESPONSE:\n{{ $json.email_content }}\n\n### INSTRUCTIONS\nAnalyze the supplier's email response and map each answer to its most likely original question.\nFor each mapping, provide a confidence score (0.0 to 1.0) indicating how certain you are of the match.\nIf a question has no corresponding answer in the email, set matched=false and response_text to empty string.\n\nReturn ONLY the JSON object. Do NOT include any text before or after the JSON.\n\n### OUTPUT SCHEMA\n{\n  \"success\": true,\n  \"processed_count\": <number of matched responses>,\n  \"mappings\": [\n    {\n      \"question_id\": \"<uuid from original question>\",\n      \"question_text\": \"<original question text>\",\n      \"response_text\": \"<extracted response from email>\",\n      \"confidence\": <0.0 to 1.0>,\n      \"matched\": <true/false>\n    }\n  ]\n}",
        "messages": {
          "messageValues": [
            {
              "message": "You are an expert AI assistant specialized in analyzing supplier email responses for procurement Q&A processes.\n\n### ROLE\nYou analyze email responses from suppliers and map each answer to its original technical question from a Q&A audit.\n\n### GUIDELINES\n1. Read the email carefully and identify distinct answers or response sections.\n2. Match each answer to the most relevant original question based on content, keywords, and context.\n3. Extract the exact response text from the email for each matched question.\n4. Assign confidence scores: 0.9+ for clear matches, 0.6-0.8 for likely matches, below 0.5 for uncertain.\n5. If a question has no answer in the email, mark it as not matched.\n6. Preserve the original question_id UUID exactly as provided.\n\n### CRITICAL: OUTPUT RESTRICTIONS\n- Return **ONLY** a valid JSON object.\n- **DO NOT** include any conversational text, explanations, or reasoning.\n- **DO NOT** use Markdown code blocks.\n- The output must start with `{` and end with `}`."
            }
          ]
        },
        "batching": {}
      },
      "type": "@n8n/n8n-nodes-langchain.chainLlm",
      "typeVersion": 1.8,
      "position": [
        -368,
        6176
      ],
      "id": "32714b74-cc03-4752-9fc9-1986be643686",
      "name": "QA Email Mapping Chain"
    },
    {
      "parameters": {
        "jsCode": "// Parse LLM output and ensure correct response format\nconst llmOutput = $input.first().json;\nlet result;\n\ntry {\n  // The LLM chain returns output in .text or .output\n  const rawText = llmOutput.text || llmOutput.output || JSON.stringify(llmOutput);\n  \n  // Try to parse as JSON\n  let parsed;\n  if (typeof rawText === 'string') {\n    // Clean potential markdown code blocks\n    const cleaned = rawText.replace(/```json\\n?/g, '').replace(/```\\n?/g, '').trim();\n    parsed = JSON.parse(cleaned);\n  } else {\n    parsed = rawText;\n  }\n  \n  // Validate and normalize\n  const mappings = (parsed.mappings || []).map(m => ({\n    question_id: m.question_id || '',\n    question_text: m.question_text || '',\n    response_text: m.response_text || '',\n    confidence: typeof m.confidence === 'number' ? m.confidence : 0,\n    matched: m.matched === true\n  }));\n  \n  const matchedCount = mappings.filter(m => m.matched).length;\n  \n  result = {\n    success: true,\n    processed_count: matchedCount,\n    mappings: mappings,\n    message: `Processed ${matchedCount} of ${mappings.length} questions from email`\n  };\n  \n  console.log(`âœ… QA Email Response processed:`);\n  console.log(`   â”œâ”€ Total mappings: ${mappings.length}`);\n  console.log(`   â””â”€ Matched: ${matchedCount}`);\n} catch (err) {\n  console.error('âŒ Error parsing LLM output:', err.message);\n  result = {\n    success: false,\n    processed_count: 0,\n    mappings: [],\n    message: 'Error parsing AI response: ' + err.message\n  };\n}\n\nreturn [{ json: result }];"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        -16,
        6176
      ],
      "id": "edb722f3-444a-47a1-a4df-3d1841f63489",
      "name": "Parse QA Email Output"
    },
    {
      "parameters": {
        "respondWith": "allIncomingItems",
        "options": {}
      },
      "type": "n8n-nodes-base.respondToWebhook",
      "typeVersion": 1.5,
      "position": [
        208,
        6176
      ],
      "id": "fbe7a105-5de5-4fd0-aa7d-b061034ba977",
      "name": "Respond QA Email Response"
    },
    {
      "parameters": {
        "options": {
          "temperature": 0.1
        }
      },
      "type": "@n8n/n8n-nodes-langchain.lmChatOpenRouter",
      "typeVersion": 1,
      "position": [
        -6144,
        4224
      ],
      "id": "7f131c36-0bf0-4fb7-bbe8-cafa296cef62",
      "name": "OpenRouter Chat Model",
      "credentials": {
        "openRouterApi": {
          "id": "4AyUqsh1Z35g6bci",
          "name": "OpenRouter account"
        }
      }
    },
    {
      "parameters": {
        "assignments": {
          "assignments": [
            {
              "id": "6d3a985e-7c5e-4c74-8b5e-407e4d8c83a9",
              "name": "project_name",
              "value": "={{ $json.body.project_name }}",
              "type": "string"
            },
            {
              "id": "project-id-uuid-field",
              "name": "project_id",
              "value": "={{ $json.body.project_id }}",
              "type": "string"
            },
            {
              "id": "2d3a985e-7c5e-4c74-8b5e-407e4d8c83a1",
              "name": "provider_name",
              "value": "={{ $json.body.provider_key }}",
              "type": "string"
            },
            {
              "id": "3d3a985e-7c5e-4c74-8b5e-407e4d8c83a2",
              "name": "tone",
              "value": "={{ $json.body.tone }}",
              "type": "string"
            },
            {
              "id": "4d3a985e-7c5e-4c74-8b5e-407e4d8c83a3",
              "name": "qa_items",
              "value": "={{ $json.body.qa_items }}",
              "type": "array"
            },
            {
              "id": "language-field-email",
              "name": "language",
              "value": "={{ $json.body.language || 'es' }}",
              "type": "string"
            },
            {
              "id": "currency-field-email",
              "name": "currency",
              "value": "={{ $json.body.currency || 'EUR' }}",
              "type": "string"
            }
          ]
        },
        "options": {}
      },
      "type": "n8n-nodes-base.set",
      "typeVersion": 3.4,
      "position": [
        -6736,
        4000
      ],
      "id": "85d0a8c1-8ba2-4926-a019-a1cd9762929c",
      "name": "Edit Fields"
    },
    {
      "parameters": {
        "jsCode": "// 1. Datos de Edit Fields (siempre disponible)\n  const editFields = $('Edit Fields').first().json;\n  const targetProvider = editFields.provider_name;\n  const qaItems = editFields.qa_items || [];\n\n  // 2. Ofertas del proveedor â€” con fallback si Get Offers no ha ejecutado\n  let allOffers = [];\n  try {\n    allOffers = $('Get Offers').all();\n  } catch (e) {\n    // Si falla, el workflow necesita un Merge node antes de este Code node\n    allOffers = [];\n  }\n\n  // 3. Filtrar issues del proveedor objetivo\n  const issuesFound = [];\n  for (const item of allOffers) {\n    const row = item.json;\n    if (row.provider_name === targetProvider) {\n      const status = (row.evaluation_value || '').trim();\n      if (status.toUpperCase() !== 'INCLUIDO') {\n        issuesFound.push({\n          description: row.requirement_text || row.item_description ||\n  row.comment || 'Item requires clarification',\n          status: status || 'NOT PROVIDED',\n          provider_comment: row.comment || ''\n        });\n      }\n    }\n  }\n\n  // 4. Preparar preguntas Q&A\n  const qaQuestions = qaItems.map(q => ({\n    question: q.question || q.pregunta_texto || '',\n    discipline: q.discipline || q.disciplina || 'General',\n    importance: q.importance || q.importancia || 'Medium'\n  }));\n\n  // 5. Retornar todo para el LLM\n  return {\n    issues: issuesFound,\n    total_issues: issuesFound.length,\n    qa_questions: qaQuestions,\n    total_qa_questions: qaQuestions.length,\n    project_id: editFields.project_id,\n    project_name: editFields.project_name,\n    provider_name: targetProvider,\n    tone: editFields.tone\n  };"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        -6288,
        4000
      ],
      "id": "688fbb8a-d90e-4dbc-82a4-3de4b1c75dbc",
      "name": "Filter and Aggregate Issues"
    },
    {
      "parameters": {
        "content": "## Email en base datos faltantes\n",
        "height": 864,
        "width": 2016,
        "color": 6
      },
      "type": "n8n-nodes-base.stickyNote",
      "typeVersion": 1,
      "position": [
        -7248,
        3712
      ],
      "id": "78b59d23-be18-4d45-99bf-9103756b29af",
      "name": "Sticky Note2"
    },
    {
      "parameters": {
        "httpMethod": "POST",
        "path": "mail",
        "responseMode": "responseNode",
        "options": {}
      },
      "type": "n8n-nodes-base.webhook",
      "typeVersion": 2.1,
      "position": [
        -6960,
        4000
      ],
      "id": "59cc00f7-484d-40ae-b785-f32127cd5c3b",
      "name": "Webhook3",
      "webhookId": "2dcca6b6-4d20-4250-9202-7b16ac06f716"
    },
    {
      "parameters": {
        "useCustomSchema": true,
        "operation": "getAll",
        "tableId": "provider_responses",
        "returnAll": true,
        "filters": {
          "conditions": [
            {
              "keyName": "provider_name",
              "condition": "eq",
              "keyValue": "={{ $json.provider_name }}"
            },
            {
              "keyName": "project_id",
              "condition": "eq",
              "keyValue": "={{ $json.project_id }}"
            }
          ]
        }
      },
      "id": "4ce9cf26-7fe9-4b87-a888-525df9dacc80",
      "name": "Get Offers",
      "type": "n8n-nodes-base.supabase",
      "typeVersion": 1,
      "position": [
        -6512,
        4208
      ],
      "alwaysOutputData": true,
      "credentials": {
        "supabaseApi": {
          "id": "pI4CpdYLTiEEBmnz",
          "name": "Supabase account"
        }
      }
    },
    {
      "parameters": {
        "model": "qwen3:8b",
        "options": {
          "temperature": 0.2,
          "numCtx": 4096,
          "numPredict": 1024
        }
      },
      "type": "@n8n/n8n-nodes-langchain.lmChatOllama",
      "typeVersion": 1,
      "position": [
        -5696,
        4224
      ],
      "id": "eee00eb8-f2c3-4482-b6c5-e943fe94aaa5",
      "name": "Ollama Chat Model",
      "credentials": {
        "ollamaApi": {
          "id": "oS2Qqti9oVfsm8XZ",
          "name": "Ollama account"
        }
      }
    },
    {
      "parameters": {
        "promptType": "define",
        "text": "=### INPUT\n\n## PROJECT: {{ $('Edit Fields').first().json.project_name }}\n\n## PROVIDER: {{ $('Edit Fields').first().json.provider_name }}\n\n## REQUIRED TONE: {{ $('Edit Fields').first().json.tone }}\n\n## ISSUES ({{ $json.total_issues }} items): {{ JSON.stringify($json.issues, null, 2) }}\n\n## TECHNICAL QUESTIONS ({{ $json.total_qa_questions }} items): {{ JSON.stringify($json.qa_questions, null, 2) }}\n\n\\n## PROJECT CONTEXT: {{ $('Fetch Project Context Email').first().json.ai_context }}\\n\\n### FINAL INSTRUCTIONS\nReturn ONLY the JSON object. Do NOT think out loud. Do NOT include any text before or after the JSON.\n",
        "messages": {
          "messageValues": [
            {
              "message": "=### ROLE\nYou are an expert Senior Project Engineer and Procurement Manager for large-scale industrial projects (P2X, Green Hydrogen). You are meticulous, diplomatic, and results-oriented.\n\n### TASK\nDraft a professional email to the Provider regarding their recent proposal for the Project. We have identified specific gaps/issues and technical questions that need to be addressed.\n\n### LANGUAGE & CURRENCY\n- Write the email in {{ $('Edit Fields').first().json.language === 'en' ? 'ENGLISH' : 'SPANISH' }}.\n- When referencing monetary values, use {{ $('Edit Fields').first().json.currency || 'EUR' }} as currency.\n\n### GUIDELINES\n1. **Subject Line**: Must be clear, professional, and reference the Project name.\n2. **Tone**: Strictly adhere to the requested 'TONE' input.\n3. **Body Content**:\n   - Briefly thank them for the proposal.\n   - State that during the review, the following points require clarification or are missing.\n   - **For ISSUES**: Group them intelligently (e.g., by category or type). For each issue, describe what is missing using the 'description' field. NEVER show any IDs, UUIDs, or internal references.\n   - **For TECHNICAL QUESTIONS**: If there are any qa_questions, add a section titled 'Technical Questions' and list them. Include the discipline and importance level for each.\n   - Ask for these specific items to be provided or clarified.\n4. **Formatting**: Use Markdown formatting (bold, bullet points) for readability.\n5. **IMPORTANT**: NEVER include any UUIDs, internal IDs, requirement_id, or database references. Use only human-readable descriptions.\n\n### CRITICAL: OUTPUT RESTRICTIONS\n- Return **ONLY** a valid JSON object.\n- **DO NOT** include any UUIDs or internal database IDs anywhere in the output.\n- **DO NOT** include any conversational text, explanations, reasoning, thoughts, or technical notes.\n- **DO NOT** use Markdown code blocks (e.g., ```json).\n- The output must start with `{` and end with `}`.\n\n### SCHEMA\n{\n  \"subject\": \"Email Subject Here\",\n  \"body\": \"Email Body Here with **bold** and - bullet points\"\n}"
            }
          ]
        },
        "batching": {}
      },
      "type": "@n8n/n8n-nodes-langchain.chainLlm",
      "typeVersion": 1.8,
      "position": [
        -6064,
        4000
      ],
      "id": "82dcb2df-cb8e-48f5-ba89-1d146741c0aa",
      "name": "Basic LLM Chain"
    },
    {
      "parameters": {
        "respondWith": "allIncomingItems",
        "options": {}
      },
      "type": "n8n-nodes-base.respondToWebhook",
      "typeVersion": 1.5,
      "position": [
        -5712,
        4000
      ],
      "id": "38174faa-82f0-431f-90de-2e0c60bcfbfb",
      "name": "Respond to Webhook3"
    },
    {
      "parameters": {
        "useCustomSchema": true,
        "operation": "get",
        "tableId": "projects",
        "filters": {
          "conditions": [
            {
              "keyName": "id",
              "keyValue": "={{ $('Edit Fields').first().json.project_id }}"
            }
          ]
        }
      },
      "id": "6b882074-7210-43a7-82e6-3c8008a99ab6",
      "name": "Fetch Project Context Email",
      "type": "n8n-nodes-base.supabase",
      "typeVersion": 1,
      "position": [
        -6480,
        4000
      ],
      "credentials": {
        "supabaseApi": {
          "id": "pI4CpdYLTiEEBmnz",
          "name": "Supabase account"
        }
      }
    },
    {
      "parameters": {
        "useCustomSchema": true,
        "operation": "getAll",
        "tableId": "rfq_items_master",
        "returnAll": true,
        "matchType": "allFilters",
        "filters": {
          "conditions": [
            {
              "keyName": "evaluation_type",
              "condition": "eq",
              "keyValue": "={{ $json.tipo_evaluacion_actual }}"
            },
            {
              "keyName": "project_id",
              "condition": "eq",
              "keyValue": "={{ $('Set File ID').first().json.project_id }}"
            }
          ]
        }
      },
      "type": "n8n-nodes-base.supabase",
      "typeVersion": 1,
      "position": [
        -4064,
        2864
      ],
      "id": "b2d08489-1a4e-409f-8563-c28e669510f4",
      "name": "Get many rows1",
      "credentials": {
        "supabaseApi": {
          "id": "pI4CpdYLTiEEBmnz",
          "name": "Supabase account"
        }
      }
    },
    {
      "parameters": {
        "model": "qwen3-embedding:8b"
      },
      "type": "@n8n/n8n-nodes-langchain.embeddingsOllama",
      "typeVersion": 1,
      "position": [
        -1024,
        3968
      ],
      "id": "be9692a9-355d-43f2-8e6f-9b370102a5b3",
      "name": "Embeddings Ollama3",
      "credentials": {
        "ollamaApi": {
          "id": "oS2Qqti9oVfsm8XZ",
          "name": "Ollama account"
        }
      }
    },
    {
      "parameters": {
        "promptType": "define",
        "text": "=### DOCUMENT AUDIT: CROSS-VALIDATION\n\n**[1. USER MANUAL SELECTION]**\n- Project: \"{{ $('Set File ID').item.json.proyect_name }}\"\n- Provider: \"{{ $('Set File ID').item.json.proveedor }}\"\n- Evaluation Type: \"{{ $('Set File ID').item.json.evaluation }}\"\n- File Name: \"{{ $('Set File ID').item.json.file_title }}\"\n\n---\n**[2. ACTUAL PDF EVIDENCE (Extracted text)]**\n{{ $json.texto_muestra }}\n\n---\n### MAPPING AND VALIDATION INSTRUCTIONS:\n\n#### RULE 1: SYNONYMS AND CANONICAL TYPES\nYou can only use these 4 exact names. Map the evidence as follows:\n- **\"Commercial Proposal\" / \"Oferta EconÃ³mica\" / \"Price Schedule\"** â†’ MUST BE `Economical Evaluation`.\n- **\"Technical Proposal\" / \"Scope of Work\" / \"MetodologÃ­a\"** â†’ MUST BE `Technical Evaluation`.\n- **\"Technical & Economical Proposal\"** â†’ MUST INCLUDE BOTH: `Technical Evaluation` AND `Economical Evaluation`.\n- **Drawing lists** â†’ `Pre-FEED Deliverables` or `FEED Deliverables`.\n\n#### RULE 2: TITLE AND FILE NAME ARE DECISIVE\n- Analyze the **File Name** and **Title** of the document. If they say \"Oferta TÃ©cnica\" or \"Technical Proposal\", the type is `Technical Evaluation`.\n- **IMPORTANT:** DO NOT add other types for minor mentions. Example: If a technical document mentions \"estimated prices\", DO NOT add `Economical Evaluation`. Only add it if you see a complete PRICE TABLE.\n- Be conservative: when in doubt, follow the File Name.\n\n#### RULE 3: INTENTION BALANCING\n- If the PDF is mixed but the user has selected one of the valid types present, mark `tipos_validados: true`.\n\n### OUTPUT FORMAT (SINGLE JSON):\n{\n  \"modo_usado\": \"VALIDADOR\",\n  \"proyecto_detectado\": \"Actual Name\",\n  \"proyecto_valido\": true | false,\n  \"proyecto_nota\": \"Summary\",\n  \"proveedor_detectado\": \"IDOM | SENER | TRESCA | SACYR | TECNICASREUNIDAS | EA | WORLEY\",\n  \"proveedor_valido\": true | false,\n  \"proveedor_nota\": \"Explanation\",\n  \"tipos_detectados\": [\"Technical Evaluation\", \"Economical Evaluation\", \"Pre-FEED Deliverables\", \"FEED Deliverables\"],\n  \"tipos_validados\": true | false,\n  \"tipos_nota\": \"Explain why you validated or rejected the types.\",\n  \"razonamiento\": \"Mention the File Name and Title found.\"\n}",
        "hasOutputParser": true,
        "messages": {
          "messageValues": [
            {
              "message": "=Act as a strict validator. If there are flagrant discrepancies between the user's suggestion and the actual PDF content, prioritize the PDF content and mark validation as false and report the correct provider/type.\n\nSupported providers: Tecnicas Reunidas, IDOM, SACYR, Empresarios Agrupados, SENER, TRESCA, WORLEY"
            }
          ]
        },
        "batching": {}
      },
      "type": "@n8n/n8n-nodes-langchain.chainLlm",
      "typeVersion": 1.8,
      "position": [
        -1520,
        3504
      ],
      "id": "03c42f58-850b-4650-8908-ba2e868061ea",
      "name": "Validador de Ofertas",
      "disabled": true
    },
    {
      "parameters": {
        "model": "mistral:7b",
        "options": {
          "temperature": 0.1,
          "numCtx": 4096,
          "numPredict": 1024
        }
      },
      "type": "@n8n/n8n-nodes-langchain.lmChatOllama",
      "typeVersion": 1,
      "position": [
        -1568,
        3696
      ],
      "id": "858d3f5d-c144-46a4-8355-858effa5f44f",
      "name": "Ollama Chat Model1",
      "credentials": {
        "ollamaApi": {
          "id": "oS2Qqti9oVfsm8XZ",
          "name": "Ollama account"
        }
      }
    },
    {
      "parameters": {
        "schemaType": "manual",
        "inputSchema": "{\n  \"type\": \"object\",\n  \"properties\": {\n    \"modo_usado\": {\n      \"type\": \"string\"\n    },\n    \"proyecto_detectado\": {\n      \"type\": \"string\"\n    },\n    \"proyecto_valido\": {\n      \"type\": \"boolean\"\n    },\n    \"proyecto_nota\": {\n      \"type\": \"string\"\n    },\n    \"proveedor_detectado\": {\n      \"type\": \"string\"\n    },\n    \"proveedor_valido\": {\n      \"type\": \"boolean\",\n      \"description\": \"DEBE ser false si el proveedor detectado es distinto al que el usuario seleccionÃ³.\"\n    },\n    \"proveedor_nota\": {\n      \"type\": \"string\"\n    },\n    \"tipos_detectados\": {\n      \"type\": \"array\",\n      \"items\": {\n        \"type\": \"string\"\n      },\n      \"description\": \"Array con los tipos que realmente tienen evidencia en el doc.\"\n    },\n    \"tipos_validados\": {\n      \"type\": \"boolean\",\n      \"description\": \"DEBE ser false si el tipo seleccionado por el usuario no tiene evidencia clara en el PDF.\"\n    },\n    \"tipos_nota\": {\n      \"type\": \"string\"\n    },\n    \"razonamiento\": {\n      \"type\": \"string\"\n    }\n  },\n  \"required\": [\n    \"proyecto_detectado\",\n    \"proyecto_valido\",\n    \"proveedor_detectado\",\n    \"proveedor_valido\",\n    \"tipos_validados\",\n    \"razonamiento\"\n  ]\n}"
      },
      "type": "@n8n/n8n-nodes-langchain.outputParserStructured",
      "typeVersion": 1.3,
      "position": [
        -1328,
        3696
      ],
      "id": "5b8f5b90-6465-4162-a22c-bd00065b0446",
      "name": "Structured Output Parser4"
    },
    {
      "parameters": {
        "promptType": "define",
        "text": "=### TECHNICAL AND COMMERCIAL CLASSIFICATION (RFQ)\n\n### DOCUMENT SAMPLE (First 2 pages):\n{{ $json.texto_muestra }}\n\n---\n### CLASSIFICATION TASK:\nIdentify project, provider and evaluation types.\n\n**GOLDEN RULE FOR NOMENCLATURE:**\nYou must translate document titles to these exact names:\n- **\"Commercial Proposal\" / \"Oferta EconÃ³mica\"** â†’ MUST BE `Economical Evaluation`.\n- **\"Technical Proposal\" / \"Scope of Work\"** â†’ MUST BE `Technical Evaluation`.\n- **Document lists** â†’ `Pre-FEED Deliverables` or `FEED Deliverables` (depending on context).\n\n#### REQUIREMENTS:\n1. **PROVIDER**: Must be one of: IDOM, SENER, TRESCA, SACYR, TECNICASREUNIDAS, EA, WORLEY.\n2. **TYPES**: The `tipos_detectados` array can only contain the canonical names mentioned above.\n\n---\n### OUTPUT FORMAT (JSON):\n{\n  \"modo_usado\": \"CLASIFICADOR\",\n  \"proyecto_detectado\": \"Name\",\n  \"proveedor_detectado\": \"IDOM | SENER | TRESCA | SACYR | TECNICASREUNIDAS | EA | WORLEY\",\n  \"tipos_detectados\": [\"Technical Evaluation\", \"Economical Evaluation\"],\n  \"razonamiento\": \"Justification: 'Commercial Proposal' detected -> Economical Evaluation mapped.\"\n}",
        "hasOutputParser": true,
        "messages": {
          "messageValues": [
            {
              "message": "Identify the provider and evaluation types present in the document based only on the first pages."
            }
          ]
        },
        "batching": {}
      },
      "type": "@n8n/n8n-nodes-langchain.chainLlm",
      "typeVersion": 1.8,
      "position": [
        -1520,
        3936
      ],
      "id": "f4c11f92-fba5-48a6-b6c2-0df75615ccb3",
      "name": "Clasificador de Tipo de Evaluacion y Proveedor",
      "disabled": true
    },
    {
      "parameters": {
        "conditions": {
          "options": {
            "caseSensitive": true,
            "leftValue": "",
            "typeValidation": "strict",
            "version": 3
          },
          "conditions": [
            {
              "id": "267128b5-e2c0-44ae-9973-7f18dffe292e",
              "leftValue": "={{ $('Set File ID').item.json.proveedor }}",
              "rightValue": "",
              "operator": {
                "type": "string",
                "operation": "notEmpty",
                "singleValue": true
              }
            },
            {
              "id": "a9d65ff4-430e-45db-8ca8-6078e5ee32fa",
              "leftValue": "={{ $('Set File ID').item.json.evaluation[0] }}",
              "rightValue": "",
              "operator": {
                "type": "string",
                "operation": "notEmpty",
                "singleValue": true
              }
            },
            {
              "id": "d5c265e7-00e5-42f4-95ad-4eca1e3ef530",
              "leftValue": "={{ $('Set File ID').item.json.proyect_name }}",
              "rightValue": "",
              "operator": {
                "type": "string",
                "operation": "notEmpty",
                "singleValue": true
              }
            }
          ],
          "combinator": "and"
        },
        "options": {}
      },
      "type": "n8n-nodes-base.if",
      "typeVersion": 2.3,
      "position": [
        -1792,
        3696
      ],
      "id": "0bda1cc4-4af4-4ae1-9b57-62f81e87a519",
      "name": "If"
    },
    {
      "parameters": {
        "model": "qwen3:8b",
        "options": {
          "temperature": 0.1,
          "numCtx": 8192,
          "numPredict": 1536
        }
      },
      "type": "@n8n/n8n-nodes-langchain.lmOllama",
      "typeVersion": 1,
      "position": [
        -1808,
        3136
      ],
      "id": "5bd6292e-af91-4a26-acd2-420e798e6e74",
      "name": "Ollama Model1",
      "credentials": {
        "ollamaApi": {
          "id": "oS2Qqti9oVfsm8XZ",
          "name": "Ollama account"
        }
      }
    },
    {
      "parameters": {
        "model": "mistral:7b",
        "options": {
          "temperature": 0.1,
          "numCtx": 4096,
          "numPredict": 1024
        }
      },
      "type": "@n8n/n8n-nodes-langchain.lmOllama",
      "typeVersion": 1,
      "position": [
        -1568,
        4144
      ],
      "id": "230d5621-ec95-43e1-8919-4d7116cca952",
      "name": "Ollama Model",
      "credentials": {
        "ollamaApi": {
          "id": "oS2Qqti9oVfsm8XZ",
          "name": "Ollama account"
        }
      }
    },
    {
      "parameters": {
        "content": "### Ingesta de Ofertas de Proveedores",
        "height": 1776,
        "width": 4608,
        "color": 5
      },
      "type": "n8n-nodes-base.stickyNote",
      "typeVersion": 1,
      "position": [
        -5040,
        2544
      ],
      "id": "0d22e4bc-ab3d-4d2e-8b40-c9895cc36cf1",
      "name": "Sticky Note5"
    },
    {
      "parameters": {
        "batchSize": 50,
        "options": {
          "reset": "={{ $json.reiniciar_bucle ? true : false }}"
        }
      },
      "type": "n8n-nodes-base.splitInBatches",
      "typeVersion": 3,
      "position": [
        -3232,
        2928
      ],
      "id": "fe46fb8c-275b-4f03-8c9b-e3ed98b9df50",
      "name": "Loop Over Phases"
    },
    {
      "parameters": {
        "jsCode": "// =============================================\n// NODO: Parsear y Preparar Update (con merge inteligente)\n// =============================================\n\n// Valores que indican 'sin datos' - no deben sobreescribir datos reales\nconst NO_DATA_VALUES = new Set(['NO INFORMATION', 'NOT QUOTED', 'NO COTIZADO', 'SIN INFORMACIÃ“N', 'ERROR ANALISIS']);\n\n// 1. Obtener TODOS los items del LLM Chain\nconst allItems = $input.all();\nconsole.log(`ðŸ“¥ Procesando ${allItems.length} respuestas del LLM`);\n\n// 2. Obtener la lista de requisitos VÃLIDOS (para validar FK)\nlet validRequirements = [];\ntry {\n  const getRowsData = $('Get many rows1').all();\n  validRequirements = getRowsData.map(item => item.json.id);\n  console.log(`âœ… Lista de requisitos vÃ¡lidos: ${validRequirements.length} items`);\n} catch(e) {\n  console.error('âŒ Error obteniendo lista de requisitos vÃ¡lidos:', e.message);\n  return [];\n}\n\n// 3. Obtener el provider name (una sola vez, es el mismo para todos)\nlet providerName = \"OTROS\";\ntry {\n  providerName = $('Expandir por Tipo de EvaluaciÃ³n').first().json.proveedor_detectado || \"OTROS\";\n} catch(e) {\n  console.warn('âš ï¸ Error obteniendo provider, usando default:', e.message);\n}\n\n// 4. Procesar CADA respuesta del LLM\nconst resultados = [];\nlet skippedNoData = 0;\n\nfor (let i = 0; i < allItems.length; i++) {\n  try {\n    const item = allItems[i];\n    const itemData = item.json || item;\n\n    let rawText = itemData.text || itemData.output || \"\";\n\n    if (!rawText || typeof rawText !== 'string') {\n      console.warn(`âš ï¸ Item ${i}: No se encontrÃ³ campo 'text' o 'output'`);\n      continue;\n    }\n\n    let cleanText = rawText\n      .replace(/```json/g, '')\n      .replace(/```/g, '')\n      .trim();\n\n    let parsedData = null;\n\n    try {\n      const start = cleanText.indexOf('[');\n      const end = cleanText.lastIndexOf(']');\n\n      if (start >= 0 && end >= 0 && end > start) {\n        const jsonString = cleanText.substring(start, end + 1);\n        parsedData = JSON.parse(jsonString);\n      } else {\n        parsedData = JSON.parse(cleanText);\n      }\n    } catch (parseError) {\n      console.error(`âŒ Error parseando JSON del item ${i}:`, parseError.message);\n      console.error(`Texto recibido:`, cleanText.substring(0, 200));\n      continue;\n    }\n\n    const outputArray = Array.isArray(parsedData) ? parsedData : [parsedData];\n\n    for (let j = 0; j < outputArray.length; j++) {\n      const outputItem = outputArray[j];\n\n      if (!outputItem || typeof outputItem !== 'object') {\n        console.warn(`âš ï¸ Item ${i}.${j}: Elemento de salida no es objeto`);\n        continue;\n      }\n\n      const cumple = outputItem?.cumple || \"ERROR ANALISIS\";\n      const gap = outputItem?.gap_analysis || \"Check logs\";\n      const score = outputItem?.score !== undefined ? outputItem.score : 0;\n      const requirementId = outputItem?.id || null;\n\n      const validatedScore = Math.max(0, Math.min(10, parseInt(score) || 0));\n\n      if (!requirementId) {\n        console.error(`âŒ Item ${i}.${j}: No se encontrÃ³ ID del requisito en la respuesta del LLM`);\n        continue;\n      }\n\n      if (!validRequirements.includes(requirementId)) {\n        console.error(`âŒ Item ${i}.${j}: El requirement_id ${requirementId} NO existe en rfq_items_master. Saltando...`);\n        continue;\n      }\n\n      // MERGE INTELIGENTE: Filtrar items sin datos para no sobreescribir evaluaciones reales\n      if (NO_DATA_VALUES.has(cumple.toUpperCase())) {\n        skippedNoData++;\n        continue;\n      }\n\n      console.log(`âœ… Item ${i}.${j}: Requisito ${requirementId} - ${cumple} (${validatedScore}/10)`);\n\n      resultados.push({\n        json: {\n          requirement_id: requirementId,\n          provider_name: providerName,\n          evaluation_value: cumple,\n          comment: gap,\n          score: validatedScore\n        }\n      });\n    }\n\n  } catch (error) {\n    console.error(`âŒ Error procesando item ${i}:`, error.message);\n    continue;\n  }\n}\n\nconsole.log(`âœ… Procesados ${resultados.length} de ${allItems.length} items exitosamente (${skippedNoData} sin datos filtrados)`);\n\nreturn resultados;"
      },
      "id": "c3afc2e4-53fb-4d54-b4a8-21a9a4b3d2a8",
      "name": "Parsear y Preparar Update",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        -1280,
        2912
      ]
    },
    {
      "parameters": {
        "promptType": "define",
        "text": "=### GRUPO DE EVALUACIÃ“N\n- Tipo: {{ $json.evaluation_type }}\n- Total requisitos en este lote: {{ $json.total_requisitos }}\n- Lote: {{ $json.batch_index }} de {{ $json.total_batches }}\n\n### IDIOMA DE RESPUESTA: {{ $('Set File ID').first().json.language === 'en' ? 'ENGLISH' : 'ESPAÃ‘OL' }}\n**IMPORTANTE**: {{ $('Set File ID').first().json.language === 'en' ? 'Respond ALWAYS in English. All gap_analysis fields must be in English. Use labels: INCLUDED, PARTIALLY INCLUDED, NOT INCLUDED, NO INFORMATION.' : 'Responde SIEMPRE en espaÃ±ol. Todos los campos gap_analysis deben estar en espaÃ±ol. Usa etiquetas: INCLUIDO, PARCIALMENTE INCLUIDO, NO INCLUIDO, SIN INFORMACIÃ“N.' }}\n\n### TIPO DE PROYECTO: {{ $('Set File ID').first().json.project_type || 'RFP' }}\n{{ $('Set File ID').first().json.project_type === 'RFI' ? '**MODO RFI**: Este es un Request for Information. Evalua SOLO capacidad tecnica y experiencia. NO evalues precios ni condiciones economicas. Si encuentras informacion economica, ignorala.' : ($('Set File ID').first().json.project_type === 'RFQ' ? '**MODO RFQ**: Este es un Request for Quotation. PRIORIZA la evaluacion economica: precios, condiciones de pago, descuentos y competitividad. La evaluacion tecnica es secundaria.' : '**MODO RFP**: Evaluacion equilibrada tecnica + economica.') }}\n\n### REQUISITOS DEL RFQ (LISTA)\nA continuaciÃ³n los requisitos del RFQ a evaluar. Cada uno tiene un 'id' y un 'requirement_text' que describe lo que el proveedor debe cumplir.\n\n{{ JSON.stringify($json.requisitos, null, 2) }}\n\n### TEXTO COMPLETO DE LA PROPUESTA\n\n{{ $('Loop Over Items1').first().json.texto_oferta_completo }}\n---\n### TAREA\nPara CADA requisito, busca en el texto de la propuesta y determina si el proveedor lo aborda.\n\n### CRITERIOS DE EVALUACIÃ“N PARA REQUISITOS TÃ‰CNICOS:\n\n**INCLUIDO** - Usar cuando CUALQUIERA de estos aplique:\n- La propuesta menciona o aborda explÃ­citamente el requisito\n- La propuesta describe trabajo, metodologÃ­a o entregables que cubren este requisito\n- La propuesta referencia normas, estÃ¡ndares o cÃ³digos aplicables al requisito\n- La propuesta incluye este elemento en su alcance de trabajo, aunque lo describa de forma diferente\n- El requisito estÃ¡ cubierto implÃ­citamente por declaraciones mÃ¡s amplias (ej: 'servicios completos de ingenierÃ­a' cubre disciplinas individuales)\n\n**PARCIALMENTE INCLUIDO** - Usar cuando:\n- La propuesta menciona el tema pero con menos detalle o alcance del requerido\n- Solo parte del requisito estÃ¡ abordada\n- La propuesta lo menciona como opcional o condicional\n- Se describe trabajo relacionado pero no este elemento especÃ­fico\n\n**NO INCLUIDO** - Usar SOLO cuando:\n- NO hay menciÃ³n ni referencia a este requisito en ningÃºn lugar de la propuesta\n- La propuesta excluye explÃ­citamente este elemento\n- Tras bÃºsqueda exhaustiva, nada en la propuesta se relaciona con este requisito\n\n### GUÃAS IMPORTANTES DE MATCHING:\n- Busca coincidencias SEMÃNTICAS, no solo texto exacto. Las propuestas usan terminologÃ­a diferente al RFQ.\n- Una propuesta que dice 'entregaremos todos los documentos de ingenierÃ­a por disciplina' cubre requisitos individuales de documentos.\n- Considera que las propuestas a menudo agrupan elementos de forma diferente a como los lista el RFQ.\n- En caso de duda entre INCLUIDO y PARCIALMENTE INCLUIDO, elige INCLUIDO.\n- En caso de duda entre PARCIALMENTE INCLUIDO y NO INCLUIDO, elige PARCIALMENTE INCLUIDO.\n- Las propuestas reales tÃ­picamente abordan 60-80% de los requisitos. Si encuentras menos de 40% INCLUIDO, reconsidera tus criterios de matching.\n\n### PARA EVALUACIONES ECONÃ“MICAS - EXTRAER EL VALOR REAL:\n**CRÃTICO**: Para Ã­tems econÃ³micos, el campo 'cumple' debe contener el VALOR REAL encontrado, no una etiqueta.\n\nFormato del campo 'cumple':\n- Si se encuentra valor: \"[VALOR] [MONEDA/UNIDAD] - [DESCRIPCIÃ“N]\"\n  Ejemplos:\n  - \"84,3 EUR/h - TARIFA (Process, Mechanical, Piping)\"\n  - \"312.640,62 EUR - COTIZACIÃ“N BASE TOTAL PRE-FEED\"\n  - \"5.231,21 EUR - Estudio geotÃ©cnico - Confirmado\"\n\n- Si NO se encuentra valor: \"SIN INFORMACIÃ“N - [RAZÃ“N]\"\n\n### FORMATO DE SALIDA (JSON)\n[\n  {\n    \"id\": \"<id del requisito>\",\n    \"cumple\": \"{{ $('Set File ID').first().json.language === 'en' ? '[Technical: INCLUDED/PARTIALLY INCLUDED/NOT INCLUDED | Economic: VALUE or NO INFORMATION]' : '[TÃ©cnicos: INCLUIDO/PARCIALMENTE INCLUIDO/NO INCLUIDO | EconÃ³micos: VALOR o SIN INFORMACIÃ“N]' }}\",\n    \"gap_analysis\": \"{{ $('Set File ID').first().json.language === 'en' ? '[Brief quote or evidence from proposal in ENGLISH, or No mention found]' : '[Cita breve o evidencia de la propuesta EN ESPAÃ‘OL, o No se encontrÃ³ menciÃ³n]' }}\"\n  }\n]\n\nSolo JSON, sin explicaciones.",
        "messages": {
          "messageValues": [
            {
              "message": "=You are an expert procurement evaluator analyzing supplier proposals against RFQ/RFP requirements.\n\nLANGUAGE: {{ $('Set File ID').first().json.language === 'en' ? 'ENGLISH' : 'SPANISH' }}\n\nRULES:\n- For TECHNICAL: Use labels {{ $('Set File ID').first().json.language === 'en' ? 'INCLUDED, PARTIALLY INCLUDED, or NOT INCLUDED' : 'INCLUIDO, PARCIALMENTE INCLUIDO, or NO INCLUIDO' }}\n- For ECONOMICAL: Extract ACTUAL VALUES with currency/units. If no value found: '{{ $('Set File ID').first().json.language === 'en' ? 'NO INFORMATION' : 'SIN INFORMACIÃ“N' }}'\n- Look for SEMANTIC matches - proposals often use different terminology than the RFQ\n- Be thorough: search the ENTIRE proposal text for each requirement before marking NOT INCLUDED\n- A well-prepared proposal typically addresses most requirements. If your analysis shows very few INCLUDED, you may be matching too strictly.\n- ALL responses in {{ $('Set File ID').first().json.language === 'en' ? 'ENGLISH' : 'SPANISH' }}\n- JSON only\n- PROJECT TYPE: {{ $('Set File ID').first().json.project_type || 'RFP' }}. Adjust evaluation focus accordingly."
            }
          ]
        },
        "batching": {}
      },
      "type": "@n8n/n8n-nodes-langchain.chainLlm",
      "typeVersion": 1.7,
      "position": [
        -1728,
        2784
      ],
      "id": "0eac8021-b87f-495c-9626-64fdad3bd410",
      "name": "LLM Chain"
    },
    {
      "parameters": {
        "operation": "upsert",
        "schema": {
          "__rl": true,
          "mode": "list",
          "value": "public"
        },
        "table": {
          "__rl": true,
          "value": "document_metadata",
          "mode": "list",
          "cachedResultName": "document_metadata"
        },
        "columns": {
          "mappingMode": "defineBelow",
          "value": {
            "id": "={{ $('Set File ID').first().json.file_id }}",
            "title": "={{ $('Set File ID').item.json.file_title }}",
            "project_id": "={{ $('Set File ID').item.json.project_id }}",
            "evaluation_types": "={{ $('Set File ID').item.json.evaluation }}",
            "document_type": "PROPOSAL",
            "provider": "={{ $('Set File ID').item.json.proveedor }}"
          },
          "matchingColumns": [
            "id"
          ],
          "schema": [
            {
              "id": "id",
              "displayName": "id",
              "required": true,
              "defaultMatch": true,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            },
            {
              "id": "title",
              "displayName": "title",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            },
            {
              "id": "project_id",
              "displayName": "project_id",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            },
            {
              "id": "document_type",
              "displayName": "document_type",
              "required": true,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": false
            },
            {
              "id": "provider",
              "displayName": "provider",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": false
            },
            {
              "id": "evaluation_types",
              "displayName": "evaluation_types",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "array",
              "canBeUsedToMatch": true,
              "removed": false
            },
            {
              "id": "created_at",
              "displayName": "created_at",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "dateTime",
              "canBeUsedToMatch": true,
              "removed": false
            }
          ],
          "attemptToConvertTypes": false,
          "convertFieldsToString": false
        },
        "options": {}
      },
      "type": "n8n-nodes-base.postgres",
      "typeVersion": 2.5,
      "position": [
        -4032,
        3696
      ],
      "id": "5aa367ed-d202-43d7-91cd-ccd3783ad669",
      "name": "Insert Document Metadata",
      "executeOnce": true,
      "credentials": {
        "postgres": {
          "id": "V0REAPph5JBLqze3",
          "name": "Postgres account"
        }
      }
    },
    {
      "parameters": {
        "useCustomSchema": true,
        "operation": "delete",
        "tableId": "proposals",
        "filterType": "string",
        "filterString": "=metadata->>file_id=like.*{{ $json.file_id }}*"
      },
      "id": "43b84f8a-b35b-4136-a4b1-bd827b701457",
      "name": "Delete Old Doc Rows",
      "type": "n8n-nodes-base.supabase",
      "typeVersion": 1,
      "position": [
        -4240,
        3696
      ],
      "alwaysOutputData": true,
      "credentials": {
        "supabaseApi": {
          "id": "pI4CpdYLTiEEBmnz",
          "name": "Supabase account"
        }
      }
    },
    {
      "parameters": {
        "assignments": {
          "assignments": [
            {
              "id": "10646eae-ae46-4327-a4dc-9987c2d76173",
              "name": "file_id",
              "value": "={{ $json.body.file_id }}",
              "type": "string"
            },
            {
              "id": "77d782de-169d-4a46-8a8e-a3831c04d90f",
              "name": "file_title",
              "value": "={{ $json.body.file_title }}",
              "type": "string"
            },
            {
              "id": "9bde4d7f-e4f3-4ebd-9338-dce1350f9eab",
              "name": "file_url",
              "value": "={{ $json.body.file_url }}",
              "type": "string"
            },
            {
              "id": "b1dbe9b9-248a-4593-a769-a085b34e0810",
              "name": "file_binary",
              "value": "={{ $json.body.file_binary }}",
              "type": "string"
            },
            {
              "id": "74d93dce-cddc-4947-ae19-88bc5cacd146",
              "name": "file_metadata",
              "value": "={{ $json.body.metadata }}",
              "type": "string"
            },
            {
              "id": "5e43f8d4-b48e-4188-89c8-3723f184dbeb",
              "name": "proyect_name",
              "value": "={{ $json.body.metadata.proyecto }}",
              "type": "string"
            },
            {
              "id": "1093ebc6-8dd8-4c5d-b146-b6f01b069be6",
              "name": "proveedor",
              "value": "={{ $json.body.user_proveedor }}",
              "type": "string"
            },
            {
              "id": "6e0e6e2a-9b88-403e-aa0a-da0eecccd3f9",
              "name": "evaluation",
              "value": "={{ $json.body.metadata.tipoEvaluacion }}",
              "type": "array"
            },
            {
              "id": "project-id-uuid-field",
              "name": "project_id",
              "value": "={{ $json.body.project_id }}",
              "type": "string"
            },
            {
              "id": "language-field-001",
              "name": "language",
              "value": "={{ $json.body.language || 'es' }}",
              "type": "string"
            },
            {
              "id": "currency-field-001",
              "name": "currency",
              "value": "={{ $json.body.currency || 'EUR' }}",
              "type": "string"
            },
            {
              "id": "project-type-field-001",
              "name": "project_type",
              "value": "={{ $json.body.project_type || $json.body.metadata.project_type || 'RFP' }}",
              "type": "string"
            }
          ]
        },
        "options": {}
      },
      "id": "7864d7bf-7d9e-410a-969b-157aa91b0df4",
      "name": "Set File ID",
      "type": "n8n-nodes-base.set",
      "typeVersion": 3.4,
      "position": [
        -4432,
        3696
      ]
    },
    {
      "parameters": {
        "jsonMode": "expressionData",
        "jsonData": "={{ $json.text }}",
        "options": {
          "metadata": {
            "metadataValues": [
              {
                "name": "file_id",
                "value": "={{ $json.metadata.file_id }}"
              },
              {
                "name": "file_title",
                "value": "={{ $json.metadata.file_title }}"
              },
              {
                "name": "tipo_evaluacion",
                "value": "={{ $json.metadata.tipo_evaluacion }}"
              },
              {
                "name": "proveedor",
                "value": "={{ $json.metadata.proveedor }}"
              },
              {
                "name": "project_name",
                "value": "={{ $json.metadata.project_name }}"
              },
              {
                "name": "project_id",
                "value": "={{ $json.metadata.project_id }}"
              }
            ]
          }
        }
      },
      "id": "1ac19917-9b0e-412d-b500-a481221af5c6",
      "name": "Default Data Loader",
      "type": "@n8n/n8n-nodes-langchain.documentDefaultDataLoader",
      "typeVersion": 1,
      "position": [
        -816,
        4000
      ]
    },
    {
      "parameters": {
        "chunkSize": 1200,
        "chunkOverlap": 200,
        "options": {}
      },
      "type": "@n8n/n8n-nodes-langchain.textSplitterRecursiveCharacterTextSplitter",
      "typeVersion": 1,
      "position": [
        -912,
        4176
      ],
      "id": "7c8bf5d8-30eb-4e49-bfa5-7c9aa0384689",
      "name": "Recursive Character Text Splitter"
    },
    {
      "parameters": {
        "mode": "insert",
        "tableName": {
          "__rl": true,
          "value": "proposals",
          "mode": "list",
          "cachedResultName": "proposals"
        },
        "options": {
          "queryName": "match_proposals"
        }
      },
      "id": "8e56d1e8-f458-4204-9330-a1f5093b1c38",
      "name": "Insert into Supabase Vectorstore",
      "type": "@n8n/n8n-nodes-langchain.vectorStoreSupabase",
      "typeVersion": 1,
      "position": [
        -944,
        3680
      ],
      "credentials": {
        "supabaseApi": {
          "id": "pI4CpdYLTiEEBmnz",
          "name": "Supabase account"
        }
      },
      "disabled": true
    },
    {
      "parameters": {
        "jsCode": "// =============================================\n// NODO: Validar Contenido PDF (FIX PAGINACIÃ“N)\n// =============================================\n\nconst input = $input.first().json;\n\n// Variables de inicializaciÃ³n\nlet pages = [];\nlet totalChars = 0;\nlet hasTablesDetected = false;\n\n// --- 1. PROCESAMIENTO DEL TEXTO ---\n\n// CASO A: Viene desglosado por pÃ¡ginas (Array)\nif (input.pages && Array.isArray(input.pages) && input.pages.length > 0) {\n  pages = input.pages;\n  pages.forEach(page => {\n    const text = page.text || page.pageContent || \"\";\n    totalChars += text.length;\n    // DetecciÃ³n simple de tablas\n    if ((text.match(/\\s{4,}/g) || []).length > 5) hasTablesDetected = true;\n  });\n\n// CASO B: Viene todo el texto junto (String) - ESTE ES TU CASO ACTUAL\n} else if (input.text && typeof input.text === 'string') {\n  const text = input.text;\n  totalChars = text.length;\n  // Creamos una \"pÃ¡gina Ãºnica\" contenedora para no romper el flujo\n  pages = [{ text: text, pageNumber: 1 }];\n  \n  // Detectar tablas en el texto completo\n  if ((text.match(/\\s{4,}/g) || []).length > 20) hasTablesDetected = true;\n  \n} else {\n  // CASO C: VacÃ­o\n  pages = [];\n}\n\n// --- 2. CÃLCULO DE PÃGINAS REALES (FIX CRÃTICO) ---\n\n// Intentamos leer el metadato 'numpages' que se ve en tu captura\nlet realPageCount = input.numpages || input.numPages || input.numberOfPages || 0;\n\n// Si no existe el metadato, usamos la longitud del array (fallback)\nif (!realPageCount || realPageCount === 0) {\n    realPageCount = pages.length;\n}\n\n// Si sigue siendo 1 pero el texto es enorme (>10k chars), estimamos\nif (realPageCount <= 1 && totalChars > 10000) {\n    // EstimaciÃ³n conservadora: 3000 caracteres por pÃ¡gina tÃ©cnica\n    realPageCount = Math.ceil(totalChars / 3000);\n}\n\n// Evitar divisiÃ³n por cero\nrealPageCount = Math.max(1, realPageCount);\n\n\n// --- 3. MÃ‰TRICAS FINALES ---\n\nconst avgCharsPerPage = totalChars / realPageCount;\n\n// CRITERIO: Â¿Necesita OCR?\n// Si hay texto (< 100 chars/pag) es probable que sea escaneado.\nconst needsOCR = avgCharsPerPage < 100; \n\n// Metadatos\nlet fileId = \"unknown\";\nlet fileTitle = \"unknown\";\ntry {\n  const metaNode = $('Set File ID').first().json;\n  fileId = metaNode.file_id;\n  fileTitle = metaNode.file_title;\n} catch (e) {}\n\n// --- LOGGING ---\nconsole.log(`ðŸ“„ AnÃ¡lisis: ${fileTitle}`);\nconsole.log(`   â”œâ”€ PÃ¡ginas (Metadato): ${input.numpages}`); \nconsole.log(`   â”œâ”€ PÃ¡ginas (Usadas): ${realPageCount}`);\nconsole.log(`   â”œâ”€ Caracteres Totales: ${totalChars}`);\nconsole.log(`   â”œâ”€ Promedio/PÃ¡g: ${Math.round(avgCharsPerPage)}`);\n\nreturn {\n  json: {\n    // MÃ©tricas corregidas\n    totalPages: realPageCount, // Ahora dirÃ¡ 235\n    totalChars: totalChars,\n    avgCharsPerPage: Math.round(avgCharsPerPage), // Ahora serÃ¡ un nÃºmero razonable (~2800)\n    hasTables: hasTablesDetected,\n    needsOCR: needsOCR,\n    \n    // Contenido\n    pages: pages, \n    \n    // Metadatos\n    fileId: fileId,\n    fileName: fileTitle\n  }\n};"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        -3360,
        3696
      ],
      "id": "32a40b62-2b01-4f5d-885a-86cda660bbaf",
      "name": "Validar Contenido PDF"
    },
    {
      "parameters": {
        "operation": "pdf",
        "options": {}
      },
      "type": "n8n-nodes-base.extractFromFile",
      "typeVersion": 1.1,
      "position": [
        -3632,
        3696
      ],
      "id": "365899f7-9c01-4ba0-b348-d3427fa3b7ab",
      "name": "Extract from File"
    },
    {
      "parameters": {
        "conditions": {
          "options": {
            "caseSensitive": true,
            "leftValue": "",
            "typeValidation": "strict",
            "version": 3
          },
          "conditions": [
            {
              "id": "57b9c551-9997-4ed5-8ddd-f80c108a177c",
              "leftValue": "={{ $json.needsOCR }}",
              "rightValue": "",
              "operator": {
                "type": "boolean",
                "operation": "true",
                "singleValue": true
              }
            }
          ],
          "combinator": "and"
        },
        "options": {}
      },
      "type": "n8n-nodes-base.if",
      "typeVersion": 2.3,
      "position": [
        -3072,
        3696
      ],
      "id": "4d22ea07-4314-4dc0-8823-5f481448fe30",
      "name": "Â¿Necesita OCR?"
    },
    {
      "parameters": {
        "jsCode": "// =============================================\n// NODO: Aggregate OCR Pages (CORREGIDO)\n// =============================================\n\nconst items = $input.all();\nlet fullText = \"\";\nlet pagesArray = [];\n\n// OPCIÃ“N A: Si Tesseract devuelve mÃºltiples items (1 por pÃ¡gina)\nif (items.length > 1) {\n  items.forEach((item, idx) => {\n    const pageText = item.json.text || \"\";\n    fullText += pageText + \"\\n\\n\";\n    \n    // Construimos array compatible con vectorstore\n    pagesArray.push({\n      text: pageText,\n      pageNumber: idx + 1\n    });\n  });\n}\n// OPCIÃ“N B: Si Tesseract devuelve un solo item con todo el texto\nelse if (items.length === 1) {\n  fullText = items[0].json.text || \"\";\n  pagesArray = [{\n    text: fullText,\n    pageNumber: 1\n  }];\n}\n\n// RECUPERAR METADATOS ORIGINALES (CRÃTICO)\nlet fileId, fileName, proveedor;\ntry {\n  fileId = $('Set File ID').first().json.file_id;\n  fileName = $('Set File ID').first().json.file_title;\n  proveedor = $('Set File ID').first().json.proveedor || \"OTROS\";\n} catch (e) {\n  console.error(\"âš ï¸ No se pudieron recuperar metadatos:\", e.message);\n  fileId = \"unknown\";\n  fileName = \"unknown\";\n  proveedor = \"OTROS\";\n}\n\nconsole.log(`ðŸ”„ OCR Agregado: ${items.length} pÃ¡ginas â†’ ${fullText.length} caracteres`);\n\n// ESTRUCTURA COMPATIBLE CON VECTORSTORE\nreturn {\n  json: {\n    pages: pagesArray, // â† Array de pÃ¡ginas (requerido por Default Data Loader)\n    text: fullText, // â† Texto completo (backup)\n    \n    // Metadatos crÃ­ticos\n    file_id: fileId,\n    file_title: fileName,\n    proveedor: proveedor,\n    \n    // Marca de origen\n    origen_datos: \"OCR_TESSERACT\",\n    ocr_pages_processed: items.length,\n    ocr_total_chars: fullText.length\n  }\n};"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        -2432,
        3584
      ],
      "id": "1b6b1f29-5f2a-4ef3-a427-9e639995ae9e",
      "name": "Aggregate OCR Pages"
    },
    {
      "parameters": {
        "jsCode": "// =============================================\n// NODO: Preparar Texto de Muestra (STRICT LIMIT)\n// =============================================\n\nconst items = $input.all();\n\nreturn items.map(item => {\n    let texto_muestra = \"SIN TEXTO\";\n\n    try {\n        if (item.json.pages && Array.isArray(item.json.pages) && item.json.pages.length > 0) {\n            // Unimos las 2 primeras pÃ¡ginas pero limitamos el total a 3000 caracteres\n            let rawJoin = item.json.pages.slice(0, 2).map(p => p.text || \"\").join(\"\\n\\n\");\n            texto_muestra = rawJoin.substring(0, 3000);\n        } else {\n            // Fallback extremadamente corto para texto plano\n            texto_muestra = (item.json.text || \"\").substring(0, 500);\n        }\n    } catch (e) {\n        console.error(\"Error al procesar pÃ¡ginas:\", e);\n    }\n\n    return {\n        json: {\n            ...item.json,\n            texto_muestra: texto_muestra\n        }\n    };\n});"
      },
      "id": "ac7112f4-be51-407f-b160-b02028c352ff",
      "name": "Preparar Texto de Muestra",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        -1984,
        3696
      ]
    },
    {
      "parameters": {
        "jsCode": "// =============================================\n// NODO: Format for Vectorstore (v3 - DIRECTO DEL USUARIO)\n// SIN clasificador ni validador LLM\n// =============================================\n\n// 1. RECUPERAR CONTENIDO\nlet fullText = \"\";\nlet totalPages = 1;\n\ntry {\n    const mergeData = $('Merge1').first().json;\n    if (mergeData.pages && mergeData.pages[0]) {\n        fullText = mergeData.pages.slice(0, 2).map(p => p.text || \"\").join(\"\\n\\n\");\n    } else {\n        fullText = mergeData.text || \"\";\n    }\n    totalPages = mergeData.totalPages || 1;\n} catch (e) {\n    console.log(\"âŒ Error leyendo de Merge1\");\n}\n\n// 2. USAR DIRECTAMENTE DATOS DEL USUARIO (Set File ID)\nlet fileId = \"unknown\";\nlet fileTitle = \"unknown\";\nlet proveedor = \"OTROS\";\nlet tipoEval = [\"Technical Evaluation\"];\nlet proyecto = \"\";\nlet projectId = null;\n\ntry {\n    const fileNode = $('Set File ID').first().json;\n    fileId = fileNode.file_id || \"unknown\";\n    fileTitle = fileNode.file_title || \"unknown\";\n    proveedor = fileNode.proveedor || \"OTROS\";\n    proyecto = fileNode.proyect_name || \"\";\n    projectId = fileNode.project_id || null;\n    \n    if (fileNode.evaluation && Array.isArray(fileNode.evaluation) && fileNode.evaluation.length > 0) {\n        tipoEval = fileNode.evaluation;\n    } else if (fileNode.evaluation && typeof fileNode.evaluation === 'string') {\n        tipoEval = [fileNode.evaluation];\n    }\n} catch(e) {\n    console.log(\"âŒ Error leyendo Set File ID\");\n}\n\n// 3. GENERAR SALIDA\nreturn {\n    json: {\n        text: fullText,\n        metadata: {\n            file_id: fileId,\n            file_title: fileTitle,\n            proveedor: proveedor,\n            tipo_evaluacion: tipoEval,\n            project_name: proyecto,\n            project_id: projectId,\n            processed_at: new Date().toISOString(),\n            total_pages: totalPages\n        }\n    }\n};"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        -1120,
        3680
      ],
      "id": "a8702a4e-34d2-4c32-8244-b773f1e9059e",
      "name": "Format for Vectorstore"
    },
    {
      "parameters": {
        "jsCode": "// =============================================\n// NODO: Expandir por Tipo de EvaluaciÃ³n (v3 - DIRECTO DEL USUARIO)\n// SIN clasificador ni validador LLM - usa datos del usuario directamente\n// =============================================\n\n// 1. RECUPERAR TEXTO Y CONTENIDO BASE\nlet fullText = \"\";\nlet totalPages = 1;\ntry {\n    const mergeData = $('Merge1').first().json;\n    fullText = (mergeData.pages && mergeData.pages[0]) \n        ? mergeData.pages.slice(0, 2).map(p => p.text || \"\").join(\"\\n\\n\") \n        : (mergeData.text || \"\");\n    totalPages = mergeData.totalPages || 1;\n} catch (e) {\n    console.error(\"âŒ Error leyendo Merge1\");\n}\n\n// 2. USAR DIRECTAMENTE DATOS DEL USUARIO (Set File ID)\nlet fileId = \"unknown\";\nlet proveedor = \"OTROS\";\nlet tipoEval = [\"Technical Evaluation\"];\nlet projectName = \"proyecto_sin_especificar\";\n\ntry {\n    const fileData = $('Set File ID').first().json;\n    fileId = fileData.file_id || \"unknown\";\n    proveedor = fileData.proveedor || \"OTROS\";\n    projectName = fileData.proyect_name || \"proyecto_sin_especificar\";\n    \n    // Tipos de evaluaciÃ³n del usuario\n    if (fileData.evaluation && Array.isArray(fileData.evaluation) && fileData.evaluation.length > 0) {\n        tipoEval = fileData.evaluation;\n    } else if (fileData.evaluation && typeof fileData.evaluation === 'string') {\n        tipoEval = [fileData.evaluation];\n    }\n    \n    console.log(`âœ… Usando datos del usuario directamente:`);\n    console.log(`   Proveedor: ${proveedor}`);\n    console.log(`   Proyecto: ${projectName}`);\n    console.log(`   Tipos: ${JSON.stringify(tipoEval)}`);\n} catch (e) {\n    console.error(\"âŒ Error leyendo Set File ID:\", e.message);\n}\n\n// 3. NORMALIZAR TIPOS\nif (!Array.isArray(tipoEval)) tipoEval = [tipoEval];\ntipoEval = tipoEval.filter(t => t && t.trim() !== \"\");\nif (tipoEval.length === 0) tipoEval = [\"Technical Evaluation\"];\n\n// Normalizar tipos antiguos (Deliverables, FEED) a Others\ntipoEval = tipoEval.map(t => {\n    if (t === 'Technical Evaluation' || t === 'Economical Evaluation' || t === 'Others') return t;\n    if (t.includes('Deliverables') || t.includes('FEED')) return 'Others';\n    return t;\n});\ntipoEval = [...new Set(tipoEval)]; // Eliminar duplicados tras mapeo\n\n// 4. GENERAR FILAS\nreturn tipoEval.map((tipo, idx) => ({\n    json: {\n        tipo_evaluacion_actual: tipo,\n        proveedor_detectado: proveedor,\n        proyecto_nombre: projectName,\n        texto_oferta_completo: fullText,\n        indice_actual: idx + 1,\n        total_tipos: tipoEval.length,\n        file_id: fileId\n    }\n}));"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        -4784,
        2992
      ],
      "id": "930fc226-1714-4d7f-a206-9cadcb5cdc1c",
      "name": "Expandir por Tipo de EvaluaciÃ³n"
    },
    {
      "parameters": {
        "options": {}
      },
      "type": "n8n-nodes-base.splitInBatches",
      "typeVersion": 3,
      "position": [
        -4480,
        2912
      ],
      "id": "78c7e268-61af-42bf-a9f4-858a39588f28",
      "name": "Loop Over Items1"
    },
    {
      "parameters": {
        "method": "POST",
        "url": "https://unlaconic-ardelle-pretenceful.ngrok-free.dev/v1/convert/file",
        "sendBody": true,
        "contentType": "multipart-form-data",
        "bodyParameters": {
          "parameters": [
            {
              "parameterType": "formBinaryData",
              "name": "files",
              "inputDataFieldName": "data"
            }
          ]
        },
        "options": {
          "timeout": 300000
        }
      },
      "id": "51cc4ad7-0d6b-4ac2-bf4d-d8a377246303",
      "name": "Docling OCR",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.3,
      "position": [
        -2640,
        3488
      ],
      "retryOnFail": true
    },
    {
      "parameters": {
        "schemaType": "manual",
        "inputSchema": "{\n  \"type\": \"object\",\n  \"properties\": {\n    \"proveedor_detectado\": {\n      \"type\": \"string\",\n      \"description\": \"Nombre de la empresa proveedora (Ej: SACYR, IDOM, etc.)\"\n    },\n    \"tipos_detectados\": {\n      \"type\": \"array\",\n      \"items\": {\n        \"type\": \"string\",\n        \"enum\": [\n          \"Technical Evaluation\",\n          \"Economical Evaluation\",\n          \"Pre-FEED Deliverables\",\n          \"FEED Deliverables\"\n        ]\n      },\n      \"description\": \"Lista de tipos de oferta detectados en el documento.\"\n    },\n    \"razonamiento\": {\n      \"type\": \"string\",\n      \"description\": \"Breve explicaciÃ³n de por quÃ© se eligieron esos tipos.\"\n    }\n  },\n  \"required\": [\n    \"proveedor_detectado\",\n    \"tipos_detectados\"\n  ]\n}"
      },
      "type": "@n8n/n8n-nodes-langchain.outputParserStructured",
      "typeVersion": 1.3,
      "position": [
        -1328,
        4144
      ],
      "id": "64fc32c9-cdd0-4e1c-b972-d26456872ab8",
      "name": "Structured Output Parser"
    },
    {
      "parameters": {},
      "type": "n8n-nodes-base.merge",
      "typeVersion": 3.2,
      "position": [
        -2176,
        3696
      ],
      "id": "783a3452-9644-4427-bbb9-d047939ac2be",
      "name": "Merge1"
    },
    {
      "parameters": {
        "jsCode": "const items = $input.all();\n\nreturn items.map(item => ({\n    json: {\n        ...item.json, // Mantiene todos los datos originales (incluido tipo_evaluacion)\n        \n        // AquÃ­ estÃ¡ la correcciÃ³n: Usamos dos puntos, no el igual.\n        reiniciar_bucle: true \n    }\n}));\n"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        -3472,
        2864
      ],
      "id": "abcb46e0-f92b-41ed-81e3-ed368115e240",
      "name": "Reset Items"
    },
    {
      "parameters": {
        "respondWith": "allIncomingItems",
        "options": {}
      },
      "type": "n8n-nodes-base.respondToWebhook",
      "typeVersion": 1.5,
      "position": [
        -4032,
        2640
      ],
      "id": "2cb10625-949e-45c2-9029-6e29b1f03b79",
      "name": "Respond to Webhook"
    },
    {
      "parameters": {
        "httpMethod": "POST",
        "path": "ofertas",
        "responseMode": "responseNode",
        "options": {}
      },
      "type": "n8n-nodes-base.webhook",
      "typeVersion": 2.1,
      "position": [
        -4864,
        3696
      ],
      "id": "21c3654d-12a1-4f47-9a3e-094c56f79719",
      "name": "Webhook",
      "webhookId": "54339356-4e6d-4e22-9820-6e1e98e167a8"
    },
    {
      "parameters": {
        "jsCode": "// =============================================\n// NODO: Convertir Base64 a Binary Data (CORREGIDO v3)\n// =============================================\n\n// LEER DIRECTAMENTE DEL NODO \"Set File ID\"\nlet inputData;\ntry {\n    inputData = $('Set File ID').first().json;\n} catch (e) {\n    throw new Error(\"âŒ No se puede acceder al nodo 'Set File ID'\");\n}\n\nconst base64Data = inputData.file_binary;\n\n// --- VALIDACIÃ“N CRÃTICA ---\nif (!base64Data || base64Data === \"\") {\n    console.error(\"âŒ ERROR: file_binary estÃ¡ vacÃ­o\");\n    console.error(\"Datos en 'Set File ID':\", Object.keys(inputData));\n    console.error(\"file_id:\", inputData.file_id);\n    console.error(\"file_title:\", inputData.file_title);\n    \n    throw new Error(\n        \"âŒ CRÃTICO: 'file_binary' no existe en 'Set File ID'. \" +\n        \"Verifica la configuraciÃ³n del nodo.\"\n    );\n}\n\n// Validar que sea string\nif (typeof base64Data !== 'string') {\n    throw new Error(`âŒ ERROR: 'file_binary' debe ser string, es ${typeof base64Data}`);\n}\n\n// Logging\nconsole.log(\"âœ… file_binary recibido de 'Set File ID'\");\nconsole.log(`   â”œâ”€ Longitud: ${base64Data.length} caracteres`);\nconsole.log(`   â”œâ”€ Archivo: ${inputData.file_title}`);\n\n// Convertir base64 a binary\nlet binaryData;\ntry {\n    binaryData = Buffer.from(base64Data, 'base64');\n} catch (e) {\n    throw new Error(`âŒ ERROR decodificando base64: ${e.message}`);\n}\n\n// Validar tamaÃ±o\nif (binaryData.length === 0) {\n    throw new Error(\"âŒ ERROR: Archivo decodificado vacÃ­o (0 bytes)\");\n}\n\nconsole.log(`âœ… Binary generado: ${binaryData.length} bytes`);\n\n// Retornar formato n8n\nreturn {\n    json: {\n        file_id: inputData.file_id,\n        file_title: inputData.file_title,\n        file_url: inputData.file_url || \"unknown\"\n    },\n    binary: {\n        data: {\n            data: binaryData.toString('base64'),\n            mimeType: 'application/pdf',\n            fileName: inputData.file_title || 'document.pdf',\n            fileSize: binaryData.length\n        }\n    }\n};"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        -3856,
        3696
      ],
      "id": "6c98cc27-b096-405a-8583-ea2e57cf050e",
      "name": "Base64 a Binary"
    },
    {
      "parameters": {
        "jsCode": "// =============================================\n// NODO: Convertir Base64 a Binary Data (CORREGIDO v3)\n// =============================================\n\n// LEER DIRECTAMENTE DEL NODO \"Set File ID\"\nlet inputData;\ntry {\n    inputData = $('Set File ID').first().json;\n} catch (e) {\n    throw new Error(\"âŒ No se puede acceder al nodo 'Set File ID'\");\n}\n\nconst base64Data = inputData.file_binary;\n\n// --- VALIDACIÃ“N CRÃTICA ---\nif (!base64Data || base64Data === \"\") {\n    console.error(\"âŒ ERROR: file_binary estÃ¡ vacÃ­o\");\n    console.error(\"Datos en 'Set File ID':\", Object.keys(inputData));\n    console.error(\"file_id:\", inputData.file_id);\n    console.error(\"file_title:\", inputData.file_title);\n    \n    throw new Error(\n        \"âŒ CRÃTICO: 'file_binary' no existe en 'Set File ID'. \" +\n        \"Verifica la configuraciÃ³n del nodo.\"\n    );\n}\n\n// Validar que sea string\nif (typeof base64Data !== 'string') {\n    throw new Error(`âŒ ERROR: 'file_binary' debe ser string, es ${typeof base64Data}`);\n}\n\n// Logging\nconsole.log(\"âœ… file_binary recibido de 'Set File ID'\");\nconsole.log(`   â”œâ”€ Longitud: ${base64Data.length} caracteres`);\nconsole.log(`   â”œâ”€ Archivo: ${inputData.file_title}`);\n\n// Convertir base64 a binary\nlet binaryData;\ntry {\n    binaryData = Buffer.from(base64Data, 'base64');\n} catch (e) {\n    throw new Error(`âŒ ERROR decodificando base64: ${e.message}`);\n}\n\n// Validar tamaÃ±o\nif (binaryData.length === 0) {\n    throw new Error(\"âŒ ERROR: Archivo decodificado vacÃ­o (0 bytes)\");\n}\n\nconsole.log(`âœ… Binary generado: ${binaryData.length} bytes`);\n\n// Retornar formato n8n\nreturn {\n    json: {\n        file_id: inputData.file_id,\n        file_title: inputData.file_title,\n        file_url: inputData.file_url || \"unknown\"\n    },\n    binary: {\n        data: {\n            data: binaryData.toString('base64'),\n            mimeType: 'application/pdf',\n            fileName: inputData.file_title || 'document.pdf',\n            fileSize: binaryData.length\n        }\n    }\n};"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        -2848,
        3584
      ],
      "id": "26da4a8e-8198-4707-ad71-165e8f2f3155",
      "name": "Base64 a Binary1"
    },
    {
      "parameters": {
        "jsCode": "// =============================================\n// NODO: Generate Stable ID + Detectar Modo (NOMBRES CORRECTOS)\n// =============================================\n\nfunction simpleHash(str) {\n  let hash = 0;\n  for (let i = 0; i < str.length; i++) {\n    const char = str.charCodeAt(i);\n    hash = ((hash << 5) - hash) + char;\n    hash = hash & hash;\n  }\n  return Math.abs(hash).toString(16).padStart(16, '0').substring(0, 16);\n}\n\nconst body = $json.body;\n\n// CAMPOS EXISTENTES\nconst originalFileId = body.file_id || \"unknown\";\nconst fileTitle = body.file_title || \"unknown.pdf\";\nconst fileBinary = body.file_binary || \"\";\nconst fileUrl = body.file_url || \"unknown\";\n\n// âœ… EXTRAER METADATA DEL USUARIO (NOMBRES CORRECTOS)\nconst metadata = body.metadata || {};\nconst projectType = body.project_type || metadata.project_type || 'RFP';\nconst rfqProjectId = metadata.proyect_name || null;        // â† proyect_name\nconst userProveedor = metadata.proveedor || null;          // â† proveedor\nconst userTipoEval = metadata.evaluation || null;          // â† evaluation (Array)\n\n// âœ… DETERMINAR MODO DE OPERACIÃ“N\nlet modoOperacion = \"CLASIFICADOR\"; // Por defecto\nlet datosCompletos = false;\n\n// Verificar si tiene datos suficientes para VALIDACIÃ“N\nif (userProveedor && userTipoEval && Array.isArray(userTipoEval) && userTipoEval.length > 0) {\n    modoOperacion = \"VALIDADOR\";\n    datosCompletos = true;\n} else if (userProveedor || (userTipoEval && Array.isArray(userTipoEval) && userTipoEval.length > 0)) {\n    modoOperacion = \"HIBRIDO\"; // Tiene algunos datos pero no todos\n}\n\n// Generar ID estable del archivo (incluye project_id para evitar colisiones entre proyectos)\nconst projectId = body.project_id || metadata.project_id || '';\nconst normalizedTitle = fileTitle.toLowerCase().trim();\nconst stableId = simpleHash(normalizedTitle + '_' + projectId);\n\n// LOGGING\nconsole.log(\"=== ANÃLISIS DE METADATA ===\");\nconsole.log(`Modo OperaciÃ³n: ${modoOperacion}`);\nconsole.log(`RFQ Project Name: ${rfqProjectId || 'No especificado'}`);\nconsole.log(`Proveedor (Usuario): ${userProveedor || 'No especificado'}`);\nconsole.log(`Evaluation (Usuario): ${JSON.stringify(userTipoEval) || 'No especificado'}`);\nconsole.log(`Datos Completos: ${datosCompletos}`);\nconsole.log(`Original ID: ${originalFileId}`);\nconsole.log(`Nombre archivo: ${fileTitle}`);\nconsole.log(`ID ESTABLE generado: ${stableId}`);\n\n// RETORNO\nreturn {\n  json: {\n    // Datos directos en raÃ­z\n    file_id: stableId,\n    file_id_original: originalFileId,\n    file_title: fileTitle,\n    file_binary: fileBinary,\n    file_url: fileUrl,\n    \n    rfq_project_id: rfqProjectId || \"proyecto_sin_especificar\",\n    user_proveedor: userProveedor,\n    user_tipo_evaluacion: userTipoEval,\n    modo_operacion: modoOperacion,\n    project_type: projectType,\n    datos_usuario_completos: datosCompletos,\n    \n    // Mantener body completo\n    body: {\n      ...body,\n      file_id: stableId,\n      file_id_original: originalFileId,\n      rfq_project_id: rfqProjectId || \"proyecto_sin_especificar\",\n      user_proveedor: userProveedor,\n      user_tipo_evaluacion: userTipoEval,\n      modo_operacion: modoOperacion,\n      datos_usuario_completos: datosCompletos,\n      project_type: projectType\n    }\n  }\n};"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        -4624,
        3696
      ],
      "id": "311df87b-76a1-4951-a7a5-07a860156cad",
      "name": "Code in JavaScript1"
    },
    {
      "parameters": {
        "operation": "upsert",
        "schema": {
          "__rl": true,
          "mode": "list",
          "value": "public"
        },
        "table": {
          "__rl": true,
          "value": "provider_responses",
          "mode": "list",
          "cachedResultName": "provider_responses"
        },
        "columns": {
          "mappingMode": "defineBelow",
          "value": {
            "provider_name": "={{ $json.provider_name }}",
            "evaluation_value": "={{ $json.evaluation_value }}",
            "comment": "={{ $json.comment }}",
            "requirement_id": "={{ $json.requirement_id }}",
            "file_id": "={{ $('Set File ID').first().json.file_id }}",
            "project_id": "={{ $('Set File ID').first().json.project_id }}",
            "updated_at": "={{ $now }}"
          },
          "matchingColumns": [
            "provider_name",
            "requirement_id"
          ],
          "schema": [
            {
              "id": "id",
              "displayName": "id",
              "required": false,
              "defaultMatch": true,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": true
            },
            {
              "id": "requirement_id",
              "displayName": "requirement_id",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": false
            },
            {
              "id": "provider_name",
              "displayName": "provider_name",
              "required": true,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": false
            },
            {
              "id": "evaluation_value",
              "displayName": "evaluation_value",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": false
            },
            {
              "id": "comment",
              "displayName": "comment",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": false
            },
            {
              "id": "file_id",
              "displayName": "file_id",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": false
            },
            {
              "id": "updated_at",
              "displayName": "updated_at",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "dateTime",
              "canBeUsedToMatch": false
            },
            {
              "id": "project_id",
              "displayName": "project_id",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": false
            },
            {
              "id": "score",
              "displayName": "score",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "number",
              "canBeUsedToMatch": false,
              "removed": true
            }
          ],
          "attemptToConvertTypes": false,
          "convertFieldsToString": false
        },
        "options": {}
      },
      "type": "n8n-nodes-base.postgres",
      "typeVersion": 2.6,
      "position": [
        -768,
        3136
      ],
      "id": "7d621a58-e9d5-47b5-9a98-14d3183ba18a",
      "name": "Insert or update rows in a table",
      "credentials": {
        "postgres": {
          "id": "V0REAPph5JBLqze3",
          "name": "Postgres account"
        }
      }
    },
    {
      "parameters": {
        "jsCode": "// =============================================\n// NODO: Preparar Todo para LLM (SIN RAG, SIN FASES)\n// Pasa TODOS los requisitos directamente al LLM\n// =============================================\n\nconst items = $input.all();\n\nconsole.log('ðŸ“¥ Requisitos recibidos:', items.length);\n\n// Obtener texto completo de la oferta desde Loop Over Items1\nlet textoOfertaCompleto = \"\";\nlet evaluationType = \"Technical Evaluation\";\n\ntry {\n    const loopData = $('Loop Over Items1').first().json;\n    textoOfertaCompleto = loopData.texto_oferta_completo || \"\";\n    evaluationType = loopData.tipo_evaluacion_actual || \"Technical Evaluation\";\n    console.log('âœ… Datos obtenidos de Loop Over Items1');\n    console.log('   â”œâ”€ Tipo evaluaciÃ³n:', evaluationType);\n    console.log('   â””â”€ Texto oferta:', textoOfertaCompleto.length, 'chars');\n} catch(e) {\n    console.warn('âš ï¸ No se pudo obtener texto de oferta de Loop Over Items1:', e.message);\n    // Fallback: intentar obtener de otro lugar\n    try {\n        const expandirData = $('Expandir por Tipo de EvaluaciÃ³n').first().json;\n        textoOfertaCompleto = expandirData.texto_oferta_completo || \"\";\n        evaluationType = expandirData.tipo_evaluacion_actual || \"Technical Evaluation\";\n        console.log('âœ… Fallback: Datos obtenidos de Expandir por Tipo de EvaluaciÃ³n');\n    } catch(e2) {\n        console.error('âŒ No se pudo obtener texto de ningÃºn nodo');\n    }\n}\n\n// Formatear TODOS los requisitos (sin batching)\nconst todosLosRequisitos = items.map(item => ({\n    id: item.json.id || \"\",\n    requirement_text: item.json.requirement_text || item.json.text || \"NO ESPECIFICADO\",\n    evaluation_type: item.json.evaluation_type || evaluationType\n}));\n\nconsole.log('ðŸ“‹ PreparaciÃ³n directa (sin RAG ni fases):');\nconsole.log('   â”œâ”€ Total requisitos:', todosLosRequisitos.length);\nconsole.log('   â”œâ”€ Tipo evaluaciÃ³n:', evaluationType);\nconsole.log('   â””â”€ TamaÃ±o texto oferta:', textoOfertaCompleto.length, 'chars');\n\n// Retornar UN SOLO item con TODOS los requisitos\nreturn [{\n    json: {\n        evaluation_type: evaluationType,\n        requisitos: todosLosRequisitos,\n        total_requisitos: todosLosRequisitos.length,\n        batch_index: 1,\n        total_batches: 1,\n        context: textoOfertaCompleto,\n        texto_length: textoOfertaCompleto.length\n    }\n}];"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        -2720,
        2784
      ],
      "id": "a3926ce6-5a2a-4a81-b3ac-5c15ec53800a",
      "name": "Preparar Todo para LLM1"
    },
    {
      "parameters": {
        "conditions": {
          "options": {
            "caseSensitive": false,
            "leftValue": ""
          },
          "conditions": [
            {
              "id": "check-has-economic-type",
              "leftValue": "={{ ($('Set File ID').first().json.evaluation || []).join(',').toLowerCase() }}",
              "rightValue": "econom",
              "operator": {
                "type": "string",
                "operation": "contains"
              }
            },
            {
              "id": "check-not-rfi-type",
              "leftValue": "={{ $('Set File ID').first().json.project_type || 'RFP' }}",
              "rightValue": "RFI",
              "operator": {
                "type": "string",
                "operation": "notEquals"
              }
            }
          ],
          "combinator": "and"
        },
        "options": {}
      },
      "type": "n8n-nodes-base.if",
      "typeVersion": 2.2,
      "position": [
        -2416,
        2544
      ],
      "id": "5bafc326-7995-44a6-9983-60e0cbea1b64",
      "name": "Has Economic Evaluation?"
    },
    {
      "parameters": {
        "content": "## Economic Data Extraction (T8)\n\nExtracts structured economic/financial data from supplier proposals.\nOnly triggered when the offer includes Economical Evaluation type.\n\n**Flow**: Merge1 -> IF (Has Economic?) -> Check If Economic -> Extract Economic Data (LLM) -> Parse Economic JSON -> Save Economic Offer (Supabase UPSERT)\n\n**Target table**: economic_offers (project_id, provider_name unique constraint)",
        "height": 520,
        "width": 2500,
        "color": 5
      },
      "type": "n8n-nodes-base.stickyNote",
      "typeVersion": 1,
      "position": [
        -2496,
        2224
      ],
      "id": "93ff82f0-1536-4e54-95db-11d0fa514fdf",
      "name": "Sticky Note Economic"
    },
    {
      "parameters": {
        "jsCode": "// =============================================\n// NODE: Check If Economic Offer\n// Determines if this supplier proposal contains economic/pricing data\n// and prepares text for LLM extraction.\n// =============================================\n\n// Get the merged proposal data\nconst mergeData = $input.first().json;\n\n// Get metadata from Set File ID\nlet providerName = 'UNKNOWN';\nlet projectId = null;\nlet projectName = '';\nlet evaluationTypes = [];\n\ntry {\n    const fileData = $('Set File ID').first().json;\n    providerName = fileData.proveedor || 'UNKNOWN';\n    projectId = fileData.project_id || null;\n    projectName = fileData.proyect_name || '';\n    \n    if (fileData.evaluation && Array.isArray(fileData.evaluation)) {\n        evaluationTypes = fileData.evaluation;\n    } else if (fileData.evaluation && typeof fileData.evaluation === 'string') {\n        evaluationTypes = [fileData.evaluation];\n    }\n} catch (e) {\n    console.log('Warning: Could not read Set File ID:', e.message);\n}\n\n// Check if evaluation types include economic\nconst hasEconomic = evaluationTypes.some(t => \n    t.toLowerCase().includes('econom') || \n    t.toLowerCase().includes('commercial') ||\n    t.toLowerCase().includes('pricing')\n);\n\n// Also check text content for economic indicators as fallback\nlet fullText = '';\ntry {\n    if (mergeData.pages && Array.isArray(mergeData.pages)) {\n        fullText = mergeData.pages.map(p => p.text || '').join('\\n\\n');\n    } else {\n        fullText = mergeData.text || '';\n    }\n} catch (e) {\n    fullText = '';\n}\n\n// Economic indicators in text\nconst economicKeywords = ['total price', 'precio total', 'price breakdown', 'desglose', \n    'payment terms', 'condiciones de pago', 'discount', 'descuento', 'EUR/h', 'USD/h',\n    'lump sum', 'suma alzada', 'cost estimate', 'presupuesto', 'budget',\n    'fee schedule', 'tarifa', 'quotation', 'cotizacion', 'oferta economica',\n    'commercial proposal', 'propuesta economica', 'pricing schedule'];\n\nconst textLower = fullText.substring(0, 50000).toLowerCase();\nconst textHasEconomic = economicKeywords.some(kw => textLower.includes(kw));\n\nconst shouldExtract = hasEconomic || textHasEconomic;\n\nconsole.log(`Economic Check:`);\nconsole.log(`  Provider: ${providerName}`);\nconsole.log(`  Project ID: ${projectId}`);\nconsole.log(`  Eval types: ${JSON.stringify(evaluationTypes)}`);\nconsole.log(`  Has economic type: ${hasEconomic}`);\nconsole.log(`  Text has economic keywords: ${textHasEconomic}`);\nconsole.log(`  Should extract: ${shouldExtract}`);\n\nif (!shouldExtract) {\n    console.log('Skipping economic extraction - no economic content detected');\n    return [];\n}\n\n// Limit text to ~60k chars for LLM context\nconst textForExtraction = fullText.substring(0, 60000);\n\nreturn [{\n    json: {\n        provider_name: providerName,\n        project_id: projectId,\n        project_name: projectName,\n        proposal_text: textForExtraction,\n        text_length: fullText.length,\n        evaluation_types: evaluationTypes\n    }\n}];"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        -2176,
        2544
      ],
      "id": "07875367-9462-43c4-9628-4d3ba00ef0f4",
      "name": "Check If Economic Offer"
    },
    {
      "parameters": {
        "promptType": "define",
        "text": "=### PROPUESTA DE PROVEEDOR - EXTRACCIÃ“N DE DATOS ECONÃ“MICOS\n\n## TIPO DE PROYECTO: {{ $('Set File ID').first().json.project_type || 'RFP' }}\n{{ $('Set File ID').first().json.project_type === 'RFQ' ? 'PRIORIDAD MAXIMA: Extrae TODOS los datos economicos con el mayor detalle posible. Busca desglose por partida, condiciones de pago, descuentos, penalizaciones y cualquier informacion financiera.' : 'Extrae los datos economicos disponibles.' }}\n\n## PROYECTO: {{ $json.project_name }}\n## PROVEEDOR: {{ $json.provider_name }}\n\n### TEXTO DE LA PROPUESTA:\n{{ $json.proposal_text }}\n\n---\n### INSTRUCCIONES:\nExtrae TODOS los datos econÃ³micos y financieros de esta propuesta de proveedor.\nDevuelve SOLO un objeto JSON vÃ¡lido. NO incluyas bloques de cÃ³digo markdown.\nSi un campo no se encuentra en el texto, usa null.\n\n**IDIOMA**: {{ $('Set File ID').first().json.language === 'en' ? 'All text fields (payment_terms, discount_conditions, price_escalation, guarantees, raw_notes, descriptions) must be in ENGLISH.' : 'Todos los campos de texto (payment_terms, discount_conditions, price_escalation, guarantees, raw_notes, descripciones) deben estar en ESPAÃ‘OL.' }}\n\nPara total_price, busca el importe total de la oferta, suma alzada o coste total.\nPara price_breakdown, extrae partidas, coste por disciplina o coste por fase.\nPara payment_terms, busca condiciones de pago (% anticipo, hitos, plazos, etc.).\n\nDevuelve SOLO JSON vÃ¡lido comenzando con { y terminando con }.",
        "messages": {
          "messageValues": [
            {
              "message": "You are an expert procurement analyst specializing in extracting economic and financial data from supplier proposals for large-scale industrial projects (EPC, P2X, Green Hydrogen, Energy).\n\n### TASK\nExtract all economic/financial data from the supplier proposal text.\n\n### OUTPUT SCHEMA (return ONLY this JSON structure):\n{\n  \"total_price\": <number or null>,\n  \"currency\": \"<ISO 4217 code, default {{ $('Set File ID').first().json.currency || 'EUR' }}>\",\n  \"price_breakdown\": <object with line items like {\"engineering\": X, \"procurement\": Y, \"construction\": Z} or null>,\n  \"discount_percentage\": <number, 0 if none>,\n  \"discount_conditions\": <string or null>,\n  \"tco_value\": <number or null>,\n  \"tco_period_years\": <number or null>,\n  \"tco_breakdown\": <object like {\"capex\": X, \"opex_annual\": Y} or null>,\n  \"payment_terms\": <string describing terms like \"Net 60\" or \"30/40/30\" or null>,\n  \"payment_schedule\": <array of {\"milestone\": \"percentage\", \"event\": \"description\"} or null>,\n  \"validity_days\": <number, default 90>,\n  \"price_escalation\": <string describing escalation clauses or null>,\n  \"guarantees\": <string describing financial/performance guarantees or null>,\n  \"insurance_included\": <boolean>,\n  \"taxes_included\": <boolean>,\n  \"optional_items\": <array of {\"description\": \"X\", \"price\": Y} or null>,\n  \"alternative_offers\": <array of {\"description\": \"X\", \"total_price\": Y, \"details\": \"...\"} or null>,\n  \"extraction_confidence\": <number 0.0-1.0>,\n  \"raw_notes\": <string with any additional economic observations>\n}\n\n### CRITICAL RULES:\n1. Return ONLY the JSON object. No explanations, no markdown.\n2. Numbers must be actual numbers, not strings (e.g., 1500000 not \"1,500,000\").\n3. The project's default currency is {{ $('Set File ID').first().json.currency || 'EUR' }}. Use this as the default currency. If you find prices in different currencies, note the original and convert to {{ $('Set File ID').first().json.currency || 'EUR' }} if possible.\n4. For price_breakdown, use descriptive keys in English.\n5. extraction_confidence should reflect how much economic data you actually found (0.1 = almost nothing, 0.9 = very detailed).\n6. Be thorough: check tables, headers, footers, appendices for pricing data.\n7. Look for both explicit prices and calculated totals."
            }
          ]
        },
        "batching": {}
      },
      "type": "@n8n/n8n-nodes-langchain.chainLlm",
      "typeVersion": 1.8,
      "position": [
        -1856,
        2544
      ],
      "id": "4c700bf4-12cf-441b-99ee-77f05d608041",
      "name": "Extract Economic Data"
    },
    {
      "parameters": {
        "jsCode": "// =============================================\n// NODE: Parse Economic JSON\n// Parses and validates the LLM economic extraction output\n// =============================================\n\nconst llmOutput = $input.first().json;\nconst inputData = $('Check If Economic Offer').first().json;\n\nlet parsed = null;\n\ntry {\n    // The LLM chain returns output in .text or .output\n    let rawText = llmOutput.text || llmOutput.output || JSON.stringify(llmOutput);\n    \n    if (typeof rawText === 'string') {\n        // Clean potential markdown code blocks\n        rawText = rawText.replace(/```json\\n?/g, '').replace(/```\\n?/g, '').trim();\n        \n        // Find JSON boundaries\n        const start = rawText.indexOf('{');\n        const end = rawText.lastIndexOf('}');\n        if (start !== -1 && end !== -1 && end > start) {\n            rawText = rawText.substring(start, end + 1);\n        }\n        \n        parsed = JSON.parse(rawText);\n    } else {\n        parsed = rawText;\n    }\n} catch (err) {\n    console.error('Error parsing economic JSON:', err.message);\n    // Return minimal valid record so we still save something\n    parsed = {\n        total_price: null,\n        currency: 'EUR',\n        extraction_confidence: 0.0,\n        raw_notes: 'LLM output could not be parsed: ' + err.message\n    };\n}\n\n// Helper to safely convert to number\nfunction toNumber(val) {\n    if (val === null || val === undefined) return null;\n    if (typeof val === 'number') return val;\n    if (typeof val === 'string') {\n        // Remove currency symbols, commas, spaces\n        const cleaned = val.replace(/[^0-9.-]/g, '');\n        const num = parseFloat(cleaned);\n        return isNaN(num) ? null : num;\n    }\n    return null;\n}\n\n// Helper to safely convert to JSON string for Supabase JSONB columns\nfunction toJsonString(val) {\n    if (val === null || val === undefined) return null;\n    if (typeof val === 'string') return val;\n    return JSON.stringify(val);\n}\n\n// Build the record for Supabase\nconst record = {\n    project_id: inputData.project_id,\n    provider_name: inputData.provider_name,\n    \n    // Core pricing\n    total_price: toNumber(parsed.total_price),\n    currency: parsed.currency || 'EUR',\n    price_breakdown: toJsonString(parsed.price_breakdown || {}),\n    \n    // Payment terms\n    payment_terms: parsed.payment_terms || null,\n    payment_schedule: toJsonString(parsed.payment_schedule || []),\n    \n    // Discounts\n    discount_percentage: toNumber(parsed.discount_percentage) || 0,\n    discount_conditions: parsed.discount_conditions || null,\n    \n    // TCO\n    tco_value: toNumber(parsed.tco_value),\n    tco_period_years: parsed.tco_period_years ? parseInt(parsed.tco_period_years) : null,\n    tco_breakdown: toJsonString(parsed.tco_breakdown || {}),\n    \n    // Additional\n    validity_days: parsed.validity_days ? parseInt(parsed.validity_days) : 90,\n    price_escalation: parsed.price_escalation || null,\n    guarantees: parsed.guarantees || null,\n    insurance_included: parsed.insurance_included === true,\n    taxes_included: parsed.taxes_included === true,\n    \n    // Optional / alternatives\n    optional_items: toJsonString(parsed.optional_items || []),\n    alternative_offers: toJsonString(parsed.alternative_offers || []),\n    \n    // AI metadata\n    extraction_confidence: toNumber(parsed.extraction_confidence) || 0,\n    raw_notes: parsed.raw_notes || null\n};\n\nconsole.log('Economic data parsed successfully:');\nconsole.log(`  Provider: ${record.provider_name}`);\nconsole.log(`  Total price: ${record.total_price} ${record.currency}`);\nconsole.log(`  Confidence: ${record.extraction_confidence}`);\nconsole.log(`  Has breakdown: ${record.price_breakdown !== '{}'}`);\nconsole.log(`  Has payment terms: ${!!record.payment_terms}`);\n\n// Validate: skip save if no project_id or provider_name\nif (!record.project_id || !record.provider_name || record.provider_name === 'UNKNOWN') {\n    console.log('WARNING: Missing project_id or provider_name, skipping save');\n    return [];\n}\n\nreturn [{ json: record }];"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        -1536,
        2544
      ],
      "id": "f32fee48-1db0-4a80-a105-498f4f6cb66e",
      "name": "Parse Economic JSON"
    },
    {
      "parameters": {
        "operation": "upsert",
        "schema": {
          "__rl": true,
          "value": "=public",
          "mode": "name"
        },
        "table": {
          "__rl": true,
          "value": "economic_offers",
          "mode": "list",
          "cachedResultName": "economic_offers"
        },
        "columns": {
          "mappingMode": "defineBelow",
          "value": {
            "insurance_included": "={{ $json.insurance_included }}",
            "taxes_included": "={{ $json.taxes_included }}",
            "total_price": "={{ $json.total_price }}",
            "discount_percentage": "={{ $json.discount_percentage }}",
            "tco_value": "={{ $json.tco_value }}",
            "tco_period_years": "={{ $json.tco_period_years }}",
            "validity_days": "={{ $json.validity_days }}",
            "extraction_confidence": "={{ $json.extraction_confidence }}",
            "project_id": "={{ $json.project_id }}",
            "provider_name": "={{ $json.provider_name }}",
            "currency": "={{ $json.currency }}",
            "price_breakdown": "={{ $json.price_breakdown }}",
            "payment_terms": "={{ $json.payment_terms }}",
            "discount_conditions": "={{ $json.discount_conditions }}",
            "tco_breakdown": "={{ $json.tco_breakdown }}",
            "price_escalation": "={{ $json.price_escalation }}",
            "guarantees": "={{ $json.guarantees }}",
            "alternative_offers": "={{ $json.alternative_offers }}",
            "raw_notes": "={{ $json.raw_notes }}",
            "created_at": "={{ $now.toISO() }}",
            "updated_at": "={{ $now.toISO() }}",
            "payment_schedule": "={{ $json.payment_schedule }}",
            "optional_items": "={{ $json.optional_items }}"
          },
          "matchingColumns": [
            "project_id",
            "provider_name"
          ],
          "schema": [
            {
              "id": "id",
              "displayName": "id",
              "required": false,
              "defaultMatch": true,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": true
            },
            {
              "id": "project_id",
              "displayName": "project_id",
              "required": true,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": false
            },
            {
              "id": "provider_name",
              "displayName": "provider_name",
              "required": true,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": false
            },
            {
              "id": "total_price",
              "displayName": "total_price",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "number",
              "canBeUsedToMatch": false
            },
            {
              "id": "currency",
              "displayName": "currency",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": false
            },
            {
              "id": "price_breakdown",
              "displayName": "price_breakdown",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": false
            },
            {
              "id": "payment_terms",
              "displayName": "payment_terms",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": false
            },
            {
              "id": "payment_schedule",
              "displayName": "payment_schedule",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": false
            },
            {
              "id": "discount_percentage",
              "displayName": "discount_percentage",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "number",
              "canBeUsedToMatch": false
            },
            {
              "id": "discount_conditions",
              "displayName": "discount_conditions",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": false
            },
            {
              "id": "tco_value",
              "displayName": "tco_value",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "number",
              "canBeUsedToMatch": false
            },
            {
              "id": "tco_period_years",
              "displayName": "tco_period_years",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "number",
              "canBeUsedToMatch": false
            },
            {
              "id": "tco_breakdown",
              "displayName": "tco_breakdown",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": false
            },
            {
              "id": "validity_days",
              "displayName": "validity_days",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "number",
              "canBeUsedToMatch": false
            },
            {
              "id": "price_escalation",
              "displayName": "price_escalation",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": false
            },
            {
              "id": "guarantees",
              "displayName": "guarantees",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": false
            },
            {
              "id": "insurance_included",
              "displayName": "insurance_included",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "boolean",
              "canBeUsedToMatch": false
            },
            {
              "id": "taxes_included",
              "displayName": "taxes_included",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "boolean",
              "canBeUsedToMatch": false
            },
            {
              "id": "optional_items",
              "displayName": "optional_items",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": false
            },
            {
              "id": "alternative_offers",
              "displayName": "alternative_offers",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": false
            },
            {
              "id": "extraction_confidence",
              "displayName": "extraction_confidence",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "number",
              "canBeUsedToMatch": false
            },
            {
              "id": "raw_notes",
              "displayName": "raw_notes",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": false
            },
            {
              "id": "created_at",
              "displayName": "created_at",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "dateTime",
              "canBeUsedToMatch": false
            },
            {
              "id": "updated_at",
              "displayName": "updated_at",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "dateTime",
              "canBeUsedToMatch": false
            }
          ],
          "attemptToConvertTypes": false,
          "convertFieldsToString": false
        },
        "options": {}
      },
      "type": "n8n-nodes-base.postgres",
      "typeVersion": 2.5,
      "position": [
        -1184,
        2544
      ],
      "id": "88b1ef1e-a787-4b80-931f-aa34bba3677b",
      "name": "Save Economic Offer",
      "credentials": {
        "postgres": {
          "id": "V0REAPph5JBLqze3",
          "name": "Postgres account"
        }
      }
    },
    {
      "parameters": {
        "content": "## /rfp-generate - AI RFP Document Generator\n\nGenerates a complete RFP/RFQ/RFI document using AI based on project requirements.\n\n**Method**: POST\n**Body**: { project_id, project_name, project_type, description, requirements, providers?, criteria?, deadlines?, language?, sections? }\n\n**Flow**: Webhook â†’ Set Fields â†’ LLM Chain â†’ Parse & Structure Output â†’ Respond\n\n**Returns**: { success, document, title, sections: [{title, content}], metadata: {word_count, generated_at, model} }",
        "height": 400,
        "width": 2200,
        "color": 6
      },
      "type": "n8n-nodes-base.stickyNote",
      "typeVersion": 1,
      "position": [
        -1664,
        6496
      ],
      "id": "3e76b487-5067-4032-8139-2ebe6aea681a",
      "name": "Sticky Note RFP Generate"
    },
    {
      "parameters": {
        "httpMethod": "POST",
        "path": "rfp-generate",
        "responseMode": "responseNode",
        "options": {}
      },
      "type": "n8n-nodes-base.webhook",
      "typeVersion": 2.1,
      "position": [
        -1584,
        6656
      ],
      "id": "0d6f1dee-3962-4d21-9c3a-1e1f7a4ec81b",
      "name": "Webhook RFP Generate",
      "webhookId": "rfp-generate-webhook-001"
    },
    {
      "parameters": {
        "assignments": {
          "assignments": [
            {
              "id": "rfp-project-id",
              "name": "project_id",
              "value": "={{ $json.body.project_id }}",
              "type": "string"
            },
            {
              "id": "rfp-project-name",
              "name": "project_name",
              "value": "={{ $json.body.project_name }}",
              "type": "string"
            },
            {
              "id": "rfp-project-type",
              "name": "project_type",
              "value": "={{ $json.body.project_type || 'RFP' }}",
              "type": "string"
            },
            {
              "id": "rfp-description",
              "name": "description",
              "value": "={{ $json.body.description }}",
              "type": "string"
            },
            {
              "id": "rfp-requirements",
              "name": "requirements",
              "value": "={{ $json.body.requirements }}",
              "type": "string"
            },
            {
              "id": "rfp-language",
              "name": "language",
              "value": "={{ $json.body.language || 'es' }}",
              "type": "string"
            },
            {
              "id": "rfp-currency",
              "name": "currency",
              "value": "={{ $json.body.currency || 'EUR' }}",
              "type": "string"
            },
            {
              "id": "rfp-sections",
              "name": "sections",
              "value": "={{ $json.body.sections }}",
              "type": "array"
            },
            {
              "id": "rfp-criteria",
              "name": "criteria",
              "value": "={{ $json.body.criteria }}",
              "type": "array"
            },
            {
              "id": "rfp-deadlines",
              "name": "deadlines",
              "value": "={{ $json.body.deadlines }}",
              "type": "object"
            },
            {
              "id": "rfp-providers",
              "name": "providers",
              "value": "={{ $json.body.providers }}",
              "type": "array"
            },
            {
              "id": "rfp-action",
              "name": "action",
              "value": "={{ $json.body.action || 'generate_rfp' }}",
              "type": "string"
            },
            {
              "id": "award-winner-name",
              "name": "winner_name",
              "value": "={{ $json.body.winner_name || '' }}",
              "type": "string"
            },
            {
              "id": "award-winner-score",
              "name": "winner_score",
              "value": "={{ $json.body.winner_score || 0 }}",
              "type": "string"
            },
            {
              "id": "award-runner-up-name",
              "name": "runner_up_name",
              "value": "={{ $json.body.runner_up_name || '' }}",
              "type": "string"
            },
            {
              "id": "award-runner-up-score",
              "name": "runner_up_score",
              "value": "={{ $json.body.runner_up_score || 0 }}",
              "type": "string"
            },
            {
              "id": "award-total-providers",
              "name": "total_providers",
              "value": "={{ $json.body.total_providers || 0 }}",
              "type": "string"
            },
            {
              "id": "award-category-scores",
              "name": "category_scores",
              "value": "={{ JSON.stringify($json.body.category_scores || {}) }}",
              "type": "string"
            },
            {
              "id": "award-strengths",
              "name": "strengths",
              "value": "={{ JSON.stringify($json.body.strengths || []) }}",
              "type": "string"
            },
            {
              "id": "award-weaknesses",
              "name": "weaknesses",
              "value": "={{ JSON.stringify($json.body.weaknesses || []) }}",
              "type": "string"
            },
            {
              "id": "award-economic-summary",
              "name": "economic_summary",
              "value": "={{ $json.body.economic_summary || '' }}",
              "type": "string"
            },
            {
              "id": "award-scoring-summary",
              "name": "scoring_criteria_summary",
              "value": "={{ $json.body.scoring_criteria_summary || '' }}",
              "type": "string"
            }
          ]
        },
        "options": {}
      },
      "type": "n8n-nodes-base.set",
      "typeVersion": 3.4,
      "position": [
        -1376,
        6656
      ],
      "id": "a0f40cb4-eb1a-45a1-b619-b0aadd434a79",
      "name": "Set RFP Params"
    },
    {
      "parameters": {
        "promptType": "define",
        "text": "=### CONTEXTO DEL PROYECTO\n\n- **Proyecto:** {{ $json.project_name }} ({{ $json.project_type }})\n- **Moneda:** {{ $json.currency || 'EUR' }}\n- **Descripcion:** {{ $json.description }}\n- **Requisitos:** {{ $json.requirements }}\n\n### INDICE COMPLETO DEL DOCUMENTO ({{ $json.section_total }} secciones)\n{{ $json.all_sections_outline }}\n\n### CRITERIOS DE EVALUACION\n{{ $json.criteria }}\n\n### PLAZOS Y CRONOGRAMA\n{{ $json.deadlines }}\n\n### PROVEEDORES INVITADOS\n{{ $json.providers }}\n\n---\n\n### TU TAREA\n\nEscribe la seccion {{ $json.section_index }} de {{ $json.section_total }}: **{{ $json.section_title }}**\n\nDescripcion de lo que debe cubrir esta seccion:\n{{ $json.section_description }}\n\n### REGLAS DE REDACCION\n1. **Extension**: Escribe un MINIMO de 600 palabras para esta seccion. Debe ser completa y detallada.\n2. **Estilo narrativo**: Escribe en PROSA NARRATIVA. Usa parrafos completos de 3-5 oraciones cada uno que expliquen con profundidad.\n3. **Listas con contexto**: Si necesitas usar listas o enumeraciones, SIEMPRE precedelas de un parrafo explicativo. Nunca una seccion que sea SOLO una lista.\n4. **Tablas**: Si esta seccion trata de criterios de evaluacion, plazos o comparativas, incluye tablas Markdown bien formateadas.\n5. **Especificidad**: Incluye detalles especificos relevantes para proyectos {{ $json.project_type }} del sector energetico/industrial.\n6. **Coherencia**: Esta seccion es parte de un documento mayor. No repitas introducciones generales ni cierres del documento. Escribe SOLO el contenido de esta seccion.\n7. **NO incluyas** el titulo de la seccion (se anadira automaticamente).\n\n### FORMATO DE SALIDA\n- Devuelve SOLO el texto de la seccion en Markdown.\n- NO devuelvas JSON.\n- NO uses bloques de codigo (```).\n- NO incluyas comentarios meta ni explicaciones sobre lo que escribiste.\n- Empieza directamente con el contenido.",
        "messages": {
          "messageValues": [
            {
              "message": "=You are a senior procurement specialist and technical writer with 15+ years of experience drafting {{ $json.project_type }} documents for industrial EPC projects (energy, P2X, green hydrogen, solar, wind, BESS, petrochemical).\n\n### YOUR ROLE\nYou are writing ONE SPECIFIC SECTION of a formal {{ $json.project_type }} document. You must write this section with the depth, detail and quality expected in a real corporate procurement document used in multi-million euro tenders.\n\n### WRITING STYLE REQUIREMENTS\n1. **NARRATIVE PROSE is mandatory**: Write in full, well-constructed paragraphs. Each paragraph must have 3-5 complete sentences that develop an idea thoroughly.\n2. **NO list-only sections**: You may use bullet points or numbered lists to enumerate specific items (e.g., requirements, criteria), but they MUST be preceded and followed by explanatory paragraphs that provide context and rationale.\n3. **Minimum 600 words**: This section must be substantial. A section shorter than 600 words is unacceptable.\n4. **Professional register**: Use formal, precise language appropriate for corporate procurement. No colloquialisms, no filler text, no generic statements.\n5. **Specificity over generality**: Reference the specific project type, sector, and requirements. Avoid vague statements like 'the provider must comply with applicable regulations' â€” instead specify WHICH regulations.\n6. **Write in {{ $json.language === 'en' ? 'English' : 'Spanish' }}** throughout.\n\n### FORMATTING\n- Use Markdown: **bold** for key terms, - for lists, | for tables where appropriate.\n- Do NOT include the section header/title (it will be added automatically).\n- Start directly with the substantive content.\n\n### OUTPUT FORMAT\n- Return ONLY the section content as plain Markdown text.\n- Do NOT return JSON, code blocks, or meta-commentary.\n- Do NOT explain what you are doing. Just write the section."
            }
          ]
        },
        "batching": {}
      },
      "type": "@n8n/n8n-nodes-langchain.chainLlm",
      "typeVersion": 1.8,
      "position": [
        -1184,
        6656
      ],
      "id": "6d67b039-6260-4c1d-b364-814b99875183",
      "name": "RFP Generation Chain"
    },
    {
      "parameters": {
        "jsCode": "// Consolidate multiple section outputs into a single RFP document\n// Each input item is one section's LLM output; section metadata comes from Prepare RFP Sections\nconst params = $('Set RFP Params').first().json;\nconst sectionMeta = $('Prepare RFP Sections').all();\nconst llmOutputs = $input.all();\n\nconst logoPlaceholderRegex = /(?:^|\\n)\\s*!?\\[\\s*(?:logo(?:\\s+de\\s+la)?(?:\\s+empresa)?|company\\s+logo)\\s*\\](?:\\([^\\)]*\\))?\\s*(?=\\n|$)/gi;\n\nconst cleanText = (text) => String(text || '')\n  .replace(logoPlaceholderRegex, '\\n')\n  .replace(/```json\\n?/gi, '').replace(/```\\n?/g, '')\n  .replace(/\\n{3,}/g, '\\n\\n')\n  .trim();\n\ntry {\n  const sections = sectionMeta.map((meta, index) => {\n    const llmItem = llmOutputs[index];\n    const rawContent = llmItem?.json?.text || llmItem?.json?.output || llmItem?.json?.response || '';\n    const content = cleanText(rawContent);\n    return {\n      title: meta.json.section_title,\n      content: content,\n      word_count: content.split(/\\s+/).filter(w => w.length > 0).length\n    };\n  });\n\n  // Build the full document with numbered section headers\n  const documentParts = sections.map((s, i) => {\n    return `## ${i + 1}. ${s.title}\\n\\n${s.content}`;\n  });\n  const document = documentParts.join('\\n\\n---\\n\\n');\n  const totalWords = sections.reduce((sum, s) => sum + s.word_count, 0);\n\n  const result = {\n    success: true,\n    title: `${params.project_type} - ${params.project_name}`,\n    document,\n    sections: sections.map(s => ({ title: s.title, content: s.content })),\n    metadata: {\n      word_count: totalWords,\n      section_count: sections.length,\n      words_per_section: sections.map(s => ({ title: s.title, words: s.word_count })),\n      generated_at: new Date().toISOString(),\n      model: 'mistral-large-latest',\n      generation_mode: 'multi-agent-per-section'\n    },\n    message: `RFP generated with ${sections.length} sections (${totalWords} words total)`\n  };\n\n  console.log('âœ… RFP Consolidated:');\n  console.log(`   â”œâ”€ Title: ${result.title}`);\n  console.log(`   â”œâ”€ Sections: ${sections.length}`);\n  console.log(`   â”œâ”€ Total words: ${totalWords}`);\n  sections.forEach(s => console.log(`   â”‚  â””â”€ ${s.title}: ${s.word_count} words`));\n  console.log(`   â””â”€ Mode: multi-agent-per-section`);\n\n  return [{ json: result }];\n} catch (err) {\n  console.error('âŒ Error consolidating RFP:', err.message);\n  return [{ json: {\n    success: false,\n    title: '',\n    document: '',\n    sections: [],\n    metadata: { word_count: 0, generated_at: new Date().toISOString(), model: 'mistral-large-latest' },\n    message: 'Error consolidating RFP: ' + err.message\n  }}];\n}\n"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        -976,
        6656
      ],
      "id": "55b18e0c-9d63-4eac-abd2-5e4050769211",
      "name": "Parse RFP Output"
    },
    {
      "parameters": {
        "respondWith": "allIncomingItems",
        "options": {}
      },
      "type": "n8n-nodes-base.respondToWebhook",
      "typeVersion": 1.5,
      "position": [
        -784,
        6656
      ],
      "id": "5f290b7b-1985-4d67-a41e-b69d9729752b",
      "name": "Respond RFP Generate"
    },
    {
      "parameters": {
        "options": {}
      },
      "type": "@n8n/n8n-nodes-langchain.lmChatOpenRouter",
      "typeVersion": 1,
      "position": [
        -1664,
        2992
      ],
      "id": "d0b8f32f-ff26-4817-9fd6-39e215d56714",
      "name": "OpenRouter Chat Model5",
      "credentials": {
        "openRouterApi": {
          "id": "4AyUqsh1Z35g6bci",
          "name": "OpenRouter account"
        }
      }
    },
    {
      "parameters": {
        "options": {
          "temperature": 0.1
        }
      },
      "type": "@n8n/n8n-nodes-langchain.lmChatOpenRouter",
      "typeVersion": 1,
      "position": [
        -272,
        6384
      ],
      "id": "3fb7e04e-7259-4778-be2a-6a1e7e807b06",
      "name": "OpenRouter Chat Model6",
      "credentials": {
        "openRouterApi": {
          "id": "4AyUqsh1Z35g6bci",
          "name": "OpenRouter account"
        }
      }
    },
    {
      "parameters": {
        "content": "### Ingesta de RFQ, actualizaciÃ³n de requisitos",
        "height": 1280,
        "width": 4390,
        "color": 4
      },
      "type": "n8n-nodes-base.stickyNote",
      "typeVersion": 1,
      "position": [
        -5040,
        4400
      ],
      "id": "1c2debd6-34a0-48b5-9086-595d081acf5e",
      "name": "Sticky Note"
    },
    {
      "parameters": {
        "httpMethod": "POST",
        "path": "ingesta-rfq",
        "responseMode": "responseNode",
        "options": {}
      },
      "type": "n8n-nodes-base.webhook",
      "typeVersion": 2.1,
      "position": [
        -4928,
        4624
      ],
      "id": "4f1a80fe-bc97-4943-bec8-83e6ed11f4b6",
      "name": "Webhook RFQ",
      "webhookId": "86850b01-70b4-4c99-a63a-6ccad35c0be2"
    },
    {
      "parameters": {
        "jsCode": "// =============================================\n// NODO: Preparar Texto (Agregador de PÃ¡ginas)\n// =============================================\n\nconst items = $input.all();\nif (!items || items.length === 0) {\n    return { json: { error: \"No input items received\" } };\n}\n\n// Recuperar metadatos del inicio del flujo (Generate IDs1)\nlet metadata = {};\ntry {\n    metadata = $('Generate IDs1').first().json;\n} catch (e) {\n    console.log(\"âš ï¸ No se pudo recuperar metadata de Generate IDs1\");\n}\n\n// 1. Agregado de Texto Completo (todas las pÃ¡ginas)\n// Intentamos md_content primero (mejor para LLMs), luego text\nlet fullText = items.map(item => item.json.md_content || item.json.text || \"\").join('\\n\\n').trim();\n\nif (!fullText) {\n    console.log(\"âš ï¸ Advertencia: No se extrajo texto del documento.\");\n}\n\n// 2. Limpieza bÃ¡sica\nfullText = fullText.replace(/\\x00/g, ''); // Eliminar caracteres nulos\n\n// 3. Preparar fragmento para clasificaciÃ³n (mÃ¡x 40k chars para no saturar context)\nconst textForClassification = fullText.substring(0, 40000);\n\nconsole.log(`âœ… Texto preparado: ${items.length} pÃ¡ginas aggregadas. Chars: ${fullText.length}`);\n\nreturn {\n    json: {\n        rfq_project_id: metadata.rfq_project_id || \"unknown\",\n        rfq_document_id: metadata.rfq_document_id || \"unknown\",\n        project_name: metadata.project_name || \"Sin Nombre\",\n        file_title: metadata.file_title || \"document.pdf\",\n        text: fullText, \n        text_for_classification: textForClassification || \"SIN TEXTO DETECTADO\",\n        pages_count: items.length\n    }\n};"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        -3808,
        4624
      ],
      "id": "07c1c67e-bace-40d9-8d04-44490eafe7f9",
      "name": "Preparar Texto1"
    },
    {
      "parameters": {
        "promptType": "define",
        "text": "=### DOCUMENTO RFQ\n\nNombre del Archivo: {{ $json.file_title }}\nNombre Proyecto: {{ $('Webhook RFQ').first().json.body.project_name }}\n### CONTENIDO (FRAGMENTO):\n{{ $json.pages ? $json.pages.slice(0, 1).map(p => p.text).join('\\n\\n') : ($json.text ? $json.text.substring(0, 2000) : 'SIN TEXTO') }}",
        "hasOutputParser": true,
        "messages": {
          "messageValues": [
            {
              "message": "=## TAREA: CLASIFICAR UN DOCUMENTO EN EXACTAMENTE 1 TIPO DE EVALUACIÃ“N\n\nEres un clasificador de documentos de licitaciÃ³n.\nCada documento pertenece a UN SOLO tipo. No hay excepciones.\n\n### REGLA ABSOLUTA\n**1 documento = 1 tipo. Siempre.**\nEl array tipos_detectados SIEMPRE debe contener EXACTAMENTE 1 elemento.\nNunca 2, nunca 3. Siempre 1.\n\n### LOS 3 TIPOS (elige UNO)\n\n1. **Economical Evaluation** â† Prioridad alta si hay precios\n   - Tablas de precios, tarifas, rates, EUR/h, USD/day\n   - Pricing schedule, cost breakdown, budget\n   - Condiciones de pago, garantÃ­as financieras\n   - CotizaciÃ³n econÃ³mica, commercial proposal\n\n2. **Technical Evaluation** â† Prioridad media\n   - Scope of Work, especificaciones tÃ©cnicas\n   - Requisitos de ingenierÃ­a, metodologÃ­a, normativas\n   - Entregables tÃ©cnicos, deliverables, listas de documentos\n   - Criterios de diseÃ±o, requisitos de personal\n   - Fases de proyecto (Pre-FEED, FEED, EPC, etc.)\n\n3. **Others** â† Todo lo demÃ¡s, si el nombre del archivo es algo como \"Compliance\" , equivale a \"Others\"\n   - InformaciÃ³n administrativa, legal, contractual\n   - DocumentaciÃ³n general, Ã­ndices, portadas\n   - Cualquier cosa que no sea claramente tÃ©cnica ni econÃ³mica\n\n### CÃ“MO DECIDIR\n\n- Â¿El documento habla PRINCIPALMENTE de precios, costes o tarifas? â†’ **Economical Evaluation**\n- Â¿El documento habla PRINCIPALMENTE de requisitos tÃ©cnicos, alcance o entregables? â†’ **Technical Evaluation**\n- Â¿No encaja claramente en ninguno de los dos anteriores? â†’ **Others**\n\nEl nombre del archivo (RFQ, RFP, etc.) NO determina el tipo. Solo el CONTENIDO real del documento determina el tipo.\n\n### FORMATO DE SALIDA (JSON PLANO â€“ ESTRICTO)\n\n1. Devuelve **ÃšNICAMENTE** un objeto JSON que empiece por `{` y termine por `}`.\n2. **PROHIBIDO** devolver el JSON dentro de una lista o array `[]`.\n3. **PROHIBIDO** usar claves contenedoras como `\"output\"`, `\"response\"` o `\"json\"`.\n4. No incluyas bloques de cÃ³digo markdown (\\`\\`\\`json). Solo el texto plano del JSON.\n5. tipos_detectados DEBE tener EXACTAMENTE 1 elemento.\n\n**EJEMPLO CORRECTO:**\n{\n  \"tipos_detectados\": [\"Technical Evaluation\"],\n  \"razonamiento\": \"El documento describe el alcance tÃ©cnico del proyecto con requisitos de ingenierÃ­a.\"\n}"
            }
          ]
        },
        "batching": {}
      },
      "type": "@n8n/n8n-nodes-langchain.chainLlm",
      "typeVersion": 1.8,
      "position": [
        -4112,
        4864
      ],
      "id": "12564477-00eb-4b3a-b616-1237e5f54962",
      "name": "Clasificador de Tipos1"
    },
    {
      "parameters": {
        "model": "mistral:7b",
        "options": {
          "temperature": 0.1
        }
      },
      "type": "@n8n/n8n-nodes-langchain.lmOllama",
      "typeVersion": 1,
      "position": [
        -4160,
        5088
      ],
      "id": "12858fa4-94a4-42a5-9fe7-2f8c94d51b96",
      "name": "Ollama Clasificador1",
      "credentials": {
        "ollamaApi": {
          "id": "oS2Qqti9oVfsm8XZ",
          "name": "Ollama account"
        }
      }
    },
    {
      "parameters": {
        "schemaType": "manual",
        "inputSchema": "{\n  \"type\": \"object\",\n  \"properties\": {\n    \"tipos_detectados\": {\n      \"type\": \"array\",\n      \"items\": {\n        \"type\": \"string\",\n        \"enum\": [\"Technical Evaluation\", \"Economical Evaluation\", \"Others\"]\n      },\n      \"minItems\": 1,\n      \"maxItems\": 1\n    },\n    \"razonamiento\": {\n      \"type\": \"string\"\n    }\n  },\n  \"required\": [\"tipos_detectados\"]\n}"
      },
      "type": "@n8n/n8n-nodes-langchain.outputParserStructured",
      "typeVersion": 1.3,
      "position": [
        -3920,
        5088
      ],
      "id": "9499422c-2cbe-4ee3-91fc-3878cf5e75ca",
      "name": "Output Parser1"
    },
    {
      "parameters": {
        "jsCode": "// =============================================\n// NODO: Expandir por Tipo (CORREGIDO)\n// =============================================\n\n// 1. Recuperar metadatos de nodos anteriores\nlet projectId = \"unknown\";\nlet documentId = \"unknown\";\nlet fileTitle = \"unknown\";\nlet fullText = \"\";\nlet metadataProjectName = \"\";\n\ntry {\n    const textNode = $('Preparar Texto1').first().json;\n    projectId = textNode.rfq_project_id || \"unknown\";\n    documentId = textNode.rfq_document_id || \"unknown\";\n    fileTitle = textNode.file_title || \"unknown\";\n    fullText = textNode.text || \"\";\n    metadataProjectName = textNode.project_name || \"\"; \n} catch(e) {\n    console.log(\"âš ï¸ No se pudieron leer metadatos de Preparar Texto1\");\n}\n\n// 2. Obtener los tipos DIRECTAMENTE del Clasificador (no del input actual)\nlet tipos = [];\nlet nombreProyecto = \"\";\n\ntry {\n    const clasificadorData = $('Clasificador de Tipos1').first().json;\n    \n    // El clasificador puede devolver el output de diferentes formas\n    let output = clasificadorData.output || clasificadorData;\n    \n    // Intentar parsear si es string\n    if (typeof output === 'string') {\n        try {\n            const clean = output.replace(/```json/gi, '').replace(/```/g, '').trim();\n            const start = clean.indexOf('{');\n            const end = clean.lastIndexOf('}');\n            if (start !== -1 && end !== -1) {\n                output = JSON.parse(clean.substring(start, end + 1));\n            } else {\n                output = JSON.parse(clean);\n            }\n        } catch(e) {\n            console.log(\"âš ï¸ Error parseando output del clasificador\");\n        }\n    }\n    \n    // Extraer tipos y nombre del proyecto\n    tipos = output.tipos_detectados || [];\n    nombreProyecto = output.nombre_proyecto || \"\";\n    \n    console.log(`âœ… Tipos detectados por IA: ${JSON.stringify(tipos)}`);\n} catch(e) {\n    console.log(\"âš ï¸ Error recuperando datos del Clasificador de Tipos1\");\n}\n\n// 3. ValidaciÃ³n y fallback SOLO si NO hay tipos\nif (!Array.isArray(tipos)) tipos = [];\n\nif (tipos.length === 0) {\n    // Fallback: si el clasificador fallÃ³, asignar Technical por defecto\n    tipos = [\"Technical Evaluation\"];\n    console.log(\"âš ï¸ Fallback: Clasificador fallÃ³, usando Technical Evaluation por defecto\");\n}\n\n// Forzar siempre 1 solo tipo (el primero detectado)\nif (tipos.length > 1) {\n    console.log(`âš ï¸ Clasificador devolviÃ³ ${tipos.length} tipos: ${tipos.join(', ')}. Usando solo el primero.`);\n    tipos = [tipos[0]];\n}\n\n// Normalizar tipos: mapear tipos antiguos a los 3 vÃ¡lidos\nconst VALID_TYPES = ['Technical Evaluation', 'Economical Evaluation', 'Others'];\ntipos = tipos.map(t => {\n    if (VALID_TYPES.includes(t)) return t;\n    if (t.includes('Deliverables') || t.includes('FEED')) return 'Others';\n    return 'Others';\n});\n\n// Eliminar duplicados\ntipos = [...new Set(tipos)];\n\n// 4. Nombre del Proyecto\nlet finalProjectName = nombreProyecto || metadataProjectName;\n\nif (!finalProjectName || finalProjectName === \"Sin Nombre\" || finalProjectName.includes(\"La Zaida\")) {\n    finalProjectName = fileTitle.replace(/\\.pdf$/i, '') + \" (Project)\";\n}\n\nconsole.log(`ðŸ“‹ Expandiendo ${tipos.length} tipos: ${tipos.join(', ')}`);\n\n// 5. Generar Salida (Expandir items)\nreturn tipos.map((tipo, idx) => ({\n    json: {\n        tipo_evaluacion: tipo,\n        rfq_project_id: projectId,\n        rfq_document_id: documentId,\n        nombre_proyecto: finalProjectName,\n        file_title: fileTitle,\n        texto_rfq: fullText,\n        indice: idx + 1,\n        total_tipos: tipos.length\n    }\n}));"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        -3152,
        4864
      ],
      "id": "81439100-fa6a-4570-a2e9-ead363912699",
      "name": "Expandir por Tipo1"
    },
    {
      "parameters": {
        "options": {}
      },
      "type": "n8n-nodes-base.splitInBatches",
      "typeVersion": 3,
      "position": [
        -2944,
        4864
      ],
      "id": "3759b7ef-986a-4e09-8e84-4e621c105492",
      "name": "Loop por Tipo1"
    },
    {
      "parameters": {
        "jsCode": "// =============================================\n// NODO: Parsear Final (Con Nombre Proyecto)\n// =============================================\nconst inputJson = $input.first().json;\n// Asegurar que sea string\nlet llmOutput = \"\";\nif (typeof inputJson === 'string') llmOutput = inputJson;\nelse if (inputJson.text && typeof inputJson.text === 'string') llmOutput = inputJson.text;\nelse if (inputJson.output && typeof inputJson.output === 'string') llmOutput = inputJson.output;\nelse if (inputJson.content && typeof inputJson.content === 'string') llmOutput = inputJson.content;\nelse llmOutput = JSON.stringify(inputJson.text || inputJson.output || inputJson.content || inputJson);\n\nllmOutput = String(llmOutput || \"[]\");\n\n// 1. Recuperar Contexto del Loop\nlet projectId = \"unknown\";\nlet documentId = \"unknown\";\nlet tipoEvaluacion = \"Unknown\";\nlet nombreProyecto = \"Sin Nombre\";\n\ntry {\n    const loopData = $('Loop por Tipo1').first().json;\n    projectId = loopData.rfq_project_id;\n    documentId = loopData.rfq_document_id;\n    tipoEvaluacion = loopData.tipo_evaluacion;\n    nombreProyecto = loopData.nombre_proyecto || \"Sin Nombre\";\n} catch(e) {}\n\n// 2. LÃ³gica de Parsing\nlet items = [];\n\ntry {\n    let clean = llmOutput.replace(/```json/gi, '').replace(/```/g, '').trim();\n    const start = clean.indexOf('[');\n    const end = clean.lastIndexOf(']');\n    if (start !== -1 && end !== -1) {\n        items = JSON.parse(clean.substring(start, end + 1));\n    }\n} catch(e) {}\n\nif (items.length === 0) {\n    const lines = llmOutput.split('\\n');\n    let currentPhase = \"General\";\n    for (let i = 0; i < lines.length; i++) {\n        const line = lines[i].trim();\n        if (!line) continue;\n        if (/^\\d+\\./.test(line) && !line.includes('Estimate')) {\n            const text = line.replace(/^\\d+\\.\\s*/, '').trim();\n            if (i+1 < lines.length && (lines[i+1].trim().startsWith('-') || lines[i+1].trim().startsWith('â€¢'))) {\n                currentPhase = text;\n            } else {\n                 items.push({ fase: \"General\", requisito_rfq: text });\n            }\n        }\n        else if (line.startsWith('-') || line.startsWith('â€¢')) {\n            items.push({ fase: currentPhase, requisito_rfq: line.replace(/^[-â€¢]\\s*/, '').trim() });\n        }\n    }\n}\n\nfunction generateId(str) {\n    let hash = 0;\n    for (let i = 0; i < str.length; i++) {\n        hash = ((hash << 5) - hash) + str.charCodeAt(i);\n        hash = hash & hash;\n    }\n    return 'item_' + Math.abs(hash).toString(16).padStart(12, '0');\n}\n\nreturn items.map(item => ({\n    json: {\n        rfq_project_id: projectId,\n        project_name: nombreProyecto,\n        rfq_document_id: documentId,\n        evaluation: tipoEvaluacion,\n        fase: item.fase || \"General\",\n        requisito_rfq: item.requisito_rfq || \"Sin Nombre\"\n    }\n}));"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        -1376,
        4800
      ],
      "id": "16aaae20-464f-4d77-a947-0386d3b0b84c",
      "name": "Parsear Items1"
    },
    {
      "parameters": {
        "jsCode": "// =============================================\n// NODO: Agregar Resultados del Tipo Actual\n// =============================================\n\nconst items = $input.all();\n\n// Contar items insertados\nconst totalInserted = items.length;\n\n// Recuperar info del tipo actual\nlet tipoActual = \"unknown\";\ntry {\n    tipoActual = $('Loop por Tipo1').first().json.tipo_evaluacion;\n} catch(e) {}\n\nconsole.log(`âœ… Tipo ${tipoActual}: ${totalInserted} items insertados`);\n\nreturn {\n    json: {\n        tipo_procesado: tipoActual,\n        items_insertados: totalInserted,\n        continuar_loop: true\n    }\n};"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        -848,
        4992
      ],
      "id": "de4b31c7-a2b7-4eff-a608-9c7b0d45cf98",
      "name": "Agregar Resultados1"
    },
    {
      "parameters": {
        "jsCode": "// =============================================\n// NODO: Resumen Final\n// =============================================\n\n// Recuperar datos del proyecto\nlet projectId = \"unknown\";\nlet fileTitle = \"unknown\";\nlet tiposDetectados = [];\n\ntry {\n    const projectNode = $('Generate IDs1').first().json;\n    projectId = projectNode.rfq_project_id;\n    fileTitle = projectNode.file_title;\n} catch(e) {}\n\ntry {\n    const clasificador = $('Clasificador de Tipos1').first().json;\n    const output = clasificador.output || clasificador;\n    tiposDetectados = output.tipos_detectados || [];\n} catch(e) {}\n\nconsole.log(\"========================================\");\nconsole.log(\"âœ… PROCESAMIENTO RFQ COMPLETADO\");\nconsole.log(`   Proyecto: ${projectId}`);\nconsole.log(`   Archivo: ${fileTitle}`);\nconsole.log(`   Tipos procesados: ${tiposDetectados.length}`);\nconsole.log(\"========================================\");\n\nreturn {\n    json: {\n        success: true,\n        rfq_project_id: projectId,\n        file_title: fileTitle,\n        tipos_procesados: tiposDetectados,\n        mensaje: `RFQ procesada correctamente. ${tiposDetectados.length} tipo(s) de evaluaciÃ³n detectados y poblados.`\n    }\n};"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        -1648,
        4464
      ],
      "id": "bedf08e5-3f62-4730-8cf7-2be6795eeac9",
      "name": "Resumen Final1"
    },
    {
      "parameters": {
        "respondWith": "json",
        "responseBody": "={{ JSON.stringify($json) }}",
        "options": {}
      },
      "type": "n8n-nodes-base.respondToWebhook",
      "typeVersion": 1.5,
      "position": [
        -1360,
        4464
      ],
      "id": "74802e87-a6b9-4188-86a7-30a34b2a4301",
      "name": "Respond Success1"
    },
    {
      "parameters": {
        "jsCode": "// =============================================\n// NODO: Base64 a Binary\n// =============================================\n\n// Recuperar metadatos del inicio del flujo (Generate IDs1)\nlet inputData = {};\ntry {\n    inputData = $('Generate IDs1').first().json;\n} catch (e) {\n    inputData = $json; // Fallback\n}\n\nconst base64Data = inputData.file_binary;\n\nif (!base64Data || base64Data === \"\") {\n    throw new Error(\"âŒ CRÃTICO: 'file_binary' estÃ¡ vacÃ­o\");\n}\n\nconst binaryData = Buffer.from(base64Data, 'base64');\n\nconsole.log(`âœ… PDF convertido: ${binaryData.length} bytes`);\n\nreturn {\n    json: {\n        rfq_project_id: inputData.rfq_project_id || \"unknown\",\n        rfq_document_id: inputData.rfq_document_id || \"unknown\",\n        project_name: inputData.project_name || \"Sin Nombre\",\n        file_title: inputData.file_title || \"document.pdf\"\n    },\n    binary: {\n        data: {\n            data: binaryData.toString('base64'),\n            mimeType: 'application/pdf',\n            fileName: inputData.file_title || 'rfq.pdf',\n            fileSize: binaryData.length\n        }\n    }\n};"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        -4256,
        4624
      ],
      "id": "5630e707-1df0-4a21-8614-14fd6565b47f",
      "name": "Base64 a Binary3"
    },
    {
      "parameters": {
        "operation": "pdf",
        "options": {}
      },
      "type": "n8n-nodes-base.extractFromFile",
      "typeVersion": 1.1,
      "position": [
        -4032,
        4624
      ],
      "id": "67f40795-26f3-4599-8729-6edb0ed2e383",
      "name": "Extract from File3"
    },
    {
      "parameters": {
        "jsCode": "// =============================================\n// NODO: Generate Stable ID + Detectar Modo (CORREGIDO)\n// Con soporte para project_id (UUID) del frontend\n// =============================================\n\nfunction simpleHash(str) {\n  let hash = 0;\n  for (let i = 0; i < str.length; i++) {\n    const char = str.charCodeAt(i);\n    hash = ((hash << 5) - hash) + char;\n    hash = hash & hash;\n  }\n  return Math.abs(hash).toString(16).padStart(16, '0').substring(0, 16);\n}\n\n// Aseguramos capturar el body correctamente desde el nodo anterior\nconst body = $json.body || $json;\n\n// CAMPOS BÃSICOS\nconst originalFileId = body.file_id || \"unknown\";\nconst fileTitle = body.file_title || \"unknown.pdf\";\nconst fileBinary = body.file_binary || \"\";\nconst fileUrl = body.file_url || \"unknown\";\n\n// âœ… EXTRAER project_id (UUID) del payload del frontend\nconst projectIdFromPayload = body.project_id || null;\n\n// âœ… EXTRAER METADATA DEL USUARIO\n// Usamos el operador ?. para evitar errores si metadata no existe\nconst metadata = body.metadata || {};\nconst rfqProjectName = metadata.proyect_name || body.project_name || null;\nconst userProveedor = metadata.proveedor || null;\nconst userTipoEval = metadata.evaluation || null;\nconst language = body.language || metadata.language || 'es'; \n\n// âœ… DETERMINAR MODO DE OPERACIÃ“N\nlet modoOperacion = \"CLASIFICADOR\"; \nlet datosCompletos = false;\n\nif (userProveedor && userTipoEval && Array.isArray(userTipoEval) && userTipoEval.length > 0) {\n    modoOperacion = \"VALIDADOR\";\n    datosCompletos = true;\n} else if (userProveedor || (userTipoEval && Array.isArray(userTipoEval) && userTipoEval.length > 0)) {\n    modoOperacion = \"HIBRIDO\";\n}\n\n// Generar ID estable basado en tÃ­tulo + project_id (evita colisiones entre proyectos)\nconst normalizedTitle = fileTitle.toLowerCase().trim();\nconst stableId = simpleHash(normalizedTitle + '_' + (projectIdFromPayload || ''));\n\n// ID de Documento (Ãºnico por contenido + proyecto)\nconst documentId = 'doc_' + stableId;\n\nconsole.log('ðŸ“‹ Generate IDs - project_id from frontend:', projectIdFromPayload);\n\nreturn {\n  json: {\n    file_id: stableId, // Este es tu ID estable\n    rfq_document_id: documentId,\n    file_id_original: originalFileId,\n    file_title: fileTitle,\n    file_binary: fileBinary,\n    file_url: fileUrl,\n    \n    // âœ… project_id (UUID) real del frontend - usado para filtrar por proyecto\n    project_id: projectIdFromPayload,\n    \n    // Si no hay nombre de proyecto, usamos el nombre del archivo como fallback\n    project_name: rfqProjectName || fileTitle.replace(/\\.[^/.]+$/, \"\"),\n    rfq_project_id: projectIdFromPayload || (rfqProjectName ? 'proj_' + simpleHash(rfqProjectName.toLowerCase().trim()) : 'proj_generic'),\n    \n    user_proveedor: userProveedor,\n    user_tipo_evaluacion: userTipoEval,\n    modo_operacion: modoOperacion,\n    datos_usuario_completos: datosCompletos,\n    \n    // Idioma para salidas LLM\n    language: language,\n    \n    // Guardamos una copia limpia para los nodos siguientes\n    metadata_limpia: {\n        proyect_name: rfqProjectName,\n        proveedor: userProveedor,\n        evaluation: userTipoEval\n    }\n  }\n};"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        -4704,
        4624
      ],
      "id": "c183558b-9d3e-4802-b053-b158007e74a1",
      "name": "Generate IDs1"
    },
    {
      "parameters": {
        "rules": {
          "values": [
            {
              "conditions": {
                "options": {
                  "caseSensitive": true,
                  "leftValue": "",
                  "typeValidation": "strict",
                  "version": 3
                },
                "conditions": [
                  {
                    "leftValue": "={{ $json.tipo_evaluacion }}",
                    "rightValue": "Evaluation",
                    "operator": {
                      "type": "string",
                      "operation": "contains"
                    },
                    "id": "c3ac36b0-dcd7-4e84-a72a-7e88b6f2fc2a"
                  }
                ],
                "combinator": "and"
              }
            },
            {
              "conditions": {
                "options": {
                  "caseSensitive": true,
                  "leftValue": "",
                  "typeValidation": "strict",
                  "version": 3
                },
                "conditions": [
                  {
                    "id": "529ee554-7a05-413a-9782-710d0deb6365",
                    "leftValue": "={{ $json.tipo_evaluacion }}",
                    "rightValue": "Others",
                    "operator": {
                      "type": "string",
                      "operation": "contains"
                    }
                  }
                ],
                "combinator": "and"
              }
            }
          ]
        },
        "options": {}
      },
      "type": "n8n-nodes-base.switch",
      "typeVersion": 3.4,
      "position": [
        -2048,
        4992
      ],
      "id": "969748fc-27fc-4e4e-8111-5c6409d5c3a9",
      "name": "Switch1"
    },
    {
      "parameters": {
        "model": "qwen3:8b",
        "options": {
          "temperature": 0.1,
          "numCtx": 8192,
          "numPredict": 2048
        }
      },
      "type": "@n8n/n8n-nodes-langchain.lmOllama",
      "typeVersion": 1,
      "position": [
        -1792,
        5440
      ],
      "id": "be85ffc5-63d8-47ec-bb9f-77ff567896f6",
      "name": "Ollama Extractor2",
      "credentials": {
        "ollamaApi": {
          "id": "oS2Qqti9oVfsm8XZ",
          "name": "Ollama account"
        }
      }
    },
    {
      "parameters": {
        "promptType": "define",
        "text": "=### {{ $('Generate IDs1').first().json.language === 'en' ? 'TASK: MASSIVE DELIVERABLES EXTRACTION' : 'TAREA: EXTRACCION MASIVA DE ENTREGABLES (DELIVERABLES)' }}\n\nOutput language: {{ $('Generate IDs1').first().json.language === 'en' ? 'ENGLISH' : 'ESPANOL' }}\n\n{{ $('Generate IDs1').first().json.language === 'en' ? '**OBJECTIVE:** Extract **ALL** documents, drawings and deliverables listed. **TOTAL EXHAUSTIVENESS**.\\n\\n### CRITICAL INSTRUCTIONS (DO NOT SUMMARIZE):\\n1. **TABLES:** If you find a table, extract **EACH ROW**. If there are 140 rows, return 140 items.\\n2. **DO NOT GROUP:** Maintain granularity.\\n3. **PHASES:** Infer the phase/discipline. If not possible, use General.' : '**OBJETIVO:** Extraer **TODOS** los documentos, planos y entregables listados. **EXHAUSTIVIDAD TOTAL**.\\n\\n### INSTRUCCIONES CRITICAS (NO RESUMIR):\\n1. **TABLAS:** Si encuentras una tabla, extrae **CADA FILA**. Si hay 140 filas, devuelve 140 items.\\n2. **NO AGRUPES:** Manten la granularidad.\\n3. **FASES:** Infiere la fase/disciplina. Si no, usa General.' }}\n\nProyecto: {{ $json.nombre_proyecto }}\nEvaluacion: {{ $('Loop por Tipo1').item.json.tipo_evaluacion }}\nArchivo: {{ $('Generate IDs1').first().json.file_title }}\n\n### {{ $('Generate IDs1').first().json.language === 'en' ? 'PDF TEXT' : 'TEXTO DEL PDF' }}:\n{{ $json.texto_chunk }}\n\n### {{ $('Generate IDs1').first().json.language === 'en' ? 'OUTPUT FORMAT' : 'FORMATO DE SALIDA' }}:\n```json\n[\n  { \"fase\": \"Process\", \"requisito_rfq\": \"PFD\" },\n  { \"fase\": \"Civil\", \"requisito_rfq\": \"Foundation Layout\" }\n]\n```\n\n**{{ $('Generate IDs1').first().json.language === 'en' ? 'RESPONSE (PURE JSON):' : 'RESPUESTA (JSON PURO):' }}**",
        "messages": {
          "messageValues": [
            {
              "message": "={{ $('Generate IDs1').first().json.language === 'en' ? 'You are a JSON API.\\n- DO NOT greet.\\n- DO NOT explain.\\n- DO NOT use markdown outside JSON.\\n- Your output MUST start with [ and end with ].\\n- Write all text in ENGLISH.' : 'Eres una API que devuelve JSON.\\n- NO saludes.\\n- NO expliques.\\n- NO uses markdown fuera del JSON.\\n- Tu salida DEBE empezar con [ y terminar con ].\\n- Escribe todo el texto en ESPANOL.' }}"
            }
          ]
        },
        "batching": {}
      },
      "type": "@n8n/n8n-nodes-langchain.chainLlm",
      "typeVersion": 1.7,
      "position": [
        -1728,
        5216
      ],
      "id": "4629b303-8889-46b5-9c0b-6855e6530a25",
      "name": "LLM Extractor - Deliverables"
    },
    {
      "parameters": {
        "jsCode": "// =============================================\n// NODO: Parsear Deliverables (ROBUST FALLBACK)\n// =============================================\n\nconst inputJson = $input.first().json;\n\n// 1. RECOGIDA DE DATOS RAW\nlet rawOutput = \"\";\nif (inputJson.output && typeof inputJson.output === 'string') rawOutput = inputJson.output;\nelse if (inputJson.text && typeof inputJson.text === 'string') rawOutput = inputJson.text;\nelse if (inputJson.content && typeof inputJson.content === 'string') rawOutput = inputJson.content;\nelse if (typeof inputJson === 'string') rawOutput = inputJson;\n\n// 2. INTENTO A: EXTRAER JSON\nlet items = [];\ntry {\n    const clean = rawOutput.replace(/```json/gi, '').replace(/```/g, '').trim();\n    const start = clean.indexOf('[');\n    const end = clean.lastIndexOf(']');\n    if (start !== -1 && end !== -1) {\n        items = JSON.parse(clean.substring(start, end + 1));\n    }\n} catch(e) {}\n\n// 3. INTENTO B: FALLBACK DE LISTA\nif (items.length === 0 && rawOutput) {\n    const lines = rawOutput.split('\\n');\n    let currentPhase = \"General\";\n    lines.forEach(line => {\n        const trimmed = line.trim();\n        if (!trimmed) return;\n        const numberMatch = trimmed.match(/^\\d+\\.\\s*(.*)/);\n        const bulletMatch = trimmed.match(/^[-â€¢*]\\s*(.*)/);\n        if (numberMatch) {\n            items.push({ fase: currentPhase, requisito_rfq: numberMatch[1] });\n        } else if (bulletMatch) {\n             items.push({ fase: currentPhase, requisito_rfq: bulletMatch[1] });\n        }\n    });\n}\n\n// 4. HELPER: GENERAR ID ESTABLE\nfunction generateId(str) {\n    let hash = 0;\n    for (let i = 0; i < str.length; i++) {\n        hash = ((hash << 5) - hash) + str.charCodeAt(i);\n        hash = hash & hash;\n    }\n    return 'item_' + Math.abs(hash).toString(16).padStart(12, '0');\n}\n\n// 5. NORMALIZAR Y RETORNAR\nlet loopCtx = {};\ntry {\n   const outerLoop = $('Loop por Tipo1').first().json;\n   loopCtx = {\n       rfq_project_id: outerLoop.rfq_project_id,\n       rfq_document_id: outerLoop.rfq_document_id,\n       project_name: outerLoop.nombre_proyecto,\n       tipo_evaluacion: outerLoop.tipo_evaluacion\n   };\n} catch(e){}\n\nreturn items.map(item => {\n    const phase = item.fase || \"General\";\n    const req = item.requisito_rfq || \"Sin Nombre\";\n    return {\n        json: {\n            rfq_project_id: loopCtx.rfq_project_id || \"unknown\",\n            rfq_document_id: loopCtx.rfq_document_id || \"unknown\",\n            project_name: loopCtx.project_name || \"Unknown\",\n            evaluation: loopCtx.tipo_evaluacion || \"Deliverables\",\n            fase: phase,\n            requisito_rfq: req\n        }\n    };\n});"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        -1376,
        5216
      ],
      "id": "ea75c091-9069-491b-ab77-495f4dc03bbe",
      "name": "Parsear deliverables"
    },
    {
      "parameters": {
        "model": "qwen3:8b",
        "options": {
          "temperature": 0.1,
          "numCtx": 8192,
          "numPredict": 2048
        }
      },
      "type": "@n8n/n8n-nodes-langchain.lmOllama",
      "typeVersion": 1,
      "position": [
        -1792,
        4992
      ],
      "id": "fae00d9e-76ba-4d20-81d2-3b6f19d33646",
      "name": "Ollama Extractor1",
      "credentials": {
        "ollamaApi": {
          "id": "oS2Qqti9oVfsm8XZ",
          "name": "Ollama account"
        }
      }
    },
    {
      "parameters": {
        "schemaType": "manual",
        "inputSchema": "{\n  \"type\": \"array\",\n  \"items\": {\n    \"type\": \"object\",\n    \"properties\": {\n      \"fase\": {\n        \"type\": \"string\",\n        \"description\": \"Nombre de la disciplina o Ã¡rea (ej: Process Engineering, Mechanical Engineering, Civil and Structural, Electrical Engineering, etc.)\"\n      },\n      \"requisito_rfq\": {\n        \"type\": \"string\",\n        \"description\": \"Nombre del documento o entregable especÃ­fico\"\n      }\n    },\n    \"required\": [\"fase\", \"requisito_rfq\"]\n  }\n}"
      },
      "type": "@n8n/n8n-nodes-langchain.outputParserStructured",
      "typeVersion": 1.3,
      "position": [
        -1488,
        5424
      ],
      "id": "057ebcdc-2de2-476e-8afc-8ebc5e692fef",
      "name": "Structured Output Parser1"
    },
    {
      "parameters": {
        "schemaType": "manual",
        "inputSchema": "{\n  \"type\": \"array\",\n  \"items\": {\n    \"type\": \"object\",\n    \"properties\": {\n      \"fase\": {\n        \"type\": \"string\",\n        \"description\": \"Fase del proyecto o disciplina (ej: PRE-FEED, FEED, EPC, Process Engineering, etc.)\"\n      },\n      \"requisito_rfq\": {\n        \"type\": \"string\",\n        \"description\": \"Requisito tÃ©cnico o econÃ³mico especÃ­fico\"\n      }\n    },\n    \"required\": [\"fase\", \"requisito_rfq\"]\n  }\n}"
      },
      "type": "@n8n/n8n-nodes-langchain.outputParserStructured",
      "typeVersion": 1.3,
      "position": [
        -1552,
        4992
      ],
      "id": "e1a31aee-00d8-42bb-8345-3e0d820ba108",
      "name": "Structured Output Parser2"
    },
    {
      "parameters": {
        "jsCode": "// =============================================\n// NODO: Dividir en Trozos (Chunking)\n// =============================================\n\nconst input = $input.first().json;\nconst fullText = input.texto_rfq || \"\";\n\n// OPTIMIZADO: Chunks mÃ¡s pequeÃ±os para procesamiento mÃ¡s rÃ¡pido\n// ~6000 caracteres (aprox 1.5k-2k tokens) = respuestas en 10-15 seg\nconst chunkSize = 6000;\nconst overlap = 400;\nconst chunks = [];\n\nif (fullText.length <= chunkSize) {\n    chunks.push({\n        ...input,\n        texto_chunk: fullText,\n        chunk_index: 1,\n        total_chunks: 1\n    });\n} else {\n    let start = 0;\n    while (start < fullText.length) {\n        let end = start + chunkSize;\n        let chunk = fullText.substring(start, end);\n        \n        chunks.push({\n            ...input,\n            texto_chunk: chunk,\n            chunk_index: chunks.length + 1\n        });\n\n        start += (chunkSize - overlap);\n        if (start >= fullText.length) break;\n    }\n    chunks.forEach(c => c.total_chunks = chunks.length);\n}\n\nreturn chunks;"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        -2656,
        4976
      ],
      "id": "fce727fc-5914-4168-92d7-2bdbbb23f462",
      "name": "Dividir en Trozos1"
    },
    {
      "parameters": {
        "options": {
          "reset": "={{ $json.reiniciar_bucle ? true : false }}"
        }
      },
      "type": "n8n-nodes-base.splitInBatches",
      "typeVersion": 3,
      "position": [
        -2304,
        4976
      ],
      "id": "313855d6-2d8c-48e6-a663-a4ac200d9cb1",
      "name": "Loop por Trozo1"
    },
    {
      "parameters": {
        "jsCode": "const items = $input.all();\n\nreturn items.map(item => ({\n    json: {\n        ...item.json, // Mantiene todos los datos originales (incluido tipo_evaluacion)\n        \n        // AquÃ­ estÃ¡ la correcciÃ³n: Usamos dos puntos, no el igual.\n        reiniciar_bucle: true \n    }\n}));\n"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        -2480,
        4976
      ],
      "id": "c5735507-7bc5-4a39-9c59-5b2d636e50a6",
      "name": "Reset Items1"
    },
    {
      "parameters": {
        "model": "qwen3-embedding:8b"
      },
      "type": "@n8n/n8n-nodes-langchain.embeddingsOllama",
      "typeVersion": 1,
      "position": [
        -3584,
        5088
      ],
      "id": "dacbb531-905c-46e9-b386-eef1e4565d46",
      "name": "Embeddings Ollama1",
      "credentials": {
        "ollamaApi": {
          "id": "oS2Qqti9oVfsm8XZ",
          "name": "Ollama account"
        }
      }
    },
    {
      "parameters": {
        "mode": "insert",
        "tableName": {
          "__rl": true,
          "value": "rfq",
          "mode": "list",
          "cachedResultName": "rfq"
        },
        "options": {
          "queryName": "match_rfq"
        }
      },
      "id": "e49ba08d-045c-4fd1-a902-3ec94ca350a0",
      "name": "Insert into Supabase Vectorstore1",
      "type": "@n8n/n8n-nodes-langchain.vectorStoreSupabase",
      "typeVersion": 1,
      "position": [
        -3504,
        4864
      ],
      "credentials": {
        "supabaseApi": {
          "id": "pI4CpdYLTiEEBmnz",
          "name": "Supabase account"
        }
      }
    },
    {
      "parameters": {
        "chunkSize": 800,
        "chunkOverlap": 150,
        "options": {}
      },
      "type": "@n8n/n8n-nodes-langchain.textSplitterRecursiveCharacterTextSplitter",
      "typeVersion": 1,
      "position": [
        -3328,
        5296
      ],
      "id": "902d51d9-3978-48c9-9587-9718aeea9257",
      "name": "Recursive Character Text Splitter1"
    },
    {
      "parameters": {
        "jsonMode": "expressionData",
        "jsonData": "={{ $('Preparar Texto1').item.json.text_for_classification }}",
        "options": {
          "metadata": {
            "metadataValues": [
              {
                "name": "file_id",
                "value": "={{ $('Generate IDs1').first().json.rfq_document_id }}"
              },
              {
                "name": "file_title",
                "value": "={{ $('Generate IDs1').first().json.file_title }}"
              },
              {
                "name": "tipo_evaluacion",
                "value": "={{ $('Clasificador de Tipos1').item.json.output.tipos_detectados }}"
              },
              {
                "name": "tipo-doc",
                "value": "RFQ"
              }
            ]
          }
        }
      },
      "id": "d11fac44-5a11-4726-b5d2-bda2b3d6bc61",
      "name": "Default Data Loader1",
      "type": "@n8n/n8n-nodes-langchain.documentDefaultDataLoader",
      "typeVersion": 1,
      "position": [
        -3408,
        5088
      ]
    },
    {
      "parameters": {
        "useCustomSchema": true,
        "tableId": "rfq_items_master",
        "fieldsUi": {
          "fieldValues": [
            {
              "fieldId": "project_id",
              "fieldValue": "={{ $('Generate IDs1').first().json.project_id }}"
            },
            {
              "fieldId": "evaluation_type",
              "fieldValue": "={{ $json.evaluation }}"
            },
            {
              "fieldId": "phase",
              "fieldValue": "={{ $json.fase }}"
            },
            {
              "fieldId": "requirement_text",
              "fieldValue": "={{ $json.requisito_rfq }}"
            }
          ]
        }
      },
      "type": "n8n-nodes-base.supabase",
      "typeVersion": 1,
      "position": [
        -1056,
        4992
      ],
      "id": "fa49da3a-0e3a-4fd7-af4b-bbbdec48ffdf",
      "name": "Create a row",
      "credentials": {
        "supabaseApi": {
          "id": "pI4CpdYLTiEEBmnz",
          "name": "Supabase account"
        }
      }
    },
    {
      "parameters": {
        "operation": "delete",
        "tableId": "rfq",
        "filterType": "string",
        "filterString": "=metadata->>file_id=like.*{{ $json.file_id }}*"
      },
      "id": "4f991be8-5899-468c-8895-b4a6e069ce6c",
      "name": "Delete Old Doc Rows1",
      "type": "n8n-nodes-base.supabase",
      "typeVersion": 1,
      "position": [
        -4480,
        4624
      ],
      "alwaysOutputData": true,
      "credentials": {
        "supabaseApi": {
          "id": "pI4CpdYLTiEEBmnz",
          "name": "Supabase account"
        }
      }
    },
    {
      "parameters": {
        "operation": "upsert",
        "schema": {
          "__rl": true,
          "mode": "list",
          "value": "public"
        },
        "table": {
          "__rl": true,
          "value": "document_metadata",
          "mode": "list",
          "cachedResultName": "document_metadata"
        },
        "columns": {
          "mappingMode": "defineBelow",
          "value": {
            "id": "={{ $('Generate IDs1').first().json.rfq_document_id }}",
            "title": "={{ $('Generate IDs1').first().json.file_title }}",
            "document_type": "=RFQ",
            "evaluation_types": "={{ $json.output.tipos_detectados }}",
            "created_at": "2026-02-11T15:13:51",
            "project_id": "={{ $('Webhook RFQ').first().json.body.project_id }}"
          },
          "matchingColumns": [
            "id"
          ],
          "schema": [
            {
              "id": "id",
              "displayName": "id",
              "required": true,
              "defaultMatch": true,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            },
            {
              "id": "title",
              "displayName": "title",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": false
            },
            {
              "id": "project_id",
              "displayName": "project_id",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": false,
              "removed": false
            },
            {
              "id": "document_type",
              "displayName": "document_type",
              "required": true,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": false,
              "removed": false
            },
            {
              "id": "provider",
              "displayName": "provider",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": false,
              "removed": false
            },
            {
              "id": "evaluation_types",
              "displayName": "evaluation_types",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "array",
              "canBeUsedToMatch": false,
              "removed": false
            },
            {
              "id": "created_at",
              "displayName": "created_at",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "dateTime",
              "canBeUsedToMatch": false,
              "removed": false
            }
          ],
          "attemptToConvertTypes": false,
          "convertFieldsToString": false
        },
        "options": {}
      },
      "type": "n8n-nodes-base.postgres",
      "typeVersion": 2.5,
      "position": [
        -3728,
        4864
      ],
      "id": "7e38cb96-cdbe-4618-9ec4-16b874f0de91",
      "name": "Insert Document Metadata2",
      "executeOnce": true,
      "credentials": {
        "postgres": {
          "id": "V0REAPph5JBLqze3",
          "name": "Postgres account"
        }
      }
    },
    {
      "parameters": {
        "promptType": "define",
        "text": "=### EXTRACCION DE REQUISITOS RFQ\n\nIdioma de salida: {{ $('Generate IDs1').first().json.language === 'en' ? 'ENGLISH' : 'ESPANOL' }}\nProyecto: {{ $json.nombre_proyecto }}\nTipo: {{ $json.tipo_evaluacion }}\nArchivo: {{ $json.file_title }}\n\n### TEXTO:\n{{ $json.texto_chunk }}\n\n---\n### INSTRUCCIONES:\n\n{{ $('Generate IDs1').first().json.language === 'en' ? 'Extract all EVALUABLE REQUIREMENTS from the text. An evaluable requirement is something concrete that a provider must comply with, deliver or demonstrate.' : 'Extrae los REQUISITOS EVALUABLES del texto. Un requisito evaluable es algo concreto que un proveedor debe cumplir, entregar o demostrar.' }}\n\n{{ $('Generate IDs1').first().json.language === 'en' ? '### WHAT IS A REQUIREMENT (extract):\\n- Concrete obligations: shall, must, will provide\\n- Specific deliverables: documents, drawings, reports\\n- Technical specifications with concrete values (standards, codes)\\n- Economic items or quotation lines (if Economical type)\\n- Personnel requirements, certifications or minimum experience\\n- Milestones with specific dates' : '### QUE ES UN REQUISITO (extraer):\\n- Obligaciones concretas: shall, must, will provide, se requiere\\n- Entregables especificos: documentos, planos, informes a entregar\\n- Especificaciones tecnicas con valores concretos (normas, estandares, codigos)\\n- Partidas economicas o lineas de cotizacion (si tipo Economical)\\n- Requisitos de personal, certificaciones o experiencia minima\\n- Plazos o hitos con fechas concretas' }}\n\n{{ $('Generate IDs1').first().json.language === 'en' ? '### WHAT IS NOT A REQUIREMENT (DO NOT extract):\\n- Introductory text, general descriptions or project context\\n- Definitions, abbreviations, glossaries\\n- Reference information that does not imply provider obligation\\n- Repetitions of the same requirement with different wording\\n- Section titles, headers, footers\\n- Generic phrases without specifying which standard' : '### QUE NO ES UN REQUISITO (NO extraer):\\n- Texto introductorio, descripciones generales o contexto del proyecto\\n- Definiciones, abreviaturas, glosarios\\n- Informacion de referencia que no implica obligacion del proveedor\\n- Repeticiones del mismo requisito con diferente redaccion\\n- Titulos de seccion, encabezados, pies de pagina\\n- Frases genericas sin especificar cual norma' }}\n\n{{ $('Generate IDs1').first().json.language === 'en' ? '### GRANULARITY LEVEL:\\n- Group related requirements from the same section into a single item\\n- DO NOT create a requirement for each sentence or bullet point\\n- A 10-page document should produce 15-40 requirements, not hundreds\\n- If a table has 20 rows of the same type, group into 1-3 requirements per category' : '### NIVEL DE GRANULARIDAD:\\n- Agrupar requisitos relacionados de una misma seccion en un solo item\\n- NO crear un requisito por cada frase o bullet point individual\\n- Un documento de 10 paginas deberia producir entre 15-40 requisitos, no cientos\\n- Si una tabla tiene 20 filas del mismo tipo, agrupar en 1-3 requisitos por categoria' }}\n\n{{ $('Generate IDs1').first().json.language === 'en' ? '### RULES:\\n1. ONLY REAL REQUIREMENTS: That the provider can answer with compliant / non-compliant\\n2. GROUP RELATED: Do not over-fragment\\n3. FAITHFUL TO TEXT: Use the original document language\\n4. DO NOT INVENT: If no clear requirements in text, return empty array []' : '### REGLAS:\\n1. SOLO REQUISITOS REALES: Que el proveedor pueda responder con cumplimos / no cumplimos\\n2. AGRUPAR LO RELACIONADO: No fragmentar en exceso\\n3. FIEL AL TEXTO: Usar el lenguaje original del documento\\n4. NO INVENTAR: Si no hay requisitos claros en el texto, devolver array vacio []' }}\n\n### FORMATO:\n```json\n[\n  { \"fase\": \"{{ $('Generate IDs1').first().json.language === 'en' ? 'Document section' : 'Seccion del documento' }}\", \"requisito_rfq\": \"{{ $('Generate IDs1').first().json.language === 'en' ? 'Requirement description' : 'Descripcion del requisito' }}\" }\n]\n```\n\n**{{ $('Generate IDs1').first().json.language === 'en' ? 'RESPONSE:' : 'RESPUESTA:' }}**",
        "messages": {
          "messageValues": [
            {
              "message": "={{ $('Generate IDs1').first().json.language === 'en' ? 'You are a Requirements Extractor for procurement processes (RFP/RFQ/RFI) in any sector.\\nYour job is to identify EVALUABLE requirements that a provider would need to comply with.\\nBe SELECTIVE: extract only concrete and verifiable obligations, not filler text.\\nGroup related requirements from the same section. Do not over-fragment.\\nA typical 10-page document should produce 15-40 requirements.\\nDO NOT invent requirements not in the text.\\nWrite requirement descriptions in ENGLISH.\\nUse strict JSON.' : 'Eres un Extractor de Requisitos para licitaciones (RFP/RFQ/RFI) de cualquier sector.\\nTu trabajo es identificar los requisitos EVALUABLES que un proveedor tendria que cumplir.\\nSe SELECTIVO: extrae solo obligaciones concretas y verificables, no texto de relleno.\\nAgrupa requisitos relacionados de la misma seccion. No fragmentes en exceso.\\nUn documento tipico de 10 paginas deberia producir entre 15-40 requisitos.\\nNO inventes requisitos que no esten en el texto.\\nEscribe las descripciones de requisitos en ESPANOL.\\nUsa JSON estricto.' }}"
            }
          ]
        },
        "batching": {}
      },
      "type": "@n8n/n8n-nodes-langchain.chainLlm",
      "typeVersion": 1.7,
      "position": [
        -1744,
        4800
      ],
      "id": "cba79c0c-0d0e-4649-b6ad-9e773a8acca0",
      "name": "LLM Extractor Tech-Econ"
    },
    {
      "parameters": {
        "options": {}
      },
      "type": "@n8n/n8n-nodes-langchain.lmChatOpenRouter",
      "typeVersion": 1,
      "position": [
        -1968,
        5216
      ],
      "id": "d6c3665c-9001-44c2-b3d3-2334a191ed40",
      "name": "OpenRouter Chat Model7",
      "credentials": {
        "openRouterApi": {
          "id": "4AyUqsh1Z35g6bci",
          "name": "OpenRouter account"
        }
      }
    },
    {
      "parameters": {
        "options": {}
      },
      "type": "@n8n/n8n-nodes-langchain.lmChatOpenRouter",
      "typeVersion": 1,
      "position": [
        -4032,
        5328
      ],
      "id": "ce198106-c776-45f3-bd31-0c6cd1743802",
      "name": "OpenRouter Chat Model8",
      "credentials": {
        "openRouterApi": {
          "id": "4AyUqsh1Z35g6bci",
          "name": "OpenRouter account"
        }
      }
    },
    {
      "parameters": {
        "httpMethod": "POST",
        "path": "qa-audit-generator",
        "responseMode": "responseNode",
        "options": {}
      },
      "type": "n8n-nodes-base.webhook",
      "typeVersion": 2.1,
      "position": [
        -10448,
        3360
      ],
      "id": "875295b6-fd27-468f-af37-b89ec67edb74",
      "name": "Webhook Inbound",
      "webhookId": "0496e481-bb76-42f1-b3d5-734935b4b631"
    },
    {
      "parameters": {
        "assignments": {
          "assignments": [
            {
              "id": "project_id",
              "name": "project_id",
              "value": "={{ $json.body.project_id }}",
              "type": "string"
            },
            {
              "id": "provider",
              "name": "provider",
              "value": "={{ $json.body.provider }}",
              "type": "string"
            },
            {
              "id": "language-field-qa",
              "name": "language",
              "value": "={{ $json.body.language || 'es' }}",
              "type": "string"
            },
            {
              "id": "currency-field-qa",
              "name": "currency",
              "value": "={{ $json.body.currency || 'EUR' }}",
              "type": "string"
            },
            {
              "id": "project-type-field-qa",
              "name": "project_type",
              "value": "={{ $json.body.project_type || 'RFP' }}",
              "type": "string"
            }
          ]
        },
        "options": {}
      },
      "type": "n8n-nodes-base.set",
      "typeVersion": 3.4,
      "position": [
        -10224,
        3360
      ],
      "id": "f6dcf2f3-c3e3-4dde-a28d-b3c8eca4a900",
      "name": "Set Input Params"
    },
    {
      "parameters": {
        "useCustomSchema": true,
        "operation": "getAll",
        "tableId": "provider_responses",
        "returnAll": true,
        "matchType": "allFilters",
        "filters": {
          "conditions": [
            {
              "keyName": "provider_name",
              "condition": "eq",
              "keyValue": "={{ $('Webhook Inbound').first().json.body.provider }}"
            },
            {
              "keyName": "project_id",
              "condition": "eq",
              "keyValue": "={{ $('Webhook Inbound').first().json.body.project_id }}"
            }
          ]
        }
      },
      "type": "n8n-nodes-base.supabase",
      "typeVersion": 1,
      "position": [
        -9776,
        3360
      ],
      "id": "1cf9da63-caed-4b3b-a62a-79f1adf85dc1",
      "name": "Fetch All Provider Responses",
      "credentials": {
        "supabaseApi": {
          "id": "pI4CpdYLTiEEBmnz",
          "name": "Supabase account"
        }
      }
    },
    {
      "parameters": {
        "jsCode": "// =============================================\n// NODO: Filter Deficiencies Only\n// Solo incluye items que realmente son deficiencias\n// =============================================\n\nconst items = $input.all();\n\n// Valores que indican deficiencias (necesitan Q&A)\nconst DEFICIENCY_VALUES = [\n  'PARTIALLY INCLUDED',\n  'NOT INCLUDED WITH ALTERNATIVE',\n  'NOT INCLUDED',\n  'NO INFORMATION'\n];\n\n// Valores que NO son deficiencias (no necesitan Q&A)\nconst OK_VALUES = [\n  'INCLUDED',\n  'INCLUDED WITH CAVEATS'\n];\n\nconst filteredItems = items.filter(item => {\n  const evalValue = (item.json.evaluation_value || '').toUpperCase().trim();\n  \n  // Si es un valor OK, excluir\n  if (OK_VALUES.some(v => evalValue === v.toUpperCase())) {\n    return false;\n  }\n  \n  // Caso 1: Es uno de los valores de deficiencia conocidos\n  if (DEFICIENCY_VALUES.some(v => evalValue.includes(v.toUpperCase()))) {\n    return true;\n  }\n  \n  // Caso 2: Empieza con \"NO VALUE FOUND\" (evaluaciÃ³n econÃ³mica sin valor)\n  if (evalValue.startsWith('NO VALUE FOUND')) {\n    return true;\n  }\n  \n  // Caso 3: Score bajo (menor a 5) como indicador de deficiencia\n  const score = item.json.score || 0;\n  if (score < 5) {\n    return true;\n  }\n  \n  // Por defecto, excluir (valores econÃ³micos con precios, etc.)\n  return false;\n});\n\nconsole.log(`ðŸ“‹ Filtrado de deficiencias:`);\nconsole.log(`   â”œâ”€ Total recibidos: ${items.length}`);\nconsole.log(`   â””â”€ Deficiencias encontradas: ${filteredItems.length}`);\n\n// Log de valores excluidos para debug\nconst excluded = items.length - filteredItems.length;\nif (excluded > 0) {\n  console.log(`   â”œâ”€ Excluidos (valores OK o econÃ³micos): ${excluded}`);\n}\n\nreturn filteredItems;"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        -9552,
        3360
      ],
      "id": "1845d9f3-7cfd-4a16-8612-daa0efee2cd9",
      "name": "Filter Deficiencies Only"
    },
    {
      "parameters": {
        "useCustomSchema": true,
        "operation": "getAll",
        "tableId": "rfq_items_master",
        "limit": 1,
        "filters": {
          "conditions": [
            {
              "keyName": "id",
              "condition": "eq",
              "keyValue": "={{ $json.requirement_id }}"
            }
          ]
        }
      },
      "type": "n8n-nodes-base.supabase",
      "typeVersion": 1,
      "position": [
        -9328,
        3360
      ],
      "id": "031d7216-ebe1-4ff2-b182-d609544ebecd",
      "name": "Fetch Requirement Specs",
      "credentials": {
        "supabaseApi": {
          "id": "pI4CpdYLTiEEBmnz",
          "name": "Supabase account"
        }
      }
    },
    {
      "parameters": {
        "aggregate": "aggregateAllItemData",
        "destinationFieldName": "total_deficiencies",
        "options": {}
      },
      "type": "n8n-nodes-base.aggregate",
      "typeVersion": 1,
      "position": [
        -9104,
        3360
      ],
      "id": "8d5869d4-e036-4f79-a89e-900abadcd636",
      "name": "Consolidate Deficiencies"
    },
    {
      "parameters": {
        "promptType": "define",
        "text": "=Generate technical audit questions based on the following deficiencies detected for the provider {{ $(\"Set Input Params\").first().json.provider }}.\n\n**OUTPUT LANGUAGE**: {{ $('Set Input Params').first().json.language === 'en' ? 'ENGLISH - All questions and text must be in English.' : 'SPANISH - All questions and text must be in Spanish.' }}\n**CURRENCY**: {{ $('Set Input Params').first().json.currency || 'EUR' }} (use this currency when referencing monetary values in questions)\n\n**PROJECT TYPE**: {{ $('Set Input Params').first().json.project_type || 'RFP' }}\n{{ $('Set Input Params').first().json.project_type === 'RFI' ? '**RFI MODE**: Generate questions focused on technical capability, experience, and information completeness. Do NOT generate questions about pricing or commercial terms.' : ($('Set Input Params').first().json.project_type === 'RFQ' ? '**RFQ MODE**: Prioritize questions about pricing clarity, payment conditions, cost breakdown, and commercial terms. Include technical questions only when pricing depends on technical scope.' : '**RFP MODE**: Generate balanced questions covering both technical gaps and commercial/pricing clarifications.') }}\n\n**CRITICAL â€” VALID requirement_id VALUES**: The ONLY valid UUIDs you can use as requirement_id are listed below. Copy them CHARACTER BY CHARACTER. Do NOT invent or modify them.\n{{ $json.total_deficiencies.map(d => 'â€¢ \"' + (d.id || '') + '\" â†’ ' + (d.requirement_text || '').substring(0, 80)).join('\\n') }}\n\nEach question MUST use one of the above UUIDs as its requirement_id, linking the question to its source deficiency.\n\nDEFICIENCIES (full details):\n{{ JSON.stringify($json.total_deficiencies) }}\n\n## PROJECT CONTEXT: {{ $('Fetch Project Context QA').first().json.ai_context }}\n\n## DISCIPLINES:\n{{ $('Fetch Project Context QA').first().json.disciplines ? 'Use ONLY these project-specific disciplines: ' + $('Fetch Project Context QA').first().json.disciplines.join(', ') : 'No disciplines defined yet for this project. You MUST first determine the appropriate engineering disciplines based on the project context and the deficiencies provided. Typical disciplines include: Electrical, Mechanical, Civil, Process, Instrumentation, Structural, Environmental, General, etc. Choose the ones that best fit this specific project.' }}\n\n### INSTRUCTIONS:\n1.  **Link to Requirement**: Each question MUST include the \"requirement_id\" (the \"id\" field from the deficiency it relates to).\n2.  **Determine Disciplines**: First, identify the relevant engineering disciplines for THIS project based on the deficiencies and project context. Then classify each question into the most specific discipline.\n    - Be as specific as possible. Do not label everything as \"General\".\n    - Only use \"General\" if it is truly administrative or multi-disciplinary.\n3.  **Language**: All questions and text MUST be in {{ $('Set Input Params').first().json.language === 'en' ? 'English' : 'Spanish' }}.\n4.  **Format**: Respond strictly with the JSON object following the schema.\n\n### OUTPUT SCHEMA:\n{\n  \"disciplines\": [\"list of all unique discipline names used in the questions below\"],\n  \"questions\": [\n    {\n      \"requirement_id\": \"uuid-from-deficiency-id-field\",\n      \"discipline\": \"One of the disciplines listed above\",\n      \"question\": \"The specific question in {{ $('Set Input Params').first().json.language === 'en' ? 'English' : 'Spanish' }}\",\n      \"importance\": \"High\" | \"Medium\" | \"Low\"\n    }\n  ]\n}",
        "hasOutputParser": true,
        "batching": {}
      },
      "type": "@n8n/n8n-nodes-langchain.chainLlm",
      "typeVersion": 1.8,
      "position": [
        -8880,
        3360
      ],
      "id": "7fdf27cf-d4c6-4dbc-a8ec-37a3cb588a31",
      "name": "QA Generation Chain"
    },
    {
      "parameters": {
        "schemaType": "manual",
        "inputSchema": "{\n  \"type\": \"object\",\n  \"properties\": {\n    \"disciplines\": {\n      \"type\": \"array\",\n      \"items\": { \"type\": \"string\" }\n    },\n    \"questions\": {\n      \"type\": \"array\",\n      \"items\": {\n        \"type\": \"object\",\n        \"properties\": {\n          \"requirement_id\": { \"type\": \"string\" },\n          \"discipline\": { \"type\": \"string\" },\n          \"question\": { \"type\": \"string\" },\n          \"importance\": { \"type\": \"string\" }\n        }\n      }\n    }\n  }\n}"
      },
      "type": "@n8n/n8n-nodes-langchain.outputParserStructured",
      "typeVersion": 1.3,
      "position": [
        -8736,
        3584
      ],
      "id": "26092689-7617-4062-928e-a1657e118b3a",
      "name": "JSON Output Parser"
    },
    {
      "parameters": {
        "fieldToSplitOut": "output.questions",
        "include": "allOtherFields",
        "options": {}
      },
      "type": "n8n-nodes-base.itemLists",
      "typeVersion": 3.1,
      "position": [
        -8528,
        3360
      ],
      "id": "705c11d0-b603-43b2-8c52-7090f470e23f",
      "name": "Split Questions List"
    },
    {
      "parameters": {
        "jsCode": "// =============================================\n// NODO: Validate Requirement IDs\n// Filtra/corrige preguntas cuyo requirement_id\n// no existe en rfq_items_master\n// Matching por hex32: tolerante a un char extra/faltante\n// Modo: Run Once for All Items\n// =============================================\n\nconst normalize = s => (s || '').toString().trim().toLowerCase();\n// Hex32: elimina guiones y trunca a 32 chars â€” identifica un UUID sin importar chars extra al final\nconst toHex32 = s => normalize(s).replace(/-/g, '').substring(0, 32);\n\nconst items = $input.all();\nconst result = [];\n\n// Log una vez\nconst firstItem = items[0];\nif (firstItem) {\n  const sampleDefs = firstItem.json.total_deficiencies || [];\n  console.log(`ðŸ” total items: ${items.length}, total_deficiencies: ${sampleDefs.length}`);\n  if (sampleDefs[0]) {\n    console.log(`   keys: ${Object.keys(sampleDefs[0]).join(', ')}`);\n    console.log(`   sample id: ${sampleDefs[0].id}`);\n  }\n}\n\nfor (const item of items) {\n  const question = item.json['output.questions'];\n  const deficiencies = item.json.total_deficiencies || [];\n\n  // Mapas de lookup\n  const exactMap = new Map(); // normalizedFull â†’ original UUID\n  const hexMap = new Map();   // hex32 â†’ original UUID\n  for (const d of deficiencies) {\n    const orig = d.id || d.item_id || d.requirement_id;\n    if (!orig) continue;\n    exactMap.set(normalize(orig), orig);\n    hexMap.set(toHex32(orig), orig);\n  }\n\n  // Fail-open: sin referencia, dejar pasar\n  if (exactMap.size === 0) {\n    result.push(item);\n    continue;\n  }\n\n  const rawReqId = question?.requirement_id;\n\n  // 1. Match exacto\n  if (exactMap.has(normalize(rawReqId))) {\n    result.push(item);\n    continue;\n  }\n\n  // 2. Match hex32 (tolera 1 char extra/faltante al final del UUID)\n  const hexMatch = hexMap.get(toHex32(rawReqId));\n  if (hexMatch) {\n    console.log(`ðŸ”§ UUID corregido: \"${rawReqId}\" â†’ \"${hexMatch}\"`);\n    item.json['output.questions'].requirement_id = hexMatch;\n    result.push(item);\n    continue;\n  }\n\n  // 3. Sin match â†’ descartar\n  console.log(`âš ï¸ No match para requirement_id: \"${rawReqId}\" â€” descartando`);\n}\n\nconsole.log(`âœ… Pasados: ${result.length}/${items.length}`);\nreturn result;"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        -8416,
        3360
      ],
      "id": "21da1569-afd2-49dc-9b09-5a38fd0721cf",
      "name": "Validate Requirement IDs"
    },
    {
      "parameters": {
        "useCustomSchema": true,
        "tableId": "qa_audit",
        "fieldsUi": {
          "fieldValues": [
            {
              "fieldId": "question",
              "fieldValue": "={{ $json['output.questions'].question }}"
            },
            {
              "fieldId": "importance",
              "fieldValue": "={{ $json['output.questions'].importance }}"
            },
            {
              "fieldId": "discipline",
              "fieldValue": "={{ $json['output.questions'].discipline }}"
            },
            {
              "fieldId": "provider_name",
              "fieldValue": "={{ $(\"Set Input Params\").first().json.provider }}"
            },
            {
              "fieldId": "project_id",
              "fieldValue": "={{ $(\"Set Input Params\").first().json.project_id }}"
            },
            {
              "fieldId": "requirement_id",
              "fieldValue": "={{ $json['output.questions'].requirement_id }}"
            },
            {
              "fieldId": "status",
              "fieldValue": "Pending"
            }
          ]
        }
      },
      "type": "n8n-nodes-base.supabase",
      "typeVersion": 1,
      "position": [
        -8304,
        3360
      ],
      "id": "2fca7b99-6e58-40e3-8195-5151ed759de6",
      "name": "Supabase Insert",
      "credentials": {
        "supabaseApi": {
          "id": "pI4CpdYLTiEEBmnz",
          "name": "Supabase account"
        }
      }
    },
    {
      "parameters": {
        "jsCode": "// Extract unique disciplines from the QA Generation Chain output\n// and merge with existing project disciplines\nconst qaOutput = $('QA Generation Chain').first().json.output || {};\nconst generatedDisciplines = qaOutput.disciplines || [];\nconst existingDisciplines = $('Fetch Project Context QA').first().json.disciplines || [];\n\n// Merge: existing + new, deduplicated\nconst allDisciplines = [...new Set([...existingDisciplines, ...generatedDisciplines])];\nconst projectId = $('Set Input Params').first().json.project_id;\n\n// Format as PostgreSQL array literal for safe Supabase handling\nconst pgArray = '{' + allDisciplines.map(d => '\"' + d.replace(/\"/g, '\\\\\"') + '\"').join(',') + '}';\n\nconsole.log(`ðŸ“‹ Disciplines for project ${projectId}:`);\nconsole.log(`   â”œâ”€ Existing: ${existingDisciplines.join(', ') || 'none'}`);\nconsole.log(`   â”œâ”€ Generated: ${generatedDisciplines.join(', ')}`);\nconsole.log(`   â””â”€ Merged (${allDisciplines.length}): ${allDisciplines.join(', ')}`);\n\nreturn [{ json: { project_id: projectId, disciplines: pgArray } }];"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        -8080,
        3360
      ],
      "id": "ee40ef0d-b227-463b-ac71-80552d355641",
      "name": "Extract Disciplines"
    },
    {
      "parameters": {
        "useCustomSchema": true,
        "operation": "update",
        "tableId": "projects",
        "matchType": "allFilters",
        "filters": {
          "conditions": [
            {
              "keyName": "id",
              "condition": "eq",
              "keyValue": "={{ $json.project_id }}"
            }
          ]
        },
        "fieldsUi": {
          "fieldValues": [
            {
              "fieldId": "disciplines",
              "fieldValue": "={{ $json.disciplines }}"
            }
          ]
        }
      },
      "type": "n8n-nodes-base.supabase",
      "typeVersion": 1,
      "position": [
        -7856,
        3360
      ],
      "id": "98bda173-628e-48b7-a72d-93c5dda9ef92",
      "name": "Save Project Disciplines",
      "credentials": {
        "supabaseApi": {
          "id": "pI4CpdYLTiEEBmnz",
          "name": "Supabase account"
        }
      }
    },
    {
      "parameters": {
        "respondWith": "allIncomingItems",
        "options": {}
      },
      "type": "n8n-nodes-base.respondToWebhook",
      "typeVersion": 1.5,
      "position": [
        -7632,
        3360
      ],
      "id": "3c06bd5c-70f3-4701-9d6b-44fd407737df",
      "name": "Respond to Webhook1"
    },
    {
      "parameters": {
        "content": "## Q&A Generator\n\n**Updated**: Dynamic disciplines per project + deficiency filtering.\n\n**Disciplines**:\n- Generated dynamically by the LLM based on project context\n- Saved to `projects.disciplines` for reuse in future runs\n- If project already has disciplines, LLM uses those\n- Merged: existing + new, deduplicated\n\n**Deficiencies filtered**:\n- PARTIALLY INCLUDED\n- NOT INCLUDED WITH ALTERNATIVE\n- NOT INCLUDED\n- NO INFORMATION\n- NO VALUE FOUND - *\n- Any item with score < 5\n\n**Excluded** (not deficiencies):\n- INCLUDED\n- INCLUDED WITH CAVEATS\n- Economic values (prices, hours, etc.)\n\n**Flow**:\n1. Receive project_id and provider\n2. Fetch project context (incl. existing disciplines)\n3. Fetch ALL provider_responses\n4. Filter only deficiencies (Code node)\n5. Fetch requirement details for each\n6. Generate questions + disciplines with LLM\n7. Save questions to qa_audit\n8. Extract & merge disciplines\n9. Save disciplines to project",
        "height": 1232,
        "width": 3448,
        "color": 7
      },
      "type": "n8n-nodes-base.stickyNote",
      "typeVersion": 1,
      "position": [
        -10816,
        2736
      ],
      "id": "7ba75d9b-5829-4d7f-9fed-ccda1b55cc6a",
      "name": "Sticky Note1"
    },
    {
      "parameters": {
        "useCustomSchema": true,
        "operation": "get",
        "tableId": "projects",
        "filters": {
          "conditions": [
            {
              "keyName": "id",
              "keyValue": "={{ $('Set Input Params').first().json.project_id }}"
            }
          ]
        }
      },
      "id": "7288ca5c-b26b-4971-9137-94f425379dee",
      "name": "Fetch Project Context QA",
      "type": "n8n-nodes-base.supabase",
      "typeVersion": 1,
      "position": [
        -10000,
        3360
      ],
      "credentials": {
        "supabaseApi": {
          "id": "pI4CpdYLTiEEBmnz",
          "name": "Supabase account"
        }
      }
    },
    {
      "parameters": {
        "options": {
          "temperature": 0.1
        }
      },
      "type": "@n8n/n8n-nodes-langchain.lmChatOpenRouter",
      "typeVersion": 1,
      "position": [
        -9136,
        3632
      ],
      "id": "d76a67b6-5eba-4ded-becb-49deefd5ecd2",
      "name": "OpenRouter Chat Model4",
      "credentials": {
        "openRouterApi": {
          "id": "4AyUqsh1Z35g6bci",
          "name": "OpenRouter account"
        }
      }
    },
    {
      "parameters": {
        "options": {}
      },
      "type": "@n8n/n8n-nodes-langchain.lmChatOpenRouter",
      "typeVersion": 1,
      "position": [
        -7040,
        6128
      ],
      "id": "2d81c573-5900-435a-a818-b58ce70b1b11",
      "name": "OpenRouter Chat Model2",
      "credentials": {
        "openRouterApi": {
          "id": "4AyUqsh1Z35g6bci",
          "name": "OpenRouter account"
        }
      }
    },
    {
      "parameters": {
        "content": "## RFQ Chat - Full Database Access",
        "height": 832,
        "width": 2016,
        "color": 3
      },
      "type": "n8n-nodes-base.stickyNote",
      "typeVersion": 1,
      "position": [
        -7248,
        2736
      ],
      "id": "ff5eb84d-67c0-4193-b1a5-95721bbae788",
      "name": "Sticky Note4"
    },
    {
      "parameters": {
        "options": {}
      },
      "type": "n8n-nodes-base.respondToWebhook",
      "typeVersion": 1.5,
      "position": [
        -5488,
        2928
      ],
      "id": "4f4c7d4c-f574-44e5-8a4a-49564d2aada6",
      "name": "Respond to Webhook5"
    },
    {
      "parameters": {
        "httpMethod": "POST",
        "path": "chat-rfq",
        "responseMode": "responseNode",
        "options": {}
      },
      "type": "n8n-nodes-base.webhook",
      "typeVersion": 2.1,
      "position": [
        -7136,
        2928
      ],
      "id": "1c911022-1f8c-41e3-8199-2a6f2c560769",
      "name": "Webhook1",
      "webhookId": "chat-rfq"
    },
    {
      "parameters": {
        "sessionIdType": "customKey",
        "sessionKey": "={{ $json.body.sessionId }}"
      },
      "id": "af74afdd-3a1f-447c-80da-fa50c00aa657",
      "name": "Postgres Chat Memory",
      "type": "@n8n/n8n-nodes-langchain.memoryPostgresChat",
      "typeVersion": 1,
      "position": [
        -6784,
        3152
      ],
      "notesInFlow": false,
      "credentials": {
        "postgres": {
          "id": "V0REAPph5JBLqze3",
          "name": "Postgres account"
        }
      }
    },
    {
      "parameters": {
        "model": "qwen3-embedding:8b"
      },
      "type": "@n8n/n8n-nodes-langchain.embeddingsOllama",
      "typeVersion": 1,
      "position": [
        -6288,
        3360
      ],
      "id": "c34f7a71-8150-4877-9273-02ab9eb81b48",
      "name": "Embeddings Ollama",
      "credentials": {
        "ollamaApi": {
          "id": "oS2Qqti9oVfsm8XZ",
          "name": "Ollama account"
        }
      }
    },
    {
      "parameters": {
        "promptType": "define",
        "text": "={{ $json.body.chatInput }}",
        "options": {
          "systemMessage": "=CRITICAL RULES - YOU MUST FOLLOW THESE:\n1. ALWAYS respond in {{ $json.body.language === 'en' ? 'ENGLISH' : 'SPANISH' }}.\n2. NEVER use emojis or emoticons in your responses.\n3. When referencing monetary values or prices, ALWAYS use {{ $json.body.currency || 'EUR' }} as the currency.\n\nYou are an expert assistant specialized in analyzing vendor proposals for RFQ evaluations.\n\nVENDORS: IDOM, SACYR, TECNICASREUNIDAS (TR), EA, SENER, TRESCA, WORLEY\n\n## AVAILABLE TOOLS\n\n### Vector Search Tools (for narrative/document content):\n- **consultar_ofertas_proveedores**: Search vendor proposal documents for detailed text, technical descriptions, and narrative content. Do NOT use this for prices or costs â€” use query_economic_offers instead.\n- **consultar_documentos_rfq**: Search original RFQ documents for client requirements and specifications.\n\n### SQL Tools (for structured data):\n- **query_economic_offers**: Query economic_offers table. Returns ACTUAL prices: total_price, net_price (after discount), discount_percentage, payment_terms, payment_schedule, tco_value, tco_breakdown, price_breakdown, optional_items, alternative_offers, validity_days, guarantees, insurance_included, taxes_included. USE THIS FIRST for any question about prices, costs, payment conditions or economic comparison between vendors.\n- **query_requirements**: Query rfq_items_master with provider_responses. Returns: requirement_text, evaluation_type (Technical/Economical/Pre-FEED/FEED), phase, provider evaluations (evaluation_value, comment).\n- **query_provider_responses**: Query provider_responses table. Filter by provider_name to get detailed vendor responses with comments.\n- **query_ranking**: Query ranking_proveedores table. Returns: overall_score (0-10 scale), compliance_percentage (%), category scores (0-10 scale), individual criterion scores (JSONB), and evaluation details with strengths/weaknesses (JSONB). Categories and weights are dynamic per project. IMPORTANT: Present data exactly as returned by the query, never invent or estimate scores.\n- **query_qa_audit**: Query qa_audit table. Filter by: provider, discipline (Electrica/Mecanica/Civil/Proceso/General), status, or all.\n\n## TOOL SELECTION GUIDE\n\n| Question Type | Tool to Use |\n|---------------|-------------|\n| Prices, costs, total price of a vendor | query_economic_offers |\n| Price comparison between vendors | query_economic_offers |\n| Payment terms, payment schedule, milestones | query_economic_offers |\n| TCO, total cost of ownership | query_economic_offers |\n| Discounts, optional items, alternatives | query_economic_offers |\n| Guarantees, insurance, taxes included | query_economic_offers |\n| Price breakdown (itemized costs) | query_economic_offers |\n| Overall ranking, who is best? | query_ranking |\n| Category scores (technical, economic, execution, HSE) | query_ranking |\n| Requirement compliance details | query_requirements |\n| Vendor evaluation details and comments | query_provider_responses |\n| Pending Q&A questions | query_qa_audit |\n| Document text, technical descriptions | consultar_ofertas_proveedores |\n| Original RFQ specifications | consultar_documentos_rfq |\n\n## ECONOMIC DATA RULES\n- ALWAYS use query_economic_offers for any question about prices, costs, payment conditions, or TCO.\n- The economic_offers table contains the ACTUAL structured data extracted from proposals. This is the source of truth for prices.\n- When presenting prices, format numbers with thousands separator and always include the currency ({{ $json.body.currency || 'EUR' }}).\n- If net_price differs from total_price, explain the discount.\n- For payment comparisons, highlight payment_terms (e.g. 30 days vs 120 days) as this significantly impacts cash flow.\n\n## SCORING\n- All scores are on a 0-10 scale.\n- Scoring categories and weights are DYNAMIC per project. Do NOT assume fixed categories or weights.\n- Always retrieve actual scores from query_ranking and present them exactly as returned.\n- NEVER invent, estimate, or hallucinate scores. If query_ranking returns no data, say so.\n\n## INSTRUCTIONS\n1. ALWAYS use tools to retrieve data before answering. Never guess.\n2. For comparisons, query multiple sources if needed.\n3. Be concise but complete when presenting economic data (show actual numbers).\n4. Remember: respond in {{ $json.body.language === 'en' ? 'English' : 'Spanish' }}, no emojis, use {{ $json.body.currency || 'EUR' }} for monetary values."
        }
      },
      "id": "4b2468ed-7753-4ab1-977d-96c17f0fc4bf",
      "name": "Chat AI Agent",
      "type": "@n8n/n8n-nodes-langchain.agent",
      "typeVersion": 1.6,
      "position": [
        -6256,
        2928
      ]
    },
    {
      "parameters": {
        "mode": "retrieve-as-tool",
        "toolName": "consultar_ofertas_proveedores",
        "toolDescription": "Search vendor technical proposals for narrative content, technical descriptions, pricing details, and compliance explanations. Use when you need detailed text from proposal documents.",
        "tableName": {
          "__rl": true,
          "value": "proposals",
          "mode": "list",
          "cachedResultName": "proposals"
        },
        "topK": 10,
        "options": {
          "queryName": "match_proposals"
        }
      },
      "type": "@n8n/n8n-nodes-langchain.vectorStoreSupabase",
      "typeVersion": 1,
      "position": [
        -6656,
        3152
      ],
      "id": "6d0fc800-1122-439e-b037-7fb81265b2c0",
      "name": "Revisar-ofertas",
      "credentials": {
        "supabaseApi": {
          "id": "pI4CpdYLTiEEBmnz",
          "name": "Supabase account"
        }
      }
    },
    {
      "parameters": {
        "model": "qwen3-embedding:8b"
      },
      "type": "@n8n/n8n-nodes-langchain.embeddingsOllama",
      "typeVersion": 1,
      "position": [
        -6576,
        3360
      ],
      "id": "8d2e269f-20b9-42c3-9e54-e227245a7106",
      "name": "Embeddings Ollama5",
      "credentials": {
        "ollamaApi": {
          "id": "oS2Qqti9oVfsm8XZ",
          "name": "Ollama account"
        }
      }
    },
    {
      "parameters": {
        "descriptionType": "manual",
        "toolDescription": "Query RFQ requirements with optional vendor responses. Use to find: requirement_text, evaluation_type (Technical/Economical/Pre-FEED/FEED), phase, and provider evaluations. Provide a search_term to filter requirements.",
        "operation": "executeQuery",
        "query": "SELECT rim.id, rim.evaluation_type, rim.phase, rim.requirement_text, pr.provider_name, pr.evaluation_value, pr.comment FROM rfq_items_master rim LEFT JOIN provider_responses pr ON rim.id = pr.requirement_id WHERE (rim.requirement_text ILIKE '%' || $1 || '%' OR rim.evaluation_type ILIKE '%' || $1 || '%') AND ($2 = '' OR rim.project_id::text = $2) ORDER BY rim.id LIMIT 30;",
        "options": {
          "queryReplacement": "={{ $fromAI('search_term', 'Keyword to search in requirements', 'string') }}, {{ $json.body.project_id || '' }}"
        }
      },
      "type": "n8n-nodes-base.postgresTool",
      "typeVersion": 2.5,
      "position": [
        -6080,
        3152
      ],
      "id": "f08010a0-6c57-48f9-9330-30f53a2b1fe3",
      "name": "query_requirements",
      "credentials": {
        "postgres": {
          "id": "V0REAPph5JBLqze3",
          "name": "Postgres account"
        }
      }
    },
    {
      "parameters": {
        "descriptionType": "manual",
        "toolDescription": "Query detailed vendor responses with comments. Use to find: evaluation_value, comment, provider_name. Provide provider_name to filter by vendor (IDOM, SACYR, TECNICASREUNIDAS, EA, SENER, TRESCA, WORLEY) or leave empty for all.",
        "operation": "executeQuery",
        "query": "SELECT pr.id, pr.provider_name, pr.evaluation_value, pr.comment, rim.requirement_text, rim.evaluation_type, rim.phase FROM provider_responses pr LEFT JOIN rfq_items_master rim ON pr.requirement_id = rim.id WHERE ($1 = '' OR pr.provider_name ILIKE '%' || $1 || '%') AND ($2 = '' OR pr.project_id::text = $2) ORDER BY pr.provider_name LIMIT 30;",
        "options": {
          "queryReplacement": "={{ $fromAI('provider_name', 'Provider name to filter (or empty for all)', 'string') }}, {{ $json.body.project_id || '' }}"
        }
      },
      "type": "n8n-nodes-base.postgresTool",
      "typeVersion": 2.5,
      "position": [
        -5952,
        3152
      ],
      "id": "4a5ea058-e778-4d56-b183-5de9516f1f24",
      "name": "query_provider_responses",
      "credentials": {
        "postgres": {
          "id": "V0REAPph5JBLqze3",
          "name": "Postgres account"
        }
      }
    },
    {
      "parameters": {
        "descriptionType": "manual",
        "toolDescription": "Query vendor rankings and scores. Returns provider_name, overall_score (0-10 scale), compliance_percentage (%), category scores (0-10 scale), individual criterion scores (JSONB), and evaluation details with strengths/weaknesses (JSONB). Categories and weights are dynamic per project. Use for ranking questions and score comparisons. Always present the data exactly as returned, never invent or estimate scores.",
        "operation": "executeQuery",
        "query": "SELECT rp.provider_name, ROUND(rp.overall_score, 2) as overall_score, rp.compliance_percentage, ROUND(rp.technical_score / 10, 2) as technical_score, ROUND(rp.economic_score / 10, 2) as economic_score, ROUND(rp.execution_score / 10, 2) as execution_score, ROUND(rp.hse_compliance_score / 10, 2) as hse_compliance_score, rp.category_scores_json, rp.individual_scores_json, rp.evaluation_details, rp.evaluation_count, rp.last_updated FROM ranking_proveedores rp WHERE ($1 = '' OR rp.project_id::text = $1) ORDER BY rp.overall_score DESC;",
        "options": {
          "queryReplacement": "={{ $json.body.project_id || '' }}"
        }
      },
      "type": "n8n-nodes-base.postgresTool",
      "typeVersion": 2.5,
      "position": [
        -5824,
        3152
      ],
      "id": "427c1649-1094-49bc-a982-11d34f77438f",
      "name": "query_ranking",
      "credentials": {
        "postgres": {
          "id": "V0REAPph5JBLqze3",
          "name": "Postgres account"
        }
      }
    },
    {
      "parameters": {
        "descriptionType": "manual",
        "toolDescription": "Query ACTUAL prices and economic data from economic_offers table. USE THIS for any question about prices, costs, payment conditions, TCO or economic comparison. Returns: provider_name, total_price, net_price (after discount), discount_percentage, discount_conditions, payment_terms, payment_schedule, tco_value, tco_period_years, tco_breakdown, price_breakdown (itemized), optional_items (with prices), alternative_offers, validity_days, guarantees, insurance_included, taxes_included, price_escalation. Filter by provider_name or leave empty for all providers.",
        "operation": "executeQuery",
        "query": "SELECT eo.provider_name, eo.total_price, eo.currency, eo.discount_percentage, eo.discount_conditions, ROUND(eo.total_price * (1 - COALESCE(eo.discount_percentage, 0)/100), 2) as net_price, eo.payment_terms, eo.payment_schedule, eo.tco_value, eo.tco_period_years, eo.tco_breakdown, eo.price_breakdown, eo.optional_items, eo.alternative_offers, eo.validity_days, eo.guarantees, eo.insurance_included, eo.taxes_included, eo.price_escalation, eo.extraction_confidence FROM economic_offers eo WHERE ($1 = '' OR eo.project_id::text = $1) ORDER BY eo.total_price ASC NULLS LAST;",
        "options": {
          "queryReplacement": "=={{ $json.body.project_id || '' }}"
        }
      },
      "type": "n8n-nodes-base.postgresTool",
      "typeVersion": 2.5,
      "position": [
        -5568,
        3152
      ],
      "id": "ceb2c374-5e41-485d-b479-80386e277276",
      "name": "query_economic_offers",
      "credentials": {
        "postgres": {
          "id": "V0REAPph5JBLqze3",
          "name": "Postgres account"
        }
      }
    },
    {
      "parameters": {
        "descriptionType": "manual",
        "toolDescription": "Query Q&A audit for technical questions and responses. Returns: provider_name, discipline (Electrica/Mecanica/Civil/Proceso/General), question, status (Pending/Approved/etc.), importance (High/Medium/Low), response. Use filter_type: 'provider' with filter_value for vendor name, 'discipline' for discipline, 'status' for status, or 'all' for everything.",
        "operation": "executeQuery",
        "query": "SELECT qa.id, qa.provider_name, qa.discipline, qa.question, qa.status, qa.importance, qa.response, qa.created_at FROM qa_audit qa WHERE (($1 = 'all') OR ($1 = 'provider' AND qa.provider_name ILIKE '%' || $2 || '%') OR ($1 = 'discipline' AND qa.discipline ILIKE '%' || $2 || '%') OR ($1 = 'status' AND qa.status ILIKE '%' || $2 || '%')) AND ($3 = '' OR qa.project_id::text = $3) ORDER BY qa.created_at DESC LIMIT 25;",
        "options": {
          "queryReplacement": "={{ $fromAI('filter_type', 'Filter type: provider, discipline, status, or all', 'string') }}, {{ $fromAI('filter_value', 'Value to filter by (provider name, discipline, or status)', 'string') }}, {{ $json.body.project_id || '' }}"
        }
      },
      "type": "n8n-nodes-base.postgresTool",
      "typeVersion": 2.5,
      "position": [
        -5696,
        3152
      ],
      "id": "fa80e9c8-424c-4305-b80a-a605b4d9d74e",
      "name": "query_qa_audit",
      "credentials": {
        "postgres": {
          "id": "V0REAPph5JBLqze3",
          "name": "Postgres account"
        }
      }
    },
    {
      "parameters": {
        "options": {
          "temperature": 0.1
        }
      },
      "type": "@n8n/n8n-nodes-langchain.lmChatOpenRouter",
      "typeVersion": 1,
      "position": [
        -6048,
        3296
      ],
      "id": "c488be28-f98a-475f-a71d-9b372aab64c1",
      "name": "OpenRouter Chat Model3",
      "credentials": {
        "openRouterApi": {
          "id": "4AyUqsh1Z35g6bci",
          "name": "OpenRouter account"
        }
      }
    },
    {
      "parameters": {
        "mode": "retrieve-as-tool",
        "toolName": "consultar_documentos_rfq",
        "toolDescription": "Search original RFQ documents for client requirements, technical specifications, scope of work, and tender documentation. Use when you need the original request details.",
        "tableName": {
          "__rl": true,
          "value": "rfq",
          "mode": "list",
          "cachedResultName": "rfq"
        },
        "topK": 10,
        "options": {
          "queryName": "match_rfq"
        }
      },
      "type": "@n8n/n8n-nodes-langchain.vectorStoreSupabase",
      "typeVersion": 1,
      "position": [
        -6368,
        3152
      ],
      "id": "a2fa7dff-d3b8-4b4b-9f0b-a1e374b1ca84",
      "name": "Revisar RFQs",
      "credentials": {
        "supabaseApi": {
          "id": "pI4CpdYLTiEEBmnz",
          "name": "Supabase account"
        }
      }
    },
    {
      "parameters": {
        "useCustomSchema": true,
        "operation": "getAll",
        "tableId": "rfq_items_master",
        "returnAll": true,
        "matchType": "allFilters",
        "filters": {
          "conditions": [
            {
              "keyName": "project_id",
              "condition": "eq",
              "keyValue": "={{ $('Set Input Params1').first().json.project_id }}"
            }
          ]
        }
      },
      "type": "n8n-nodes-base.supabase",
      "typeVersion": 1,
      "position": [
        -9664,
        4592
      ],
      "id": "254d048d-f795-40fc-9daa-6abaa1174db4",
      "name": "Fetch Requirements",
      "credentials": {
        "supabaseApi": {
          "id": "pI4CpdYLTiEEBmnz",
          "name": "Supabase account"
        }
      }
    },
    {
      "parameters": {
        "useCustomSchema": true,
        "operation": "getAll",
        "tableId": "provider_responses",
        "returnAll": true,
        "filters": {
          "conditions": [
            {
              "keyName": "project_id",
              "condition": "eq",
              "keyValue": "={{ $('Set Input Params1').first().json.project_id }}"
            }
          ]
        }
      },
      "type": "n8n-nodes-base.supabase",
      "typeVersion": 1,
      "position": [
        -9664,
        4832
      ],
      "id": "199b70c2-95b6-40a1-8ba8-aab1b6b103b0",
      "name": "Fetch Provider Responses",
      "credentials": {
        "supabaseApi": {
          "id": "pI4CpdYLTiEEBmnz",
          "name": "Supabase account"
        }
      }
    },
    {
      "parameters": {
        "useCustomSchema": true,
        "operation": "getAll",
        "tableId": "scoring_configuration_summary",
        "returnAll": true,
        "filters": {
          "conditions": [
            {
              "keyName": "project_id",
              "condition": "eq",
              "keyValue": "={{ $('Set Input Params1').first().json.project_id }}"
            }
          ]
        }
      },
      "type": "n8n-nodes-base.supabase",
      "typeVersion": 1,
      "position": [
        -9664,
        5056
      ],
      "id": "405bc67f-e887-46c8-b934-da8b7e296cc3",
      "name": "Fetch Scoring Configuration",
      "alwaysOutputData": true,
      "credentials": {
        "supabaseApi": {
          "id": "pI4CpdYLTiEEBmnz",
          "name": "Supabase account"
        }
      }
    },
    {
      "parameters": {
        "useCustomSchema": true,
        "operation": "getAll",
        "tableId": "economic_offers",
        "returnAll": true,
        "filters": {
          "conditions": [
            {
              "keyName": "project_id",
              "condition": "eq",
              "keyValue": "={{ $('Set Input Params1').first().json.project_id }}"
            }
          ]
        }
      },
      "type": "n8n-nodes-base.supabase",
      "typeVersion": 1,
      "position": [
        -9664,
        5280
      ],
      "id": "a84579ef-cc8e-471e-8bda-01ba52726ae3",
      "name": "Fetch Economic Offers",
      "alwaysOutputData": true,
      "credentials": {
        "supabaseApi": {
          "id": "pI4CpdYLTiEEBmnz",
          "name": "Supabase account"
        }
      }
    },
    {
      "parameters": {
        "numberInputs": 4
      },
      "type": "n8n-nodes-base.merge",
      "typeVersion": 3.2,
      "position": [
        -9440,
        4688
      ],
      "id": "184a6be4-ed7b-4451-b33b-ead5fd833ada",
      "name": "Merge Requirements & Responses"
    },
    {
      "parameters": {
        "jsCode": "// =============================================\n// NODO: Prepare Scoring Data (v5 - Dynamic Criteria Support)\n// Supports both hardcoded defaults and dynamic criteria from database\n// =============================================\n\nconst items = $input.all();\n\nconsole.log('ðŸ“Š Prepare Scoring Data - Starting...');\nconsole.log('   Items received:', items.length);\n\n/* =========================\nGet project_id from webhook\n========================= */\nlet projectId = null;\ntry {\n    projectId = $('Set Input Params1').first().json.project_id;\n    console.log('   ðŸ“‹ Project ID:', projectId);\n} catch (e) {\n    console.log('   âš ï¸ Could not get project_id:', e.message);\n}\n\n/* =========================\nGet Dynamic Scoring Configuration (if exists)\n========================= */\nlet dynamicConfig = null;\nlet useDynamicConfig = false;\ntry {\n    const configItems = $('Fetch Scoring Configuration').all();\n    if (configItems && configItems.length > 0 && configItems[0].json.category_name) {\n        // Parse configuration into structured format\n        const configData = configItems.map(item => item.json);\n        dynamicConfig = {\n            categories: {},\n            criteria: {},\n            criteriaWeights: {},\n            categoryWeights: {}\n        };\n        \n        configData.forEach(row => {\n            const catName = row.category_name;\n            const catWeight = parseFloat(row.category_weight) || 0;\n            \n            if (!dynamicConfig.categories[catName]) {\n                dynamicConfig.categories[catName] = {\n                    name: catName,\n                    display_name: row.category_display_name,\n                    weight: catWeight,\n                    color: row.category_color,\n                    criteria: []\n                };\n                dynamicConfig.categoryWeights[catName.toUpperCase()] = catWeight / 100;\n            }\n            \n            if (row.criterion_name) {\n                const critName = row.criterion_name;\n                const critWeight = parseFloat(row.criterion_weight) || 0;\n                const actualWeight = (critWeight * catWeight) / 10000; // criterion_weight% of category_weight%\n                \n                dynamicConfig.criteria[critName] = {\n                    name: critName,\n                    display_name: row.criterion_display_name,\n                    description: row.criterion_description,\n                    category: catName,\n                    weight: critWeight,\n                    keywords: row.criterion_keywords || []\n                };\n                dynamicConfig.criteriaWeights[critName] = actualWeight;\n                dynamicConfig.categories[catName].criteria.push(critName);\n            }\n        });\n        \n        useDynamicConfig = Object.keys(dynamicConfig.criteria).length > 0;\n        console.log('   âœ… Dynamic configuration loaded:', Object.keys(dynamicConfig.criteria).length, 'criteria');\n    }\n} catch (e) {\n    console.log('   âš ï¸ Could not load dynamic config:', e.message);\n}\n\n/* =========================\nDefault Criteria (fallback)\n========================= */\nconst DEFAULT_CRITERIA_WEIGHTS = {\n    scope_facilities: 0.10,\n    scope_work: 0.10,\n    deliverables_quality: 0.10,\n    total_price: 0.15,\n    price_breakdown: 0.08,\n    optionals_included: 0.07,\n    capex_opex_methodology: 0.05,\n    schedule: 0.08,\n    resources_allocation: 0.06,\n    exceptions: 0.06,\n    safety_studies: 0.08,\n    regulatory_compliance: 0.07\n};\n\nconst DEFAULT_CATEGORY_WEIGHTS = {\n    TECHNICAL: 0.30,\n    ECONOMIC: 0.35,\n    EXECUTION: 0.20,\n    HSE_COMPLIANCE: 0.15\n};\n\n// Use dynamic or default\nconst CRITERIA_WEIGHTS = useDynamicConfig ? dynamicConfig.criteriaWeights : DEFAULT_CRITERIA_WEIGHTS;\nconst CATEGORY_WEIGHTS = useDynamicConfig ? dynamicConfig.categoryWeights : DEFAULT_CATEGORY_WEIGHTS;\n\nconsole.log('   ðŸ“Š Using', useDynamicConfig ? 'DYNAMIC' : 'DEFAULT', 'configuration');\nconsole.log('   ðŸ“Š Criteria:', Object.keys(CRITERIA_WEIGHTS).join(', '));\n\n/* =========================\nHelpers - Map requirements to criteria\n========================= */\nfunction getCriterionFromRequirement(evalType, phase, reqText, keywords) {\n    const type = (evalType || '').toLowerCase();\n    const phaseL = (phase || '').toLowerCase();\n    const text = (reqText || '').toLowerCase();\n    \n    // If using dynamic config, try to match by keywords first\n    if (useDynamicConfig && dynamicConfig.criteria) {\n        for (const [critName, critInfo] of Object.entries(dynamicConfig.criteria)) {\n            const kws = critInfo.keywords || [];\n            for (const kw of kws) {\n                if (text.includes(kw.toLowerCase())) {\n                    return critName;\n                }\n            }\n        }\n    }\n    \n    // Fallback to default mapping logic\n    if (type.includes('technical')) {\n        if (text.includes('scope of facilities') || text.includes('hydrogen plant') || text.includes('utilities')) {\n            return 'scope_facilities';\n        }\n        if (text.includes('scope of work') || text.includes('project management') || text.includes('deliverables')) {\n            return 'scope_work';\n        }\n        if (text.includes('p&id') || text.includes('3d model') || text.includes('specification') || text.includes('datasheet')) {\n            return 'deliverables_quality';\n        }\n        return 'scope_work';\n    }\n    \n    if (type.includes('econom')) {\n        if (text.includes('price') || text.includes('â‚¬') || text.includes('fee') || text.includes('cost')) {\n            return 'total_price';\n        }\n        if (text.includes('hour') || text.includes('discipline') || text.includes('breakdown')) {\n            return 'price_breakdown';\n        }\n        if (text.includes('optional') || text.includes('geotechnical') || text.includes('topograph') || text.includes('hazid')) {\n            return 'optionals_included';\n        }\n        if (text.includes('capex') || text.includes('opex') || text.includes('aacei') || text.includes('estimate')) {\n            return 'capex_opex_methodology';\n        }\n        return 'total_price';\n    }\n    \n    if (text.includes('hse') || text.includes('safety') || text.includes('hazop') || text.includes('hazid') || text.includes('atex') || text.includes('qra')) {\n        return 'safety_studies';\n    }\n    if (text.includes('code') || text.includes('standard') || text.includes('compliance') || text.includes('regulation')) {\n        return 'regulatory_compliance';\n    }\n    \n    if (phaseL.includes('pre-feed') || phaseL.includes('feed') || type.includes('deliverable')) {\n        if (text.includes('schedule') || text.includes('planning') || text.includes('timeline')) {\n            return 'schedule';\n        }\n        if (text.includes('exception') || text.includes('deviation') || text.includes('exclusion')) {\n            return 'exceptions';\n        }\n        return 'resources_allocation';\n    }\n    \n    return 'scope_work';\n}\n\nfunction classifyEval(val) {\n    const v = (val || '').toUpperCase();\n    if (v.includes('INCLUD') || v.includes('INCLUIDO') || v === 'SI' || v === 'YES') return 'INCLUDED';\n    if (v.includes('PARCIAL') || v.includes('PARTIAL')) return 'PARTIAL';\n    if (v.includes('NO INCLUD') || v.includes('NOT INCLUD') || v === 'NO') return 'NOT_INCLUDED';\n    return 'NO_INFO';\n}\n\n/* =========================\nGet data from previous nodes\n========================= */\nlet requirements = [];\nlet responses = [];\n\ntry {\n    const reqItems = $('Fetch Requirements').all();\n    requirements = reqItems.map(item => item.json);\n    console.log('   âœ… Requirements from Fetch Requirements:', requirements.length);\n} catch (e) {\n    console.log('   âš ï¸ Could not access Fetch Requirements:', e.message);\n}\n\ntry {\n    const respItems = $('Fetch Provider Responses').all();\n    responses = respItems.map(item => item.json);\n    console.log('   âœ… Responses from Fetch Provider Responses:', responses.length);\n} catch (e) {\n    console.log('   âš ï¸ Could not access Fetch Provider Responses:', e.message);\n}\n\nif (requirements.length === 0 || responses.length === 0) {\n    console.log('   ðŸ”„ Using fallback: separating from input...');\n    items.forEach(item => {\n        const data = item.json;\n        if (data.requirement_text && !data.provider_name) {\n            requirements.push(data);\n        } else if (data.provider_name && data.requirement_id) {\n            responses.push(data);\n        }\n    });\n}\n\nif (requirements.length === 0) {\n    return [{ json: { error: 'No requirements found', items_received: items.length } }];\n}\nif (responses.length === 0) {\n    return [{ json: { error: 'No responses found', items_received: items.length } }];\n}\n\n/* =========================\nOptimization with MAPS\n========================= */\nconst requirementMap = {};\nrequirements.forEach(r => {\n    if (r.id) requirementMap[r.id] = r;\n});\n\nconst responsesByProvider = {};\nresponses.forEach(r => {\n    if (r.provider_name) {\n        if (!responsesByProvider[r.provider_name]) {\n            responsesByProvider[r.provider_name] = [];\n        }\n        responsesByProvider[r.provider_name].push(r);\n    }\n});\n\nconsole.log('   ðŸ“Š Providers found:', Object.keys(responsesByProvider).join(', '));\n\n/* =========================\nGet Economic Offers Data\n========================= */\nlet economicOffers = [];\ntry {\n    const econItems = $('Fetch Economic Offers').all();\n    economicOffers = econItems.map(item => item.json);\n    console.log('   âœ… Economic Offers:', economicOffers.length);\n} catch (e) {\n    console.log('   âš ï¸ Could not access Economic Offers:', e.message);\n}\n\nconst economicByProvider = {};\neconomicOffers.forEach(offer => {\n    if (offer.provider_name) {\n        economicByProvider[offer.provider_name] = offer;\n        economicByProvider[offer.provider_name.toUpperCase()] = offer;\n    }\n});\n\nconsole.log('   ðŸ’° Economic data for:', economicOffers.map(o => o.provider_name).join(', '));\n\n/* =========================\nHelper: Score economic criteria from economic_offers\n========================= */\nfunction getEconomicScore(criterionName, keywords, providerOffer, allOffers) {\n    if (!providerOffer) return null;\n    const name = (criterionName || '').toLowerCase();\n    const kws = (keywords || []).map(k => k.toLowerCase());\n    \n    // TCO / Total Price / Total Cost\n    if (name.includes('tco') || name.includes('total_cost') || name.includes('total_price') ||\n        kws.some(k => k.includes('tco') || k.includes('total cost') || k.includes('investment') || k.includes('coste total'))) {\n        const myPrice = providerOffer.tco_value || providerOffer.total_price;\n        if (!myPrice) return null;\n        const prices = allOffers.filter(o => (o.tco_value || o.total_price) > 0).map(o => o.tco_value || o.total_price);\n        if (prices.length <= 1) return 7;\n        const minP = Math.min(...prices);\n        const maxP = Math.max(...prices);\n        if (minP === maxP) return 7;\n        return Math.round((9 - ((myPrice - minP) / (maxP - minP)) * 5) * 100) / 100;\n    }\n    \n    // Price Breakdown / Transparency\n    if (name.includes('breakdown') || name.includes('transparency') || name.includes('desglose') || name.includes('capex') ||\n        kws.some(k => k.includes('breakdown') || k.includes('itemized') || k.includes('desglose') || k.includes('capex') || k.includes('opex'))) {\n        const bd = providerOffer.price_breakdown;\n        if (!bd || typeof bd !== 'object') return 2;\n        const entries = Object.keys(bd).length;\n        if (entries >= 5) return 9;\n        if (entries >= 3) return 7;\n        if (entries >= 1) return 5;\n        return 2;\n    }\n    \n    // Energy Efficiency / Savings / PUE\n    if (name.includes('energy') || name.includes('efficiency') || name.includes('savings') || name.includes('pue') ||\n        kws.some(k => k.includes('energy') || k.includes('pue') || k.includes('efficiency') || k.includes('roi'))) {\n        const tcoB = providerOffer.tco_breakdown;\n        if (tcoB && typeof tcoB === 'object') {\n            const eKeys = Object.keys(tcoB).filter(k =>\n                k.toLowerCase().includes('energy') || k.toLowerCase().includes('electric') ||\n                k.toLowerCase().includes('pue') || k.toLowerCase().includes('cooling'));\n            if (eKeys.length > 0) return 7;\n        }\n        const opts = providerOffer.optional_items || [];\n        const eOpts = opts.filter(o => {\n            const d = (o.description || '').toLowerCase();\n            return d.includes('energy') || d.includes('efficiency') || d.includes('pue') || d.includes('solar');\n        });\n        if (eOpts.length > 0) return 6;\n        if (providerOffer.total_price) return 3;\n        return null;\n    }\n    \n    // Payment Terms / Milestones\n    if (name.includes('payment') || name.includes('milestone') || name.includes('pago') || name.includes('plazo') ||\n        kws.some(k => k.includes('payment') || k.includes('milestone') || k.includes('pago') || k.includes('financing'))) {\n        const hasPT = providerOffer.payment_terms && providerOffer.payment_terms.trim().length > 0;\n        const hasPS = providerOffer.payment_schedule && providerOffer.payment_schedule.length > 0;\n        if (hasPT && hasPS) return 8;\n        if (hasPT || hasPS) return 5;\n        if (providerOffer.discount_percentage > 0) return 4;\n        return null;\n    }\n    \n    // Discount / Optionals\n    if (name.includes('optional') || name.includes('discount') || name.includes('descuento') ||\n        kws.some(k => k.includes('optional') || k.includes('discount') || k.includes('alternative'))) {\n        let s = 3;\n        if ((providerOffer.optional_items || []).length > 0) s += 2;\n        if ((providerOffer.alternative_offers || []).length > 0) s += 2;\n        if ((providerOffer.discount_percentage || 0) > 0) s += 2;\n        return Math.min(s, 9);\n    }\n    \n    // Schedule / Timeline\n    if (name.includes('schedule') || name.includes('timeline') || name.includes('cronograma') ||\n        kws.some(k => k.includes('schedule') || k.includes('timeline') || k.includes('gantt'))) {\n        if (providerOffer.validity_days > 0) return 5;\n        return null;\n    }\n    \n    return null;\n}\n\n/* =========================\nProvider filter (optional)\n========================= */\nlet providerFilter = '';\ntry {\n    providerFilter = $('Set Input Params1').first().json.provider_filter || '';\n} catch (e) {}\n\nlet providers = Object.keys(responsesByProvider);\nif (providerFilter) {\n    providers = providers.filter(p => p.toLowerCase().includes(providerFilter.toLowerCase()));\n}\n\nif (providers.length === 0) {\n    return [{ json: { error: 'No providers found', filter: providerFilter } }];\n}\n\n/* =========================\nEvaluation by Criteria\n========================= */\nconst evaluationData = providers.map(providerName => {\n    const providerResponses = responsesByProvider[providerName] || [];\n    \n    // Initialize criteria summary\n    const criteriaScores = {};\n    Object.keys(CRITERIA_WEIGHTS).forEach(criterion => {\n        criteriaScores[criterion] = { total: 0, included: 0, partial: 0, not_included: 0, no_info: 0, scores: [], comments: [] };\n    });\n    \n    providerResponses.forEach(resp => {\n        const req = requirementMap[resp.requirement_id];\n        if (!req) return;\n        \n        const criterion = getCriterionFromRequirement(req.evaluation_type, req.phase, req.requirement_text);\n        const evalClass = classifyEval(resp.evaluation_value);\n        \n        const cs = criteriaScores[criterion];\n        if (!cs) return;\n        \n        cs.total++;\n        if (evalClass === 'INCLUDED') cs.included++;\n        else if (evalClass === 'PARTIAL') cs.partial++;\n        else if (evalClass === 'NOT_INCLUDED') cs.not_included++;\n        else cs.no_info++; if (resp.comment && resp.comment.trim().length > 0) { cs.comments.push(resp.comment.trim().substring(0, 400)); }\n        \n        if (typeof resp.score === 'number' && resp.score > 0) {\n            cs.scores.push(resp.score);\n        }\n    });\n    \n    // Calculate average scores per criterion\n    let globalScore = 0;\n    const criteriaAvgScores = {};\n    \n    Object.keys(criteriaScores).forEach(criterion => {\n        const cs = criteriaScores[criterion];\n        if (cs.scores.length > 0) {\n            cs.avg_score = Math.round((cs.scores.reduce((a, b) => a + b, 0) / cs.scores.length) * 100) / 100;\n        } else if (cs.total > 0) {\n            // Calculate based on items with actual evaluations (exclude no_info from denominator)\n            const evaluated = cs.included + cs.partial + cs.not_included;\n            if (evaluated > 0) {\n                cs.avg_score = Math.round(((cs.included * 9 + cs.partial * 6 + cs.not_included * 2) / evaluated) * 100) / 100;\n            } else {\n                cs.avg_score = 0;\n            }\n        } else {\n            cs.avg_score = 0;\n        }\n        criteriaAvgScores[criterion] = cs.avg_score;\n        globalScore += cs.avg_score * (CRITERIA_WEIGHTS[criterion] || 0);\n        delete cs.scores;\n    });\n    \n    globalScore = Math.round(globalScore * 100) / 100;\n    \n    // === ECONOMIC ENRICHMENT: Use economic_offers data to improve scores ===\n    const providerEconOffer = economicByProvider[providerName] || economicByProvider[providerName.toUpperCase()];\n    if (providerEconOffer) {\n        console.log('   ðŸ’° Enriching scores for', providerName, 'with economic data');\n        let enrichedCount = 0;\n        globalScore = 0;\n        \n        Object.keys(criteriaAvgScores).forEach(crit => {\n            const critInfo = useDynamicConfig && dynamicConfig.criteria[crit] ? dynamicConfig.criteria[crit] : null;\n            const kws = critInfo ? critInfo.keywords : [];\n            const econScore = getEconomicScore(crit, kws, providerEconOffer, economicOffers);\n            \n            if (econScore !== null && (((c => c === 'total_price' || c.includes('tco') || c.includes('total_cost'))(crit.toLowerCase())) || econScore > criteriaAvgScores[crit])) {\n                console.log('     ðŸ’°', crit, ':', criteriaAvgScores[crit], 'â†’', econScore, '(economic data)');\n                criteriaAvgScores[crit] = econScore;\n                enrichedCount++;\n            }\n            \n            globalScore += criteriaAvgScores[crit] * (CRITERIA_WEIGHTS[crit] || 0);\n        });\n        \n        globalScore = Math.round(globalScore * 100) / 100;\n        console.log('   ðŸ’° Enriched', enrichedCount, 'criteria â†’ new global:', globalScore);\n    }\n    \n    // Calculate category scores dynamically\n    let categoryScores = {};\n    if (useDynamicConfig) {\n        for (const [catName, catInfo] of Object.entries(dynamicConfig.categories)) {\n            const catCriteria = catInfo.criteria || [];\n            const scores = catCriteria.map(c => criteriaAvgScores[c] || 0);\n            const avg = scores.length > 0 ? scores.reduce((a, b) => a + b, 0) / scores.length : 0;\n            categoryScores[catName.toUpperCase()] = Math.round(avg * 100) / 100;\n        }\n    } else {\n        categoryScores = {\n            TECHNICAL: Math.round(((criteriaAvgScores.scope_facilities || 0) + (criteriaAvgScores.scope_work || 0) + (criteriaAvgScores.deliverables_quality || 0)) / 3 * 100) / 100,\n            ECONOMIC: Math.round(((criteriaAvgScores.total_price || 0) + (criteriaAvgScores.price_breakdown || 0) + (criteriaAvgScores.optionals_included || 0) + (criteriaAvgScores.capex_opex_methodology || 0)) / 4 * 100) / 100,\n            EXECUTION: Math.round(((criteriaAvgScores.schedule || 0) + (criteriaAvgScores.resources_allocation || 0) + (criteriaAvgScores.exceptions || 0)) / 3 * 100) / 100,\n            HSE_COMPLIANCE: Math.round(((criteriaAvgScores.safety_studies || 0) + (criteriaAvgScores.regulatory_compliance || 0)) / 2 * 100) / 100\n        };\n    }\n    \n    return {\n        provider_name: providerName,\n        project_id: projectId,\n        total_responses: providerResponses.length,\n        global_score: globalScore,\n        category_scores: categoryScores,\n        criteria_scores: criteriaAvgScores,\n        criteria_summary: criteriaScores,\n        config_type: useDynamicConfig ? 'dynamic' : 'default',\n        scoring_config: useDynamicConfig ? dynamicConfig : null,\n        economic_data: economicByProvider[providerName] || economicByProvider[providerName.toUpperCase()] || null\n    };\n});\n\n/* =========================\nExecutive Ranking\n========================= */\nevaluationData\n    .sort((a, b) => b.global_score - a.global_score)\n    .forEach((item, index) => {\n        item.rank = index + 1;\n    });\n\nconsole.log('âœ… Scoring Data prepared for', evaluationData.length, 'providers');\nconsole.log('   Project ID included:', projectId);\nconsole.log('   Config type:', useDynamicConfig ? 'DYNAMIC' : 'DEFAULT');\n\n/* === Cross-provider relative normalization (non-price criteria) === */ const _nCrit = Object.keys(CRITERIA_WEIGHTS).filter(c => c !== 'total_price' && !c.includes('tco') && !c.includes('total_cost')); if (evaluationData.length > 1) { _nCrit.forEach(crit => { const _sc = evaluationData.map(d => d.criteria_scores[crit] || 0).filter(s => s > 0); if (_sc.length < 2) return; const _mn = Math.min(..._sc), _mx = Math.max(..._sc); if (_mx - _mn < 0.2) return; evaluationData.forEach(d => { const r = d.criteria_scores[crit]; if (r > 0) d.criteria_scores[crit] = Math.round((4 + ((r - _mn) / (_mx - _mn)) * 5) * 100) / 100; }); }); evaluationData.forEach(d => { d.global_score = Math.round(Object.entries(CRITERIA_WEIGHTS).reduce((s, [c, w]) => s + (d.criteria_scores[c] || 0) * w, 0) * 100) / 100; if (useDynamicConfig && dynamicConfig) { for (const [cat, info] of Object.entries(dynamicConfig.categories)) { const avg = (info.criteria || []).reduce((s, c) => s + (d.criteria_scores[c] || 0), 0) / Math.max(1, (info.criteria || []).length); d.category_scores[cat.toUpperCase()] = Math.round(avg * 100) / 100; } } else { d.category_scores.TECHNICAL = Math.round(((d.criteria_scores.scope_facilities || 0) + (d.criteria_scores.scope_work || 0) + (d.criteria_scores.deliverables_quality || 0)) / 3 * 100) / 100; d.category_scores.ECONOMIC = Math.round(((d.criteria_scores.total_price || 0) + (d.criteria_scores.price_breakdown || 0) + (d.criteria_scores.optionals_included || 0) + (d.criteria_scores.capex_opex_methodology || 0)) / 4 * 100) / 100; d.category_scores.EXECUTION = Math.round(((d.criteria_scores.schedule || 0) + (d.criteria_scores.resources_allocation || 0) + (d.criteria_scores.exceptions || 0)) / 3 * 100) / 100; d.category_scores.HSE_COMPLIANCE = Math.round(((d.criteria_scores.safety_studies || 0) + (d.criteria_scores.regulatory_compliance || 0)) / 2 * 100) / 100; } }); console.log('   âœ… Cross-provider normalization:', _nCrit.length, 'criteria'); } return evaluationData.map(data => ({ json: data }));"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        -9216,
        4688
      ],
      "id": "15b30aa0-87a6-4a70-aaa1-ae9be38062a4",
      "name": "Prepare Scoring Data"
    },
    {
      "parameters": {
        "options": {
          "reset": false
        }
      },
      "type": "n8n-nodes-base.splitInBatches",
      "typeVersion": 3,
      "position": [
        -8992,
        4640
      ],
      "id": "1684a7ee-0f40-4bd8-9eaf-30341b3ec0ae",
      "name": "Loop Over Providers"
    },
    {
      "parameters": {
        "promptType": "define",
        "text": "=You are a procurement evaluation assistant. Score this provider's proposal.\n\nOUTPUT LANGUAGE: {{ $('Set Input Params1').first().json.language === 'en' ? 'ENGLISH - Write evaluation_summary, strengths and weaknesses in English.' : 'ESPAÃ‘OL - Escribe evaluation_summary, strengths y weaknesses en espaÃ±ol.' }}\n\nPROVIDER: {{ $json.provider_name }}\nTOTAL RESPONSES: {{ $json.total_responses }}\nPROJECT CONTEXT: {{ $('Fetch Project Context Scoring').first().json.ai_context || 'Procurement evaluation' }}\n\nCURRENCY: {{ $('Set Input Params1').first().json.currency || 'EUR' }} (use this currency when referencing monetary values)\n\nECONOMIC DATA (from economic_offers table):\n{{ $json.economic_data ? JSON.stringify($json.economic_data) : 'No economic data available' }}\n\nPRE-CALCULATED COMPLIANCE DATA:\nCategory scores: {{ JSON.stringify($json.category_scores) }}\nCriteria scores: {{ JSON.stringify($json.criteria_scores) }}\n\nCRITERIA DETAILS (included/partial/not_included/no_info counts):\n{{ JSON.stringify($json.criteria_summary) }}\n\nSCORING METHODOLOGY:\n- Scale: 0-10 per criterion\n- Use the pre-calculated scores as your STARTING POINT\n- Scoring is a MIX of compliance + quality. Both matter:\n  * Compliance (baseline): INCLUDED = provider covers the requirement, NOT_INCLUDED = critical gap\n  * Quality (your adjustment): HOW WELL they cover it â€” specificity, methodology, evidence, detail level\n- The pre-calculated scores reflect RELATIVE compliance across all providers (already normalized)\n- Adjust scores based on the 'comments' text in criteria_summary â€” that is the actual text from provider documents\n- NO fixed cap: if the evidence strongly justifies it, adjust Â±3 or more from the baseline\n- A provider that checks a box with vague text is NOT the same as one that provides detailed methodology\n\nRESPONSE QUALITY GUIDE (read the 'comments' in criteria_summary):\n- 9-10: Specific methodology, quantified results, proven track record, unique technical advantage\n- 7-8: Clear approach with some specifics, relevant experience, solid but not exceptional\n- 5-6: Generic/boilerplate response, technically present but no depth or evidence\n- 3-4: Vague or templated â€” even if marked INCLUDED, substance is minimal\n- 1-2: No meaningful content, or clear inability to meet the requirement\n\nCOMPLIANCE SIGNAL:\n- NOT_INCLUDED on key requirements: drop score significantly (2-3 range)\n- PARTIAL: score 4-6 depending on what is actually missing\n- INCLUDED with quality content: 7-10 depending on how well\n- INCLUDED with no substance: 4-6 maximum\n\nCRITICAL â€” DIFFERENTIATION IS MANDATORY:\n- You MUST score providers differently. If all providers receive 6-8 on every criterion, the evaluation has failed its purpose.\n- Read the comments carefully. Providers that write more specific, detailed, evidence-backed responses MUST score higher.\n- Use the full 0-10 scale. Typical spread between best and worst provider on a criterion: 2-5 points.\n- Do NOT give the same score to all providers on any criterion unless their responses are truly identical.\n\nRETURN ONLY valid JSON with this exact structure:\n{\n  \"provider_name\": \"{{ $json.provider_name }}\",\n  \"category_scores\": {\n    {{ $json.scoring_config ? Object.keys($json.scoring_config.categories).map(name => `\"${name.toUpperCase()}\": { \"score\": 7.0, \"weight\": ${$json.scoring_config.categories[name].weight / 100} }`).join(',\\n    ') : `\"TECHNICAL\": { \"score\": 7.0, \"weight\": 0.30 },\\n    \"ECONOMIC\": { \"score\": 7.0, \"weight\": 0.35 },\\n    \"EXECUTION\": { \"score\": 7.0, \"weight\": 0.20 },\\n    \"HSE_COMPLIANCE\": { \"score\": 7.0, \"weight\": 0.15 }` }}\n  },\n  \"individual_scores\": {\n    {{ Object.keys($json.criteria_scores).map(k => `\"${k}\": ${$json.criteria_scores[k] || 5.0}`).join(',\\n    ') }}\n  },\n  \"overall_score\": {{ $json.global_score || 5.0 }},\n  \"compliance_percentage\": 70,\n  \"evaluation_summary\": \"Brief 1-2 sentence evaluation in {{ $('Set Input Params1').first().json.language === 'en' ? 'English' : 'Spanish' }}\",\n  \"strengths\": [\"strength 1\", \"strength 2\"],\n  \"weaknesses\": [\"weakness 1\", \"weakness 2\"]\n}\n\nIMPORTANT: Replace the example numbers with your REAL scores based on compliance + quality analysis. Read provider comments in criteria_summary. Differentiate between providers â€” identical scores defeat the purpose. All number fields must be actual numbers (not strings). Write text fields in {{ $('Set Input Params1').first().json.language === 'en' ? 'English' : 'Spanish' }}.",
        "hasOutputParser": true,
        "batching": {}
      },
      "type": "@n8n/n8n-nodes-langchain.chainLlm",
      "typeVersion": 1.8,
      "position": [
        -8720,
        4656
      ],
      "id": "ab022785-ea32-444f-8f49-fdc8270db934",
      "name": "Scoring LLM Chain",
      "alwaysOutputData": true,
      "continueOnFail": true
    },
    {
      "parameters": {
        "jsCode": "// =============================================\n// NODO: Calculate Weighted Scores (v8 - Resilient to LLM failures)\n// FIX: Gets project_id from Set Input Params1 (not LLM output)\n// FIX: Falls back to pre-calculated scores when LLM returns zeros or errors\n// FIX: Handles LLM chain continueOnFail error items\n// =============================================\n\nconst input = $input.first().json;\n\n// Check if LLM chain failed (continueOnFail produces error items)\nconst isLlmError = input.error || input.errorMessage || !input.output;\nif (isLlmError) {\n    console.log('Calculate Weighted Scores v8 - LLM FAILED, using pre-calculated scores only');\n    console.log('  Error:', input.error || input.errorMessage || 'No output from LLM');\n}\n\nconst llmOutput = (!isLlmError && input.output) ? input.output : {};\n\nconsole.log('Calculate Weighted Scores v8 - Starting...');\nconsole.log('  LLM output keys:', Object.keys(llmOutput).join(', '));\n\n// === FIX 1: Get project_id from webhook params (NOT from LLM) ===\nlet projectId = null;\ntry {\n    projectId = $('Set Input Params1').first().json.project_id;\n} catch(e) {\n    console.log('  Could not get project_id:', e.message);\n}\n\n// === FIX 2: Get pre-calculated scores from Prepare Scoring Data ===\nlet configType = 'default';\nlet scoringConfig = null;\nlet preCalcCriteria = {};\nlet preCalcCategory = {};\nlet preCalcGlobal = 0;\ntry {\n    const allPrepared = $('Prepare Scoring Data').all();\n    const providerName = llmOutput.provider_name || '';\n    const match = allPrepared.find(item => item.json.provider_name === providerName);\n    if (match) {\n        configType = match.json.config_type || 'default';\n        scoringConfig = match.json.scoring_config || null;\n        preCalcCriteria = match.json.criteria_scores || {};\n        preCalcCategory = match.json.category_scores || {};\n        preCalcGlobal = match.json.global_score || 0;\n        console.log('  Pre-calculated scores found for', providerName);\n        console.log('  Pre-calc criteria:', JSON.stringify(preCalcCriteria));\n        console.log('  Pre-calc categories:', JSON.stringify(preCalcCategory));\n        console.log('  Pre-calc global:', preCalcGlobal);\n    } else {\n        console.log('  No pre-calculated match for:', providerName);\n    }\n} catch(e) {\n    console.log('  Could not get pre-calculated scores:', e.message);\n}\n\n// === Extract LLM category scores ===\nconst llmCatScores = llmOutput.category_scores || {};\nconst getScore = (cat) => {\n    const v = llmCatScores[cat];\n    if (!v) return 0;\n    return (typeof v === 'object' && v.score) ? v.score : (typeof v === 'number' ? v : 0);\n};\n\n// === FIX 3: Build individual scores with fallback to pre-calculated ===\nconst llmIndividual = llmOutput.individual_scores || {};\nconst is = {};\nconst allCriteriaKeys = new Set([\n    ...Object.keys(llmIndividual),\n    ...Object.keys(preCalcCriteria)\n]);\nfor (const key of allCriteriaKeys) {\n    const llmVal = llmIndividual[key];\n    const preVal = preCalcCriteria[key];\n    // Use LLM value only if it's a real positive number\n    const _isPrice = (key === 'total_price' || key.includes('tco') || key.includes('total_cost')); if (_isPrice && typeof preVal === 'number' && preVal > 0) { is[key] = preVal; } else if (typeof llmVal === 'number' && llmVal > 0 && typeof preVal === 'number' && preVal > 0) { is[key] = Math.round(Math.max(0, Math.min(10, Math.max(preVal - 3, Math.min(preVal + 3, llmVal)))) * 100) / 100; } else { is[key] = (typeof llmVal === 'number' && llmVal > 0) ? Math.round(Math.min(10, llmVal) * 100) / 100 : (preVal || 0); }\n}\nconsole.log('  Final individual_scores:', JSON.stringify(is));\n\n// === Build category scores with fallback ===\nconst categoryScoresClean = {};\nconst allCatKeys = new Set([\n    ...Object.keys(llmCatScores),\n    ...Object.keys(preCalcCategory)\n]);\nfor (const catKey of allCatKeys) {\n    const llmCatVal = llmCatScores[catKey];\n    const preCatVal = preCalcCategory[catKey];\n    const llmScore = (typeof llmCatVal === 'object' && llmCatVal?.score)\n        ? llmCatVal.score\n        : (typeof llmCatVal === 'number' ? llmCatVal : 0);\n    const _isEcon = (catKey === 'ECONOMIC' || catKey === 'economic'); if (_isEcon && typeof preCatVal === 'number' && preCatVal > 0) { categoryScoresClean[catKey] = preCatVal; } else if (llmScore > 0 && typeof preCatVal === 'number' && preCatVal > 0) { categoryScoresClean[catKey] = Math.round(Math.max(0, Math.min(10, Math.max(preCatVal - 3, Math.min(preCatVal + 3, llmScore)))) * 100) / 100; } else { categoryScoresClean[catKey] = llmScore > 0 ? Math.round(Math.min(10, llmScore) * 100) / 100 : (preCatVal || 0); }\n}\nconsole.log('  Final category_scores:', JSON.stringify(categoryScoresClean));\n\n// === Calculate overall score with fallback ===\nconst llmOverall = llmOutput.overall_score || 0;\nconst overallScore = (() => { const cw = (configType === 'dynamic' && scoringConfig && scoringConfig.categories) ? Object.fromEntries(Object.entries(scoringConfig.categories).map(([k,v]) => [k.toUpperCase(), v.weight/100])) : {'TECHNICAL':0.30,'ECONOMIC':0.35,'EXECUTION':0.20,'HSE_COMPLIANCE':0.15}; const r = Object.entries(cw).reduce((s,[k,w]) => s+(categoryScoresClean[k]||0)*w, 0); const rc = Object.values(cw).reduce((a,b)=>a+b,0); return rc > 0 ? Math.round(r/rc*100)/100 : (llmOverall > 0 ? llmOverall : preCalcGlobal); })();\n\n// === Calculate compliance percentage with fallback ===\nconst llmCompliance = llmOutput.compliance_percentage || 0;\nconst compliancePercentage = llmCompliance > 0 ? llmCompliance : Math.round(overallScore * 10);\n\n// Build ranking object\nconst ranking = {\n    provider_name: llmOutput.provider_name || input.provider_name || 'UNKNOWN',\n    project_id: projectId,\n    // Legacy fixed fields\n    technical_score: categoryScoresClean.TECHNICAL || categoryScoresClean.technical || 0,\n    economic_score: categoryScoresClean.ECONOMIC || categoryScoresClean.economic || 0,\n    execution_score: categoryScoresClean.EXECUTION || categoryScoresClean.execution || 0,\n    hse_compliance_score: categoryScoresClean.HSE_COMPLIANCE || categoryScoresClean.hse_compliance || 0,\n    scope_facilities_score: is.scope_facilities || 0,\n    scope_work_score: is.scope_work || 0,\n    deliverables_quality_score: is.deliverables_quality || 0,\n    total_price_score: is.total_price || 0,\n    price_breakdown_score: is.price_breakdown || 0,\n    optionals_included_score: is.optionals_included || 0,\n    capex_opex_methodology_score: is.capex_opex_methodology || 0,\n    schedule_score: is.schedule || 0,\n    resources_allocation_score: is.resources_allocation || 0,\n    exceptions_score: is.exceptions || 0,\n    safety_studies_score: is.safety_studies || 0,\n    regulatory_compliance_score: is.regulatory_compliance || 0,\n    // Dynamic JSONB fields\n    category_scores_json: categoryScoresClean,\n    individual_scores_json: is,\n    evaluation_details: {\n        strengths: llmOutput.strengths || [],\n        weaknesses: llmOutput.weaknesses || [],\n        recommendations: llmOutput.recommendations || [],\n        summary: llmOutput.evaluation_summary || ''\n    },\n    overall_score: overallScore,\n    compliance_percentage: compliancePercentage,\n    evaluation_count: 1,\n    last_updated: new Date().toISOString()\n};\n\nconsole.log('  FINAL ranking for', ranking.provider_name, ':', ranking.overall_score);\n\nreturn [{\n    json: {\n        ranking,\n        details: ranking.evaluation_details,\n        category_scores: categoryScoresClean,\n        individual_scores: is,\n        config_type: configType,\n        scoring_config: scoringConfig\n    }\n}];"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        -8336,
        4656
      ],
      "id": "8939a0ac-1f49-4183-a15f-d30c4fdeb94f",
      "name": "Calculate Weighted Scores"
    },
    {
      "parameters": {
        "useCustomSchema": true,
        "operation": "getAll",
        "tableId": "ranking_proveedores",
        "limit": 1,
        "filters": {
          "conditions": [
            {
              "keyName": "provider_name",
              "condition": "eq",
              "keyValue": "={{ $('Calculate Weighted Scores').first().json.ranking.provider_name }}"
            },
            {
              "keyName": "project_id",
              "condition": "eq",
              "keyValue": "={{ $('Set Input Params1').first().json.project_id }}"
            }
          ]
        }
      },
      "type": "n8n-nodes-base.supabase",
      "typeVersion": 1,
      "position": [
        -8096,
        4656
      ],
      "id": "f5039427-bdb5-4002-adc5-d352022656ae",
      "name": "Check Provider Exists",
      "alwaysOutputData": true,
      "credentials": {
        "supabaseApi": {
          "id": "pI4CpdYLTiEEBmnz",
          "name": "Supabase account"
        }
      }
    },
    {
      "parameters": {
        "conditions": {
          "options": {
            "caseSensitive": true,
            "leftValue": "",
            "typeValidation": "strict",
            "version": 2
          },
          "conditions": [
            {
              "id": "provider-exists-condition",
              "leftValue": "={{ $input.all().length }}",
              "rightValue": 0,
              "operator": {
                "type": "number",
                "operation": "gt"
              }
            }
          ],
          "combinator": "and"
        },
        "options": {}
      },
      "type": "n8n-nodes-base.if",
      "typeVersion": 2.2,
      "position": [
        -7856,
        4656
      ],
      "id": "1f5121af-20c1-4c40-86ad-14287e0ea03e",
      "name": "Provider Exists?",
      "disabled": true
    },
    {
      "parameters": {
        "operation": "update",
        "tableId": "ranking_proveedores",
        "matchType": "allFilters",
        "filters": {
          "conditions": [
            {
              "keyName": "provider_name",
              "condition": "eq",
              "keyValue": "={{ $('Calculate Weighted Scores').first().json.ranking.provider_name }}"
            },
            {
              "keyName": "project_id",
              "condition": "eq",
              "keyValue": "={{ $('Set Input Params1').first().json.project_id }}"
            }
          ]
        },
        "fieldsUi": {
          "fieldValues": [
            {
              "fieldId": "project_id",
              "fieldValue": "={{ $('Set Input Params1').first().json.project_id }}"
            },
            {
              "fieldId": "technical_score",
              "fieldValue": "={{ $('Calculate Weighted Scores').first().json.ranking.technical_score || 0 }}"
            },
            {
              "fieldId": "economic_score",
              "fieldValue": "={{ $('Calculate Weighted Scores').first().json.ranking.economic_score || 0 }}"
            },
            {
              "fieldId": "execution_score",
              "fieldValue": "={{ $('Calculate Weighted Scores').first().json.ranking.execution_score || 0 }}"
            },
            {
              "fieldId": "hse_compliance_score",
              "fieldValue": "={{ $('Calculate Weighted Scores').first().json.ranking.hse_compliance_score || 0 }}"
            },
            {
              "fieldId": "scope_facilities_score",
              "fieldValue": "={{ $('Calculate Weighted Scores').first().json.ranking.scope_facilities_score || 0 }}"
            },
            {
              "fieldId": "scope_work_score",
              "fieldValue": "={{ $('Calculate Weighted Scores').first().json.ranking.scope_work_score || 0 }}"
            },
            {
              "fieldId": "deliverables_quality_score",
              "fieldValue": "={{ $('Calculate Weighted Scores').first().json.ranking.deliverables_quality_score || 0 }}"
            },
            {
              "fieldId": "total_price_score",
              "fieldValue": "={{ $('Calculate Weighted Scores').first().json.ranking.total_price_score || 0 }}"
            },
            {
              "fieldId": "price_breakdown_score",
              "fieldValue": "={{ $('Calculate Weighted Scores').first().json.ranking.price_breakdown_score || 0 }}"
            },
            {
              "fieldId": "optionals_included_score",
              "fieldValue": "={{ $('Calculate Weighted Scores').first().json.ranking.optionals_included_score || 0 }}"
            },
            {
              "fieldId": "capex_opex_methodology_score",
              "fieldValue": "={{ $('Calculate Weighted Scores').first().json.ranking.capex_opex_methodology_score || 0 }}"
            },
            {
              "fieldId": "schedule_score",
              "fieldValue": "={{ $('Calculate Weighted Scores').first().json.ranking.schedule_score || 0 }}"
            },
            {
              "fieldId": "resources_allocation_score",
              "fieldValue": "={{ $('Calculate Weighted Scores').first().json.ranking.resources_allocation_score || 0 }}"
            },
            {
              "fieldId": "exceptions_score",
              "fieldValue": "={{ $('Calculate Weighted Scores').first().json.ranking.exceptions_score || 0 }}"
            },
            {
              "fieldId": "safety_studies_score",
              "fieldValue": "={{ $('Calculate Weighted Scores').first().json.ranking.safety_studies_score || 0 }}"
            },
            {
              "fieldId": "regulatory_compliance_score",
              "fieldValue": "={{ $('Calculate Weighted Scores').first().json.ranking.regulatory_compliance_score || 0 }}"
            },
            {
              "fieldId": "overall_score",
              "fieldValue": "={{ $('Calculate Weighted Scores').first().json.ranking.overall_score || 0 }}"
            },
            {
              "fieldId": "compliance_percentage",
              "fieldValue": "={{ $('Calculate Weighted Scores').first().json.ranking.compliance_percentage || 0 }}"
            },
            {
              "fieldId": "evaluation_count",
              "fieldValue": "={{ $('Calculate Weighted Scores').first().json.ranking.evaluation_count || 0 }}"
            },
            {
              "fieldId": "last_updated",
              "fieldValue": "={{ $('Calculate Weighted Scores').first().json.ranking.last_updated }}"
            }
          ]
        }
      },
      "type": "n8n-nodes-base.supabase",
      "typeVersion": 1,
      "position": [
        -7616,
        4560
      ],
      "id": "ca7892a2-3e83-4990-a604-7499c64a30c1",
      "name": "Update Ranking",
      "alwaysOutputData": false,
      "credentials": {
        "supabaseApi": {
          "id": "pI4CpdYLTiEEBmnz",
          "name": "Supabase account"
        }
      },
      "disabled": true,
      "continueOnFail": true
    },
    {
      "parameters": {
        "useCustomSchema": true,
        "tableId": "ranking_proveedores",
        "fieldsUi": {
          "fieldValues": [
            {
              "fieldId": "provider_name",
              "fieldValue": "={{ $('Calculate Weighted Scores').first().json.ranking.provider_name }}"
            },
            {
              "fieldId": "project_id",
              "fieldValue": "={{ $('Set Input Params1').first().json.project_id }}"
            },
            {
              "fieldId": "technical_score",
              "fieldValue": "={{ $('Calculate Weighted Scores').first().json.ranking.technical_score || 0 }}"
            },
            {
              "fieldId": "economic_score",
              "fieldValue": "={{ $('Calculate Weighted Scores').first().json.ranking.economic_score || 0 }}"
            },
            {
              "fieldId": "execution_score",
              "fieldValue": "={{ $('Calculate Weighted Scores').first().json.ranking.execution_score || 0 }}"
            },
            {
              "fieldId": "hse_compliance_score",
              "fieldValue": "={{ $('Calculate Weighted Scores').first().json.ranking.hse_compliance_score || 0 }}"
            },
            {
              "fieldId": "scope_facilities_score",
              "fieldValue": "={{ $('Calculate Weighted Scores').first().json.ranking.scope_facilities_score || 0 }}"
            },
            {
              "fieldId": "scope_work_score",
              "fieldValue": "={{ $('Calculate Weighted Scores').first().json.ranking.scope_work_score || 0 }}"
            },
            {
              "fieldId": "deliverables_quality_score",
              "fieldValue": "={{ $('Calculate Weighted Scores').first().json.ranking.deliverables_quality_score || 0 }}"
            },
            {
              "fieldId": "total_price_score",
              "fieldValue": "={{ $('Calculate Weighted Scores').first().json.ranking.total_price_score || 0 }}"
            },
            {
              "fieldId": "price_breakdown_score",
              "fieldValue": "={{ $('Calculate Weighted Scores').first().json.ranking.price_breakdown_score || 0 }}"
            },
            {
              "fieldId": "optionals_included_score",
              "fieldValue": "={{ $('Calculate Weighted Scores').first().json.ranking.optionals_included_score || 0 }}"
            },
            {
              "fieldId": "capex_opex_methodology_score",
              "fieldValue": "={{ $('Calculate Weighted Scores').first().json.ranking.capex_opex_methodology_score || 0 }}"
            },
            {
              "fieldId": "schedule_score",
              "fieldValue": "={{ $('Calculate Weighted Scores').first().json.ranking.schedule_score || 0 }}"
            },
            {
              "fieldId": "resources_allocation_score",
              "fieldValue": "={{ $('Calculate Weighted Scores').first().json.ranking.resources_allocation_score || 0 }}"
            },
            {
              "fieldId": "exceptions_score",
              "fieldValue": "={{ $('Calculate Weighted Scores').first().json.ranking.exceptions_score || 0 }}"
            },
            {
              "fieldId": "safety_studies_score",
              "fieldValue": "={{ $('Calculate Weighted Scores').first().json.ranking.safety_studies_score || 0 }}"
            },
            {
              "fieldId": "regulatory_compliance_score",
              "fieldValue": "={{ $('Calculate Weighted Scores').first().json.ranking.regulatory_compliance_score || 0 }}"
            },
            {
              "fieldId": "overall_score",
              "fieldValue": "={{ $('Calculate Weighted Scores').first().json.ranking.overall_score || 0 }}"
            },
            {
              "fieldId": "compliance_percentage",
              "fieldValue": "={{ $('Calculate Weighted Scores').first().json.ranking.compliance_percentage || 0 }}"
            },
            {
              "fieldId": "evaluation_count",
              "fieldValue": "={{ $('Calculate Weighted Scores').first().json.ranking.evaluation_count || 0 }}"
            },
            {
              "fieldId": "last_updated",
              "fieldValue": "={{ $('Calculate Weighted Scores').first().json.ranking.last_updated }}"
            },
            {
              "fieldId": "category_scores_json",
              "fieldValue": "={{ $('Calculate Weighted Scores').first().json.ranking.category_scores_json }}"
            },
            {
              "fieldId": "individual_scores_json",
              "fieldValue": "={{ $('Calculate Weighted Scores').first().json.ranking.individual_scores_json }}"
            },
            {
              "fieldId": "evaluation_details",
              "fieldValue": "={{ $('Calculate Weighted Scores').first().json.ranking.evaluation_details }}"
            }
          ]
        }
      },
      "type": "n8n-nodes-base.supabase",
      "typeVersion": 1,
      "position": [
        -7616,
        4784
      ],
      "id": "91aeb3bf-499a-4248-89ae-0a10775ffddf",
      "name": "Insert Ranking",
      "alwaysOutputData": false,
      "credentials": {
        "supabaseApi": {
          "id": "pI4CpdYLTiEEBmnz",
          "name": "Supabase account"
        }
      },
      "continueOnFail": true
    },
    {
      "parameters": {
        "aggregate": "aggregateAllItemData",
        "destinationFieldName": "all_rankings",
        "options": {}
      },
      "type": "n8n-nodes-base.aggregate",
      "typeVersion": 1,
      "position": [
        -8720,
        4480
      ],
      "id": "d39e7e99-bc91-4653-a03f-c21dcabb948c",
      "name": "Aggregate All Rankings"
    },
    {
      "parameters": {
        "jsCode": "// =============================================\n// NODE: Generate Final Ranking with Details (v6 - Fully Dynamic Criteria)\n// Passes individual_scores and category scores as dynamic objects\n// =============================================\n\nconst items = $input.all();\nlet allRankings = [];\n\nitems.forEach(item => {\n    if (item.json.all_rankings) {\n        allRankings = allRankings.concat(item.json.all_rankings);\n    } else if (item.json.ranking) {\n        allRankings.push(item.json);\n    }\n});\n\nconst sortedRankings = allRankings\n    .map(r => ({\n        ranking: r.ranking || r,\n        details: r.details || {},\n        category_scores: r.category_scores || {},\n        individual_scores: r.individual_scores || {},\n        config_type: r.config_type || 'default'\n    }))\n    .sort((a, b) => (b.ranking.overall_score || 0) - (a.ranking.overall_score || 0));\n\nconst finalRanking = sortedRankings.map((r, idx) => {\n    // Build dynamic category scores object\n    const categoryScores = r.ranking.category_scores_json || {};\n    // Also populate legacy fields for backward compatibility\n    const scores = {\n        technical: categoryScores.TECHNICAL || categoryScores.technical || r.ranking.technical_score || 0,\n        economic: categoryScores.ECONOMIC || categoryScores.economic || r.ranking.economic_score || 0,\n        execution: categoryScores.EXECUTION || categoryScores.execution || r.ranking.execution_score || 0,\n        hse_compliance: categoryScores.HSE_COMPLIANCE || categoryScores.hse_compliance || r.ranking.hse_compliance_score || 0\n    };\n    // Add any dynamic categories that aren't in the legacy set\n    for (const [catKey, catScore] of Object.entries(categoryScores)) {\n        const normalizedKey = catKey.toLowerCase();\n        if (!scores[normalizedKey]) {\n            scores[normalizedKey] = catScore;\n        }\n    }\n\n    // Build dynamic individual_scores from JSONB or fallback to legacy fields\n    const dynamicIndividual = r.ranking.individual_scores_json || r.individual_scores || {};\n    // Merge with legacy fixed fields as fallback\n    const individualScores = { ...dynamicIndividual };\n    const legacyFields = [\n        'scope_facilities', 'scope_work', 'deliverables_quality',\n        'total_price', 'price_breakdown', 'optionals_included', 'capex_opex_methodology',\n        'schedule', 'resources_allocation', 'exceptions',\n        'safety_studies', 'regulatory_compliance'\n    ];\n    legacyFields.forEach(f => {\n        if (!(f in individualScores) || !individualScores[f]) {\n            individualScores[f] = r.ranking[f + '_score'] || r.individual_scores?.[f] || 0;\n        }\n    });\n\n    return {\n        position: idx + 1,\n        provider_name: r.ranking.provider_name,\n        overall_score: r.ranking.overall_score,\n        compliance_percentage: r.ranking.compliance_percentage,\n        scores,\n        individual_scores: individualScores,\n        evaluation: {\n            strengths: r.details.strengths || [],\n            weaknesses: r.details.weaknesses || [],\n            recommendations: r.details.recommendations || [],\n            summary: r.details.summary || ''\n        }\n    };\n});\n\nconst configType = sortedRankings[0]?.config_type || 'default';\n\nconst stats = {\n    total_providers: finalRanking.length,\n    average_score: finalRanking.reduce((sum, r) => sum + (r.overall_score || 0), 0) / (finalRanking.length || 1),\n    top_performer: finalRanking[0]?.provider_name || 'N/A',\n    score_range: {\n        min: Math.min(...finalRanking.map(r => r.overall_score || 0)),\n        max: Math.max(...finalRanking.map(r => r.overall_score || 0))\n    },\n    evaluation_date: new Date().toISOString(),\n    config_type: configType\n};\n\nconsole.log(`Final Ranking Generated (${configType} config):`);\nfinalRanking.forEach(r => {\n    console.log(`   ${r.position}. ${r.provider_name}: ${r.overall_score} (${r.compliance_percentage}%)`);\n});\n\nreturn {\n    json: {\n        success: true,\n        ranking: finalRanking,\n        statistics: stats,\n        message: `Scoring completed for ${finalRanking.length} providers using ${configType} criteria configuration`\n    }\n};"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        -8432,
        4480
      ],
      "id": "9d99ddf1-14e0-42cf-b9f7-22f003099208",
      "name": "Generate Final Ranking"
    },
    {
      "parameters": {
        "respondWith": "json",
        "responseBody": "={{ $json }}",
        "options": {
          "responseHeaders": {
            "entries": [
              {
                "name": "Content-Type",
                "value": "application/json"
              }
            ]
          }
        }
      },
      "type": "n8n-nodes-base.respondToWebhook",
      "typeVersion": 1.5,
      "position": [
        -8208,
        4480
      ],
      "id": "e97e623b-577f-40f3-b543-28fac8057da7",
      "name": "Respond with Ranking"
    },
    {
      "parameters": {
        "content": "## Scoring Workflow - Provider Evaluation (v5)\n## Dynamic Criteria Support\n\nThis workflow now supports:\n1. **Default criteria** - 11 hardcoded criteria for engineering proposals\n2. **Dynamic criteria** - Custom criteria loaded from `scoring_configuration_summary` view\n\n### How it works:\n1. Fetches scoring configuration for the project\n2. If configuration exists, uses dynamic criteria and weights\n3. If no configuration, falls back to default criteria\n\n### Default Category Weights:\n- **TECHNICAL COMPLETENESS (30%)**\n- **ECONOMIC COMPETITIVENESS (35%)**\n- **EXECUTION CAPABILITY (20%)**\n- **HSE & COMPLIANCE (15%)**\n\n### Endpoint:\nPOST /webhook/scoring-evaluation\n```json\n{\n  \"project_id\": \"uuid\",\n  \"provider_name\": \"filter\",\n  \"recalculate_all\": false\n}\n```\n\n### Response includes:\n- `config_type`: 'dynamic' or 'default'\n- `ranking`: Sorted provider scores\n- `statistics`: Summary stats",
        "height": 1264,
        "width": 3280
      },
      "type": "n8n-nodes-base.stickyNote",
      "typeVersion": 1,
      "position": [
        -10672,
        4080
      ],
      "id": "aa4a7120-96e0-4477-b7bb-daad803f3b8f",
      "name": "Workflow Info"
    },
    {
      "parameters": {
        "content": "## AI Scoring (v5)\n\nEvaluates engineering proposals using:\n- Dynamic OR default criteria\n- Custom weights from database\n- Value-for-money comparison\n- Strengths and weaknesses\n\nStructured JSON output",
        "height": 220,
        "width": 320,
        "color": 6
      },
      "type": "n8n-nodes-base.stickyNote",
      "typeVersion": 1,
      "position": [
        -8816,
        4240
      ],
      "id": "d04fc6d7-a2ee-4044-8f50-0047be027d47",
      "name": "LLM Scoring Info"
    },
    {
      "parameters": {
        "assignments": {
          "assignments": [
            {
              "id": "project_id",
              "name": "project_id",
              "value": "={{ $('Webhook Scoring').first().json.body.project_id }}",
              "type": "string"
            },
            {
              "id": "provider_filter",
              "name": "provider_filter",
              "value": "={{ $('Webhook Scoring').first().json.body.provider_name || '' }}",
              "type": "string"
            },
            {
              "id": "recalculate_all",
              "name": "recalculate_all",
              "value": "={{ $('Webhook Scoring').first().json.body.recalculate_all || false }}",
              "type": "boolean"
            },
            {
              "id": "language-field-scoring",
              "name": "language",
              "value": "={{ $('Webhook Scoring').first().json.body.language || 'es' }}",
              "type": "string"
            },
            {
              "id": "currency-field-scoring",
              "name": "currency",
              "value": "={{ $('Webhook Scoring').first().json.body.currency || 'EUR' }}",
              "type": "string"
            }
          ]
        },
        "options": {}
      },
      "type": "n8n-nodes-base.set",
      "typeVersion": 3.4,
      "position": [
        -9888,
        4688
      ],
      "id": "a6afa3a9-8e8d-4345-aa30-afeaac81b0b1",
      "name": "Set Input Params1"
    },
    {
      "parameters": {
        "schemaType": "manual",
        "inputSchema": "{\n  \"type\": \"object\",\n  \"properties\": {\n    \"provider_name\": { \"type\": \"string\" },\n    \"category_scores\": {\n      \"type\": \"object\",\n      \"additionalProperties\": {\n        \"type\": \"object\",\n        \"properties\": {\n          \"score\": { \"type\": \"number\" },\n          \"weight\": { \"type\": \"number\" }\n        }\n      }\n    },\n    \"individual_scores\": {\n      \"type\": \"object\",\n      \"additionalProperties\": { \"type\": \"number\" }\n    },\n    \"overall_score\": { \"type\": \"number\" },\n    \"compliance_percentage\": { \"type\": \"number\" },\n    \"evaluation_summary\": { \"type\": \"string\" },\n    \"strengths\": { \"type\": \"array\", \"items\": { \"type\": \"string\" } },\n    \"weaknesses\": { \"type\": \"array\", \"items\": { \"type\": \"string\" } },\n    \"recommendations\": { \"type\": \"array\", \"items\": { \"type\": \"string\" } }\n  },\n  \"required\": [\"provider_name\", \"category_scores\", \"individual_scores\", \"overall_score\", \"compliance_percentage\"]\n}"
      },
      "type": "@n8n/n8n-nodes-langchain.outputParserStructured",
      "typeVersion": 1.3,
      "position": [
        -8576,
        4896
      ],
      "id": "ae2319f6-cc92-4439-aa73-cdb726a4870b",
      "name": "JSON Output Parser1"
    },
    {
      "parameters": {
        "model": "qwen3:8b",
        "options": {
          "temperature": 0.1,
          "numCtx": 8192,
          "numPredict": 2048
        }
      },
      "type": "@n8n/n8n-nodes-langchain.lmChatOllama",
      "typeVersion": 1,
      "position": [
        -8832,
        4880
      ],
      "id": "dacfb168-becf-4645-9ef2-39a935b35e88",
      "name": "Ollama Scoring Model",
      "credentials": {
        "ollamaApi": {
          "id": "oS2Qqti9oVfsm8XZ",
          "name": "Ollama account"
        }
      }
    },
    {
      "parameters": {
        "useCustomSchema": true,
        "operation": "delete",
        "tableId": "ranking_proveedores",
        "filters": {
          "conditions": [
            {
              "keyName": "project_id",
              "condition": "eq",
              "keyValue": "={{ $('Webhook Scoring').first().json.body.project_id }}"
            }
          ]
        }
      },
      "type": "n8n-nodes-base.supabase",
      "typeVersion": 1,
      "position": [
        -10112,
        4688
      ],
      "id": "fa20ecd5-9a8a-446d-9415-f1ed9f4741fa",
      "name": "Delete a row",
      "alwaysOutputData": true,
      "credentials": {
        "supabaseApi": {
          "id": "pI4CpdYLTiEEBmnz",
          "name": "Supabase account"
        }
      }
    },
    {
      "parameters": {
        "options": {}
      },
      "type": "@n8n/n8n-nodes-langchain.lmChatOpenRouter",
      "typeVersion": 1,
      "position": [
        -8736,
        4976
      ],
      "id": "d1390406-477a-49be-b091-bdbd3d4920db",
      "name": "OpenRouter Chat Model1",
      "credentials": {
        "openRouterApi": {
          "id": "4AyUqsh1Z35g6bci",
          "name": "OpenRouter account"
        }
      }
    },
    {
      "parameters": {
        "httpMethod": "POST",
        "path": "scoring-evaluation",
        "responseMode": "responseNode",
        "options": {}
      },
      "type": "n8n-nodes-base.webhook",
      "typeVersion": 2.1,
      "position": [
        -10416,
        4688
      ],
      "id": "1a4f51d9-1b13-49bf-a26c-cb93e7feb710",
      "name": "Webhook Scoring",
      "webhookId": "scoring-eval-webhook-001"
    },
    {
      "parameters": {
        "useCustomSchema": true,
        "operation": "get",
        "tableId": "projects",
        "filters": {
          "conditions": [
            {
              "keyName": "id",
              "keyValue": "={{ $('Set Input Params1').first().json.project_id }}"
            }
          ]
        }
      },
      "id": "dd9622c5-ab77-401f-a9de-847cc3a86a07",
      "name": "Fetch Project Context Scoring",
      "type": "n8n-nodes-base.supabase",
      "typeVersion": 1,
      "position": [
        -9632,
        4688
      ],
      "credentials": {
        "supabaseApi": {
          "id": "pI4CpdYLTiEEBmnz",
          "name": "Supabase account"
        }
      }
    },
    {
      "parameters": {
        "conditions": {
          "options": {
            "caseSensitive": true,
            "leftValue": "",
            "typeValidation": "strict"
          },
          "conditions": [
            {
              "id": "check-award-action",
              "leftValue": "={{ $json.action }}",
              "rightValue": "generate_award_justification",
              "operator": {
                "type": "string",
                "operation": "equals"
              }
            }
          ],
          "combinator": "and"
        },
        "options": {}
      },
      "type": "n8n-nodes-base.if",
      "typeVersion": 2.2,
      "position": [
        -1280,
        6656
      ],
      "id": "b1c2d3e4-f5a6-7890-abcd-ef1234567890",
      "name": "Is Award Justification?"
    },
    {
      "parameters": {
        "promptType": "define",
        "text": "=### DATOS DE LA EVALUACION\n\n- **Proyecto:** {{ $json.project_name }} ({{ $json.project_type }})\n- **Fecha:** {{ new Date().toISOString().split('T')[0] }}\n- **Proveedor ganador:** {{ $json.winner_name }}\n- **Puntuacion global ganador:** {{ $json.winner_score }}/10\n- **Segundo clasificado:** {{ $json.runner_up_name || 'N/A' }}\n- **Puntuacion segundo:** {{ $json.runner_up_score || 0 }}/10\n- **Total proveedores evaluados:** {{ $json.total_providers }}\n\n**Puntuaciones por categoria:**\n{{ $json.category_scores }}\n\n**Fortalezas identificadas:**\n{{ $json.strengths }}\n\n**Debilidades identificadas:**\n{{ $json.weaknesses }}\n\n**Resumen economico:**\n{{ $json.economic_summary || 'No disponible' }}\n\n**Criterios de evaluacion:**\n{{ $json.scoring_criteria_summary }}\n\n### INDICE COMPLETO DEL DOCUMENTO ({{ $json.section_total }} secciones)\n{{ $json.all_sections_outline }}\n\n---\n\n### TU TAREA\n\nEscribe la seccion {{ $json.section_index }} de {{ $json.section_total }}: **{{ $json.section_title }}**\n\nDescripcion de lo que debe cubrir esta seccion:\n{{ $json.section_description }}\n\n### REGLAS DE REDACCION\n1. **Extension**: Escribe un MINIMO de 500 palabras para esta seccion.\n2. **Estilo narrativo**: Escribe en PROSA NARRATIVA con parrafos completos de 3-5 oraciones. No solo listas.\n3. **Basado en datos**: Referencia puntuaciones concretas, porcentajes y diferencias numericas de los datos proporcionados.\n4. **No inventes**: NO fabriques datos que no esten en el input. Si no hay datos para algun punto, indicalo.\n5. **Tono auditable**: Este documento debe resistir el escrutinio de auditoria interna, compliance y gobernanza.\n6. **Tablas**: Si esta seccion requiere comparativas, incluye tablas Markdown con los datos.\n7. **Coherencia**: Esta seccion es parte de un documento mayor. No repitas introducciones generales.\n8. **Idioma**: Escribe en {{ $json.language === 'en' ? 'English' : 'EspaÃ±ol' }}.\n9. **NO incluyas** el titulo de la seccion (se anadira automaticamente).\n\n### FORMATO DE SALIDA\n- Devuelve SOLO el texto de la seccion en Markdown.\n- NO devuelvas JSON.\n- NO uses bloques de codigo.\n- Empieza directamente con el contenido.",
        "messages": {
          "messageValues": [
            {
              "message": "=You are an expert procurement analyst, technical evaluator, and document writer specialized in industrial EPC projects (energy, green hydrogen, P2X, solar, wind, BESS).\n\n### YOUR ROLE\nYou are writing ONE SPECIFIC SECTION of a formal Award Justification document (Propuesta de Adjudicacion). This is a critical procurement document that must be:\n- **Auditable**: Subject to review by internal audit, compliance, and governance teams\n- **Data-driven**: Every conclusion must reference specific scores, percentages, or factual data\n- **Objective**: Present both strengths and weaknesses honestly\n- **Professional**: Written in formal corporate language suitable for executive review\n\n### WRITING STYLE\n1. Write in NARRATIVE PROSE with full paragraphs (3-5 sentences each). Do not produce list-only sections.\n2. Minimum 500 words for this section.\n3. Reference specific numerical data from the evaluation throughout your analysis.\n4. Use Markdown formatting: **bold** for emphasis, - for lists, | for tables.\n5. When comparing providers, use concrete data points and percentage differences.\n6. Write in {{ $json.language === 'en' ? 'English' : 'Spanish' }}.\n\n### OUTPUT FORMAT\n- Return ONLY the section content as plain Markdown text.\n- Do NOT return JSON, code blocks, or meta-commentary.\n- Do NOT include the section title. Start directly with content."
            }
          ]
        },
        "batching": {}
      },
      "type": "@n8n/n8n-nodes-langchain.chainLlm",
      "typeVersion": 1.8,
      "position": [
        -1088,
        6856
      ],
      "id": "c2d3e4f5-a6b7-8901-bcde-f23456789012",
      "name": "Award Justification Chain"
    },
    {
      "parameters": {
        "jsCode": "// Consolidate multiple section outputs into a single Award Justification document\nconst params = $('Set RFP Params').first().json;\nconst sectionMeta = $('Prepare Award Sections').all();\nconst llmOutputs = $input.all();\nconst lang = (params.language || 'es') === 'en' ? 'en' : 'es';\n\nconst cleanText = (text) => String(text || '')\n  .replace(/```json\\n?/gi, '').replace(/```\\n?/g, '')\n  .replace(/\\n{3,}/g, '\\n\\n')\n  .trim();\n\ntry {\n  const sections = sectionMeta.map((meta, index) => {\n    const llmItem = llmOutputs[index];\n    const rawContent = llmItem?.json?.text || llmItem?.json?.output || llmItem?.json?.response || '';\n    const content = cleanText(rawContent);\n    return {\n      title: meta.json.section_title,\n      content: content,\n      word_count: content.split(/\\s+/).filter(w => w.length > 0).length\n    };\n  });\n\n  // Build the full justification document\n  const documentParts = sections.map((s, i) => {\n    return `## ${i + 1}. ${s.title}\\n\\n${s.content}`;\n  });\n\n  const title = lang === 'es'\n    ? `Propuesta de Adjudicacion - ${params.project_name}`\n    : `Award Proposal - ${params.project_name}`;\n\n  const justification = documentParts.join('\\n\\n---\\n\\n');\n  const totalWords = sections.reduce((sum, s) => sum + s.word_count, 0);\n\n  // Extract recommendation from the last section (Final Recommendation)\n  const lastSection = sections[sections.length - 1];\n  const recommendationSummary = lang === 'es'\n    ? `Se recomienda adjudicar el proyecto \"${params.project_name}\" a ${params.winner_name} con una puntuacion global de ${params.winner_score}/10, habiendo obtenido la mayor puntuacion en la evaluacion integral de las ${params.total_providers} ofertas recibidas.`\n    : `It is recommended to award the project \"${params.project_name}\" to ${params.winner_name} with an overall score of ${params.winner_score}/10, having achieved the highest score in the comprehensive evaluation of ${params.total_providers} submitted proposals.`;\n\n  const result = {\n    success: true,\n    title,\n    justification,\n    document: justification,\n    content: justification,\n    text: justification,\n    sections: sections.map(s => ({ title: s.title, content: s.content })),\n    recommendation_summary: recommendationSummary,\n    metadata: {\n      word_count: totalWords,\n      section_count: sections.length,\n      words_per_section: sections.map(s => ({ title: s.title, words: s.word_count })),\n      generated_at: new Date().toISOString(),\n      model: 'mistral-large-latest',\n      generation_mode: 'multi-agent-per-section'\n    },\n    message: `Award justification generated with ${sections.length} sections (${totalWords} words total)`\n  };\n\n  console.log('âœ… Award Justification Consolidated:');\n  console.log(`   â”œâ”€ Title: ${title}`);\n  console.log(`   â”œâ”€ Sections: ${sections.length}`);\n  console.log(`   â”œâ”€ Total words: ${totalWords}`);\n  sections.forEach(s => console.log(`   â”‚  â””â”€ ${s.title}: ${s.word_count} words`));\n  console.log(`   â””â”€ Mode: multi-agent-per-section`);\n\n  return [{ json: result }];\n} catch (err) {\n  console.error('âŒ Error consolidating award justification:', err.message);\n  return [{ json: {\n    success: false,\n    title: '',\n    justification: '',\n    document: '',\n    content: '',\n    text: '',\n    sections: [],\n    recommendation_summary: '',\n    metadata: { word_count: 0, generated_at: new Date().toISOString(), model: 'mistral-large-latest' },\n    message: 'Error consolidating award justification: ' + err.message\n  }}];\n}\n"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        -880,
        6856
      ],
      "id": "d3e4f5a6-b789-0123-cdef-456789012345",
      "name": "Parse Award Output"
    },
    {
      "parameters": {
        "jsCode": "// Split RFP sections into individual items for per-section LLM generation\nconst params = $input.first().json;\nconst sections = params.sections || [];\nconst lang = (params.language || 'es') === 'en' ? 'en' : 'es';\n\n// Default professional RFP sections if none provided\nconst defaultSections = lang === 'es' ? [\n  { id: 'introduccion', title: 'Introduccion y Objeto del Proyecto', description: 'Contexto del proyecto, objetivo de la licitacion, alcance general, antecedentes y justificacion de la necesidad. Explica quien es la empresa compradora, por que se lanza esta licitacion y que se espera lograr.' },\n  { id: 'alcance', title: 'Alcance Tecnico y Descripcion de Trabajos', description: 'Descripcion detallada del alcance tecnico del proyecto, fases de ejecucion, entregables esperados, tecnologias involucradas, condiciones de sitio y requisitos de ingenieria.' },\n  { id: 'requisitos', title: 'Requisitos Tecnicos y Funcionales', description: 'Especificaciones tecnicas detalladas, normativas aplicables, certificaciones requeridas, estandares de calidad, requisitos de seguridad y medio ambiente.' },\n  { id: 'economico', title: 'Condiciones Economicas y Estructura de Precios', description: 'Estructura de desglose de costes esperada (CAPEX, OPEX, unitarios), condiciones de pago, hitos de facturacion, garantias bancarias, moneda, validez de precios y formula de revision.' },\n  { id: 'evaluacion', title: 'Metodologia de Evaluacion y Criterios de Seleccion', description: 'Explicacion detallada del modelo de evaluacion ponderada multi-criterio, definicion de cada criterio, pesos asignados, escala de puntuacion y proceso de decision.' },\n  { id: 'cronograma', title: 'Cronograma del Proyecto y Plazos', description: 'Calendario del proceso de licitacion, hitos clave del proyecto, fechas de entrega, plazo de ejecucion y penalizaciones por retraso.' },\n  { id: 'participacion', title: 'Instrucciones para los Licitadores', description: 'Como presentar la oferta: formato requerido, numero de copias, documentacion obligatoria, plazo de presentacion, canal de comunicacion, proceso de preguntas y aclaraciones.' },\n  { id: 'legal', title: 'Condiciones Generales, Legales y Contractuales', description: 'Clausulas de confidencialidad, proteccion de datos, propiedad intelectual, seguros, responsabilidad civil, resolucion de disputas, ley aplicable y compliance anti-corrupcion.' }\n] : [\n  { id: 'introduction', title: 'Project Introduction and Objective', description: 'Project background, purpose of the tender, general scope, rationale and justification. Explain who the buyer is, why this tender is launched and what outcomes are expected.' },\n  { id: 'scope', title: 'Technical Scope and Work Description', description: 'Detailed technical scope, project phases, expected deliverables, technologies involved, site conditions and engineering requirements.' },\n  { id: 'requirements', title: 'Technical and Functional Requirements', description: 'Detailed technical specifications, applicable standards, required certifications, quality standards, HSE requirements.' },\n  { id: 'economic', title: 'Economic Conditions and Pricing Structure', description: 'Expected cost breakdown structure (CAPEX, OPEX, unit prices), payment terms, invoicing milestones, bank guarantees, currency, price validity and escalation formula.' },\n  { id: 'evaluation', title: 'Evaluation Methodology and Selection Criteria', description: 'Detailed explanation of weighted multi-criteria evaluation model, criterion definitions, assigned weights, scoring scale and decision process.' },\n  { id: 'timeline', title: 'Project Timeline and Milestones', description: 'Tender process calendar, key project milestones, delivery dates, execution period and delay penalties.' },\n  { id: 'submission', title: 'Bidder Instructions', description: 'How to submit the proposal: required format, number of copies, mandatory documentation, submission deadline, communication channel, Q&A process.' },\n  { id: 'legal', title: 'General, Legal and Contractual Conditions', description: 'Confidentiality clauses, data protection, intellectual property, insurance, liability, dispute resolution, governing law and anti-corruption compliance.' }\n];\n\nconst sectionsToGenerate = sections.length > 0 ? sections : defaultSections;\nconst totalSections = sectionsToGenerate.length;\n\n// Create one item per section with full project context\nconst items = sectionsToGenerate.map((section, index) => ({\n  json: {\n    section_index: index + 1,\n    section_total: totalSections,\n    section_title: section.title || section.name || `Section ${index + 1}`,\n    section_description: section.description || section.content || '',\n    section_id: section.id || `section_${index}`,\n    project_name: params.project_name,\n    project_type: params.project_type,\n    description: params.description,\n    requirements: params.requirements,\n    language: params.language,\n    currency: params.currency,\n    criteria: typeof params.criteria === 'string' ? params.criteria : JSON.stringify(params.criteria || []),\n    deadlines: typeof params.deadlines === 'string' ? params.deadlines : JSON.stringify(params.deadlines || {}),\n    providers: typeof params.providers === 'string' ? params.providers : JSON.stringify(params.providers || []),\n    all_sections_outline: sectionsToGenerate.map((s, i) => `${i+1}. ${s.title || s.name}`).join('\\n')\n  }\n}));\n\nconsole.log(`ðŸ“‹ Prepared ${items.length} RFP sections for individual generation`);\nreturn items;\n"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        -1100,
        6456
      ],
      "id": "e4f5a6b7-c890-1234-def0-567890123456",
      "name": "Prepare RFP Sections"
    },
    {
      "parameters": {
        "jsCode": "// Split Award Justification into individual sections for per-section LLM generation\nconst params = $input.first().json;\nconst lang = (params.language || 'es') === 'en' ? 'en' : 'es';\n\nconst awardSections = lang === 'es' ? [\n  { id: 'resumen_ejecutivo', title: 'Resumen Ejecutivo', description: 'Sintesis del proceso de evaluacion: numero de proveedores evaluados, metodologia utilizada (modelo de evaluacion ponderada multi-criterio), resultado global y recomendacion final. Debe ser un resumen que permita a un directivo entender la conclusion sin leer el resto del documento.' },\n  { id: 'proceso_evaluacion', title: 'Descripcion del Proceso de Evaluacion', description: 'Metodologia de evaluacion detallada: modelo ponderado multi-criterio, como se definio cada criterio, como se asignaron los pesos, quien participo en la evaluacion, que fuentes de informacion se utilizaron (documentos tecnicos, ofertas economicas, referencias).' },\n  { id: 'analisis_comparativo', title: 'Analisis Comparativo de Proveedores', description: 'Comparacion detallada entre el proveedor ganador y el segundo clasificado (y tercero si relevante). Incluir tabla comparativa de puntuaciones globales, diferencias por categoria, y analisis de las brechas mas significativas.' },\n  { id: 'evaluacion_categorias', title: 'Evaluacion Detallada por Categorias', description: 'Desglose de las puntuaciones del ganador en CADA categoria de evaluacion. Para cada categoria: que se evaluo, que evidencia sustenta la puntuacion, como se compara con otros proveedores.' },\n  { id: 'fortalezas', title: 'Fortalezas del Proveedor Recomendado', description: 'Analisis exhaustivo de los puntos fuertes del proveedor ganador: experiencia relevante, capacidad tecnica, propuesta economica, plazos, equipo propuesto, referencias, innovacion. Cada fortaleza debe estar sustentada con datos concretos.' },\n  { id: 'riesgos_mitigacion', title: 'Areas de Atencion y Plan de Mitigacion', description: 'Identificacion honesta de debilidades o riesgos del proveedor ganador. Para cada riesgo: descripcion del riesgo, impacto potencial, probabilidad, y propuesta concreta de mitigacion (clausulas contractuales, supervisiÃ³n adicional, hitos de control).' },\n  { id: 'analisis_economico', title: 'Analisis Economico', description: 'Resumen detallado de la propuesta economica del ganador. Comparativa de precios con otros proveedores. Analisis de la relacion calidad-precio. Desglose de costes principales si esta disponible. Condiciones de pago propuestas.' },\n  { id: 'recomendacion_final', title: 'Recomendacion Final y Proximos Pasos', description: 'Justificacion formal y fundamentada de por que se recomienda adjudicar a este proveedor. Referencia a las puntuaciones, fortalezas clave y analisis economico. Incluir proximos pasos recomendados (negociacion, due diligence, firma de contrato).' }\n] : [\n  { id: 'executive_summary', title: 'Executive Summary', description: 'Overview of the evaluation process: number of providers evaluated, methodology used (weighted multi-criteria model), overall result and final recommendation. Should allow an executive to understand the conclusion without reading the rest.' },\n  { id: 'evaluation_process', title: 'Evaluation Process Description', description: 'Detailed evaluation methodology: weighted multi-criteria model, how each criterion was defined, how weights were assigned, who participated, what information sources were used.' },\n  { id: 'comparative_analysis', title: 'Comparative Provider Analysis', description: 'Detailed comparison between winner and runner-up. Include comparative scoring table, per-category differences, and analysis of most significant gaps.' },\n  { id: 'category_evaluation', title: 'Detailed Category Evaluation', description: 'Breakdown of winner scores in EACH evaluation category. For each: what was evaluated, supporting evidence, comparison with other providers.' },\n  { id: 'strengths', title: 'Recommended Provider Strengths', description: 'Comprehensive analysis of winner strengths: relevant experience, technical capability, economic proposal, timelines, proposed team, references, innovation. Each backed by concrete data.' },\n  { id: 'risks_mitigation', title: 'Areas of Attention and Mitigation Plan', description: 'Honest identification of winner weaknesses or risks. For each: description, potential impact, probability, and concrete mitigation proposal.' },\n  { id: 'economic_analysis', title: 'Economic Analysis', description: 'Detailed summary of winner economic proposal. Price comparison with others. Value-for-money analysis. Main cost breakdown if available.' },\n  { id: 'final_recommendation', title: 'Final Recommendation and Next Steps', description: 'Formal justification for recommending this provider. Reference scores, key strengths, economic analysis. Include recommended next steps (negotiation, due diligence, contract signing).' }\n];\n\nconst totalSections = awardSections.length;\n\nconst items = awardSections.map((section, index) => ({\n  json: {\n    section_index: index + 1,\n    section_total: totalSections,\n    section_title: section.title,\n    section_description: section.description,\n    section_id: section.id,\n    project_name: params.project_name,\n    project_type: params.project_type,\n    language: params.language || 'es',\n    winner_name: params.winner_name,\n    winner_score: params.winner_score,\n    runner_up_name: params.runner_up_name || '',\n    runner_up_score: params.runner_up_score || 0,\n    total_providers: params.total_providers,\n    category_scores: params.category_scores,\n    strengths: params.strengths,\n    weaknesses: params.weaknesses,\n    economic_summary: params.economic_summary || '',\n    scoring_criteria_summary: params.scoring_criteria_summary,\n    all_sections_outline: awardSections.map((s, i) => `${i+1}. ${s.title}`).join('\\n')\n  }\n}));\n\nconsole.log(`ðŸ“‹ Prepared ${items.length} Award Justification sections for individual generation`);\nreturn items;\n"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        -1100,
        6856
      ],
      "id": "f5a6b7c8-d901-2345-ef01-678901234567",
      "name": "Prepare Award Sections"
    }
  ],
  "connections": {
    "Extract Fields": {
      "main": [
        [
          {
            "node": "Validate Data",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Validate Data": {
      "main": [
        [
          {
            "node": "Convert Markdown to HTML",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Respond Error",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Convert Markdown to HTML": {
      "main": [
        [
          {
            "node": "Gmail Send",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Gmail Send": {
      "main": [
        [
          {
            "node": "Respond Success2",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Webhook2": {
      "main": [
        [
          {
            "node": "Extract Fields",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Webhook Receive": {
      "main": [
        [
          {
            "node": "Set Input Params2",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Email Provided?": {
      "main": [
        [
          {
            "node": "Send Email via Gmail",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Split for Update",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Send Email via Gmail": {
      "main": [
        [
          {
            "node": "Split for Update",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Generate Token": {
      "main": [
        [
          {
            "node": "Save Token to DB",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Save Token to DB": {
      "main": [
        [
          {
            "node": "Split Question IDs",
            "type": "main",
            "index": 0
          },
          {
            "node": "Fetch Project Name",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Split Question IDs": {
      "main": [
        [
          {
            "node": "Fetch Questions",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Fetch Questions": {
      "main": [
        [
          {
            "node": "Merge Data",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Fetch Project Name": {
      "main": [
        [
          {
            "node": "Merge Data",
            "type": "main",
            "index": 1
          }
        ]
      ]
    },
    "Merge Data": {
      "main": [
        [
          {
            "node": "Build Email Content",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Build Email Content": {
      "main": [
        [
          {
            "node": "Email Provided?",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Split for Update": {
      "main": [
        [
          {
            "node": "Update Question Status",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Update Question Status": {
      "main": [
        [
          {
            "node": "Respond to Webhook2",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Set Input Params2": {
      "main": [
        [
          {
            "node": "Generate Token",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Validate Token": {
      "main": [
        [
          {
            "node": "Token Valid?",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Token Valid?": {
      "main": [
        [
          {
            "node": "Split Responses",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Respond Invalid",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Split Responses": {
      "main": [
        [
          {
            "node": "Loop Over Items",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Loop Over Items": {
      "main": [
        [
          {
            "node": "Mark Token Responded",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Save Response to QA Audit",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Save Response to QA Audit": {
      "main": [
        [
          {
            "node": "Fetch Question Details",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Fetch Question Details": {
      "main": [
        [
          {
            "node": "Has Requirement?",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Has Requirement?": {
      "main": [
        [
          {
            "node": "Fetch Requirement",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "No Requirement",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Fetch Requirement": {
      "main": [
        [
          {
            "node": "Fetch Current Evaluation",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Fetch Current Evaluation": {
      "main": [
        [
          {
            "node": "LLM Re-evaluate",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "LLM Re-evaluate": {
      "main": [
        [
          {
            "node": "Should Update?",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Should Update?": {
      "main": [
        [
          {
            "node": "Update Provider Response",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Skip Update",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Update Provider Response": {
      "main": [
        [
          {
            "node": "Merge Results",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Skip Update": {
      "main": [
        [
          {
            "node": "Merge Results",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "No Requirement": {
      "main": [
        [
          {
            "node": "Merge Results",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Merge Results": {
      "main": [
        [
          {
            "node": "Loop Over Items",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Mark Token Responded": {
      "main": [
        [
          {
            "node": "Create Notification",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Create Notification": {
      "main": [
        [
          {
            "node": "Respond Success",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Webhook Receive1": {
      "main": [
        [
          {
            "node": "Set Input Params3",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Set Input Params3": {
      "main": [
        [
          {
            "node": "Validate Token",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "JSON Output Parser2": {
      "ai_outputParser": [
        [
          {
            "node": "LLM Re-evaluate",
            "type": "ai_outputParser",
            "index": 0
          }
        ]
      ]
    },
    "Webhook QA Email Response": {
      "main": [
        [
          {
            "node": "Set QA Email Params",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Set QA Email Params": {
      "main": [
        [
          {
            "node": "Fetch QA Questions",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Fetch QA Questions": {
      "main": [
        [
          {
            "node": "Build AI Context",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Build AI Context": {
      "main": [
        [
          {
            "node": "QA Email Mapping Chain",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "QA Email Mapping Chain": {
      "main": [
        [
          {
            "node": "Parse QA Email Output",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Parse QA Email Output": {
      "main": [
        [
          {
            "node": "Respond QA Email Response",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "OpenRouter Chat Model": {
      "ai_languageModel": [
        [
          {
            "node": "Basic LLM Chain",
            "type": "ai_languageModel",
            "index": 0
          }
        ]
      ]
    },
    "Edit Fields": {
      "main": [
        [
          {
            "node": "Get Offers",
            "type": "main",
            "index": 0
          },
          {
            "node": "Fetch Project Context Email",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Filter and Aggregate Issues": {
      "main": [
        [
          {
            "node": "Basic LLM Chain",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Webhook3": {
      "main": [
        [
          {
            "node": "Edit Fields",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Get Offers": {
      "main": [
        [
          {
            "node": "Filter and Aggregate Issues",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Basic LLM Chain": {
      "main": [
        [
          {
            "node": "Respond to Webhook3",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Fetch Project Context Email": {
      "main": [
        [
          {
            "node": "Filter and Aggregate Issues",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Get many rows1": {
      "main": [
        [
          {
            "node": "Reset Items",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Embeddings Ollama3": {
      "ai_embedding": [
        [
          {
            "node": "Insert into Supabase Vectorstore",
            "type": "ai_embedding",
            "index": 0
          }
        ]
      ]
    },
    "Validador de Ofertas": {
      "main": [
        [
          {
            "node": "Format for Vectorstore",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Structured Output Parser4": {
      "ai_outputParser": [
        [
          {
            "node": "Validador de Ofertas",
            "type": "ai_outputParser",
            "index": 0
          }
        ]
      ]
    },
    "Clasificador de Tipo de Evaluacion y Proveedor": {
      "main": [
        [
          {
            "node": "Format for Vectorstore",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "If": {
      "main": [
        [
          {
            "node": "Format for Vectorstore",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Format for Vectorstore",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Loop Over Phases": {
      "main": [
        [
          {
            "node": "Loop Over Items1",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Preparar Todo para LLM1",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Parsear y Preparar Update": {
      "main": [
        [
          {
            "node": "Insert or update rows in a table",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "LLM Chain": {
      "main": [
        [
          {
            "node": "Parsear y Preparar Update",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Insert Document Metadata": {
      "main": [
        [
          {
            "node": "Base64 a Binary",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Delete Old Doc Rows": {
      "main": [
        [
          {
            "node": "Insert Document Metadata",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Set File ID": {
      "main": [
        [
          {
            "node": "Delete Old Doc Rows",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Default Data Loader": {
      "ai_document": [
        [
          {
            "node": "Insert into Supabase Vectorstore",
            "type": "ai_document",
            "index": 0
          }
        ]
      ]
    },
    "Recursive Character Text Splitter": {
      "ai_textSplitter": [
        [
          {
            "node": "Default Data Loader",
            "type": "ai_textSplitter",
            "index": 0
          }
        ]
      ]
    },
    "Insert into Supabase Vectorstore": {
      "main": [
        [
          {
            "node": "Expandir por Tipo de EvaluaciÃ³n",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Validar Contenido PDF": {
      "main": [
        [
          {
            "node": "Â¿Necesita OCR?",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Extract from File": {
      "main": [
        [
          {
            "node": "Validar Contenido PDF",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Â¿Necesita OCR?": {
      "main": [
        [
          {
            "node": "Base64 a Binary1",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Merge1",
            "type": "main",
            "index": 1
          }
        ]
      ]
    },
    "Aggregate OCR Pages": {
      "main": [
        [
          {
            "node": "Merge1",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Preparar Texto de Muestra": {
      "main": [
        [
          {
            "node": "Format for Vectorstore",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Format for Vectorstore": {
      "main": [
        [
          {
            "node": "Insert into Supabase Vectorstore",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Expandir por Tipo de EvaluaciÃ³n": {
      "main": [
        [
          {
            "node": "Loop Over Items1",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Loop Over Items1": {
      "main": [
        [
          {
            "node": "Respond to Webhook",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Get many rows1",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Docling OCR": {
      "main": [
        [
          {
            "node": "Aggregate OCR Pages",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Structured Output Parser": {
      "ai_outputParser": [
        [
          {
            "node": "Clasificador de Tipo de Evaluacion y Proveedor",
            "type": "ai_outputParser",
            "index": 0
          }
        ]
      ]
    },
    "Merge1": {
      "main": [
        [
          {
            "node": "Has Economic Evaluation?",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Reset Items": {
      "main": [
        [
          {
            "node": "Loop Over Phases",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Webhook": {
      "main": [
        [
          {
            "node": "Code in JavaScript1",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Base64 a Binary": {
      "main": [
        [
          {
            "node": "Extract from File",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Base64 a Binary1": {
      "main": [
        [
          {
            "node": "Docling OCR",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Code in JavaScript1": {
      "main": [
        [
          {
            "node": "Set File ID",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Insert or update rows in a table": {
      "main": [
        [
          {
            "node": "Loop Over Phases",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Preparar Todo para LLM1": {
      "main": [
        [
          {
            "node": "LLM Chain",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Has Economic Evaluation?": {
      "main": [
        [
          {
            "node": "Check If Economic Offer",
            "type": "main",
            "index": 0
          },
          {
            "node": "Preparar Texto de Muestra",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Preparar Texto de Muestra",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Check If Economic Offer": {
      "main": [
        [
          {
            "node": "Extract Economic Data",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Extract Economic Data": {
      "main": [
        [
          {
            "node": "Parse Economic JSON",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Parse Economic JSON": {
      "main": [
        [
          {
            "node": "Save Economic Offer",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Webhook RFP Generate": {
      "main": [
        [
          {
            "node": "Set RFP Params",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Set RFP Params": {
      "main": [
        [
          {
            "node": "Is Award Justification?",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Is Award Justification?": {
      "main": [
        [
          {
            "node": "Prepare Award Sections",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Prepare RFP Sections",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Prepare RFP Sections": {
      "main": [
        [
          {
            "node": "RFP Generation Chain",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "RFP Generation Chain": {
      "main": [
        [
          {
            "node": "Parse RFP Output",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Parse RFP Output": {
      "main": [
        [
          {
            "node": "Respond RFP Generate",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Prepare Award Sections": {
      "main": [
        [
          {
            "node": "Award Justification Chain",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Award Justification Chain": {
      "main": [
        [
          {
            "node": "Parse Award Output",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Parse Award Output": {
      "main": [
        [
          {
            "node": "Respond RFP Generate",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "OpenRouter Chat Model5": {
      "ai_languageModel": [
        [
          {
            "node": "LLM Chain",
            "type": "ai_languageModel",
            "index": 0
          },
          {
            "node": "Extract Economic Data",
            "type": "ai_languageModel",
            "index": 0
          }
        ]
      ]
    },
    "OpenRouter Chat Model6": {
      "ai_languageModel": [
        [
          {
            "node": "QA Email Mapping Chain",
            "type": "ai_languageModel",
            "index": 0
          },
          {
            "node": "RFP Generation Chain",
            "type": "ai_languageModel",
            "index": 0
          },
          {
            "node": "Award Justification Chain",
            "type": "ai_languageModel",
            "index": 0
          }
        ]
      ]
    },
    "Webhook RFQ": {
      "main": [
        [
          {
            "node": "Generate IDs1",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Preparar Texto1": {
      "main": [
        [
          {
            "node": "Clasificador de Tipos1",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Clasificador de Tipos1": {
      "main": [
        [
          {
            "node": "Insert Document Metadata2",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Output Parser1": {
      "ai_outputParser": [
        [
          {
            "node": "Clasificador de Tipos1",
            "type": "ai_outputParser",
            "index": 0
          }
        ]
      ]
    },
    "Expandir por Tipo1": {
      "main": [
        [
          {
            "node": "Loop por Tipo1",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Loop por Tipo1": {
      "main": [
        [
          {
            "node": "Resumen Final1",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Dividir en Trozos1",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Parsear Items1": {
      "main": [
        [
          {
            "node": "Create a row",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Agregar Resultados1": {
      "main": [
        [
          {
            "node": "Loop por Trozo1",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Resumen Final1": {
      "main": [
        [
          {
            "node": "Respond Success1",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Base64 a Binary3": {
      "main": [
        [
          {
            "node": "Extract from File3",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Extract from File3": {
      "main": [
        [
          {
            "node": "Preparar Texto1",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Generate IDs1": {
      "main": [
        [
          {
            "node": "Delete Old Doc Rows1",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Switch1": {
      "main": [
        [
          {
            "node": "LLM Extractor Tech-Econ",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "LLM Extractor - Deliverables",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "LLM Extractor - Deliverables": {
      "main": [
        [
          {
            "node": "Parsear deliverables",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Parsear deliverables": {
      "main": [
        [
          {
            "node": "Create a row",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Dividir en Trozos1": {
      "main": [
        [
          {
            "node": "Reset Items1",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Loop por Trozo1": {
      "main": [
        [
          {
            "node": "Loop por Tipo1",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Switch1",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Reset Items1": {
      "main": [
        [
          {
            "node": "Loop por Trozo1",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Embeddings Ollama1": {
      "ai_embedding": [
        [
          {
            "node": "Insert into Supabase Vectorstore1",
            "type": "ai_embedding",
            "index": 0
          }
        ]
      ]
    },
    "Insert into Supabase Vectorstore1": {
      "main": [
        [
          {
            "node": "Expandir por Tipo1",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Recursive Character Text Splitter1": {
      "ai_textSplitter": [
        [
          {
            "node": "Default Data Loader1",
            "type": "ai_textSplitter",
            "index": 0
          }
        ]
      ]
    },
    "Default Data Loader1": {
      "ai_document": [
        [
          {
            "node": "Insert into Supabase Vectorstore1",
            "type": "ai_document",
            "index": 0
          }
        ]
      ]
    },
    "Create a row": {
      "main": [
        [
          {
            "node": "Agregar Resultados1",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Delete Old Doc Rows1": {
      "main": [
        [
          {
            "node": "Base64 a Binary3",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Insert Document Metadata2": {
      "main": [
        [
          {
            "node": "Insert into Supabase Vectorstore1",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "LLM Extractor Tech-Econ": {
      "main": [
        [
          {
            "node": "Parsear Items1",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "OpenRouter Chat Model7": {
      "ai_languageModel": [
        [
          {
            "node": "LLM Extractor Tech-Econ",
            "type": "ai_languageModel",
            "index": 0
          },
          {
            "node": "LLM Extractor - Deliverables",
            "type": "ai_languageModel",
            "index": 0
          }
        ]
      ]
    },
    "OpenRouter Chat Model8": {
      "ai_languageModel": [
        [
          {
            "node": "Clasificador de Tipos1",
            "type": "ai_languageModel",
            "index": 0
          }
        ]
      ]
    },
    "Webhook Inbound": {
      "main": [
        [
          {
            "node": "Set Input Params",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Set Input Params": {
      "main": [
        [
          {
            "node": "Fetch Project Context QA",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Fetch All Provider Responses": {
      "main": [
        [
          {
            "node": "Filter Deficiencies Only",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Filter Deficiencies Only": {
      "main": [
        [
          {
            "node": "Fetch Requirement Specs",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Fetch Requirement Specs": {
      "main": [
        [
          {
            "node": "Consolidate Deficiencies",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Consolidate Deficiencies": {
      "main": [
        [
          {
            "node": "QA Generation Chain",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "QA Generation Chain": {
      "main": [
        [
          {
            "node": "Split Questions List",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "JSON Output Parser": {
      "ai_outputParser": [
        [
          {
            "node": "QA Generation Chain",
            "type": "ai_outputParser",
            "index": 0
          }
        ]
      ]
    },
    "Split Questions List": {
      "main": [
        [
          {
            "node": "Validate Requirement IDs",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Validate Requirement IDs": {
      "main": [
        [
          {
            "node": "Supabase Insert",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Supabase Insert": {
      "main": [
        [
          {
            "node": "Extract Disciplines",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Extract Disciplines": {
      "main": [
        [
          {
            "node": "Save Project Disciplines",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Save Project Disciplines": {
      "main": [
        [
          {
            "node": "Respond to Webhook1",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Fetch Project Context QA": {
      "main": [
        [
          {
            "node": "Fetch All Provider Responses",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "OpenRouter Chat Model4": {
      "ai_languageModel": [
        [
          {
            "node": "QA Generation Chain",
            "type": "ai_languageModel",
            "index": 0
          }
        ]
      ]
    },
    "OpenRouter Chat Model2": {
      "ai_languageModel": [
        [
          {
            "node": "LLM Re-evaluate",
            "type": "ai_languageModel",
            "index": 0
          }
        ]
      ]
    },
    "Webhook1": {
      "main": [
        [
          {
            "node": "Chat AI Agent",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Postgres Chat Memory": {
      "ai_memory": [
        [
          {
            "node": "Chat AI Agent",
            "type": "ai_memory",
            "index": 0
          }
        ]
      ]
    },
    "Embeddings Ollama": {
      "ai_embedding": [
        [
          {
            "node": "Revisar RFQs",
            "type": "ai_embedding",
            "index": 0
          }
        ]
      ]
    },
    "Chat AI Agent": {
      "main": [
        [
          {
            "node": "Respond to Webhook5",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Revisar-ofertas": {
      "ai_tool": [
        [
          {
            "node": "Chat AI Agent",
            "type": "ai_tool",
            "index": 0
          }
        ]
      ]
    },
    "Embeddings Ollama5": {
      "ai_embedding": [
        [
          {
            "node": "Revisar-ofertas",
            "type": "ai_embedding",
            "index": 0
          }
        ]
      ]
    },
    "query_requirements": {
      "ai_tool": [
        [
          {
            "node": "Chat AI Agent",
            "type": "ai_tool",
            "index": 0
          }
        ]
      ]
    },
    "query_provider_responses": {
      "ai_tool": [
        [
          {
            "node": "Chat AI Agent",
            "type": "ai_tool",
            "index": 0
          }
        ]
      ]
    },
    "query_ranking": {
      "ai_tool": [
        [
          {
            "node": "Chat AI Agent",
            "type": "ai_tool",
            "index": 0
          }
        ]
      ]
    },
    "query_economic_offers": {
      "ai_tool": [
        [
          {
            "node": "Chat AI Agent",
            "type": "ai_tool",
            "index": 0
          }
        ]
      ]
    },
    "query_qa_audit": {
      "ai_tool": [
        [
          {
            "node": "Chat AI Agent",
            "type": "ai_tool",
            "index": 0
          }
        ]
      ]
    },
    "OpenRouter Chat Model3": {
      "ai_languageModel": [
        [
          {
            "node": "Chat AI Agent",
            "type": "ai_languageModel",
            "index": 0
          }
        ]
      ]
    },
    "Revisar RFQs": {
      "ai_tool": [
        [
          {
            "node": "Chat AI Agent",
            "type": "ai_tool",
            "index": 0
          }
        ]
      ]
    },
    "Fetch Requirements": {
      "main": [
        [
          {
            "node": "Merge Requirements & Responses",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Fetch Provider Responses": {
      "main": [
        [
          {
            "node": "Merge Requirements & Responses",
            "type": "main",
            "index": 1
          }
        ]
      ]
    },
    "Fetch Scoring Configuration": {
      "main": [
        [
          {
            "node": "Merge Requirements & Responses",
            "type": "main",
            "index": 2
          }
        ]
      ]
    },
    "Fetch Economic Offers": {
      "main": [
        [
          {
            "node": "Merge Requirements & Responses",
            "type": "main",
            "index": 3
          }
        ]
      ]
    },
    "Merge Requirements & Responses": {
      "main": [
        [
          {
            "node": "Prepare Scoring Data",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Prepare Scoring Data": {
      "main": [
        [
          {
            "node": "Loop Over Providers",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Loop Over Providers": {
      "main": [
        [
          {
            "node": "Aggregate All Rankings",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Scoring LLM Chain",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Scoring LLM Chain": {
      "main": [
        [
          {
            "node": "Calculate Weighted Scores",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Calculate Weighted Scores": {
      "main": [
        [
          {
            "node": "Check Provider Exists",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Check Provider Exists": {
      "main": [
        [
          {
            "node": "Insert Ranking",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Provider Exists?": {
      "main": [
        [
          {
            "node": "Update Ranking",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Insert Ranking",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Update Ranking": {
      "main": [
        [
          {
            "node": "Loop Over Providers",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Insert Ranking": {
      "main": [
        [
          {
            "node": "Loop Over Providers",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Aggregate All Rankings": {
      "main": [
        [
          {
            "node": "Generate Final Ranking",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Generate Final Ranking": {
      "main": [
        [
          {
            "node": "Respond with Ranking",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Set Input Params1": {
      "main": [
        [
          {
            "node": "Fetch Project Context Scoring",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "JSON Output Parser1": {
      "ai_outputParser": [
        [
          {
            "node": "Scoring LLM Chain",
            "type": "ai_outputParser",
            "index": 0
          }
        ]
      ]
    },
    "Delete a row": {
      "main": [
        [
          {
            "node": "Set Input Params1",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "OpenRouter Chat Model1": {
      "ai_languageModel": [
        [
          {
            "node": "Scoring LLM Chain",
            "type": "ai_languageModel",
            "index": 0
          }
        ]
      ]
    },
    "Webhook Scoring": {
      "main": [
        [
          {
            "node": "Delete a row",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Fetch Project Context Scoring": {
      "main": [
        [
          {
            "node": "Fetch Requirements",
            "type": "main",
            "index": 0
          },
          {
            "node": "Fetch Provider Responses",
            "type": "main",
            "index": 0
          },
          {
            "node": "Fetch Scoring Configuration",
            "type": "main",
            "index": 0
          },
          {
            "node": "Fetch Economic Offers",
            "type": "main",
            "index": 0
          }
        ]
      ]
    }
  },
  "pinData": {},
  "meta": {
    "templateCredsSetupCompleted": true,
    "instanceId": "53140335eaf11280ef77ef2f5a378f48c2b28e822e3e0d96563cdd92175c0eff"
  }
}